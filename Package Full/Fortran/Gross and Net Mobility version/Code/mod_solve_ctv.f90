
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
! Copyright 2023 Ludo Visschers and Carlos Carrillo-Tudela
!
!
! Redistribution and use in source and binary forms, with or without 
!	modification, are permitted provided that the following conditions are met:
!
! 1. Redistributions of source code must retain the above copyright notice, 
!	this list of conditions and the following disclaimer.
!
! 2. Redistributions in binary form must reproduce the above copyright notice, 
!	this list of conditions and the following disclaimer in the documentation 
!	and/or other materials provided with the distribution.
!
! 3. Neither the name of the copyright holder nor the names of its contributors 
!	may be used to endorse or promote products derived from this software 
!	without specific prior written permission.
!
! 4. If using this code or its results (whole or in part, with or without 
! 	modifications) in academic work, please cite:  
!		Carrillo-Tudela, Carlos and Ludo Visschers, "Unemployment and Endogenous 
!		Reallocation over the Business Cycle" 
!	in its published version, in the references of the publications associated 
!	with aforementioned academic work.
!
!
! THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" 
! AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
! IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
! DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE 
! FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
! DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
! SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
! CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, 
! OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
! OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!include 'mkl_vsl.f90'
include "errcheck.inc"


MODULE mod_solve_ctv



!USE luxury
USE MKL_VSL_TYPE
USE MKL_VSL

USE modglobal_ctv_eff
USE ctv_grid_mod
USE ctv_grid_mod_VE_VU
USE mod_tauchen_ctv
USE mod_auxdata_moments
USE mod_backward_ctv
!USE omp_lib
!USE ifport
!USE cmaes_param_mod
!USE discretizeAR1           ! ROUWENHORST DISCRETIZATION

!#ifdef __HAVE_MPI__
!      USE MPI
!#endif	


IMPLICIT NONE


!#ifdef __HAVE_MPI__
!      INCLUDE "mpif.h"
!#endif	
!  FILES PRODUCED BY THIS PROGRAM
!       UNIT=11, data.txt
!       UNIT=19, CHANGING FILES: wage.txt, ev_ve.txt
!       UNIT=20, tauchen.txt
!       OPEN(UNIT=21, file="quarterly_timeseries.csv", status="replace", form="formatted")
!       OPEN(UNIT=22, file="results2.txt", status="old", form="formatted", position="append")
!       UNIT=29, reservation.txt
!       UNIT=30, duration.txt
!       UNIT=39, textout.txt ---> opened in main_ctv!!!!
!       OPEN(UNIT=49, file='unemp_dist.txt', form='formatted', status='replace')
!       OPEN(UNIT=50, file='unemp_transmatrix.txt', form='formatted', status='replace')
!       OPEN(UNIT=51, file='occmob.txt', form='formatted', status='replace')
!       OPEN(UNIT=52, file='ave_u_dur.txt', form='formatted', status='replace')
!       OPEN(UNIT=53, file='u_dur_weekly.txt', form='formatted', status='replace')
!       OPEN(UNIT=54, file='random_test.txt', form='formatted', status='replace')
!       OPEN(UNIT=55, file='island_random.txt', form='formatted', status='replace')
!       OPEN(UNIT=59, file='dist_pars.txt', form='formatted', status='replace')
!       OPEN(UNIT=60, file='cutoffs.csv', form='formatted', status='replace')
!       OPEN(UNIT=61, file='upz_dist.csv', form='formatted', status='replace')
!       OPEN(UNIT=62, file='epz_dist.csv', form='formatted', status='replace')
!       OPEN(UNIT=63, file='upz_y_dist.csv', form='formatted', status='replace')
!       OPEN(UNIT=64, file='epz_y_dist.csv', form='formatted', status='replace')
!       OPEN(UNIT=65, file='upz_p_dist.csv', form='formatted', status='replace')
!       OPEN(UNIT=66, file='epz_p_dist.csv', form='formatted', status='replace')
!       OPEN(unit=81, file='monthly_series_nonnormalized.txt', status='replace', form='formatted')
!       OPEN(UNIT=88, file='yearly_data', form='formatted', status='replace')
!       OPEN(UNIT=93, file='monthlyseries2.txt', form='formatted', status='replace')
!       OPEN(unit=94, file='monthly_series_nonnormalized.txt', status='replace', form='formatted')
!       OPEN(unit=97, file='workerhistory.txt', status='replace', form='formatted')
!       OPEN(UNIT=99, file="parresult3.txt", status="new", form="formatted")
!       OPEN(UNIT=59, file="error.txt", status="new", form="formatted")  in MAIN_CTV

CONTAINS

    SUBROUTINE CTV_function_simple(thetal,mom,mom1_dist,mpthread)  !,mom,mom1_dist, mom2_dist, mom3_dist, stat_switch) THE REST OF THE VARIABLES WILL COME
                                        ! theta is the set of parameters fed into this system
                                        ! mom is the actual moments (in the real data)
                                        ! momdists are the moment distances




    !Arguments
    REAL(8), DIMENSION(:), INTENT(in) :: thetal          !  Vector of moments put into the model
    REAL(8), DIMENSION(:), INTENT(out) :: mom           !
    REAL(8), INTENT(out) :: mom1_dist !,  mom2_dist, mom3_dist                    !
    INTEGER, INTENT(in) :: mpthread

    INTEGER, PARAMETER :: nmom_local=120
    REAL(8), DIMENSION(nmom_local) :: mom_local
    REAL(8), DIMENSION(nmom_local) :: mom_data
    REAL(8), DIMENSION(nmom_local, nmom_local) :: omega
    REAL(8), DIMENSION(nmom_local) :: momweightl
    !REAL(8), DIMENSION(:,:,:), INTENT(inout) :: VUl        ! (ppts, xpts, zpts, tmax)        Value of unemployment
    !REAL(8), DIMENSION(:,:,:), INTENT(inout) :: VEl        ! (ppts, xpts, zpts, tmax)           Joint value of employment, conditional on p, z, x
    !REAL(8), DIMENSION(ppts,xpts,zpts) :: VUl
    !REAL(8), DIMENSION(ppts,xpts,zpts) :: VEl
    !INTEGER(4), INTENT(in):: stat_switch

    !vars, parameters, but main parameters in global_dsage
    !counters
    INTEGER :: icnt                      ! island counter
    INTEGER(4):: tcnt, tcnt2                   !Counter of period
    INTEGER(4):: zcnt                   !idiosyncratic shock count
    INTEGER(4):: pcnt                  ! aggregate productivity count
    INTEGER(4):: xcnt, x2cnt                  ! experience count
    INTEGER  :: p2cnt
    INTEGER :: z2cnt

    REAL(8) :: zcorrection

    ! second run, increased z-precision

    REAL(8) :: zprecision_lb, zprecision_ub, tempreal_dd, sep_cutoff, skilldep_cutoff
    REAL(8), DIMENSION(xpts) :: sep_cutoff_vec


    ! convergence
    REAL(8) :: convdistance

    !For simulations STILL TO CHANGE
    REAL, DIMENSION(MAX(tmax_sim, tmax_sim2)) :: prob



    ! RANDOM NUMBER GENERATING
    INTEGER :: tmphour, tmpminute, tmpsecond, tmphund
    INTEGER :: randomseedy
    INTEGER, DIMENSION(25) :: isvec


    INTEGER(4) :: i, isl, t, tempint, tempint3, tempint0, tempint2, tempint1
    INTEGER :: tmax_sim2_quarterly, tmax_qtr, tmax_yr, tmax_qtr2

    ! MAKE SURE THAT WE HAVE THE RIGHT KIND OF INTEGER HERE!!!!
    INTEGER(2), ALLOCATABLE, DIMENSION(:) :: aggprod_ind

    ! NET MOB
    REAL(8), DIMENSION(occpts) :: entry_occdistr, entry_test_distr
    REAL(8), DIMENSION(occpts,1) :: temp_occ_y
    REAL(8), DIMENSION(occpts,2) :: temp_occ_x
    REAL(8), DIMENSION(occpts,2) :: occdistr_begin_end, corr_occdistr_begin_end
    REAL(8), DIMENSION(occpts) :: occdistr_end_v2, occdistr_end_v3, corr_occdistr_end_v3

    REAL(8), DIMENSION(0:occpts,2) :: occdistr_exo_entry_exit, corr_occdistr_exo_entry_exit, &
                                        occdistr_endo_entry_exit, corr_occdistr_endo_entry_exit

    REAL(8), DIMENSION(0:occpts,2) :: occdistr_exo_entry_exit2, corr_occdistr_exo_entry_exit2, &
                                    occdistr_endo_entry_exit2, corr_occdistr_endo_entry_exit2
    REAL(8), DIMENSION(0:occpts,2) :: occdistr_exo_entry_exit3, corr_occdistr_exo_entry_exit3, &
                                    occdistr_endo_entry_exit3, corr_occdistr_endo_entry_exit3
    
    REAL(8), DIMENSION(0:occpts,2) :: occdistr_exo_entry_exit_goodp50, corr_occdistr_exo_entry_exit_goodp50 , &
                                    occdistr_endo_entry_exit_goodp50, corr_occdistr_endo_entry_exit_goodp50
    REAL(8), DIMENSION(0:occpts,2) :: occdistr_exo_entry_exit_badp50, corr_occdistr_exo_entry_exit_badp50 , &
                                    occdistr_endo_entry_exit_badp50, corr_occdistr_endo_entry_exit_badp50
    
    REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: occdistr_exo_entry_exit_qtr, corr_occdistr_exo_entry_exit_qtr, &
                                    occdistr_endo_entry_exit_qtr, corr_occdistr_endo_entry_exit_qtr


    ! SIMULATIONS
   REAL, DIMENSION(tmax_sim2) :: jprobs, sepprobs, zprobs
   INTEGER, DIMENSION(tmax_sim2) :: e_sim, island_sim, hcten_sim, hcind_sim, duration_sim, e_duration_sim, corr_occid_sim, occid_sim
   INTEGER, DIMENSION(tmax_sim2) :: occmob_ind, corr_occmob_ind
   REAL(8), DIMENSION(tmax_sim2) ::  wage_sim

   REAL(8) :: monthind
    ! unemployment duration: tot_durationmatrix --> unemployment survival rates
    ! composition of the unemployed: tot_durationmatrix_cocc/nocc --> cm/cs - uduration
    ! unemployment duration of occ stayers and changers: tot_uduration_s/m

   !===
   ! RAW OCCUPATIONAL MOBILITY MEASURES, incl. MEASUREMENT ERROR
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix, tot_durationmatrix_cocc  , tot_durationmatrix_nocc, tot_durationmatrix2
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cocc_p33, tot_durationmatrix_cocc_p50  , tot_durationmatrix_cocc_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_nocc_p33, tot_durationmatrix_nocc_p50  , tot_durationmatrix_nocc_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cocc_young_p33, tot_durationmatrix_cocc_young_p50  , tot_durationmatrix_cocc_young_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_nocc_young_p33, tot_durationmatrix_nocc_young_p50  , tot_durationmatrix_nocc_young_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cocc_prime_p33, tot_durationmatrix_cocc_prime_p50  , tot_durationmatrix_cocc_prime_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_nocc_prime_p33, tot_durationmatrix_nocc_prime_p50  , tot_durationmatrix_nocc_prime_p67

   !===
   ! CORRECTED OCCUPATIONAL MOBILITY MEASURES, incl. MEASUREMENT ERROR
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr, tot_durationmatrix_cr_cocc  , tot_durationmatrix_cr_nocc
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_cocc_p33, tot_durationmatrix_cr_cocc_p50  , tot_durationmatrix_cr_cocc_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_nocc_p33, tot_durationmatrix_cr_nocc_p50  , tot_durationmatrix_cr_nocc_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_cocc_young_p33, tot_durationmatrix_cr_cocc_young_p50  , tot_durationmatrix_cr_cocc_young_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_nocc_young_p33, tot_durationmatrix_cr_nocc_young_p50  , tot_durationmatrix_cr_nocc_young_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_cocc_prime_p33, tot_durationmatrix_cr_cocc_prime_p50  , tot_durationmatrix_cr_cocc_prime_p67
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_nocc_prime_p33, tot_durationmatrix_cr_nocc_prime_p50  , tot_durationmatrix_cr_nocc_prime_p67


   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_young, tot_durationmatrix_cocc_young , tot_durationmatrix_nocc_young
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_prime, tot_durationmatrix_cocc_prime , tot_durationmatrix_nocc_prime

   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_young, tot_durationmatrix_cr_cocc_young , tot_durationmatrix_cr_nocc_young
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix_cr_prime, tot_durationmatrix_cr_cocc_prime , tot_durationmatrix_cr_nocc_prime

   REAL(8), DIMENSION(0:24) :: tot_udurationmatrix_m_young, tot_udurationmatrix_s_young , tot_udurationmatrix_m
   REAL(8), DIMENSION(0:24) :: tot_udurationmatrix_m_prime, tot_udurationmatrix_s_prime , tot_udurationmatrix_s

   REAL(8), DIMENSION(0:24) :: tot_durationmatrix2_cocc, tot_durationmatrix2_cocc_young , tot_durationmatrix2_nocc_young
   REAL(8), DIMENSION(0:24) :: tot_durationmatrix2_nocc, tot_durationmatrix2_cocc_prime , tot_durationmatrix2_nocc_prime


   REAL(8), DIMENSION(0:24) :: tot_haz_udurationmatrix_m_young, tot_haz_udurationmatrix_s_young , tot_haz_udurationmatrix_m
   REAL(8), DIMENSION(0:24) :: tot_haz_udurationmatrix_m_prime, tot_haz_udurationmatrix_s_prime , tot_haz_udurationmatrix_s
   REAL(8), DIMENSION(0:24) :: tot_haz_durationmatrix, tot_haz_durationmatrix_cocc  , tot_haz_durationmatrix_nocc
   REAL(8), DIMENSION(0:24) :: tot_haz_durationmatrix_young, tot_haz_durationmatrix_cocc_young , tot_haz_durationmatrix_nocc_young
   REAL(8), DIMENSION(0:24) :: tot_haz_durationmatrix_prime, tot_haz_durationmatrix_cocc_prime , tot_haz_durationmatrix_nocc_prime
    REAL(8), DIMENSION(0:24, 2) :: tot_haz_durationmatrix2


   REAL(8) :: subseqreall, returnstenure5y, returnstenure10y, ult5wk, u5lt15wk, u15lt27wk, ugt27wk, tot_ult5wk, tot_u5lt15wk, tot_u15lt27wk, tot_ugt27wk

   ! LOG WAGE DISPERSION COMPARISON
   REAL(8) :: logwage_disp_all, logwage_ave_all, logwage_disp_highoccten, logwage_ave_highoccten, logwage_disp_uhires, logwage_ave_uhires
   REAL(8) :: logwage_disp_diff_all, logwage_disp_diff_highoccten
   INTEGER :: logwage_all_counter, logwage_highoccten_counter, logwage_uhires_counter



   REAL(8), DIMENSION(0:7) :: empduration,  empduration_y, empduration_p
   REAL(8), DIMENSION(0:7) :: empduration_shuspell, empduration_luspell



   REAL(8), DIMENSION(0:7) :: empduration_occ, empduration_nocc, empduration_occ_y, empduration_occ_p, empduration_nocc_y, empduration_nocc_p
   REAL(8), DIMENSION(0:7) :: empduration_occ_shuspell, empduration_nocc_shuspell, empduration_occ_luspell, empduration_nocc_luspell


   REAL(8) :: reemployhaz_sas, reemployhaz_sam, reemployhaz_mas, reemployhaz_mam
   REAL(8) :: reemployhaz_sas_y, reemployhaz_sam_y, reemployhaz_mas_y, reemployhaz_mam_y
   REAL(8) :: reemployhaz_sas_p, reemployhaz_sam_p, reemployhaz_mas_p, reemployhaz_mam_p

   REAL(8), DIMENSION(0:7) :: duration2
   REAL(8), DIMENSION(0:7) :: duration2_young, duration2_prime, duration2_move, duration2_stay, duration2_move_young, duration2_stay_young, duration2_move_prime, duration2_stay_prime

   REAL(8) :: ult5wk_2, u5lt15wk_2, u15lt27wk_2, ugt27wk_2
   INTEGER :: subseqreallcounter, returnstenure5ycounter, returnstenure10ycounter
   INTEGER :: counter_u_window, counter_u_window_all, counter_uocc_window, counter_uocc_window_all, counter_unocc_window, counter_unocc_window_all
   INTEGER :: counter_u_window_all_y, counter_u_window_all_p, counter_u_window_y, counter_u_window_p
   REAL(8) :: uproportion_window, uoccproportion_window, unoccproportion_window, uproportion_window_y, uproportion_window_p


    REAL(8) :: repeat_udur_corr, repeat_udur_el, repeat_udur_corr_m, repeat_udur_el_m, repeat_udur_corr_s, repeat_udur_el_s
    REAL(8) :: repeat_udur_corr_sam, repeat_udur_el_sam, repeat_udur_corr_sas, repeat_udur_el_sas
    REAL(8) :: repeat_udur_corr_mam, repeat_udur_el_mam, repeat_udur_corr_mas, repeat_udur_el_mas
    REAL(8) ::repeat_udur_corr_y, repeat_udur_el_y, repeat_udur_corr_m_y, repeat_udur_el_m_y, repeat_udur_corr_s_y, repeat_udur_el_s_y
    REAL(8) :: repeat_udur_corr_sam_y, repeat_udur_el_sam_y, repeat_udur_corr_sas_y, repeat_udur_el_sas_y
    REAL(8) :: repeat_udur_corr_mam_y, repeat_udur_el_mam_y, repeat_udur_corr_mas_y, repeat_udur_el_mas_y
    REAL(8) ::repeat_udur_corr_p, repeat_udur_el_p, repeat_udur_corr_m_p, repeat_udur_el_m_p, repeat_udur_corr_s_p, repeat_udur_el_s_p
    REAL(8) :: repeat_udur_corr_sam_p, repeat_udur_el_sam_p, repeat_udur_corr_sas_p, repeat_udur_el_sas_p
    REAL(8) :: repeat_udur_corr_mam_p, repeat_udur_el_mam_p, repeat_udur_corr_mas_p, repeat_udur_el_mas_p



    ! for correlation and elasticity calculation
    REAL(8) :: u_spell_now, u_spell_before, u_spell_before_sq, u_spell_before_am_sq, u_spell_before_as_sq, u_spell_before_mas_sq, u_spell_before_mam_sq, u_spell_before_sam_sq, u_spell_before_sas_sq
    REAL(8) :: u_spell_now_sq, u_spell_now_am_sq, u_spell_now_as_sq, u_spell_now_mas_sq, u_spell_now_mam_sq, u_spell_now_sam_sq, u_spell_now_sas_sq
    REAL(8) :: u_spell_crossterm, u_spell_crossterm_am, u_spell_crossterm_as, u_spell_crossterm_mas, u_spell_crossterm_mam, u_spell_crossterm_sam, u_spell_crossterm_sas
        !young
    REAL(8) :: u_spell_young_before_sq, u_spell_young_before_am_sq, u_spell_young_before_as_sq, u_spell_young_before_mas_sq, u_spell_young_before_mam_sq, u_spell_young_before_sam_sq, u_spell_young_before_sas_sq
    REAL(8) :: u_spell_young_now_sq, u_spell_young_now_am_sq, u_spell_young_now_as_sq, u_spell_young_now_mas_sq, u_spell_young_now_mam_sq, u_spell_young_now_sam_sq, u_spell_young_now_sas_sq
    REAL(8) :: u_spell_young_crossterm, u_spell_young_crossterm_am, u_spell_young_crossterm_as, u_spell_young_crossterm_mas, u_spell_young_crossterm_mam, u_spell_young_crossterm_sam, u_spell_young_crossterm_sas
        !old
    REAL(8) :: u_spell_prime_before_sq, u_spell_prime_before_am_sq, u_spell_prime_before_as_sq, u_spell_prime_before_mas_sq, u_spell_prime_before_mam_sq, u_spell_prime_before_sam_sq, u_spell_prime_before_sas_sq
    REAL(8) :: u_spell_prime_now_sq, u_spell_prime_now_am_sq, u_spell_prime_now_as_sq, u_spell_prime_now_mas_sq, u_spell_prime_now_mam_sq, u_spell_prime_now_sam_sq, u_spell_prime_now_sas_sq
    REAL(8) :: u_spell_prime_crossterm, u_spell_prime_crossterm_am, u_spell_prime_crossterm_as, u_spell_prime_crossterm_mas, u_spell_prime_crossterm_mam, u_spell_prime_crossterm_sam, u_spell_prime_crossterm_sas

    ! averages for centered elasticities
    REAL(8) ::u_spell_before_ave, u_spell_before_am_ave, u_spell_before_as_ave, u_spell_before_mas_ave, u_spell_before_mam_ave, u_spell_before_sam_ave, u_spell_before_sas_ave
    REAL(8) :: u_spell_now_ave, u_spell_now_am_ave, u_spell_now_as_ave, u_spell_now_mas_ave, u_spell_now_mam_ave, u_spell_now_sam_ave, u_spell_now_sas_ave
        !young
    REAL(8) :: u_spell_young_before_ave, u_spell_young_before_am_ave, u_spell_young_before_as_ave, u_spell_young_before_mas_ave, u_spell_young_before_mam_ave, u_spell_young_before_sam_ave, u_spell_young_before_sas_ave
    REAL(8) :: u_spell_young_now_ave, u_spell_young_now_am_ave, u_spell_young_now_as_ave, u_spell_young_now_mas_ave, u_spell_young_now_mam_ave, u_spell_young_now_sam_ave, u_spell_young_now_sas_ave
        !old
    REAL(8) :: u_spell_prime_before_ave, u_spell_prime_before_am_ave, u_spell_prime_before_as_ave, u_spell_prime_before_mas_ave, u_spell_prime_before_mam_ave, u_spell_prime_before_sam_ave, u_spell_prime_before_sas_ave
    REAL(8) :: u_spell_prime_now_ave, u_spell_prime_now_am_ave, u_spell_prime_now_as_ave, u_spell_prime_now_mas_ave, u_spell_prime_now_mam_ave, u_spell_prime_now_sam_ave, u_spell_prime_now_sas_ave


   REAL(8), DIMENSION(10) :: occ_ten_dist, occ_surv_rates

   REAL(8) :: profileshift_shortdur, profileshift_longdur

   ! DATA MOMENTS --- MONTHLY/QUARTERLY

   ! QUARTERLY: tmax_sim2/12
   INTEGER :: maxqtr_alloc
   INTEGER, ALLOCATABLE, DIMENSION(:) :: unempdur_estatus
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_prime_qtr

   LOGICAL, ALLOCATABLE, DIMENSION(:) :: mask_qtr
   INTEGER                            :: tmax_mask_qtr, tmax_mask_swindow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u_qtr, data_e_qtr, data_uadj18m_qtr, data_ulev_qtr, data_uraw_qtr, data_lu5_qtr, data_uall_qtr, data_u_yr, data_luall5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ucompldur_occ_qtr, data_ucompldur_young_occ_qtr, data_ucompldur_prime_occ_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ucompldur_nocc_qtr, data_ucompldur_young_nocc_qtr, data_ucompldur_prime_nocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u_qtr_p33, data_u_qtr_p50, data_u_qtr_p67
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cocc_qtr, data_totduration_nocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cocc_young_qtr, data_totduration_nocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cocc_prime_qtr, data_totduration_nocc_prime_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_compduration_cocc_qtr, data_compduration_nocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_compduration_cocc_young_qtr, data_compduration_nocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_compduration_cocc_prime_qtr, data_compduration_nocc_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cr_cocc_qtr, data_totduration_cr_nocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cr_cocc_young_qtr, data_totduration_cr_nocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:,:) :: data_totduration_cr_cocc_prime_qtr, data_totduration_cr_nocc_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u_young_qtr, data_e_young_qtr, data_uadj18m_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u_prime_qtr, data_e_prime_qtr, data_uadj18m_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_v_qtr, data_lv5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_theta_qtr, data_ltheta5_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_jf_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_jf_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_jf_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf5_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf5_prime_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_lpocc5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_lpnocc5_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ljf_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_prod_qtr, data_wage_qtr, data_lprod5_qtr, data_lwage5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sep_qtr, data_sep_y_qtr, data_sep_p_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sep_yr, data_sep_y_yr, data_sep_p_yr, data_jf_y_yr, data_jf_p_yr, data_u_y_yr, data_u_p_yr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_lsep_qtr, data_lsep_y_qtr, data_lsep_p_qtr, data_lsep5_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_inflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_young_inflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_prime_inflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_inflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_young_inflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_prime_inflow_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_prime_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_prime_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_outflow_qtr, data_lcocc_outflow5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_young_outflow_qtr, data_lcocc_young_outflow5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_cocc_prime_outflow_qtr, data_lcocc_prime_outflow5_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_outflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_young_outflow_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_nocc_prime_outflow_qtr


   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pnocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_lpocc_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_lpnocc_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pnocc_young_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pocc_prime_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_pnocc_prime_qtr


   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_temp_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_temp_qtr2
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_temp_qtr3

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult5wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u5lt15wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_u15lt27wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ugt27wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult5wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_u5lt15wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_u15lt27wk_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ugt27wk_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult3m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult5m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult9m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult13m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ugt13m_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult3m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult5m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult9m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult13m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ugt13m_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sm5_ult3m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sm5_ult5m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sm5_ult9m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sm5_ult13m_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_sm5_ugt13m_qtr


   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult3m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult5m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult9m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult13m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ugt13m_yng_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult3m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult5m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult9m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult13m_yng_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ugt13m_yng_qtr

   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult3m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult5m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult9m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ult13m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_ugt13m_prm_qtr



   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult3m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult5m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult9m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ult13m_prm_qtr
   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_l_ugt13m_prm_qtr




   REAL(8), ALLOCATABLE, DIMENSION(:) :: data_scratch_qtr
   !!--------------------------------------------------------
   !! simple memory savings by adding up all monthly data
   !!--------------------------------------------------------

   REAL(8) :: tot_young_qtru, tot_prime_qtr
                ! tot_young_qtru to keep track of unemployed
   REAL(8) :: tot_u_young_qtr, tot_u_prime_qtr
   REAL(8) :: tot_costofhires, tot_hires, tot_reallcost,tot_realls
   INTEGER :: reall_ind

   REAL(8)  :: tot_occafterocc, tot_occafternocc, tot_occafterocc_y, tot_occafternocc_y, tot_occafterocc_p, tot_occafternocc_p
   REAL(8)  :: tot_noccafterocc, tot_noccafternocc, tot_noccafterocc_y, tot_noccafternocc_y, tot_noccafterocc_p, tot_noccafternocc_p
   REAL(8)  :: tot_corr_occafterocc, tot_corr_occafternocc, tot_corr_occafterocc_y, tot_corr_occafternocc_y, tot_corr_occafterocc_p, tot_corr_occafternocc_p
   REAL(8)  :: tot_corr_noccafterocc, tot_corr_noccafternocc, tot_corr_noccafterocc_y, tot_corr_noccafternocc_y, tot_corr_noccafterocc_p, tot_corr_noccafternocc_p


   REAL(8)  :: tot_occafterocc_stu, tot_occafternocc_stu, tot_occafterocc_ltu, tot_occafternocc_ltu
   REAL(8)  :: tot_noccafterocc_stu, tot_noccafternocc_stu, tot_noccafterocc_ltu, tot_noccafternocc_ltu

   REAL(8), DIMENSION(4) :: tot_occafterocc_vector, tot_occafternocc_vector, tot_noccafterocc_vector, tot_noccafternocc_vector
   REAL(8), DIMENSION(4) :: tot_occafterocc_vector_young, tot_occafternocc_vector_young, tot_noccafterocc_vector_young, tot_noccafternocc_vector_young
   REAL(8), DIMENSION(4) :: tot_occafterocc_vector_prime, tot_occafternocc_vector_prime, tot_noccafterocc_vector_prime, tot_noccafternocc_vector_prime

   INTEGER, DIMENSION(10,2) :: repeatmobspells_matrix

   REAL(8), DIMENSION(18) :: data_compduration_cocc, data_compduration_nocc
   REAL(8), DIMENSION(18) :: data_compduration_cocc_young, data_compduration_nocc_young
   REAL(8), DIMENSION(18) :: data_compduration_cocc_prime, data_compduration_nocc_prime



   REAL(8)  :: stock_occafterocc, stock_occafternocc, stock_occafterocc_y, stock_occafternocc_y, stock_occafterocc_p, stock_occafternocc_p
   REAL(8)  :: stock_noccafterocc, stock_noccafternocc, stock_noccafterocc_y, stock_noccafternocc_y, stock_noccafterocc_p, stock_noccafternocc_p
   REAL(8)  :: poccafterocc, poccafternocc, poccafterocc_y, poccafternocc_y, poccafterocc_p, poccafternocc_p
   REAL(8)  :: pnoccafterocc, pnoccafternocc, pnoccafterocc_y, pnoccafternocc_y, pnoccafterocc_p, pnoccafternocc_p


   REAL(8), DIMENSION(2)  :: stock_occafterocc_uspell, stock_occafternocc_uspell, stock_occafterocc_y_uspell, stock_occafternocc_y_uspell, stock_occafterocc_p_uspell, stock_occafternocc_p_uspell
   REAL(8), DIMENSION(2)  :: stock_noccafterocc_uspell, stock_noccafternocc_uspell, stock_noccafterocc_y_uspell, stock_noccafternocc_y_uspell, stock_noccafterocc_p_uspell, stock_noccafternocc_p_uspell
   REAL(8), DIMENSION(2)  :: poccafterocc_uspell, poccafternocc_uspell, poccafterocc_y_uspell, poccafternocc_y_uspell, poccafterocc_p_uspell, poccafternocc_p_uspell
   REAL(8), DIMENSION(2)  :: pnoccafterocc_uspell, pnoccafternocc_uspell, pnoccafterocc_y_uspell, pnoccafternocc_y_uspell, pnoccafterocc_p_uspell, pnoccafternocc_p_uspell
   REAL(8), DIMENSION(2)  :: noccafterocc_uspell, noccafternocc_uspell, occafterocc_uspell, occafternocc_uspell


   INTEGER :: uspellength_ind, prev_empl_ind
   INTEGER(4), DIMENSION(tmax_sim2) :: age_sim, occ_change_before_ind, occ_change_sim
                                            ! occ_change_sim (0 can't tell, 1 yes, 2 no)




   REAL(8) :: unemp_ave, unemp_ave2, prod_ave, prod_ave2, wage_ave, wage_ave2, reall_ave, reall_ave2, uadj18m_ave, unemp_earlier_e_ave, uall_ave, uall_yrave
   REAL(8) :: sepyoung_ave, sepprime_ave
   REAL(8) :: jf_ave, jf_ave2, jfo_ave, sep_ave, sep_ave2, v_ave, v_ave2, theta_ave, theta_ave2, z_ave, reall_ave_conditional, sep_yrave, sep_y_yrave, sep_p_yrave
   INTEGER :: jf_ave2_counter
   REAL(8) :: sep_ave_1m, sep_ave_2m, sep_ave_3m,sep_ave_4m, sep_ave_5m, sep_ave_6m, sep_ave_7m, sep_ave_8m, sep_ave_9m, sep_ave_10m, sep_ave_11m, sep_ave_12m
  REAL(8) :: udur_occ_ave, udur_nocc_ave, udur_occ_ave_q, udur_nocc_ave_q
   REAL(8) :: udur_occ_young_ave, udur_nocc_young_ave, udur_occ_young_ave_q, udur_nocc_young_ave_q
   REAL(8) :: udur_occ_prime_ave, udur_nocc_prime_ave, udur_occ_prime_ave_q, udur_nocc_prime_ave_q
   REAL(8), DIMENSION(12) :: udur_mvec_occ_ave, udur_mvec_occ_with_u, udur_mvec_occ_with_hpu !, udur_mvec_occ_with_hplu, udur_mvec_occ_with_lu
   REAL(8), DIMENSION(12) :: udur_mvec_occ_young_ave,  udur_mvec_occ_young_with_u, udur_mvec_occ_young_with_hpu !, udur_mvec_occ_young_with_hplu, udur_mvec_occ_young_with_lu
   REAL(8), DIMENSION(12) :: udur_mvec_occ_prime_ave,  udur_mvec_occ_prime_with_u, udur_mvec_occ_prime_with_hpu !, udur_mvec_occ_prime_with_hplu, udur_mvec_occ_prime_with_lu
   REAL(8), DIMENSION(12) :: udur_mvec_nocc_ave,  udur_mvec_nocc_with_u, udur_mvec_nocc_with_hpu !, udur_mvec_nocc_with_hplu, udur_mvec_nocc_with_lu
   REAL(8), DIMENSION(12) :: udur_mvec_nocc_young_ave, udur_mvec_nocc_young_with_u, udur_mvec_nocc_young_with_hpu !, udur_mvec_nocc_young_with_hplu, udur_mvec_nocc_young_with_lu
   REAL(8), DIMENSION(12) :: udur_mvec_nocc_prime_ave, udur_mvec_nocc_prime_with_u, udur_mvec_nocc_prime_with_hpu !, udur_mvec_nocc_prime_with_hplu, udur_mvec_nocc_prime_with_lu
   REAL(8) :: udur_occ_with_hplu, udur_occ_with_lu, udur_occ_with_u, udur_nocc_with_u, udur_occ_with_hpu, udur_nocc_with_hpu
   REAL(8) :: udur_nocc_with_hplu, udur_nocc_with_lu
   REAL(8) :: udur_occ_young_with_hplu, udur_occ_young_with_lu, udur_occ_young_with_u, udur_nocc_young_with_u, udur_occ_young_with_hpu, udur_nocc_young_with_hpu
   REAL(8) :: udur_nocc_young_with_hplu, udur_nocc_young_with_lu
   REAL(8) :: udur_nocc_prime_with_hplu, udur_nocc_prime_with_lu, udur_occ_prime_with_u, udur_nocc_prime_with_u, udur_occ_prime_with_hpu, udur_nocc_prime_with_hpu
   REAL(8) :: udur_occ_prime_with_hplu, udur_occ_prime_with_lu

   REAL(8) :: sep_ave_1m_posthire, sep_ave_2m_posthire, sep_ave_3m_posthire,sep_ave_4m_posthire, sep_ave_5m_posthire, sep_ave_6m_posthire, sep_ave_7m_posthire, sep_ave_8m_posthire, sep_ave_9m_posthire, sep_ave_10m_posthire, sep_ave_11m_posthire, sep_ave_12m_posthire
   INTEGER :: sep_ave_m_counter, sep_ave_m_posthire_counter, earlier_e_counter, young_earlier_e_counter, prime_earlier_e_counter
   REAL(8) :: u_ave_q, v_ave_q, theta_ave_q, sep_ave_q, jf_ave_q, wage_ave_q, prod_ave_q, reall_ave_q, jfo_ave_q, uall_ave_q
   REAL(8) :: u_ave_q5, v_ave_q5, theta_ave_q5, sep_ave_q5, jf_ave_q5, wage_ave_q5, prod_ave_q5, reall_ave_q5, jfo_ave_q5, uall_ave_q5


   INTEGER(4) :: tempint_u, tempint_jf, tempint_sep, tempint_reall, tempint_jfo
   REAL(8) :: tempreal_wage, tempreal_v, tempreal_prod, tempint_e, testreal, testreal2, testreal3

   REAL(8) :: cocc_ave, cocc_young_ave, cocc_prime_ave, jfocc_ave, jfocc_young_ave, jfocc_prime_ave
   REAL(8) :: nocc_ave, nocc_young_ave, nocc_prime_ave, jfnocc_ave, jfnocc_young_ave, jfnocc_prime_ave
   REAL(8) :: cocc_inflow_ave, cocc_young_inflow_ave, cocc_prime_inflow_ave
   REAL(8) :: nocc_inflow_ave, nocc_young_inflow_ave, nocc_prime_inflow_ave
   REAL(8) :: u_young_ave, u_prime_ave, uadj18m_young_ave, uadj18m_prime_ave, u_earlier_e_young_ave, u_earlier_e_prime_ave
   REAL(8) :: noccafternocc_ave, noccafterocc_ave, noccafternocc_y_ave, noccafterocc_y_ave, noccafternocc_p_ave, noccafterocc_p_ave
   REAL(8) :: noccafterall_ave, noccafterall_y_ave, noccafterall_p_ave
   REAL(8) :: hpu_p33, hpu_p50, hpu_p67

   REAL(8) :: jf_young_ave, jf_prime_ave

   ! SEPARATIONS
   REAL(8) :: sepocc_ave, sepnocc_ave, sepocc_y_ave, sepnocc_y_ave, sepocc_p_ave, sepnocc_p_ave
   REAL(8) :: sepocc_ave_counter, sepnocc_ave_counter, sepocc_y_ave_counter, sepnocc_y_ave_counter, sepocc_p_ave_counter, sepnocc_p_ave_counter

    REAL(8)  :: sepocc_afternocc_2_5yr, sepocc_afternocc_2_5yr_2m, sepocc_afternocc_3yr
    REAL(8) :: sep_afternocc_2_5yr, sep_afternocc_2_5yr_2m
    REAL(8) :: sepnocc_afternocc_2_5yr, sepnocc_afternocc_2_5yr_2m
    INTEGER :: sepocc_afternocc_2_5yr_counter, sepocc_afternocc_3yr_counter, sep_afternocc_2_5yr_counter, sepnocc_afternocc_2_5yr_counter


    ! BUSINESS CYCLE ELASTICITIES
   REAL(8) :: elmatching_ave, elmatching_lindt_ave, el_u_with_v_lindt, el_u_with_p_lindt,el_u_with_p
   REAL(8) :: el_u_with_v, el_u5_with_v5, el_v_with_u, el_v5_with_u5
   REAL(8) :: unemp_prod_elasticity, u_young_prod_elasticity, u_prime_prod_elasticity, sep_young_prod_elasticity, sep_prime_prod_elasticity
   REAL(8) :: cocc_inflow_prod_elasticity, cocc_inflow_unemp_elasticity, jf_young_prod_elasticity, jf_prime_prod_elasticity, jf_prod_elasticity, sep_prod_elasticity
   REAL(8) :: cocc_young_inflow_prod_elasticity, cocc_prime_inflow_prod_elasticity, cocc_young_inflow_unemp_elasticity, cocc_prime_inflow_unemp_elasticity
   REAL(8) :: sep_young_unemp_elasticity, sep_prime_unemp_elasticity, wage_prod_elasticity, jfocc_prod_elasticity, jfnocc_prod_elasticity
   REAL(8) :: jfocc5_prod_elasticity, jfnocc5_prod_elasticity, jf5_young_prod_elasticity, jf5_prime_prod_elasticity, jf5_prod_elasticity
   REAL(8) :: jfocc5_prod_semielasticity, jfnocc5_prod_semielasticity, jf5_young_prod_semielasticity, jf5_prime_prod_semielasticity, jf5_prod_semielasticity
   REAL(8) :: jfocc5_unemp_semielasticity, jfnocc5_unemp_semielasticity, jf5_young_unemp_semielasticity, jf5_prime_unemp_semielasticity, jf5_unemp_semielasticity
   REAL(8) :: jfocc5_unemp_elasticity, jfnocc5_unemp_elasticity, jf5_young_unemp_elasticity, jf5_prime_unemp_elasticity, jf5_unemp_elasticity

   REAL(8) :: jfocc_unemp_elasticity, jfnocc_unemp_elasticity
   REAL(8) :: jf_young_unemp_elasticity, jf_prime_unemp_elasticity, jf_unemp_elasticity, sep_unemp_elasticity

   REAL(8), DIMENSION(occpts) :: sep_supocc_unemp_elasticity, sep_supocc_unemp_semielasticity, sep_supocc_prod_elasticity, sep_supocc_prod_semielasticity
   REAL(8), DIMENSION(occpts) :: sep_supocc_unemp_elasticity_ldt, sep_supocc_unemp_semielasticity_ldt, sep_supocc_prod_elasticity_ldt, sep_supocc_prod_semielasticity_ldt
   REAL(8), DIMENSION(occpts) :: udur_supocc_unemp_elasticity, udur_supocc_unemp_semielasticity, udur_supocc_prod_elasticity, udur_supocc_prod_semielasticity
   REAL(8), DIMENSION(occpts) :: udur_supocc_unemp_elasticity_ldt, udur_supocc_unemp_semielasticity_ldt, udur_supocc_prod_elasticity_ldt, udur_supocc_prod_semielasticity_ldt
   !REAL(8), DIMENSION(occpts) :: u_supocc_prod_elasticity_ldt, u_supocc_prod_semielasticity_ldt,u_supocc_unemp_elasticity_ldt, u_supocc_unemp_semielasticity_ldt
   REAL(8), DIMENSION(occpts) :: u_supocc_unemp_elasticity, u_supocc_unemp_semielasticity, u_supocc_prod_elasticity, u_supocc_prod_semielasticity
   REAL(8), DIMENSION(occpts) :: u_supocc_unemp_elasticity_ldt, u_supocc_unemp_semielasticity_ldt, u_supocc_prod_elasticity_ldt, u_supocc_prod_semielasticity_ldt
   REAL(8) :: sep_unemp_elasticity_ldt, sep_unemp_semielasticity_ldt, udur_unemp_elasticity_ldt, udur_unemp_semielasticity_ldt
   REAL(8), DIMENSION(occpts) :: unemp_supocc_ave, e_supocc_ave

   !! NET MOBILITY OVER THE CYCLE
    ! occpts x occpts
    REAL(8), DIMENSION(occpts, occpts) :: data_superocc_transmatrix_p33, data_corr_superocc_transmatrix_p33, data_superocc_transmatrix_forreal, data_corr_superocc_transmatrix_forreal
    REAL(8), DIMENSION(occpts)         :: netmob_calc_vector_p33, grossmob_calc_vector_p33, corr_netmob_calc_vector_p33, corr_grossmob_calc_vector_p33
    REAL(8)                            :: overall_netmob_p33, overall_grossmob_p33, overall_xsmob_p33
    REAL(8)                            :: overall_corr_netmob_p33, overall_corr_grossmob_p33, overall_corr_xsmob_p33
    REAL(8), DIMENSION(occpts, occpts) :: data_superocc_transmatrix_p50, data_corr_superocc_transmatrix_p50
    REAL(8), DIMENSION(occpts)         :: netmob_calc_vector_p50, grossmob_calc_vector_p50, corr_netmob_calc_vector_p50, corr_grossmob_calc_vector_p50
    REAL(8)                            :: overall_netmob_p50, overall_grossmob_p50, overall_xsmob_p50
    REAL(8)                            :: overall_corr_netmob_p50, overall_corr_grossmob_p50, overall_corr_xsmob_p50
    REAL(8), DIMENSION(occpts, occpts) :: data_superocc_transmatrix_p67, data_corr_superocc_transmatrix_p67
    REAL(8), DIMENSION(occpts)         :: netmob_calc_vector_p67, grossmob_calc_vector_p67, corr_netmob_calc_vector_p67, corr_grossmob_calc_vector_p67
    REAL(8)                            :: overall_netmob_p67, overall_grossmob_p67, overall_xsmob_p67
    REAL(8)                            :: overall_corr_netmob_p67, overall_corr_grossmob_p67, overall_corr_xsmob_p67
    REAL(8), DIMENSION(occpts, occpts) :: data_superocc_transmatrix_p50p67, data_corr_superocc_transmatrix_p50p67 ! test matrix for the gap
    REAL(8), DIMENSION(occpts)         :: netmob_calc_vector_p50p67, grossmob_calc_vector_p50p67, corr_netmob_calc_vector_p50p67, corr_grossmob_calc_vector_p50p67
    REAL(8)                            :: overall_netmob_p50p67, overall_grossmob_p50p67, overall_xsmob_p50p67
    REAL(8)                            :: overall_corr_netmob_p50p67, overall_corr_grossmob_p50p67, overall_corr_xsmob_p50p67
    REAL(8), DIMENSION(occpts, occpts) :: data_superocc_transmatrix_allptile, data_corr_superocc_transmatrix_allptile ! test matrix for the gap
    REAL(8), DIMENSION(occpts)         :: netmob_calc_vector_allptile, grossmob_calc_vector_allptile, corr_netmob_calc_vector_allptile, corr_grossmob_calc_vector_allptile
    REAL(8)                            :: overall_netmob_allptile, overall_grossmob_allptile, overall_xsmob_allptile
    REAL(8)                            :: overall_corr_netmob_allptile, overall_corr_grossmob_allptile, overall_corr_xsmob_allptile
    
    REAL(8), DIMENSION(occpts)         :: supocc_outflow, supocc_outflow_p33, supocc_outflow_p50, supocc_outflow_p67
    REAL(8), DIMENSION(occpts)         :: supocc_inflow, supocc_inflow_p33, supocc_inflow_p50, supocc_inflow_p67
    REAL(8), DIMENSION(occpts)         :: corr_supocc_outflow, corr_supocc_outflow_p33, corr_supocc_outflow_p50, corr_supocc_outflow_p67
    REAL(8), DIMENSION(occpts)         :: corr_supocc_inflow, corr_supocc_inflow_p33, corr_supocc_inflow_p50, corr_supocc_inflow_p67
    REAL(8), DIMENSION(occpts)         :: mogmob_superocc, corr_mogmob_superocc


   REAL(8) :: sep_young_prod_semielasticity, sep_prod_semielasticity, sep_prime_prod_semielasticity, jfocc_prod_semielasticity, jfnocc_prod_semielasticity
   REAL(8) :: jf_prod_semielasticity, jf_young_prod_semielasticity, jf_prime_prod_semielasticity
   REAL(8) :: sep_young_unemp_semielasticity, sep_unemp_semielasticity, sep_prime_unemp_semielasticity, jfocc_unemp_semielasticity, jfnocc_unemp_semielasticity
   REAL(8) :: jf_unemp_semielasticity, jf_young_unemp_semielasticity, jf_prime_unemp_semielasticity
    ! u-durations (in wks)
   !REAL(8) :: u5w_prod_elasticity, u15w_prod_elasticity, u27w_prod_elasticity, ugt27w_prod_elasticity
   !REAL(8) :: u5w_prod_semielasticity, u15w_prod_semielasticity, u27w_prod_semielasticity, ugt27w_prod_semielasticity
   REAL(8) :: u5w_unemp_elasticity, u15w_unemp_elasticity, u27w_unemp_elasticity, ugt27w_unemp_elasticity
   REAL(8) :: u5w_unemp_semielasticity, u15w_unemp_semielasticity, u27w_unemp_semielasticity, ugt27w_unemp_semielasticity
   !REAL(8) :: uprop5w_prod_elasticity, uprop15w_prod_elasticity, uprop27w_prod_elasticity, upropgt27w_prod_elasticity
   !REAL(8) :: uprop5w_prod_semielasticity, uprop15w_prod_semielasticity, uprop27w_prod_semielasticity, upropgt27w_prod_semielasticity
   !REAL(8) :: uprop5w_unemp_elasticity, uprop15w_unemp_elasticity, uprop27w_unemp_elasticity, upropgt27w_unemp_elasticity
   !REAL(8) :: uprop5w_unemp_semielasticity, uprop15w_unemp_semielasticity, uprop27w_unemp_semielasticity, upropgt27w_unemp_semielasticity
   !REAL(8) :: luprop5w_prod_elasticity, luprop15w_prod_elasticity, luprop27w_prod_elasticity, lupropgt27w_prod_elasticity
   !REAL(8) :: luprop5w_prod_semielasticity, luprop15w_prod_semielasticity, luprop27w_prod_semielasticity, lupropgt27w_prod_semielasticity
   !REAL(8) :: luprop5w_unemp_elasticity, luprop15w_unemp_elasticity, luprop27w_unemp_elasticity, lupropgt27w_unemp_elasticity
   !REAL(8) :: luprop5w_unemp_semielasticity, luprop15w_unemp_semielasticity, luprop27w_unemp_semielasticity, lupropgt27w_unemp_semielasticity
   REAL(8) :: hp_uprop5w_prod_elasticity, hp_uprop15w_prod_elasticity, hp_uprop27w_prod_elasticity, hp_upropgt27w_prod_elasticity
   REAL(8) :: hp_uprop5w_prod_semielasticity, hp_uprop15w_prod_semielasticity, hp_uprop27w_prod_semielasticity, hp_upropgt27w_prod_semielasticity
   REAL(8) :: hp_uprop5w_unemp_elasticity, hp_uprop15w_unemp_elasticity, hp_uprop27w_unemp_elasticity, hp_upropgt27w_unemp_elasticity
   REAL(8) :: hp_uprop5w_unemp_semielasticity, hp_uprop15w_unemp_semielasticity, hp_uprop27w_unemp_semielasticity, hp_upropgt27w_unemp_semielasticity
   !REAL(8) :: hpl_uprop5w_prod_elasticity, hpl_uprop15w_prod_elasticity, hpl_uprop27w_prod_elasticity, hpl_upropgt27w_prod_elasticity
   !REAL(8) :: hpl_uprop5w_prod_semielasticity, hpl_uprop15w_prod_semielasticity, hpl_uprop27w_prod_semielasticity, hpl_upropgt27w_prod_semielasticity
   !REAL(8) :: hpl_uprop5w_unemp_elasticity, hpl_uprop15w_unemp_elasticity, hpl_uprop27w_unemp_elasticity, hpl_upropgt27w_unemp_elasticity
   !REAL(8) :: hpl_uprop5w_unemp_semielasticity, hpl_uprop15w_unemp_semielasticity, hpl_uprop27w_unemp_semielasticity, hpl_upropgt27w_unemp_semielasticity

    ! u-durations (in wks)
   !REAL(8) :: u3m_prod_elasticity, u5m_prod_elasticity, u9m_prod_elasticity, u13m_prod_elasticity, ugt13m_prod_elasticity
   !REAL(8) :: u3m_prod_semielasticity, u5m_prod_semielasticity, u9m_prod_semielasticity, u13m_prod_semielasticity, ugt13m_prod_semielasticity
   REAL(8) :: u3m_unemp_elasticity, u5m_unemp_elasticity, u9m_unemp_elasticity, u13m_unemp_elasticity, ug13m_unemp_elasticity
   REAL(8) :: u3m_unemp_semielasticity, u5m_unemp_semielasticity, u9m_unemp_semielasticity, u13m_unemp_semielasticity, ug13m_unemp_semielasticity
   REAL(8) :: u3m_unemp_yng_elasticity, u5m_unemp_yng_elasticity, u9m_unemp_yng_elasticity, u13m_unemp_yng_elasticity, ug13m_unemp_yng_elasticity
   REAL(8) :: u3m_unemp_yng_semielasticity, u5m_unemp_yng_semielasticity, u9m_unemp_yng_semielasticity, u13m_unemp_yng_semielasticity, ug13m_unemp_yng_semielasticity
   REAL(8) :: u3m_unemp_prm_elasticity, u5m_unemp_prm_elasticity, u9m_unemp_prm_elasticity, u13m_unemp_prm_elasticity, ug13m_unemp_prm_elasticity
   REAL(8) :: u3m_unemp_prm_semielasticity, u5m_unemp_prm_semielasticity, u9m_unemp_prm_semielasticity, u13m_unemp_prm_semielasticity, ug13m_unemp_prm_semielasticity


   !REAL(8) :: uprop3m_prod_elasticity, uprop5m_prod_elasticity, uprop9m_prod_elasticity, uprop13m_prod_elasticity, upropg13m_prod_elasticity
   !REAL(8) :: uprop3m_prod_semielasticity, uprop5m_prod_semielasticity, uprop9m_prod_semielasticity, uprop13m_prod_semielasticity, upropg13m_prod_semielasticity
   !REAL(8) :: uprop3m_unemp_elasticity, uprop5m_unemp_elasticity, uprop9m_unemp_elasticity, uprop13m_unemp_elasticity, upropg13m_unemp_elasticity
   !REAL(8) :: uprop3m_unemp_semielasticity, uprop5m_unemp_semielasticity, uprop9m_unemp_semielasticity, uprop13m_unemp_semielasticity, upropg13m_unemp_semielasticity
   !REAL(8) :: luprop3m_prod_elasticity, luprop5m_prod_elasticity, luprop9m_prod_elasticity, luprop13m_prod_elasticity, lupropg13m_prod_elasticity
   !REAL(8) :: luprop3m_prod_semielasticity, luprop5m_prod_semielasticity, luprop9m_prod_semielasticity, luprop13m_prod_semielasticity, lupropg13m_prod_semielasticity
   !REAL(8) :: luprop3m_unemp_elasticity, luprop5m_unemp_elasticity, luprop9m_unemp_elasticity, luprop13m_unemp_elasticity, lupropg13m_unemp_elasticity
   !REAL(8) :: luprop3m_unemp_semielasticity, luprop5m_unemp_semielasticity, luprop9m_unemp_semielasticity, luprop13m_unemp_semielasticity, lupropg13m_unemp_semielasticity
   REAL(8) :: hp_uprop3m_prod_elasticity, hp_uprop5m_prod_elasticity, hp_uprop9m_prod_elasticity, hp_uprop13m_prod_elasticity,hp_upropg13m_prod_elasticity
   REAL(8) :: hp_uprop3m_prod_semielasticity, hp_uprop5m_prod_semielasticity, hp_uprop9m_prod_semielasticity, hp_uprop13m_prod_semielasticity, hp_upropg13m_prod_semielasticity
   REAL(8) :: hp_uprop3m_unemp_elasticity, hp_uprop5m_unemp_elasticity, hp_uprop9m_unemp_elasticity, hp_uprop13m_unemp_elasticity, hp_upropg13m_unemp_elasticity
   REAL(8) :: hp_sm_uprop3m_unemp_elasticity, hp_sm_uprop5m_unemp_elasticity, hp_sm_uprop9m_unemp_elasticity, hp_sm_uprop13m_unemp_elasticity, hp_sm_upropg13m_unemp_elasticity
   REAL(8) :: hp_uprop3m_unemp_semielasticity, hp_uprop5m_unemp_semielasticity, hp_uprop9m_unemp_semielasticity, hp_uprop13m_unemp_semielasticity, hp_upropg13m_unemp_semielasticity
   REAL(8) :: hp_uprop3m_prod_yng_elasticity, hp_uprop5m_prod_yng_elasticity, hp_uprop9m_prod_yng_elasticity, hp_uprop13m_prod_yng_elasticity,hp_upropg13m_prod_yng_elasticity
   REAL(8) :: hp_uprop3m_prod_yng_semielasticity, hp_uprop5m_prod_yng_semielasticity, hp_uprop9m_prod_yng_semielasticity, hp_uprop13m_prod_yng_semielasticity, hp_upropg13m_prod_yng_semielasticity
   REAL(8) :: hp_uprop3m_unemp_yng_elasticity, hp_uprop5m_unemp_yng_elasticity, hp_uprop9m_unemp_yng_elasticity, hp_uprop13m_unemp_yng_elasticity, hp_upropg13m_unemp_yng_elasticity
   REAL(8) :: hp_uprop3m_unemp_yng_semielasticity, hp_uprop5m_unemp_yng_semielasticity, hp_uprop9m_unemp_yng_semielasticity, hp_uprop13m_unemp_yng_semielasticity, hp_upropg13m_unemp_yng_semielasticity
   REAL(8) :: hp_uprop3m_prod_prm_elasticity, hp_uprop5m_prod_prm_elasticity, hp_uprop9m_prod_prm_elasticity, hp_uprop13m_prod_prm_elasticity,hp_upropg13m_prod_prm_elasticity
   REAL(8) :: hp_uprop3m_prod_prm_semielasticity, hp_uprop5m_prod_prm_semielasticity, hp_uprop9m_prod_prm_semielasticity, hp_uprop13m_prod_prm_semielasticity, hp_upropg13m_prod_prm_semielasticity
   REAL(8) :: hp_uprop3m_unemp_prm_elasticity, hp_uprop5m_unemp_prm_elasticity, hp_uprop9m_unemp_prm_elasticity, hp_uprop13m_unemp_prm_elasticity, hp_upropg13m_unemp_prm_elasticity
   REAL(8) :: hp_uprop3m_unemp_prm_semielasticity, hp_uprop5m_unemp_prm_semielasticity, hp_uprop9m_unemp_prm_semielasticity, hp_uprop13m_unemp_prm_semielasticity, hp_upropg13m_unemp_prm_semielasticity

   REAL(8) :: sm_hp_uprop3m_u_semi_el, sm_hp_uprop5m_u_semi_el, sm_hp_uprop9m_u_semi_el, sm_hp_uprop13m_u_semi_el, sm_hp_upropg13m_u_semi_el
   !REAL(8) :: hpl_uprop3m_prod_elasticity, hpl_uprop5m_prod_elasticity, hpl_uprop9m_prod_elasticity, hpl_uprop13m_prod_elasticity, hpl_upropg13m_prod_elasticity
   !REAL(8) :: hpl_uprop3m_prod_semielasticity, hpl_uprop5m_prod_semielasticity, hpl_uprop9m_prod_semielasticity, hpl_uprop13m_prod_semielasticity, hpl_upropg13m_prod_semielasticity
   !REAL(8) :: hpl_uprop3m_unemp_elasticity, hpl_uprop5m_unemp_elasticity, hpl_uprop9m_unemp_elasticity, hpl_uprop13m_unemp_elasticity, hpl_upropg13m_unemp_elasticity
   !REAL(8) :: hpl_uprop3m_unemp_semielasticity, hpl_uprop5m_unemp_semielasticity, hpl_uprop9m_unemp_semielasticity, hpl_uprop13m_unemp_semielasticity, hpl_upropg13m_unemp_semielasticity

   REAL(8) :: cycl_sep_age_shift_muellermom
   REAL(8) :: cycl_jf_age_shift_muellermom, jf_y_yrave, jf_p_yrave
   REAL(8) :: cycl_u_age_shift_muellermom, u_y_yrave, u_p_yrave

   REAL(8) :: cocc_outflow_prod_elasticity, cocc_young_outflow_prod_elasticity, cocc_prime_outflow_prod_elasticity
   REAL(8) :: cocc_outflow_unemp_elasticity, cocc_young_outflow_unemp_elasticity, cocc_prime_outflow_unemp_elasticity
   REAL(8) :: cocc_outflow_prod_semielasticity, cocc_young_outflow_prod_semielasticity, cocc_prime_outflow_prod_semielasticity
   REAL(8) :: cocc_outflow_unemp_semielasticity, cocc_young_outflow_unemp_semielasticity, cocc_prime_outflow_unemp_semielasticity

   REAL(8) :: var_jfocc, var_jfnocc

   REAL(8) :: uprop_3m_ave, uprop_5m_ave, uprop_9m_ave, uprop_13m_ave, uprop_g13m_ave
   REAL(8) :: var_uprop_3m_ave, var_uprop_5m_ave, var_uprop_9m_ave, var_uprop_13m_ave, var_uprop_g13m_ave
   REAL(8) :: hp_var_uprop_3m_ave, hp_var_uprop_5m_ave, hp_var_uprop_9m_ave, hp_var_uprop_13m_ave, hp_var_uprop_g13m_ave
   REAL(8) :: var_l_uprop_3m_ave, var_l_uprop_5m_ave, var_l_uprop_9m_ave, var_l_uprop_13m_ave, var_l_uprop_g13m_ave
   REAL(8) :: hp_var_l_uprop_3m_ave, hp_var_l_uprop_5m_ave, hp_var_l_uprop_9m_ave, hp_var_l_uprop_13m_ave, hp_var_l_uprop_g13m_ave

   REAL(8) :: uprop_yng_3m_ave, uprop_yng_5m_ave, uprop_yng_9m_ave, uprop_yng_13m_ave, uprop_yng_g13m_ave
   REAL(8) :: var_uprop_yng_3m_ave, var_uprop_yng_5m_ave, var_uprop_yng_9m_ave, var_uprop_yng_13m_ave, var_uprop_yng_g13m_ave
   REAL(8) :: hp_var_uprop_yng_3m_ave, hp_var_uprop_yng_5m_ave, hp_var_uprop_yng_9m_ave, hp_var_uprop_yng_13m_ave, hp_var_uprop_yng_g13m_ave
   REAL(8) :: var_l_uprop_yng_3m_ave, var_l_uprop_yng_5m_ave, var_l_uprop_yng_9m_ave, var_l_uprop_yng_13m_ave, var_l_uprop_yng_g13m_ave
   REAL(8) :: hp_var_l_uprop_yng_3m_ave, hp_var_l_uprop_yng_5m_ave, hp_var_l_uprop_yng_9m_ave, hp_var_l_uprop_yng_13m_ave, hp_var_l_uprop_yng_g13m_ave

   REAL(8) :: uprop_prm_3m_ave, uprop_prm_5m_ave, uprop_prm_9m_ave, uprop_prm_13m_ave, uprop_prm_g13m_ave
   REAL(8) :: var_uprop_prm_3m_ave, var_uprop_prm_5m_ave, var_uprop_prm_9m_ave, var_uprop_prm_13m_ave, var_uprop_prm_g13m_ave
   REAL(8) :: hp_var_uprop_prm_3m_ave, hp_var_uprop_prm_5m_ave, hp_var_uprop_prm_9m_ave, hp_var_uprop_prm_13m_ave, hp_var_uprop_prm_g13m_ave
   REAL(8) :: var_l_uprop_prm_3m_ave, var_l_uprop_prm_5m_ave, var_l_uprop_prm_9m_ave, var_l_uprop_prm_13m_ave, var_l_uprop_prm_g13m_ave
   REAL(8) :: hp_var_l_uprop_prm_3m_ave, hp_var_l_uprop_prm_5m_ave, hp_var_l_uprop_prm_9m_ave, hp_var_l_uprop_prm_13m_ave, hp_var_l_uprop_prm_g13m_ave


   REAL(8) :: ult5wk_ave, u5lt15wk_ave, u15lt27wk_ave, ugt27wk_ave
   REAL(8) :: var_ult5wk_ave, var_u5lt15wk_ave, var_u15lt27wk_ave, var_ugt27wk_ave
   REAL(8) :: var_l_ult5wk_ave, var_l_u5lt15wk_ave, var_l_u15lt27wk_ave, var_l_ugt27wk_ave



    REAL(8), DIMENSION(ppts) :: u_prod_relation, prod_distribution
    REAL(8), DIMENSION(ppts) :: prod_median, wage_median, sep_prod_above_med, sep_prod_below_med, sep_wage_above_med, sep_wage_below_med

    !REAL(8), ALLOCATABLE, DIMENSION(:,:) :: hp_scratch


    !Target and non-target (result) moments
    REAL(8):: var_u, var_v, var_theta, var_sep, var_jf, var_jfo, var_wage, var_prod, var_reall, var_u5, var_v5, var_theta5, &
                                        var_sep5, var_jf5, var_jfo5, var_wage5, var_prod5, var_reall5, var_reall5_2, var_uall, var_uall5
    REAL(8):: corr_uv, corr_uv_lindt, corr_utheta, corr_usep, corr_ujf, corr_uwage, corr_uprod, corr_ureall, corr_vtheta,&
        corr_uallv, corr_uallv_lindt, corr_ualltheta, corr_uallsep, corr_ualljf, corr_uallwage, corr_uallprod, corr_uallreall, corr_uallu, &
                                 corr_vsep, corr_vjf, corr_vwage, corr_vprd, corr_vreall, &
                                 corr_thetasep, corr_thetajf, corr_thetawage, corr_thetaprod, corr_thetareall, &
                                 corr_sepjf, corr_sepwage, corr_sepprod, corr_sepreall, &
                                 corr_jfwage, corr_jfprod, corr_wageprod, corr_wagereall, corr_prodreall, &
                                 corr_jfreall, corr_vprod, corr_ujfo, corr_vjfo, corr_thetajfo, corr_sepjfo, corr_jfjfo, &
                                 corr_wagejfo, corr_prodjfo, corr_realljfo, &
                                 corr_uv5, corr_uv5_2, corr_utheta5, corr_usep5, corr_ujf5, corr_uwage5, corr_uprod5, corr_ureall5, corr_vtheta5,&
        corr_uallu5, corr_uallv5, corr_uallv5_2, corr_ualltheta5, corr_uallsep5, corr_ualljf5, corr_uallwage5, corr_uallprod5, corr_uallreall5, &
        corr_vsep5, corr_vjf5, corr_vwage5, corr_vprd5, corr_vreall5, &
                                 corr_thetasep5, corr_thetajf5, corr_thetawage5, corr_thetaprod5, corr_thetareall5, &
                                 corr_sepjf5, corr_sepwage5, corr_sepprod5, corr_sepreall5, &
                                 corr_jfwage5, corr_jfprod5, corr_wageprod5, corr_wagereall5, corr_prodreall5, &
                                 corr_jfreall5, corr_vprod5, corr_ujfo5, corr_vjfo5, corr_thetajfo5, corr_sepjfo5, corr_jfjfo5, &
                                 corr_wagejfo5, corr_prodjfo5, corr_realljfo5

    REAL(8) :: ac_u, ac_v, ac_theta, ac_sep, ac_jf, ac_wage, ac_prod, ac_reall, ac_jfo, ac_u5, &
                    ac_v5, ac_theta5, ac_sep5, ac_jf5, ac_wage5, ac_prod5, ac_reall5, ac_jfo5, ac_uall5, ac_uall



    REAL(8) :: var_uyoung, var_uprime, var_jfyoung, var_jfprime, var_sepyoung, var_sepprime, var_cmyoung,var_cmprime, var_cm, var_lsepyoung, var_lsepprime
    REAL(8) :: corr_uyoungprod, corr_uprimeprod, corr_jfyoungprod, corr_jfprimeprod, corr_sepyoungprod, corr_sepprimeprod
    REAL(8) :: corr_cmyoungprod, corr_cmprimeprod, corr_jfyoungunempl, corr_jfprimeunempl, corr_sepyoungunempl, corr_sepprimeunempl, corr_cmyoungunempl, corr_cmprimeunempl

    REAL(8) :: relstdev_occmob_y


    !REAL(8), DIMENSION(tmax) :: w_ave
    !REAL(8), DIMENSION(tmax-1) :: w_ave_uj, w_chg_jj, w_chg_uj
    !REAL(8), DIMENSION(nsim, tmax) ::  w_chg, w_chg_u


    REAL(8), ALLOCATABLE, DIMENSION(:,:) :: Xjf,Yjf
    !REAL(8)  ::
    REAL(8), DIMENSION(2) :: betajf





    REAL(8), DIMENSION(12) :: tmom             ! total moments
   ! statistics to report
    INTEGER(4) :: ycnt, vvcnt, vvpts, ttemp, ttemp2, vtemp, xtemp, ztemp, ztemp_indicator, tempstep, counter1, tempcounter, &
                                                                            vvcnt2, vvcnt3,  tempcounter1, tempcounter2, tempcounter3, sim_id, zcnt2, exper, yauxcnt,&
                                                                           expertemp, counter_eu, counter_en, counter_ne, counter_nu, counter_ue, counter_un, counter2, counter3
    INTEGER(4) :: yearcnt, ncnt,occcnt
    INTEGER(4) :: truthflag, truthflag2, flag1, flag2, flag3,switch_ind, u_flag, e_flag, flag_windowsurvival
    REAL(8) :: realstep, tempreal,tempreal2, tempreal3, factor, thetatemp
    REAL(8) :: tempreal4, tempreal5, tempreal6


    ! i/o, and time
    REAL(8)                 :: mu_temp, binsize, xstep, xvalue
    INTEGER(4)              :: bincounter, flag_z, i1
    LOGICAL                 :: exists, file_exists
    CHARACTER*24            :: dt
    CHARACTER*12, DIMENSION(3) :: time_string, input_string, time_string_begin, time_string_end
    REAL                    :: t1, t2, t_post_bwind
    CHARACTER*24            :: filename, x1,x2, errorpoint
    INTEGER 				:: ierr
    CHARACTER*24            :: filenm, filenm2
    CHARACTER*10            :: mom_id



! BASIC MATRICES!!!!!!!!!

REAL(8), DIMENSION(ppts,xpts, zpts) :: prod
REAL(8), DIMENSION(occpts, ppts,xpts, zpts) :: prod_occ


REAL(8), DIMENSION(ppts) :: pvector         !productivity
!REAL(8), DIMENSION(occpts) :: occprodvector
REAL(8), DIMENSION(ppts, ppts) :: ptransmatrix
REAL(8), DIMENSION(ppts) :: pnewpdf             ! unconditional z distribution for new draw
REAL(8), DIMENSION(xpts) :: xvector
REAL(8), DIMENSION(xpts) :: xpdfvector, xcdfvector
REAL(8), DIMENSION(xpts, xpts) ::  xtransmatrix
REAL(8), DIMENSION(zpts) :: zvector              ! dimension zpts
REAL(8), DIMENSION(zpts,zpts) ::  ztransmatrix, ztemptransmatrix, zrest4transmatrix, zrest6transmatrix, zrest8transmatrix   ! Probabilities of the idiosyncratic shock, dimension zpts
REAL(8), DIMENSION(zpts) :: znewpdf, znewcdf            ! unconditional z distribution for new draw
REAL(8), DIMENSION(ppts) :: temp_p_cdf

! tmax has the function here of having both present and tomorrow's value. Also used to figure out convergence!
REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: TH       ! (ppts,  xpts, zpts, tmax)          Tightness in market
REAL(8), ALLOCATABLE, DIMENSION(:,:,:,:) :: TH_Occ       ! (ppts,  xpts, zpts, tmax)          Tightness in market
REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: DmaxU     ! (ppts, xpts, zpts,tmax)                 Expected surplus value of search for unemployed
REAL(8), ALLOCATABLE, DIMENSION(:,:,:,:) :: DmaxU_Occ     ! (ppts, xpts, zpts,tmax)                 Expected surplus value of search for unemployed
!REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: EV       ! (ppts, zpts,tmax)                 Expected value of a new match
REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: Wage         ! (ppts, zpts,tmax)        Expected productivity of the match
REAL(8), ALLOCATABLE, DIMENSION(:,:,:,:) :: Wage_Occ         ! (ppts, zpts,tmax)        Expected productivity of the match
!REAL(8), ALLOCATABLE, DIMENSION(:,:,:) :: phi     ! (ppts, zpts,tmax)                 piece rate offered to previously unemployed
REAL(8), ALLOCATABLE, DIMENSION(:)  :: Realloc  !(ppts, tmax)              the value of reallocating
REAL(8), ALLOCATABLE, DIMENSION(:,:)  :: Realloc_Occ  !(ppts, tmax)              the value of reallocating

!policy functions (matrices)for the WORKERS
INTEGER, ALLOCATABLE, DIMENSION(:,:,:) :: poliDW ! (ppts, xpts, zpts, tmax)        MATCH BREAKUP DECISIONS: 1 for CONTINUATION, 0 for BREAKUP
INTEGER, ALLOCATABLE, DIMENSION(:,:,:) :: poliR ! (ppts, xpts, zpts, tmax)                 Reallocation decisions: 1 for CONTINUATION, 0 for REALLOCATION
INTEGER, ALLOCATABLE, DIMENSION(:,:,:,:) :: poliDW_Occ ! (ppts, xpts, zpts,occpts)         MATCH BREAKUP DECISIONS: 1 for CONTINUATION, 0 for BREAKUP
INTEGER, ALLOCATABLE, DIMENSION(:,:,:,:) :: poliR_Occ ! (ppts, xpts, zpts,occpts)          Reallocation decisions: 1 for CONTINUATION, 0 for REALLOCATION

!-------------------------
!  AUXILIARY FUNCTIONS
!-------------------------
REAL(8), ALLOCATABLE, DIMENSION(:,:,:)   :: JF       ! (ypts, xpts, zpts,  tmax)   Prob of Succesful application *from* a match unemployment at t
REAL(8), ALLOCATABLE, DIMENSION(:,:,:,:) :: JF_Occ       ! (ppts, xpts, zpts,occpts)
REAL(8), ALLOCATABLE, DIMENSION(:,:,:)   :: Searchdir_Occ       !(ppts, occpts, occpts)




REAL, DIMENSION(zpts) :: z_restricted_pdf, z_restricted_cdf, zoldpdf, zoldcdf
INTEGER, DIMENSION (zpts) :: best_islands_locator
INTEGER :: max_chosen_islands, islandcounter2, zcounter1


INTEGER, DIMENSION(ppts, xpts) :: reservation_zr, reservation_zq, zr_res, zs_res
INTEGER, DIMENSION(occpts, ppts, xpts)  :: reservation_zr_occ, reservation_zq_occ
INTEGER, DIMENSION(xpts) :: sepcutoff, reallcutoff

    !=============================================
    ! CONSTANTS TO CONTROL OPTIONS IN PROGRAM
    !=============================================


     INTEGER :: loopcounter
    INTEGER :: runnumber, threadnumber, islandcounter, islandcounter1
    INTEGER :: expts

    INTEGER(4) :: youngcutoff, lowcutoff, highcutoff, highcutoff2, gencutoff


    ! ------------------------------------
    !  FURTHER DISTRIBUTIONS
    !-----------------------------------------------

    ! distribution of aggregate states
    REAL(8), DIMENSION(ppts) :: p_distribution_sim

    ! distribution of (employed and )unemployed with aggregate states
    REAL(8), DIMENSION(ppts) :: up_distribution_sim, up_distribution_sim2, ep_distribution_sim, &
                                        uallp_distribution_sim, eallp_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_young_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_prime_distribution_sim
    ! distribution of (employed and unemployed over islands with different aggregate states
    REAL(8), DIMENSION(ppts, zpts) :: upz_distribution_sim, epz_distribution_sim
    REAL(8), DIMENSION(ppts, zpts) :: upz_young_distribution_sim, epz_young_distribution_sim
    REAL(8), DIMENSION(ppts, zpts) :: upz_prime_distribution_sim, epz_prime_distribution_sim
    ! distribution of (employed and unemployed over islands with different aggregate states PER SUPOCC
    REAL(8), DIMENSION(occpts, ppts, zpts) :: uopz_distribution_sim, eopz_distribution_sim
    REAL(8), DIMENSION(occpts, ppts, zpts) :: uopz_young_distribution_sim, eopz_young_distribution_sim
    REAL(8), DIMENSION(occpts, ppts, zpts) :: uopz_prime_distribution_sim, eopz_prime_distribution_sim
    ! distribution of (employed and unemployed over islands with different aggregate states PER SUPOCC
    REAL(8), DIMENSION(occpts, ppts, xpts, zpts) :: uopxz_distribution_sim, eopxz_distribution_sim
    
    ! total rest, reallocation, search unemployment
    ! distribution of (employed and )unemployed with aggregate states
    REAL(8), DIMENSION(ppts) :: up_rest_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_young_rest_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_prime_rest_distribution_sim
    ! distribution of (employed and )unemployed with aggregate states
    REAL(8), DIMENSION(ppts) :: up_search_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_young_search_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_prime_search_distribution_sim
    ! distribution of (employed and )unemployed with aggregate states
    REAL(8), DIMENSION(ppts) :: up_reall_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_young_reall_distribution_sim
    REAL(8), DIMENSION(ppts) :: up_prime_reall_distribution_sim
    ! distribution of (employed and )unemployed with aggregate states and SUPOCC
    REAL(8), DIMENSION(occpts,ppts) :: uop_rest_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_young_rest_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_prime_rest_distribution_sim
    ! distribution of (employed and )unemployed with aggregate states and SUPOCC
    REAL(8), DIMENSION(occpts,ppts) :: uop_search_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_young_search_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_prime_search_distribution_sim
    ! distribution of (employed and )unemployed with aggregate states and SUPOCC
    REAL(8), DIMENSION(occpts,ppts) :: uop_reall_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_young_reall_distribution_sim
    REAL(8), DIMENSION(occpts,ppts) :: uop_prime_reall_distribution_sim

    ! for the mM distribution
    ! distribution of (employed and unemployed over islands with different aggregate states
    REAL(8), DIMENSION(ppts, zpts) :: wagepz_distribution_sim, wagepz_young_distribution_sim, wagepz_prime_distribution_sim, &
                                        epz_1yb4_distribution_sim, sep_epz_1yb4_distribution_sim
    REAL(8), DIMENSION(ppts, xpts, zpts) :: epz_x_distribution_sim, epz_x_young_distribution_sim, epz_x_prime_distribution_sim, &
                                            upz_x_distribution_sim, upz_x_young_distribution_sim, upz_x_prime_distribution_sim, &
                                            epz_xallp_distribution_sim, epz_xallp_young_distribution_sim, epz_xallp_prime_distribution_sim, &
                                            epz_1yb4_x_distribution_sim, sep_epz_1yb4_x_distribution_sim

    REAL(8) :: epz_x1_pmass, epz_x2_pmass, epz_x3_pmass, epz_x1_young_pmass, epz_x2_young_pmass, epz_x3_young_pmass, &
                                    epz_x1_prime_pmass, epz_x2_prime_pmass, epz_x3_prime_pmass, epz_young_pmass, epz_prime_pmass
    REAL(8), DIMENSION(ppts) :: epz_x1_pmass_p, epz_x2_pmass_p, epz_x3_pmass_p, epz_x1_young_pmass_p, epz_x2_young_pmass_p,&
                                    epz_x3_young_pmass_p, epz_x1_prime_pmass_p, epz_x2_prime_pmass_p, epz_x3_prime_pmass_p, &
                                    epz_young_pmass_p, epz_prime_pmass_p



    !! mM distributions
    REAL(8) :: m0mratio_all, m0mratio_young, m0mratio_prime, m0mratio_x1, m0mratio_x2, m0mratio_x3, m0mratio_age_contr, m0mratio_age_x_contr, m0mratio_age_p_x_contr, m0mratio_age_p_contr
    REAL(8), DIMENSION(ppts) :: m0mratio_all_p, m0mratio_young_p, m0mratio_prime_p, m0mratio_x1_p, m0mratio_x2_p, m0mratio_x3_p
    REAL(8) :: m1mratio_all, m1mratio_young, m1mratio_prime, m1mratio_x1, m1mratio_x2, m1mratio_x3, m1mratio_age_contr, m1mratio_age_x_contr, m1mratio_age_p_x_contr, m1mratio_age_p_contr
    REAL(8), DIMENSION(ppts) :: m1mratio_all_p, m1mratio_young_p, m1mratio_prime_p, m1mratio_x1_p, m1mratio_x2_p, m1mratio_x3_p
    REAL(8) :: m5mratio_all, m5mratio_young, m5mratio_prime, m5mratio_x1, m5mratio_x2, m5mratio_x3, m5mratio_age_contr, m5mratio_age_x_contr, m5mratio_age_p_x_contr, m5mratio_age_p_contr
    REAL(8), DIMENSION(ppts) :: m5mratio_all_p, m5mratio_young_p, m5mratio_prime_p, m5mratio_x1_p, m5mratio_x2_p, m5mratio_x3_p
    REAL(8) :: m10mratio_all, m10mratio_young, m10mratio_prime, m10mratio_x1, m10mratio_x2, m10mratio_x3, m10mratio_age_contr, m10mratio_age_x_contr, m10mratio_age_p_x_contr, m10mratio_age_p_contr
    REAL(8), DIMENSION(ppts) :: m10mratio_all_p, m10mratio_young_p, m10mratio_prime_p, m10mratio_x1_p, m10mratio_x2_p, m10mratio_x3_p
    REAL(8) :: meanwage_all, meanwage_young, meanwage_prime, meanwage_x1, meanwage_x2, meanwage_x3
    REAL(8), DIMENSION(ppts) :: meanwage_all_p, meanwage_young_p, meanwage_prime_p, meanwage_x1_p, meanwage_x2_p, meanwage_x3_p

    REAL(8) :: meanwage_x1_young, meanwage_x2_young, meanwage_x3_young, meanwage_x1_prime, meanwage_x2_prime, meanwage_x3_prime
    REAL(8), DIMENSION(ppts) :: meanwage_x1_young_p, meanwage_x2_young_p, meanwage_x3_young_p, meanwage_x1_prime_p, meanwage_x2_prime_p, meanwage_x3_prime_p
    REAL(8) :: m0mratio_x1_young, m0mratio_x2_young, m0mratio_x3_young, m0mratio_x1_prime, m0mratio_x2_prime, m0mratio_x3_prime
    REAL(8), DIMENSION(ppts) :: m0mratio_x1_young_p, m0mratio_x2_young_p, m0mratio_x3_young_p, m0mratio_x1_prime_p, m0mratio_x2_prime_p, m0mratio_x3_prime_p
    REAL(8) :: m1mratio_x1_young, m1mratio_x2_young, m1mratio_x3_young, m1mratio_x1_prime, m1mratio_x2_prime, m1mratio_x3_prime
    REAL(8), DIMENSION(ppts) :: m1mratio_x1_young_p, m1mratio_x2_young_p, m1mratio_x3_young_p, m1mratio_x1_prime_p, m1mratio_x2_prime_p, m1mratio_x3_prime_p

    REAL(8) :: m5mratio_x1_young, m5mratio_x2_young, m5mratio_x3_young, m5mratio_x1_prime, m5mratio_x2_prime, m5mratio_x3_prime
    REAL(8), DIMENSION(ppts) :: m5mratio_x1_young_p, m5mratio_x2_young_p, m5mratio_x3_young_p, m5mratio_x1_prime_p, m5mratio_x2_prime_p, m5mratio_x3_prime_p
    REAL(8) :: m10mratio_x1_young, m10mratio_x2_young, m10mratio_x3_young, m10mratio_x1_prime, m10mratio_x2_prime, m10mratio_x3_prime
    REAL(8), DIMENSION(ppts) :: m10mratio_x1_young_p, m10mratio_x2_young_p, m10mratio_x3_young_p, m10mratio_x1_prime_p, m10mratio_x2_prime_p, m10mratio_x3_prime_p

    INTEGER :: counter_meanwage_all, counter_meanwage_young, counter_meanwage_prime, counter_meanwage_x1, counter_meanwage_x2, counter_meanwage_x3
    INTEGER, DIMENSION(ppts) :: counter_meanwage_all_p, counter_meanwage_young_p, counter_meanwage_prime_p, counter_meanwage_x1_p, counter_meanwage_x2_p, counter_meanwage_x3_p



    !--------------
    ! FURTHER VECTOR DEFINITIONS
    !------------------------------
    INTEGER, DIMENSION(tmax_sim2/12) :: number_agents               ! keeps track of agents in a growing economy
    INTEGER, DIMENSION(nsim_gen) :: initial_island




    REAL(8) :: reall_moment1, reall_moment2a, reall_moment2b, reall_moment3a, reall_moment3b
    REAL(8) :: duration_moment1, duration_moment2, duration_moment3, duration_moment4, duration_moment5
    REAL(8) :: duration_datamoment1, duration_datamoment2, duration_datamoment3, duration_datamoment4, duration_datamoment5
    REAL(8) :: udur_occ_moment1, udur_occ_moment2, udur_occ_moment3, udur_occ_moment1_data, udur_occ_moment2_data, udur_occ_moment3_data
    REAL(8) :: udur_nocc_moment1, udur_nocc_moment2, udur_nocc_moment3, udur_nocc_moment1_data, udur_nocc_moment2_data, udur_nocc_moment3_data



    REAL(8) :: min_unemp
    REAL(8) :: min_unemp_ee
    REAL(8) :: min_unemp_young_ee
    REAL(8) :: min_unemp_prime_ee

    REAL(8) :: max_unemp
    REAL(8) :: max_unemp_ee
    REAL(8) :: max_unemp_young_ee
    REAL(8) :: max_unemp_prime_ee

    REAL(8) :: unemp_ee_p5,unemp_ee_p10,unemp_ee_p25,unemp_ee_p50,unemp_ee_p75,unemp_ee_p90,unemp_ee_p95

    REAL(8) :: occmob_3m_p33, occmob_3m_p67, occmob_6m_p33, occmob_6m12_p67

    INTEGER :: warningcounter, improv_ind
    INTEGER(4) :: errmsg

    !! NETMOB ADDITIONS:

    INTEGER :: no_superwindows, tmax_swindow_qtr                  !! number of superwindows in the data, length of a superwindow
    INTEGER :: tswindow_qtr_min, tswindow_qtr_max                 !! quarter-t-index of beginning of superwindow, quarter-t-index of end of superwindow
    INTEGER :: tswindow_qtr_mask_min, tswindow_qtr_mask_max, tswindow_wks_min, tswindow_wks_max
    REAL(8) :: gamma_misc_within_superocc
    !Transition matrix overall (window)
    REAL(8),DIMENSION(4,4)                      :: data_superocc_transmatrix, data_corr_superocc_transmatrix, data_superocc_temptransmatrix
    REAL(8),DIMENSION(4,4,18)                   :: data_superocc_transmatrix_wdur, data_corr_superocc_transmatrix_wdur
    REAL(8),DIMENSION(4,4,18)                   :: data_superocc_ctransmatrix_wdur, data_corr_superocc_ctransmatrix_wdur

    REAL(8),ALLOCATABLE, DIMENSION(:,:,:)       :: data_superocc_transmatrix_qtr, data_corr_superocc_transmatrix_qtr
    REAL(8),ALLOCATABLE, DIMENSION(:,:)         :: data_supocc_sep_qtr,data_supocc_lsep_qtr, data_supocc_udur_qtr, data_supocc_ludur_qtr
    REAL(8),ALLOCATABLE, DIMENSION(:,:)         :: data_supocc_e_qtr, data_supocc_u_qtr, data_supocc_lu_qtr
    INTEGER,ALLOCATABLE, DIMENSION(:,:)         :: data_supocc_udur_counter_qtr

    REAL(8), DIMENSION(occpts)                  :: netmob_calc_vector, grossmob_calc_vector, corr_netmob_calc_vector, corr_grossmob_calc_vector
    REAL(8), DIMENSION(occpts, 18)              :: netmobdur_calc_vector, grossmobdur_calc_vector, corr_netmobdur_calc_vector, corr_grossmobdur_calc_vector
    REAL(8)                                     :: overall_netmob,overall_grossmob, overall_xsmob, overall_corr_netmob,overall_corr_grossmob, overall_corr_xsmob
    REAL(8), DIMENSION(18)                      :: overall_netmobdur,overall_grossmobdur, overall_xsmobdur, overall_corr_netmobdur,overall_corr_grossmobdur, overall_corr_xsmobdur

    !! scaling the 22MOG occupational mobility within superoccupation group
    REAL(8), DIMENSION(occpts,2)                  :: mobility_prop_within_supocc, corr_mobility_prop_within_supocc


    !CHARACTER*12 :: x1
    !INTEGER(4):: i1
    !LOGICAL :: file_exists


    !!OPEN(UNIT=33, file='smd_trace.txt', status='replace', form='formatted')
    !

    ! -----------------------------------------------------------
    !   FOR MATH KERNEL LIBRARY PSEUDO-RANDOM NUMBER GENERATOR
    ! -------------------------------------------------------
      integer n
      integer(kind=4) errcode

      integer brng,method,seed

      TYPE (VSL_STREAM_STATE) :: stream

  !================
  ! SOME DATA MOMENTS USED IN THE CALIBRATION
  !================

   CALL set_auxdata_moments



    !------------------------------------------
    ! WRITE OUTPUT TO FILE
    !------------------------------------------
    !call MPI_INIT(ierr)
    !CALL MPI_COMM_RANK(MPI_COMM_WORLD, threadnumber, ierr)
    threadnumber=mpthread
    i1= threadnumber
    !WRITE(*,*) 'thread reporting', i1
    WRITE(x1,FMT='(I3.3)') i1 ! converting integer to string using a 'internal file'
    filenm='output_'//trim(file_id)//trim(x1)//'.txt'

    INQUIRE(FILE=filenm, EXIST=file_exists)
    IF(file_exists) THEN
        IF((estim_counter/2000)*2000 .NE. estim_counter) THEN
            ! append if not 100 iterations
            OPEN(unit=10,file=filenm,status="old", form="formatted", position='append')
        ELSE
            ! replace file when more than a 100 iterations have been recorded
            OPEN(unit=10,file=filenm,status="replace",form="formatted")
        END IF
    ELSE
        OPEN(unit=10,file=filenm,status="replace",form="formatted")
    END IF


   !-----------
   ! SOME INITIAL INITIALIZATIONS, SETTINGS
   !---------------------
    restricted_search_ind=0
    !matrix_statistics=0
    runnumber=0
    expts=tmax

    tmin_sim2=(tmin_sim2basic/12)*12


    !--------------------------------
    ! THREADNUMBERS (BOTH FOR MPI AND OPENMP -- VERIFY!)
    !--------------------------------


    !threadnumber=1
    !$ threadnumber=omp_get_thread_num()
    !WRITE(10,*) '------- threadnumber = ', threadnumber

    !---------------------------------------------------------
    !           REPORTING ON THE SWITCHING
    !---------------------------------------------------------




        !WRITE(*,*) 'MODEL PERIOD ------ WEEKLY'
        !youngcutoff=480                                               ! cutoff for young
        ! AVERAGE AGE OF 20-30yo who have entered, and earlier employment (even with
        ! su tage [w=pweight2] if entry_ind==1 & earlier_empl==1 & tage>=20 & tage<=30 & wave>4

        !    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
        !-------------+-----------------------------------------------------------------
        !        tage | 1.3e+06  1503015.98    25.92234   2.810108         20         30


        !. su tage [w=pweight2] if earlier_empl==1 & tage>=18 & tage<=30 & wave>4
        !(analytic weights assumed)
        !
        !    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
        !-------------+-----------------------------------------------------------------
        !        tage | 1.5e+06  1706244.81     25.3576   3.070447         20         30



        youngcutoff=432         ! average 9 years in the market when young; enter on average at age 21.
        lowcutoff=672                                                 ! lower cutoff for prime
        highcutoff=1632 !max(tmax_sim2, tmax_sim) !2160                     ! higher cutoff for prime 2160/48=45
        gencutoff=max(tmax_sim2, tmax_sim) ! CAN CUT OFF WORKING LIFE IN SIMULATIONS (e.g. at 216), or just infinite life, latter is default
        highcutoff2=gencutoff !highcutoff  !=gencutoff                           ! age cutoff for cm(dur) calculations.
        bt=0.9997_8                                    !bt=0.9992_8
        dd=0.00048_8
        




        

 !================================================
  !----------------------------------------
	!  PARAMETERS -  VERSIONS
	!---------------------------------------
!======================================================


        

 IF (standard_theta_to_pars_ind==1) THEN
   delta=thetal(1)
   reallc=thetal(2)
   k=thetal(3)
   b=thetal(4)

   rho_p=thetal(5)
   sigma_p=thetal(6)

   rho_z=thetal(7)
   sigma_z=thetal(8)
   eta= thetal(9)

   zcorrection=thetal(10)

   IF(xpts>=3) THEN
   xvector(1)=1.0_8
   xvector(2)=thetal(11)
   xvector(3)=thetal(12)
   ELSE IF (xpts==1) THEN
   xvector=1.0_8
   END IF

   directed_parameter=1.0_8
   skilldep=0.0_8
   skilldep=thetal(13)

    IF(heterogenous_delta_ind==1) THEN
        deltalowhc=thetal(1)
        deltahighhc=thetal(14)
    ELSE
        deltalowhc=delta
        deltahighhc=delta
    END IF

END IF


entry_test_distr=0.0

IF(netmob_theta_modsolve==1) THEN

!! PRODUCTIVITY HETEROGENEITY
occprodvector(1)=thetal(15)
occprodvector(3)=thetal(16)
occprodvector(4)=thetal(17)
!! set as the remainder to create an average of 1.0
tempreal=0.5*(corr_occdistr_begin_end_data(1,1)+corr_occdistr_begin_end_data(1,2))*thetal(15)
tempreal=tempreal+0.5*(corr_occdistr_begin_end_data(3,1)+corr_occdistr_begin_end_data(3,2))*thetal(16)
tempreal=tempreal+0.5*(corr_occdistr_begin_end_data(4,1)+corr_occdistr_begin_end_data(4,2))*thetal(17)
occprodvector(2)=MAX((1.0-tempreal)/(0.5*(corr_occdistr_begin_end_data(2,1)+corr_occdistr_begin_end_data(2,2))),0.0)

!! RESPONSE ELASTICITY
occaggprod_elas(1)=thetal(18)
occaggprod_elas(3)=thetal(19)
occaggprod_elas(4)=thetal(20)
!! set as the remainder to create a weighted average 1.0
tempreal=0.5*(corr_occdistr_begin_end_data(1,1)+corr_occdistr_begin_end_data(1,2))*thetal(18)+ &    !1.0- !thetal(20)       ! normalized to 1? (Check which normalization gives the fastest estimation). Maybe not: need freedom of all parameters to hit average responsiveness=1
                0.5*(corr_occdistr_begin_end_data(3,1)+corr_occdistr_begin_end_data(3,2))*thetal(19)+ &
                0.5*(corr_occdistr_begin_end_data(4,1)+corr_occdistr_begin_end_data(4,2))*thetal(20)
occaggprod_elas(2)=MAX(((1.0-tempreal)/(0.5*(corr_occdistr_begin_end_data(2,1)+corr_occdistr_begin_end_data(2,2)))),0.0)

!! EXOGENOUS INFLOW PARAMETERS
entry_occdistr(1)=MIN(thetal(21),1.0)
entry_occdistr(2)=MAX(MIN(entry_occdistr(1)+thetal(22),1.0),0.0)
entry_occdistr(3)=MAX(MIN(entry_occdistr(2)+thetal(23),1.0),0.0)
entry_occdistr(4)=1.0


!! SEARCH PARAMETERS
searchdir_pars(1,1)=thetal(24)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(1,2)=(1.0-thetal(24))*thetal(25)
searchdir_pars(1,3)=(1.0-thetal(24))*thetal(26)
searchdir_pars(1,4)=MAX(MIN((1.0-thetal(24))*(1.0-thetal(26)-thetal(25)),1.0),0.0)
searchdir_pars(2,1)=(1.0-thetal(24))*thetal(27)
searchdir_pars(2,2)=thetal(24)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(2,3)=(1.0-thetal(24))*thetal(28)
searchdir_pars(2,4)=MAX(MIN((1.0-thetal(24))*(1.0-thetal(27)-thetal(28)),1.0),0.0)
searchdir_pars(3,1)=(1.0-thetal(24))*thetal(29)
searchdir_pars(3,2)=(1.0-thetal(24))*thetal(30)
searchdir_pars(3,3)=thetal(24)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(3,4)=MAX(MIN((1.0-thetal(24))*(1.0-thetal(29)-thetal(30)),1.0),0.0)
searchdir_pars(4,1)=(1.0-thetal(24))*thetal(31)
searchdir_pars(4,2)=(1.0-thetal(24))*thetal(32)
searchdir_pars(4,3)=MAX(MIN((1.0-thetal(24))*(1.0-thetal(31)-thetal(32)),1.0),0.0)
searchdir_pars(4,4)=thetal(24)      ! move but stay in superocc: constant across occ/superocc
occsearch_elas=thetal(33)
END IF



IF(netmob_22par_modsolve==1) THEN

!! PRODUCTIVITY HETEROGENEITY
occprodvector(1)=thetal(15)
occprodvector(3)=thetal(16)
occprodvector(4)=thetal(17)
!! set as the remainder to create an average of 1.0
tempreal=0.5*(corr_occdistr_begin_end_data(1,1)+corr_occdistr_begin_end_data(1,2))*thetal(15)
tempreal=tempreal+0.5*(corr_occdistr_begin_end_data(3,1)+corr_occdistr_begin_end_data(3,2))*thetal(16)
tempreal=tempreal+0.5*(corr_occdistr_begin_end_data(4,1)+corr_occdistr_begin_end_data(4,2))*thetal(17)
occprodvector(2)=MAX((1.0-tempreal)/(0.5*(corr_occdistr_begin_end_data(2,1)+corr_occdistr_begin_end_data(2,2))),0.0)

!! RESPONSE ELASTICITY
occaggprod_elas(1)=thetal(18)
occaggprod_elas(3)=thetal(19)
occaggprod_elas(4)=thetal(20)
!! set as the remainder to create a weighted average 1.0
tempreal=0.5*(corr_occdistr_begin_end_data(1,1)+corr_occdistr_begin_end_data(1,2))*thetal(18)+ &    !1.0- !thetal(20)       ! normalized to 1? (Check which normalization gives the fastest estimation). Maybe not: need freedom of all parameters to hit average responsiveness=1
                0.5*(corr_occdistr_begin_end_data(3,1)+corr_occdistr_begin_end_data(3,2))*thetal(19)+ &
                0.5*(corr_occdistr_begin_end_data(4,1)+corr_occdistr_begin_end_data(4,2))*thetal(20)
occaggprod_elas(2)=MAX(((1.0-tempreal)/(0.5*(corr_occdistr_begin_end_data(2,1)+corr_occdistr_begin_end_data(2,2)))),0.0)

!! EXOGENOUS INFLOW PARAMETERS
entry_occdistr(1)=MIN(thetal(21),1.0)
entry_occdistr(2)=MAX(MIN(entry_occdistr(1)+thetal(22),1.0),0.0)
entry_occdistr(3)=MAX(MIN(entry_occdistr(2)+thetal(23),1.0),0.0)
entry_occdistr(4)=1.0


!! SEARCH PARAMETERS
searchdir_pars(1,1)=thetal(24)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(1,2)=(1.0-thetal(24))*thetal(25)
searchdir_pars(1,3)=(1.0-thetal(24))*(MIN(thetal(26), (1.0-thetal(25))))
searchdir_pars(1,4)=MAX(MIN((1.0-thetal(24))*(1.0-thetal(26)-thetal(25)),1.0),0.0)
searchdir_pars(2,1)=(1.0-thetal(34))*thetal(27)
searchdir_pars(2,2)=thetal(34)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(2,3)=(1.0-thetal(34))*(MIN(thetal(28), (1.0-thetal(27))))
searchdir_pars(2,4)=MAX(MIN((1.0-thetal(34))*(1.0-thetal(27)-thetal(28)),1.0),0.0)
searchdir_pars(3,1)=(1.0-thetal(35))*thetal(29)
searchdir_pars(3,2)=(1.0-thetal(35))*(MIN(thetal(30), (1.0-thetal(29))))
searchdir_pars(3,3)=thetal(35)      ! move but stay in superocc: constant across occ/superocc
searchdir_pars(3,4)=MAX(MIN((1.0-thetal(35))*(1.0-thetal(29)-thetal(30)),1.0),0.0)
searchdir_pars(4,1)=(1.0-thetal(36))*thetal(31)
searchdir_pars(4,2)=(1.0-thetal(36))*(MIN(thetal(32), (1.0-thetal(31))))
searchdir_pars(4,3)=MAX(MIN((1.0-thetal(36))*(1.0-thetal(31)-thetal(32)),1.0),0.0)
searchdir_pars(4,4)=thetal(36)      ! move but stay in superocc: constant across occ/superocc
occsearch_elas=thetal(33)
END IF

CALL DATE_AND_TIME(time_string_begin(1), time_string_begin(2), time_string_begin(3))

IF(verbose_netmob_solve) THEN
    WRITE(*,FMT='(A8,I2, A9, A8,X, A10,2X, A8, X,A10)') 'thread: ', threadnumber, 'Start/End:'  , time_string_begin(1),time_string_begin(2)
    WRITE(*,*)  ' '
   WRITE(*,*) ' --- NET MOBILITY PARAMETERS ---'
   WRITE(*,FMT='(A12,F9.4, A13, F9.4, A5, F9.4, A5, F9.4)') 'occprod: *', occprodvector(1), '  , (implied)' , occprodvector(2), '  , *' ,occprodvector(3), '  , *', occprodvector(4)
   WRITE(*,FMT='(A12,F9.4, A13, F9.4, A5, F9.4, A5, F9.4)') 'occelas: *', occaggprod_elas(1), '  , (implied)' , occaggprod_elas(2), '  , *' ,occaggprod_elas(3), '  , *', occaggprod_elas(4)
   WRITE(*,FMT='(A12,F9.4, A13, F9.4, A5, F9.4, A5, F9.4)') 'ocentry: *', entry_occdistr(1), '  , *        ' , entry_occdistr(2), '  , *' ,entry_occdistr(3), '  , i', entry_occdistr(4)
   WRITE(*,FMT='(A12,F9.4, A13, F9.4, A5, F9.4, A5, F9.4)') 'ocenpdf: *', entry_occdistr(1), '  , *        ' , entry_occdistr(2)-entry_occdistr(1), '  , *' ,entry_occdistr(3)-entry_occdistr(2), '  , i', entry_occdistr(4)-entry_occdistr(3)
   WRITE(*,*)  ' Occupation search technology parameters'
   WRITE(*,FMT='(A18,F9.4, A10, F9.4, A10, F9.4, A10, F9.4)') 'o1s: (share)', searchdir_pars(1,1), '  , * ' , searchdir_pars(1,2), '  , *' ,searchdir_pars(1,3), '  , (imp) ', searchdir_pars(1,4)
   WRITE(*,FMT='(A18,F9.4, A10, F9.4, A10, F9.4, A10, F9.4)') 'o2s: *', searchdir_pars(2,1), '  , (shr) ' , searchdir_pars(2,2), '  , *' ,searchdir_pars(2,3), '  , (imp) ', searchdir_pars(2,4)
   WRITE(*,FMT='(A18,F9.4, A10, F9.4, A10, F9.4, A10, F9.4)') 'o3s: *', searchdir_pars(3,1), '  , * ' , searchdir_pars(3,2), '  , (shr) ' ,searchdir_pars(3,3), '  , (imp) ', searchdir_pars(3,4)
   WRITE(*,FMT='(A18,F9.4, A10, F9.4, A10, F9.4, A10, F9.4)') 'o4s: *', searchdir_pars(4,1), '  , * ' , searchdir_pars(4,2), '  , (imp) ' ,searchdir_pars(4,3), '  , (shr) ', searchdir_pars(4,4)
   WRITE(*,*)  ' Occupation search elasticity parameter: ' , occsearch_elas
   WRITE(*,*) ' '
   WRITE(*,*)  'begin(1-4)-end(1-4) distribution:'
   WRITE(*, FMT='(8(F9.4,A1))' ) corr_occdistr_begin_end_data(1,1), ',', corr_occdistr_begin_end_data(2,1), ',' , corr_occdistr_begin_end_data(3,1), ',', corr_occdistr_begin_end_data(4,1), '|', &
                                    corr_occdistr_begin_end_data(1,2), ',', corr_occdistr_begin_end_data(2,2), ',' , corr_occdistr_begin_end_data(3,2), ',', corr_occdistr_begin_end_data(4,2), '|'
END IF










occdistr_exo_entry_exit=0.0
corr_occdistr_exo_entry_exit=0.0
occdistr_endo_entry_exit=0.0
corr_occdistr_endo_entry_exit=0.0

    !====================================
    !  SET AUXILIARY VARIABLES, TO BE CHANGED LATER (MOVE TO GLOBAL)
    !=====================================


   IF (miscoding_estimation_ind==1) THEN
       directed_parameter=1.0
       miscoding_estimation=thetal(13)

   END IF
    IF (miscoding_parameter_ind==1) THEN
       miscoding_estimation=miscoding_par+miscoding_par-(miscoding_par*(miscoding_par/10.0_8))  !incorporating that miscoding can occur on both sides of the unemployment spell
                                                                                                !, but that a miscoding that involves two times the exact same occupation is unlikely (hence the division by a factor 10)
    END IF


    IF (exo_gamma_misc_within_superocc_ind==1) THEN
            gamma_misc_within_superocc=exo_gamma_misc_within_superocc
    ELSE IF (gamma_misc_within_superocc_data>=0.0 .AND. gamma_misc_within_superocc_data<1.0) THEN 
            gamma_misc_within_superocc=gamma_misc_within_superocc_data
    END IF

   sep_cutoff=dd+ (1.0_8-dd)*(1.0_8-delta)         ! used in the simulation, implied cutoff for random number used separation
   sep_cutoff_vec=dd+ (1.0_8-dd)*(1.0_8-delta)
   IF (heterogenous_delta_ind==1 .AND. xpts>1) THEN
   sep_cutoff_vec(1)=dd+ (1.0_8-dd)*(1.0_8-deltalowhc)         ! used in the simulation, implied cutoff for random number used separation
   sep_cutoff_vec(2:xpts)=dd+ (1.0_8-dd)*(1.0_8-deltahighhc)         ! used in the simulation, implied cutoff for random number used separation
   END IF
   skilldep_cutoff=dd+(1.0_8-dd)*(1.0_8-skilldep)

   IF(directed_parameter>1.0_8) directed_parameter=1.0_8
   IF(directed_parameter==1.0_8) restricted_search_ind=0
   IF(directed_parameter<0.0_8) directed_parameter=0.0001_8





!============================================
!  FURTHER DATA FOR SMD
!===========================================

    ac_p_data=0.753_8           ! autocorrelation of production
    sd_p_data=0.00940_8           ! volatility of HP productivity
    
    ! returns to tenure
    rtnoccten5yr_data=0.154_8   ! returns to 5yr tenure
    rtnoccten10yr_data=0.232_8       ! returns to 10yr tenure


    ! THE DATA MOMENTS BELOW ARE DEPRECATED OR ARE ENTERED IN A DIFFERENT WAY    
    !cm_data=0.547_8             ! percentage of monthly job finding with an occupational change (stock at duration 2 months) 0.008_8
    cm_data=0.532              ! second month composition
    lcmy_lcmp_data=0.16_8       ! decline in occupational mobility with age: ln 0.6 - ln 0.5
    !lcmy_lcmp_data=((tot_durationmatrix_cocc_young_data(2)/tot_durationmatrix_cocc_prime_data(2)))-1.0_8       ! 1.14 ratio -1
    !jf_ave_data=0.241_8           ! monthly job finding rate NOW IN MOD_AUXDATA_MOMENTS
    !elmatch_data=0.5000_8          ! elasticity of the matching function
    cmaftercm_cmaftercs_data=0.639/0.37              ! occafterocc/cocc_inflow DEPRECATED
    logwage_disp_diff_all_data=0.05_8           
    logwage_disp_diff_highoccten_data=0.07_8

CALL set_auxdata_moments

!============================
!   PRODUCTIVITY EVOLUTIONS
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!===========================

!-----------------------------------------------
!  OCC EXPERIENCE, and ACCUMULATION process
!----------------------------------------------


    xtransmatrix=0.0_8
    IF(xpts==3) THEN
        xtransmatrix(1,1)=0.99615_8            ! stochastic aging, weekly model, 5y, 10y
        xtransmatrix(1,2)=0.00385_8
        xtransmatrix(2,2)=0.99615_8
        xtransmatrix(2,3)=0.00385_8
        xtransmatrix(3,3)=1.0_8
    ELSE IF (xpts==1) THEN
        xtransmatrix(1,1)=1.0_8
    END IF
!----------------------------------------------------
!      AGGREGATE PRODUCTIVITY PROCESS
!----------------------------------------------------


CALL sub_tauchen(ppts, plambda, rho_p, sigma_p, pvector, ptransmatrix,0)
!IF (rouwenhorst_ind==1) CALL Rouwenhorst(rho_p, 0.0_8, sigma_p, ppts, pvector, ptransmatrix)
CALL sub_gamastar(ptransmatrix, pnewpdf)
!WRITE(10,*) 'outside tauchen'
!
!     !$OMP MASTER
     IF(printtransitionmatrix_ind==1) THEN
     INQUIRE (FILE='tauchen.txt', EXIST=exists)
        IF(exists) OPEN(UNIT=20, file="tauchen.txt", status="replace", form="formatted")
        IF(exists == .FALSE.) OPEN(UNIT=20, file="tauchen.txt", status="unknown", form="formatted")
!
               WRITE(20,*) ' '
               WRITE(20,*) ' '
               WRITE(20,*) '============================================================='
               WRITE(20,*) '==, rho_p:', rho_p, '==,sigma:',sigma_p
               WRITE(20,*) '-------------------------------------------------------------'
               WRITE(20,FMT='(2(A10))', ADVANCE='no')  'grid,', 'stat dist,'
!
               DO zcnt=1,SIZE(pvector)-1
                        WRITE(20,FMT='(I3,A6,A1)', ADVANCE='no') zcnt,'trans' , ','
               END DO
                        WRITE(20,FMT='(I3,A6,A1)') SIZE(pvector),'trans', ','
!
              DO zcnt=1,SIZE(pvector)
                    WRITE(20,FMT='(2(F9.4,A1))', ADVANCE='no')  pvector(zcnt), ',' , pnewpdf(zcnt), ','
                  DO xcnt=1,SIZE(pvector)-1
                        WRITE(20,FMT='(F9.4,A1)', ADVANCE='no')  ptransmatrix(zcnt,xcnt), ','
                  END DO
!
                  WRITE(20,FMT='(F9.4,A1)')  ptransmatrix(zcnt,SIZE(pvector)), ','
              END DO
!
              WRITE(20,*) 'long run average aggregate productivity is ', sum(pvector(:)*pnewpdf(:))
       CLOSE(20)
       END IF
       !$OMP END MASTER
!
CALL sub_tauchen(zpts, zlambda, rho_z, sigma_z, zvector, ztransmatrix, 0)       ! 0,1 is precision_ind, creates more precision at the bottom
!IF (rouwenhorst_ind==1) CALL Rouwenhorst(rho_z, 0.0_8, sigma_z, zpts, zvector, ztransmatrix)



CALL sub_gamastar(ztransmatrix, znewpdf(1:zpts))
!WRITE(10,*) 'outside z-tauchen-2'

znewcdf(1)=znewpdf(1)


  DO zcnt=2, zpts
    !WRITE(10,*) zvector(zcnt), znewpdf(zcnt)
    znewcdf(zcnt)=znewcdf(zcnt-1)+znewpdf(zcnt)
  END DO
znewcdf(zpts)=1.0_8

zvector=zvector-zcorrection


!---------------------------------------------------------
!                   NEW Z DISTRIBUTION: drawn from the stationary distribution of z
!---------------------------------------------------------

!CALL sub_gamastar(ztransmatrix, znewpdf)

IF(sum(znewpdf)<0.99 .OR. sum(znewpdf)>1.01) THEN
 WRITE(*,*) 'mistake in stationary z distribution'
znewcdf(1)=znewpdf(1)
!WRITE(*,*) zvector(1), znewpdf(1)
  IF (threadnumber==1) THEN
  DO zcnt=2, zpts
      IF(verboseswitch==1) WRITE(10,*) zvector(zcnt), znewpdf(zcnt)
    znewcdf(zcnt)=znewcdf(zcnt-1)+znewpdf(zcnt)
  END DO
  END IF
  !PAUSE
END IF






!------------------------------------------------
! PRODUCTION MATRIX ASSIGNMENT
!-----------------------------------------------


DO pcnt=1, ppts
        DO xcnt=1, xpts
            DO zcnt=1, zpts
               prod(pcnt, xcnt, zcnt)=pfunction(pcnt, xcnt, zcnt)
            END DO
        END DO
END DO


!-------------------------
! ADD RESTRICTED SEARCH //// DISPLAY PRODUCTIVITY DISTRIBUTIONS
!------------------------

IF (threadnumber==1 .AND. verbose_results_l1==2) THEN
WRITE(10,*) 'zvector(1): ', zvector(1), '-- pdf:', znewpdf(1), 'cdf:', znewcdf(1)
WRITE(10,*) 'zvector(zpts): ', zvector(zpts), '-- pdf:', znewpdf(zpts), 'cdf:', znewcdf(zpts)
END IF

        ! explanation: directed_parameter gives the mass of islands considered, i.e. 0.2, means that
        ! the top 20% of islands is considered

znewpdf_under_restricted_search: IF (restricted_search_ind==1 .AND. directed_parameter<1.00_8) THEN

tempreal=0.0_8
z_restricted_pdf=0.0_8
z_restricted_cdf=0.0_8

IF (znewpdf(zpts)>=directed_parameter) THEN
        WRITE(10,*) 'znewpdf, directed_parameter', znewpdf(zpts), directed_parameter
        z_restricted_pdf(zpts)=1.0_8
        z_restricted_cdf(zpts)=1.0_8
        tempint=zpts
ELSE
    tempreal=0.0_8
    tempcounter1=0
    tempint=1
    restricted_do: DO zcnt=zpts, 1, -1
        IF (tempreal+znewpdf(zcnt)>=directed_parameter ) THEN       !.AND. tempcounter1==0
            z_restricted_pdf(zcnt)=(directed_parameter-tempreal)/(directed_parameter)
            z_restricted_cdf(zcnt)=(directed_parameter-tempreal)/(directed_parameter)
            tempint=zcnt+1
            tempcounter1=1
            EXIT restricted_do
        ELSE !! IF (tempcounter1==0) THEN
            tempreal=tempreal+znewpdf(zcnt)
        END IF
    END DO  restricted_do

    DO zcnt=max(1,tempint), zpts
    z_restricted_pdf(zcnt)=znewpdf(zcnt)/directed_parameter                 !! make sure tempint>0
    z_restricted_cdf(zcnt)=z_restricted_cdf(zcnt-1)+z_restricted_pdf(zcnt)
    END DO
END IF

CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
WRITE(10,*) 'date=', time_string(1)
WRITE(10,*) 'time=', time_string(2)
!CALL DATE_AND_TIME(time_string_begin(1), time_string_begin(2), time_string_begin(3))
IF(verbose_progress==1) &
    WRITE(*,*) 'start (after initialization)', time_string(2)


IF (z_restricted_cdf(zpts)>1.001_8 .OR. z_restricted_cdf(zpts)<0.999_8) THEN
     WRITE(*,*) (z_restricted_cdf(i), i=1,zpts )
     WRITE(*,*) 'ERROR IN THE RESTRICTED SEARCH CUTOFF'
        STOP
END IF
zoldpdf=znewpdf
znewpdf=z_restricted_pdf

zoldcdf=znewcdf
znewcdf=z_restricted_cdf


IF(verboseswitch==1) WRITE(*,*) 'stationary z distribution, zvector, pvector'
DO zcnt=1, zpts
 IF(verboseswitch==1) WRITE(*,*) znewpdf(zcnt), zvector(zcnt), pvector(MIN(zcnt,ppts))
END DO



IF(threadnumber==1) THEN
    IF(verboseswitch==1) WRITE(*,*) 'znewpdf: ', znewpdf
    IF(verboseswitch==1) WRITE(*,*) 'znewcdf: ', znewcdf
END IF
tempreal=znewcdf(zpts)
znewcdf=znewcdf/tempreal
znewpdf=znewpdf/tempreal

IF(verboseswitch==1) WRITE(*,*) 'productivity assigned'

END IF znewpdf_under_restricted_search

tempreal=0.0_8
tempreal2=0.0_8




!--------------------
! ALLOCATING THE ARRAYS
!--------------------


CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
IF(verboseswitch==1) WRITE(*,*) 'date=', time_string(1), 'time=', time_string(2)
time_string_begin=time_string
call cpu_time ( t1 )

  !$OMP CRITICAL
ALLOCATE(poliDW(ppts,xpts, zpts), & !TH(ypts, 0:expts, zpts, tmax),TH_U(ypts, 0:expts, tmax)&
                        PoliR(ppts, xpts, zpts), & !EV(ppts, zpts, 2),REALLOC(ppts), DmaxU(ppts, xpts, zpts)
                        JF(ppts, xpts, zpts) , WAGE(ppts, xpts,zpts))
ALLOCATE(poliDW_Occ(occpts, ppts,xpts, zpts), & !TH(ypts, 0:expts, zpts, tmax),TH_U(ypts, 0:expts, tmax)&
                        PoliR_Occ(occpts, ppts, xpts, zpts), & !EV(ppts, zpts, 2),REALLOC(ppts), DmaxU(ppts, xpts, zpts)
                        JF_Occ(occpts, ppts, xpts, zpts) , WAGE_Occ(occpts, ppts, xpts,zpts), Searchdir_Occ(occpts, occpts,ppts))


  !$OMP END CRITICAL


    poliR(:,:,:)=0
    poliDW(:,:,:)=0
    JF(:,:,:)=0.0_8
    !EV(:,:,:)=0.0_8
    WAGE(:,:,:)=0.0_8
    !REALLOC(:)=0.0_8

    poliR_Occ(:,:,:,:)=0
    poliDW_Occ(:,:,:,:)=0
    JF_Occ(:,:,:,:)=0.0_8
    !EV(:,:,:)=0.0_8
    WAGE_Occ(:,:,:,:)=0.0_8
    Searchdir_Occ(:,:,:)=0.0_8

  !!--------------------------
  !! INITIAL GUESS VE, VU, zr, zs
  !!--------------------------


    VE(:,:,:)=b/(1.0-bt*(1.0-dd))
    VU(:,:,:)=b/(1.0-bt*(1.0-dd))



! put separation cutoffs half way (no need to calculate it more precise, as that routine will be repeated inside ctv_backwards_induct
reservation_zr(1:ppts, 1:xpts)=(zpts/2)+1
reservation_zq(1:ppts, 1:xpts)=(zpts/2)+1

!-------
! CHECK VE and VU guess constructed.
!-------

        ! check that the properties of the guess are not too crazy.

!!-------------------- WRITE EV, VE to file

        !    OPEN(UNIT=19, file="ev_ve.txt", status="replace", form="formatted")
        !
        !               WRITE(19, FMT='(7(A3, A12)))', ADVANCE='NO'),"   ", "pvector,", "   ", "zvector,", "   ", "xvector,", "   ", "VEl(p, x, z)," , "   ", "pisswage "
        !               WRITE(19, FMT='(4(A3, A12)))', ADVANCE='NO'),"   ", "wage lb,", "   ",  "const flow,", "   ", "wage(p,x,z)", "   ", "prod(p,x,z)"
        !               WRITE(19, FMT='(3(A12, A3),2(A2,A3))'), "VUl(p,x,z),", "   ", "jfl(p,x,z)," , "   ", "D," , "   ", "R," ,"   "
        !    DO pcnt=1, ppts, (MAX(ppts/10,1))
        !        DO xcnt=1, xpts
        !            DO zcnt=1, zpts
        !               WRITE(19, FMT='(7(A3, F12.6)))', ADVANCE='NO'),"   ", pvector(pcnt), "   ", zvector(zcnt), "   ",xvector(xcnt), "   ",VE(pcnt, xcnt, zcnt),"   ",(1-eta)*prod(pcnt, xcnt, zcnt)+eta*b+bt*(1-dd)*jf(pcnt, xcnt, zcnt)**(1.0_8/eta)*k
        !               WRITE(19, FMT='(4(A3, F12.6)))', ADVANCE='NO'),"   ", VE(pcnt, xcnt, zcnt)*(1-bt*(1-dd)), "   ", (VE(pcnt, xcnt, zcnt)-VU(pcnt,xcnt, zcnt))*(1-bt*(1-dd)*(1-delta)+bt*(1-dd)*jf(pcnt, xcnt, zcnt))+b, "   ", wage(pcnt, xcnt, zcnt), "   ",  prod(pcnt, xcnt, zcnt)
        !               WRITE(19, FMT='(A3, 3(F12.6, A3),2(I2,A3))'), "   ", VU(pcnt, xcnt, zcnt), "   ", jf(pcnt, xcnt, zcnt), "   ",poliDW(pcnt, xcnt, zcnt), "   ",poliR(pcnt, xcnt, zcnt),"   "
        !!               WRITE(*,FMT='(5(F12.6, A3))'), pvector(pcnt), "   ",zvector(zcnt), "   ",xvector(xcnt), "   ",VEl(pcnt, xcnt, zcnt,1), "   ",ev(pcnt, zcnt,1), "   "
        !             END DO
        !        END DO
        !    END DO
        !    CLOSE(UNIT=19)


  !--------------------------------
  ! CALL BACKWARDS INDUCTION
  !--------------------------------

!CALL ctv_backwards_induct(VE,VU, reservation_zr, reservation_zq, poliDW, poliR, jf, wage, &
!                            prod, ztransmatrix, ptransmatrix, xtransmatrix, znewpdf, threadnumber, skilldep, pvector, deltalowhc, deltahighhc)
CALL ctv_backwards_induct_nm(VE, VU, reservation_zr, reservation_zq, poliDW, poliR, jf, wage, &
                             VEO, VUO, reservation_zr_occ, reservation_zq_occ, poliDW_Occ, PoliR_Occ, JF_Occ, WAGE_Occ, Searchdir_Occ, &
                             prod, ztransmatrix, ptransmatrix, xtransmatrix, znewpdf, &
                             threadnumber, skilldep, pvector, zvector, xvector, &
                             deltalowhc, deltahighhc, &
                             occprodvector, occaggprod_elas, searchdir_pars , occsearch_elas)



!------------------------ CHECK ON WAGES, AND VALUE FUNCTIONS


!---------- some more housekeeping
!  !$OMP CRITICAL
!DEALLOCATE(VE, VU)  ! ev excluded
!  !$OMP END CRITICAL

IF (decisionrules_excessmob_occ_test_ind==1) THEN
CALL CPU_TIME(t_post_bwind)
IF(verbose_progress) WRITE(*,*) 'CPU time in BW induction', t_post_bwind-t1
    !DO pcnt=1, ppts
    !DO zcnt=1, zpts
    !DO xcnt=1, xpts
    !    poliR_Occ(:,pcnt,xcnt,zcnt)=poliR(pcnt,xcnt,zcnt)
    !    poliDW_Occ(:,pcnt,xcnt,zcnt)=poliDW(pcnt,xcnt,zcnt)
    !    JF_Occ(:,pcnt,xcnt,zcnt)=JF(pcnt,xcnt,zcnt)
    !    VUO(:,pcnt, xcnt, zcnt)=VU(pcnt, xcnt, zcnt)
    !    !EV(:,:,:)=0.0_8
    !    WAGE_Occ(:,pcnt,xcnt,zcnt)=WAGE(pcnt,xcnt,zcnt)
    !END DO
    !END DO
    !END DO
        !DO pcnt=1, ppts
        !
        !DO occcnt=1, occpts         ! source occupation
        !DO xcnt=1, occpts           ! destination occupation
        !    IF (occcnt==xcnt) THEN
        !        Searchdir_Occ(occcnt,xcnt,pcnt)=0.334
        !    ELSE
        !        Searchdir_Occ(occcnt,xcnt,pcnt)=0.222
        !    END IF
        !END DO
        !END DO
        !
        !! turn it into a cumulative function

        !DO occcnt=1, occpts         ! source occupation
        !DO xcnt=2, occpts           ! destination occupation
        !        tempreal=Searchdir_Occ(occcnt,xcnt,pcnt)+Searchdir_Occ(occcnt,xcnt-1,pcnt)
        !        Searchdir_Occ(occcnt,xcnt,pcnt)=tempreal
        !        !WRITE(*,FMT='(A2,I3,A7,I1,A7,I1,A5, E10.4)') 'p=', pcnt, ', socc=', occcnt, ', docc=', xcnt, 'Sdir:', Searchdir_Occ(pcnt,occcnt,xcnt)
        !END DO
        !END DO
        !
        !! WRITE IT OUT

        IF(verbose_netmob_solve) THEN
            DO occcnt=1, occpts         ! source occupation
            DO xcnt=1, occpts           ! destination occupation
            DO pcnt=1, ppts
                WRITE(*,FMT='(A2,I3,A7,I1,A7,I1,A5, E10.4)') 'p=', pcnt, ', socc=', occcnt, ', docc=', xcnt, 'Sdir:', Searchdir_Occ(occcnt,xcnt,pcnt)
            END DO
            END DO
            END DO
        END IF
END IF


CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
IF(verbose_progress==1) &
    WRITE(*,*) 'start time simulations=', time_string(2)


    !******************************************************************
    !
    ! II. SIMULATION
    !
    !******************************************************************

    !1. All workers start unemployed, randomly assigned to one island
    !2. Convention: ustate is recorded post-search at t and indexed as t. The state x (promised value)
    !is recorded post-search at t, the promised value choice for next period, i.e. the continuation
    !value into the next period is indexed t+1 (overwritten if a succesfull application yields a better promised value.
    !Dummies and wages are recorded
    !post-search at t and indexed by t (helps also in computing wage moments by status later).
    !3. Whenever w(t)=0, could set w(t)=b IF the income measurement in the data includes UI benefits.

    !PRINT *, "Simulating"

    ! -----------------------------------------------------------
    !   FOR MATH KERNEL LIBRARY PSEUDO-RANDOM NUMBER GENERATOR
    ! -------------------------------------------------------

      brng=VSL_BRNG_SFMT19937
      method=VSL_RNG_METHOD_UNIFORM_STD

      ! initialize it
      seed=1


!     ***** Initialize *****
      errcode=vslnewstream( stream, brng,  seed )
      call CheckVslError(errcode)



  !$OMP CRITICAL
ALLOCATE(aggprod_ind(tmax_sim2))
  !$OMP END CRITICAL



 aggprod_ind(:)=0
p_distribution_sim=0.0_8
!-------------------------------------------------------------------------------------
! GENERATE TIME SERIES FOR PRODUCTIVITY AND ISLANDS
!======================================================
!---------------------------------------------------------------------------------------

! AGGREGATE PRODUCTIVITY SERIES MAPS T into P
!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


!CALL RANDOM_SEED()

! start aggregate quality at 1
aggprod_ind(1)=INT(ppts/2)


!CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
!ISLAND: generate random number, then find quality
!WRITE(10,*) 'simulating aggregate productivity time series', 'time=', time_string(2)


!CALL ranlux(prob,tmax_sim2)
!  !$OMP CRITICAL
!CALL RANDOM_NUMBER(prob)
!  !$OMP END CRITICAL


!     ***** Call RNG *****
errcode=vsrnguniform( method, stream, tmax_sim2, prob, 0.0000001, 0.99999999 )

!! FIRST PART OF TIME SERIES IN STEADY STATE
aggprod_ind(1:tmin_sim2)=ppts/2

DO t=tmin_sim2+1, tmax_sim2
            tempreal=prob(t)

            tempint=1
                    tempreal6=0.0_8
                    DO p2cnt=1, ppts
                       tempreal6=ptransmatrix(aggprod_ind(t-1), p2cnt)+tempreal6
                       temp_p_cdf(p2cnt)=tempreal6
                    END DO

                    DO p2cnt=1, ppts

                        ! turn pdf into cdf

                        IF (tempreal>temp_p_cdf(p2cnt)) THEN
                            tempint=tempint+1
                        END IF

                            IF (tempint>ppts) THEN
                                WRITE(*,*) 'Mistake in simulation, attempts to assign a p>ppts'
                                STOP
                            END IF
                    END DO
             aggprod_ind(t)=tempint

            p_distribution_sim(aggprod_ind(t))=p_distribution_sim(aggprod_ind(t))+1.0_8
END DO
p_distribution_sim=p_distribution_sim/sum(p_distribution_sim(:))



!---------------------------------
!  ALLOCATE DATA SERIES
!---------------------------------

maxqtr_alloc=((tmax_sim2-12-MAX((tmin_sim2/12)*12,5))/12)+5+20

  !$OMP CRITICAL
ALLOCATE(mask_qtr(maxqtr_alloc), unempdur_estatus((tmax_sim2/4)+4), data_u_qtr(maxqtr_alloc),data_uall_qtr(maxqtr_alloc), data_e_qtr(maxqtr_alloc), &
    data_uadj18m_qtr(maxqtr_alloc), data_uraw_qtr(maxqtr_alloc), &
    data_u_young_qtr(maxqtr_alloc),data_u_prime_qtr(maxqtr_alloc), data_uadj18m_young_qtr(maxqtr_alloc),&
    data_uadj18m_prime_qtr(maxqtr_alloc), data_e_young_qtr(maxqtr_alloc),data_e_prime_qtr(maxqtr_alloc), &
data_u_qtr_p33(maxqtr_alloc), data_u_qtr_p50(maxqtr_alloc), data_u_qtr_p67(maxqtr_alloc), &
data_ucompldur_occ_qtr(maxqtr_alloc), data_ucompldur_young_occ_qtr(maxqtr_alloc), data_ucompldur_prime_occ_qtr(maxqtr_alloc), &
data_ucompldur_nocc_qtr(maxqtr_alloc), data_ucompldur_young_nocc_qtr(maxqtr_alloc), data_ucompldur_prime_nocc_qtr(maxqtr_alloc), &
data_totduration_cocc_qtr(maxqtr_alloc,0:18), data_totduration_nocc_qtr(maxqtr_alloc,0:18), &
data_totduration_cocc_young_qtr(maxqtr_alloc,0:18), data_totduration_nocc_young_qtr(maxqtr_alloc,0:18),&
data_totduration_cocc_prime_qtr(maxqtr_alloc,0:18), data_totduration_nocc_prime_qtr(maxqtr_alloc,0:18),&
data_compduration_cocc_qtr(maxqtr_alloc,0:18), data_compduration_nocc_qtr(maxqtr_alloc,0:18), &
data_compduration_cocc_young_qtr(maxqtr_alloc,0:18), data_compduration_nocc_young_qtr(maxqtr_alloc,0:18),&
data_compduration_cocc_prime_qtr(maxqtr_alloc,0:18), data_compduration_nocc_prime_qtr(maxqtr_alloc,0:18),&
data_totduration_cr_cocc_qtr(maxqtr_alloc,0:18), data_totduration_cr_nocc_qtr(maxqtr_alloc,0:18),&
data_totduration_cr_cocc_young_qtr(maxqtr_alloc,0:18), data_totduration_cr_nocc_young_qtr(maxqtr_alloc,0:18),&
data_totduration_cr_cocc_prime_qtr(maxqtr_alloc,0:18), data_totduration_cr_nocc_prime_qtr(maxqtr_alloc,0:18),&
data_v_qtr(maxqtr_alloc),data_theta_qtr(maxqtr_alloc), &
data_jf_qtr(maxqtr_alloc), data_jf_young_qtr(maxqtr_alloc), data_jf_prime_qtr(maxqtr_alloc), &
data_prod_qtr(maxqtr_alloc), data_wage_qtr(maxqtr_alloc), data_sep_qtr(maxqtr_alloc), data_sep_y_qtr(maxqtr_alloc), &
data_sep_p_qtr(maxqtr_alloc), &
data_cocc_inflow_qtr(maxqtr_alloc), data_cocc_young_inflow_qtr(maxqtr_alloc), data_cocc_prime_inflow_qtr(maxqtr_alloc), data_nocc_inflow_qtr(maxqtr_alloc), &
data_nocc_young_inflow_qtr(maxqtr_alloc), data_nocc_prime_inflow_qtr(maxqtr_alloc), &
data_cocc_outflow_qtr(maxqtr_alloc), data_cocc_young_outflow_qtr(maxqtr_alloc), data_cocc_prime_outflow_qtr(maxqtr_alloc), data_nocc_outflow_qtr(maxqtr_alloc), &
data_nocc_young_outflow_qtr(maxqtr_alloc), data_nocc_prime_outflow_qtr(maxqtr_alloc), &
data_cocc_qtr(maxqtr_alloc), data_cocc_young_qtr(maxqtr_alloc), data_cocc_prime_qtr(maxqtr_alloc), data_nocc_qtr(maxqtr_alloc), &
data_nocc_young_qtr(maxqtr_alloc), data_nocc_prime_qtr(maxqtr_alloc), data_pocc_qtr(maxqtr_alloc), data_pnocc_qtr(maxqtr_alloc), &
data_pocc_young_qtr(maxqtr_alloc), data_pnocc_young_qtr(maxqtr_alloc), data_pocc_prime_qtr(maxqtr_alloc), data_pnocc_prime_qtr(maxqtr_alloc), &
data_young_qtr(maxqtr_alloc), data_prime_qtr(maxqtr_alloc), data_ult5wk_qtr(maxqtr_alloc), data_u5lt15wk_qtr(maxqtr_alloc), &
data_u15lt27wk_qtr(maxqtr_alloc), data_ugt27wk_qtr(maxqtr_alloc), data_l_ult5wk_qtr(maxqtr_alloc), data_l_u5lt15wk_qtr(maxqtr_alloc), &
data_l_u15lt27wk_qtr(maxqtr_alloc), data_l_ugt27wk_qtr(maxqtr_alloc), data_ult3m_qtr(maxqtr_alloc), data_ult5m_qtr(maxqtr_alloc), &
data_ult9m_qtr(maxqtr_alloc), data_ult13m_qtr(maxqtr_alloc), data_ugt13m_qtr(maxqtr_alloc), &
data_l_ult3m_qtr(maxqtr_alloc), data_l_ult5m_qtr(maxqtr_alloc), &
data_l_ult9m_qtr(maxqtr_alloc), data_l_ult13m_qtr(maxqtr_alloc), data_l_ugt13m_qtr(maxqtr_alloc), &
data_ult3m_yng_qtr(maxqtr_alloc), data_ult5m_yng_qtr(maxqtr_alloc), &
data_ult9m_yng_qtr(maxqtr_alloc), data_ult13m_yng_qtr(maxqtr_alloc), data_ugt13m_yng_qtr(maxqtr_alloc), &
data_l_ult3m_yng_qtr(maxqtr_alloc), data_l_ult5m_yng_qtr(maxqtr_alloc), &
data_l_ult9m_yng_qtr(maxqtr_alloc), data_l_ult13m_yng_qtr(maxqtr_alloc), data_l_ugt13m_yng_qtr(maxqtr_alloc), &
data_ult3m_prm_qtr(maxqtr_alloc), data_ult5m_prm_qtr(maxqtr_alloc), &
data_ult9m_prm_qtr(maxqtr_alloc), data_ult13m_prm_qtr(maxqtr_alloc), data_ugt13m_prm_qtr(maxqtr_alloc), &
data_l_ult3m_prm_qtr(maxqtr_alloc), data_l_ult5m_prm_qtr(maxqtr_alloc), &
data_l_ult9m_prm_qtr(maxqtr_alloc), data_l_ult13m_prm_qtr(maxqtr_alloc), data_l_ugt13m_prm_qtr(maxqtr_alloc), &
!data_scratch_qtr(maxqtr_alloc), &
! NET MOBILITY
data_superocc_transmatrix_qtr(occpts,occpts, maxqtr_alloc), data_corr_superocc_transmatrix_qtr(occpts,occpts, maxqtr_alloc), &
data_supocc_udur_counter_qtr(occpts, maxqtr_alloc), data_supocc_u_qtr(occpts, maxqtr_alloc), data_supocc_lu_qtr(occpts, maxqtr_alloc), &
data_supocc_e_qtr(occpts, maxqtr_alloc), data_supocc_sep_qtr(occpts,maxqtr_alloc),data_supocc_lsep_qtr(occpts,maxqtr_alloc), &
data_supocc_udur_qtr(occpts,maxqtr_alloc), data_supocc_ludur_qtr(occpts,maxqtr_alloc), & 
data_temp_qtr(maxqtr_alloc), data_temp_qtr2(maxqtr_alloc),data_temp_qtr3(maxqtr_alloc), &
occdistr_exo_entry_exit_qtr(0:occpts, 2, maxqtr_alloc), corr_occdistr_exo_entry_exit_qtr(0:occpts, 2, maxqtr_alloc), &
occdistr_endo_entry_exit_qtr(0:occpts, 2, maxqtr_alloc), corr_occdistr_endo_entry_exit_qtr(0:occpts, 2, maxqtr_alloc) &    
    ) !)
  !$OMP END CRITICAL

!CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
!WRITE(10,*) 'allocated data series:', time_string(2)

    !-------------------------------------
    ! superwindow preliminaries
    !-------------------------------------

    ! right now, no lead-in or lead-out
    !tmax_swindow_qtr=1680               ! to be changed
    tmax_swindow_qtr=tmax_swindow_wks_raw/12
    IF (tmax_swindow_wks_raw .ne. tmax_swindow_qtr*12) THEN
            WRITE(*,*) 'ERROR in tmax_swindow_qtr DEF, weeks left outside a quarter'
            WRITE(*,*) 'tmax_swindow_qtr=', tmax_swindow_qtr
            WRITE(*,*) 'tmax_swindow_wks_raw=', tmax_swindow_wks_raw
    END IF

    no_superwindows=(tmax_sim2-48-tmin_sim2)/(tmax_swindow_wks_raw)
    IF(no_superwindows<=0) WRITE(*,*) 'ERROR: NO SUPERWINDOWS IN SIMULATION'

    IF((tmax_swindow_qtr/4)*4 .ne. tmax_swindow_qtr) WRITE(*,*) 'tmax_swindow_qtr/4 not full years'


    tswindow_qtr_min=((tcutoffmin_swindow_wks-1)/12)+2
    tswindow_qtr_max=(tcutoffmax_swindow_wks/12)
    IF(tswindow_qtr_max<=tswindow_qtr_min) WRITE(*,*) 'ERROR TS WINDOW ZERO INTERVAL'
    tmax_mask_swindow_qtr=tswindow_qtr_max-tswindow_qtr_min+1

    mask_qtr = .FALSE.

    icnt=0
    DO i=1, no_superwindows

        DO zcnt=tswindow_qtr_min, tswindow_qtr_max
            mask_qtr(zcnt)= .TRUE.
            icnt=icnt+1
        END DO
        tswindow_qtr_min=tswindow_qtr_min+tmax_swindow_qtr
        tswindow_qtr_max=tswindow_qtr_max+tmax_swindow_qtr
    END DO

    tmax_mask_qtr=icnt              ! QTRS THAT SURVIVE WHEN QUARTERLY ARRAYS ARE PACKED

   !-----------------------------------
   !  INITIALIZE ALL VARIABLES TO ZERO
   !-----------------------------------

tot_costofhires=0.0
tot_hires=0.0_8
tot_reallcost=0.0_8
tot_realls=0.0_8

unempdur_estatus=-2

 data_young_qtr=0.0_8
 data_prime_qtr=0.0_8

 data_u_qtr=0.0_8
 data_uall_qtr=0.0_8
 data_uraw_qtr=0.0_8
 data_e_qtr=0.0_8
 data_uadj18m_qtr=0.0_8
 data_u_young_qtr=0.0_8
 data_u_prime_qtr=0.0_8
 data_uadj18m_young_qtr=0.0_8
 data_uadj18m_prime_qtr=0.0_8

 data_e_young_qtr=0.0_8
 data_e_prime_qtr=0.0_8

 data_ucompldur_occ_qtr=0.0_8
 data_ucompldur_young_occ_qtr=0.0_8
 data_ucompldur_prime_occ_qtr=0.0_8

 data_ucompldur_nocc_qtr=0.0_8
 data_ucompldur_young_nocc_qtr=0.0_8
 data_ucompldur_prime_nocc_qtr=0.0_8

 data_u_qtr_p33=0.0_8
 data_u_qtr_p50=0.0_8
 data_u_qtr_p67=0.0_8

 data_compduration_cocc=0.0_8
 data_compduration_nocc=0.0_8
 data_compduration_cocc_young=0.0_8
 data_compduration_nocc_young=0.0_8
 data_compduration_cocc_prime=0.0_8
 data_compduration_nocc_prime=0.0_8


 data_totduration_cocc_qtr=0.0_8
 data_totduration_nocc_qtr=0.0_8
 data_totduration_cocc_young_qtr=0.0_8
 data_totduration_nocc_young_qtr=0.0_8
 data_totduration_cocc_prime_qtr=0.0_8
 data_totduration_nocc_prime_qtr=0.0_8
 data_compduration_cocc_qtr=0.0_8
 data_compduration_nocc_qtr=0.0_8
 data_compduration_cocc_young_qtr=0.0_8
 data_compduration_nocc_young_qtr=0.0_8
 data_compduration_cocc_prime_qtr=0.0_8
 data_compduration_nocc_prime_qtr=0.0_8


 data_totduration_cr_cocc_qtr=0.0_8
 data_totduration_cr_nocc_qtr=0.0_8
 data_totduration_cr_cocc_young_qtr=0.0_8
 data_totduration_cr_nocc_young_qtr=0.0_8
 data_totduration_cr_cocc_prime_qtr=0.0_8
 data_totduration_cr_nocc_prime_qtr=0.0_8

 jf_ave2=0.0_8
 jf_ave2_counter=0

 data_v_qtr=0.0_8
 data_theta_qtr=0.0_8
 data_jf_qtr=0.0_8
 data_jf_young_qtr=0.0_8
 data_jf_prime_qtr=0.0_8

 data_prod_qtr=0.0_8
 data_wage_qtr=0.0_8
 data_sep_qtr=0.0_8
 data_sep_y_qtr=0.0_8
 data_sep_p_qtr=0.0_8

 data_cocc_inflow_qtr=0.0_8
 data_cocc_young_inflow_qtr=0.0_8
 data_cocc_prime_inflow_qtr=0.0_8
 data_nocc_inflow_qtr=0.0_8
 data_nocc_young_inflow_qtr=0.0_8
 data_nocc_prime_inflow_qtr=0.0_8

 data_cocc_outflow_qtr=0.0_8
 data_cocc_young_outflow_qtr=0.0_8
 data_cocc_prime_outflow_qtr=0.0_8
 data_nocc_outflow_qtr=0.0_8
 data_nocc_young_outflow_qtr=0.0_8
 data_nocc_prime_outflow_qtr=0.0_8


 data_cocc_qtr=0.0_8
 data_cocc_young_qtr=0.0_8
 data_cocc_prime_qtr=0.0_8
 data_nocc_qtr=0.0_8
 data_nocc_young_qtr=0.0_8
 data_nocc_prime_qtr=0.0_8

 data_pocc_qtr=0.0_8
 data_pnocc_qtr=0.0_8
 data_pocc_young_qtr=0.0_8
 data_pnocc_young_qtr=0.0_8
 data_pocc_prime_qtr=0.0_8
 data_pnocc_prime_qtr=0.0_8

data_ult5wk_qtr=0.0_8
data_u5lt15wk_qtr=0.0_8
data_u15lt27wk_qtr=0.0_8
data_ugt27wk_qtr=0.0_8
data_l_ult5wk_qtr=0.0_8
data_l_u5lt15wk_qtr=0.0_8
data_l_u15lt27wk_qtr=0.0_8
data_l_ugt27wk_qtr=0.0_8

data_ult3m_qtr=0.0_8
data_ult5m_qtr=0.0_8
data_ult9m_qtr=0.0_8
data_ult13m_qtr=0.0_8
data_ugt13m_qtr=0.0_8
data_l_ult3m_qtr=0.0_8
data_l_ult5m_qtr=0.0_8
data_l_ult9m_qtr=0.0_8
data_l_ult13m_qtr=0.0_8
data_l_ugt13m_qtr=0.0_8


data_ult3m_yng_qtr=0.0_8
data_ult5m_yng_qtr=0.0_8
data_ult9m_yng_qtr=0.0_8
data_ult13m_yng_qtr=0.0_8
data_ugt13m_yng_qtr=0.0_8
data_l_ult3m_yng_qtr=0.0_8
data_l_ult5m_yng_qtr=0.0_8
data_l_ult9m_yng_qtr=0.0_8
data_l_ult13m_yng_qtr=0.0_8
data_l_ugt13m_yng_qtr=0.0_8

data_ult3m_prm_qtr=0.0_8
data_ult5m_prm_qtr=0.0_8
data_ult9m_prm_qtr=0.0_8
data_ult13m_prm_qtr=0.0_8
data_ugt13m_prm_qtr=0.0_8
data_l_ult3m_prm_qtr=0.0_8
data_l_ult5m_prm_qtr=0.0_8
data_l_ult9m_prm_qtr=0.0_8
data_l_ult13m_prm_qtr=0.0_8
data_l_ugt13m_prm_qtr=0.0_8

! data_temp_qtr=0.0_8

 counter_u_window=0
 counter_u_window_y=0
 counter_u_window_p=0
 counter_u_window_all=0
 counter_u_window_all_y=0
 counter_u_window_all_p=0
 counter_uocc_window=0
 counter_uocc_window_all=0
 counter_unocc_window=0
 counter_unocc_window_all=0


 sep_ave_1m=0.0_8
 sep_ave_2m=0.0_8
 sep_ave_3m=0.0_8
 sep_ave_4m=0.0_8
 sep_ave_5m=0.0_8
 sep_ave_6m=0.0_8
 sep_ave_7m=0.0_8
 sep_ave_8m=0.0_8
 sep_ave_9m=0.0_8
 sep_ave_10m=0.0_8
 sep_ave_11m=0.0_8
 sep_ave_12m=0.0_8
 sep_ave_m_counter=0

 sep_ave_1m_posthire=0.0_8
 sep_ave_2m_posthire=0.0_8
 sep_ave_3m_posthire=0.0_8
 sep_ave_4m_posthire=0.0_8
 sep_ave_5m_posthire=0.0_8
 sep_ave_6m_posthire=0.0_8
 sep_ave_7m_posthire=0.0_8
 sep_ave_8m_posthire=0.0_8
 sep_ave_9m_posthire=0.0_8
 sep_ave_10m_posthire=0.0_8
 sep_ave_11m_posthire=0.0_8
 sep_ave_12m_posthire=0.0_8
 sep_ave_m_posthire_counter=0

 earlier_e_counter=0
 young_earlier_e_counter=0
 prime_earlier_e_counter=0
 unemp_earlier_e_ave=0.0_8
 u_earlier_e_young_ave=0.0_8
 u_earlier_e_prime_ave=0.0_8

 warningcounter=0

 threadno_if1: IF (threadnumber==1) THEN
 IF(workerhistory_sim==1) THEN
     OPEN(unit=14, file='workerhistory.txt', status='replace', form='formatted')
 END IF
 END IF threadno_if1


! ----NET MOBILITY---
data_superocc_transmatrix_qtr=0.0_8
data_corr_superocc_transmatrix_qtr=0.0_8
data_supocc_udur_counter_qtr=0
data_supocc_sep_qtr=0.0_8
data_supocc_lsep_qtr=0.0_8
data_supocc_udur_qtr=0.0_8
data_supocc_ludur_qtr=0.0_8
data_supocc_e_qtr=0.0_8
data_supocc_u_qtr=0.0_8
data_supocc_lu_qtr=0.0_8

mobility_prop_within_supocc=0.0_8
corr_mobility_prop_within_supocc=0.0_8


occdistr_exo_entry_exit_qtr=0.0
corr_occdistr_exo_entry_exit_qtr=0.0
occdistr_endo_entry_exit_qtr=0.0
corr_occdistr_endo_entry_exit_qtr=0.0
occdistr_exo_entry_exit3=0.0
corr_occdistr_exo_entry_exit3=0.0
occdistr_endo_entry_exit3=0.0
corr_occdistr_endo_entry_exit3=0.0

!---------
! POPULATION PYRAMID
!------------




! SIMPLE each period, for max_gen periods, nsim_gen people are added
!       more compl things possible

!!! FOR NOW, simple calculation of number of agents
number_agents(:)=nsim_gen















!-------- INITIALIZE

ult5wk=0.0_8
u5lt15wk=0.0_8
u15lt27wk=0.0_8
ugt27wk=0.0_8


duration2=0.0_8
duration2_young=0.0_8
duration2_prime=0.0_8

duration2_move=0.0_8
duration2_stay=0.0_8
duration2_move_young=0.0_8
duration2_stay_young=0.0_8
duration2_move_prime=0.0_8
duration2_stay_prime=0.0_8

empduration_occ=0.0_8
empduration_nocc=0.0_8
empduration_occ_Y=0.0_8
empduration_nocc_y=0.0_8
empduration_occ_p=0.0_8
empduration_nocc_p=0.0_8
empduration_occ_shuspell=0.0_8
empduration_nocc_shuspell=0.0_8
empduration_occ_luspell=0.0_8
empduration_nocc_luspell=0.0_8


sepocc_ave=0.0_8
sepnocc_ave=0.0_8
sepocc_y_ave=0.0_8
sepnocc_y_ave=0.0_8
sepocc_p_ave=0.0_8
sepnocc_p_ave=0.0_8
sepocc_ave_counter=0.0_8
sepnocc_ave_counter=0.0_8
sepocc_y_ave_counter=0.0_8
sepnocc_y_ave_counter=0.0_8
sepocc_p_ave_counter=0.0_8
sepnocc_p_ave_counter=0.0_8

sepocc_afternocc_2_5yr=0.0_8
sepocc_afternocc_2_5yr_2m=0.0_8
sepocc_afternocc_3yr=0.0_8
sep_afternocc_2_5yr=0.0_8
sep_afternocc_2_5yr_2m=0.0_8
sepnocc_afternocc_2_5yr=0.0_8
sepnocc_afternocc_2_5yr_2m=0.0_8

sepocc_afternocc_2_5yr_counter=0
sepocc_afternocc_3yr_counter=0
sepnocc_afternocc_2_5yr_counter=0
sep_afternocc_2_5yr_counter=0


returnstenure5y=0.0_8
returnstenure10y=0.0_8

returnstenure5ycounter=0
returnstenure10ycounter=0

tot_occafterocc=0.0_8
tot_occafternocc=0.0_8
tot_noccafterocc=0.0_8
tot_noccafternocc=0.0_8
tot_occafterocc_y=0.0_8
tot_occafternocc_y=0.0_8
tot_noccafterocc_y=0.0_8
tot_noccafternocc_y=0.0_8
tot_occafterocc_p=0.0_8
tot_occafternocc_p=0.0_8
tot_noccafterocc_p=0.0_8
tot_noccafternocc_p=0.0_8

tot_corr_occafterocc=0.0_8
tot_corr_occafternocc=0.0_8
tot_corr_noccafterocc=0.0_8
tot_corr_noccafternocc=0.0_8
tot_corr_occafterocc_y=0.0_8
tot_corr_occafternocc_y=0.0_8
tot_corr_noccafterocc_y=0.0_8
tot_corr_noccafternocc_y=0.0_8
tot_corr_occafterocc_p=0.0_8
tot_corr_occafternocc_p=0.0_8
tot_corr_noccafterocc_p=0.0_8
tot_corr_noccafternocc_p=0.0_8


tot_occafterocc_vector=0.0_8
tot_occafternocc_vector=0.0_8
tot_noccafterocc_vector=0.0_8
tot_noccafternocc_vector=0.0_8

tot_occafterocc_vector_young=0.0_8
tot_occafternocc_vector_young=0.0_8
tot_noccafterocc_vector_young=0.0_8
tot_noccafternocc_vector_young=0.0_8

tot_occafterocc_vector_prime=0.0_8
tot_occafternocc_vector_prime=0.0_8
tot_noccafterocc_vector_prime=0.0_8
tot_noccafternocc_vector_prime=0.0_8


stock_occafterocc=0.0_8
stock_occafternocc=0.0_8
stock_noccafterocc=0.0_8
stock_noccafternocc=0.0_8
stock_occafterocc_y=0.0_8
stock_occafternocc_y=0.0_8
stock_noccafterocc_y=0.0_8
stock_noccafternocc_y=0.0_8
stock_occafterocc_p=0.0_8
stock_occafternocc_p=0.0_8
stock_noccafterocc_p=0.0_8
stock_noccafternocc_p=0.0_8

poccafterocc=0.0_8
poccafternocc=0.0_8
pnoccafterocc=0.0_8
pnoccafternocc=0.0_8

poccafterocc_y=0.0_8
poccafternocc_y=0.0_8
pnoccafterocc_y=0.0_8
pnoccafternocc_y=0.0_8

poccafterocc_p=0.0_8
poccafternocc_p=0.0_8
pnoccafterocc_p=0.0_8
pnoccafternocc_p=0.0_8


poccafterocc_uspell=0.0_8
poccafternocc_uspell=0.0_8
pnoccafterocc_uspell=0.0_8
pnoccafternocc_uspell=0.0_8

poccafterocc_y_uspell=0.0_8
poccafternocc_y_uspell=0.0_8
pnoccafterocc_y_uspell=0.0_8
pnoccafternocc_y_uspell=0.0_8

poccafterocc_p_uspell=0.0_8
poccafternocc_p_uspell=0.0_8
pnoccafterocc_p_uspell=0.0_8
pnoccafternocc_p_uspell=0.0_8


stock_occafterocc_uspell=0.0_8
stock_occafternocc_uspell=0.0_8
stock_noccafterocc_uspell=0.0_8
stock_noccafternocc_uspell=0.0_8
stock_occafterocc_y_uspell=0.0_8
stock_occafternocc_y_uspell=0.0_8
stock_noccafterocc_y_uspell=0.0_8
stock_noccafternocc_y_uspell=0.0_8
stock_occafterocc_p_uspell=0.0_8
stock_occafternocc_p_uspell=0.0_8
stock_noccafterocc_p_uspell=0.0_8
stock_noccafternocc_p_uspell=0.0_8


occafterocc_uspell=0.0_8
occafternocc_uspell=0.0_8
noccafterocc_uspell=0.0_8
noccafternocc_uspell=0.0_8




! REGULAR duration matrices
tot_durationmatrix=0.0_8
tot_durationmatrix2=0.0_8
tot_haz_durationmatrix2=0.0_8
tot_durationmatrix_cocc=0.0_8
tot_durationmatrix_nocc=0.0_8

tot_durationmatrix_young=0.0_8
tot_durationmatrix_cocc_young=0.0_8
tot_durationmatrix_nocc_young=0.0_8

tot_durationmatrix_prime=0.0_8
tot_durationmatrix_cocc_prime=0.0_8
tot_durationmatrix_nocc_prime=0.0_8


tot_durationmatrix2_cocc=0.0
tot_durationmatrix2_cocc_young=0.0
tot_durationmatrix2_nocc_young=0.0
tot_durationmatrix2_nocc=0.0
tot_durationmatrix2_cocc_prime=0.0
tot_durationmatrix2_nocc_prime=0.0




tot_durationmatrix_cr=0.0_8
tot_durationmatrix_cr_cocc=0.0_8
tot_durationmatrix_cr_nocc=0.0_8

tot_durationmatrix_cr_young=0.0_8
tot_durationmatrix_cr_cocc_young=0.0_8
tot_durationmatrix_cr_nocc_young=0.0_8

tot_durationmatrix_cr_prime=0.0_8
tot_durationmatrix_cr_cocc_prime=0.0_8
tot_durationmatrix_cr_nocc_prime=0.0_8

tot_durationmatrix_cocc_p33=0.0_8
tot_durationmatrix_nocc_p33=0.0_8
tot_durationmatrix_cocc_p50=0.0_8
tot_durationmatrix_nocc_p50=0.0_8
tot_durationmatrix_cocc_p67=0.0_8
tot_durationmatrix_nocc_p67=0.0_8


tot_durationmatrix_cocc_young_p33=0.0_8
tot_durationmatrix_nocc_young_p33=0.0_8
tot_durationmatrix_cocc_young_p50=0.0_8
tot_durationmatrix_nocc_young_p50=0.0_8
tot_durationmatrix_cocc_young_p67=0.0_8
tot_durationmatrix_nocc_young_p67=0.0_8


tot_durationmatrix_cocc_prime_p33=0.0_8
tot_durationmatrix_nocc_prime_p33=0.0_8
tot_durationmatrix_cocc_prime_p50=0.0_8
tot_durationmatrix_nocc_prime_p50=0.0_8
tot_durationmatrix_cocc_prime_p67=0.0_8
tot_durationmatrix_nocc_prime_p67=0.0_8


tot_durationmatrix_cr_cocc_p33=0.0_8
tot_durationmatrix_cr_nocc_p33=0.0_8
tot_durationmatrix_cr_cocc_p50=0.0_8
tot_durationmatrix_cr_nocc_p50=0.0_8
tot_durationmatrix_cr_cocc_p67=0.0_8
tot_durationmatrix_cr_nocc_p67=0.0_8


tot_durationmatrix_cr_cocc_young_p33=0.0_8
tot_durationmatrix_cr_nocc_young_p33=0.0_8
tot_durationmatrix_cr_cocc_young_p50=0.0_8
tot_durationmatrix_cr_nocc_young_p50=0.0_8
tot_durationmatrix_cr_cocc_young_p67=0.0_8
tot_durationmatrix_cr_nocc_young_p67=0.0_8


tot_durationmatrix_cr_cocc_prime_p33=0.0_8
tot_durationmatrix_cr_nocc_prime_p33=0.0_8
tot_durationmatrix_cr_cocc_prime_p50=0.0_8
tot_durationmatrix_cr_nocc_prime_p50=0.0_8
tot_durationmatrix_cr_cocc_prime_p67=0.0_8
tot_durationmatrix_cr_nocc_prime_p67=0.0_8


! U CORRELATIONS
u_spell_before_sq=0.0_8
u_spell_before_am_sq=0.0_8
u_spell_before_as_sq=0.0_8
u_spell_before_mas_sq=0.0_8
u_spell_before_mam_sq=0.0_8
u_spell_before_sam_sq=0.0_8
u_spell_before_sas_sq=0.0_8

u_spell_now_sq=0.0_8
u_spell_now_am_sq=0.0_8
u_spell_now_as_sq=0.0_8
u_spell_now_mas_sq=0.0_8
u_spell_now_mam_sq=0.0_8
u_spell_now_sam_sq=0.0_8
u_spell_now_sas_sq=0.0_8

u_spell_before_ave=0.0_8
u_spell_before_am_ave=0.0_8
u_spell_before_as_ave=0.0_8
u_spell_before_mas_ave=0.0_8
u_spell_before_mam_ave=0.0_8
u_spell_before_sam_ave=0.0_8
u_spell_before_sas_ave=0.0_8

u_spell_now_ave=0.0_8
u_spell_now_am_ave=0.0_8
u_spell_now_as_ave=0.0_8
u_spell_now_mas_ave=0.0_8
u_spell_now_mam_ave=0.0_8
u_spell_now_sam_ave=0.0_8
u_spell_now_sas_ave=0.0_8


u_spell_crossterm=0.0_8
u_spell_crossterm_am=0.0_8
u_spell_crossterm_as=0.0_8
u_spell_crossterm_mas=0.0_8
u_spell_crossterm_mam=0.0_8
u_spell_crossterm_sam=0.0_8
u_spell_crossterm_sas=0.0_8

u_spell_young_before_sq=0.0_8
u_spell_young_before_am_sq=0.0_8
u_spell_young_before_as_sq=0.0_8
u_spell_young_before_mas_sq=0.0_8
u_spell_young_before_mam_sq=0.0_8
u_spell_young_before_sam_sq=0.0_8
u_spell_young_before_sas_sq=0.0_8

u_spell_young_now_sq=0.0_8
u_spell_young_now_am_sq=0.0_8
u_spell_young_now_as_sq=0.0_8
u_spell_young_now_mas_sq=0.0_8
u_spell_young_now_mam_sq=0.0_8
u_spell_young_now_sam_sq=0.0_8
u_spell_young_now_sas_sq=0.0_8

u_spell_young_before_ave=0.0_8
u_spell_young_before_am_ave=0.0_8
u_spell_young_before_as_ave=0.0_8
u_spell_young_before_mas_ave=0.0_8
u_spell_young_before_mam_ave=0.0_8
u_spell_young_before_sam_ave=0.0_8
u_spell_young_before_sas_ave=0.0_8

u_spell_young_now_ave=0.0_8
u_spell_young_now_am_ave=0.0_8
u_spell_young_now_as_ave=0.0_8
u_spell_young_now_mas_ave=0.0_8
u_spell_young_now_mam_ave=0.0_8
u_spell_young_now_sam_ave=0.0_8
u_spell_young_now_sas_ave=0.0_8


u_spell_young_crossterm=0.0_8
u_spell_young_crossterm_am=0.0_8
u_spell_young_crossterm_as=0.0_8
u_spell_young_crossterm_mas=0.0_8
u_spell_young_crossterm_mam=0.0_8
u_spell_young_crossterm_sam=0.0_8
u_spell_young_crossterm_sas=0.0_8

u_spell_prime_before_sq=0.0_8
u_spell_prime_before_am_sq=0.0_8
u_spell_prime_before_as_sq=0.0_8
u_spell_prime_before_mas_sq=0.0_8
u_spell_prime_before_mam_sq=0.0_8
u_spell_prime_before_sam_sq=0.0_8
u_spell_prime_before_sas_sq=0.0_8

u_spell_prime_now_sq=0.0_8
u_spell_prime_now_am_sq=0.0_8
u_spell_prime_now_as_sq=0.0_8
u_spell_prime_now_mas_sq=0.0_8
u_spell_prime_now_mam_sq=0.0_8
u_spell_prime_now_sam_sq=0.0_8
u_spell_prime_now_sas_sq=0.0_8

u_spell_prime_before_ave=0.0_8
u_spell_prime_before_am_ave=0.0_8
u_spell_prime_before_as_ave=0.0_8
u_spell_prime_before_mas_ave=0.0_8
u_spell_prime_before_mam_ave=0.0_8
u_spell_prime_before_sam_ave=0.0_8
u_spell_prime_before_sas_ave=0.0_8

u_spell_prime_now_ave=0.0_8
u_spell_prime_now_am_ave=0.0_8
u_spell_prime_now_as_ave=0.0_8
u_spell_prime_now_mas_ave=0.0_8
u_spell_prime_now_mam_ave=0.0_8
u_spell_prime_now_sam_ave=0.0_8
u_spell_prime_now_sas_ave=0.0_8



u_spell_prime_crossterm=0.0_8
u_spell_prime_crossterm_am=0.0_8
u_spell_prime_crossterm_as=0.0_8
u_spell_prime_crossterm_mas=0.0_8
u_spell_prime_crossterm_mam=0.0_8
u_spell_prime_crossterm_sam=0.0_8
u_spell_prime_crossterm_sas=0.0_8



! distribution of (employed and )unemployed with aggregate states
up_distribution_sim=0.0_8
uallp_distribution_sim=0.0_8
eallp_distribution_sim=0.0_8
ep_distribution_sim=0.0_8
up_young_distribution_sim=0.0_8
up_prime_distribution_sim=0.0_8
    ! distribution of (employed and unemployed over islands with different aggregate states
upz_distribution_sim=0.0_8
epz_distribution_sim=0.0_8
upz_young_distribution_sim=0.0_8
epz_young_distribution_sim=0.0_8
upz_prime_distribution_sim=0.0_8
epz_prime_distribution_sim=0.0_8
    ! SUPOCC distribution
   ! distribution of (employed and unemployed over islands with different aggregate states
uopz_distribution_sim=0.0_8
eopz_distribution_sim=0.0_8
uopz_young_distribution_sim=0.0_8
eopz_young_distribution_sim=0.0_8
uopz_prime_distribution_sim=0.0_8
eopz_prime_distribution_sim=0.0_8
uopxz_distribution_sim=0.0_8
eopxz_distribution_sim=0.0_8

! distribution of rest/search/reall unemployed with aggregate states
up_rest_distribution_sim=0.0_8
up_young_rest_distribution_sim=0.0_8
up_prime_rest_distribution_sim=0.0_8
up_search_distribution_sim=0.0_8
up_young_search_distribution_sim=0.0_8
up_prime_search_distribution_sim=0.0_8
up_reall_distribution_sim=0.0_8
up_young_reall_distribution_sim=0.0_8
up_prime_reall_distribution_sim=0.0_8

uop_rest_distribution_sim=0.0_8
uop_young_rest_distribution_sim=0.0_8
uop_prime_rest_distribution_sim=0.0_8
uop_search_distribution_sim=0.0_8
uop_young_search_distribution_sim=0.0_8
uop_prime_search_distribution_sim=0.0_8
uop_reall_distribution_sim=0.0_8
uop_young_reall_distribution_sim=0.0_8
uop_prime_reall_distribution_sim=0.0_8



wagepz_distribution_sim=0.0_8
wagepz_young_distribution_sim=0.0_8
wagepz_prime_distribution_sim=0.0_8

epz_x_distribution_sim=0.0_8
epz_x_young_distribution_sim=0.0_8
epz_x_prime_distribution_sim=0.0_8


upz_x_distribution_sim=0.0_8
upz_x_young_distribution_sim=0.0_8
upz_x_prime_distribution_sim=0.0_8

epz_1yb4_x_distribution_sim=0.0_8
sep_epz_1yb4_x_distribution_sim=0.0_8

!! LOG WAGE DISPERSION

logwage_disp_all=0.0_8
logwage_ave_all=0.0_8
logwage_disp_highoccten=0.0_8
logwage_ave_highoccten=0.0_8
logwage_disp_uhires=0.0_8
logwage_ave_uhires=0.0_8

logwage_all_counter=0
logwage_highoccten_counter=0
logwage_uhires_counter=0

!! NET MOBILITY STATS

occdistr_begin_end(:,:)=0.0_8
corr_occdistr_begin_end(:,:)=0.0_8
occdistr_end_v2=0.0_8
occdistr_end_v3=0.0_8

!    !---- subsequent reallocations as a function of previous unemployment spell
!    !   ----  in the data we only see this for those people who have multiple unemployment spells within 4 years
!    !   ----  if exogenous breakups are very rare, and a large proportion of measured breakups are endogenous, we have to reproduce these conditions in the program!!!
!    !   ----  this means adding a condition that previous unemployment and employment spell, plus current unemployment spell fall with blocks of 180 weeks.
!    !   ----  this condition is marked by <-----***** on the RHS margin below
!
!

IF(verbose_progress) WRITE(*,*) 'entering simulations'

!OPEN(UNIT=54, file='random_test.txt', form='formatted', status='replace')

gen_do: DO counter2=1, max_gen              ! MAX number of simultaneous generations
    !IF (((10*counter1)/max_gen)*max_gen-(10*counter1)==0) WRITE(*,*) 'simulation generation no', counter1, 'out of ', max_gen


! assign initial islands, based on znewcdf
initial_island(:)=zpts

tempint=1
DO i=1, nsim_gen
    IF(znewcdf(tempint)<REAL(i)/REAL(nsim_gen)) THEN
        tempint=tempint+1
    ELSE
        initial_island(i)=tempint
    END IF
END DO




nsim_do: DO i=1, nsim_gen


!IF((i/5000)*5000-i==0) WRITE(10,*) 'person i simulation, i=', i, 'on thread ', threadnumber



! initialization of indicators, time variables
age_sim=-8
e_sim=-8
island_sim=-8
hcten_sim=-8
hcind_sim=-8                    ! initialize -8, newborn -1,
duration_sim=-8
e_duration_sim=-8
reall_ind=0
corr_occid_sim=-8
occid_sim=-8




! INITIALIZATION t=1
e_sim(counter2)=0
hcten_sim(counter2)=0
hcind_sim(counter2)=-2           !initialize without a sector
duration_sim(counter2)=0
wage_sim(counter2)=0.0_8


!----> ASSIGN NEW ISLAND, znewpdf

!island_sim(counter2)=MAX( INT( ((REAL(i-1.0_8)*REAL(maxislands))/REAL(nsim_gen))    +1.0_8)   ,1)
!            ! assigns islands proportionally with one correction, so first island=1, and last island=zpts
island_sim(counter2)=initial_island(counter2)


!--------------------------------
!   time series for each person
!--------------------------------
!  !$OMP CRITICAL
!CALL RANDOM_NUMBER(jprobs)       !For probability of success in matching when unemployed, and human capital shock when employed
!CALL RANDOM_NUMBER(sepprobs)     !For probability of exogenous separation
!CALL RANDOM_NUMBER(zprobs)       !For realization of idiosyncratic shock
!  !$OMP END CRITICAL

!     ***** Call RNG *****
errcode=vsrnguniform( method, stream, tmax_sim2, jprobs, 0.0, 1.0 )
errcode=vsrnguniform( method, stream, tmax_sim2, sepprobs, 0.0, 1.0 )
errcode=vsrnguniform( method, stream, tmax_sim2, zprobs, 0.0, 1.0 )


!IF((i/10000)*10000-i==0) WRITE(*,*) 'sim no=', i, ', random vectors, 1st elements', workrandom1(1), workrandom2(1), workrandom1(2), workrandom2(2)
IF(verbosesimulation==1) THEN
IF((((i/1000)*1000-i==0 .AND. i<=10000) .OR. ((i/10000)*10000-i==0 .AND. i>10000) .AND. verbosesimulation==1)) THEN
    WRITE(10,FMT='(A10,I2, A10,I6, A20)', ADVANCE="no") 'thread no:', threadnumber, ' sim no=', i, ', random vectors, 1st elements'
    WRITE(10,FMT='(12(F4.3,A1))', ADVANCE='no') jprobs(1),',', jprobs(2),',', jprobs(3),',', jprobs(4),'-', &
                                                     sepprobs(1),',', sepprobs(2),',', sepprobs(3), ',' ,sepprobs(4),'-', &
                                                     zprobs(1),',', zprobs(2),',', zprobs(3), ',' , zprobs(4),'-'
    CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
    WRITE(10,*) 'time=', time_string(2)
END IF
END IF

monthind=0

!!======================================================
!! STEADY STATE SIMULATION
!!======================================================

indiv_timeseries_do_ss: DO t=2, tmin_sim2



IF ((t/4)*4-t==0 .AND. t>3000) monthind=1  ! month observation

!    ! write a sequence
!    IF (threadnumber==1) THEN
!    IF(i==1 .OR. i==2 .AND. counter1==1) THEN
!    WRITE(UNIT=49,FMT='(A2,I4, A4,I3, A6,I3,A5, I2,A8,I4,A7,I4)', ADVANCE='NO') 't=', t-1, ', p=', aggprod_ind(t-1), ', isl=', island_sim(t-1), ', hc=', hcind_sim(t-1), ', hcten=', hcten_sim(t-1), ', dur=', duration_sim(t-1)
!    WRITE(UNIT=49, FMT='(A5,F5.2,A20, F5.2, A4, F5.2, A5, F5.2, A7, F5.2)', ADVANCE='NO')'wage=', wage_sim(t-1), ', monthly stats: u', data_u_qtr(t-1), ', v', data_v_qtr(t-1), ', sep', data_sep_qtr(t-1), ', reall', data_reall_qtr(t)
!    WRITE(UNIT=49, FMT='(A20,3F5.2)') 'duration matrix', durationmatrix(MAX(MIN(duration_sim(t-1),205)-1,0),t-1),durationmatrix(MAX(MIN(duration_sim(t-1),205),0),t-1),durationmatrix(MAX(MIN(duration_sim(t-1)+1,205),0),t-1)
!    END IF
!    END IF !(threadnumber==1)

!-----------------------------------------------------
! STAGE 1: DEATH SHOCK, HUMAN CAPITAL ACCUMULATION
!-----------------------------------------------------




survival_if: &
IF(sepprobs(t)<dd .OR. age_sim(t)>(gencutoff+5*48) .OR. (  ( i> ( (REAL(t)-1.0_8)/REAL(tmin_sim2basic) )*REAL(nsim_gen)) .AND.  ( i<=( (REAL(t))/REAL(tmin_sim2basic) )*REAL(nsim_gen)   ))) THEN                ! DEATH AND TAXES -- COULD REPLACED BY NEWBORN. REPLACE SIXTY-YEAR OLDS WITH NEWBORNS
                                                                            ! note that in the lead-in period, people are replaced evenly over time to get the demographics right
                                                                            ! need the lead-in period to cover at least the average working life
e_sim(t)=0
age_sim(t)=0
hcten_sim(t)=0
hcind_sim(t)=-1      ! born with -2, reborn with -1, so not recorded as a reallocation when getting first job on the same island, reallocation 0
                     ! lowest hc level: 1, med hc level 2, hi hc level 3
duration_sim(t)=0
wage_sim(t)=0.0_8


! draw new island
        !CALL RANDOM_NUMBER(tempreal)
        tempreal=jprobs(t)
        island_assignment_do: &
        DO zcnt=1,zpts
            IF (tempreal<=znewcdf(zcnt)) THEN
                island_sim(t)=zcnt
                EXIT island_assignment_do
            ELSE IF (tempreal>1.0) THEN
                island_sim(t)=zpts
                EXIT island_assignment_do
            END IF
END DO island_assignment_do



  !-------------> GOTO END OF SURVIVAL IF


ELSE survival_if        ! you're a survivor!!!   -you're taken through the motions

!! 1. UPDATE AGE  AGE_SIM(t)
age_sim(t)=age_sim(t-1)+1

    !----------------------------------
    !   HUMAN CAPITAL UPGRADING (DOWNGRADING TOO!), AND ISLAND-SHOCK (which updates island_sim(t-1)!!!! because island_sim(t) is the newly reallocated island)
    !----------------------------------


!! 2. UPDATE HUMAN CAPITAL HCIND_SIM(t)
    ! human capital upgrading/downgrading
    IF(e_sim(t-1)==0 .AND. (skilldep==0.0_8 .OR. hcind_sim(t-1)<=1)) THEN
        hcind_sim(t)=hcind_sim(t-1)
    ELSE IF (e_sim(t-1)==0 .AND. (skilldep>0.0_8 .AND. hcind_sim(t-1)>1)) THEN
        IF (sepprobs(t)<=skilldep_cutoff) THEN
            hcind_sim(t)=hcind_sim(t-1)
        ELSE IF (sepprobs(t)>=skilldep_cutoff .AND. sepprobs(t)<=1.0_8) THEN
            hcind_sim(t)=hcind_sim(t-1)-1
        END IF
    ELSE IF (e_sim(t-1)==1 .AND. hcind_sim(t-1)>0) THEN
        IF (jprobs(t)<=xtransmatrix(hcind_sim(t-1), hcind_sim(t-1))) THEN
            hcind_sim(t)=hcind_sim(t-1)
        ELSE IF (jprobs(t)<=1.0_8) THEN
            hcind_sim(t)=hcind_sim(t-1)+1
        ELSE
            WRITE(*,*) 'SHOULDNOT ARRIVE    HERE: WORKRANDOM1(t)/sepprobs=', sepprobs(t)
            !STOP
        END IF
    ELSE
         WRITE(*,*) 'hcind_sim update mistake, hcind_sim, e_sim', hcind_sim(t-1), e_sim(t-1)
            !STOP
    END IF


    !-----------------------------------------
    !   ISLAND PRODUCTIVITY SHOCK
    !-----------------------------------------

    ! island shock hits island_sim(t-1)

!! 3. UPDATE ZPROD: ISLAND_SIM(t)
    ! check
    tempreal=zprobs(t)
    IF (ztransmatrix(island_sim(t-1), island_sim(t-1))>=zprobs(t)) THEN

        island_sim(t-1)=island_sim(t-1)
        flag_z=1

    ELSE  IF (ztransmatrix(island_sim(t-1), island_sim(t-1)) < zprobs(t)) THEN

        zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), island_sim(t-1))

        IF(zprobs(t)<0.0) WRITE(10,*) 'ALREADY ERROR: diminished zprobs, flag============='

        tempint=island_sim(t-1)
        tempint2=island_sim(t-1)
        flag_z=0

        island_assignment_do2: DO zcnt=1, zpts
            IF(zprobs(t)<0.0) WRITE(10,*) 'ERROR: diminished zprobs, flag=',flag_z
            IF(island_sim(t-1)-zcnt>0 .AND. flag_z==0) THEN

                tempint=island_sim(t-1)-zcnt

                IF(ztransmatrix(island_sim(t-1), tempint)>= zprobs(t)) THEN
                    island_sim(t-1)=tempint
                    flag_z=1
                    EXIT island_assignment_do2
                ELSE
                    zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), tempint)
                END IF
            ELSE
                !WRITE(10,*) 'weird:check... flag_z=', flag_z, 'island_sim=', island_sim(t-1), 'zcnt=', zcnt
            END IF

            IF(island_sim(t-1)+zcnt<=zpts .AND. flag_z==0)  THEN
                IF(zprobs(t)<0.0) WRITE(10,*) 'ERROR: diminished zprobs, flag=',flag_z

                tempint2=island_sim(t-1)+zcnt

                IF(ztransmatrix(island_sim(t-1), tempint2)>zprobs(t)-0.00001_8) THEN
                    island_sim(t-1)=tempint2
                    flag_z=1
                    EXIT island_assignment_do2
                ELSE
                    zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), tempint2)
                END IF
            END IF


            IF(tempint==1 .AND. tempint2==zpts) THEN
!			WRITE(10,*) 'ERRRRRRRRORRRRRRRR in islandsim, flag=', flag_z, 'zprobs=', zprobs(t)!
!			WRITE(10,*) 'original zprobs(t)=', tempreal, 'island_sim(t-1)=', island_sim(t-1), '|island_sim(t)=', island_sim(t)

	    END IF
        END DO island_assignment_do2

    END IF


    ! assign updated island_sim to the today's ex post island indicator
    island_sim(t)=island_sim(t-1)       ! workers stays on the same island, but island moves according to islandprod_ind
    IF(island_sim(t)<0) WRITE(10,*) 'island trouble: island_sim(t) gives a below-zero island indicator'


!!! 4. UPDATE OCCUPATIONS (MECHANICALLY)
!corr_occid_sim(t)=corr_occid_sim(t-1)

    !------------------------------------------------------------------------
    !  SEPARATION STAGE IN CASE OF EMPLOYED, REALLOCATION+MATCHING IN CASE OF UNEMPLOYED
    !------------------------------------------------------------------------


    ! ---- sep: lose the job
    sep_or_matching:&
        IF (e_sim(t-1)==1 .AND. (sepprobs(t)>=sep_cutoff_vec(MAX(hcind_sim(t),1)) .OR. poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==0)) THEN

                duration_sim(t)=0
                hcten_sim(t)=hcten_sim(t-1)
                e_sim(t)=0
                wage_sim(t)=0.0_8


        !----keep the job
        ELSE IF (e_sim(t-1)==1 .AND. (sepprobs(t)<=sep_cutoff_vec(MAX(hcind_sim(t),1)) .AND. poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==1)) THEN
                ! keep the job

                hcten_sim(t)=hcten_sim(t-1)+1           !
                e_sim(t)=1              ! KEEP THE JOB
                wage_sim(t)=wage(aggprod_ind(t), hcind_sim(t), island_sim(t))
                e_duration_sim(t)=e_duration_sim(t-1)+1

                ! keep the duration of the last completed unemployment spell
                duration_sim(t)=duration_sim(t-1)

                IF(hcind_sim(t)<1) THEN
                    WRITE(*,*) 'error in hcind_sim assignment'
                    STOP
                END IF



        !----- reallocate

        ELSE IF (e_sim(t-1)==0 .AND. poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==0) THEN

        IF(t>tmin_sim2) THEN
            tot_reallcost=tot_reallcost+reallc
            IF(reall_ind==0) THEN
                tot_realls=tot_realls+1.0_8
                reall_ind=1
            END IF
        END IF

        ! reallocation unemployment

        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0 .AND. unempdur_estatus(t/4)>=1) THEN
        !    up_reall_distribution_sim(aggprod_ind(t))=up_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)<youngcutoff) up_young_reall_distribution_sim(aggprod_ind(t))=up_young_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                         up_prime_reall_distribution_sim(aggprod_ind(t))=up_prime_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !END IF

        !island_sim(t)=MIN(INT(sepprobs(t)*REAL(maxislands))+1, maxislands)

        !sepprobs(t)=(sepprobs(t)-dd)/(1.0_8-dd)         ! using sepprobs (can be used scaling znewcdf, not needing to rescale sepprobs)
                                                        ! not using jprobs at this step, can be used for occupational direction in future version
                                                        ! using jprobs now, because sepprobs used in skilldep

        island_assignment_do0: DO zcnt=1,zpts
            IF (jprobs(t)<znewcdf(zcnt)) THEN
                island_sim(t)=zcnt
                EXIT island_assignment_do0
            ELSE IF (jprobs(t)>1.0) THEN
                island_sim(t)=zpts
                EXIT island_assignment_do0
            END IF
        END DO island_assignment_do0


        ! stay if new island is worse
        !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        IF (island_sim(t)<=island_sim(t-1)) THEN

                    island_sim(t)=island_sim(t-1)
                    e_sim(t)=0

                    ! update occupational tenure if worker had a job before
                    IF(hcind_sim(t-1)>0) THEN
                        hcten_sim(t)=hcten_sim(t-1)         ! occupational tenure only counted when at work +1
                    ELSE
                        hcten_sim(t)=0
                    END IF

                    duration_sim(t)=duration_sim(t-1)+1



        ! move if island is better
        !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ELSE    ! actual change of attention to a different island

                e_sim(t)=0
                IF(hcind_sim(t)>-1) THEN
                        hcind_sim(t)=0
                ELSE
                        hcind_sim(t)=hcind_sim(t)          ! changes to 1, if getting a job
                END IF
                hcten_sim(t)=0
                duration_sim(t)=duration_sim(t-1)+1
        END IF


        !================================
        !------successful matching
        !==================================
                ! lots of updating follows

        ELSE IF (e_sim(t-1)==0 .AND. poliR(aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t))==1 &
                        .AND. jprobs(t)<=jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))) THEN
        reall_ind=0

        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0) THEN
        !    up_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)<youngcutoff) up_young_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                         up_prime_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !END IF

            !--------------------------
            ! with occupational mobility before
        IF (hcind_sim(t)<=0) THEN

            hcind_sim(t)=1
            hcten_sim(t)=1

            !---------------
            ! no occupational mobility occurs
        ELSE
            hcten_sim(t)=hcten_sim(t-1)+1
            hcind_sim(t)=MAX(hcind_sim(t-1),1)
        END IF

        ! in all case update employment and wage information
            e_sim(t)=1
            wage_sim(t)=wage(aggprod_ind(t), hcind_sim(t), island_sim(t))
            e_duration_sim(t)=1

            ! keep the duration of the last unemployment spell!!
            duration_sim(t)=duration_sim(t-1)

       !--------unsuccessful matching, remain unemployed
        ELSE IF (e_sim(t-1)==0 .AND. poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==1 &
                        .AND. jprobs(t)>=jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))) THEN
        reall_ind=0

        !
        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0 .AND. unempdur_estatus(t/4)>=1) THEN
        !    IF (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))>0.00001_8) THEN
        !        up_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)<youngcutoff) up_young_search_distribution_sim(aggprod_ind(t))=up_young_search_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                             up_prime_search_distribution_sim(aggprod_ind(t))=up_prime_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    ELSE IF (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))<=0.00001_8) THEN
        !        up_rest_distribution_sim(aggprod_ind(t))=up_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)<youngcutoff) up_young_rest_distribution_sim(aggprod_ind(t))=up_young_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                             up_prime_rest_distribution_sim(aggprod_ind(t))=up_prime_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !    END IF
        !END IF
        !
                duration_sim(t)=duration_sim(t-1)+1

                IF(hcind_sim(t-1)>0) THEN
                    hcten_sim(t)=hcten_sim(t-1)+1
                ELSE
                    hcten_sim(t)=0
                END IF

                e_sim(t)=0
                wage_sim(t)=0.0_8

       ELSE
                WRITE(*,*) '====================================================================='
                WRITE(*,*) 'contingency should not occur in simulation loop --- DUMPING SITUATION'
                WRITE(*,*) ' ** time' , t, 'thread' , threadnumber
                WRITE(*,*) ' ** previous employment status e_sim(t-1)=(1/0 or E/U) -->', e_sim(t-1)
                WRITE(*,FMT=' (A8,F8.5,A6,I4,A5,I4,A5,I4,A5,F10.5)') 'e=0:', jprobs(t),'<>?jf(',aggprod_ind(t),',MAX(',hcind_sim(t),',1),',island_sim(t),')=', &
                                                                                                            jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))
                WRITE(*,*) ' **poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))', poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))

                WRITE(*,*)  ' **(jprobs(t) vs jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))=number)'
                WRITE(*,FMT='(A8,F8.5,A26,I4,A6,F10.5)') 'e=1:', sepprobs(t),'<>?sep_cutoff_vec(MAX(',hcind_sim(t),',1))=', &
                                                                                                                    sep_cutoff_vec(MAX(hcind_sim(t),1))
                WRITE(*,*)  '  ** poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))', poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))
                WRITE(*,*)  ' ** zprobs(t)=', zprobs(t)
                WRITE(*,*)  '  THETA  '
                WRITE(*,*)  thetal
                WRITE(*,*) '  sep_cutoff_vec '
                WRITE(*,*)  sep_cutoff_vec
                WRITE(*,*) '====================================================================='
                !! UPDATE VARIABLES: keep in the same position as before, but update tenures
                e_sim(t)=e_sim(t-1)
                IF(e_sim(t-1)==0) THEN
                        wage_sim(t)=0.0_8
                        duration_sim(t)=duration_sim(t-1)+1
                        hcten_sim(t)=hcten_sim(t-1)+1
                ELSE IF (e_sim(t-1)==1) THEN
                        hcten_sim(t)=hcten_sim(t-1)+1           !
                        e_sim(t)=1              ! KEEP THE JOB
                        wage_sim(t)=wage(aggprod_ind(t), hcind_sim(t), island_sim(t))
                        e_duration_sim(t)=e_duration_sim(t-1)+1
                END IF



       END IF sep_or_matching


END IF survival_if
! END OF PERIOD

    END DO indiv_timeseries_do_ss

!=========================================================
!  NET MOBILITY SIMULATION
!=========================================================

tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw


indiv_timeseries_do_netmob:&
DO t=tmin_sim2+1, tmax_sim2

! RESET THE INITIAL STARTING POINT AT THE BEGINNING OF THE WINDOW
window_start_if: &
IF(t==tswindow_wks_min) THEN
    e_sim(t)=e_sim(tmin_sim2)
    age_sim(t)=age_sim(tmin_sim2)
    hcten_sim(t)=hcten_sim(tmin_sim2)
    hcind_sim(t)=hcind_sim(tmin_sim2)      ! born with -2, reborn with -1, so not recorded as a reallocation when getting first job on the same island, reallocation 0
                         ! lowest hc level: 1, med hc level 2, hi hc level 3
    duration_sim(t)=duration_sim(tmin_sim2)
    wage_sim(t)=wage_sim(tmin_sim2)
    island_sim(t)=island_sim(tmin_sim2)
    e_duration_sim(t)=e_duration_sim(tmin_sim2)

    !! occupation distribution REPLACED BY RANDOMNESS 
    
    !IF ((REAL(i)/REAL(nsim_gen))<=init_occdistr(1)) THEN
    !    corr_occid_sim(t)=1
    !END IF
    !
    !DO occcnt=2,occpts
    !    IF ((REAL(i)/REAL(nsim_gen))>init_occdistr(occcnt-1) .AND. (REAL(i)/REAL(nsim_gen))<=init_occdistr(occcnt)) THEN
    !        corr_occid_sim(t)=occcnt
    !    END IF
    !END DO

    ! draw new island
        CALL RANDOM_NUMBER(tempreal)
        superocc_assignment_if: &
        DO occcnt=1,occpts
            IF (tempreal<=init_occdistr(occcnt)) THEN
                corr_occid_sim(t)=occcnt
                EXIT superocc_assignment_if
            ELSE IF (tempreal>1.0) THEN
                WRITE(*,*) 'superocc_assignment_if problem: random number>1'
                corr_occid_sim(t)=occpts
                EXIT superocc_assignment_if
            END IF
        END DO superocc_assignment_if


    
    
    !! NEED OBSERVED OCCUPATIONAL IDENTITY (MEASURED WITH ERROR) (need to generate a random number for this)
    tempreal=sepprobs(t)
    occupation_observedcode_initnm: &
        DO occcnt=1, occpts
            IF (tempreal<gamma_miscode(corr_occid_sim(t),occcnt)) THEN
                occid_sim(t)=occcnt
                EXIT occupation_observedcode_initnm
            ELSE IF (tempreal>=1.0) THEN
                occid_sim(t)=occpts
                EXIT occupation_observedcode_initnm
            END IF
        END DO occupation_observedcode_initnm



    !! UPDATE WINDOW
    tswindow_wks_min=tswindow_wks_min+tmax_swindow_wks_raw
    tswindow_wks_max=tswindow_wks_min-1    ! note: uses the newly updated tswindow_wks_min


    IF(occid_sim(t)>0 .AND. e_sim(t)==1) occdistr_begin_end(occid_sim(t),1)=occdistr_begin_end(occid_sim(t),1)+1.0
    IF(corr_occid_sim(t)>0 .AND. e_sim(t)==1) corr_occdistr_begin_end(corr_occid_sim(t),1)=corr_occdistr_begin_end(corr_occid_sim(t),1)+1.0
    IF(occid_sim(t)>0 .AND. e_sim(t)==1) occdistr_begin_end(occid_sim(t),1)=occdistr_begin_end(occid_sim(t),1)+1.0


!!-----------------------
!!window_start_if: &
!!---------------------
ELSE
! ELSE PROCEED TO THE REGULAR WITHIN PERIOD UPDATE
                    !IF ((t/4)*4-t==0 .AND. t>3000) monthind=1  ! month observation

            !    ! write a sequence
            !    IF (threadnumber==1) THEN
            !    IF(i==1 .OR. i==2 .AND. counter1==1) THEN
            !    WRITE(UNIT=49,FMT='(A2,I4, A4,I3, A6,I3,A5, I2,A8,I4,A7,I4)', ADVANCE='NO') 't=', t-1, ', p=', aggprod_ind(t-1), ', isl=', island_sim(t-1), ', hc=', hcind_sim(t-1), ', hcten=', hcten_sim(t-1), ', dur=', duration_sim(t-1)
            !    WRITE(UNIT=49, FMT='(A5,F5.2,A20, F5.2, A4, F5.2, A5, F5.2, A7, F5.2)', ADVANCE='NO')'wage=', wage_sim(t-1), ', monthly stats: u', data_u_qtr(t-1), ', v', data_v_qtr(t-1), ', sep', data_sep_qtr(t-1), ', reall', data_reall_qtr(t)
            !    WRITE(UNIT=49, FMT='(A20,3F5.2)') 'duration matrix', durationmatrix(MAX(MIN(duration_sim(t-1),205)-1,0),t-1),durationmatrix(MAX(MIN(duration_sim(t-1),205),0),t-1),durationmatrix(MAX(MIN(duration_sim(t-1)+1,205),0),t-1)
            !    END IF
            !    END IF !(threadnumber==1)

!-----------------------------------------------------
! STAGE 1: DEATH SHOCK, HUMAN CAPITAL ACCUMULATION
!-----------------------------------------------------




survival_if_nm: &
! DID NOT SURVIVE
IF(sepprobs(t)<dd .OR. age_sim(t)>(gencutoff+5*48)) THEN                ! DEATH AND TAXES -- COULD REPLACED BY NEWBORN. REPLACE SIXTY-YEAR OLDS WITH NEWBORNS
                                                                        ! CHECK AGE_SIM timing; should be AGE_SIM(t-1)??

!! record exit before things are reset
!! counter1=MAX(((t-tmin_sim2)/12),1)  quarter counter later 
tempint=(t-tmin_sim2)/12
IF(t>tswindow_wks_min-tmax_swindow_wks_raw+2 .AND. (t<tmin_sim2+no_superwindows*tmax_swindow_wks_raw) &
        .AND. tempint>0 ) THEN  
    
    IF (t<tswindow_wks_min-tmax_swindow_endexitcounting) THEN
        corr_occdistr_exo_entry_exit(MAX(0,corr_occid_sim(t-1)),2)=corr_occdistr_exo_entry_exit(MAX(0,corr_occid_sim(t-1)),2)+1.0
        occdistr_exo_entry_exit(MAX(0,occid_sim(t-1)),2)=occdistr_exo_entry_exit(MAX(0,occid_sim(t-1)),2)+1.0
    END IF 
    
    IF(tempint>0 .AND. tempint<=maxqtr_alloc .AND. mask_qtr(tempint)==.TRUE.) THEN
        corr_occdistr_exo_entry_exit_qtr(MAX(0,corr_occid_sim(t-1)),2, tempint)=corr_occdistr_exo_entry_exit_qtr(MAX(0,corr_occid_sim(t-1)),2,tempint)+1.0
        occdistr_exo_entry_exit_qtr(MAX(0,occid_sim(t-1)),2,tempint)=occdistr_exo_entry_exit_qtr(MAX(0,occid_sim(t-1)),2,tempint)+1.0
    END IF
END IF


e_sim(t)=0
age_sim(t)=0
hcten_sim(t)=0
hcind_sim(t)=-1      ! born with -2, reborn with -1, so not recorded as a reallocation when getting first job on the same island, reallocation 0
                     ! lowest hc level: 1, med hc level 2, hi hc level 3
duration_sim(t)=0
wage_sim(t)=0.0_8


! draw new island
        !CALL RANDOM_NUMBER(tempreal)
        tempreal=zprobs(t)
        island_assignment_do_nm: &
        DO zcnt=1,zpts
            IF (tempreal<=znewcdf(zcnt)) THEN
                island_sim(t)=zcnt
                EXIT island_assignment_do_nm
            ELSE IF (tempreal>1.0) THEN
                island_sim(t)=zpts
                EXIT island_assignment_do_nm
            END IF
        END DO island_assignment_do_nm


! draw new occupation
        !CALL RANDOM_NUMBER(tempreal)
        tempreal=jprobs(t)
        occ_assignment_do_nm_entry: &
        DO occcnt=1,occpts
            IF (tempreal<=entry_occdistr(occcnt)) THEN
                corr_occid_sim(t)=occcnt
                EXIT occ_assignment_do_nm_entry
            ELSE IF (tempreal>1.0) THEN
                WRITE(*,*) 'error in occ_Assignment_do_nm_entry, entry new guys'
                corr_occid_sim(t)=occpts
                EXIT occ_assignment_do_nm_entry
            END IF
    END DO occ_assignment_do_nm_entry

! commented out because we want entry at the moment of employment!!!!
!IF(t>tswindow_wks_min-tmax_swindow_wks_raw+2 .AND. (t<tmin_sim2+no_superwindows*tmax_swindow_wks_raw)) THEN
        entry_test_distr(MAX(0,corr_occid_sim(t)))=entry_test_distr(MAX(0,corr_occid_sim(t)))+1.0
        corr_occdistr_exo_entry_exit3(MAX(0,corr_occid_sim(t)),1)=corr_occdistr_exo_entry_exit3(MAX(0,corr_occid_sim(t)),1)+1.0
        !occdistr_exo_entry_exit3(MAX(0,occid_sim(t)),1)=occdistr_exo_entry_exit3(MAX(0,occid_sim(t)),1)+1.0
!END IF
! code this occupation independently
         !CALL RANDOM_SEED
         CALL RANDOM_NUMBER(tempreal2)
            occupation_observedcode_birthnm: &
                DO occcnt=1, occpts
                    IF (tempreal2<gamma_miscode(corr_occid_sim(t), occcnt)) THEN
                        occid_sim(t)=occcnt
                        EXIT occupation_observedcode_birthnm
                    ELSE IF (tempreal2>1.0) THEN
                        occid_sim(t)=occpts
                        EXIT occupation_observedcode_birthnm
                    END IF
                END DO occupation_observedcode_birthnm

occdistr_exo_entry_exit3(occid_sim(t),1)=occdistr_exo_entry_exit3(occid_sim(t),1)+1.0



        !-------------> GOTO END OF SURVIVAL IF

ELSE survival_if_nm        ! you're a survivor!!!   -you're taken through the motions

!====================================================================
! UPDATE AGE, HC, Z, AND OCC ID
!====================================================================

! 1 UPDATE AGE
age_sim(t)=age_sim(t-1)+1

    !----------------------------------
    !   HUMAN CAPITAL UPGRADING (DOWNGRADING TOO!), AND ISLAND-SHOCK (which updates island_sim(t-1)!!!! because island_sim(t) is the newly reallocated island)
    !----------------------------------

! 2 UPDATE HC
    ! human capital upgrading/downgrading
    IF(e_sim(t-1)==0 .AND. (skilldep==0.0_8 .OR. hcind_sim(t-1)<=1)) THEN
        hcind_sim(t)=hcind_sim(t-1)
    ELSE IF (e_sim(t-1)==0 .AND. (skilldep>0.0_8 .AND. hcind_sim(t-1)>1)) THEN
        IF (sepprobs(t)<=skilldep_cutoff) THEN
            hcind_sim(t)=hcind_sim(t-1)
        ELSE IF (sepprobs(t)>=skilldep_cutoff .AND. sepprobs(t)<=1.0_8) THEN
            hcind_sim(t)=hcind_sim(t-1)-1
        END IF
    ELSE IF (e_sim(t-1)==1 .AND. hcind_sim(t-1)>0) THEN
        IF (jprobs(t)<=xtransmatrix(hcind_sim(t-1), hcind_sim(t-1))) THEN
            hcind_sim(t)=hcind_sim(t-1)
        ELSE IF (jprobs(t)<=1.0_8) THEN
            hcind_sim(t)=hcind_sim(t-1)+1
        ELSE
            WRITE(*,*) 'SHOULDNOT ARRIVE    HERE: WORKRANDOM1(t)/sepprobs=', sepprobs(t)
            !STOP
        END IF
    ELSE
         WRITE(*,*) 'hcind_sim update mistake, hcind_sim, e_sim', hcind_sim(t-1), e_sim(t-1)
            !STOP
    END IF

    !-----------------------------------------
    !   ISLAND PRODUCTIVITY SHOCK
    !-----------------------------------------

    ! island shock hits island_sim(t-1); which is overwritten by design!!!

! 3 UPDATE Z
    tempreal=zprobs(t)
    IF (ztransmatrix(island_sim(t-1), island_sim(t-1))>=zprobs(t)) THEN

        island_sim(t-1)=island_sim(t-1)
        flag_z=1

    ELSE  IF (ztransmatrix(island_sim(t-1), island_sim(t-1)) < zprobs(t)) THEN

        zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), island_sim(t-1))

        IF(zprobs(t)<0.0) WRITE(10,*) 'ALREADY ERROR: diminished zprobs, flag============='

        tempint=island_sim(t-1)
        tempint2=island_sim(t-1)
        flag_z=0

        island_assignment_do2_nm: DO zcnt=1, zpts
            IF(zprobs(t)<0.0) WRITE(10,*) 'ERROR: diminished zprobs, flag=',flag_z
            IF(island_sim(t-1)-zcnt>0 .AND. flag_z==0) THEN

                tempint=island_sim(t-1)-zcnt

                IF(ztransmatrix(island_sim(t-1), tempint)>= zprobs(t)) THEN
                    island_sim(t-1)=tempint
                    flag_z=1
                    EXIT island_assignment_do2_nm
                ELSE
                    zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), tempint)
                END IF
            ELSE
                !WRITE(10,*) 'weird:check... flag_z=', flag_z, 'island_sim=', island_sim(t-1), 'zcnt=', zcnt
            END IF

            IF(island_sim(t-1)+zcnt<=zpts .AND. flag_z==0)  THEN
                IF(zprobs(t)<0.0) WRITE(10,*) 'ERROR: diminished zprobs, flag=',flag_z

                tempint2=island_sim(t-1)+zcnt

                IF(ztransmatrix(island_sim(t-1), tempint2)>zprobs(t)-0.00001_8) THEN
                    island_sim(t-1)=tempint2
                    flag_z=1
                    EXIT island_assignment_do2_nm
                ELSE
                    zprobs(t)=zprobs(t)-ztransmatrix(island_sim(t-1), tempint2)
                END IF
            END IF


            IF(tempint==1 .AND. tempint2==zpts) THEN
!			WRITE(10,*) 'ERRRRRRRRORRRRRRRR in islandsim, flag=', flag_z, 'zprobs=', zprobs(t)!
!			WRITE(10,*) 'original zprobs(t)=', tempreal, 'island_sim(t-1)=', island_sim(t-1), '|island_sim(t)=', island_sim(t)

	    END IF
        END DO island_assignment_do2_nm

    END IF


    ! assign updated island_sim to the today's ex post island indicator
    island_sim(t)=island_sim(t-1)       ! workers stays on the same island, but island moves according to islandprod_ind
    IF(island_sim(t)<0) WRITE(10,*) 'island trouble: island_sim(t) gives a below-zero island indicator'

! 4 CARRY OVER OCCUPATIONAL ID
    ! carry over occ_id
    corr_occid_sim(t)=corr_occid_sim(t-1)
    occid_sim(t)=occid_sim(t-1)
    !------------------------------------------------------------------------
    !  SEPARATION STAGE IN CASE OF EMPLOYED, REALLOCATION+MATCHING IN CASE OF UNEMPLOYED
    !------------------------------------------------------------------------


    ! ---- sep: lose the job
    sep_or_matching_nm:&
        IF (e_sim(t-1)==1 .AND. (sepprobs(t)>=sep_cutoff_vec(MAX(hcind_sim(t),1)) .OR. poliDW_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==0)) THEN

                duration_sim(t)=0
                hcten_sim(t)=hcten_sim(t-1)
                e_sim(t)=0
                wage_sim(t)=0.0_8


        !----keep the job
        ELSE IF (e_sim(t-1)==1 .AND. (sepprobs(t)<=sep_cutoff_vec(MAX(hcind_sim(t),1)) .AND. poliDW_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==1)) THEN
                ! keep the job

                hcten_sim(t)=hcten_sim(t-1)+1           !
                e_sim(t)=1              ! KEEP THE JOB
                wage_sim(t)=WAGE_Occ(corr_occid_sim(t), aggprod_ind(t), hcind_sim(t), island_sim(t))
                e_duration_sim(t)=e_duration_sim(t-1)+1

                ! keep the duration of the last completed unemployment spell
                duration_sim(t)=duration_sim(t-1)

                IF(hcind_sim(t)<1) THEN
                    WRITE(*,*) 'error in hcind_sim assignment'
                    STOP
                END IF



        !----- reallocate

        ELSE IF (e_sim(t-1)==0 .AND. poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==0) THEN

        IF(t>tmin_sim2) THEN
            tot_reallcost=tot_reallcost+reallc
            IF(reall_ind==0) THEN
                tot_realls=tot_realls+1.0_8
                reall_ind=1
            END IF
        END IF

        ! reallocation unemployment

        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0 .AND. unempdur_estatus(t/4)>=1) THEN
        !    up_reall_distribution_sim(aggprod_ind(t))=up_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)<youngcutoff) up_young_reall_distribution_sim(aggprod_ind(t))=up_young_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                         up_prime_reall_distribution_sim(aggprod_ind(t))=up_prime_reall_distribution_sim(aggprod_ind(t))+1.0_8
        !END IF

        !island_sim(t)=MIN(INT(sepprobs(t)*REAL(maxislands))+1, maxislands)

        !sepprobs(t)=(sepprobs(t)-dd)/(1.0_8-dd)         ! using sepprobs (can be used scaling znewcdf, not needing to rescale sepprobs)
                                                        ! not using jprobs at this step, can be used for occupational direction in future version
                                                        ! using jprobs now, because sepprobs used in skilldep



        !! DRAW Z-PRODUCTIVITY  (USING JPROBS OR RANDOM_NUMBER; not used otherwise; SEP probs used in hc depreciation; ZPROBS used in z update)
        !CALL RANDOM_SEED
        CALL RANDOM_NUMBER(tempreal)
        !tempreal=jprobs(t)
        island_assignment_do0_nm:&
        DO zcnt=1,zpts
            IF (tempreal<=znewcdf(zcnt)) THEN
                island_sim(t)=zcnt
                EXIT island_assignment_do0_nm
            ELSE IF (tempreal>1.0) THEN
                island_sim(t)=zpts
                EXIT island_assignment_do0_nm
            END IF
    END DO island_assignment_do0_nm

        !! NEED OCCUPATIONAL IDENTITY  (need to generate a random number for this)
        !CALL RANDOM_SEED
        !CALL RANDOM_NUMBER(tempreal)
        tempreal=jprobs(t)      !(USING JPROBS; not used otherwise; SEP probs used in hc depreciation; ZPROBS used in z update)
        occupation_assignment_doreall_nm: &
        DO occcnt=1, occpts
            IF (tempreal<=SEARCHDIR_OCC(corr_occid_sim(t-1), occcnt,aggprod_ind(t))) THEN
                corr_occid_sim(t)=occcnt
                EXIT occupation_assignment_doreall_nm
            ELSE IF (tempreal>1.0+0.00000000001) THEN
                WRITE(*,*) 'violation of random no in occupation_assignment_doreall_nm'
                corr_occid_sim(t)=occpts
                EXIT occupation_assignment_doreall_nm
            END IF
        END DO occupation_assignment_doreall_nm
        !! OBSERVED OCCUPATIONAL IDENTITY ONLY UPDATED AT MOMENT OF NEW JOB

        ! stay if new island is worse 
        !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        IF ((tempreal>SEARCHDIR_OCC(corr_occid_sim(t-1), occpts,aggprod_ind(t)))   &
             !.OR. (VUO(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))<&
              !  VUO(corr_occid_sim(t-1), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))) &
             ) THEN
                    ! note that island_sim(t-1) refers to current z in old occupation.

                    island_sim(t)=1 !island_sim(t-1)
                    corr_occid_sim(t)=corr_occid_sim(t-1)
                    !occid_sim(t)=occid_sim(t-1)
                    e_sim(t)=0

                    ! update occupational tenure if worker had a job before
                    IF(hcind_sim(t-1)>0) THEN
                        hcten_sim(t)=hcten_sim(t-1)         ! occupational tenure only counted when at work +1
                    ELSE
                        hcten_sim(t)=0
                    END IF

                    duration_sim(t)=duration_sim(t-1)+1



        ! move if island is better
        !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        ELSE    ! actual change of attention to a different island

                e_sim(t)=0
                !island_sim(t)=island_sim(t)
                !corr_occid_sim(t)=corr_occid_sim(t)

                IF(hcind_sim(t)>-1) THEN
                        hcind_sim(t)=0
                ELSE
                        hcind_sim(t)=hcind_sim(t)          ! changes to 1, if getting a job
                END IF
                hcten_sim(t)=0
                duration_sim(t)=duration_sim(t-1)+1
        END IF


        !================================
        !------successful matching
        !==================================
                ! lots of updating follows

        ELSE IF (e_sim(t-1)==0 .AND. poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t))==1 &
                        .AND. jprobs(t)<=JF_Occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))) THEN
        reall_ind=0

        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0) THEN
        !    up_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)<youngcutoff) up_young_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                         up_prime_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !END IF

            !------------------------------------
            ! if a newborn
            IF(hcind_sim(t)==-1) THEN
                        !IF(t>tswindow_wks_min-tmax_swindow_wks_raw+2 .AND. (t<tmin_sim2+no_superwindows*tmax_swindow_wks_raw)  &
                        !    1 .AND. ) THEN  !(t<tswindow_wks_min-tmax_swindow_endexitcounting)
            tempint=(t-tmin_sim2)/12
            IF(t>tswindow_wks_min-tmax_swindow_wks_raw+2 .AND. (t<tmin_sim2+no_superwindows*tmax_swindow_wks_raw) &
                    .AND. tempint>0 ) THEN  !(t<tswindow_wks_min-tmax_swindow_endexitcounting)
                
                IF(t<tswindow_wks_min-tmax_swindow_endexitcounting) THEN
                corr_occdistr_exo_entry_exit(MAX(0,corr_occid_sim(t)),1)=corr_occdistr_exo_entry_exit(MAX(0,corr_occid_sim(t)),1)+1.0
                occdistr_exo_entry_exit(MAX(0,occid_sim(t)),1)=occdistr_exo_entry_exit(MAX(0,occid_sim(t)),1)+1.0
                END IF 
                
                IF(tempint>0 .AND. tempint<=maxqtr_alloc .AND. mask_qtr(tempint)==.TRUE.) THEN
                    corr_occdistr_exo_entry_exit_qtr(MAX(0,corr_occid_sim(t)),1, tempint)=corr_occdistr_exo_entry_exit_qtr(MAX(0,corr_occid_sim(t)),1,tempint)+1.0
                    occdistr_exo_entry_exit_qtr(MAX(0,occid_sim(t)),1,tempint)=occdistr_exo_entry_exit_qtr(MAX(0,occid_sim(t)),1,tempint)+1.0
                END IF
                
            END IF
            END IF

            !--------------------------
            ! with occupational mobility before, or a newborn, update to occupational tenure, and lowest-level of HC
        IF (hcind_sim(t)<=0) THEN

            hcind_sim(t)=1
            hcten_sim(t)=1

            !---------------
            ! no occupational mobility occurs, add to occ tenure, keep hc at least at lowest level
        ELSE
            hcten_sim(t)=hcten_sim(t-1)+1
            hcind_sim(t)=MAX(hcind_sim(t-1),1)
        END IF

        ! in all case update employment and wage information
            e_sim(t)=1
            wage_sim(t)=wage_occ(corr_occid_sim(t), aggprod_ind(t), hcind_sim(t), island_sim(t))
            e_duration_sim(t)=1

            ! keep the duration of the last unemployment spell!!
            duration_sim(t)=duration_sim(t-1)

         ! INDEPENDENT INTERVIEWING

        !! NEED OBSERVED OCCUPATIONAL IDENTITY (MEASURED WITH ERROR) (need to generate a random number for this)
        CALL RANDOM_NUMBER(tempreal)
        occupation_observedcode_nm: &
        DO occcnt=1, occpts
            IF (tempreal<gamma_miscode(corr_occid_sim(t), occcnt)) THEN
                occid_sim(t)=occcnt
                EXIT occupation_observedcode_nm
            ELSE IF (tempreal>1.0) THEN
                occid_sim(t)=occpts
                EXIT occupation_observedcode_nm
            END IF
        END DO occupation_observedcode_nm

       !--------unsuccessful matching, remain unemployed
        ELSE IF (e_sim(t-1)==0 .AND. poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==1 &
                        .AND. jprobs(t)>=jf_Occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))) THEN
        reall_ind=0

        !
        !IF (t>tmin_sim2 .AND. (t/4)*4-t==0 .AND. unempdur_estatus(t/4)>=1) THEN
        !    IF (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))>0.00001_8) THEN
        !        up_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)<youngcutoff) up_young_search_distribution_sim(aggprod_ind(t))=up_young_search_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                             up_prime_search_distribution_sim(aggprod_ind(t))=up_prime_search_distribution_sim(aggprod_ind(t))+1.0_8
        !    ELSE IF (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))<=0.00001_8) THEN
        !        up_rest_distribution_sim(aggprod_ind(t))=up_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)<youngcutoff) up_young_rest_distribution_sim(aggprod_ind(t))=up_young_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
        !                                             up_prime_rest_distribution_sim(aggprod_ind(t))=up_prime_rest_distribution_sim(aggprod_ind(t))+1.0_8
        !    END IF
        !END IF
        !
                duration_sim(t)=duration_sim(t-1)+1

                IF(hcind_sim(t-1)>0) THEN
                    hcten_sim(t)=hcten_sim(t-1)+1
                ELSE
                    hcten_sim(t)=0
                END IF

                e_sim(t)=0
                wage_sim(t)=0.0_8

       ELSE
                WRITE(*,*) '====================================================================='
                WRITE(*,*) 'contingency should not occur in simulation loop --- DUMPING SITUATION'
                WRITE(*,*) ' ** time' , t, 'thread' , threadnumber
                WRITE(*,*) ' ** previous employment status (b4 jf) e(t-1)=(1/0 or E/U) -->', e_sim(t-1)
                WRITE(*,*) ' ** current code employment status e_sim(t)=(1/0 or E/U) -->', e_sim(t)
                WRITE(*,*) ' '
                WRITE(*,*) ' p = ', aggprod_ind(t)
                WRITE(*,*) ' x = ', hcind_sim(t)
                WRITE(*,*) ' z = ', island_sim(t-1)
                WRITE(*,*) ' o = ', corr_occid_sim(t)
                WRITE(*,*) ' o-= ', corr_occid_sim(t-1)
                WRITE(*,*) ' o^= ', occid_sim(t)
                WRITE(*,*) ' jf=', JF_OCC(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))
                WRITE(*,*) ' sep=', poliDW_OCC(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))
                WRITE(*,*) ' R=', poliR_OCC(corr_occid_sim(t),aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))
                WRITE(*,*) 'sd=', searchdir_occ(corr_occid_sim(t-1),:,aggprod_ind(t))
                !! COMPARE WHAT WOULD HAPPEN IF UNEMPLOYED
                IF (jprobs(t)<=JF_OCC(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))) THEN
                    WRITE(*,FMT=' (A8,F8.5,A10,I4,  A1,I4,A1,I4, A1, I1,A5,F10.5)') 'e=0:', jprobs(t),'<=jf_occ(',aggprod_ind(t),',',hcind_sim(t),',',island_sim(t), ',', corr_occid_sim(t), ')=', &
                                                                                                            jf_occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))
                ELSE
                    WRITE(*,FMT=' (A8,F8.5,A10,I4,  A1,I4,A1,I4, A1, I1,A5,F10.5)') 'e=0:', jprobs(t),&
                            '> jf_occ(',corr_occid_sim(t),',', aggprod_ind(t),',',hcind_sim(t),',',island_sim(t),  ')=', &
                            jf_occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))
                END IF
                WRITE(*,*) ' reallocation simulation'
                WRITE(*,*) ' **poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t), occ(t))', &
                                poliR_occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))

                IF (e_sim(t-1)==0) THEN
                    WRITE(*,*)  ' separation simulation, but worker was unemployed before'
                ELSEIF (e_sim(t-1)==1) THEN
                    WRITE(*,*) ' separation simulation: RELEVANT SINCE EMPLOYED BEFORE!!!'
                END IF
                WRITE(*,FMT='(A8,F8.5,A26,I4,A6,F10.5)') 'e=1:', sepprobs(t),'<>?sep_cutoff_vec(MAX(',hcind_sim(t),',1))=', &
                                                                                                                    sep_cutoff_vec(MAX(hcind_sim(t),1))
                WRITE(*,*)  '  ** poliDW_occ(aggprod_ind(t), MAX(hcind_sim(t),1), z(t), occ(t))', poliDW_occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t-1))
                WRITE(*,*)  ' ** zprobs(t)=', zprobs(t)
                WRITE(*,*)  '  THETA  '
                WRITE(*,*)  thetal
                WRITE(*,*) '  sep_cutoff_vec '
                WRITE(*,*)  sep_cutoff_vec
                WRITE(*,*) ''
                WRITE(*,*) ' --- ORIGINAL (NO OCC ID) ---- '
                WRITE(*,*) ''

                WRITE(*,*) ' ** time' , t, 'thread' , threadnumber
                WRITE(*,*) ' ** previous employment status e_sim(t-1)=(1/0 or E/U) -->', e_sim(t-1)
                WRITE(*,FMT=' (A8,F8.5,A6,I4,A5,I4,A5,I4,A5,F10.5)') 'e=0:', jprobs(t),'<>?jf(',aggprod_ind(t),',MAX(',hcind_sim(t),',1),',island_sim(t),')=', &
                                                                                                            jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))
                WRITE(*,*) ' **poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))', poliR(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))

                WRITE(*,*)  ' **(jprobs(t) vs jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))=number)'
                WRITE(*,FMT='(A8,F8.5,A26,I4,A6,F10.5)') 'e=1:', sepprobs(t),'<>?sep_cutoff_vec(MAX(',hcind_sim(t),',1))=', &
                                                                                                                    sep_cutoff_vec(MAX(hcind_sim(t),1))
                WRITE(*,*)  '  ** poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))', poliDW(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))
                WRITE(*,*)  ' ** zprobs(t)=', zprobs(t)
                WRITE(*,*)  '  THETA  '
                WRITE(*,*)  thetal
                WRITE(*,*) '  sep_cutoff_vec '
                WRITE(*,*)  sep_cutoff_vec


                WRITE(*,*) '====================================================================='
                !! UPDATE VARIABLES: keep in the same position as before, but update tenures
                e_sim(t)=e_sim(t-1)
                IF(e_sim(t-1)==0) THEN
                        wage_sim(t)=0.0_8
                        duration_sim(t)=duration_sim(t-1)+1
                        hcten_sim(t)=hcten_sim(t-1)+1
                ELSE IF (e_sim(t-1)==1) THEN
                        hcten_sim(t)=hcten_sim(t-1)+1           !
                        e_sim(t)=1              ! KEEP THE JOB
                        wage_sim(t)=wage(aggprod_ind(t), hcind_sim(t), island_sim(t))
                        e_duration_sim(t)=e_duration_sim(t-1)+1
                END IF



       END IF sep_or_matching_nm


END IF survival_if_nm       ! END OF PERIOD
END IF window_start_if      ! END OF WINDOW_START_IF: (1) RESTART WINDOW, initialize; (2) go through regular timing


    !
    !IF(write_netmob_simul_test_ind==1 .AND. i==1 ) THEN
    !            WRITE(10,FMT='(A2,I6,A4,I2,A4,I1,A4,I3,A4,I1, A7,I1, A5, I1,A7,I1,A7,I1)') 't=', t, ', p=',aggprod_ind(t),', x=', hcind_sim(t),', z=', island_sim(t-1),', o=', corr_occid_sim(t), &
    !                ', ot-1=', corr_occid_sim(t-1),', o^=', occid_sim(t), &
    !                ', decR=', poliR_Occ(aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1), corr_occid_sim(t-1)), &
    !                ', decS=', poliDW_Occ(aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1), corr_occid_sim(t-1))
    !IF(t==tswindow_wks_max-1) WRITE(10,*) '-----------------------------------------------------'
    !END IF

    !WRITE(10,FMT='(I3,A3, I8, A3, I4, A3, I3,A3, I4,A3, I5,A3, I5,A3, I5,A3, I5,A3,I5, A3)')&
    IF(write_netmob_simul_test_ind==1 .AND. i==1 .AND. t==(tmax_sim2*8)/10) THEN
        WRITE(10,FMT='(A3,A3, A8,A3, A4,A3, A4,A3, A3,A3, A4,A3, A5,A3, A5,A3, A5,A3,   A5,A3, A5,A3)', ADVANCE='no') &
                       'vs ',' , ', &
                            'week', ' , ',&
                                    'age ',' , ', &
                                           'aggp',' , ', &
                                                  'hc ', ' , ' , &
                                                        'zind', ' , ', &
                                                               'cor_o', ' , ', &
                                                                      'oo_lw', ' , ', &
                                                                             'obs_o', ' , ', &
                                                                                      'reall', ' , ', &
                                                                                               'sep', ' , '
        WRITE(10,FMT='(A9,A3, A9,A3, A9,A3)') &
            'srchcdf-1', ' , ' , 'ranjprobs', ' , ', 'srchcdf', ' , '
    END IF

    IF(write_netmob_simul_test_ind==1 .AND. (i==1 .OR. i==nsim_gen/2 .OR. i==nsim_gen) .AND. t>=(tmax_sim2*8)/10 .AND. t<tmax_sim2) THEN
        !DO t=(tmax_sim2*8)/10, tmax_sim2

                WRITE(10,FMT='(I3,A3, I8,A3, I4,A3, I4,A3, I3,A3, I4,A3, I5,A3, I5,A3, I5,A3, I5,A3, I5,A3)', ADVANCE='NO') &
                        1,' , ', t, ' , ', age_sim(t), ' , ', aggprod_ind(t),' , ', hcind_sim(t),' , ', island_sim(t-1),' , ', corr_occid_sim(t), &
                    ' , ', corr_occid_sim(t-1),' , ', occid_sim(t), &
                    ' , ', poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1)), &
                    ' , ', poliDW_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1)), ' , '
                IF(corr_occid_sim(t-1) .ne. corr_occid_sim(t)) THEN
                    IF (corr_occid_sim(t)>1) THEN
                        WRITE(10,FMT='(2(F9.4, A3))', ADVANCE='NO') SEARCHDIR_OCC(corr_occid_sim(t-1), corr_occid_sim(t)-1,aggprod_ind(t)), ' , '
                    ELSE
                        WRITE(10,FMT='(2(F9.4, A3))', ADVANCE='NO') 0.0, ' , '
                    END IF
                    WRITE(10,FMT='(2(F9.4, A3))', ADVANCE='NO') jprobs(t), ' , ' , SEARCHDIR_OCC(corr_occid_sim(t-1), corr_occid_sim(t),aggprod_ind(t)), ' , '

                END IF
                WRITE(10,FMT='(A1)') ' '
        IF(t==tswindow_wks_max-1) WRITE(10,*) '-----------------------------------------------------'
        !END DO
    END IF



    IF(t==tswindow_wks_max-1) THEN

        IF(occid_sim(t)>0 .AND. e_sim(t)==1) occdistr_begin_end(occid_sim(t),2)=occdistr_begin_end(occid_sim(t),2)+1.0
        IF(corr_occid_sim(t)>0 .AND. e_sim(t)==1) corr_occdistr_begin_end(corr_occid_sim(t),2)=corr_occdistr_begin_end(corr_occid_sim(t),2)+1.0
        IF(occid_sim(t)>0 .AND. e_sim(t)==1) occdistr_begin_end(occid_sim(t),2)=occdistr_begin_end(occid_sim(t),2)+1.0
    END IF

END DO indiv_timeseries_do_netmob



!!---------------------------------------------------
!! OCCUPATIONAL MOBILITY THROUGH UNEMPLOYMENT : assign cocc/nocc indicators
!!----------------------------------------------------

    !! ORIGINAL
    !! occmob_ind=-2 unassigned indicator, should only occur for those born at beginning of panel, without any previous occupation
                    ! and those leaving the panel, no subsequent occupation
    !! occmob_ind=-1 born in middle of panel, no previous occupation
    !! occmob_ind=0 employed
    !! occmob_ind=1 end of spell with occupational change
    !! occmob_ind=2 end of spell without occupational change

    !! CHANGED
    !! occmob_ind=-2 unassigned indicator, should only occur for those born at beginning of panel, without any previous occupation
                    ! and those leaving the panel, no subsequent occupation
    !! occmob_ind=-1 born in middle of panel, no previous occupation
    !! occmob_ind=0 employed
    !! occmob_ind=1 end of spell with occupational change
    !! occmob_ind=2 end of spell without occupational change
    !! occmob_ind=3 employed after occupational change
    !! occmob_ind=4 employed after unemployment spell without occupational change

    !! occmob_ind indicates whether the u-spell ends with occupational change (1), or not (2)
occmob_ind(:)=-2
corr_occmob_ind(:)=-2


!! counter1=
counter1=tmin_sim2+1


!!====================
!! ASSIGN OCCUPATIONAL MOBILITY STATUS
!!====================

    ! NOTE: we assign this to every week, based on weekly jobfinding and separation, and weekly employment status
    ! WARNING: therefore occmob_ind SHOULD NOT BE USED TO INFER MONTHLY EMPLOYMENT STATUS

tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw
counter1=tswindow_wks_min+1

cocc_superwindow_loop: &
DO zcnt=1, no_superwindows

cocc_loop: &
DO WHILE (counter1<tswindow_wks_max-72)


    cocc_loop_within_window_if: &
    IF(counter1>=tswindow_wks_max-72) THEN      ! too close to finish, should not occur
        counter1=tswindow_wks_max

    !! SEPARATION
    ELSE IF(e_sim(MAX(counter1,1))==0 .AND. e_sim(MAX(counter1-1,1))==1 .AND. counter1<tswindow_wks_max-72) THEN       ! week-to-week separation
                                                                                                                ! not in the last 8 months of simulated data series

                    !********** TIMEFORWARD DO
                        timeforward_do:&
                        DO t=counter1+1, tswindow_wks_max-1

                            IF(e_sim(t)==1) THEN       ! found employment again   -- NEW EMPLOYMENT
                                tempint=t

                                !! STAY IN SAME OCCUPATION (TRUE)
                                IF(hcind_sim(t-1)>0) THEN           ! same occupation (notice timing)
                                    occmob_ind(counter1:t-1)=2
                                    occmob_ind(t)=4                      ! used to assign occ mobility in the last unemployment spell to employment spell
                                    corr_occmob_ind(counter1:t-1)=2
                                    corr_occmob_ind(t)=4                      ! used to assign occ mobility in the last unemployment spell to employment spell

                                    !! RE_DEFINE OCCID_SIM AND CORR_OCCID_SIM TO CAPTURE LAST EMPLOYMENT COMPARED TO CURRENT EMPLOYMENT
                                    tempint=corr_occid_sim(MAX(counter1-1,1))
                                    corr_occid_sim(counter1:t-1)=tempint
                                    tempint=occid_sim(MAX(counter1-1,1))
                                    occid_sim(counter1:t-1)=tempint

                                    ! ALLOW MEASUREMENT ERROR (Also miscoding from Gamma matrix)

                                    !IF(miscoding_estimation_ind==1 .OR. miscoding_parameter_ind==1 ) THEN
                                    !        ! if below cutoff of measurement error probability, record as a occupational change
                                    !        ! later can use jprobs for the entire miscoding transition matrix
                                    !        ! in net mobility world, miscoding is "within superoccupation" miscoding
                                    !        CALL RANDOM_NUMBER(tempreal)
                                    !        IF(tempreal<miscoding_estimation) THEN
                                    !            occmob_ind(counter1:t-1)=1
                                    !            occmob_ind(t)=3                      ! used to assign occ mobility in the last unemployment spell to employment spell
                                    !        END IF
                                    !END IF



                                    IF(exo_gamma_misc_within_superocc_ind==1 .OR. (gamma_misc_within_superocc>0.0 .AND. gamma_misc_within_superocc<1.0)) THEN
                                            ! If earlier employment was (mis)coded across superoccs such that they appear different
                                            IF(occid_sim(t-1) .ne. occid_sim(t)) THEN
                                                occmob_ind(counter1:t-1)=1
                                                occmob_ind(t)=3                      ! used to assign occ mobility in the last unemployment spell to employment spell
                                            END IF
                                            ! in net mobility world, miscoding is "within superoccupation" miscoding
                                            CALL RANDOM_NUMBER(tempreal)
                                            IF(tempreal<2.0*gamma_misc_within_superocc) THEN
                                                occmob_ind(counter1:t-1)=1
                                                occmob_ind(t)=3                      ! used to assign occ mobility in the last unemployment spell to employment spell
                                            END IF
                                    END IF

                                ! -----DIFFERENT OCCUPATION-----
                                ELSE IF (hcind_sim(t-1)==0) THEN  ! different occupation
                                    occmob_ind(counter1:t-1)=1
                                    occmob_ind(t)=3                      ! used to assign occ mobility in the last unemployment spell to employment spell
                                    corr_occmob_ind(counter1:t-1)=1
                                    corr_occmob_ind(t)=3                      ! used to assign occ mobility in the last unemployment spell to employment spell

                                    !! RE_DEFINE OCCID_SIM AND CORR_OCCID_SIM TO CAPTURE LAST EMPLOYMENT COMPARED TO CURRENT EMPLOYMENT
                                    tempint=corr_occid_sim(MAX(counter1-1,1))
                                    corr_occid_sim(counter1:t-1)=tempint
                                    tempint=occid_sim(MAX(counter1-1,1))
                                    occid_sim(counter1:t-1)=tempint

                                ELSE IF (hcind_sim(t-1)<0) THEN
                                    occmob_ind(counter1:t-1)=-1            ! do nothing because the guy changed
                                    corr_occmob_ind(counter1:t-1)=-1            ! do nothing because the guy changed
                                ELSE
                                    occmob_ind(t)=0
                                    corr_occmob_ind(t)=0
                                END IF
                                counter1=t+1
                                EXIT timeforward_do
                            END IF

                            IF (t==tswindow_wks_max-1) THEN
                                counter1=t              ! end the whole procedure
                            END IF



                        END DO timeforward_do
                    !****************

    ELSE IF(e_sim(MAX(counter1,1))==1 .AND. e_sim(MAX(counter1-1,1))==1 .AND. counter1<tswindow_wks_max-72) THEN
    ! continues employed, keep moving forward
        occmob_ind(MAX(counter1,1))=occmob_ind(MAX(counter1-1,1))
        corr_occmob_ind(MAX(counter1,1))=corr_occmob_ind(MAX(counter1-1,1))
        counter1=counter1+1
    ELSE
    ! unemployed but without previous occupation
        counter1=counter1+1
        occmob_ind(counter1-1)=0
        corr_occmob_ind(MAX(counter1,1))=0
    END IF cocc_loop_within_window_if


END DO cocc_loop

tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
tswindow_wks_min=tswindow_wks_min+tmax_swindow_wks_raw
counter1=tswindow_wks_min+1         ! +2

END DO cocc_superwindow_loop



    IF((i/1000)*1000==i) THEN
                tempint2=sum(e_sim)
                IF(verboseswitch==1 .AND. verbosesimulation==1) WRITE(*,*) 'simulations sum e_sim', tempint2
    END IF

! CHECK ASSIGNMENT OF OCCUPATIONS
    !WRITE(10,FMT='(A3, A2,I6,A4,I2,A4,I1,A4,I3,A4,I1, A7,I1, A5, I1,A7,I1,A7,I1)') 'v,','t=', t, ', p=',aggprod_ind(t),', x=', hcind_sim(t),', z=', island_sim(t-1), &
    !                                        ', o=', corr_occid_sim(t), &
    !WRITE(10,FMT='(I3,A3, I8, A3, I4, A3, I3,A3, I4,A3, I5,A3, I5,A3, I5,A3, I5,A3,I5, A3)')&
    !WRITE(10,FMT='(A3,A3, A8, A3, A4, A3, A3,A3, A4,A3, A5,A3, A5,A3, A5,A3, I5,A3,I5, A3)') &
    !               'vs ',' , ', &
    !                    'week', ' , ',&
    !                             'aggp',' , ', &
    !                                     'hc ', ' , ' , &
    !                                            'zind', ' , ', &
    !                                                   'cor_o', ' , ', &
    !                                                          'oo_lw', ' , ', &
    !                                                                 'obs_o', ' , ', &
    !                                                                        'reall', ' , ', &
    !                                                                            'sep', ' , '
    !

IF(write_netmob_simul_test_ind==1 .AND. i==1 ) THEN
        DO t=(tmax_sim2*8)/10, tmax_sim2

                WRITE(10,FMT='(I3,A3, I8, A3, I4, A3, I4, A3, I3,A3, I4,A3, I5,A3, I5,A3, I5,A3, I5,A3,I5, A3)') &
                        2,' , ', t, ' , ', age_sim(t),' , ', aggprod_ind(t),' , ', hcind_sim(t),' , ', island_sim(t-1),' , ', corr_occid_sim(t), &
                    ' , ', corr_occid_sim(t-1),' , ', occid_sim(t), &
                    ' , ', poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1)), &
                    ' , ', poliDW_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1),island_sim(t-1))
    !IF(t==tswindow_wks_max-1) WRITE(10,*) '-----------------------------------------------------'
        END DO
END IF


!==================================
!  ADD OBSERVATIONS FOR TIME SERIES, taking into account time aggregation, pay attention to coding of monthly employment status
!===================================


    !========================================
    ! NOTIONS TO KEEP IN MIND
    !
    ! *Create employment, unemployment and non-particpation indicators
    ! EMPLOYMENT
    !        !*Based on rmesr= monthly labour force indicator
    !        !gen byte empl = 0
    !        !replace empl = 1 if rmesr==1 | rmesr==2 | rmesr==3 | rmesr==4 | rmesr==5
    !        !*1 With a job entire month, worked all weeks.
    !        !*2 With a job all month, absent from work w/out pay 1+ weeks, absence not due to layoff
    !        !*3 With job all month, absent from work w/out pay 1+ weeks, absence due to layoff
    !       !*4 With a job at least 1 but not all weeks, no time on layoff and no time looking for work
    !        !*5 With job at least 1 but not all weeks, some weeks on layoff or looking for work
    ! UNEMPLOYMENT PERSISTENT BREAKAGE OF LINK, NEED AT LEAST 4 WEEKS OF UNEMPLOYMENT AT TIME OF MEASUREMENT
    !
    !
    !===================================================================


 prev_empl_ind=0
 unempdur_estatus=-2
tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw
counter1=tswindow_wks_min+1

                !DO tcnt=MAX((tmin_sim2/12)*12,1), tmax_sim2-60, 12       ! increase in 3month increments, for quarterly timeseries
                 !   DO t=tcnt, tcnt+8, 4                                        !  for each month in a quarter....

DO tcnt=8, tmax_sim2-12, 12       ! increase in 3month increments, for quarterly timeseries. NO reason to restrict the window at the END?
DO t=tcnt, tcnt+8, 4                                        !  for each month in a quarter....

    !==============================
    ! MONTHLY EMPLOYMENT STATUS
    !==============================
    !
    ! unempdur_estatus integer variable: MONTHLY aggregate
    ! -1 if agent is just born in the month
    !  0 if employed (employed, if employed at some point in the month)
    !  1+ unemployed, duration

    !! four weeks comparison
    !IF(hcind_sim(t)<0 .OR. hcind_sim(t-3)<0 .OR. hcind_sim(t-2)<0 .OR. hcind_sim(t-1)<0) unempdur_estatus(t/4)=-1
    !IF((unempdur_estatus(t/4) .NE. -1) .AND. (e_sim(t)==1 .OR. e_sim(t-1)==1 .OR. e_sim(t-2)==1 .OR. e_sim(t-3)==1)) unempdur_estatus(t/4)=0
    !! EMPLOYED AS WELL IF CODED EMPLOYED LAST MONTH, AND STILL SOME EMPLOYMENT IN THE LAST FOUR WEEKS (now do not need to separately adjust that, with week 2 coding of E status, yes)
    !    !(...)
    !! UNEMPLOYED, IF ALL WEEKS OF THE MONTH UNEMPLOYED
    !IF((unempdur_estatus(t/4) .NE. -1) .AND. (e_sim(t)==0 .AND. e_sim(t-1)==0 .AND. e_sim(t-2)==0 .AND. e_sim(t-3)==0)) unempdur_estatus(t/4)=1
    !! add duration
    !IF(t>8 .AND. unempdur_estatus(t/4)==1 .AND. unempdur_estatus((t/4)-1)>=1) unempdur_estatus(t/4)=unempdur_estatus((t/4)-1)+1
    !

    ! full month comparison, week 2 measurement, and unemployed if previously out of job for more than a month

    ! NO EMPLOYMENT BEFORE
    IF(hcind_sim(t)<0 .OR. hcind_sim(t-3)<0 .OR. hcind_sim(t-2)<0 .OR. hcind_sim(t-1)<0) unempdur_estatus(t/4)=-1

    ! EMPLOYED
    IF((unempdur_estatus(t/4) .NE. -1 ) .AND. (e_sim(t-1)==1 .OR. e_sim(t)==1 .OR. e_sim(t+1)==1 .OR. e_sim(t+2)==1) &
            .AND. t<=tswindow_wks_max-2) unempdur_estatus(t/4)=0
    ! Also employed still when within 3 weeks of employment before
    IF((unempdur_estatus(t/4) .NE. -1) .AND. (e_sim(t-3)==1 .OR. e_sim(t-2)==1 .OR. e_sim(t-1)==1) .AND. t<=tswindow_wks_max-2) &
            unempdur_estatus(t/4)=0

    ! UNEMPLOYED, IF ALL WEEKS OF THE MONTH UNEMPLOYED, AND IF UNEMPLOYED BEFORE UP TO A MONTH
    IF((unempdur_estatus(t/4) .NE. -1) .AND. (e_sim(t)==0 .AND. e_sim(t-1)==0 .AND. e_sim(t-2)==0 .AND. e_sim(t-3)==0) &
                .AND. e_sim(t+1)==0 .AND. e_sim(t+2)==0 .AND. t<=tswindow_wks_max-2) unempdur_estatus(t/4)=1


    ! add duration, pay attention to superwindow changes
    IF(t>8 .AND. unempdur_estatus(t/4)==1 .AND. unempdur_estatus((t/4)-1)>=1 &
        .AND. t>tswindow_wks_max-tmax_swindow_wks_raw+4)   THEN
        unempdur_estatus(t/4)=unempdur_estatus((t/4)-1)+1
    END IF

    ! CHECK SUPERWINDOW
    IF(t>=tswindow_wks_max .AND. t<tswindow_wks_max+4) THEN
        tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
    END IF

END DO
END DO


!=====================================================================
!  CREATE THE TIME SERIES
!====================================================================

tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw



    !-------------------------------------
    ! fill in the time series
    !-------------------------------------


quarter_do_1: &
DO tcnt=tmin_sim2+4, tmax_sim2-12, 12       ! increase in 3month increments, for quarterly timeseries
month_do_1: &
DO t=tcnt, tcnt+8, 4                                        !  for each month in a quarter....

    counter1=MAX(((t-tmin_sim2)/12),1)

      ! CHECK SUPERWINDOW
    IF(t>tswindow_wks_max .AND. t<=tswindow_wks_max+4) THEN
        tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
        tswindow_wks_min=tswindow_wks_min+tmax_swindow_wks_raw
    END IF

    ! end of superwindow, look at the distribution
    IF(t>=tswindow_wks_max-4 .AND. t<=tswindow_wks_max-1 .AND. corr_occid_sim(t)>0 .AND. corr_occid_sim(t)<=occpts) THEN
            occdistr_end_v2(corr_occid_sim(t))=occdistr_end_v2(corr_occid_sim(t))+1.0
    END IF


    ! age structure
    IF(age_sim(t)<youngcutoff .AND. age_sim(t)>1) data_young_qtr(counter1)=data_young_qtr(counter1)+1.0_8
    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_prime_qtr(counter1)=data_prime_qtr(counter1)+1.0_8


    !===================
    ! previous employment indicator
    IF (e_sim(t)==1 .OR. e_sim(t-1)==1 .OR. e_sim(t-2)==1 .OR. e_sim(t-3)==1) prev_empl_ind=1
    IF (hcind_sim(t)<0 .OR. hcind_sim(t-3)<0 .OR. hcind_sim(t-2)<0 .OR. hcind_sim(t-1)<0) prev_empl_ind=0

    IF(t>tmin_sim2 ) THEN
        !IF(e_sim(t)==0) uallp_distribution_sim(aggprod_ind(t))=uallp_distribution_sim(aggprod_ind(t))+1.0_8
        IF(e_sim(t)==1) eallp_distribution_sim(aggprod_ind(t))=eallp_distribution_sim(aggprod_ind(t))+1.0_8
    END IF


    !===================================
    ! in employment (NEW ACCOUNTING):
    !IF((e_sim(t)==1 .OR. e_sim(t-3)==1 .OR. e_sim(t-2)==1 .OR. e_sim(t-1)==1)  .AND. age_sim(t)>=4) THEN
    IF(unempdur_estatus(t/4)==0) THEN
       data_e_qtr(counter1)=data_e_qtr(counter1)+1.0_8
       ep_distribution_sim(aggprod_ind(t))=ep_distribution_sim(aggprod_ind(t))+1.0_8
                    IF(age_sim(t)<youngcutoff .AND. age_sim(t)>1) data_e_young_qtr(counter1)=data_e_young_qtr(counter1)+1.0_8
                    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_e_prime_qtr(counter1)=data_e_prime_qtr(counter1)+1.0_8

            IF(occid_sim(t)>0 .AND. occid_sim(t)<=occpts) THEN
                data_supocc_e_qtr(occid_sim(t), counter1)=data_supocc_e_qtr(occid_sim(t), counter1)+1.0
            END IF
    END IF

    ! separations (make sure that the worker is at least one full month unemployed, before counted -- coming from a month in which he had at least one week of employment!)
    IF(unempdur_estatus((t/4))==0 .AND. unempdur_estatus((t+4)/4)==1 .AND. hcind_sim(t+4)>=0) THEN         ! make sure of survival (implied twice here)
            data_sep_qtr(counter1)=data_sep_qtr(counter1)+1.0_8
            IF(age_sim(t)<youngcutoff)                              data_sep_y_qtr(counter1)=data_sep_y_qtr(counter1)+1.0_8
            IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff)    data_sep_p_qtr(counter1)=data_sep_p_qtr(counter1)+1.0_8

            IF(occid_sim(t)>0 .AND. occid_sim(t)<=occpts) THEN
                data_supocc_sep_qtr(occid_sim(t), counter1)=data_supocc_sep_qtr(occid_sim(t), counter1)+1.0
            END IF
    END IF


    !================
    ! unemployment
    !IF(e_sim(t)==0 .AND. age_sim(t)>5 .AND. ((e_sim(t-3)==0 .AND. e_sim(t-2)==0 .AND. e_sim(t-1)==0) )) THEN

    !! ALL UNEMPLOYED, INCL. ENTRANTS
    IF(unempdur_estatus(t/4)>0 .OR. unempdur_estatus(t/4)<0) THEN
                    data_uall_qtr(counter1)=data_uall_qtr(counter1)+1.0_8
                    !IF(age_sim(t)<youngcutoff .AND. age_sim(t)>1) data_uall_young_qtr(counter1)=data_uall_young_qtr(counter1)+1.0_8
                    !IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_uall_prime_qtr(counter1)=data_uall_prime_qtr(counter1)+1.0_8

                    ! second way of calculating the job finding rate
                    !jf_ave2_counter=jf_ave2_counter+1
                    !IF(unempdur_estatus((t+4)/4)==0) jf_ave2=jf_ave2+1.0_8

    END IF

    !! PREVIOUSLY EMPLOYED BEFORE
    IF(unempdur_estatus(t/4)>0) THEN
                    data_u_qtr(counter1)=data_u_qtr(counter1)+1.0_8
                    IF(age_sim(t)<youngcutoff .AND. age_sim(t)>1) data_u_young_qtr(counter1)=data_u_young_qtr(counter1)+1.0_8
                    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_u_prime_qtr(counter1)=data_u_prime_qtr(counter1)+1.0_8

                    IF(occid_sim(t)>0 .AND. occid_sim(t)<=occpts) THEN
                        data_supocc_u_qtr(occid_sim(t), counter1)=data_supocc_u_qtr(occid_sim(t), counter1)+1.0
                    END IF


                    ! second way of calculating the job finding rate
                    jf_ave2_counter=jf_ave2_counter+1
                    IF(unempdur_estatus((t+4)/4)==0) jf_ave2=jf_ave2+1.0_8

    END IF

    ! job finding rate from unemployment (non-entrants)
    IF(unempdur_estatus(t/4)>0 .AND. unempdur_estatus((t+4)/4)==0) THEN
                    data_jf_qtr(counter1)=data_jf_qtr(counter1)+1.0_8

                    IF(age_sim(t)<youngcutoff) THEN
                        data_jf_young_qtr(counter1)=data_jf_young_qtr(counter1)+1.0_8
                    END IF
                    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                        data_jf_prime_qtr(counter1)=data_jf_prime_qtr(counter1)+1.0_8
                    END IF

    END IF

    ! direct method of calculating the unemployment hazards
    IF(t<tmax_sim2-40) THEN
    IF(unempdur_estatus(t/4)>0 .AND. unempdur_estatus(t/4)<=24 .AND. age_sim(t)==age_sim(t+4)-4 ) THEN
                    tot_haz_durationmatrix2(unempdur_estatus(t/4),2)=tot_haz_durationmatrix2(unempdur_estatus(t/4),2)+1.0_8
                    IF (unempdur_estatus((t+4)/4)==0) THEN
                        tot_haz_durationmatrix2(unempdur_estatus(t/4),1)=tot_haz_durationmatrix2(unempdur_estatus(t/4),1)+1.0_8
                    END IF
    END IF
    END IF

    ! direct method of calculating the unemployment survival at inflow, for those that survive at least 32 months when flowing into unemployment
    IF (t<tmax_sim2-130) THEN
    IF(unempdur_estatus((t/4))==0 .AND. unempdur_estatus((t+4)/4)==1 .AND. age_sim(t+128)==age_sim(t)+128 ) THEN
        DO zcnt=1,24
            IF(unempdur_estatus((t+(zcnt*4))/4)==zcnt) THEN
                tot_durationmatrix2(zcnt)=tot_durationmatrix2(zcnt)+1.0_8
            END IF
        END DO
    END IF
    END IF


    ! SINCE data_u_qtr+data_e_qtr covers all workers, apart from birth/retirement, adding them up, should give the entire working population.

    !=================================
    ! unemployment of those who had a job before, not including when unemployed for less than a month
            ! global wavecond " & interview_no2>14 & wave>4 & sample_timetogo>=0"
            ! global sumstats_jf_addcondition " ((unempl_ctv[_n-1]==1 | outlf_ctv[_n-1]==1)  & personkey==personkey[_n-1] & yearmonth==yearmonth[_n-1]+1)  & durdistr_stability==1 & n_spellength[_n-1]<=18 & n_spellength>=1 & (complete_nunspell==1 | incomplete_nunspell==1) "
            ! global ts_u_addcondition " (unempl_ctv==1 | empl_ctv==1) & durdistr_stability==1 ${wavecond} & earlier_empl==1"

        ! we take this as requiring employment within the last 14-46 months, given concavity, approx. on average the last 18 months
    IF(unempdur_estatus(t/4)>0 .AND. prev_empl_ind==1 .AND. duration_sim(t)<=72) THEN
                    data_uadj18m_qtr(counter1)=data_uadj18m_qtr(counter1)+1.0_8
                    IF(age_sim(t)<youngcutoff .AND. age_sim(t)>1) data_uadj18m_young_qtr(counter1)=data_uadj18m_young_qtr(counter1)+1.0_8
                    IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_uadj18m_prime_qtr(counter1)=data_uadj18m_prime_qtr(counter1)+1.0_8
    END IF



    !=======================================
    ! unemployment duration; CPS weekly, use everyone, including those just separated
    IF(e_sim(t)==0 .AND. duration_sim(t)<5) THEN
        data_ult5wk_qtr(counter1)=data_ult5wk_qtr(counter1)+1.0_8
    ELSE IF(e_sim(t)==0 .AND. duration_sim(t)<15) THEN
        data_u5lt15wk_qtr(counter1)=data_u5lt15wk_qtr(counter1)+1.0_8
    ELSE IF(e_sim(t)==0 .AND. duration_sim(t)<27) THEN
        data_u15lt27wk_qtr(counter1)=data_u15lt27wk_qtr(counter1)+1.0_8
    ELSE IF(e_sim(t)==0 .AND. duration_sim(t)>=27) THEN
        data_ugt27wk_qtr(counter1)=data_ugt27wk_qtr(counter1)+1.0_8
    END IF

    !================================
    ! unemployment duration (on-going)
    IF(e_sim(t)==0 .AND. unempdur_estatus(t/4)>=1 .AND. unempdur_estatus(t/4)<=2) THEN
        data_ult3m_qtr(counter1)=data_ult3m_qtr(counter1)+1.0_8
        IF(age_sim(t)<youngcutoff) data_ult3m_yng_qtr(counter1)=data_ult3m_yng_qtr(counter1)+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 data_ult3m_prm_qtr(counter1)=data_ult3m_prm_qtr(counter1)+1.0_8
    END IF
    IF(e_sim(t)==0 .AND. unempdur_estatus(t/4)>=1 .AND. unempdur_estatus(t/4)<=4) THEN
        data_ult5m_qtr(counter1)=data_ult5m_qtr(counter1)+1.0_8
        IF(age_sim(t)<youngcutoff) data_ult5m_yng_qtr(counter1)=data_ult5m_yng_qtr(counter1)+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 data_ult5m_prm_qtr(counter1)=data_ult5m_prm_qtr(counter1)+1.0_8
    END IF
    IF(e_sim(t)==0 .AND. unempdur_estatus(t/4)>=5 .AND. unempdur_estatus(t/4)<=8) THEN
        data_ult9m_qtr(counter1)=data_ult9m_qtr(counter1)+1.0_8
        IF(age_sim(t)<youngcutoff) data_ult9m_yng_qtr(counter1)=data_ult9m_yng_qtr(counter1)+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 data_ult9m_prm_qtr(counter1)=data_ult9m_prm_qtr(counter1)+1.0_8
    END IF

    IF(e_sim(t)==0 .AND. unempdur_estatus(t/4)>=9 .AND. unempdur_estatus(t/4)<=12) THEN
        data_ult13m_qtr(counter1)=data_ult13m_qtr(counter1)+1.0_8
        IF(age_sim(t)<youngcutoff) data_ult13m_yng_qtr(counter1)=data_ult13m_yng_qtr(counter1)+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 data_ult13m_prm_qtr(counter1)=data_ult13m_prm_qtr(counter1)+1.0_8
    END IF

    IF(e_sim(t)==0 .AND. unempdur_estatus(t/4)>=13 .AND. unempdur_estatus(t/4)<=18) THEN
        data_ugt13m_qtr(counter1)=data_ugt13m_qtr(counter1)+1.0_8
        IF(age_sim(t)<youngcutoff) data_ugt13m_yng_qtr(counter1)=data_ugt13m_yng_qtr(counter1)+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 data_ugt13m_prm_qtr(counter1)=data_ugt13m_prm_qtr(counter1)+1.0_8
    END IF

    IF(t>tmin_sim2) THEN
        IF(e_sim(t)==0) uallp_distribution_sim(aggprod_ind(t))=uallp_distribution_sim(aggprod_ind(t))+1.0_8
        !IF(e_sim(t)==1) eallp_distribution_sim(aggprod_ind(t))=eallp_distribution_sim(aggprod_ind(t))+1.0_8
    END IF
    ! for unemployment distribution: aggregate productivity
    IF(unempdur_estatus(t/4)>=1) THEN

        up_distribution_sim(aggprod_ind(t))=up_distribution_sim(aggprod_ind(t))+1.0_8
            IF(age_sim(t)<youngcutoff) up_young_distribution_sim(aggprod_ind(t))=up_young_distribution_sim(aggprod_ind(t))+1.0_8
            IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                                 up_prime_distribution_sim(aggprod_ind(t))=up_prime_distribution_sim(aggprod_ind(t))+1.0_8


        !! REALLOCATION DIVISION (NO REALL: REST OR SEARCH)
        IF (poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t)) == 1) THEN

            IF (jf_Occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))>0.00001_8) THEN
                up_search_distribution_sim(aggprod_ind(t))=up_search_distribution_sim(aggprod_ind(t))+1.0_8
                uop_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                IF(age_sim(t)<youngcutoff) THEN 
                    up_young_search_distribution_sim(aggprod_ind(t))=up_young_search_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_young_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_young_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN 
                    up_prime_search_distribution_sim(aggprod_ind(t))=up_prime_search_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_prime_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_prime_search_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                END IF 
            ELSE IF (jf_Occ(corr_occid_sim(t), aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t))<=0.00001_8) THEN
                up_rest_distribution_sim(aggprod_ind(t))=up_rest_distribution_sim(aggprod_ind(t))+1.0_8
                uop_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                IF(age_sim(t)<youngcutoff) THEN 
                    up_young_rest_distribution_sim(aggprod_ind(t))=up_young_rest_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_young_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_young_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    up_prime_rest_distribution_sim(aggprod_ind(t))=up_prime_rest_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_prime_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_prime_rest_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
                END IF 
            END IF

        !! REALLOCATION DIVISION (REALL: NO REST AND NO SEARCH)
        ELSE IF (poliR_Occ(corr_occid_sim(t), aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t))==0) THEN
            up_reall_distribution_sim(aggprod_ind(t))=up_reall_distribution_sim(aggprod_ind(t))+1.0_8
            uop_reall_distribution_sim(corr_occid_sim(t),aggprod_ind(t))=uop_reall_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
            IF(age_sim(t)<youngcutoff) THEN 
                    up_young_reall_distribution_sim(aggprod_ind(t))=up_young_reall_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_young_reall_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_young_reall_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
            ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    up_prime_reall_distribution_sim(aggprod_ind(t))=up_prime_reall_distribution_sim(aggprod_ind(t))+1.0_8
                    uop_prime_reall_distribution_sim(corr_occid_sim(t), aggprod_ind(t))=uop_prime_reall_distribution_sim(corr_occid_sim(t), aggprod_ind(t))+1.0_8
            END IF 
        END IF

    END IF



    ! for unemployment distribution: aggregate productivity, and island location
    IF(unempdur_estatus(t/4)>=1) THEN

                upz_distribution_sim(aggprod_ind(t), island_sim(t))=upz_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
                uopz_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))=uopz_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))+1.0_8
                
                IF(hcind_sim(t)>=1 .AND. hcind_sim(t)<=xpts) THEN
                    upz_x_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))=upz_x_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8
                    uopxz_distribution_sim(occid_sim(t), aggprod_ind(t), hcind_sim(t), island_sim(t))=uopxz_distribution_sim(occid_sim(t), aggprod_ind(t),  hcind_sim(t), island_sim(t))+1.0_8
                END IF 
                IF(age_sim(t)<youngcutoff) THEN
                    upz_young_distribution_sim(aggprod_ind(t), island_sim(t))=upz_young_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
                    uopz_young_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))=uopz_young_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))+1.0_8
                    IF(hcind_sim(t)>=1 .AND. hcind_sim(t)<=xpts) &
                        upz_x_young_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))=upz_x_young_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8

                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    upz_prime_distribution_sim(aggprod_ind(t), island_sim(t))=upz_prime_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
                    uopz_prime_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))=uopz_prime_distribution_sim(occid_sim(t), aggprod_ind(t), island_sim(t))+1.0_8
                    IF(hcind_sim(t)>=1 .AND. hcind_sim(t)<=xpts) &
                    upz_x_prime_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))=upz_x_prime_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8

                END IF
    END IF






    !vacancies (count all, including those for workers only 1 week unemployed)
    IF(e_sim(t)==0 .AND. nosearch_withvacancy_ind .ne. 1) data_v_qtr (counter1)=data_v_qtr(counter1)+ (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t)))**(1.0_8/eta)
    IF(e_sim(t)==0 .AND. nosearch_withvacancy_ind==1) data_v_qtr (counter1)=data_v_qtr(counter1)+ (jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t)))

    IF(e_sim(t)==0) tot_costofhires=tot_costofhires+k*(jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t)))**(1.0_8/eta)
    ! hires here use expected value ...
    !IF(e_sim(t)==0) tot_hires=tot_hires+(jf(aggprod_ind(t),MAX(hcind_sim(t),1),island_sim(t)))
    ! count as hires those actually hired for one month or more? NOW, even 1 week of work is a hire...
    IF(e_sim(t)==0 .AND. e_sim(t+1)==1) tot_hires=tot_hires+1.0_8


    !productivity and wages: COUNT EVERYONE
    IF(e_sim(t)==1) THEN
        data_prod_qtr(counter1)=data_prod_qtr(counter1)+ prod(aggprod_ind(t), hcind_sim(t), island_sim(t))
        data_wage_qtr(counter1)=data_wage_qtr(counter1)+ wage_sim(t)
        logwage_disp_all=logwage_disp_all+log(wage_sim(t))**2.0_8
        logwage_ave_all=logwage_disp_all+log(wage_sim(t))
        logwage_all_counter=logwage_all_counter+1
        ! high occ tenure
        IF(hcten_sim(t) >= 480 .AND. hcten_sim(t) <= 1920) THEN
        logwage_disp_highoccten=logwage_disp_highoccten+log(wage_sim(t))**2.0_8
        logwage_ave_highoccten=logwage_ave_highoccten+log(wage_sim(t))
        logwage_highoccten_counter=logwage_highoccten_counter+1
        ! newly hired wages, measured at moment worker is hired...
        END IF
    END IF


    ! for employment distribution: aggregate productivity, and island location
    IF(e_sim(t)==1) THEN
 
        epz_distribution_sim(aggprod_ind(t), island_sim(t))=epz_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
        eopz_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))=eopz_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))+1.0_8
        IF(hcind_sim(t)>=1 .AND. hcind_sim(t)<=xpts) THEN
                    eopxz_distribution_sim(occid_sim(t), aggprod_ind(t), hcind_sim(t), island_sim(t))=eopxz_distribution_sim(occid_sim(t), aggprod_ind(t),  hcind_sim(t), island_sim(t))+1.0_8
        END IF         
        IF(age_sim(t)<youngcutoff) &
                    epz_young_distribution_sim(aggprod_ind(t), island_sim(t))=epz_young_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
                    eopz_young_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))=eopz_young_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))+1.0_8
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                    epz_prime_distribution_sim(aggprod_ind(t), island_sim(t))=epz_prime_distribution_sim(aggprod_ind(t), island_sim(t))+1.0_8
                    eopz_prime_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))=eopz_prime_distribution_sim(occid_sim(t),aggprod_ind(t), island_sim(t))+1.0_8
        wagepz_distribution_sim(aggprod_ind(t), island_sim(t))=wagepz_distribution_sim(aggprod_ind(t), island_sim(t))+wage_sim(t)
        IF(age_sim(t)<youngcutoff) &
                    wagepz_young_distribution_sim(aggprod_ind(t), island_sim(t))=wagepz_young_distribution_sim(aggprod_ind(t), island_sim(t))+wage_sim(t)
        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                    wagepz_prime_distribution_sim(aggprod_ind(t), island_sim(t))=wagepz_prime_distribution_sim(aggprod_ind(t), island_sim(t))+wage_sim(t)

        IF(hcind_sim(t)>=1 .AND. hcind_sim(t)<=xpts) THEN
            epz_x_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))=epz_x_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8
            IF(age_sim(t)<youngcutoff) epz_x_young_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))=epz_x_young_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8
            IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) epz_x_prime_distribution_sim(aggprod_ind(t), hcind_sim(t),island_sim(t))=epz_x_prime_distribution_sim(aggprod_ind(t), hcind_sim(t), island_sim(t))+1.0_8

            IF (age_sim(t)>48 .AND. e_sim(MAX(1,t-48))==1) THEN

                IF(unempdur_estatus((t/4))==0) THEN
                epz_1yb4_x_distribution_sim(aggprod_ind(t), hcind_sim(MAX(1,t-48)), island_sim(MAX(1,t-48)))=epz_x_distribution_sim(aggprod_ind(t), hcind_sim(MAX(1,t-48)), island_sim(MAX(1,t-48)))+1.0_8
                    IF(unempdur_estatus((t+4)/4)==1 .AND. hcind_sim(t+4)>=0) THEN
                    sep_epz_1yb4_x_distribution_sim(aggprod_ind(t), hcind_sim(MAX(1,t-48)), island_sim(MAX(1,t-48)))=sep_epz_1yb4_x_distribution_sim(aggprod_ind(t), hcind_sim(MAX(1,t-48)), island_sim(MAX(1,t-48)))+1.0_8
                    END IF
                END IF

            END IF

        END IF
    END IF


    !!!!! REALLOCATION THROUGH UNEMPLOYMENT
    !!!!! --- REALLOCATION ASSIGNED STATISTICS

    censoring_window_if: &
    IF( unempdur_estatus(t/4)>=1 .AND. t>tswindow_wks_max-tmax_swindow_wks_raw+72 .AND. t<tswindow_wks_max-72 ) THEN

        ! cocc

        IF(occmob_ind(t)==1) data_cocc_qtr(counter1)=data_cocc_qtr(counter1)+1.0_8
        IF(occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) data_cocc_young_qtr(counter1)=data_cocc_young_qtr(counter1)+1.0_8
        IF(occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_cocc_prime_qtr(counter1)=data_cocc_prime_qtr(counter1)+1.0_8

        ! nocc
        IF(occmob_ind(t)==2) data_nocc_qtr(counter1)=data_nocc_qtr(counter1)+1.0_8
        IF(occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) data_nocc_young_qtr(counter1)=data_nocc_young_qtr(counter1)+1.0_8
        IF(occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_nocc_prime_qtr(counter1)=data_nocc_prime_qtr(counter1)+1.0_8

        ! pocc: job found from unemployment, with occupational change
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==1) THEN
                            data_pocc_qtr(counter1)=data_pocc_qtr(counter1)+1.0_8
                            ! MAYBE NEED TO IMPOSE MAX OBSERVATION (censoring in the SIPP! -- DONE NOT HERE BUT IN MLEV MEASURES BELOW)
                            !data_ucompldur_occ_qtr(counter1)=data_ucompldur_occ_qtr(counter1)+unempdur_estatus(t/4)

                            !! DISTRIBUTION OF COMPLETED SPELLS (used to calculate restricted)
                            IF(unempdur_estatus(t/4)<=18 .AND. unempdur_estatus(t/4)>0 ) THEN
                            data_ucompldur_occ_qtr(counter1)=data_ucompldur_occ_qtr(counter1)+unempdur_estatus(t/4)
                            data_compduration_cocc_qtr(counter1,unempdur_estatus(t/4))=data_compduration_cocc_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                            data_compduration_cocc(unempdur_estatus(t/4))=data_compduration_cocc(unempdur_estatus(t/4))+1.0_8
                                IF(age_sim(t)<youngcutoff) THEN
                                    data_compduration_cocc_young_qtr(counter1,unempdur_estatus(t/4))=data_compduration_cocc_young_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                                    data_compduration_cocc_young(unempdur_estatus(t/4))=data_compduration_cocc_young(unempdur_estatus(t/4))+1.0_8
                                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                                    data_compduration_cocc_prime_qtr(counter1,unempdur_estatus(t/4))=data_compduration_cocc_prime_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                                    data_compduration_cocc_prime(unempdur_estatus(t/4))=data_compduration_cocc_prime(unempdur_estatus(t/4))+1.0_8
                                END IF
                            END if
                IF(age_sim(t)<youngcutoff) THEN
                            data_pocc_young_qtr(counter1)=data_pocc_young_qtr(counter1)+1.0_8
                            data_ucompldur_young_occ_qtr(counter1)=data_ucompldur_young_occ_qtr(counter1)+unempdur_estatus(t/4)
                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                            data_pocc_prime_qtr(counter1)=data_pocc_prime_qtr(counter1)+1.0_8
                            data_ucompldur_prime_occ_qtr(counter1)=data_ucompldur_prime_occ_qtr(counter1)+unempdur_estatus(t/4)
                END IF
        END IF


        ! pnocc
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==2) THEN
                            data_pnocc_qtr(counter1)=data_pnocc_qtr(counter1)+1.0_8
                            !data_ucompldur_nocc_qtr(counter1)=data_ucompldur_nocc_qtr(counter1)+unempdur_estatus(t/4)

                            IF(unempdur_estatus(t/4)<=18 .AND. unempdur_estatus(t/4)>0 ) THEN
                            data_ucompldur_nocc_qtr(counter1)=data_ucompldur_nocc_qtr(counter1)+unempdur_estatus(t/4)
                            data_compduration_nocc_qtr(counter1,unempdur_estatus(t/4))=data_compduration_nocc_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                            data_compduration_nocc(unempdur_estatus(t/4))=data_compduration_nocc(unempdur_estatus(t/4))+1.0_8
                                IF(age_sim(t)<youngcutoff) THEN
                                    data_compduration_nocc_young_qtr(counter1,unempdur_estatus(t/4))=data_compduration_nocc_young_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                                    data_compduration_nocc_young(unempdur_estatus(t/4))=data_compduration_nocc_young(unempdur_estatus(t/4))+1.0_8
                                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                                    data_compduration_nocc_prime_qtr(counter1,unempdur_estatus(t/4))=data_compduration_nocc_prime_qtr(counter1,unempdur_estatus(t/4))+1.0_8
                                    data_compduration_nocc_prime(unempdur_estatus(t/4))=data_compduration_nocc_prime(unempdur_estatus(t/4))+1.0_8
                                END IF
                            END if

                IF(age_sim(t)<youngcutoff) THEN
                            data_pnocc_young_qtr(counter1)=data_pnocc_young_qtr(counter1)+1.0_8
                            data_ucompldur_young_nocc_qtr(counter1)=data_ucompldur_young_nocc_qtr(counter1)+unempdur_estatus(t/4)
                ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                            data_pnocc_prime_qtr(counter1)=data_pnocc_prime_qtr(counter1)+1.0_8
                            data_ucompldur_prime_nocc_qtr(counter1) =data_ucompldur_prime_nocc_qtr(counter1)+unempdur_estatus(t/4)
                END IF
        END IF
    END IF censoring_window_if


    IF( unempdur_estatus(t/4)>=1 .AND. t>tswindow_wks_max-tmax_swindow_wks_raw+4 .AND. t<tswindow_wks_max-72 ) THEN

        ! cocc INFLOW, measured at first moment of unemployment; take those who have at least two months of unemployment
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==1) data_cocc_inflow_qtr(counter1)=data_cocc_inflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) data_cocc_young_inflow_qtr(counter1)=data_cocc_young_inflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_cocc_prime_inflow_qtr(counter1)=data_cocc_prime_inflow_qtr(counter1)+1.0_8

        ! nocc
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==2) data_nocc_inflow_qtr(counter1)=data_nocc_inflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) data_nocc_young_inflow_qtr(counter1)=data_nocc_young_inflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t-4)/4)==0 .AND. occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_nocc_prime_inflow_qtr(counter1)=data_nocc_prime_inflow_qtr(counter1)+1.0_8

    END IF

    ! cocc OUTFLOW, measured at last moment of unemployment
    IF( unempdur_estatus(t/4)>=1 .AND. t>tswindow_wks_max-tmax_swindow_wks_raw+72 .AND. t<tswindow_wks_max-4 ) THEN

        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==1) data_cocc_outflow_qtr(counter1)=data_cocc_outflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) data_cocc_young_outflow_qtr(counter1)=data_cocc_young_outflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_cocc_prime_outflow_qtr(counter1)=data_cocc_prime_outflow_qtr(counter1)+1.0_8
    ! nocc
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==2) data_nocc_outflow_qtr(counter1)=data_nocc_outflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) data_nocc_young_outflow_qtr(counter1)=data_nocc_young_outflow_qtr(counter1)+1.0_8
        IF(unempdur_estatus((t+4)/4)==0 .AND. occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_nocc_prime_outflow_qtr(counter1)=data_nocc_prime_outflow_qtr(counter1)+1.0_8



    END IF

    !! TRANSITION MATRIX CALCULATION
    IF(unempdur_estatus(t/4)>=1 .AND. unempdur_estatus((t+4)/4)==0 .AND. unempdur_estatus((t-4)/4)>=0  &
                                            .AND. (occmob_ind(t)==1 .OR. occmob_ind(t)==2) .AND. &
                                                t>tswindow_wks_max-tmax_swindow_wks_raw+72 .AND. t<tswindow_wks_max-8 ) THEN
                ! FIND MOMENT OF EMPLOYMENT
                tcnt2=t
                DO WHILE (e_sim(tcnt2) .ne. 1)
                    tcnt2=tcnt2+1
                END DO

                IF(e_sim(tcnt2)==1 .AND. e_sim(t)==0 .AND. e_sim(tcnt2-1)==0 .AND. hcind_sim(tcnt2-1)>=0) THEN

                    ! transition matrix (Corr/uncorr): ONLY INCLUDE IF IN MASKED QUATERS
                    IF (mask_qtr(counter1)== .TRUE.) THEN
                    data_corr_superocc_transmatrix(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2))=&
                        data_corr_superocc_transmatrix(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2))+1.0
                    data_superocc_transmatrix(occid_sim(tcnt2-1), occid_sim(tcnt2))=&
                        data_superocc_transmatrix(occid_sim(tcnt2-1), occid_sim(tcnt2))+1.0
                    END IF 

                    IF(t>tswindow_wks_min-tmax_swindow_wks_raw+2 .AND. (t<tmin_sim2+no_superwindows*tmax_swindow_wks_raw )) THEN
                        
                        IF (t<tswindow_wks_min-tmax_swindow_endexitcounting) THEN 
                            ! entry into new occupation
                            occdistr_endo_entry_exit(occid_sim(tcnt2),1)=occdistr_endo_entry_exit(occid_sim(tcnt2),1)+1.0
                            corr_occdistr_endo_entry_exit(corr_occid_sim(tcnt2),1)=corr_occdistr_endo_entry_exit(corr_occid_sim(tcnt2),1)+1.0
                            ! exiting from old occupation
                            occdistr_endo_entry_exit(occid_sim(tcnt2-1),2)=occdistr_endo_entry_exit(occid_sim(tcnt2-1),2)+1.0
                            corr_occdistr_endo_entry_exit(corr_occid_sim(tcnt2-1),2)=corr_occdistr_endo_entry_exit(corr_occid_sim(tcnt2-1),2)+1.0
                        END IF 
                        
                        IF(counter1>0 .AND. counter1<=maxqtr_alloc .AND. mask_qtr(counter1)== .TRUE.) THEN
                            ! entering into a new occupation
                            corr_occdistr_endo_entry_exit_qtr(MAX(0,corr_occid_sim(tcnt2)),1,counter1)=corr_occdistr_endo_entry_exit_qtr(MAX(0,corr_occid_sim(tcnt2)),1,counter1)+1.0
                            occdistr_endo_entry_exit_qtr(MAX(0,occid_sim(tcnt2)),1,counter1)=occdistr_endo_entry_exit_qtr(MAX(0,occid_sim(tcnt2)),1,counter1)+1.0
                            ! exiting from old occupation
                            corr_occdistr_endo_entry_exit_qtr(MAX(0,corr_occid_sim(tcnt2-1)),2,counter1)=corr_occdistr_endo_entry_exit_qtr(MAX(0,corr_occid_sim(tcnt2-1)),2,counter1)+1.0
                            occdistr_endo_entry_exit_qtr(MAX(0,occid_sim(tcnt2-1)),2,counter1)=occdistr_endo_entry_exit_qtr(MAX(0,occid_sim(tcnt2-1)),2,counter1)+1.0
                        END IF
                    END IF

                    ! transition matrix with duration (corr/uncorr)
                    IF(unempdur_estatus(t/4)<=18 .AND. unempdur_estatus(t/4)>=1) THEN
                        data_corr_superocc_transmatrix_wdur(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2),MAX(unempdur_estatus(t/4),1))=&
                                data_corr_superocc_transmatrix_wdur(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2),MAX(unempdur_estatus(t/4),1))+1.0
                        data_superocc_transmatrix_wdur(occid_sim(tcnt2-1), occid_sim(tcnt2),MAX(unempdur_estatus(t/4),1))=&
                                data_superocc_transmatrix_wdur(occid_sim(tcnt2-1), occid_sim(tcnt2),MAX(unempdur_estatus(t/4),1))+1.0
                    END IF
                    
                    !!----------------------------
                    !! QUARTERLY SERIES
                    !!---------------------------                    
                    ! transition matrix (corr/uncorr) per QUARTER
                    data_corr_superocc_transmatrix_qtr(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2), counter1)=&
                            data_corr_superocc_transmatrix_qtr(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2), counter1)+1.0
                    data_superocc_transmatrix_qtr(occid_sim(tcnt2-1), occid_sim(tcnt2), counter1)=&
                            data_superocc_transmatrix_qtr(occid_sim(tcnt2-1), occid_sim(tcnt2), counter1)+1.0
                    ! u duration per occupation per quarter (<= 18?)
                    ! can place this above, under cocc outflow
                    IF(unempdur_estatus(t/4)<=18 .AND. unempdur_estatus(t/4)>=1) THEN
                        data_supocc_udur_qtr(occid_sim(tcnt2-1), counter1)=data_supocc_udur_qtr(occid_sim(tcnt2-1), counter1)+REAL(unempdur_estatus(t/4))
                        data_supocc_udur_counter_qtr(occid_sim(tcnt2-1), counter1)=data_supocc_udur_counter_qtr(occid_sim(tcnt2-1), counter1)+1
                        IF(occmob_ind(t)==1 .AND. (corr_occid_sim(tcnt2-1)==corr_occid_sim(tcnt2))) THEN
                            ! move wthin supergroup
                            mobility_prop_within_supocc(occid_sim(tcnt2-1),2)=mobility_prop_within_supocc(occid_sim(tcnt2-1),2)+1.0
                            corr_mobility_prop_within_supocc(corr_occid_sim(tcnt2-1),2)=corr_mobility_prop_within_supocc(corr_occid_sim(tcnt2-1),2)+1.0
                        ELSE IF (occmob_ind(t)==1 .AND. (occid_sim(tcnt2-1) .ne. occid_sim(tcnt2))) THEN
                            ! move outside of supergroup
                            mobility_prop_within_supocc(occid_sim(tcnt2-1),1)=mobility_prop_within_supocc(occid_sim(tcnt2-1),1)+1.0
                            corr_mobility_prop_within_supocc(corr_occid_sim(tcnt2-1),1)=corr_mobility_prop_within_supocc(corr_occid_sim(tcnt2-1),1)+1.0
                        END IF
                    END IF
            END IF

    END IF


    !---- subsequent reallocations as a function of previous unemployment spell
    !   ----  ADDRESSING CENSORING IN THE DATA (taking this into account in the computation) in the data we only see this for those people who have multiple unemployment spells within 4 years
    !   ----  if exogenous breakups are very rare, and a large proportion of measured breakups are endogenous, we have to reproduce these conditions in the program!!!
    !   ----  this means adding a condition that previous unemployment and employment spell, plus current unemployment spell fall with blocks of 180 weeks.
    !   ----  this condition is marked by <-----***** on the RHS margin below



    ! --- in DATA:
    !               * spells that complete in 18 months or less
    !               * measure at outflow moment
    !               * cumulative profile. consider at duration x, if completed duration y >= x, y<=18



    ! CPS duration distribution
     ! duration distribution
    unemp_dur_if: IF(e_sim(t)==0) THEN
    IF(duration_sim(t)>=0) THEN
    IF(e_sim(MAX(t-duration_sim(t)-4,1))==1) THEN          ! check uninterrupted unemployment spell


          ! FOR CPS DURATION DISTRIBUTION
          IF(duration_sim(t)>0 .AND. duration_sim(t)<5) ult5wk=ult5wk+1.0_8
          IF(duration_sim(t)>=5 .AND. duration_sim(t)<15) u5lt15wk=u5lt15wk+1.0_8
          IF(duration_sim(t)>=15 .AND. duration_sim(t)<27) u15lt27wk=u15lt27wk+1.0_8
          IF(duration_sim(t)>=27) ugt27wk=ugt27wk+1.0_8

                          !! first month at the 0 element of the tot_durationmatrices!!!!
                          !tot_durationmatrix(MIN((MAX(duration_sim(t),0)/4),24))=tot_durationmatrix(MIN((MAX(duration_sim(t),0)/4),24))+1.0_8
                          !IF(age_sim(t)<youngcutoff) THEN
                          !    tot_durationmatrix_young(MIN((MAX(duration_sim(t),0)/4),24))=tot_durationmatrix_young(MIN((MAX(duration_sim(t),0)/4),24))+1.0_8
                          !ELSE IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                          !    tot_durationmatrix_prime(MIN((MAX(duration_sim(t),0)/4),24))=tot_durationmatrix_prime(MIN((MAX(duration_sim(t),0)/4),24))+1.0_8
                          !END IF
                          !
                          !
                          !  ! DURATION PROFILE
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2) tot_durationmatrix_cocc(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_cocc(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !! test that the durationmatrix_cocc with duration<4 counts the same as cocc_inflow
                          !
                          !! DISTRIBUTION OVER TIME
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2 .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1)  data_totduration_cocc_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_cocc_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
                          !
                          !!IF(occmob_ind(t)==1 .AND. duration_sim(t)<4) data_temp_qtr(counter1)=data_temp_qtr(counter1)+1.0_8
                          !        ! conclusion: almost the same, sometimes a small difference.
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_cocc_young(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_cocc_young(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_cocc_prime(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_cocc_prime(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1) &
                          !      data_totduration_cocc_young_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_cocc_young_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
                          !IF(occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1) &
                          !      data_totduration_cocc_prime_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_cocc_prime_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
                          !
                          !! nocc
                          !IF(occmob_ind(t)==2  .AND. age_sim(t)<highcutoff2)  tot_durationmatrix_nocc(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_nocc(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !! test that the durationmatrix_cocc with duration<4 counts the same as cocc_inflow
                          !IF(occmob_ind(t)==2 .AND. age_sim(t)<highcutoff2 .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1)  data_totduration_nocc_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_nocc_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
                          !
                          !!IF(occmob_ind(t)==2 .AND. duration_sim(t)<4) data_temp_qtr2(counter1)=data_temp_qtr2(counter1)+1.0_8
                          !        ! conclusion: almost the same, sometimes a small difference.
                          !IF(occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_nocc_young(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_nocc_young(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !IF(occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_nocc_prime(MIN((duration_sim(t)-1)/4,24))=tot_durationmatrix_nocc_prime(MIN((duration_sim(t)-1)/4,24))+1.0_8
                          !
                          !IF(occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1) &
                          !      data_totduration_nocc_young_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_nocc_young_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
                          !IF(occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff .AND. e_sim(MIN(t+(60-duration_sim(t)),tmax_sim2-12))==1) &
                          !      data_totduration_nocc_prime_qtr(counter1,MIN((duration_sim(t)-1)/4,18))=data_totduration_nocc_prime_qtr(counter1,MIN((duration_sim(t)-1)/4,18))+1.0_8
    END IF
    END IF
    END IF unemp_dur_if


    !=============================
    ! OCCMOB U DURATION PROFILE

    occmob_dur_if: &
    IF( unempdur_estatus(t/4)>=1 .AND. t>tswindow_wks_max-tmax_swindow_wks_raw+72 .AND. t<tswindow_wks_max-72 ) THEN
            ! unemployment ongoing with enough window


    !!===================================
    !! COMPLETED SPELL DURATIONS  ---> IMPLIED SURVIVAL DISTRIBUTION
    !!===================================

    ! measured and assigned at moment of outflow into employment, as in the SIPP data
    u_outflow_next_period_1_if: &
        IF(unempdur_estatus((t+4)/4)==0) THEN               ! OUTFLOW IN THE NEXT PERIOD
                ! finding a job next month


        !---------------------
        ! ALL, spells up to 24 months distinguished; all spells included!
                    ! NOTE: this adds the survival to all previous spell durations
                    ! NOTE: for symmetry with SIPP, require that worker survives at least until 32 months after begin spell!

            DO tcnt2=1, MIN(unempdur_estatus(t/4),24)
                IF(age_sim(t)<highcutoff2) tot_durationmatrix(tcnt2)=tot_durationmatrix(tcnt2)+1.0_8
                IF(age_sim(t)<youngcutoff) tot_durationmatrix_young(tcnt2)=tot_durationmatrix_young(tcnt2)+1.0_8
                IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_prime(tcnt2)=tot_durationmatrix_prime(tcnt2)+1.0_8


                !! 32 MONTHS MEASURE. COMPLETE WITHIN 36

                IF(unempdur_estatus(t/4)<=40) THEN

                    IF (occmob_ind(t)==1) THEN
                        IF(age_sim(t)<highcutoff2) &
                            tot_durationmatrix2_cocc(tcnt2)=tot_durationmatrix2_cocc(tcnt2)+1.0
                        IF(age_sim(t)<youngcutoff) &
                             tot_durationmatrix2_cocc_young(tcnt2)=tot_durationmatrix2_cocc_young(tcnt2)+1.0
                        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                                tot_durationmatrix2_cocc_prime(tcnt2)=tot_durationmatrix2_cocc_prime(tcnt2)+1.0
                    ELSEIF (occmob_ind(t)==2) THEN
                        IF(age_sim(t)<highcutoff2) &
                            tot_durationmatrix2_nocc(tcnt2)=tot_durationmatrix2_nocc(tcnt2)+1.0
                        IF(age_sim(t)<youngcutoff) &
                            tot_durationmatrix2_nocc_young(tcnt2)=tot_durationmatrix2_nocc_young(tcnt2)+1.0
                        IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) &
                            tot_durationmatrix2_nocc_prime(tcnt2)=tot_durationmatrix2_nocc_prime(tcnt2)+1.0
                    END IF
                END IF

            END DO

          !---------------------
          ! OCCUPATIONAL MOVERS, only for completed spells <=18 !!!!
          !---------------------

          complete_within_18m_ifm: &
          IF(unempdur_estatus(t/4)>0 .AND. unempdur_estatus(t/4)<=18) THEN

          ! *******CUMULATIVE PROFILE********
           DO tcnt2=1, MIN(unempdur_estatus(t/4),18)

                  ! t is month before outflow from unemployment
                  ! tcnt2 = incomplete unemployment duration of spell ending at t
                  ! tempint3 = quarter in which incomplete duration tcnt2 is measured

                  ! THUS SURVIVAL OF ONLY THOSE

                  !======== OCCUPATIONAL MOBILITY WITH MISCODING

                  ! OVER THE ENTIRE SAMPLE
                  IF(occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2) tot_durationmatrix_cocc(tcnt2)=tot_durationmatrix_cocc(tcnt2)+1.0_8
                  IF(occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_cocc_young(tcnt2)=tot_durationmatrix_cocc_young(tcnt2)+1.0_8
                  IF(occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_cocc_prime(tcnt2)=tot_durationmatrix_cocc_prime(tcnt2)+1.0_8
                    ! stayers
                  IF(occmob_ind(t)==2 .AND. age_sim(t)<highcutoff2) tot_durationmatrix_nocc(tcnt2)=tot_durationmatrix_nocc(tcnt2)+1.0_8
                  IF(occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_nocc_young(tcnt2)=tot_durationmatrix_nocc_young(tcnt2)+1.0_8
                  IF(occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_nocc_prime(tcnt2)=tot_durationmatrix_nocc_prime(tcnt2)+1.0_8

                  ! DISTRIBUTION OVER TIME

                  ! if assigning that to quarter of incomplete duration
                  tempint3=counter1-(unempdur_estatus(t/4)-tcnt2)/3
                  ! if assigning to quarter of completion
                  !tempint3=counter1

                  IF(occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2)  data_totduration_cocc_qtr(tempint3,tcnt2)=data_totduration_cocc_qtr(tempint3,tcnt2)+1.0_8
                  IF(occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) data_totduration_cocc_young_qtr(tempint3,tcnt2)=data_totduration_cocc_young_qtr(tempint3,tcnt2)+1.0_8
                  IF(occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_totduration_cocc_prime_qtr(tempint3,tcnt2)=data_totduration_cocc_prime_qtr(tempint3,tcnt2)+1.0_8
                    ! stayers
                  IF(occmob_ind(t)==2 .AND. age_sim(t)<highcutoff2)  data_totduration_nocc_qtr(tempint3,tcnt2)=data_totduration_nocc_qtr(tempint3,tcnt2)+1.0_8
                  IF(occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) data_totduration_nocc_young_qtr(tempint3,tcnt2)=data_totduration_nocc_young_qtr(tempint3,tcnt2)+1.0_8
                  IF(occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_totduration_nocc_prime_qtr(tempint3,tcnt2)=data_totduration_nocc_prime_qtr(tempint3,tcnt2)+1.0_8


                  !======= CORRECT OCCUPATIONAL MOBILITY

                  ! OVER THE ENTIRE SAMPLE
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2) tot_durationmatrix_cr_cocc(tcnt2)=tot_durationmatrix_cr_cocc(tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_cr_cocc_young(tcnt2)=tot_durationmatrix_cr_cocc_young(tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_cr_cocc_prime(tcnt2)=tot_durationmatrix_cr_cocc_prime(tcnt2)+1.0_8
                    ! stayers
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)<highcutoff2) tot_durationmatrix_cr_nocc(tcnt2)=tot_durationmatrix_cr_nocc(tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) tot_durationmatrix_cr_nocc_young(tcnt2)=tot_durationmatrix_cr_nocc_young(tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) tot_durationmatrix_cr_nocc_prime(tcnt2)=tot_durationmatrix_cr_nocc_prime(tcnt2)+1.0_8

                  ! DISTRIBUTION OVER TIME
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)<highcutoff2)  data_totduration_cr_cocc_qtr(tempint3,tcnt2)=data_totduration_cr_cocc_qtr(tempint3,tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)<youngcutoff) data_totduration_cr_cocc_young_qtr(tempint3,tcnt2)=data_totduration_cr_cocc_young_qtr(tempint3,tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==1 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_totduration_cr_cocc_prime_qtr(tempint3,tcnt2)=data_totduration_cr_cocc_prime_qtr(tempint3,tcnt2)+1.0_8
                    ! stayers
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)<highcutoff2)  data_totduration_cr_nocc_qtr(tempint3,tcnt2)=data_totduration_cr_nocc_qtr(tempint3,tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)<youngcutoff) data_totduration_cr_nocc_young_qtr(tempint3,tcnt2)=data_totduration_cr_nocc_young_qtr(tempint3,tcnt2)+1.0_8
                  IF(corr_occmob_ind(t)==2 .AND. age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) data_totduration_cr_nocc_prime_qtr(tempint3,tcnt2)=data_totduration_cr_nocc_prime_qtr(tempint3,tcnt2)+1.0_8
           END DO
          END IF complete_within_18m_ifm

    END IF u_outflow_next_period_1_if
    END IF occmob_dur_if

END DO month_do_1!t month counter
END DO quarter_do_1 !t  quarter counter

tmax_qtr=((tmax_sim2-tmin_sim2)/tmax_swindow_wks_raw)*(tmax_swindow_wks_raw/12)
!! CHECK

IF(tmax_qtr < (no_superwindows*(tmax_swindow_wks_raw/12))) THEN
            WRITE(*,*) 'ERROR: TMAX_QTR AND no_superwindows not aligned, tmax_qtr too low'
ELSEIF(tmax_qtr > (no_superwindows*(tmax_swindow_wks_raw/12))) THEN
            WRITE(*,*) 'WARNING: TMAX_QTR larger implied by no_superwindows'
END IF

!!!=================================================
!!!------------------------------------------------
!!! SIPP PSEUDO-WINDOWS, FOR REPEAT MOBILITY, REPEAT SEPARATIONS, AND UNEMPLOYMENT PROPORTION!
!!!------------------------------------------------
!!!=================================================

!!! the program should institute exactly the same conditions as the .do file with the original data
!!! this means that we are dealing with 3.5 or 4 year windows (average of panel length)
!!! AND WE NEED TO INSTITUTE A SAMPLE-TIME TO GO CONDITIONS, OR A IN PANEL THE WHOLE TIME CONDITION... (the current option)
!!! and we make sure we are not measuring across different people


counter1=tmin_sim2+4
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw

!== window length --> tempint               !WINDOW LENGTH
tempint=188  !=4 years (minus one month)

!!========= SIPP WINDOW GENERATION --- DIFFERENT WINDOWS
sipp_window_do1: &
DO WHILE (tswindow_wks_max<=tmax_sim2)
DO WHILE (counter1<tswindow_wks_max-tempint)

!! survival within panel
flag_windowsurvival=0
IF((age_sim(counter1)==age_sim(counter1+tempint-1)-(tempint-1)) .AND. (age_sim(counter1)>1)) THEN
    flag_windowsurvival=1
END IF


!!>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 1. STEP INSIDE WINDOW:<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

!! INITIALIZATION/INITIAL OBS
u_flag=0
e_flag=0
tempcounter=0  !! USED TO COUNT UNEMPLOYMENT SPELLS WITHIN WINDOW
repeatmobspells_matrix=0

IF (unempdur_estatus(counter1/4)==0 .AND. age_sim(counter1)==age_sim(counter1+144)-144) THEN
    counter_u_window_all=counter_u_window_all+1
    IF(age_sim(counter1)<youngcutoff) counter_u_window_all_y=counter_u_window_all_y+1
    IF(age_sim(counter1)>lowcutoff .AND. age_sim(counter1)<highcutoff) counter_u_window_all_p=counter_u_window_all_p+1
    u_flag=1
END IF

! SURVIVAL WITHIN THE PSEUDO SIPP PANEL: NEED TO CHANGE THIS!!!!
!IF(age_sim(counter1)==age_sim(counter1+tempint)-tempint) THEN


!!>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 2. MOVE WITHIN WINDOW:<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<


!********************
! ENTER WINDOW: t , t+4, t+8 , t+12, t+16,.... counts forwards months 1,2,3,4,5,...
!***********************
inside_pseudo_sipp_window_do: &
DO t=counter1, counter1+tempint, 4

    ! set earlier_employment flag
    IF(unempdur_estatus(t/4)==0) e_flag=1
    IF(unempdur_estatus(t/4)<0) e_flag=0

    !=============================
    !--  REPEAT SEPARATIONS:
    !================================
        !               complete entire spell of 2-10 months, come back in the same occupation, stay in sample for the next 2.5 year (100 weeks) = 0
        !               lose job and find it again, change occupation, change 0 into 1

    repeat_sep_if: &
    IF (t>=counter1+8 .AND. t<=counter1+48 .AND. (unempdur_estatus(t/4)==0) &
                .AND. (unempdur_estatus((t-4)/4)>=2 .AND. unempdur_estatus((t-4)/4)<=10) &
                .AND. occmob_ind(t-4)==2 .AND. age_sim(t)==age_sim(MIN(t+120,tmax_sim2))-120 &
                .AND. age_sim(counter1)==age_sim(t)-t+counter1                    ) THEN

                                    ! eligible case, at moment of job finding;
                                    ! was in sample, at the beginning of panel,
                                    ! will stay in sample for 2.5 year or more


                                        ! Now, have to check two things:
                                        ! i. this person will stay in sample for the next 2.5 yr, i.e. 120 weeks
                                        ! ii. this person will, in fact, go through unemployment again

                sepocc_afternocc_2_5yr_counter=sepocc_afternocc_2_5yr_counter + 1
                sepnocc_afternocc_2_5yr_counter=sepnocc_afternocc_2_5yr_counter + 1
                sep_afternocc_2_5yr_counter=sep_afternocc_2_5yr_counter + 1

                repeat_sep_u_search_do: &
                DO tcnt=t+4, (t+116), 4

                    IF (hcind_sim(tcnt)<0) THEN
                                ! ineligible window, subtract one from the number of eligible spells, since it was added before
                                sepocc_afternocc_2_5yr_counter=sepocc_afternocc_2_5yr_counter - 1
                                sepnocc_afternocc_2_5yr_counter=sepnocc_afternocc_2_5yr_counter - 1
                                sep_afternocc_2_5yr_counter=sep_afternocc_2_5yr_counter - 1
                                EXIT repeat_sep_u_search_do

                    ELSE IF ((unempdur_estatus(tcnt/4)==0) .AND. &
                                unempdur_estatus((tcnt+4)/4)>=1) THEN
                             ! NEW SEPARATION post-job finding, within panel
                                sep_afternocc_2_5yr=sep_afternocc_2_5yr + 1.0_8

                                    ! make sure it this spell completes within the pseudo-panel
                                    compl_occ_sep_within_pspanel: &
                                    DO tcnt2=tcnt+8, t+120, 4
                                        IF (unempdur_estatus((tcnt2)/4)==0 .AND. unempdur_estatus((tcnt2-4)/4)>=1) THEN

                                            IF (occmob_ind(tcnt2-4)==1  )  THEN
                                                sepocc_afternocc_2_5yr=sepocc_afternocc_2_5yr + 1.0_8
                                                IF(unempdur_estatus((tcnt2-4)/4)>=2 ) sepocc_afternocc_2_5yr_2m=sepocc_afternocc_2_5yr_2m + 1.0_8
                                            ELSE IF (occmob_ind(tcnt2-4)==2 )  THEN
                                                sepnocc_afternocc_2_5yr=sepnocc_afternocc_2_5yr + 1.0_8
                                                IF(unempdur_estatus((tcnt2-4)/4)>=2 ) sepnocc_afternocc_2_5yr_2m=sepnocc_afternocc_2_5yr_2m + 1.0_8
                                            END IF

                                            EXIT compl_occ_sep_within_pspanel

                                        END IF
                                    END DO compl_occ_sep_within_pspanel
                                EXIT repeat_sep_u_search_do
                    END IF
                END DO  repeat_sep_u_search_do

    END IF repeat_sep_if


    ! person leaves sample
!    IF (hcind_sim(t)<0) EXIT inside_pseudo_sipp_window_do


    ! UNEMPLOYMENT RATE FOR THOSE WITH EARLIER EMPLOYMENT IN THE FIRST 4 WAVES, i.e. 16 months, OR IN THE SUBSEQUENT PERIOD UNTIL T.
    IF(t>counter1+64 .AND. e_flag==1 .AND. unempdur_estatus(t/4)>=0) THEN
            earlier_e_counter=earlier_e_counter+1
            IF(age_sim(t)<youngcutoff)                              young_earlier_e_counter=young_earlier_e_counter+1
            IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff)    prime_earlier_e_counter=prime_earlier_e_counter+1

            IF(unempdur_estatus(t/4)>=1) THEN
                unemp_earlier_e_ave=unemp_earlier_e_ave+1.0_8
                IF(age_sim(t)<youngcutoff)                              u_earlier_e_young_ave=u_earlier_e_young_ave+1.0_8
                IF(age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff)    u_earlier_e_prime_ave=u_earlier_e_prime_ave+1.0_8
            END IF

    END IF


    IF(t>counter1+64 .AND. e_flag==1 .AND. unempdur_estatus(t/4)<0) warningcounter=warningcounter+1



    ! CALCULATION OF THE UNEMPLOYMENT PROPORTION
    IF(unempdur_estatus(t/4)>=1 .AND. u_flag==1 .AND. t<=counter1+144 .AND. age_sim(counter1)==age_sim(counter1+144)-144) THEN
                ! IF CHANGING THE WINDOW SIZE (144 now), change it here, and above (where u_flag=1 is set)
                ! CALCULATE PROPORTION OF WORKERS WHO BECOME UNEMPLOYED WITHIN A 3/3.5/4 YEAR WINDOW (NOW 3)

        u_flag=2
        counter_u_window=counter_u_window+1
        IF(age_sim(counter1)<youngcutoff) counter_u_window_y=counter_u_window_y+1
        IF(age_sim(counter1)>lowcutoff .AND. age_sim(counter1)<highcutoff) counter_u_window_p=counter_u_window_p+1
    END IF


    !!------------------------------------------------------
    !! ALTERNATIVE METHOD TO CALCULATE SAM/SAS/MAS/MAM HERE
    !!------------------------------------------------------
    flag_windowsurvival_if: &
    IF(flag_windowsurvival==1) THEN

    !! become employed after unemployment
    IF(unempdur_estatus(t/4)==0 .AND. unempdur_estatus((t-4)/4)>0 .AND. t>counter1) THEN

        ! add completed spell count
        tempcounter=tempcounter+1

        ! add to nocc or occ spell when satisfying the conditions
        IF(occmob_ind(t-4) == 1 .AND. tempcounter>0 .AND. tempcounter<=10) THEN
            repeatmobspells_matrix(tempcounter,1)=unempdur_estatus((t-4)/4)
            repeatmobspells_matrix(tempcounter,2)=0
        ELSE IF(occmob_ind(t-4) == 2 .AND. tempcounter>0 .AND. tempcounter<=10) THEN
            repeatmobspells_matrix(tempcounter,1)=0
            repeatmobspells_matrix(tempcounter,2)=unempdur_estatus((t-4)/4)
        END IF
    END IF

    !!-------------------
    !! ORIGINAL METHOD TO CALCULATE SAM/SAS/MAS/MAM HERE
    !!-------------------


    ! whenever there is a second unemployment spell; OCC/NOCC AFTER OCC

    !================
    ! FIRST UNEMPLOYMENT SPELL ENDS AT *t*
    !==================

        ! t will be refer to beginning employment spell, end first unemployment spell before
        ! tcnt               beginning second unemployment spell
        ! tcnt2              end second unemployment spell

    !! end of first unemployment spell
    first_u_spell_ends_if: &
    IF (unempdur_estatus(t/4)==0 .AND. unempdur_estatus((t-4)/4)>0 .AND. age_sim(t)==age_sim(counter1+tempint)-counter1-tempint+t) THEN               ! UNEMPLOYMENT SPELL ENDS, BUT WORKER STAYS IN SAMPLE in the pseudo-panel


                  !===================
                  !  CONCENTRATION OF OCC MOVE/STAY UNEMPLOYMENT   -----> this needs to be redone!!!

                  IF (occmob_ind(t-4)==1) counter_uocc_window_all=counter_uocc_window_all+1
                  IF (occmob_ind(t-4)==2) counter_unocc_window_all=counter_unocc_window_all+1

                  IF(duration_sim(t-4)<7 .AND. duration_sim(t-4)>0) uspellength_ind=1         ! previous unemployment spell "short"
                  IF(duration_sim(t-4)>=7) uspellength_ind=2                                  ! previous unemployment spell "long"

      !=============================
      ! calculate wage dispersion among ALL newly hired, with more than 2 years in sample

            wagedisp_uhires_if: &
            IF(t>counter1+96) THEN
              forward_loop_wages:&
              DO tcnt=t+4, MIN(counter1+tempint-(sample_timetogo_int*4)+1, t+96),4        ! WAGES OF NEWLY HIRED WITHIN 2 YRS
                IF(e_sim(tcnt)==1) THEN
                    logwage_disp_uhires=logwage_disp_uhires+log(wage_sim(tcnt))**2.0_8
                    logwage_ave_uhires=logwage_ave_uhires+log(wage_sim(tcnt))
                    logwage_uhires_counter=logwage_uhires_counter+1
                END IF
              END DO forward_loop_wages
            END IF wagedisp_uhires_if







    !====================
    !  LOCATING THE START OF THE SECOND UNEMPLOYMENT SPELL
    !======================


!! CONTINUE ONLY IF SURVIVAL THROUGHOUT PANEL
    !flag_windowsurvival_if: &
    !IF(flag_windowsurvival==1) THEN

        ! Looking for the repeat unemployment spell forward
        ! t is stopped at end of first unemployment spell. *tcnt* is moving forward
      flag3=0
      forward_loop2:&
      DO tcnt=t+4, counter1+tempint-(sample_timetogo_int*4)+1,4         ! FIND START OF SUBSEQUENT U SPELL WITHIN WINDOW; WITH SAMPLE-TIMETOGO CONDITION!!!!!

            ! person leaves sample SHOULD NOT OCCUR!!!
            !IF (hcind_sim(tcnt)<0) EXIT XXX inside_pseudo_sipp_window_do


          !~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
          !== BEGIN SECOND UNEMPLOYMENT SPELL

          repeat_u_entry_1_if: &
          IF (unempdur_estatus(tcnt/4)>0 .AND. unempdur_estatus((tcnt-4)/4)==0 .AND. occmob_ind(tcnt)>0) THEN            ! BECOME UNEMPLOYED AGAIN (second unemployment spell), with at least sample_timetogo_ind in the remaining window

                IF (occmob_ind(t-4)==1) counter_uocc_window=counter_uocc_window+1     ! interpretation?
                IF (occmob_ind(t-4)==2) counter_unocc_window=counter_unocc_window+1   ! interpretation?

                !============
                ! determine the length of subsequent unemployment, for unemployment duration correlations across spells


                        u_now_loop2:&
                        DO tcnt2=tcnt+4, counter1+tempint, 4             !  search: when does the next job start?

                            !IF (hcind_sim(tcnt2)<0) XXX EXIT inside_pseudo_sipp_window_do
                            IF (hcind_sim(tcnt2)<0) THEN
                                u_spell_now=log(12.0_8)
                                flag3=2
                                tempint2=-1
                                EXIT u_now_loop2
                            END IF

                            IF (e_sim(tcnt2)==1) THEN
                               u_spell_now=log(REAL(MIN((tcnt2-tcnt)/4+1,12)))
                               tempint2=tcnt2
                               flag3=1                    ! set flag, indeed end of spell
                                                           ! FLAG3=1 means that next job (EUEU->E) is within the window
                               EXIT u_now_loop2
                            END IF

                         END DO u_now_loop2

                         IF(flag3==0) THEN
                            u_spell_now=log(12.0_8)
                            flag3=2
                            tempint2=-1
                         END IF

                                                    ! reset flag
                         tcnt2=tempint2             ! time of becoming employed again (end of second unemployment spell)
                         u_spell_before=log(MAX(REAL(INT(duration_sim(t-4)/4)),12.0_8))

       !  !! for all previous spells
       !         u_spell_now_ave=u_spell_now_ave+(REAL(u_spell_now))
       !         u_spell_before_ave=u_spell_before_ave+(u_spell_before)
       !
       !         u_spell_now_sq=u_spell_now_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_sq=u_spell_before_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm=u_spell_crossterm+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_now_ave=u_spell_now_ave+(REAL(u_spell_now))
       !             u_spell_young_before_ave=u_spell_young_before_ave+(u_spell_before)
       !             u_spell_young_now_sq=u_spell_now_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_sq=u_spell_young_before_sq+(u_spell_before)**(2.0_8)
       !             u_spell_young_crossterm=u_spell_young_crossterm+(u_spell_before)*(REAL(u_spell_now))
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_now_ave=u_spell_prime_now_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_ave=u_spell_prime_before_ave+(u_spell_before)
       !             u_spell_prime_now_sq=u_spell_prime_now_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_sq=u_spell_prime_before_sq+(u_spell_before)**(2.0_8)
       !             u_spell_prime_crossterm=u_spell_prime_crossterm+(u_spell_before)*(REAL(u_spell_now))
       !         END IF
       !
       !
       ! ! for previous spells with occ mobility
       ! IF (occmob_ind(t-4)==1) THEN
       !         u_spell_now_am_ave=u_spell_now_am_ave+(REAL(u_spell_now))
       !         u_spell_before_am_ave=u_spell_before_am_ave+(u_spell_before)
       !         u_spell_now_am_sq=u_spell_now_am_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_am_sq=u_spell_before_am_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_am=u_spell_crossterm_am+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_crossterm_am=u_spell_young_crossterm_am+(u_spell_before)*(REAL(u_spell_now))
       !             u_spell_young_now_am_ave=u_spell_now_am_ave+(REAL(u_spell_now))
       !             u_spell_young_before_am_ave=u_spell_young_before_am_ave+(u_spell_before)
       !             u_spell_young_now_am_sq=u_spell_now_am_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_am_sq=u_spell_young_before_am_sq+(u_spell_before)**(2.0_8)
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_crossterm_am=u_spell_prime_crossterm_am+(u_spell_before)*(REAL(u_spell_now))
       !             u_spell_prime_now_am_ave=u_spell_prime_now_am_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_am_ave=u_spell_prime_before_am_ave+(u_spell_before)
       !             u_spell_prime_now_am_sq=u_spell_prime_now_am_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_am_sq=u_spell_prime_before_am_sq+(u_spell_before)**(2.0_8)
       !         END IF
       ! END IF
       !
       ! ! for previous spells without occ mobility
       ! IF (occmob_ind(t-4)==2) THEN
       !         u_spell_now_as_ave=u_spell_now_as_ave+(REAL(u_spell_now))
       !         u_spell_before_as_ave=u_spell_before_as_ave+(u_spell_before)
       !         u_spell_now_as_sq=u_spell_now_as_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_as_sq=u_spell_before_as_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_as=u_spell_crossterm_as+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_crossterm_as=u_spell_young_crossterm_as+(u_spell_before)*(REAL(u_spell_now))
       !             u_spell_young_now_as_ave=u_spell_now_as_ave+(REAL(u_spell_now))
       !             u_spell_young_before_as_ave=u_spell_young_before_as_ave+(u_spell_before)
       !             u_spell_young_now_as_sq=u_spell_now_as_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_as_sq=u_spell_young_before_as_sq+(u_spell_before)**(2.0_8)
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_crossterm_as=u_spell_prime_crossterm_as+(u_spell_before)*(REAL(u_spell_now))
       !             u_spell_prime_now_as_ave=u_spell_prime_now_as_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_as_ave=u_spell_prime_before_as_ave+(u_spell_before)
       !             u_spell_prime_now_as_sq=u_spell_prime_now_as_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_as_sq=u_spell_prime_before_as_sq+(u_spell_before)**(2.0_8)
       !         END IF
       ! END IF
       !
       ! !------ repeat mobility
       !
       !
       ! ! for occ mob: MAM
       ! IF (occmob_ind(t-4)==1 .AND. occmob_ind(tcnt)==1 .AND. flag3==1) THEN
       !         u_spell_now_mam_ave=u_spell_now_mam_ave+(REAL(u_spell_now))
       !         u_spell_before_mam_ave=u_spell_before_mam_ave+(u_spell_before)
       !         u_spell_now_mam_sq=u_spell_now_mam_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_mam_sq=u_spell_before_mam_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_mam=u_spell_crossterm_mam+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_now_mam_ave=u_spell_now_mam_ave+(REAL(u_spell_now))
       !             u_spell_young_before_mam_ave=u_spell_young_before_mam_ave+(u_spell_before)
       !             u_spell_young_now_mam_sq=u_spell_now_mam_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_mam_sq=u_spell_young_before_mam_sq+(u_spell_before)**(2.0_8)
       !             u_spell_young_crossterm_mam=u_spell_young_crossterm_mam+(u_spell_before)*(REAL(u_spell_now))
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_now_mam_ave=u_spell_prime_now_mam_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_mam_ave=u_spell_prime_before_mam_ave+(u_spell_before)
       !             u_spell_prime_now_mam_sq=u_spell_prime_now_mam_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_mam_sq=u_spell_prime_before_mam_sq+(u_spell_before)**(2.0_8)
       !             u_spell_prime_crossterm_mam=u_spell_prime_crossterm_mam+(u_spell_before)*(REAL(u_spell_now))
       !         END IF
       ! END IF
       !
       ! ! for occ mob: SAM
       ! IF (occmob_ind(t-4)==1 .AND. occmob_ind(tcnt)==2 .AND. flag3==1) THEN
       !         u_spell_now_sam_ave=u_spell_now_sam_ave+(REAL(u_spell_now))
       !         u_spell_before_sam_ave=u_spell_before_sam_ave+(u_spell_before)
       !         u_spell_now_sam_sq=u_spell_now_sam_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_sam_sq=u_spell_before_sam_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_sam=u_spell_crossterm_sam+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_now_sam_ave=u_spell_now_sam_ave+(REAL(u_spell_now))
       !             u_spell_young_before_sam_ave=u_spell_young_before_sam_ave+(u_spell_before)
       !             u_spell_young_now_sam_sq=u_spell_now_sam_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_sam_sq=u_spell_young_before_sam_sq+(u_spell_before)**(2.0_8)
       !             u_spell_young_crossterm_sam=u_spell_young_crossterm_sam+(u_spell_before)*(REAL(u_spell_now))
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_now_sam_ave=u_spell_prime_now_sam_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_sam_ave=u_spell_prime_before_sam_ave+(u_spell_before)
       !             u_spell_prime_now_sam_sq=u_spell_prime_now_sam_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_sam_sq=u_spell_prime_before_sam_sq+(u_spell_before)**(2.0_8)
       !             u_spell_prime_crossterm_sam=u_spell_prime_crossterm_sam+(u_spell_before)*(REAL(u_spell_now))
       !         END IF
       ! END IF
       !
       ! ! for occ mob: MAS
       ! IF (occmob_ind(t-4)==2 .AND. occmob_ind(tcnt)==1 .AND. flag3==1) THEN
       !         u_spell_now_mas_ave=u_spell_now_mas_ave+(REAL(u_spell_now))
       !         u_spell_before_mas_ave=u_spell_before_mas_ave+(u_spell_before)
       !         u_spell_now_mas_sq=u_spell_now_mas_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_mas_sq=u_spell_before_mas_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_mas=u_spell_crossterm_mas+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_now_mas_ave=u_spell_now_mas_ave+(REAL(u_spell_now))
       !             u_spell_young_before_mas_ave=u_spell_young_before_mas_ave+(u_spell_before)
       !             u_spell_young_now_mas_sq=u_spell_now_mas_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_mas_sq=u_spell_young_before_mas_sq+(u_spell_before)**(2.0_8)
       !             u_spell_young_crossterm_mas=u_spell_young_crossterm_mas+(u_spell_before)*(REAL(u_spell_now))
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_now_mas_ave=u_spell_prime_now_mas_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_mas_ave=u_spell_prime_before_mas_ave+(u_spell_before)
       !             u_spell_prime_now_mas_sq=u_spell_prime_now_mas_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_mas_sq=u_spell_prime_before_mas_sq+(u_spell_before)**(2.0_8)
       !             u_spell_prime_crossterm_mas=u_spell_prime_crossterm_mas+(u_spell_before)*(REAL(u_spell_now))
       !         END IF
       ! END IF
       !
       ! ! for occ mob: SAS
       ! IF (occmob_ind(t-4)==2 .AND. occmob_ind(tcnt)==2 .AND. flag3==1) THEN
       !         u_spell_now_sas_ave=u_spell_now_sas_ave+(REAL(u_spell_now))
       !         u_spell_before_sas_ave=u_spell_before_sas_ave+(u_spell_before)
       !         u_spell_now_sas_sq=u_spell_now_sas_sq+(REAL(u_spell_now))**2.0_8
       !         u_spell_before_sas_sq=u_spell_before_sas_sq+(u_spell_before)**(2.0_8)
       !         u_spell_crossterm_sas=u_spell_crossterm_sas+(u_spell_before)*(REAL(u_spell_now))
       !         IF(age_sim(t)<youngcutoff) THEN
       !             u_spell_young_now_sas_ave=u_spell_now_sas_ave+(REAL(u_spell_now))
       !             u_spell_young_before_sas_ave=u_spell_young_before_sas_ave+(u_spell_before)
       !             u_spell_young_now_sas_sq=u_spell_now_sas_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_young_before_sas_sq=u_spell_young_before_sas_sq+(u_spell_before)**(2.0_8)
       !             u_spell_young_crossterm_sas=u_spell_young_crossterm_sas+(u_spell_before)*(REAL(u_spell_now))
       !         ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
       !             u_spell_prime_now_sas_ave=u_spell_prime_now_sas_ave+(REAL(u_spell_now))
       !             u_spell_prime_before_sas_ave=u_spell_prime_before_sas_ave+(u_spell_before)
       !             u_spell_prime_now_sas_sq=u_spell_prime_now_sas_sq+(REAL(u_spell_now))**2.0_8
       !             u_spell_prime_before_sas_sq=u_spell_prime_before_sas_sq+(u_spell_before)**(2.0_8)
       !             u_spell_prime_crossterm_sas=u_spell_prime_crossterm_sas+(u_spell_before)*(REAL(u_spell_now))
       !         END IF
       ! END IF
       !
       !
       !
       !


                !=============
                ! determine the outflow patterns of the second spell: Pmam, Pmas, Psam, Psas, Cmam, Csas etc.




    rep_mob_1_if:  IF(flag3==1) THEN           ! WE HAVE TWO COMPLETED SPELLS then we are in business

        !IF (occmob_ind(t-4)==1 .AND.  occmob_ind(tcnt)==1 .AND. flag3==1) THEN
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafterocc=tot_occafterocc+1.0_8
!
!                tot_occafterocc_vector(1)=tot_occafterocc_vector(1)+1.0_8
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                        tot_occafterocc_vector(2)=tot_occafterocc_vector(2)+1.0_8
!                        IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                            tot_occafterocc_vector(3)=tot_occafterocc_vector(3)+1.0_8
!                            IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                tot_occafterocc_vector(4)=tot_occafterocc_vector(4)+1.0_8
!                            END IF
!                        END IF
!                END IF
!
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) occafterocc_uspell(uspellength_ind)=occafterocc_uspell(uspellength_ind)+1.0_8
!
!                stock_occafterocc=stock_occafterocc+REAL((tcnt2-tcnt)/4)
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_uspell(uspellength_ind)=stock_occafterocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!
!                poccafterocc=poccafterocc+1.0_8
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_uspell(uspellength_ind)=poccafterocc_uspell(uspellength_ind)+1.0_8
!
!                IF (age_sim(t)<youngcutoff) THEN
!
!
!
!                     tot_occafterocc_vector_young(1)=tot_occafterocc_vector_young(1)+1.0_8
!                     IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                             tot_occafterocc_vector_young(2)=tot_occafterocc_vector_young(2)+1.0_8
!                             IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                                 tot_occafterocc_vector_young(3)=tot_occafterocc_vector_young(3)+1.0_8
!                                 IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                     tot_occafterocc_vector_young(4)=tot_occafterocc_vector_young(4)+1.0_8
!                                 END IF
!                             END IF
!                    END IF
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafterocc_y=tot_occafterocc_y+1.0_8
!                    stock_occafterocc_y=stock_occafterocc_y+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_y_uspell(uspellength_ind)=stock_occafterocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    poccafterocc_y=poccafterocc_y+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_y_uspell(uspellength_ind)=poccafterocc_y_uspell(uspellength_ind)+1.0_8
!
!                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
!
!                    tot_occafterocc_vector_prime(1)=tot_occafterocc_vector_prime(1)+1.0_8
!                     IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                             tot_occafterocc_vector_prime(2)=tot_occafterocc_vector_prime(2)+1.0_8
!                             IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                                 tot_occafterocc_vector_prime(3)=tot_occafterocc_vector_prime(3)+1.0_8
!                                 IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                     tot_occafterocc_vector_prime(4)=tot_occafterocc_vector_prime(4)+1.0_8
!                                 END IF
!                             END IF
!                    END IF
!
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafterocc_p=tot_occafterocc_p+1.0_8
!                    stock_occafterocc_p=stock_occafterocc_p+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_p_uspell(uspellength_ind)=stock_occafterocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    poccafterocc_p=poccafterocc_p+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_p_uspell(uspellength_ind)=poccafterocc_p_uspell(uspellength_ind)+1.0_8
!                END IF
!
!        ELSE IF(occmob_ind(t-4)==1 .AND. occmob_ind(tcnt)==2 .AND. flag3==1) THEN              ! FOUND BEGINNING subsequent spell without occ change
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafterocc=tot_noccafterocc+1.0_8
!
!                tot_noccafterocc_vector(1)=tot_noccafterocc_vector(1)+1.0_8
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                    tot_noccafterocc_vector(2)=tot_noccafterocc_vector(2)+1.0_8
!                    IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_noccafterocc_vector(3)=tot_noccafterocc_vector(3)+1.0_8
!                        IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                            tot_noccafterocc_vector(4)=tot_noccafterocc_vector(4)+1.0_8
!                        END IF
!                    END IF
!                END IF
!
!                IF (uspellength_ind>0) noccafterocc_uspell(uspellength_ind)=noccafterocc_uspell(uspellength_ind)+1.0_8
!                stock_noccafterocc=stock_noccafterocc+REAL((tcnt2-tcnt)/4)
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_uspell(uspellength_ind)=stock_noccafterocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                pnoccafterocc=pnoccafterocc+1.0_8
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_uspell(uspellength_ind)=pnoccafterocc_uspell(uspellength_ind)+1.0_8
!
!                IF (age_sim(t)<youngcutoff) THEN
!
!                tot_noccafterocc_vector_young(1)=tot_noccafterocc_vector_young(1)+1.0_8
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                    tot_noccafterocc_vector_young(2)=tot_noccafterocc_vector_young(2)+1.0_8
!                    IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_noccafterocc_vector_young(3)=tot_noccafterocc_vector_young(3)+1.0_8
!                        IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                            tot_noccafterocc_vector_young(4)=tot_noccafterocc_vector_young(4)+1.0_8
!                        END IF
!                    END IF
!                END IF
!
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafterocc_y=tot_noccafterocc_y+1.0_8
!
!                    stock_noccafterocc_y=stock_noccafterocc_y+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_y_uspell(uspellength_ind)=stock_noccafterocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    pnoccafterocc_y=pnoccafterocc_y+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_y_uspell(uspellength_ind)=pnoccafterocc_y_uspell(uspellength_ind)+1.0_8
!                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
!
!                tot_noccafterocc_vector_prime(1)=tot_noccafterocc_vector_prime(1)+1.0_8
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                    tot_noccafterocc_vector_prime(2)=tot_noccafterocc_vector_prime(2)+1.0_8
!                    IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_noccafterocc_vector_prime(3)=tot_noccafterocc_vector_prime(3)+1.0_8
!                        IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                            tot_noccafterocc_vector_prime(4)=tot_noccafterocc_vector_prime(4)+1.0_8
!                        END IF
!                    END IF
!                END IF
!
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafterocc_p=tot_noccafterocc_p+1.0_8
!                    stock_noccafterocc_p=stock_noccafterocc_p+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_p_uspell(uspellength_ind)=stock_noccafterocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    pnoccafterocc_p=pnoccafterocc_p+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_p_uspell(uspellength_ind)=pnoccafterocc_p_uspell(uspellength_ind)+1.0_8
!                END IF
!
!        END IF
!
!        IF (occmob_ind(tcnt)==1 .AND. occmob_ind(t-4)==2 .AND. flag3==1) THEN  ! MAS: OCC MOVE AFTER OCC STAY, i.e. OccafterNocc
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafternocc=tot_occafternocc+1.0_8
!
!                tot_occafternocc_vector(1)=tot_occafternocc_vector(1)+1.0_8
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                    tot_occafternocc_vector(2)=tot_occafternocc_vector(2)+1.0_8
!                    IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                    tot_occafternocc_vector(3)=tot_occafternocc_vector(3)+1.0_8
!                        IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                            tot_occafternocc_vector(4)=tot_occafternocc_vector(4)+1.0_8
!                        END IF
!                    END IF
!                END IF
!
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) occafternocc_uspell(uspellength_ind)=occafternocc_uspell(uspellength_ind)+1.0_8
!                stock_occafternocc=stock_occafternocc+REAL((tcnt2-tcnt)/4)
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_uspell(uspellength_ind)=stock_occafternocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                poccafternocc=poccafternocc+1.0_8
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_uspell(uspellength_ind)=poccafternocc_uspell(uspellength_ind)+1.0_8
!
!                IF (age_sim(t)<youngcutoff) THEN
!
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafternocc_y=tot_occafternocc_y+1.0_8
!
!
!                    tot_occafternocc_vector_young(1)=tot_occafternocc_vector_young(1)+1.0_8
!                    IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                        tot_occafternocc_vector_young(2)=tot_occafternocc_vector_young(2)+1.0_8
!                        IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_occafternocc_vector_young(3)=tot_occafternocc_vector_young(3)+1.0_8
!                            IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                tot_occafternocc_vector_young(4)=tot_occafternocc_vector_young(4)+1.0_8
!                            END IF
!                        END IF
!                    END IF
!                    stock_occafternocc_y=stock_occafternocc_y+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_y_uspell(uspellength_ind)=stock_occafternocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    poccafternocc_y=poccafternocc_y+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_y_uspell(uspellength_ind)=poccafternocc_y_uspell(uspellength_ind)+1.0_8
!                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
!
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_occafternocc_p=tot_occafternocc_p+1.0_8
!
!                    tot_occafternocc_vector_prime(1)=tot_occafternocc_vector_prime(1)+1.0_8
!                    IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                        tot_occafternocc_vector_prime(2)=tot_occafternocc_vector_prime(2)+1.0_8
!                        IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_occafternocc_vector_prime(3)=tot_occafternocc_vector_prime(3)+1.0_8
!                            IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                tot_occafternocc_vector_prime(4)=tot_occafternocc_vector_prime(4)+1.0_8
!                            END IF
!                        END IF
!                    END IF
!                    stock_occafternocc_p=stock_occafternocc_p+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_p_uspell(uspellength_ind)=stock_occafternocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    poccafternocc_p=poccafternocc_p+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_p_uspell(uspellength_ind)=poccafternocc_p_uspell(uspellength_ind)+1.0_8
!                END IF
!
!        ELSE IF(occmob_ind(tcnt)==2 .AND. occmob_ind(t-4)==2 .AND. flag3==1) THEN           ! SAS: occupational stay after occupational stay
!
!                IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafternocc=tot_noccafternocc+1.0_8
!
!                tot_noccafternocc_vector(1)=tot_noccafternocc_vector(1)+1.0_8
!                IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                    tot_noccafternocc_vector(2)=tot_noccafternocc_vector(2)+1.0_8
!                    IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                        tot_noccafternocc_vector(3)=tot_noccafternocc_vector(3)+1.0_8
!                        IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                            tot_noccafternocc_vector(4)=tot_noccafternocc_vector(4)+1.0_8
!                        END IF
!                    END IF
!                END IF
!
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) noccafternocc_uspell(uspellength_ind)=noccafternocc_uspell(uspellength_ind)+1.0_8
!                stock_noccafternocc=stock_noccafternocc+REAL((tcnt2-tcnt)/4)
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_uspell(uspellength_ind)=stock_noccafternocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                pnoccafternocc=pnoccafternocc+1.0_8
!                IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_uspell(uspellength_ind)=pnoccafternocc_uspell(uspellength_ind)+1.0_8
!
!                IF (age_sim(t)<youngcutoff) THEN
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafternocc_y=tot_noccafternocc_y+1.0_8
!
!                    tot_noccafternocc_vector_young(1)=tot_noccafternocc_vector_young(1)+1.0_8
!                    IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                        tot_noccafternocc_vector_young(2)=tot_noccafternocc_vector_young(2)+1.0_8
!                        IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                            tot_noccafternocc_vector_young(3)=tot_noccafternocc_vector_young(3)+1.0_8
!                            IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                tot_noccafternocc_vector_young(4)=tot_noccafternocc_vector_young(4)+1.0_8
!                            END IF
!                        END IF
!                    END IF
!
!
!                    stock_noccafternocc_y=stock_noccafternocc_y+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_y_uspell(uspellength_ind)=stock_noccafternocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    pnoccafternocc_y=pnoccafternocc_y+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_y_uspell(uspellength_ind)=pnoccafternocc_y_uspell(uspellength_ind)+1.0_8
!                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
!                    IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafternocc_p=tot_noccafternocc_p+1.0_8
!
!                    tot_noccafternocc_vector_prime(1)=tot_noccafternocc_vector_prime(1)+1.0_8
!                    IF(unempdur_estatus((tcnt+4)/4)==0) THEN
!                        tot_noccafternocc_vector_prime(2)=tot_noccafternocc_vector_prime(2)+1.0_8
!                        IF(unempdur_estatus((tcnt+8)/4)==0) THEN
!                            tot_noccafternocc_vector_prime(3)=tot_noccafternocc_vector_prime(3)+1.0_8
!                            IF(unempdur_estatus((tcnt+12)/4)==0) THEN
!                                tot_noccafternocc_vector_prime(4)=tot_noccafternocc_vector_prime(4)+1.0_8
!                            END IF
!                        END IF
!                    END IF
!
!
!                    stock_noccafternocc_p=stock_noccafternocc_p+REAL((tcnt2-tcnt)/4)
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_p_uspell(uspellength_ind)=stock_noccafternocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
!                    pnoccafternocc_p=pnoccafternocc_p+1.0_8
!                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_p_uspell(uspellength_ind)=pnoccafternocc_p_uspell(uspellength_ind)+1.0_8
!                END IF
!
!        END IF

!! ======= CORRECTED REPEAT MOBILITY ========================
        IF (corr_occmob_ind(t-4)==1 .AND.  corr_occmob_ind(tcnt)==1 .AND. flag3==1) THEN
                tot_corr_occafterocc=tot_corr_occafterocc+1.0_8
                IF (age_sim(t)<youngcutoff) THEN
                    tot_corr_occafterocc_y=tot_corr_occafterocc_y+1.0_8
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    tot_corr_occafterocc_p=tot_corr_occafterocc_p+1.0_8
                END IF
        ELSE IF (corr_occmob_ind(t-4)==1 .AND.  corr_occmob_ind(tcnt)==2 .AND. flag3==1) THEN
                tot_corr_noccafterocc=tot_corr_noccafterocc+1.0_8
                IF (age_sim(t)<youngcutoff) THEN
                    tot_corr_noccafterocc_y=tot_corr_noccafterocc_y+1.0_8
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    tot_corr_noccafterocc_p=tot_corr_noccafterocc_p+1.0_8
                END IF
        ELSE IF (corr_occmob_ind(t-4)==2 .AND.  corr_occmob_ind(tcnt)==1 .AND. flag3==1) THEN
                tot_corr_occafternocc=tot_corr_occafternocc+1.0_8
                IF (age_sim(t)<youngcutoff) THEN
                    tot_corr_occafternocc_y=tot_corr_occafternocc_y+1.0_8
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    tot_corr_occafternocc_p=tot_corr_occafternocc_p+1.0_8
                END IF
        ELSE IF (corr_occmob_ind(t-4)==2 .AND.  corr_occmob_ind(tcnt)==2 .AND. flag3==1) THEN
                tot_corr_noccafternocc=tot_corr_noccafternocc+1.0_8
                IF (age_sim(t)<youngcutoff) THEN
                    tot_corr_noccafternocc_y=tot_corr_noccafternocc_y+1.0_8
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    tot_corr_noccafternocc_p=tot_corr_noccafternocc_p+1.0_8
                END IF
        END IF

        !! ========MAM: MOVE AFTER MOVE================
        IF (occmob_ind(t-4)==1 .AND.  occmob_ind(tcnt)==1 .AND. flag3==1) THEN


                tot_occafterocc_vector(1)=tot_occafterocc_vector(1)+1.0_8

                !IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafterocc=tot_occafterocc+1.0_8

                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                        tot_occafterocc_vector(2)=tot_occafterocc_vector(2)+1.0_8
                        IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                            tot_occafterocc_vector(3)=tot_occafterocc_vector(3)+1.0_8
                            IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                tot_occafterocc_vector(4)=tot_occafterocc_vector(4)+1.0_8
                            END IF
                        END IF
                END IF

                IF(uspellength_ind>0 .AND. uspellength_ind<3) occafterocc_uspell(uspellength_ind)=occafterocc_uspell(uspellength_ind)+1.0_8

                stock_occafterocc=stock_occafterocc+REAL((tcnt2-tcnt)/4)
                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_uspell(uspellength_ind)=stock_occafterocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)

                poccafterocc=poccafterocc+1.0_8
                IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_uspell(uspellength_ind)=poccafterocc_uspell(uspellength_ind)+1.0_8

                !! YOUNG
                IF (age_sim(t)<youngcutoff) THEN



                     tot_occafterocc_vector_young(1)=tot_occafterocc_vector_young(1)+1.0_8
                     IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                             tot_occafterocc_vector_young(2)=tot_occafterocc_vector_young(2)+1.0_8
                             IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                                 tot_occafterocc_vector_young(3)=tot_occafterocc_vector_young(3)+1.0_8
                                 IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                     tot_occafterocc_vector_young(4)=tot_occafterocc_vector_young(4)+1.0_8
                                 END IF
                             END IF
                    END IF

                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafterocc_y=tot_occafterocc_y+1.0_8
                    stock_occafterocc_y=stock_occafterocc_y+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_y_uspell(uspellength_ind)=stock_occafterocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    poccafterocc_y=poccafterocc_y+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_y_uspell(uspellength_ind)=poccafterocc_y_uspell(uspellength_ind)+1.0_8

                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN

                    tot_occafterocc_vector_prime(1)=tot_occafterocc_vector_prime(1)+1.0_8
                     IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                             tot_occafterocc_vector_prime(2)=tot_occafterocc_vector_prime(2)+1.0_8
                             IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                                 tot_occafterocc_vector_prime(3)=tot_occafterocc_vector_prime(3)+1.0_8
                                 IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                     tot_occafterocc_vector_prime(4)=tot_occafterocc_vector_prime(4)+1.0_8
                                 END IF
                             END IF
                    END IF


                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafterocc_p=tot_occafterocc_p+1.0_8
                    stock_occafterocc_p=stock_occafterocc_p+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafterocc_p_uspell(uspellength_ind)=stock_occafterocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    poccafterocc_p=poccafterocc_p+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafterocc_p_uspell(uspellength_ind)=poccafterocc_p_uspell(uspellength_ind)+1.0_8
                END IF


        !!  ==============SAM -- NOCC AFTER OCC=============================
        ELSE IF(occmob_ind(t-4)==1 .AND. occmob_ind(tcnt)==2 .AND. flag3==1) THEN              ! FOUND BEGINNING subsequent spell without occ change

                !IF(unempdur_estatus((tcnt+4)/4)==0) tot_noccafterocc=tot_noccafterocc+1.0_8
                !IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafterocc=tot_noccafterocc+1.0_8

                tot_noccafterocc_vector(1)=tot_noccafterocc_vector(1)+1.0_8

                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                    tot_noccafterocc_vector(2)=tot_noccafterocc_vector(2)+1.0_8
                    IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_noccafterocc_vector(3)=tot_noccafterocc_vector(3)+1.0_8
                        IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                            tot_noccafterocc_vector(4)=tot_noccafterocc_vector(4)+1.0_8
                        END IF
                    END IF
                END IF

                IF (uspellength_ind>0) noccafterocc_uspell(uspellength_ind)=noccafterocc_uspell(uspellength_ind)+1.0_8
                stock_noccafterocc=stock_noccafterocc+REAL((tcnt2-tcnt)/4)
                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_uspell(uspellength_ind)=stock_noccafterocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                pnoccafterocc=pnoccafterocc+1.0_8
                IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_uspell(uspellength_ind)=pnoccafterocc_uspell(uspellength_ind)+1.0_8


                !! YOUNG NOCC AFTER OCC
                IF (age_sim(t)<youngcutoff) THEN

                tot_noccafterocc_vector_young(1)=tot_noccafterocc_vector_young(1)+1.0_8

                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                    tot_noccafterocc_vector_young(2)=tot_noccafterocc_vector_young(2)+1.0_8
                    IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_noccafterocc_vector_young(3)=tot_noccafterocc_vector_young(3)+1.0_8
                        IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                            tot_noccafterocc_vector_young(4)=tot_noccafterocc_vector_young(4)+1.0_8
                        END IF
                    END IF
                END IF


                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafterocc_y=tot_noccafterocc_y+1.0_8

                    stock_noccafterocc_y=stock_noccafterocc_y+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_y_uspell(uspellength_ind)=stock_noccafterocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    pnoccafterocc_y=pnoccafterocc_y+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_y_uspell(uspellength_ind)=pnoccafterocc_y_uspell(uspellength_ind)+1.0_8

                !! PRIME NOCC AFTER OCC
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN

                tot_noccafterocc_vector_prime(1)=tot_noccafterocc_vector_prime(1)+1.0_8

                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                    tot_noccafterocc_vector_prime(2)=tot_noccafterocc_vector_prime(2)+1.0_8
                    IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_noccafterocc_vector_prime(3)=tot_noccafterocc_vector_prime(3)+1.0_8
                        IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                            tot_noccafterocc_vector_prime(4)=tot_noccafterocc_vector_prime(4)+1.0_8
                        END IF
                    END IF
                END IF


                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafterocc_p=tot_noccafterocc_p+1.0_8
                    stock_noccafterocc_p=stock_noccafterocc_p+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafterocc_p_uspell(uspellength_ind)=stock_noccafterocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    pnoccafterocc_p=pnoccafterocc_p+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafterocc_p_uspell(uspellength_ind)=pnoccafterocc_p_uspell(uspellength_ind)+1.0_8
                END IF

        END IF

        !! MAS -- OCC AFTER NOCC
        IF (occmob_ind(tcnt)==1 .AND. occmob_ind(t-4)==2 .AND. flag3==1) THEN  ! MAS: OCC MOVE AFTER OCC STAY, i.e. OccafterNocc

                !IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafternocc=tot_occafternocc+1.0_8

                tot_occafternocc_vector(1)=tot_occafternocc_vector(1)+1.0_8

                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                    tot_occafternocc_vector(2)=tot_occafternocc_vector(2)+1.0_8
                    IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                    tot_occafternocc_vector(3)=tot_occafternocc_vector(3)+1.0_8
                        IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                            tot_occafternocc_vector(4)=tot_occafternocc_vector(4)+1.0_8
                        END IF
                    END IF
                END IF

                IF(uspellength_ind>0 .AND. uspellength_ind<3) occafternocc_uspell(uspellength_ind)=occafternocc_uspell(uspellength_ind)+1.0_8
                stock_occafternocc=stock_occafternocc+REAL((tcnt2-tcnt)/4)
                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_uspell(uspellength_ind)=stock_occafternocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                poccafternocc=poccafternocc+1.0_8
                IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_uspell(uspellength_ind)=poccafternocc_uspell(uspellength_ind)+1.0_8

                !!-- AGE SPLIT MAS
                !! YOUNG
                IF (age_sim(t)<youngcutoff) THEN


                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafternocc_y=tot_occafternocc_y+1.0_8


                    tot_occafternocc_vector_young(1)=tot_occafternocc_vector_young(1)+1.0_8
                    IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                        tot_occafternocc_vector_young(2)=tot_occafternocc_vector_young(2)+1.0_8
                        IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_occafternocc_vector_young(3)=tot_occafternocc_vector_young(3)+1.0_8
                            IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                tot_occafternocc_vector_young(4)=tot_occafternocc_vector_young(4)+1.0_8
                            END IF
                        END IF
                    END IF



                    stock_occafternocc_y=stock_occafternocc_y+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_y_uspell(uspellength_ind)=stock_occafternocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    poccafternocc_y=poccafternocc_y+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_y_uspell(uspellength_ind)=poccafternocc_y_uspell(uspellength_ind)+1.0_8

                !! PRIME-AGED
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN

                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_occafternocc_p=tot_occafternocc_p+1.0_8

                    tot_occafternocc_vector_prime(1)=tot_occafternocc_vector_prime(1)+1.0_8
                    IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                        tot_occafternocc_vector_prime(2)=tot_occafternocc_vector_prime(2)+1.0_8
                        IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_occafternocc_vector_prime(3)=tot_occafternocc_vector_prime(3)+1.0_8
                            IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                tot_occafternocc_vector_prime(4)=tot_occafternocc_vector_prime(4)+1.0_8
                            END IF
                        END IF
                    END IF

                    stock_occafternocc_p=stock_occafternocc_p+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_occafternocc_p_uspell(uspellength_ind)=stock_occafternocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    poccafternocc_p=poccafternocc_p+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) poccafternocc_p_uspell(uspellength_ind)=poccafternocc_p_uspell(uspellength_ind)+1.0_8
                END IF
                !!-- AGE SPLIT MAS

        !! SAS
        ELSE IF(occmob_ind(tcnt)==2 .AND. occmob_ind(t-4)==2 .AND. flag3==1) THEN           ! SAS: occupational stay after occupational stay

                !IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafternocc=tot_noccafternocc+1.0_8

                tot_noccafternocc_vector(1)=tot_noccafternocc_vector(1)+1.0_8
                IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                    tot_noccafternocc_vector(2)=tot_noccafternocc_vector(2)+1.0_8
                    IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                        tot_noccafternocc_vector(3)=tot_noccafternocc_vector(3)+1.0_8
                        IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                            tot_noccafternocc_vector(4)=tot_noccafternocc_vector(4)+1.0_8
                        END IF
                    END IF
                END IF

                IF(uspellength_ind>0 .AND. uspellength_ind<3) noccafternocc_uspell(uspellength_ind)=noccafternocc_uspell(uspellength_ind)+1.0_8
                stock_noccafternocc=stock_noccafternocc+REAL((tcnt2-tcnt)/4)
                IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_uspell(uspellength_ind)=stock_noccafternocc_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                pnoccafternocc=pnoccafternocc+1.0_8
                IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_uspell(uspellength_ind)=pnoccafternocc_uspell(uspellength_ind)+1.0_8

                IF (age_sim(t)<youngcutoff) THEN
                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafternocc_y=tot_noccafternocc_y+1.0_8

                    tot_noccafternocc_vector_young(1)=tot_noccafternocc_vector_young(1)+1.0_8
                    IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                        tot_noccafternocc_vector_young(2)=tot_noccafternocc_vector_young(2)+1.0_8
                        IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                            tot_noccafternocc_vector_young(3)=tot_noccafternocc_vector_young(3)+1.0_8
                            IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                tot_noccafternocc_vector_young(4)=tot_noccafternocc_vector_young(4)+1.0_8
                            END IF
                        END IF
                    END IF


                    stock_noccafternocc_y=stock_noccafternocc_y+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_y_uspell(uspellength_ind)=stock_noccafternocc_y_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    pnoccafternocc_y=pnoccafternocc_y+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_y_uspell(uspellength_ind)=pnoccafternocc_y_uspell(uspellength_ind)+1.0_8

                !! PRIME
                ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
                    IF(unempdur_estatus((tcnt+4)/4)>0) tot_noccafternocc_p=tot_noccafternocc_p+1.0_8

                    tot_noccafternocc_vector_prime(1)=tot_noccafternocc_vector_prime(1)+1.0_8
                    IF(unempdur_estatus((tcnt+4)/4)>0) THEN
                        tot_noccafternocc_vector_prime(2)=tot_noccafternocc_vector_prime(2)+1.0_8
                        IF(unempdur_estatus((tcnt+8)/4)>0) THEN
                            tot_noccafternocc_vector_prime(3)=tot_noccafternocc_vector_prime(3)+1.0_8
                            IF(unempdur_estatus((tcnt+12)/4)>0) THEN
                                tot_noccafternocc_vector_prime(4)=tot_noccafternocc_vector_prime(4)+1.0_8
                            END IF
                        END IF
                    END IF


                    stock_noccafternocc_p=stock_noccafternocc_p+REAL((tcnt2-tcnt)/4)
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) stock_noccafternocc_p_uspell(uspellength_ind)=stock_noccafternocc_p_uspell(uspellength_ind)+REAL((tcnt2-tcnt)/4)
                    pnoccafternocc_p=pnoccafternocc_p+1.0_8
                    IF(uspellength_ind>0 .AND. uspellength_ind<3) pnoccafternocc_p_uspell(uspellength_ind)=pnoccafternocc_p_uspell(uspellength_ind)+1.0_8
                END IF

        END IF

    END IF rep_mob_1_if
    END IF repeat_u_entry_1_if

    IF (flag3==1 .OR. flag3==2) THEN
        flag3=0
        EXIT forward_loop2
    END IF

END DO forward_loop2        ! looking for the second entry into unemployment
END IF first_u_spell_ends_if
END IF flag_windowsurvival_if

END DO inside_pseudo_sipp_window_do


  !! outside the inner sipp window, count the spells according to definition
    !! ALL WORKERS
    IF(tempcounter>1) THEN
    DO tcnt=1, tempcounter-1
        IF (repeatmobspells_matrix(tcnt,1)>0) THEN        !! INITIAL USPELL = OCC MOVE
            IF(repeatmobspells_matrix(tcnt+1,1)>1) THEN       !! SUBSEQUENT USPELL = ALSO OCC MOVE; BUT NEED TWO MONTHS IN U
                tot_occafterocc=tot_occafterocc+1.0
            ELSEIF(repeatmobspells_matrix(tcnt+1,2)>1) THEN   !! SUBSEQUENT USPELL = NOCC STAY; BUT NEED TWO MONTHS IN U
                tot_noccafterocc=tot_noccafterocc+1.0
            END IF
        ELSEIF (repeatmobspells_matrix(tcnt,2)>0) THEN        !! INITIAL USPELL = NOCC STAY
            IF(repeatmobspells_matrix(tcnt+1,1)>1) THEN       !! SUBSEQUENT USPELL = ALSO OCC MOVE; BUT NEED TWO MONTHS IN U
                tot_occafternocc=tot_occafternocc+1.0
            ELSEIF(repeatmobspells_matrix(tcnt+1,2)>1) THEN   !! SUBSEQUENT USPELL = NOCC STAY; BUT NEED TWO MONTHS IN U
                tot_noccafternocc=tot_noccafternocc+1.0
            END IF
        END IF

    !! YOUNG
    !! PRIME-AGED
    END DO ![tcnt]
    END IF



!*************************
! EXIT WINDOW
!*************************
!END IF
counter1=counter1+tempint+1
END DO
tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
counter1=tswindow_wks_max-tmax_swindow_wks_raw+4
    END DO sipp_window_do1






!!!------------------------------------------------
!!! RETURNS TO TENURE
!!!------------------------------------------------

tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw
        ! returns to tenure
        DO t=tmin_sim2+240, tmax_sim2
            IF(hcten_sim(t)==240 .AND. e_sim(t)==1 .AND. t>tswindow_wks_min+288 .AND. t<tswindow_wks_min+tmax_swindow_wks_raw) THEN
                tenure5yr_do: DO counter1=t-239,MAX(1,t-288),-1
                    IF(e_sim(counter1)==1 .AND. wage_sim(counter1)>0.0_8 .AND. wage_sim(t)>0.0_8) THEN
                        returnstenure5y=log(wage_sim(t))-log(wage_sim(counter1))+returnstenure5y
                        returnstenure5ycounter=returnstenure5ycounter+1
                        EXIT tenure5yr_do
                    END IF
                END DO tenure5yr_do
            ELSE IF(t>=tswindow_wks_min+tmax_swindow_wks_raw) THEN
                tswindow_wks_min=tswindow_wks_min+tmax_swindow_wks_raw
                tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
            END IF
        END DO

tswindow_wks_min=tmin_sim2+1
tswindow_wks_max=tmin_sim2+tmax_swindow_wks_raw

        DO t=tmin_sim2+1, tmax_sim2
            IF(hcten_sim(t)==480 .AND. e_sim(t)==1 .AND. t>tswindow_wks_min+528 .AND. t<tswindow_wks_min+tmax_swindow_wks_raw) THEN
                tenure10yr_do: DO counter1=t-479,MAX(1,t-528),-1
                    IF(e_sim(counter1)==1 .AND. wage_sim(counter1)>0.0_8 .AND. wage_sim(t)>0.0_8) THEN
                        returnstenure10y=log(wage_sim(t))-log(wage_sim(counter1))+returnstenure10y
                        returnstenure10ycounter=returnstenure10ycounter+1
                        EXIT tenure10yr_do
                    END IF
                END DO tenure10yr_do
            ELSE IF(t>=tswindow_wks_min+tmax_swindow_wks_raw) THEN
                tswindow_wks_min=tswindow_wks_min+tmax_swindow_wks_raw
                tswindow_wks_max=tswindow_wks_max+tmax_swindow_wks_raw
            END IF
    END DO






!!!------------------------------------------------
!!! UNEMPLOYMENT DURATIONS
!!!------------------------------------------------

! DO t=tmin_sim2+1, tmax_sim2, 4
!
!     !! WITH TIME AGGREGATION CORRECTION
!     ! entry into unemployment
!     IF (duration_sim(t)>=0 .AND. duration_sim(t)<4    ) duration2(0)=duration2(0)+1.0_8
!     ! seen unemployed 1 months later
!     IF (duration_sim(t)>=4 .AND. duration_sim(t)<8    ) duration2(1)=duration2(1)+1.0_8
!     ! 4 months unemployed
!     IF (duration_sim(t)>=16 .AND. duration_sim(t)<20    ) duration2(2)=duration2(2)+1.0_8
!     ! 8 months unemployed, 12, 16, 20, 24 months unemployed
!     IF (duration_sim(t)>=32 .AND. duration_sim(t)<36    ) duration2(3)=duration2(3)+1.0_8
!     IF (duration_sim(t)>=48 .AND. duration_sim(t)<52    ) duration2(4)=duration2(4)+1.0_8
!     IF (duration_sim(t)>=64 .AND. duration_sim(t)<68    ) duration2(5)=duration2(5)+1.0_8
!     IF (duration_sim(t)>=80 .AND. duration_sim(t)<84    ) duration2(6)=duration2(6)+1.0_8
!     IF (duration_sim(t)>=96 .AND. duration_sim(t)<100    )duration2(7)=duration2(7)+1.0_8
!
!     ! young workers with time aggregation
!     IF(age_sim(t)<youngcutoff) THEN
!             IF (duration_sim(t)>=0 .AND. duration_sim(t)<4    ) duration2_young(0)=duration2_young(0)+1.0_8
!             IF (duration_sim(t)>=4 .AND. duration_sim(t)<8    )duration2_young(1)=duration2_young(1)+1.0_8
!             ! seen unemployed 4 months later
!             IF (duration_sim(t)>=16 .AND. duration_sim(t)<20    ) duration2_young(2)=duration2_young(2)+1.0_8
!             IF (duration_sim(t)>=32 .AND. duration_sim(t)<36    ) duration2_young(3)=duration2_young(3)+1.0_8
!             IF (duration_sim(t)>=48 .AND. duration_sim(t)<52    ) duration2_young(4)=duration2_young(4)+1.0_8
!             IF (duration_sim(t)>=64 .AND. duration_sim(t)<68    ) duration2_young(5)=duration2_young(5)+1.0_8
!             IF (duration_sim(t)>=80 .AND. duration_sim(t)<84    ) duration2_young(6)=duration2_young(6)+1.0_8
!             IF (duration_sim(t)>=96 .AND. duration_sim(t)<100    ) duration2_young(7)=duration2_young(7)+1.0_8
!
!     END IF
!
!     ! prime age workers with time aggregation
!
!     IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN
!         IF (duration_sim(t)>=0 .AND. duration_sim(t)<4    ) duration2_prime(0)=duration2_prime(0)+1.0_8
!         IF (duration_sim(t)>=4 .AND. duration_sim(t)<8    )  duration2_prime(1)=duration2_prime(1)+1.0_8
!         ! seen unemployed 4 months later
!         IF (duration_sim(t)>=16 .AND. duration_sim(t)<20    ) duration2_prime(2)=duration2_prime(2)+1.0_8
!         IF (duration_sim(t)>=32 .AND. duration_sim(t)<36    ) duration2_prime(3)=duration2_prime(3)+1.0_8
!         IF (duration_sim(t)>=48 .AND. duration_sim(t)<52    ) duration2_prime(4)=duration2_prime(4)+1.0_8
!         IF (duration_sim(t)>=64 .AND. duration_sim(t)<68    ) duration2_prime(5)=duration2_prime(5)+1.0_8
!         IF (duration_sim(t)>=80 .AND. duration_sim(t)<84    ) duration2_prime(6)=duration2_prime(6)+1.0_8
!         IF (duration_sim(t)>=96 .AND. duration_sim(t)<100    ) duration2_prime(7)=duration2_prime(7)+1.0_8
!     END IF
!
!
!         IF(duration_sim(t)>0 .AND. duration_sim(t)<5) ult5wk=ult5wk+1.0_8
!         IF(duration_sim(t)>=5 .AND. duration_sim(t)<15) u5lt15wk=u5lt15wk+1.0_8
!         IF(duration_sim(t)>=15 .AND. duration_sim(t)<27) u15lt27wk=u15lt27wk+1.0_8
!         IF(duration_sim(t)>=27) ugt27wk=ugt27wk+1.0_8
!
! END DO
!

!!!===========================================================
!!!------------------------------------------------
!!! EMPLOYMENT DURATIONS AND SEPARATION RATES WITHIN THE FIRST YEAR OF HIRING &  SUBSEQUENT OCC MOB
!!!------------------------------------------------
!!!============================================================

! SEPARATIONS WITHIN THE FIRST 1-12 MONTHS OF AN EMPLOYED WORKER

oneyear_future_sep_do: &
DO t=MAX(tmin_sim2+8,8), tmax_sim2-52, 4
    IF (unempdur_estatus(t/4)==0 .AND. age_sim(t)>8 .AND. mask_qtr(t/12)==.true.) THEN
                    ! currently employed
    ! everybody who is at least one more year in sample
    IF(age_sim(t+48)==age_sim(t)+48 ) THEN
        sep_ave_m_counter=sep_ave_m_counter+1
        IF(unempdur_estatus((t+4)/4)>=1) THEN
            sep_ave_1m=sep_ave_1m+1.0_8
            sep_ave_2m=sep_ave_2m+1.0_8
            sep_ave_3m=sep_ave_3m+1.0_8
            sep_ave_4m=sep_ave_4m+1.0_8
            sep_ave_5m=sep_ave_5m+1.0_8
            sep_ave_6m=sep_ave_6m+1.0_8
            sep_ave_7m=sep_ave_7m+1.0_8
            sep_ave_8m=sep_ave_8m+1.0_8
            sep_ave_9m=sep_ave_9m+1.0_8
            sep_ave_10m=sep_ave_10m+1.0_8
            sep_ave_11m=sep_ave_11m+1.0_8
            sep_ave_12m=sep_ave_12m+1.0_8
        ELSE
            IF(unempdur_estatus((t+8)/4)>=1) THEN
            sep_ave_2m=sep_ave_2m+1.0_8
                sep_ave_3m=sep_ave_3m+1.0_8
                sep_ave_4m=sep_ave_4m+1.0_8
                sep_ave_5m=sep_ave_5m+1.0_8
                sep_ave_6m=sep_ave_6m+1.0_8
                sep_ave_7m=sep_ave_7m+1.0_8
                sep_ave_8m=sep_ave_8m+1.0_8
                sep_ave_9m=sep_ave_9m+1.0_8
                sep_ave_10m=sep_ave_10m+1.0_8
                sep_ave_11m=sep_ave_11m+1.0_8
                sep_ave_12m=sep_ave_12m+1.0_8
            ELSE
                IF(unempdur_estatus((t+12)/4)>=1) THEN
                    sep_ave_3m=sep_ave_3m+1.0_8
                    sep_ave_4m=sep_ave_4m+1.0_8
                    sep_ave_5m=sep_ave_5m+1.0_8
                    sep_ave_6m=sep_ave_6m+1.0_8
                    sep_ave_7m=sep_ave_7m+1.0_8
                    sep_ave_8m=sep_ave_8m+1.0_8
                    sep_ave_9m=sep_ave_9m+1.0_8
                    sep_ave_10m=sep_ave_10m+1.0_8
                    sep_ave_11m=sep_ave_11m+1.0_8
                    sep_ave_12m=sep_ave_12m+1.0_8
                ELSE
                    IF(unempdur_estatus((t+16)/4)>=1) THEN
                            sep_ave_4m=sep_ave_4m+1.0_8
                            sep_ave_5m=sep_ave_5m+1.0_8
                            sep_ave_6m=sep_ave_6m+1.0_8
                            sep_ave_7m=sep_ave_7m+1.0_8
                            sep_ave_8m=sep_ave_8m+1.0_8
                            sep_ave_9m=sep_ave_9m+1.0_8
                            sep_ave_10m=sep_ave_10m+1.0_8
                            sep_ave_11m=sep_ave_11m+1.0_8
                            sep_ave_12m=sep_ave_12m+1.0_8
                        ELSE
                            IF(unempdur_estatus((t+20)/4)>=1) THEN
                                sep_ave_5m=sep_ave_5m+1.0_8
                                sep_ave_6m=sep_ave_6m+1.0_8
                                sep_ave_7m=sep_ave_7m+1.0_8
                                sep_ave_8m=sep_ave_8m+1.0_8
                                sep_ave_9m=sep_ave_9m+1.0_8
                                sep_ave_10m=sep_ave_10m+1.0_8
                                sep_ave_11m=sep_ave_11m+1.0_8
                                sep_ave_12m=sep_ave_12m+1.0_8
                            ELSE
                                IF(unempdur_estatus((t+24)/4)>=1) THEN
                                    sep_ave_6m=sep_ave_6m+1.0_8
                                    sep_ave_7m=sep_ave_7m+1.0_8
                                    sep_ave_8m=sep_ave_8m+1.0_8
                                    sep_ave_9m=sep_ave_9m+1.0_8
                                    sep_ave_10m=sep_ave_10m+1.0_8
                                    sep_ave_11m=sep_ave_11m+1.0_8
                                    sep_ave_12m=sep_ave_12m+1.0_8
                                ELSE
                                    IF(unempdur_estatus((t+28)/4)>=1) THEN
                                        sep_ave_7m=sep_ave_7m+1.0_8
                                        sep_ave_8m=sep_ave_8m+1.0_8
                                        sep_ave_9m=sep_ave_9m+1.0_8
                                        sep_ave_10m=sep_ave_10m+1.0_8
                                        sep_ave_11m=sep_ave_11m+1.0_8
                                        sep_ave_12m=sep_ave_12m+1.0_8
                                    ELSE
                                        IF(unempdur_estatus((t+32)/4)>=1) THEN
                                            sep_ave_8m=sep_ave_8m+1.0_8
                                            sep_ave_9m=sep_ave_9m+1.0_8
                                            sep_ave_10m=sep_ave_10m+1.0_8
                                            sep_ave_11m=sep_ave_11m+1.0_8
                                            sep_ave_12m=sep_ave_12m+1.0_8
                                        ELSE
                                            IF(unempdur_estatus((t+36)/4)>=1) THEN
                                                    sep_ave_9m=sep_ave_9m+1.0_8
                                                    sep_ave_10m=sep_ave_10m+1.0_8
                                                    sep_ave_11m=sep_ave_11m+1.0_8
                                                    sep_ave_12m=sep_ave_12m+1.0_8
                                                ELSE
                                                    IF(unempdur_estatus((t+40)/4)>=1) THEN
                                                        sep_ave_10m=sep_ave_10m+1.0_8
                                                        sep_ave_11m=sep_ave_11m+1.0_8
                                                        sep_ave_12m=sep_ave_12m+1.0_8
                                                    ELSE
                                                       IF(unempdur_estatus((t+44)/4)>=1) THEN
                                                                sep_ave_11m=sep_ave_11m+1.0_8
                                                                sep_ave_12m=sep_ave_12m+1.0_8
                                                        ELSE
                                                              IF(unempdur_estatus((t+48)/4)>=1) THEN
                                                                sep_ave_12m=sep_ave_12m+1.0_8
                                                                END IF
                                                        END IF

                                                    END IF
                                                END IF
                                        END IF
                                    END IF

                                END IF

                            END IF

                        END IF

                    END IF
                END IF
            END IF
        END IF
    END IF
    END DO oneyear_future_sep_do

!==================================
! SEPARATIONS ONE YEAR AFTER HIRING

    oneyear_future_sep_do_afterhire: &
DO t=MAX(tmin_sim2+8,8), tmax_sim2-52, 4
    IF (unempdur_estatus(t/4)==0 .AND. unempdur_estatus((t-4)/4)>=1 .AND. age_sim(t)>8 .AND. mask_qtr(t/12)==.true.) THEN
                    ! newly hired from recorded unemployment
    ! everybody who is at least one more year in sample
    IF(age_sim(t+48)==age_sim(t)+48) THEN
        sep_ave_m_posthire_counter=sep_ave_m_posthire_counter+1
        IF(unempdur_estatus((t+4)/4)>=1) THEN
            sep_ave_1m_posthire=sep_ave_1m_posthire+1.0_8
            sep_ave_2m_posthire=sep_ave_2m_posthire+1.0_8
            sep_ave_3m_posthire=sep_ave_3m_posthire+1.0_8
            sep_ave_4m_posthire=sep_ave_4m_posthire+1.0_8
            sep_ave_5m_posthire=sep_ave_5m_posthire+1.0_8
            sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
            sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
            sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
            sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
            sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
            sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
            sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
        ELSE
            IF(unempdur_estatus((t+8)/4)>=1) THEN
                sep_ave_2m_posthire=sep_ave_2m_posthire+1.0_8
                sep_ave_3m_posthire=sep_ave_3m_posthire+1.0_8
                sep_ave_4m_posthire=sep_ave_4m_posthire+1.0_8
                sep_ave_5m_posthire=sep_ave_5m_posthire+1.0_8
                sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
                sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
            ELSE
                IF(unempdur_estatus((t+12)/4)>=1) THEN
                    sep_ave_3m_posthire=sep_ave_3m_posthire+1.0_8
                    sep_ave_4m_posthire=sep_ave_4m_posthire+1.0_8
                    sep_ave_5m_posthire=sep_ave_5m_posthire+1.0_8
                    sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
                    sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                    sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                    sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                    sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                    sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                    sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                ELSE
                    IF(unempdur_estatus((t+16)/4)>=1) THEN
                        sep_ave_4m_posthire=sep_ave_4m_posthire+1.0_8
                            sep_ave_5m_posthire=sep_ave_5m_posthire+1.0_8
                            sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
                            sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                            sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                            sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                            sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                            sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                            sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                        ELSE
                            IF(unempdur_estatus((t+20)/4)>=1) THEN
                                sep_ave_5m_posthire=sep_ave_5m_posthire+1.0_8
                                sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
                                sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                                sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                                sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                                sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                            ELSE
                                IF(unempdur_estatus((t+24)/4)>=1) THEN
                                    sep_ave_6m_posthire=sep_ave_6m_posthire+1.0_8
                                    sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                                    sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                                    sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                                    sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                    sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                    sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                ELSE
                                    IF(unempdur_estatus((t+28)/4)>=1) THEN
                                        sep_ave_7m_posthire=sep_ave_7m_posthire+1.0_8
                                        sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                                        sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                                        sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                        sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                        sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                    ELSE
                                        IF(unempdur_estatus((t+32)/4)>=1) THEN
                                            sep_ave_8m_posthire=sep_ave_8m_posthire+1.0_8
                                            sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                                            sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                            sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                            sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                        ELSE
                                            IF(unempdur_estatus((t+36)/4)>=1) THEN
                                                    sep_ave_9m_posthire=sep_ave_9m_posthire+1.0_8
                                                    sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                                    sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                                    sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                                ELSE
                                                    IF(unempdur_estatus((t+40)/4)>=1) THEN
                                                        sep_ave_10m_posthire=sep_ave_10m_posthire+1.0_8
                                                        sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                                        sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                                    ELSE
                                                        IF(unempdur_estatus((t+44)/4)>=1) THEN
                                                                sep_ave_11m_posthire=sep_ave_11m_posthire+1.0_8
                                                                sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                                        ELSE
                                                                IF(unempdur_estatus((t+48)/4)>=1) THEN
                                                                sep_ave_12m_posthire=sep_ave_12m_posthire+1.0_8
                                                                END IF
                                                        END IF

                                                    END IF
                                                END IF
                                        END IF
                                    END IF

                                END IF

                            END IF

                        END IF

                    END IF
                END IF
            END IF
        END IF
    END IF
    END DO oneyear_future_sep_do_afterhire

!=========
! SEPARATIONS IN FIRST YEAR, SUBSEQUENT MOBILITY
!=========
DO t=MAX(tmin_sim2+1,2), tmax_sim2-8, 4

    !================
    ! employment recorded within first year
    IF ((e_sim(t)==1 .AND. e_duration_sim(t)<48) .OR.  & ! employed, in the first year of employment
            (e_sim(t-4)==1 .AND. e_duration_sim(t-4)<44 .AND. (e_sim(t-3)==1 .OR. e_sim(t-2)==1 .OR. e_sim(t-1)==1) )) THEN ! STILL COUNTED AS EMPLOYED                                     ! unemployed in the week of measurement, but not long enough to be counted
                    !(sets out eligible employment for the denominator)

        IF(occmob_ind(t)==3 .OR. (occmob_ind(t-4)==3 .AND. e_sim(t)==0) ) THEN                 ! occ change before

            ! BASELINE: EMPLOYMENT IN DENOMINATOR
            sepocc_ave_counter=sepocc_ave_counter+1.0_8
            IF(age_sim(t)<youngcutoff) sepocc_y_ave_counter=sepocc_y_ave_counter+1.0_8
            IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) sepocc_p_ave_counter=sepocc_p_ave_counter+1.0_8

            ! SEPARATION
            IF (e_sim(t+1)==0 .AND. e_sim(t+2)==0 .AND. e_sim(t+3)==0 .AND. e_sim(t+4)==0 )   THEN                  ! lost job within the month
                sepocc_ave=sepocc_ave+1.0_8
                IF(age_sim(t)<youngcutoff) sepocc_y_ave=sepocc_y_ave+1.0_8
                IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) sepocc_p_ave=sepocc_p_ave+1.0_8
            END IF



        ELSE IF (occmob_ind(t)==4 .OR. (occmob_ind(t-4)==4 .AND. e_sim(t)==0)) THEN


            sepnocc_ave_counter=sepnocc_ave_counter+1.0_8
            IF(age_sim(t)<youngcutoff) sepnocc_y_ave_counter=sepnocc_y_ave_counter+1.0_8
            IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) sepnocc_p_ave_counter=sepnocc_p_ave_counter+1.0_8

            ! SEPARATION
            IF (e_sim(t+1)==0 .AND. e_sim(t+2)==0 .AND. e_sim(t+3)==0 .AND. e_sim(t+4)==0 ) THEN
                sepnocc_ave=sepnocc_ave+1.0_8
                IF(age_sim(t)<youngcutoff) sepnocc_y_ave=sepnocc_y_ave+1.0_8
                IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) sepnocc_p_ave=sepnocc_p_ave+1.0_8
            END IF
        END IF
    END IF

    !========================
    ! employment durations

    IF(e_duration_sim(t)>0 .AND. (e_duration_sim(t)-(e_duration_sim(t)/16)*16)<4) THEN                      !! only in the 1st, 5th, 9th months etc.
        IF(t-e_duration_sim(t)>0.0_8) THEN              ! just to make sure that the indices do not cause a crash
            !weeks mapping into indicators in empduration 0: 1-16, 1:17-32, etc. 6:97-112, 7:113+
            IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)<=112)  empduration_nocc((e_duration_sim(t)-1)/16)=empduration_nocc((e_duration_sim(t)-1)/16)+1.0
            IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)>112)   empduration_nocc(7)=empduration_nocc(7)+1.0
            IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)<=112) empduration_occ((e_duration_sim(t)-1)/16)=empduration_occ((e_duration_sim(t)-1)/16)+1.0
            IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)>112)  empduration_occ(7)=empduration_nocc(7)+1.0

            ! employment hazards with age
            IF(age_sim(t)<youngcutoff) THEN    ! young guy
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)<=112)  empduration_nocc_y((e_duration_sim(t)-1)/16)=empduration_nocc_y((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)>112)   empduration_nocc_y(7)=empduration_nocc_y(7)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)<=112) empduration_occ_y((e_duration_sim(t)-1)/16)=empduration_occ_y((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)>112)  empduration_occ_y(7)=empduration_nocc_y(7)+1.0
            ELSE IF (age_sim(t)>lowcutoff .AND. age_sim(t)<highcutoff) THEN ! prime guy
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)<=112)  empduration_nocc_p((e_duration_sim(t)-1)/16)=empduration_nocc_p((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)>112)   empduration_nocc_p(7)=empduration_nocc_p(7)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)<=112) empduration_occ_p((e_duration_sim(t)-1)/16)=empduration_occ_p((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)>112)  empduration_occ_p(7)=empduration_nocc_p(7)+1.0
            END IF

            ! employment hazards with previous unemployment spell
            IF(duration_sim(t-e_duration_sim(t))>0 .AND. duration_sim(t-e_duration_sim(t))<4) THEN    ! unemployed for less than 4 months
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)<=112)  empduration_nocc_shuspell((e_duration_sim(t)-1)/16)=empduration_nocc_shuspell((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)>112)   empduration_nocc_shuspell(7)=empduration_nocc_shuspell(7)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)<=112) empduration_occ_shuspell((e_duration_sim(t)-1)/16)=empduration_occ_shuspell((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)>112)  empduration_occ_shuspell(7)=empduration_nocc_shuspell(7)+1.0
            ELSE IF(duration_sim(t-e_duration_sim(t))>=4 .AND. duration_sim(t-e_duration_sim(t))<8) THEN    ! unemployed for more than 4 months, less than 8
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)<=112)  empduration_nocc_luspell((e_duration_sim(t)-1)/16)=empduration_nocc_luspell((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))>0 .AND. e_duration_sim(t)>112)   empduration_nocc_luspell(7)=empduration_nocc_luspell(7)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)<=112) empduration_occ_luspell((e_duration_sim(t)-1)/16)=empduration_occ_luspell((e_duration_sim(t)-1)/16)+1.0
                IF(hcten_sim(t-e_duration_sim(t))==0 .AND. e_duration_sim(t)>112)  empduration_occ_luspell(7)=empduration_nocc_luspell(7)+1.0
            END IF
        END IF
    END IF
END DO






!!!------------------------------------------------
!!! WRITING DOWN THE SIMULATIONS
!!!------------------------------------------------


threadno_if2: IF (threadnumber==1) THEN
IF(workerhistory_sim==1) THEN
!
!
!
    DO t=tmin_sim2+1,MIN(tmax_sim2, tmin_sim2+4800)
!
        !WHEN ARE THINGS RECORDED
        flag1=0
        IF ((i==nsim_gen/2 .OR. i==nsim_gen .OR. i<4) .AND. counter2==1) flag1=1
        IF (t<tmin_sim2+36 .AND. counter2==1 .AND. i<MIN(300, nsim_gen)) flag1=1
!
        history_if1: IF(flag1==1) THEN
!
!
        IF ((t==tmin_sim2+1 .AND. i==1).OR. (i<4 .AND. occmob_ind(t)>0 .AND. occmob_ind(MAX(t-1,1))==0 )) THEN
            write(14, FMT='(3(A6,A1), A4, A1)', ADVANCE='NO') 't', ',' ,'i', ',', 'age', ';', 'cocc', ','
            write(14, FMT='(5(A4,A1), A4, A1, 3(A7, A1))', ADVANCE='NO') 'esim', '|', 'isim', '|', 'hctn', '|', 'hind', '|', 'udur', '|', &
            'wage', '|', 'd_u_mon', '|', 'd_v_mon', '|', 'prod', '|'
            write(14, FMT='(3(A7, A1))', ADVANCE='NO') 'd_jf_mn', '|', 'd_sep_m', '|', 'd_prod', '|'
            write(14, FMT='(1(A7, A1))', ADVANCE='NO') ' test  ', '|'
!
            write(14, FMT='(3(A7, A1))', ADVANCE='NO') ' cocc  ', '|', 'cocc y', '|', 'cocc p ','|'
            write(14, FMT='(3(A7, A1))', ADVANCE='NO') 'cinf ', '|', 'cinf y   ', '|', 'cinf p ','|'
            write(14, FMT='(2(A7, A1))', ADVANCE='NO') 'pocc ', '|', 'pnocc   ', '|'
            write(14, FMT='(3(A7, A1))', ADVANCE='NO') ' nocc  ', '|', 'nocc y', '|', 'nocc p ','|'
            write(14, FMT='(3(A7, A1))', ADVANCE='NO') 'ninf ', '|', 'ninf y   ', '|', 'ninf p ','|'
!
            write(14, FMT='(2(A7, A1))', ADVANCE='NO') 'u_young', '|', 'u_prime', '|'
            write(14, FMT='(2(A7, A1))', ADVANCE='NO') 'no. yng', '|', 'no.prim', '|'
            write(14, FMT='(A3)', ADVANCE='NO') '|-|'
            write(14, FMT='(2(A7, A1))', ADVANCE='NO') 'islprod', '|', 'low isl', '|'
            write(14, FMT='(6(A7, A1))', ADVANCE='NO') 'sepprob', '|', 'jfprob', '|', 'zprob', '|', 'd_u_mn', '|', 'd_v_mn', '|', 'd_re_mn', '|'
            write(14, FMT='(3(A7, A1))') 'jf', '|', 'poliDW', '|', 'poliR', '|'
        END IF
!
        IF (t==tmin_sim2+1) write(14,*) '===================', i, '======================='
        IF ((t-tmin_sim2)/160*160-(t-tmin_sim2)==0) write(14,*) '----------------------------------------------'
        write(14, FMT='(3(I6,A1), I4, A1)', ADVANCE='NO') t, ',' ,i, ',' , age_sim(t), ';', occmob_ind(t), ','
        write(14, FMT='(5(I4,A1), F4.2, A1, 3(F7.1, A1))', ADVANCE='NO') e_sim(t), '|', island_sim(t), '|', hcten_sim(t), '|', hcind_sim(t), '|', duration_sim(t), '|', &
            wage_sim(t), '|', data_u_qtr((t-tmin_sim2)/12+1), '|', data_v_qtr((t-tmin_sim2)/12+1), '|', prod(aggprod_ind(t), MAX(hcind_sim(t),1), island_sim(t)), '|'
        write(14, FMT='(3(F7.2, A1))', ADVANCE='NO') data_jf_qtr((t-tmin_sim2)/12+1), '|', data_sep_qtr((t-tmin_sim2)/12+1), '|', data_prod_qtr((t-tmin_sim2)/12+1),'|'
        !write(14, FMT='(1(F7.0, A1))', ADVANCE='NO') data_temp_qtr((t-tmin_sim2)/12+1),  '|'        ! test variable, e.g. for repeat mobility
        write(14, FMT='(3(F7.0, A1))', ADVANCE='NO') data_cocc_qtr((t-tmin_sim2)/12+1), '|', data_cocc_young_qtr((t-tmin_sim2)/12+1), '|', data_cocc_prime_qtr((t-tmin_sim2)/12+1),'|'
        write(14, FMT='(3(F7.0, A1))', ADVANCE='NO') data_cocc_inflow_qtr((t-tmin_sim2)/12+1),'|', data_cocc_young_inflow_qtr((t-tmin_sim2)/12+1), '|', data_cocc_prime_inflow_qtr((t-tmin_sim2)/12+1),'|'
        write(14, FMT='(2(F7.0, A1))', ADVANCE='NO') data_pocc_qtr((t-tmin_sim2)/12+1),'|', data_pnocc_qtr((t-tmin_sim2)/12+1), '|'
        write(14, FMT='(3(F7.0, A1))', ADVANCE='NO') data_nocc_qtr((t-tmin_sim2)/12+1), '|', data_nocc_young_qtr((t-tmin_sim2)/12+1), '|', data_nocc_prime_qtr((t-tmin_sim2)/12+1),'|'
        write(14, FMT='(3(F7.0, A1))', ADVANCE='NO') data_nocc_inflow_qtr((t-tmin_sim2)/12+1),'|', data_nocc_young_inflow_qtr((t-tmin_sim2)/12+1), '|', data_nocc_prime_inflow_qtr((t-tmin_sim2)/12+1),'|'
!
        write(14, FMT='(2(F7.0, A1))', ADVANCE='NO') data_u_young_qtr((t-tmin_sim2)/12+1), '|', data_u_prime_qtr((t-tmin_sim2)/12+1), '|'
        write(14, FMT='(2(F7.0, A1))', ADVANCE='NO') data_young_qtr((t-tmin_sim2)/12+1), '|', data_prime_qtr((t-tmin_sim2)/12+1), '|'
!
        write(14, FMT='(A3)', ADVANCE='NO') '|-|'
!
!        IF(restricted_search_ind==1) THEN
!        IF(max_chosen_islands==0) WRITE(*,*) 'ERROR: ***** max_chosen_islands: illegal value*******'
!
!        IF(max_chosen_islands==0) WRITE(59,*) 'ERROR: ***** max_chosen_islands: illegal value*******'
!
!        IF(best_islands(max_chosen_islands, t)>=1 .AND. best_islands(max_chosen_islands, t)<=maxislands) THEN
!            write(14, FMT='(2(F7.4, A1))', ADVANCE='NO') zvector(islandprod_ind(island_sim(t),t)), '|', zvector(islandprod_ind(best_islands(max_chosen_islands, t),t)), '|'
!        ELSE
!            WRITE(59,*) 'error 71: best_islands, line 4165, best_islands(max_chosen_islands, t)=', best_islands(max_chosen_islands, t)
!            WRITE(59,*) '     at max_chosen_islands=', max_chosen_islands, ' and t=', t
!        END IF
!        END IF

        write(14, FMT='(3(F7.4, A1))', ADVANCE='NO') sepprobs(t),'|', jprobs(t), '|', zprobs(t),'|'
        write(14, FMT='(A3)') '|-|'
!++++++++++++++
    END IF history_if1
    END DO
!
END IF
END IF threadno_if2 !(threadnumber==1)






    !!!-----------------------------------------------------
    !!!  LOOP FOR EVERY SIMULATED PERSON UNTIL THE nsim_gen, max_gen is reached
    !!!-----------------------------------------------------

!WRITE(*,*) 'i=', i
END DO nsim_do
!CLOSE(55)
END DO gen_do

 threadno_if3: IF (threadnumber==1) THEN
 IF(workerhistory_sim==1) THEN
     CLOSE(unit=14)
 END IF
    END IF threadno_if3

!!!***************************************************************************************************************************





!IF (threadnumber==1) THEN
!OPEN(unit=94, file='monthly_series_nonnormalized.txt', status='replace', form='formatted')
!DO t=1, tmax_sim2
!WRITE(94, FMT='(I3, A1, 3(F11.4, A1))', ADVANCE='NO') aggprod_ind(t), '|', data_prod_qtr(t), '|', data_u_qtr(t), '|', data_v_qtr(t), '|'
!WRITE(94, FMT='(I3, A1, 3(F11.4, A1))') aggprod_ind(t), '|', data_prod_qtr(t)/(number_agents(t)-data_u_qtr(t)), '|', data_u_qtr(t)/number_agents(t), '|', data_v_qtr(t)/number_agents(t), '|'
!END DO
!CLOSE(94)
!END IF !(threadnumber==1)
!
!IF (threadnumber==1) THEN
!OPEN(unit=81, file='island_series_nonnormalized.txt', status='replace', form='formatted')
!DO zcnt=1, zpts
!WRITE(81, FMT='(I3, A1, 6(A11, A1))', ADVANCE='no') zcnt, '|', ' island_e1 ', '|', ' island_e2 ', '|', ' island_e3 ', '|', ' island_u1 ','|', ' island_u3 ','|', ' island_u3 ','|'
!END DO

!counter1=1
!counter2=2000
!
!DO t=counter1, counter2
!DO zcnt=1, zpts
!WRITE(81, FMT='(I3, A1, 3(F11.4, A1))', ADVANCE='NO') zcnt, '|', island_employment(zcnt,1,t), '|', &
!island_employment(zcnt,2,t), '|', island_employment(zcnt,3,t), '|'
!WRITE(81, FMT='(3(F11.4, A1))', ADVANCE='NO')  island_unemployment(zcnt,1, t), '|',&
!island_unemployment(zcnt,2, t), '|',island_unemployment(zcnt,3, t), '|'
!!WRITE(81, FMT='(I3, A1, 3(F11.4, A1))', ADVANCE='NO') aggprod_ind(t), '|', data_prod_qtr(t)/(number_agents(t)-data_u_qtr(t)), '|', data_u_qtr(t)/number_agents(t), '|', data_v_qtr(t)/number_agents(t), '|'
!END DO
!WRITE(81,FMT='(A1)') '!'
!END DO
!
!IF(tmax_sim2>4000) THEN
!    counter1=tmax_sim2-2000
!    counter2=tmax_sim2
!END IF
!
!DO t=counter1, counter2
!DO zcnt=1, zpts
!WRITE(81, FMT='(I3, A1, 3(F11.4, A1))', ADVANCE='NO') zcnt, '|', island_employment(zcnt,1,t), '|', &
!island_employment(zcnt,2,t), '|', island_employment(zcnt,3,t), '|'
!WRITE(81, FMT='(3(F11.4, A1))', ADVANCE='NO')  island_unemployment(zcnt,1, t), '|',&
!island_unemployment(zcnt,2, t), '|',island_unemployment(zcnt,3, t), '|'
!!WRITE(81, FMT='(I3, A1, 3(F11.4, A1))', ADVANCE='NO') aggprod_ind(t), '|', data_prod_qtr(t)/(number_agents(t)-data_u_qtr(t)), '|', data_u_qtr(t)/number_agents(t), '|', data_v_qtr(t)/number_agents(t), '|'
!END DO
!WRITE(81,FMT='(A1)') '!'
!END DO
!
!CLOSE(81)
!END IF !(threadnumber==1)




!!!!========================================================================
!!! NORMALIZE SERIES, AND HP DETREND the appropriate time series
!!!=========================================================================



! U EARLIER EMPLOYMENT
        ! UNEMPLOYMENT RATE FOR THOSE WITH EARLIER EMPLOYMENT IN THE FIRST 4 WAVES, i.e. 16 months, OR IN THE SUBSEQUENT PERIOD UNTIL T.

        IF(earlier_e_counter>0) unemp_earlier_e_ave=unemp_earlier_e_ave/REAL(earlier_e_counter)
        IF(young_earlier_e_counter>0) u_earlier_e_young_ave=u_earlier_e_young_ave/REAL(young_earlier_e_counter)
        IF(prime_earlier_e_counter>0) u_earlier_e_prime_ave=u_earlier_e_prime_ave/REAL(prime_earlier_e_counter)



! U PROPORTION

IF(counter_u_window_all>0) uproportion_window=REAL(counter_u_window)/REAL(counter_u_window_all)
IF(counter_u_window_all_y>0) uproportion_window_y=REAL(counter_u_window_y)/REAL(counter_u_window_all_y)
IF(counter_u_window_all_p>0) uproportion_window_p=REAL(counter_u_window_p)/REAL(counter_u_window_all_p)

uoccproportion_window=REAL(counter_uocc_window)/REAL(counter_uocc_window_all)
unoccproportion_window=REAL(counter_unocc_window)/REAL(counter_unocc_window_all)


! SEPARATION PROFILE POST-HIRING
IF(sep_ave_m_counter>0) THEN
    sep_ave_1m=sep_ave_1m/REAL(sep_ave_m_counter)
    sep_ave_2m=sep_ave_2m/REAL(sep_ave_m_counter)
    sep_ave_3m=sep_ave_3m/REAL(sep_ave_m_counter)
    sep_ave_4m=sep_ave_4m/REAL(sep_ave_m_counter)
    sep_ave_5m=sep_ave_5m/REAL(sep_ave_m_counter)
    sep_ave_6m=sep_ave_6m/REAL(sep_ave_m_counter)
    sep_ave_7m=sep_ave_7m/REAL(sep_ave_m_counter)
    sep_ave_8m=sep_ave_8m/REAL(sep_ave_m_counter)
    sep_ave_9m=sep_ave_9m/REAL(sep_ave_m_counter)
    sep_ave_10m=sep_ave_10m/REAL(sep_ave_m_counter)
    sep_ave_11m=sep_ave_11m/REAL(sep_ave_m_counter)
    sep_ave_12m=sep_ave_12m/REAL(sep_ave_m_counter)
END IF

IF(sep_ave_m_posthire_counter>0) THEN
            sep_ave_1m_posthire=sep_ave_1m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_2m_posthire=sep_ave_2m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_3m_posthire=sep_ave_3m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_4m_posthire=sep_ave_4m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_5m_posthire=sep_ave_5m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_6m_posthire=sep_ave_6m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_7m_posthire=sep_ave_7m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_8m_posthire=sep_ave_8m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_9m_posthire=sep_ave_9m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_10m_posthire=sep_ave_10m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_11m_posthire=sep_ave_11m_posthire/REAL(sep_ave_m_posthire_counter)
            sep_ave_12m_posthire=sep_ave_12m_posthire/REAL(sep_ave_m_posthire_counter)
END IF

! WAGE DISPERSION

IF(logwage_all_counter>0) logwage_disp_all=((logwage_disp_all/REAL(logwage_all_counter))-(((logwage_ave_all)**2.0_8)/(REAL(logwage_all_counter)**2.0)))
IF(logwage_highoccten_counter>0) logwage_disp_highoccten=((logwage_disp_highoccten/(REAL(logwage_highoccten_counter)))-(((logwage_ave_highoccten)**2.0_8)/(REAL(logwage_highoccten_counter)**2.0_8)))
IF(logwage_uhires_counter>0) logwage_disp_uhires=((logwage_disp_uhires/REAL(logwage_uhires_counter))-(((logwage_ave_uhires)**2.0_8)/(REAL(logwage_uhires_counter)**2.0_8)))
IF(logwage_all_counter<=0) logwage_disp_all=0.0_8
IF(logwage_highoccten_counter<=0) logwage_disp_highoccten=0.0_8
IF(logwage_uhires_counter<=0) logwage_disp_uhires=0.0_8

logwage_disp_diff_all=logwage_disp_all-logwage_disp_uhires
logwage_disp_diff_highoccten=logwage_disp_highoccten-logwage_disp_uhires

! REPEAT SEPARATIONS
IF (sepocc_afternocc_2_5yr_counter>0) sepocc_afternocc_2_5yr=sepocc_afternocc_2_5yr/REAL(sepocc_afternocc_2_5yr_counter)
IF (sepocc_afternocc_2_5yr_counter>0) sepocc_afternocc_2_5yr_2m=sepocc_afternocc_2_5yr_2m/REAL(sepocc_afternocc_2_5yr_counter)
IF (sepocc_afternocc_2_5yr_counter==0 ) sepocc_afternocc_2_5yr=0.0_8
IF (sepnocc_afternocc_2_5yr_counter>0) sepnocc_afternocc_2_5yr=sepnocc_afternocc_2_5yr/REAL(sepnocc_afternocc_2_5yr_counter)
IF (sepnocc_afternocc_2_5yr_counter>0) sepnocc_afternocc_2_5yr_2m=sepnocc_afternocc_2_5yr_2m/REAL(sepnocc_afternocc_2_5yr_counter)
IF (sepnocc_afternocc_2_5yr_counter==0 ) sepnocc_afternocc_2_5yr=0.0_8
IF (sep_afternocc_2_5yr_counter>0) sep_afternocc_2_5yr=sep_afternocc_2_5yr/REAL(sep_afternocc_2_5yr_counter)
IF (sep_afternocc_2_5yr_counter==0 ) sep_afternocc_2_5yr=0.0_8


IF (returnstenure10ycounter>0) THEN
returnstenure10y=returnstenure10y/REAL(returnstenure10ycounter)
END IF

IF (returnstenure5ycounter>0) THEN
returnstenure5y=returnstenure5y/REAL(returnstenure5ycounter)
    END IF



IF (write_netmob_simul_test_ind==1 .OR. verbose_netmob_solve==.true.) THEN
    WRITE(*,*) 'occ distribution end of window'
    WRITE(*,*) corr_occdistr_begin_end(:,2)
END IF
!!===================================================
!! NET MOBILITY MOMENTS -- TIME AVERAGE
!!===================================================
DO tcnt=1,2
    tempreal=sum(occdistr_begin_end(:,tcnt))
    tempreal2=sum(corr_occdistr_begin_end(:,tcnt))
    occdistr_begin_end(:,tcnt)=occdistr_begin_end(:,tcnt)/tempreal
    corr_occdistr_begin_end(:,tcnt)=corr_occdistr_begin_end(:,tcnt)/tempreal2
    END DO

IF (verbose_netmob_solve) THEN
        ! flow matrix normalized
        tempreal=sum(data_corr_superocc_transmatrix(:,:))
        WRITE(*,*) 'spell observations occ trans through u: ', tempreal
        data_corr_superocc_transmatrix=data_corr_superocc_transmatrix/tempreal

        tempreal=sum(data_superocc_transmatrix(:,:))
        data_superocc_transmatrix=data_superocc_transmatrix/tempreal
        WRITE(*,*) 'double check', tempreal

        !! FLOW TRANSITION MATRICES WITH DURATION, NORMALIZED * 100
        tempreal=sum(data_corr_superocc_transmatrix_wdur(:,:,:))
        WRITE(*,*) 'obs occ trans through u with dur<=18m: ', tempreal
        data_corr_superocc_transmatrix_wdur=(data_corr_superocc_transmatrix_wdur/tempreal)*100

        tempreal=sum(data_superocc_transmatrix_wdur(:,:,:))
        WRITE(*,*) 'raw obs occ trans through u with dur<=18m: ', tempreal
        data_superocc_transmatrix_wdur=(data_superocc_transmatrix_wdur/tempreal)*100
END IF

!! ----------------
!!  NET, GROSS AND EXCESS MOBILITY
!! ----------------

!! NET MOBILITY CALCULATION
CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix, netmob_calc_vector)
CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix, corr_netmob_calc_vector)
!! GROSS MOBILITY
CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix, corr_grossmob_calc_vector)
CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix, grossmob_calc_vector)

overall_netmob=sum(abs(netmob_calc_vector(:)))/2.0
overall_grossmob=sum(abs(grossmob_calc_vector(:)))
overall_xsmob=overall_grossmob-overall_netmob

overall_corr_netmob=sum(abs(corr_netmob_calc_vector(:)))/2.0
overall_corr_grossmob=sum(abs(corr_grossmob_calc_vector(:)))
overall_corr_xsmob=overall_corr_grossmob-overall_corr_netmob

!! DATA
CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_data, netmob_calc_vector_data)
CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_data, corr_netmob_calc_vector_data)
!! GROSS MOBILITY
CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_data, corr_grossmob_calc_vector_data)
CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_data, grossmob_calc_vector_data)

overall_netmob_data=sum(abs(netmob_calc_vector_data(:)))/2.0
overall_grossmob_data=sum(abs(grossmob_calc_vector_data(:)))
overall_xsmob_data=overall_grossmob_data-overall_netmob_data

overall_corr_netmob_data=sum(abs(corr_netmob_calc_vector_data(:)))/2.0
overall_corr_grossmob_data=sum(abs(corr_grossmob_calc_vector_data(:)))
overall_corr_xsmob_data=overall_corr_grossmob_data-overall_corr_netmob_data

!!!! NET, GROSS AND EXCESS MOBILITY WITH DURATION

!! cumulative duration matrix
data_corr_superocc_ctransmatrix_wdur(:,:,18)=data_corr_superocc_transmatrix_wdur(:,:,18)
DO t=17,1,-1
    tempint=t+1
    data_corr_superocc_ctransmatrix_wdur(:,:,t)=data_corr_superocc_ctransmatrix_wdur(:,:,t)+data_corr_superocc_transmatrix_wdur(:,:,tempint)
END DO

data_superocc_ctransmatrix_wdur(:,:,18)=data_superocc_transmatrix_wdur(:,:,18)
DO t=17,1,-1
    tempint=t+1
    IF (sum(data_superocc_transmatrix_wdur(:,:, t))>0.0_8 .AND. &
        sum(data_superocc_transmatrix_wdur(:,:, t)) .eq. sum(data_superocc_transmatrix_wdur(:,:, t))) THEN
        data_superocc_ctransmatrix_wdur(:,:,t)=data_superocc_ctransmatrix_wdur(:,:,t)+data_superocc_transmatrix_wdur(:,:,tempint)
    ELSE
        data_superocc_ctransmatrix_wdur(:,:,t)=data_superocc_ctransmatrix_wdur(:,:,tempint)
    END IF
END DO


DO t=1,18


    !! NET MOBILITY CALCULATION
    data_superocc_temptransmatrix=data_superocc_ctransmatrix_wdur(:,:,t)
    CALL NETMOBILITY_CALC(occpts,data_superocc_temptransmatrix, netmobdur_calc_vector(:,t))
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_temptransmatrix, grossmobdur_calc_vector(:,t))
    data_superocc_temptransmatrix=data_corr_superocc_ctransmatrix_wdur(:,:,t)
    CALL NETMOBILITY_CALC(occpts,data_superocc_temptransmatrix, corr_netmobdur_calc_vector(:,t))
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_temptransmatrix, corr_grossmobdur_calc_vector(:,t))


    overall_netmobdur(t)=sum(abs(netmobdur_calc_vector(:,t)))/2.0
    overall_grossmobdur(t)=sum(abs(grossmobdur_calc_vector(:,t)))
    overall_xsmobdur(t)=overall_grossmobdur(t)-overall_netmobdur(t)

    overall_corr_netmobdur(t)=sum(abs(corr_netmobdur_calc_vector(:,t)))/2.0
    overall_corr_grossmobdur(t)=sum(abs(corr_grossmobdur_calc_vector(:,t)))
    overall_corr_xsmobdur(t)=overall_corr_grossmobdur(t)-overall_corr_netmobdur(t)
END DO


    !! MOBILITY WITHIN AND ACROSS SUPEROCCUPATIONS
DO t=1,occpts
    tempreal=sum(mobility_prop_within_supocc(t,:))
    mobility_prop_within_supocc(t,1)=mobility_prop_within_supocc(t,1)/tempreal
    mobility_prop_within_supocc(t,2)=mobility_prop_within_supocc(t,2)/tempreal

    tempreal=sum(corr_mobility_prop_within_supocc(t,:))
    corr_mobility_prop_within_supocc(t,1)=corr_mobility_prop_within_supocc(t,1)/tempreal
    corr_mobility_prop_within_supocc(t,2)=corr_mobility_prop_within_supocc(t,2)/tempreal
END DO





!!================================================================================
!! CALCULATING TIME SERIES
!!================================================================================

!! job finding and tightness
DO t=1,tmax_qtr
IF (data_u_qtr(t)>0.0_8 .AND. data_u_qtr(t)<nsim_gen*max_gen) THEN
    data_theta_qtr(t)=REAL(data_v_qtr(t))/REAL(data_u_qtr(t))
    data_jf_qtr(t)=REAL(data_jf_qtr(t))/REAL(data_u_qtr(t))
ELSE
    data_theta_qtr(t)=0.0_8
    data_jf_qtr(t)=0.0_8
END IF
END DO

!! cost of hiring
tot_costofhires=tot_costofhires/tot_hires

!! cost of reallocation
tot_reallcost=tot_reallcost/tot_realls


!! separation and productivity
DO t=1, tmax_qtr
    IF (data_e_qtr(t)>0.0_8) THEN
        data_sep_qtr(t)=data_sep_qtr(t)/(data_e_qtr(t))
    ELSE
        data_sep_qtr(t)=0.0_8
    END IF

    DO occcnt=1, occpts
    IF (data_supocc_e_qtr(occcnt, t)>0.0_8) THEN
        data_supocc_sep_qtr(occcnt, t)=data_supocc_sep_qtr(occcnt, t)/(data_supocc_e_qtr(occcnt, t))
    ELSE
        data_supocc_sep_qtr(occcnt, t)=0.0_8
    END IF
    END DO

    DO occcnt=1, occpts
        tempreal=data_supocc_e_qtr(occcnt, t)+data_supocc_u_qtr(occcnt, t)
    IF (tempreal>0.0_8) THEN
        data_supocc_u_qtr(occcnt, t)=data_supocc_u_qtr(occcnt, t)/tempreal
    ELSE
        data_supocc_u_qtr(occcnt, t)=0.0_8
    END IF
    END DO

     tempreal=sum(data_supocc_e_qtr(:, t))
    DO occcnt=1, occpts
        IF (tempreal>0.0_8) THEN
            data_supocc_e_qtr(occcnt, t)=data_supocc_e_qtr(occcnt, t)/tempreal
        ELSE
            data_supocc_e_qtr(occcnt, t)=0.0_8
        END IF
    END DO


    DO occcnt=1, occpts
    IF (REAL(data_supocc_udur_counter_qtr(occcnt, t))>0.0_8) THEN
        data_supocc_udur_qtr(occcnt, t)=data_supocc_udur_qtr(occcnt, t)/REAL(data_supocc_udur_counter_qtr(occcnt, t))
    ELSE
        data_supocc_udur_qtr(occcnt, t)=0.0_8
    END IF
    END DO



    IF (3.0_8*REAL(number_agents(t))-data_u_qtr(t)>0.0_8) THEN
        data_prod_qtr(t)=data_prod_qtr(t)/(data_e_qtr(t))
        data_wage_qtr(t)=data_wage_qtr(t)/(data_e_qtr(t))
    ELSE
        data_prod_qtr(t)=0.0_8
        data_wage_qtr(t)=0.0_8
    END IF
END DO

!! normalized by number of people (nsim)
!DO t=1,tmax_qtr
!    data_v_qtr(t)=data_v_qtr(t)/(3.0_8*REAL(number_agents(t)))
!END DO


!! separation and productivity
DO t=1, tmax_qtr
IF (data_e_young_qtr(t)>0) THEN
    data_sep_y_qtr(t)=data_sep_y_qtr(t)/(data_e_young_qtr(t))
ELSE
    data_sep_y_qtr(t)=0.0_8
END IF
END DO

DO t=1, tmax_qtr
IF (data_e_prime_qtr(t)>0.0_8) THEN
    data_sep_p_qtr(t)=data_sep_p_qtr(t)/(data_e_prime_qtr(t))
ELSE
    data_sep_p_qtr(t)=0.0_8
END IF
END DO



! jf, u of the young and prime aged
DO t=1, tmax_qtr

IF(data_u_young_qtr(t)>0.0) THEN
    data_jf_young_qtr(t)=REAL(data_jf_young_qtr(t))/REAL(data_u_young_qtr(t))
    data_u_young_qtr(t)=data_u_young_qtr(t)/(data_u_young_qtr(t)+data_e_young_qtr(t))
ELSE
    data_jf_young_qtr(t)=0.0_8
    data_u_young_qtr(t)=0.0_8
END IF



IF(data_u_prime_qtr(t)>0.0) THEN
    data_jf_prime_qtr(t)=REAL(data_jf_prime_qtr(t))/REAL(data_u_prime_qtr(t))
    data_u_prime_qtr(t)=data_u_prime_qtr(t)/(data_e_prime_qtr(t)+data_u_prime_qtr(t))
ELSE
    data_jf_prime_qtr(t)=0.0_8
    data_u_prime_qtr(t)=0.0_8
END IF

END DO



! normalized by the number of occ/nocc categorizable unemployed



        !===============
        ! repeat mobility

        tempreal=(REAL(tot_noccafterocc)+REAL(tot_occafterocc))
        IF (tempreal>0.0_8) tot_occafterocc=REAL(tot_occafterocc)/tempreal
        IF (tempreal>0.0_8) tot_noccafterocc=REAL(tot_noccafterocc)/tempreal

        tempreal=(REAL(tot_noccafterocc_y)+REAL(tot_occafterocc_y))
        IF (tempreal>0.0_8) tot_occafterocc_y=REAL(tot_occafterocc_y)/tempreal
        IF (tempreal>0.0_8) tot_noccafterocc_y=REAL(tot_noccafterocc_y)/tempreal

        tempreal=(REAL(tot_noccafterocc_p)+REAL(tot_occafterocc_p))
        IF (tempreal>0.0_8) tot_occafterocc_p=REAL(tot_occafterocc_p)/tempreal
        IF (tempreal>0.0_8) tot_noccafterocc_p=REAL(tot_noccafterocc_p)/tempreal

        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafterocc_vector(zcnt))+REAL(tot_occafterocc_vector(zcnt)))
            IF (tempreal>0.0_8) tot_occafterocc_vector(zcnt)=REAL(tot_occafterocc_vector(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafterocc_vector(zcnt)=REAL(tot_noccafterocc_vector(zcnt))/tempreal
        END DO
        ! young
        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafterocc_vector_young(zcnt))+REAL(tot_occafterocc_vector_young(zcnt)))
            IF (tempreal>0.0_8) tot_occafterocc_vector_young(zcnt)=REAL(tot_occafterocc_vector_young(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafterocc_vector_young(zcnt)=REAL(tot_noccafterocc_vector_young(zcnt))/tempreal
        END DO
        ! prime
        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafterocc_vector_prime(zcnt))+REAL(tot_occafterocc_vector_prime(zcnt)))
            IF (tempreal>0.0_8) tot_occafterocc_vector_prime(zcnt)=REAL(tot_occafterocc_vector_prime(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafterocc_vector_prime(zcnt)=REAL(tot_noccafterocc_vector_prime(zcnt))/tempreal
        END DO

        tempreal=(REAL(tot_corr_noccafterocc)+REAL(tot_corr_occafterocc))
        IF (tempreal>0.0_8) tot_corr_occafterocc=REAL(tot_corr_occafterocc)/tempreal
        IF (tempreal>0.0_8) tot_corr_noccafterocc=REAL(tot_corr_noccafterocc)/tempreal

        tempreal=(REAL(tot_corr_noccafterocc_y)+REAL(tot_corr_occafterocc_y))
        IF (tempreal>0.0_8) tot_corr_occafterocc_y=REAL(tot_corr_occafterocc_y)/tempreal
        IF (tempreal>0.0_8) tot_corr_noccafterocc_y=REAL(tot_corr_noccafterocc_y)/tempreal

        tempreal=(REAL(tot_corr_noccafterocc_p)+REAL(tot_corr_occafterocc_p))
        IF (tempreal>0.0_8) tot_corr_occafterocc_p=REAL(tot_corr_occafterocc_p)/tempreal
        IF (tempreal>0.0_8) tot_corr_noccafterocc_p=REAL(tot_corr_noccafterocc_p)/tempreal

        !! AFTER OCC STAY

        tempreal=(REAL(tot_noccafternocc)+REAL(tot_occafternocc))
        IF (tempreal>0.0_8) tot_noccafternocc=REAL(tot_noccafternocc)/tempreal
        IF (tempreal>0.0_8) tot_occafternocc=REAL(tot_occafternocc)/tempreal

        tempreal=(REAL(tot_noccafternocc_y)+REAL(tot_occafternocc_y))
        IF (tempreal>0.0_8) tot_noccafternocc_y=REAL(tot_noccafternocc_y)/tempreal
        IF (tempreal>0.0_8) tot_occafternocc_y=REAL(tot_occafternocc_y)/tempreal

        tempreal=(REAL(tot_noccafternocc_p)+REAL(tot_occafternocc_p))
        IF (tempreal>0.0_8) tot_noccafternocc_p=REAL(tot_noccafternocc_p)/tempreal
        IF (tempreal>0.0_8) tot_occafternocc_p=REAL(tot_occafternocc_p)/tempreal


        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafternocc_vector(zcnt))+REAL(tot_occafternocc_vector(zcnt)))
            IF (tempreal>0.0_8) tot_occafternocc_vector(zcnt)=REAL(tot_occafternocc_vector(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafternocc_vector(zcnt)=REAL(tot_noccafternocc_vector(zcnt))/tempreal
        END DO
        ! young
        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafternocc_vector_young(zcnt))+REAL(tot_occafternocc_vector_young(zcnt)))
            IF (tempreal>0.0_8) tot_occafternocc_vector_young(zcnt)=REAL(tot_occafternocc_vector_young(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafternocc_vector_young(zcnt)=REAL(tot_noccafternocc_vector_young(zcnt))/tempreal
        END DO
        ! prime
        DO zcnt=1, 4
            tempreal=(REAL(tot_noccafternocc_vector_prime(zcnt))+REAL(tot_occafternocc_vector_prime(zcnt)))
            IF (tempreal>0.0_8) tot_occafternocc_vector_prime(zcnt)=REAL(tot_occafternocc_vector_prime(zcnt))/tempreal
            IF (tempreal>0.0_8) tot_noccafternocc_vector_prime(zcnt)=REAL(tot_noccafternocc_vector_prime(zcnt))/tempreal
        END DO


        tempreal=(REAL(tot_corr_noccafternocc)+REAL(tot_corr_occafternocc))
        IF (tempreal>0.0_8) tot_corr_noccafternocc=REAL(tot_corr_noccafternocc)/tempreal
        IF (tempreal>0.0_8) tot_corr_occafternocc=REAL(tot_corr_occafternocc)/tempreal


        tempreal=(REAL(tot_corr_noccafternocc_y)+REAL(tot_corr_occafternocc_y))
        IF (tempreal>0.0_8) tot_corr_noccafternocc_y=REAL(tot_corr_noccafternocc_y)/tempreal
        IF (tempreal>0.0_8) tot_corr_occafternocc_y=REAL(tot_corr_occafternocc_y)/tempreal

        tempreal=(REAL(tot_corr_noccafternocc_p)+REAL(tot_corr_occafternocc_p))
        IF (tempreal>0.0_8) tot_corr_noccafternocc_p=REAL(tot_corr_noccafternocc_p)/tempreal
        IF (tempreal>0.0_8) tot_corr_occafternocc_p=REAL(tot_corr_occafternocc_p)/tempreal



        IF (stock_occafterocc>0.0_8) poccafterocc=REAL(poccafterocc)/REAL(stock_occafterocc)
        IF (stock_noccafterocc>0.0_8) pnoccafterocc=REAL(pnoccafterocc)/REAL(stock_noccafterocc)
        IF (stock_occafternocc>0.0_8) poccafternocc=REAL(poccafternocc)/REAL(stock_occafternocc)
        IF (stock_noccafternocc>0.0_8) pnoccafternocc=REAL(pnoccafternocc)/REAL(stock_noccafternocc)

        IF (stock_occafterocc_y>0.0_8) poccafterocc_y=REAL(poccafterocc_y)/REAL(stock_occafterocc_y)
        IF (stock_noccafterocc_y>0.0_8) pnoccafterocc_y=REAL(pnoccafterocc_y)/REAL(stock_noccafterocc_y)
        IF (stock_occafternocc_y>0.0_8) poccafternocc_y=REAL(poccafternocc_y)/REAL(stock_occafternocc_y)
        IF (stock_noccafternocc_y>0.0_8) pnoccafternocc_Y=REAL(pnoccafternocc_y)/REAL(stock_noccafternocc_y)

        IF (stock_occafterocc_p>0.0_8) poccafterocc_p=REAL(poccafterocc_p)/REAL(stock_occafterocc_p)
        IF (stock_noccafterocc_p>0.0_8) pnoccafterocc_p=REAL(pnoccafterocc_p)/REAL(stock_noccafterocc_p)
        IF (stock_occafternocc_p>0.0_8) poccafternocc_p=REAL(poccafternocc_p)/REAL(stock_occafternocc_p)
        IF (stock_noccafternocc_p>0.0_8) pnoccafternocc_p=REAL(pnoccafternocc_p)/REAL(stock_noccafternocc_p)

DO zcnt=1, 2
        IF (stock_occafterocc_uspell(zcnt)>0.0_8) poccafterocc_uspell(zcnt)=REAL(poccafterocc_uspell(zcnt))/REAL(stock_occafterocc_uspell(zcnt))
        IF (stock_noccafterocc_uspell(zcnt)>0.0_8) pnoccafterocc_uspell(zcnt)=REAL(pnoccafterocc_uspell(zcnt))/REAL(stock_noccafterocc_uspell(zcnt))
        IF (stock_occafternocc_uspell(zcnt)>0.0_8) poccafternocc_uspell(zcnt)=REAL(poccafternocc_uspell(zcnt))/REAL(stock_occafternocc_uspell(zcnt))
        IF (stock_noccafternocc_uspell(zcnt)>0.0_8) pnoccafternocc_uspell(zcnt)=REAL(pnoccafternocc_uspell(zcnt))/REAL(stock_noccafternocc_uspell(zcnt))

        IF (stock_occafterocc_y_uspell(zcnt)>0.0_8) poccafterocc_y_uspell(zcnt)=REAL(poccafterocc_y_uspell(zcnt))/REAL(stock_occafterocc_y_uspell(zcnt))
        IF (stock_noccafterocc_y_uspell(zcnt)>0.0_8) pnoccafterocc_y_uspell(zcnt)=REAL(pnoccafterocc_y_uspell(zcnt))/REAL(stock_noccafterocc_y_uspell(zcnt))
        IF (stock_occafternocc_y_uspell(zcnt)>0.0_8) poccafternocc_y_uspell(zcnt)=REAL(poccafternocc_y_uspell(zcnt))/REAL(stock_occafternocc_y_uspell(zcnt))
        IF (stock_noccafternocc_y_uspell(zcnt)>0.0_8) pnoccafternocc_y_uspell(zcnt)=REAL(pnoccafternocc_y_uspell(zcnt))/REAL(stock_noccafternocc_y_uspell(zcnt))

        IF (stock_occafterocc_p_uspell(zcnt)>0.0_8) poccafterocc_p_uspell(zcnt)=REAL(poccafterocc_p_uspell(zcnt))/REAL(stock_occafterocc_p_uspell(zcnt))
        IF (stock_noccafterocc_p_uspell(zcnt)>0.0_8) pnoccafterocc_p_uspell(zcnt)=REAL(pnoccafterocc_p_uspell(zcnt))/REAL(stock_noccafterocc_p_uspell(zcnt))
        IF (stock_occafternocc_p_uspell(zcnt)>0.0_8) poccafternocc_p_uspell(zcnt)=REAL(poccafternocc_p_uspell(zcnt))/REAL(stock_occafternocc_p_uspell(zcnt))
        IF (stock_noccafternocc_p_uspell(zcnt)>0.0_8) pnoccafternocc_p_uspell(zcnt)=REAL(pnoccafternocc_p_uspell(zcnt))/REAL(stock_noccafternocc_p_uspell(zcnt))

        noccafterocc_uspell(zcnt)=REAL(noccafterocc_uspell(zcnt))/REAL(noccafterocc_uspell(zcnt)+occafterocc_uspell(zcnt))
        noccafternocc_uspell(zcnt)=REAL(noccafternocc_uspell(zcnt))/REAL(noccafternocc_uspell(zcnt)+occafternocc_uspell(zcnt))
        occafterocc_uspell(zcnt)=1.0_8-noccafterocc_uspell(zcnt)
        occafternocc_uspell(zcnt)=1.0_8-noccafternocc_uspell(zcnt)
END DO



DO tcnt=1,tmax_qtr

         ! FOR THE DURATION REGRESSION: MOVERS
        !tempreal=REAL(data_pocc_qtr(tcnt))
        tempreal=sum(data_compduration_cocc_qtr(tcnt,1:18))
        IF(tempreal>0.0_8) data_ucompldur_occ_qtr(tcnt)=data_ucompldur_occ_qtr(tcnt)/tempreal

        tempreal=REAL(data_pocc_young_qtr(tcnt))
        IF(tempreal>0.0_8) data_ucompldur_young_occ_qtr(tcnt)=data_ucompldur_young_occ_qtr(tcnt)/tempreal

        tempreal=REAL(data_pocc_prime_qtr(tcnt))
        IF(tempreal>0.0_8) data_ucompldur_prime_occ_qtr(tcnt)=data_ucompldur_prime_occ_qtr(tcnt)/tempreal


        ! FOR THE DURATION REGRESSION: STAYERS
        tempreal=REAL(SUM(data_compduration_nocc_qtr(tcnt,1:18)))
        IF(tempreal>0.0_8) data_ucompldur_nocc_qtr(tcnt)=data_ucompldur_nocc_qtr(tcnt)/tempreal


        tempreal=REAL(data_pnocc_young_qtr(tcnt))
        IF(tempreal>0.0_8) data_ucompldur_young_nocc_qtr(tcnt)=data_ucompldur_young_nocc_qtr(tcnt)/tempreal

        tempreal=REAL(data_pnocc_prime_qtr(tcnt))
        IF(tempreal>0.0_8) data_ucompldur_prime_nocc_qtr(tcnt)=data_ucompldur_prime_nocc_qtr(tcnt)/tempreal

        tempreal=REAL(data_cocc_qtr(tcnt))
        IF (tempreal>0.0_8) data_pocc_qtr(tcnt)=REAL(data_pocc_qtr(tcnt))/tempreal

       tempreal=REAL(data_cocc_young_qtr(tcnt))
       IF (tempreal>0.0_8) data_pocc_young_qtr(tcnt)=REAL(data_pocc_young_qtr(tcnt))/tempreal
       tempreal=REAL(data_cocc_prime_qtr(tcnt))
       IF (tempreal>0.0_8) data_pocc_prime_qtr(tcnt)=REAL(data_pocc_prime_qtr(tcnt))/tempreal

        tempreal=REAL(data_nocc_qtr(tcnt))
        IF (tempreal>0.0_8) data_pnocc_qtr(tcnt)=REAL(data_pnocc_qtr(tcnt))/tempreal

        tempreal=REAL(data_nocc_young_qtr(tcnt))
        IF (tempreal>0.0_8) data_pnocc_young_qtr(tcnt)=REAL(data_pnocc_young_qtr(tcnt))/tempreal
        tempreal=REAL(data_nocc_prime_qtr(tcnt))
        IF (tempreal>0.0_8) data_pnocc_prime_qtr(tcnt)=REAL(data_pnocc_prime_qtr(tcnt))/tempreal


        tempreal=(REAL(data_cocc_qtr(tcnt))+REAL(data_nocc_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_qtr(tcnt)=REAL(data_cocc_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_young_qtr(tcnt))+REAL(data_nocc_young_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_young_qtr(tcnt)=REAL(data_cocc_young_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_prime_qtr(tcnt))+REAL(data_nocc_prime_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_prime_qtr(tcnt)=REAL(data_cocc_prime_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_inflow_qtr(tcnt))+REAL(data_nocc_inflow_qtr(tcnt)))
          IF (tempreal>0.0_8) data_cocc_inflow_qtr(tcnt)=REAL(data_cocc_inflow_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_young_inflow_qtr(tcnt))+REAL(data_nocc_young_inflow_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_young_inflow_qtr(tcnt)=REAL(data_cocc_young_inflow_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_prime_inflow_qtr(tcnt))+REAL(data_nocc_prime_inflow_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_prime_inflow_qtr(tcnt)=REAL(data_cocc_prime_inflow_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_outflow_qtr(tcnt))+REAL(data_nocc_outflow_qtr(tcnt)))
          IF (tempreal>0.0_8) data_cocc_outflow_qtr(tcnt)=REAL(data_cocc_outflow_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_young_outflow_qtr(tcnt))+REAL(data_nocc_young_outflow_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_young_outflow_qtr(tcnt)=REAL(data_cocc_young_outflow_qtr(tcnt))/tempreal

        tempreal=(REAL(data_cocc_prime_outflow_qtr(tcnt))+REAL(data_nocc_prime_outflow_qtr(tcnt)))
        IF (tempreal>0.0_8) data_cocc_prime_outflow_qtr(tcnt)=REAL(data_cocc_prime_outflow_qtr(tcnt))/tempreal


    END DO

    !!===============================
    !!  NET MOBILITY QUARTERLY
    !!===================================
              !!! QUARTERLY SERIES
              !      ! transition matrix (corr/uncorr) per QUARTER
              !      data_corr_superocc_transmatrix_qtr(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2), counter1)=&
              !              data_corr_superocc_transmatrix_qtr(corr_occid_sim(tcnt2-1), corr_occid_sim(tcnt2), counter1)+1.0
              !      data_superocc_transmatrix_qtr(occid_sim(tcnt2-1), occid_sim(tcnt2), counter1)=&
              !              data_superocc_transmatrix_qtr(occid_sim(tcnt2-1), occid_sim(tcnt2), counter1)+1.0
              !      ! note duration per occupation per quarter
              !      data_supocc_udur_qtr(occid_sim(tcnt2-1), counter1)=data_supocc_udur_qtr(occid_sim(tcnt2-1), counter1)+REAL(unempdur_estatus(t/4))
              !      data_supocc_udur_counter_qtr(occid_sim(tcnt2-1), counter1)=data_supocc_udur_counter_qtr(occid_sim(tcnt2-1), counter1)+1
              !

!data_nocc_qtr(:)=1.0_8-data_cocc_qtr(:)
!data_nocc_young_qtr(:)=1.0_8-data_cocc_young_qtr(:)
!data_nocc_prime_qtr(:)=1.0_8-data_cocc_prime_qtr(:)

!data_nocc_inflow_qtr(:)=1.0_8-data_cocc_inflow_qtr(:)
!data_nocc_young_inflow_qtr(:)=1.0_8-data_cocc_young_inflow_qtr(:)
!data_nocc_prime_inflow_qtr(:)=1.0_8-data_cocc_prime_inflow_qtr(:)



! TEST: write data_u_prime_qtr matrix

!      !$OMP CRITICAL
!    OPEN(UNIT=77, file='u_series.txt', status='old', form='formatted', position='append')
!    WRITE(*,*) 'UPDATING THREADNO. ------------------------------------------------------------>', threadnumber
!    WRITE(77,*) 'threadnumber==========', threadnumber
!    DO t=1, tmax_sim2
!        WRITE(77,*) data_u_prime_qtr(t), ',' ,data_prime_qtr(t)
!    END DO
!    CLOSE(77)
!      !$OMP END CRITICAL

! normalize the durationmatrix



    tempreal=REAL(tot_durationmatrix(1))
IF (tempreal>0.0) tot_durationmatrix=tot_durationmatrix/tempreal
    tempreal=REAL(tot_durationmatrix_young(1))
IF (tempreal>0.0) tot_durationmatrix_young=tot_durationmatrix_young/tempreal
    tempreal=REAL(tot_durationmatrix_prime(1))
IF (tempreal>0.0) tot_durationmatrix_prime=tot_durationmatrix_prime/tempreal

! alternative durationmatrix/survival
   tempreal=REAL(tot_durationmatrix2(1))
IF (tempreal>0.0) tot_durationmatrix2=tot_durationmatrix2/tempreal
!    tempreal=REAL(tot_durationmatrix2_young(1))
!IF (tempreal>0.0) tot_durationmatrix2_young=tot_durationmatrix2_young/tempreal
!    tempreal=REAL(tot_durationmatrix2_prime(1))
!IF (tempreal>0.0) tot_durationmatrix2_prime=tot_durationmatrix2_prime/tempreal
tempreal=REAL(tot_durationmatrix2_cocc(1))
IF (tempreal>0.0) tot_durationmatrix2_cocc=tot_durationmatrix2_cocc/tempreal
tempreal=REAL(tot_durationmatrix2_cocc_young(1))
IF (tempreal>0.0) tot_durationmatrix2_cocc_young=tot_durationmatrix2_cocc_young/tempreal
tempreal=REAL(tot_durationmatrix2_cocc_prime(1))
IF (tempreal>0.0) tot_durationmatrix2_cocc_prime=tot_durationmatrix2_cocc_prime/tempreal
tempreal=REAL(tot_durationmatrix2_nocc(1))
IF (tempreal>0.0) tot_durationmatrix2_nocc=tot_durationmatrix2_nocc/tempreal
tempreal=REAL(tot_durationmatrix2_nocc_young(1))
IF (tempreal>0.0) tot_durationmatrix2_nocc_young=tot_durationmatrix2_nocc_young/tempreal
tempreal=REAL(tot_durationmatrix2_nocc_prime(1))
IF (tempreal>0.0) tot_durationmatrix2_nocc_prime=tot_durationmatrix2_nocc_prime/tempreal
!



! same for data

    tempreal=REAL(tot_durationmatrix_data(1))
IF (tempreal>0.0) tot_durationmatrix_data=tot_durationmatrix_data/tempreal
    tempreal=REAL(tot_durationmatrix_young_data(1))
IF (tempreal>0.0) tot_durationmatrix_young_data=tot_durationmatrix_young_data/tempreal
    tempreal=REAL(tot_durationmatrix_prime_data(1))
IF (tempreal>0.0) tot_durationmatrix_prime_data=tot_durationmatrix_prime_data/tempreal

! UNEMPLOYMENT SURVIVAL RATES

!tot_udurationmatrix_m
    tempreal=REAL(tot_durationmatrix_cocc(1))
IF (tempreal>0.0) tot_udurationmatrix_m=tot_durationmatrix_cocc/tempreal
    tempreal=REAL(tot_durationmatrix_cocc_young(1))
IF (tempreal>0.0) tot_udurationmatrix_m_young=tot_durationmatrix_cocc_young/tempreal
    tempreal=REAL(tot_durationmatrix_cocc_prime(1))
IF (tempreal>0.0) tot_udurationmatrix_m_prime=tot_durationmatrix_cocc_prime/tempreal


!tot_udurationmatrix_s
    tempreal=REAL(tot_durationmatrix_nocc(1))
IF (tempreal>0.0) tot_udurationmatrix_s=tot_durationmatrix_nocc/tempreal
    tempreal=REAL(tot_durationmatrix_nocc_young(1))
IF (tempreal>0.0) tot_udurationmatrix_s_young=tot_durationmatrix_nocc_young/tempreal
    tempreal=REAL(tot_durationmatrix_nocc_prime(1))
IF (tempreal>0.0) tot_udurationmatrix_s_prime=tot_durationmatrix_nocc_prime/tempreal

! SAME NORMALIZATION IN THE DATA

!tot_udurationmatrix_m
    tempreal=REAL(tot_udurationmatrix_m_data(1))
IF (tempreal>0.0) tot_udurationmatrix_m_data=tot_udurationmatrix_m_data/tempreal
    tempreal=REAL(tot_udurationmatrix_m_young_data(1))
IF (tempreal>0.0) tot_udurationmatrix_m_young_data=tot_udurationmatrix_m_young_data/tempreal
    tempreal=REAL(tot_udurationmatrix_m_prime_data(1))
IF (tempreal>0.0) tot_udurationmatrix_m_prime_data=tot_udurationmatrix_m_prime_data/tempreal


!tot_udurationmatrix_s
    tempreal=REAL(tot_udurationmatrix_s_data(1))
IF (tempreal>0.0) tot_udurationmatrix_s_data=tot_udurationmatrix_s_data/tempreal
    tempreal=REAL(tot_udurationmatrix_s_young_data(1))
IF (tempreal>0.0) tot_udurationmatrix_s_young_data=tot_udurationmatrix_s_young_data/tempreal
    tempreal=REAL(tot_udurationmatrix_s_prime_data(1))
IF (tempreal>0.0) tot_udurationmatrix_s_prime_data=tot_udurationmatrix_s_prime_data/tempreal

!! HAZARDS
DO zcnt=2, 24
    tempreal=REAL(tot_durationmatrix(zcnt-1))
    IF (tempreal>0.0) tot_haz_durationmatrix(zcnt)=tot_durationmatrix(zcnt)/tempreal
    tempreal=REAL(tot_durationmatrix_young(zcnt-1))
    IF (tempreal>0.0) tot_haz_durationmatrix_young(zcnt)=tot_durationmatrix_young(zcnt)/tempreal
    tempreal=REAL(tot_durationmatrix_prime(zcnt-1))
    IF (tempreal>0.0) tot_haz_durationmatrix_prime(zcnt)=tot_durationmatrix_prime(zcnt)/tempreal


    tempreal=REAL(tot_udurationmatrix_m(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_m(zcnt)=tot_udurationmatrix_m(zcnt)/tempreal
    tempreal=REAL(tot_udurationmatrix_m_young(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_m_young(zcnt)=tot_udurationmatrix_m_young(zcnt)/tempreal
    tempreal=REAL(tot_udurationmatrix_m_prime(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_m_prime(zcnt)=tot_udurationmatrix_m_prime(zcnt)/tempreal


    tempreal=REAL(tot_udurationmatrix_s(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_s(zcnt)=tot_udurationmatrix_s(zcnt)/tempreal
    tempreal=REAL(tot_udurationmatrix_s_young(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_s_young(zcnt)=tot_udurationmatrix_s_young(zcnt)/tempreal
    tempreal=REAL(tot_udurationmatrix_s_prime(zcnt-1))
    IF (tempreal>0.0) tot_haz_udurationmatrix_s_prime(zcnt)=tot_udurationmatrix_s_prime(zcnt)/tempreal
    END DO

    ! ALTERNATIVE HAZARDS
    DO zcnt=1, 24
        IF(tot_haz_durationmatrix2(zcnt,2)>0) THEN
            tot_haz_durationmatrix2(zcnt,1)= tot_haz_durationmatrix2(zcnt,1)/tot_haz_durationmatrix2(zcnt,2)
        END IF
    END DO

    ! INCOMPLETE SPELL DISTRIBUTION
    tempreal=SUM(tot_haz_durationmatrix2(1:24,2))
    DO zcnt=1,24
        tot_haz_durationmatrix2(zcnt,2)= tot_haz_durationmatrix2(zcnt,2)/tempreal
    END DO
! COMPOSITION CM-DUR_S/M

DO zcnt=1, 18

    tempreal=REAL(tot_durationmatrix_cocc(zcnt)+tot_durationmatrix_nocc(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cocc(zcnt)=tot_durationmatrix_cocc(zcnt)/tempreal

    tempreal=REAL(tot_durationmatrix_cocc_young(zcnt)+tot_durationmatrix_nocc_young(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cocc_young(zcnt)=tot_durationmatrix_cocc_young(zcnt)/tempreal

    tempreal=REAL(tot_durationmatrix_cocc_prime(zcnt)+tot_durationmatrix_nocc_prime(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cocc_prime(zcnt)=tot_durationmatrix_cocc_prime(zcnt)/tempreal

    !
    tempreal=REAL(tot_durationmatrix_cr_cocc(zcnt)+tot_durationmatrix_cr_nocc(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cr_cocc(zcnt)=tot_durationmatrix_cr_cocc(zcnt)/tempreal

    tempreal=REAL(tot_durationmatrix_cr_cocc_young(zcnt)+tot_durationmatrix_cr_nocc_young(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cr_cocc_young(zcnt)=tot_durationmatrix_cr_cocc_young(zcnt)/tempreal

    tempreal=REAL(tot_durationmatrix_cr_cocc_prime(zcnt)+tot_durationmatrix_cr_nocc_prime(zcnt))
    IF (tempreal>0.0) tot_durationmatrix_cr_cocc_prime(zcnt)=tot_durationmatrix_cr_cocc_prime(zcnt)/tempreal


    END DO

 !WRITE(*,*) 'data_totduration_cocc_qtr(tmax_qtr/5,:)', data_totduration_cocc_qtr(tmax_qtr/4,:)
 !WRITE(*,*) 'data_totduration_nocc_qtr(tmax_qtr/5,:)', data_totduration_nocc_qtr(tmax_qtr/4,:)
                    !
                    !! DO NOT CREATE QUARTER PROFILE FIRST, THEN AVERAGE WITHIN BINS. JUST AT UP ALL OBSERVATIONS WITHIN BIN, THEN CREATE PROFILE
                    !DO pcnt=1, tmax_qtr
                    !DO zcnt=1, 18
                    !tempreal=data_totduration_cocc_qtr(pcnt, zcnt)+data_totduration_nocc_qtr(pcnt, zcnt)
                    !IF(tempreal>0.0_8) THEN
                    !    data_totduration_cocc_qtr(pcnt,zcnt)=data_totduration_cocc_qtr(pcnt,zcnt)/REAL(tempreal)
                    !    data_totduration_nocc_qtr(pcnt, zcnt)=tempreal
                    !ELSE
                    !    data_totduration_cocc_qtr(pcnt,zcnt)=0.0_8
                    !    data_totduration_nocc_qtr(pcnt,zcnt)=0.0_8
                    !END IF
                    !END DO
                    !    END DO
                    !
                    !
                    !DO pcnt=1, tmax_qtr
                    !DO zcnt=1, 18
                    !tempreal=data_totduration_cocc_young_qtr(pcnt, zcnt)+data_totduration_nocc_young_qtr(pcnt, zcnt)
                    !IF(tempreal>0.0_8) THEN
                    !    data_totduration_cocc_young_qtr(pcnt,zcnt)=data_totduration_cocc_young_qtr(pcnt,zcnt)/REAL(tempreal)
                    !    data_totduration_nocc_young_qtr(pcnt, zcnt)=tempreal
                    !ELSE
                    !    data_totduration_cocc_young_qtr(pcnt,zcnt)=0.0_8
                    !    data_totduration_nocc_young_qtr(pcnt,zcnt)=0.0_8
                    !END IF
                    !END DO
                    !    END DO
                    !
                    !DO pcnt=1, tmax_qtr
                    !DO zcnt=1, 18
                    !tempreal=data_totduration_cocc_prime_qtr(pcnt, zcnt)+data_totduration_nocc_prime_qtr(pcnt, zcnt)
                    !IF(tempreal>0.0_8) THEN
                    !    data_totduration_cocc_prime_qtr(pcnt,zcnt)=data_totduration_cocc_prime_qtr(pcnt,zcnt)/REAL(tempreal)
                    !    data_totduration_nocc_prime_qtr(pcnt, zcnt)=tempreal
                    !ELSE
                    !    data_totduration_cocc_prime_qtr(pcnt,zcnt)=0.0_8
                    !    data_totduration_nocc_prime_qtr(pcnt,zcnt)=0.0_8
                    !END IF
                    !END DO
                    !END DO
                    !

repeat_udur_corr=u_spell_crossterm/(sqrt(u_spell_before_sq)*sqrt(u_spell_now_sq))
repeat_udur_el=(u_spell_crossterm-(u_spell_before_ave*u_spell_now_ave))/((u_spell_before_sq)-(u_spell_before_ave)**2.0_8)
repeat_udur_corr_m=u_spell_crossterm_am/(sqrt(u_spell_before_am_sq)*sqrt(u_spell_now_am_sq))
repeat_udur_el_m=(u_spell_crossterm_am-(u_spell_before_am_ave*u_spell_now_am_ave))/((u_spell_before_am_sq)-(u_spell_before_am_ave)**2.0_8)
repeat_udur_corr_s=u_spell_crossterm_as/(sqrt(u_spell_before_as_sq)*sqrt(u_spell_now_as_sq))
repeat_udur_el_s=(u_spell_crossterm_as-(u_spell_before_as_ave*u_spell_now_as_ave))/((u_spell_before_as_sq)-(u_spell_before_as_ave)**2.0_8)
repeat_udur_corr_sam=u_spell_crossterm_sam/(sqrt(u_spell_before_sam_sq)*sqrt(u_spell_now_sam_sq))
repeat_udur_el_sam=(u_spell_crossterm_sam-(u_spell_before_sam_ave*u_spell_now_sam_ave))/((u_spell_before_sam_sq)-(u_spell_before_sam_ave)**2.0_8)
repeat_udur_corr_sas=u_spell_crossterm_sas/(sqrt(u_spell_before_sas_sq)*sqrt(u_spell_now_sas_sq))
repeat_udur_el_sas=(u_spell_crossterm_sas-(u_spell_before_sas_ave*u_spell_now_sas_ave))/((u_spell_before_sas_sq)-(u_spell_before_sas_ave)**2.0_8)
repeat_udur_corr_mam=u_spell_crossterm_mam/(sqrt(u_spell_before_mam_sq)*sqrt(u_spell_now_mam_sq))
repeat_udur_el_mam=(u_spell_crossterm_mam-(u_spell_before_mam_ave*u_spell_now_mam_ave))/((u_spell_before_mam_sq)-(u_spell_before_mam_ave)**2.0_8)
repeat_udur_corr_mas=u_spell_crossterm_mas/(sqrt(u_spell_before_mas_sq)*sqrt(u_spell_now_mas_sq))
repeat_udur_el_mas=(u_spell_crossterm_sas-(u_spell_before_sas_ave*u_spell_now_sas_ave))/((u_spell_before_sas_sq)-(u_spell_before_sas_ave)**2.0_8)

repeat_udur_corr_y=u_spell_young_crossterm/(sqrt(u_spell_young_before_sq)*sqrt(u_spell_young_now_sq))
repeat_udur_el_y=(u_spell_young_crossterm-(u_spell_young_before_ave*u_spell_young_now_ave))/((u_spell_young_before_sq)-(u_spell_young_before_ave)**2.0_8)
repeat_udur_corr_m_y=u_spell_young_crossterm_am/(sqrt(u_spell_young_before_am_sq)*sqrt(u_spell_young_now_am_sq))
repeat_udur_el_m_y=(u_spell_young_crossterm_am-(u_spell_young_before_am_ave*u_spell_young_now_am_ave))/((u_spell_young_before_am_sq)-(u_spell_young_before_am_ave)**2.0_8)
repeat_udur_corr_s_y=u_spell_young_crossterm_as/(sqrt(u_spell_young_before_as_sq)*sqrt(u_spell_young_now_as_sq))
repeat_udur_el_s_y=(u_spell_young_crossterm_as-(u_spell_young_before_as_ave*u_spell_young_now_as_ave))/((u_spell_young_before_as_sq)-(u_spell_young_before_as_ave)**2.0_8)
repeat_udur_corr_sam_y=u_spell_young_crossterm_sam/(sqrt(u_spell_young_before_sam_sq)*sqrt(u_spell_young_now_sam_sq))
repeat_udur_el_sam_y=(u_spell_young_crossterm_sam-(u_spell_young_before_sam_ave*u_spell_young_now_sam_ave))/((u_spell_young_before_sam_sq)-(u_spell_young_before_sam_ave)**2.0_8)
repeat_udur_corr_sas_y=u_spell_young_crossterm_sas/(sqrt(u_spell_young_before_sas_sq)*sqrt(u_spell_young_now_sas_sq))
repeat_udur_el_sas_y=(u_spell_young_crossterm_sas-(u_spell_young_before_sas_ave*u_spell_young_now_sas_ave))/((u_spell_young_before_sas_sq)-(u_spell_young_before_sas_ave)**2.0_8)
repeat_udur_corr_mam_y=u_spell_young_crossterm_mam/(sqrt(u_spell_young_before_mam_sq)*sqrt(u_spell_young_now_mam_sq))
repeat_udur_el_mam_y=(u_spell_young_crossterm_mam-(u_spell_young_before_mam_ave*u_spell_young_now_mam_ave))/((u_spell_young_before_mam_sq)-(u_spell_young_before_mam_ave)**2.0_8)
repeat_udur_corr_mas_y=u_spell_young_crossterm_mas/(sqrt(u_spell_young_before_mas_sq)*sqrt(u_spell_young_now_mas_sq))
repeat_udur_el_mas_y=(u_spell_young_crossterm_sas-(u_spell_young_before_sas_ave*u_spell_young_now_sas_ave))/((u_spell_young_before_sas_sq)-(u_spell_young_before_sas_ave)**2.0_8)


repeat_udur_corr_p=u_spell_prime_crossterm/(sqrt(u_spell_prime_before_sq)*sqrt(u_spell_prime_now_sq))
repeat_udur_el_p=(u_spell_prime_crossterm-(u_spell_prime_before_ave*u_spell_prime_now_ave))/((u_spell_prime_before_sq)-(u_spell_prime_before_ave)**2.0_8)
repeat_udur_corr_m_p=u_spell_prime_crossterm_am/(sqrt(u_spell_prime_before_am_sq)*sqrt(u_spell_prime_now_am_sq))
repeat_udur_el_m_p=(u_spell_prime_crossterm_am-(u_spell_prime_before_am_ave*u_spell_prime_now_am_ave))/((u_spell_prime_before_am_sq)-(u_spell_prime_before_am_ave)**2.0_8)
repeat_udur_corr_s_p=u_spell_prime_crossterm_as/(sqrt(u_spell_prime_before_as_sq)*sqrt(u_spell_prime_now_as_sq))
repeat_udur_el_s_p=(u_spell_prime_crossterm_as-(u_spell_prime_before_as_ave*u_spell_prime_now_as_ave))/((u_spell_prime_before_as_sq)-(u_spell_prime_before_as_ave)**2.0_8)
repeat_udur_corr_sam_p=u_spell_prime_crossterm_sam/(sqrt(u_spell_prime_before_sam_sq)*sqrt(u_spell_prime_now_sam_sq))
repeat_udur_el_sam_p=(u_spell_prime_crossterm_sam-(u_spell_prime_before_sam_ave*u_spell_prime_now_sam_ave))/((u_spell_prime_before_sam_sq)-(u_spell_prime_before_sam_ave)**2.0_8)
repeat_udur_corr_sas_p=u_spell_prime_crossterm_sas/(sqrt(u_spell_prime_before_sas_sq)*sqrt(u_spell_prime_now_sas_sq))
repeat_udur_el_sas_p=(u_spell_prime_crossterm_sas-(u_spell_prime_before_sas_ave*u_spell_prime_now_sas_ave))/((u_spell_prime_before_sas_sq)-(u_spell_prime_before_sas_ave)**2.0_8)
repeat_udur_corr_mam_p=u_spell_prime_crossterm_mam/(sqrt(u_spell_prime_before_mam_sq)*sqrt(u_spell_prime_now_mam_sq))
repeat_udur_el_mam_p=(u_spell_prime_crossterm_mam-(u_spell_prime_before_mam_ave*u_spell_prime_now_mam_ave))/((u_spell_prime_before_mam_sq)-(u_spell_prime_before_mam_ave)**2.0_8)
repeat_udur_corr_mas_p=u_spell_prime_crossterm_mas/(sqrt(u_spell_prime_before_mas_sq)*sqrt(u_spell_prime_now_mas_sq))
repeat_udur_el_mas_p=(u_spell_prime_crossterm_sas-(u_spell_prime_before_sas_ave*u_spell_prime_now_sas_ave))/((u_spell_prime_before_sas_sq)-(u_spell_prime_before_sas_ave)**2.0_8)


IF (u_spell_young_before_sam_sq==0.0_8) repeat_udur_el_sam_p=-1.0_8
IF (u_spell_young_before_mam_sq==0.0_8) repeat_udur_el_mam_p=-1.0_8
IF (u_spell_young_before_mas_sq==0.0_8) repeat_udur_el_mas_p=-1.0_8
IF (u_spell_young_before_sas_sq==0.0_8) repeat_udur_el_sas_p=-1.0_8

IF (u_spell_young_now_sam_sq==0.0_8) repeat_udur_corr_sam_p=-2.0_8
IF (u_spell_young_now_mam_sq==0.0_8) repeat_udur_corr_mam_p=-2.0_8
IF (u_spell_young_now_mas_sq==0.0_8) repeat_udur_corr_mas_p=-2.0_8
IF (u_spell_young_now_sas_sq==0.0_8) repeat_udur_corr_sas_p=-2.0_8



!Finally, normalize data_u_qtr itself.
DO t=1, tmax_qtr

    IF(data_u_qtr(t)+data_e_qtr(t)>0.0_8) THEN
        data_u_qtr(t)=data_u_qtr(t)/REAL(data_u_qtr(t)+data_e_qtr(t))
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) 'ERROR 73: u_prime>prime population: data_u_prime/data_prime:'
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) data_u_prime_qtr(t), '/', data_prime_qtr(t)
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) '-------------'
    END IF


    IF(data_uall_qtr(t)+data_e_qtr(t)>0) THEN
        data_uall_qtr(t)=data_uall_qtr(t)/(data_u_qtr(t)+data_e_qtr(t))
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) 'ERROR 73: u_prime>prime population: data_u_prime/data_prime:'
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) data_u_prime_qtr(t), '/', data_prime_qtr(t)
        !    IF (data_u_prime_qtr(t)>data_prime_qtr(t)) WRITE(59,*) '-------------'
    END IF


    IF(data_uadj18m_qtr(t)+data_e_qtr(t)>0) THEN
      data_uadj18m_qtr(t)=data_uadj18m_qtr(t)/(data_uadj18m_qtr(t)+data_e_qtr(t))
    END IF

    IF(data_uadj18m_young_qtr(t)+data_e_young_qtr(t)>0) THEN
      data_uadj18m_young_qtr(t)=data_uadj18m_young_qtr(t)/(data_uadj18m_young_qtr(t)+data_e_young_qtr(t))
    END IF


    END DO

    !==========
    ! unemployment distribution
    !==========

    !min_unemp
    min_unemp_ee=minval(data_u_qtr(1:tmax_qtr),data_u_qtr(1:tmax_qtr)>0.0_8)
    min_unemp_young_ee=minval(data_u_young_qtr(1:tmax_qtr),data_u_young_qtr(1:tmax_qtr)>0.0_8)
    min_unemp_prime_ee=minval(data_u_prime_qtr(1:tmax_qtr),data_u_prime_qtr(1:tmax_qtr)>0.0_8)
    max_unemp_ee=maxval(data_u_qtr(1:tmax_qtr))
    max_unemp_young_ee=maxval(data_u_young_qtr(1:tmax_qtr))
    max_unemp_prime_ee=maxval(data_u_prime_qtr(1:tmax_qtr))







DO t=1, tmax_qtr
    tempreal=REAL(data_ult5wk_qtr(t)+data_u5lt15wk_qtr(t)+data_u15lt27wk_qtr(t)+data_ugt27wk_qtr(t))
    IF(tempreal>0.0_8) THEN
    data_ult5wk_qtr(t)=data_ult5wk_qtr(t)/tempreal
    data_u5lt15wk_qtr(t)=data_u5lt15wk_qtr(t)/tempreal
    data_u15lt27wk_qtr(t)=data_u15lt27wk_qtr(t)/tempreal
    data_ugt27wk_qtr(t)=data_ugt27wk_qtr(t)/tempreal
    END IF
END DO


DO t=1, tmax_qtr
    tempreal=REAL(data_ult5m_qtr(t)+data_ult9m_qtr(t)+data_ult13m_qtr(t)+data_ugt13m_qtr(t))
    IF(tempreal>0.0_8) THEN
    data_ult3m_qtr(t)=data_ult3m_qtr(t)/tempreal
    data_ult5m_qtr(t)=data_ult5m_qtr(t)/tempreal
    data_ult9m_qtr(t)=data_ult9m_qtr(t)/tempreal
    data_ult13m_qtr(t)=data_ult13m_qtr(t)/tempreal
    data_ugt13m_qtr(t)=data_ugt13m_qtr(t)/tempreal
    END IF
END DO


DO t=1, tmax_qtr
    tempreal=REAL(data_ult5m_yng_qtr(t)+data_ult9m_yng_qtr(t)+data_ult13m_yng_qtr(t)+data_ugt13m_yng_qtr(t))
    IF(tempreal>0.0_8) THEN
    data_ult3m_yng_qtr(t)=data_ult3m_yng_qtr(t)/tempreal
    data_ult5m_yng_qtr(t)=data_ult5m_yng_qtr(t)/tempreal
    data_ult9m_yng_qtr(t)=data_ult9m_yng_qtr(t)/tempreal
    data_ult13m_yng_qtr(t)=data_ult13m_yng_qtr(t)/tempreal
    data_ugt13m_yng_qtr(t)=data_ugt13m_yng_qtr(t)/tempreal
    END IF
END DO

! YOUNG
DO t=1, tmax_qtr
    tempreal=REAL(data_ult5m_prm_qtr(t)+data_ult9m_prm_qtr(t)+data_ult13m_prm_qtr(t)+data_ugt13m_prm_qtr(t))
    IF(tempreal>0.0_8) THEN
    data_ult3m_prm_qtr(t)=data_ult3m_prm_qtr(t)/tempreal
    data_ult5m_prm_qtr(t)=data_ult5m_prm_qtr(t)/tempreal
    data_ult9m_prm_qtr(t)=data_ult9m_prm_qtr(t)/tempreal
    data_ult13m_prm_qtr(t)=data_ult13m_prm_qtr(t)/tempreal
    data_ugt13m_prm_qtr(t)=data_ugt13m_prm_qtr(t)/tempreal
    END IF
END DO

!!==============================================================================
 !! END OF MASKED WINDOW USED FOR END-DISTRIBUTION
 !!==============================================================================
    tempcounter=0
    tempcounter1=min(size(data_supocc_e_qtr), size(mask_qtr))
    DO t=MIN(10,tmax_qtr-1), MIN(tmax_qtr-1,tempcounter1-1)
        IF(mask_qtr(t)==.false. .AND. mask_qtr(t-1)==.true. .AND. data_supocc_e_qtr(1,t-1)>0.0) THEN
            tempcounter=tempcounter+1
            DO occcnt=1, occpts
                occdistr_end_v3(occcnt)=occdistr_end_v3(occcnt)+data_supocc_e_qtr(occcnt,t-1)
            
            END DO
            
        END IF
    END DO

    occdistr_end_v3(:)=occdistr_end_v3(:)/REAL(tempcounter)
    
    !! corrected occdistr_end_v3, requires inverse, but should not be too different
            DO occcnt=1, occpts
            tempreal=0.0
            DO xcnt=1,occpts
                tempreal=tempreal+occdistr_end_v3(xcnt)*invgamma_miscode(xcnt,occcnt)
            END DO 
                corr_occdistr_end_v3(occcnt)=tempreal
            END DO 
    !! XXXXXshould normalize it, just in case the inverting creates a bit too much

            tempreal=0.0
            DO occcnt=1, occpts
                tempreal=tempreal+corr_occdistr_end_v3(occcnt)
            END DO 
            
            corr_occdistr_end_v3=corr_occdistr_end_v3/tempreal 
    !! XXXXX

    
    !! other version normalized
    tempreal=sum(occdistr_end_v2(:))
    occdistr_end_v2(:)=occdistr_end_v2(:)/tempreal

    !WRITE(10,*) '-unadjusted durations'
!WRITE(10,*) duration2


    !! -------------------------------------
    !!   WRITE UNEMPLOYMENT TOT_DURATIONMATRIX into duration2
    !! ---------------------------------------------------

duration2(0)=tot_durationmatrix(0)
duration2(1)=tot_durationmatrix(2)
duration2(2)=tot_durationmatrix(4)
duration2(3)=tot_durationmatrix(8)
duration2(4)=tot_durationmatrix(12)
duration2(5)=tot_durationmatrix(16)
duration2(6)=tot_durationmatrix(20)
duration2(7)=tot_durationmatrix(24)

IF(verboseswitch==1) WRITE(*,*) 'duration2= ', duration2(2)
IF(verboseswitch==1) WRITE(*,*) 'corresponding tot_durationmatrix(4)', tot_durationmatrix(4)

duration2_young(0)=tot_durationmatrix_young(0)
duration2_young(1)=tot_durationmatrix_young(2)
duration2_young(2)=tot_durationmatrix_young(4)
duration2_young(3)=tot_durationmatrix_young(8)
duration2_young(4)=tot_durationmatrix_young(12)
duration2_young(5)=tot_durationmatrix_young(16)
duration2_young(6)=tot_durationmatrix_young(20)
duration2_young(7)=tot_durationmatrix_young(24)

duration2_prime(0)=tot_durationmatrix_prime(0)
duration2_prime(1)=tot_durationmatrix_prime(2)
duration2_prime(2)=tot_durationmatrix_prime(4)
duration2_prime(3)=tot_durationmatrix_prime(8)
duration2_prime(4)=tot_durationmatrix_prime(12)
duration2_prime(5)=tot_durationmatrix_prime(16)
duration2_prime(6)=tot_durationmatrix_prime(20)
duration2_prime(7)=tot_durationmatrix_prime(24)

!! duration for movers and stayers

duration2_move(0)=tot_durationmatrix2_cocc(0)
duration2_move(1)=tot_durationmatrix2_cocc(2)
duration2_move(2)=tot_durationmatrix2_cocc(4)
duration2_move(3)=tot_durationmatrix2_cocc(8)
duration2_move(4)=tot_durationmatrix2_cocc(12)
duration2_move(5)=tot_durationmatrix2_cocc(16)
duration2_move(6)=tot_durationmatrix2_cocc(20)
duration2_move(7)=tot_durationmatrix2_cocc(24)

duration2_move_young(0)=tot_durationmatrix2_cocc_young(0)
duration2_move_young(1)=tot_durationmatrix2_cocc_young(2)
duration2_move_young(2)=tot_durationmatrix2_cocc_young(4)
duration2_move_young(3)=tot_durationmatrix2_cocc_young(8)
duration2_move_young(4)=tot_durationmatrix2_cocc_young(12)
duration2_move_young(5)=tot_durationmatrix2_cocc_young(16)
duration2_move_young(6)=tot_durationmatrix2_cocc_young(20)
duration2_move_young(7)=tot_durationmatrix2_cocc_young(24)

duration2_move_prime(0)=tot_durationmatrix2_cocc_prime(0)
duration2_move_prime(1)=tot_durationmatrix2_cocc_prime(2)
duration2_move_prime(2)=tot_durationmatrix2_cocc_prime(4)
duration2_move_prime(3)=tot_durationmatrix2_cocc_prime(8)
duration2_move_prime(4)=tot_durationmatrix2_cocc_prime(12)
duration2_move_prime(5)=tot_durationmatrix2_cocc_prime(16)
duration2_move_prime(6)=tot_durationmatrix2_cocc_prime(20)
duration2_move_prime(7)=tot_durationmatrix2_cocc_prime(24)


duration2_stay(0)=tot_durationmatrix2_nocc(0)
duration2_stay(1)=tot_durationmatrix2_nocc(2)
duration2_stay(2)=tot_durationmatrix2_nocc(4)
duration2_stay(3)=tot_durationmatrix2_nocc(8)
duration2_stay(4)=tot_durationmatrix2_nocc(12)
duration2_stay(5)=tot_durationmatrix2_nocc(16)
duration2_stay(6)=tot_durationmatrix2_nocc(20)
duration2_stay(7)=tot_durationmatrix2_nocc(24)

duration2_stay_young(0)=tot_durationmatrix2_nocc_young(0)
duration2_stay_young(1)=tot_durationmatrix2_nocc_young(2)
duration2_stay_young(2)=tot_durationmatrix2_nocc_young(4)
duration2_stay_young(3)=tot_durationmatrix2_nocc_young(8)
duration2_stay_young(4)=tot_durationmatrix2_nocc_young(12)
duration2_stay_young(5)=tot_durationmatrix2_nocc_young(16)
duration2_stay_young(6)=tot_durationmatrix2_nocc_young(20)
duration2_stay_young(7)=tot_durationmatrix2_nocc_young(24)

duration2_stay_prime(0)=tot_durationmatrix2_nocc_prime(0)
duration2_stay_prime(1)=tot_durationmatrix2_nocc_prime(2)
duration2_stay_prime(2)=tot_durationmatrix2_nocc_prime(4)
duration2_stay_prime(3)=tot_durationmatrix2_nocc_prime(8)
duration2_stay_prime(4)=tot_durationmatrix2_nocc_prime(12)
duration2_stay_prime(5)=tot_durationmatrix2_nocc_prime(16)
duration2_stay_prime(6)=tot_durationmatrix2_nocc_prime(20)
duration2_stay_prime(7)=tot_durationmatrix2_nocc_prime(24)




!! DATA PATTERNS

duration2_data(0)=tot_durationmatrix_data(0)
duration2_data(1)=tot_durationmatrix_data(2)
duration2_data(2)=tot_durationmatrix_data(4)
duration2_data(3)=tot_durationmatrix_data(8)
duration2_data(4)=tot_durationmatrix_data(12)
duration2_data(5)=tot_durationmatrix_data(16)
duration2_data(6)=tot_durationmatrix_data(20)
duration2_data(7)=tot_durationmatrix_data(24)

duration2_young_data(0)=tot_durationmatrix_young_data(0)
duration2_young_data(1)=tot_durationmatrix_young_data(2)
duration2_young_data(2)=tot_durationmatrix_young_data(4)
duration2_young_data(3)=tot_durationmatrix_young_data(8)
duration2_young_data(4)=tot_durationmatrix_young_data(12)
duration2_young_data(5)=tot_durationmatrix_young_data(16)
duration2_young_data(6)=tot_durationmatrix_young_data(20)
duration2_young_data(7)=tot_durationmatrix_young_data(24)

duration2_prime_data(0)=tot_durationmatrix_prime_data(0)
duration2_prime_data(1)=tot_durationmatrix_prime_data(2)
duration2_prime_data(2)=tot_durationmatrix_prime_data(4)
duration2_prime_data(3)=tot_durationmatrix_prime_data(8)
duration2_prime_data(4)=tot_durationmatrix_prime_data(12)
duration2_prime_data(5)=tot_durationmatrix_prime_data(16)
duration2_prime_data(6)=tot_durationmatrix_prime_data(20)
duration2_prime_data(7)=tot_durationmatrix_prime_data(24)

!! duration for movers and stayers

duration2_move_data(0)=tot_durationmatrix2_cocc_data(0)
duration2_move_data(1)=tot_durationmatrix2_cocc_data(2)
duration2_move_data(2)=tot_durationmatrix2_cocc_data(4)
duration2_move_data(3)=tot_durationmatrix2_cocc_data(8)
duration2_move_data(4)=tot_durationmatrix2_cocc_data(12)
duration2_move_data(5)=tot_durationmatrix2_cocc_data(16)
duration2_move_data(6)=tot_durationmatrix2_cocc_data(20)
duration2_move_data(7)=tot_durationmatrix2_cocc_data(24)

duration2_move_young_data(0)=tot_durationmatrix2_cocc_young_data(0)
duration2_move_young_data(1)=tot_durationmatrix2_cocc_young_data(2)
duration2_move_young_data(2)=tot_durationmatrix2_cocc_young_data(4)
duration2_move_young_data(3)=tot_durationmatrix2_cocc_young_data(8)
duration2_move_young_data(4)=tot_durationmatrix2_cocc_young_data(12)
duration2_move_young_data(5)=tot_durationmatrix2_cocc_young_data(16)
duration2_move_young_data(6)=tot_durationmatrix2_cocc_young_data(20)
duration2_move_young_data(7)=tot_durationmatrix2_cocc_young_data(24)

duration2_move_prime_data(0)=tot_durationmatrix2_cocc_prime_data(0)
duration2_move_prime_data(1)=tot_durationmatrix2_cocc_prime_data(2)
duration2_move_prime_data(2)=tot_durationmatrix2_cocc_prime_data(4)
duration2_move_prime_data(3)=tot_durationmatrix2_cocc_prime_data(8)
duration2_move_prime_data(4)=tot_durationmatrix2_cocc_prime_data(12)
duration2_move_prime_data(5)=tot_durationmatrix2_cocc_prime_data(16)
duration2_move_prime_data(6)=tot_durationmatrix2_cocc_prime_data(20)
duration2_move_prime_data(7)=tot_durationmatrix2_cocc_prime_data(24)


duration2_stay_data(0)=tot_durationmatrix2_nocc_data(0)
duration2_stay_data(1)=tot_durationmatrix2_nocc_data(2)
duration2_stay_data(2)=tot_durationmatrix2_nocc_data(4)
duration2_stay_data(3)=tot_durationmatrix2_nocc_data(8)
duration2_stay_data(4)=tot_durationmatrix2_nocc_data(12)
duration2_stay_data(5)=tot_durationmatrix2_nocc_data(16)
duration2_stay_data(6)=tot_durationmatrix2_nocc_data(20)
duration2_stay_data(7)=tot_durationmatrix2_nocc_data(24)

duration2_stay_young_data(0)=tot_durationmatrix2_nocc_young_data(0)
duration2_stay_young_data(1)=tot_durationmatrix2_nocc_young_data(2)
duration2_stay_young_data(2)=tot_durationmatrix2_nocc_young_data(4)
duration2_stay_young_data(3)=tot_durationmatrix2_nocc_young_data(8)
duration2_stay_young_data(4)=tot_durationmatrix2_nocc_young_data(12)
duration2_stay_young_data(5)=tot_durationmatrix2_nocc_young_data(16)
duration2_stay_young_data(6)=tot_durationmatrix2_nocc_young_data(20)
duration2_stay_young_data(7)=tot_durationmatrix2_nocc_young_data(24)

duration2_stay_prime_data(0)=tot_durationmatrix2_nocc_prime_data(0)
duration2_stay_prime_data(1)=tot_durationmatrix2_nocc_prime_data(2)
duration2_stay_prime_data(2)=tot_durationmatrix2_nocc_prime_data(4)
duration2_stay_prime_data(3)=tot_durationmatrix2_nocc_prime_data(8)
duration2_stay_prime_data(4)=tot_durationmatrix2_nocc_prime_data(12)
duration2_stay_prime_data(5)=tot_durationmatrix2_nocc_prime_data(16)
duration2_stay_prime_data(6)=tot_durationmatrix2_nocc_prime_data(20)
duration2_stay_prime_data(7)=tot_durationmatrix2_nocc_prime_data(24)


!   WRITE(*,*) '-unadjusted E durations after occ'
!   DO counter2=0,6
!       WRITE(*,FMT='(F9.5, A1)', ADVANCE='no') empduration_occ(counter2), ','
!   END DO
!   WRITE(*,FMT='(F9.5, A1)')  empduration_occ(7)
!
   IF(empduration_occ(0)>0.0_8) THEN
   empduration_occ(1)=empduration_occ(1)/empduration_occ(0)
   empduration_occ(2)=empduration_occ(2)/empduration_occ(0)
   empduration_occ(3)=empduration_occ(3)/empduration_occ(0)
   empduration_occ(4)=empduration_occ(4)/empduration_occ(0)
   empduration_occ(5)=empduration_occ(5)/empduration_occ(0)
   empduration_occ(6)=empduration_occ(6)/empduration_occ(0)
   empduration_occ(7)=empduration_occ(7)/empduration_occ(0)
   ELSE
   empduration_occ(:)=-1.0
   END IF



   IF(empduration_nocc(0)>0.0_8) THEN
   empduration_nocc(1)=empduration_nocc(1)/empduration_nocc(0)
   empduration_nocc(2)=empduration_nocc(2)/empduration_nocc(0)
   empduration_nocc(3)=empduration_nocc(3)/empduration_nocc(0)
   empduration_nocc(4)=empduration_nocc(4)/empduration_nocc(0)
   empduration_nocc(5)=empduration_nocc(5)/empduration_nocc(0)
   empduration_nocc(6)=empduration_nocc(6)/empduration_nocc(0)
   empduration_nocc(7)=empduration_nocc(7)/empduration_nocc(0)
   ELSE
   empduration_nocc(:)=-1.0
   END IF


!
!   WRITE(*,*) '-unadjusted E durations after nocc'
!   DO counter2=0,6
!       WRITE(*,FMT='(F9.5, A1)', ADVANCE='no') empduration_nocc(counter2), ','
!   END DO
!   WRITE(*,FMT='(F9.5, A1)')  empduration_nocc(7)
!
   IF(empduration_occ_y(0)>0.0_8) THEN
   empduration_occ_y(1)=empduration_occ_y(1)/empduration_occ_y(0)
   empduration_occ_y(2)=empduration_occ_y(2)/empduration_occ_y(0)
   empduration_occ_y(3)=empduration_occ_y(3)/empduration_occ_y(0)
   empduration_occ_y(4)=empduration_occ_y(4)/empduration_occ_y(0)
   empduration_occ_y(5)=empduration_occ_y(5)/empduration_occ_y(0)
   empduration_occ_y(6)=empduration_occ_y(6)/empduration_occ_y(0)
   empduration_occ_y(7)=empduration_occ_y(7)/empduration_occ_y(0)
   ELSE
   empduration_occ_y(:)=-1.0
   END IF


   IF(empduration_nocc_y(0)>0.0_8) THEN
   empduration_nocc_y(1)=empduration_nocc_y(1)/empduration_nocc_y(0)
   empduration_nocc_y(2)=empduration_nocc_y(2)/empduration_nocc_y(0)
   empduration_nocc_y(3)=empduration_nocc_y(3)/empduration_nocc_y(0)
   empduration_nocc_y(4)=empduration_nocc_y(4)/empduration_nocc_y(0)
   empduration_nocc_y(5)=empduration_nocc_y(5)/empduration_nocc_y(0)
   empduration_nocc_y(6)=empduration_nocc_y(6)/empduration_nocc_y(0)
   empduration_nocc_y(7)=empduration_nocc_y(7)/empduration_nocc_y(0)
   ELSE
   empduration_nocc_y(:)=-1.0
   END IF

   IF(empduration_occ_p(0)>0.0_8) THEN
   empduration_occ_p(1)=empduration_occ_p(1)/empduration_occ_p(0)
   empduration_occ_p(2)=empduration_occ_p(2)/empduration_occ_p(0)
   empduration_occ_p(3)=empduration_occ_p(3)/empduration_occ_p(0)
   empduration_occ_p(4)=empduration_occ_p(4)/empduration_occ_p(0)
   empduration_occ_p(5)=empduration_occ_p(5)/empduration_occ_p(0)
   empduration_occ_p(6)=empduration_occ_p(6)/empduration_occ_p(0)
   empduration_occ_p(7)=empduration_occ_p(7)/empduration_occ_p(0)
   ELSE
   empduration_occ_p(:)=-1.0
   END IF


   IF(empduration_nocc_p(0)>0.0_8) THEN
   empduration_nocc_p(1)=empduration_nocc_p(1)/empduration_nocc_p(0)
   empduration_nocc_p(2)=empduration_nocc_p(2)/empduration_nocc_p(0)
   empduration_nocc_p(3)=empduration_nocc_p(3)/empduration_nocc_p(0)
   empduration_nocc_p(4)=empduration_nocc_p(4)/empduration_nocc_p(0)
   empduration_nocc_p(5)=empduration_nocc_p(5)/empduration_nocc_p(0)
   empduration_nocc_p(6)=empduration_nocc_p(6)/empduration_nocc_p(0)
   empduration_nocc_p(7)=empduration_nocc_p(7)/empduration_nocc_p(0)
   ELSE
   empduration_nocc_p(:)=-1.0
   END IF

   IF(empduration_occ_shuspell(0)>0.0_8) THEN
   empduration_occ_shuspell(1)=empduration_occ_shuspell(1)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(2)=empduration_occ_shuspell(2)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(3)=empduration_occ_shuspell(3)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(4)=empduration_occ_shuspell(4)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(5)=empduration_occ_shuspell(5)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(6)=empduration_occ_shuspell(6)/empduration_occ_shuspell(0)
   empduration_occ_shuspell(7)=empduration_occ_shuspell(7)/empduration_occ_shuspell(0)
   ELSE
   empduration_occ_shuspell(:)=-1.0
   END IF


   IF(empduration_nocc_shuspell(0)>0.0_8) THEN
   empduration_nocc_shuspell(1)=empduration_nocc_shuspell(1)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(2)=empduration_nocc_shuspell(2)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(3)=empduration_nocc_shuspell(3)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(4)=empduration_nocc_shuspell(4)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(5)=empduration_nocc_shuspell(5)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(6)=empduration_nocc_shuspell(6)/empduration_nocc_shuspell(0)
   empduration_nocc_shuspell(7)=empduration_nocc_shuspell(7)/empduration_nocc_shuspell(0)
   ELSE
   empduration_nocc_shuspell(:)=-1.0
   END IF

   IF(empduration_occ_luspell(0)>0.0_8) THEN
   empduration_occ_luspell(1)=empduration_occ_luspell(1)/empduration_occ_luspell(0)
   empduration_occ_luspell(2)=empduration_occ_luspell(2)/empduration_occ_luspell(0)
   empduration_occ_luspell(3)=empduration_occ_luspell(3)/empduration_occ_luspell(0)
   empduration_occ_luspell(4)=empduration_occ_luspell(4)/empduration_occ_luspell(0)
   empduration_occ_luspell(5)=empduration_occ_luspell(5)/empduration_occ_luspell(0)
   empduration_occ_luspell(6)=empduration_occ_luspell(6)/empduration_occ_luspell(0)
   empduration_occ_luspell(7)=empduration_occ_luspell(7)/empduration_occ_luspell(0)
   ELSE
   empduration_occ_luspell(:)=-1.0
   END IF


   IF(empduration_nocc_luspell(0)>0.0_8) THEN
   empduration_nocc_luspell(1)=empduration_nocc_luspell(1)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(2)=empduration_nocc_luspell(2)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(3)=empduration_nocc_luspell(3)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(4)=empduration_nocc_luspell(4)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(5)=empduration_nocc_luspell(5)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(6)=empduration_nocc_luspell(6)/empduration_nocc_luspell(0)
   empduration_nocc_luspell(7)=empduration_nocc_luspell(7)/empduration_nocc_luspell(0)
   ELSE
   empduration_nocc_luspell(:)=-1.0
   END IF

    ! DURATION DISTRIBUTION
 tempreal=ult5wk+u5lt15wk+u15lt27wk+ugt27wk
  ult5wk=ult5wk/tempreal
  u5lt15wk=u5lt15wk/tempreal
  u15lt27wk=u15lt27wk/tempreal
  ugt27wk=ugt27wk/tempreal


    !!===========================================================
    !! CALCULATE WAGE DISTRIBUTION & mM ratio
    !!===========================================================



  !! MEAN WAGES
            !


            meanwage_all=SUM(wagepz_distribution_sim(:, :))/SUM(epz_distribution_sim(:,:))
            meanwage_young=SUM(wagepz_young_distribution_sim(:, :))/SUM(epz_young_distribution_sim(:,:))
            meanwage_prime=SUM(wagepz_prime_distribution_sim(:, :))/SUM(epz_prime_distribution_sim(:,:))

            meanwage_x1=SUM(wage(:,1, :)*epz_x_distribution_sim(:,1,:))/SUM(epz_x_distribution_sim(:,1,:))
            meanwage_x2=0.0_8
            meanwage_x3=0.0_8
            IF(xpts>=2) meanwage_x2=SUM(wage(:,2, :)*epz_x_distribution_sim(:,2,:))/SUM(epz_x_distribution_sim(:,2,:))
            IF(xpts>=3) meanwage_x3=SUM(wage(:,3, :)*epz_x_distribution_sim(:,3,:))/SUM(epz_x_distribution_sim(:,3,:))

            meanwage_x1_young=SUM(wage(:,1, :)*epz_x_young_distribution_sim(:,1,:))/SUM(epz_x_young_distribution_sim(:,1,:))
            meanwage_x2_young=0.0_8
            meanwage_x3_young=0.0_8
            IF(xpts>=2) meanwage_x2_young=SUM(wage(:,2, :)*epz_x_young_distribution_sim(:,2,:))/SUM(epz_x_young_distribution_sim(:,2,:))
            IF(xpts>=3) meanwage_x3_young=SUM(wage(:,3, :)*epz_x_young_distribution_sim(:,3,:))/SUM(epz_x_young_distribution_sim(:,3,:))

            meanwage_x1_prime=SUM(wage(:,1, :)*epz_x_prime_distribution_sim(:,1,:))/SUM(epz_x_prime_distribution_sim(:,1,:))
            meanwage_x2_prime=0.0_8
            meanwage_x3_prime=0.0_8
            IF(xpts>=2) meanwage_x2_prime=SUM(wage(:,2, :)*epz_x_prime_distribution_sim(:,2,:))/SUM(epz_x_prime_distribution_sim(:,2,:))
            IF(xpts>=3) meanwage_x3_prime=SUM(wage(:,3, :)*epz_x_prime_distribution_sim(:,3,:))/SUM(epz_x_prime_distribution_sim(:,3,:))


            !! Per pcnt
            DO pcnt=1, ppts

                meanwage_all_p(pcnt)=SUM(wagepz_distribution_sim(pcnt, :))/SUM(epz_distribution_sim(pcnt,:))
                meanwage_young_p(pcnt)=SUM(wagepz_young_distribution_sim(pcnt, :))/SUM(epz_young_distribution_sim(pcnt,:))
                meanwage_prime_p(pcnt)=SUM(wagepz_prime_distribution_sim(pcnt, :))/SUM(epz_prime_distribution_sim(pcnt,:))

                meanwage_x1_p(pcnt)=SUM(wage(pcnt,1, :)*epz_x_distribution_sim(pcnt,1,:))/SUM(epz_x_distribution_sim(pcnt,1,:))
                meanwage_x2_p(pcnt)=0.0_8
                meanwage_x3_p(pcnt)=0.0_8
                IF(xpts>=2) meanwage_x2_p(pcnt)=SUM(wage(pcnt,2, :)*epz_x_distribution_sim(pcnt,2,:))/SUM(epz_x_distribution_sim(pcnt,2,:))
                IF(xpts>=3) meanwage_x3_p(pcnt)=SUM(wage(pcnt,3, :)*epz_x_distribution_sim(pcnt,3,:))/SUM(epz_x_distribution_sim(pcnt,3,:))

                meanwage_x1_young_p(pcnt)=SUM(wage(pcnt,1, :)*epz_x_young_distribution_sim(pcnt,1,:))/SUM(epz_x_young_distribution_sim(pcnt,1,:))
                meanwage_x2_young_p(pcnt)=0.0_8
                meanwage_x3_young_p(pcnt)=0.0_8
                IF(xpts>=2) meanwage_x2_young_p(pcnt)=SUM(wage(pcnt,2, :)*epz_x_young_distribution_sim(pcnt,2,:))/SUM(epz_x_young_distribution_sim(pcnt,2,:))
                IF(xpts>=3) meanwage_x3_young_p(pcnt)=SUM(wage(pcnt,3, :)*epz_x_young_distribution_sim(pcnt,3,:))/SUM(epz_x_young_distribution_sim(pcnt,3,:))

                meanwage_x1_prime_p(pcnt)=SUM(wage(pcnt,1, :)*epz_x_prime_distribution_sim(pcnt,1,:))/SUM(epz_x_prime_distribution_sim(pcnt,1,:))
                meanwage_x2_prime_p(pcnt)=0.0_8
                meanwage_x3_prime_p(pcnt)=0.0_8
                IF(xpts>=2) meanwage_x2_prime_p(pcnt)=SUM(wage(pcnt,2, :)*epz_x_prime_distribution_sim(pcnt,2,:))/SUM(epz_x_prime_distribution_sim(pcnt,2,:))
                IF(xpts>=3) meanwage_x3_prime_p(pcnt)=SUM(wage(pcnt,3, :)*epz_x_prime_distribution_sim(pcnt,3,:))/SUM(epz_x_prime_distribution_sim(pcnt,3,:))
    END DO



    !! NORMALIZE WAGE DISTRIBUTIONS

    DO pcnt=1, ppts
        DO zcnt=1, zpts

            tempreal=epz_distribution_sim(pcnt,zcnt)
            tempreal2=epz_young_distribution_sim(pcnt,zcnt)
            tempreal3=epz_prime_distribution_sim(pcnt,zcnt)


             IF(tempreal>0.0) wagepz_distribution_sim(pcnt,zcnt)=wagepz_distribution_sim(pcnt,zcnt)/tempreal
             IF(tempreal2>0.0) wagepz_young_distribution_sim(pcnt,zcnt)=wagepz_young_distribution_sim(pcnt,zcnt)/tempreal2
             IF(tempreal3>0.0) wagepz_prime_distribution_sim(pcnt,zcnt)=wagepz_prime_distribution_sim(pcnt,zcnt)/tempreal3


        END DO
    END DO

    !! RELATIVE DENSITY OF POPULATION


    epz_x2_pmass=0.0_8
    epz_x3_pmass=0.0_8
    epz_x1_pmass=SUM(epz_x_distribution_sim(:,1,:))
    IF(xpts>=2) epz_x2_pmass=SUM(epz_x_distribution_sim(:,2,:))
    IF(xpts>=2) epz_x3_pmass=SUM(epz_x_distribution_sim(:,3,:))
    tempreal=epz_x1_pmass+epz_x2_pmass+epz_x3_pmass
    IF(tempreal>0.0_8) THEN
        epz_x1_pmass=epz_x1_pmass/tempreal
        epz_x2_pmass=epz_x2_pmass/tempreal
        epz_x3_pmass=epz_x3_pmass/tempreal
    END IF

    epz_x2_young_pmass=0.0_8
    epz_x3_young_pmass=0.0_8
    epz_x1_young_pmass=SUM(epz_x_distribution_sim(:,1,:))
    IF(xpts>=2) epz_x2_young_pmass=SUM(epz_x_distribution_sim(:,2,:))
    IF(xpts>=2) epz_x3_young_pmass=SUM(epz_x_distribution_sim(:,3,:))
    tempreal=epz_x1_young_pmass+epz_x2_young_pmass+epz_x3_young_pmass
    IF(tempreal>0.0_8) THEN
        epz_x1_young_pmass=epz_x1_young_pmass/tempreal
        epz_x2_young_pmass=epz_x2_young_pmass/tempreal
        epz_x3_young_pmass=epz_x3_young_pmass/tempreal
    END IF

    epz_x2_young_pmass=0.0_8
    epz_x3_young_pmass=0.0_8
    epz_x1_young_pmass=SUM(epz_x_young_distribution_sim(:,1,:))
    IF(xpts>=2) epz_x2_young_pmass=SUM(epz_x_young_distribution_sim(:,2,:))
    IF(xpts>=2) epz_x3_young_pmass=SUM(epz_x_young_distribution_sim(:,3,:))
    tempreal=epz_x1_young_pmass+epz_x2_young_pmass+epz_x3_young_pmass
    IF(tempreal>0.0_8) THEN
        epz_x1_young_pmass=epz_x1_young_pmass/tempreal
        epz_x2_young_pmass=epz_x2_young_pmass/tempreal
        epz_x3_young_pmass=epz_x3_young_pmass/tempreal
    END IF

    epz_x2_prime_pmass=0.0_8
    epz_x3_prime_pmass=0.0_8
    epz_x1_prime_pmass=SUM(epz_x_prime_distribution_sim(:,1,:))
    IF(xpts>=2) epz_x2_prime_pmass=SUM(epz_x_prime_distribution_sim(:,2,:))
    IF(xpts>=2) epz_x3_prime_pmass=SUM(epz_x_prime_distribution_sim(:,3,:))
    tempreal=epz_x1_prime_pmass+epz_x2_prime_pmass+epz_x3_prime_pmass
    IF(tempreal>0.0_8) THEN
        epz_x1_prime_pmass=epz_x1_prime_pmass/tempreal
        epz_x2_prime_pmass=epz_x2_prime_pmass/tempreal
        epz_x3_prime_pmass=epz_x3_prime_pmass/tempreal
    END IF

    epz_young_pmass=SUM(epz_young_distribution_sim(:,:))
    epz_prime_pmass=SUM(epz_prime_distribution_sim(:,:))
    tempreal=epz_young_pmass+epz_prime_pmass
    IF(tempreal>0.0_8) epz_young_pmass=epz_young_pmass/tempreal
    IF(tempreal>0.0_8) epz_prime_pmass=epz_prime_pmass/tempreal

    ! can do this per aggregate state too
    DO pcnt=1,ppts
    epz_x2_pmass_p(pcnt)=0.0_8
    epz_x3_pmass_p(pcnt)=0.0_8
    epz_x1_pmass_p(pcnt)=SUM(epz_x_distribution_sim(pcnt,1,:))
    IF(xpts>=2) epz_x2_pmass_p(pcnt)=SUM(epz_x_distribution_sim(pcnt,2,:))
    IF(xpts>=2) epz_x3_pmass_p(pcnt)=SUM(epz_x_distribution_sim(pcnt,3,:))
    tempreal=epz_x1_pmass_p(pcnt)+epz_x2_pmass_p(pcnt)+epz_x3_pmass_p(pcnt)
    IF(tempreal>0.0_8) THEN
        epz_x1_pmass_p(pcnt)=epz_x1_pmass_p(pcnt)/tempreal
        epz_x2_pmass_p(pcnt)=epz_x2_pmass_p(pcnt)/tempreal
        epz_x3_pmass_p(pcnt)=epz_x3_pmass_p(pcnt)/tempreal
    END IF

    epz_x2_young_pmass_p(pcnt)=0.0_8
    epz_x3_young_pmass_p(pcnt)=0.0_8
    epz_x1_young_pmass_p(pcnt)=SUM(epz_x_young_distribution_sim(pcnt,1,:))
    IF(xpts>=2) epz_x2_young_pmass_p(pcnt)=SUM(epz_x_young_distribution_sim(pcnt,2,:))
    IF(xpts>=2) epz_x3_young_pmass_p(pcnt)=SUM(epz_x_young_distribution_sim(pcnt,3,:))
    tempreal=epz_x1_young_pmass_p(pcnt)+epz_x2_young_pmass_p(pcnt)+epz_x3_young_pmass_p(pcnt)
    IF(tempreal>0.0_8) THEN
        epz_x1_young_pmass_p(pcnt)=epz_x1_young_pmass_p(pcnt)/tempreal
        epz_x2_young_pmass_p(pcnt)=epz_x2_young_pmass_p(pcnt)/tempreal
        epz_x3_young_pmass_p(pcnt)=epz_x3_young_pmass_p(pcnt)/tempreal
    END IF

    epz_x2_prime_pmass_p(pcnt)=0.0_8
    epz_x3_prime_pmass_p(pcnt)=0.0_8
    epz_x1_prime_pmass_p(pcnt)=SUM(epz_x_prime_distribution_sim(pcnt,1,:))
    IF(xpts>=2) epz_x2_prime_pmass_p(pcnt)=SUM(epz_x_prime_distribution_sim(pcnt,2,:))
    IF(xpts>=2) epz_x3_prime_pmass_p(pcnt)=SUM(epz_x_prime_distribution_sim(pcnt,3,:))
    tempreal=epz_x1_prime_pmass_p(pcnt)+epz_x2_prime_pmass_p(pcnt)+epz_x3_prime_pmass_p(pcnt)
    IF(tempreal>0.0_8) THEN
        epz_x1_prime_pmass_p(pcnt)=epz_x1_prime_pmass_p(pcnt)/tempreal
        epz_x2_prime_pmass_p(pcnt)=epz_x2_prime_pmass_p(pcnt)/tempreal
        epz_x3_prime_pmass_p(pcnt)=epz_x3_prime_pmass_p(pcnt)/tempreal
    END IF

    epz_young_pmass_p(pcnt)=SUM(epz_young_distribution_sim(pcnt,:))
    epz_prime_pmass_p(pcnt)=SUM(epz_prime_distribution_sim(pcnt,:))
    tempreal=epz_young_pmass_p(pcnt)+epz_prime_pmass_p(pcnt)
    IF(tempreal>0.0_8) epz_young_pmass_p(pcnt)=epz_young_pmass_p(pcnt)/tempreal
    IF(tempreal>0.0_8) epz_prime_pmass_p(pcnt)=epz_prime_pmass_p(pcnt)/tempreal

    END DO

    !epz_x1_pmass_p, epz_x2_pmass_p, epz_x3_pmass_p, epz_x1_young_pmass_p, epz_x2_young_pmass_p,&
    !epz_x3_young_pmass_p, epz_x1_prime_pmass_p, epz_x2_prime_pmass_p, epz_x3_prime_pmass_p, &
    !epz_young_pmass_p, epz_prime_pmass_p

    !!----------------------------------------
    !! NORMALIZE (UN) EMPLOYMENT DISTRIBUTIONS

    epz_xallp_distribution_sim=epz_x_distribution_sim/SUM(epz_x_distribution_sim(:,:,:))
    epz_xallp_young_distribution_sim=epz_x_young_distribution_sim/SUM(epz_x_young_distribution_sim(:,:,:))
    epz_xallp_prime_distribution_sim=epz_x_prime_distribution_sim/SUM(epz_x_prime_distribution_sim(:,:,:))

    ! all workers
normalize_do1: &
 DO pcnt=1, ppts

    up_rest_distribution_sim(pcnt)=up_rest_distribution_sim(pcnt)/REAL(up_distribution_sim(pcnt)+ep_distribution_sim(pcnt))
    up_reall_distribution_sim(pcnt)=up_reall_distribution_sim(pcnt)/REAL(up_distribution_sim(pcnt)+ep_distribution_sim(pcnt))
    up_search_distribution_sim(pcnt)=up_search_distribution_sim(pcnt)/REAL(up_distribution_sim(pcnt)+ep_distribution_sim(pcnt))

    up_distribution_sim(pcnt)=up_distribution_sim(pcnt)/REAL(up_distribution_sim(pcnt)+ep_distribution_sim(pcnt))
    uallp_distribution_sim(pcnt)=uallp_distribution_sim(pcnt)/REAL(uallp_distribution_sim(pcnt)+eallp_distribution_sim(pcnt))
    !! ALL WORKERS
    tempreal=sum(upz_distribution_sim(pcnt, :)+epz_distribution_sim(pcnt, :))
    tempreal2=sum(upz_distribution_sim(pcnt, :))
    tempreal3=sum(epz_distribution_sim(pcnt, :))

    tempreal4=sum(epz_x_distribution_sim(pcnt, 1,:))
    IF(xpts>=2) tempreal5=sum(epz_x_distribution_sim(pcnt, 2,:))
    IF(xpts>=3)  tempreal6=sum(epz_x_distribution_sim(pcnt, 3,:))

    IF (tempreal>0.0_8) THEN
        up_distribution_sim2(pcnt)=sum(upz_distribution_sim(pcnt,:))/REAL(tempreal)
        upz_distribution_sim(pcnt,:)=upz_distribution_sim(pcnt,:)/REAL(tempreal)
        epz_distribution_sim(pcnt,:)=epz_distribution_sim(pcnt,:)/REAL(tempreal)

        DO xcnt=1,xpts
            epz_x_distribution_sim(pcnt,xcnt,:)=epz_x_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
            upz_x_distribution_sim(pcnt,xcnt,:)=upz_x_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
        END DO

    
    END IF
    !! YOUNG
    tempreal=sum(upz_young_distribution_sim(pcnt, :)+epz_young_distribution_sim(pcnt, :))
    tempreal2=sum(upz_young_distribution_sim(pcnt, :))
    tempreal3=sum(epz_young_distribution_sim(pcnt, :))
    tempreal4=sum(epz_x_young_distribution_sim(pcnt, 1,:))
    IF(xpts>=2) tempreal5=sum(epz_x_young_distribution_sim(pcnt, 2,:))
    IF(xpts>=3)  tempreal6=sum(epz_x_young_distribution_sim(pcnt, 3,:))


    IF (tempreal>0.0_8) THEN
        up_young_distribution_sim(pcnt)=sum(upz_young_distribution_sim(pcnt,:))/REAL(tempreal)
        upz_young_distribution_sim(pcnt,:)=upz_young_distribution_sim(pcnt,:)/REAL(tempreal)
        epz_young_distribution_sim(pcnt,:)=epz_young_distribution_sim(pcnt,:)/REAL(tempreal)

        DO xcnt=1,xpts
            epz_x_young_distribution_sim(pcnt,xcnt,:)=epz_x_young_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
            upz_x_young_distribution_sim(pcnt,xcnt,:)=upz_x_young_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
        END DO

        up_young_rest_distribution_sim(pcnt)=up_young_rest_distribution_sim(pcnt)/tempreal
        up_young_reall_distribution_sim(pcnt)=up_young_reall_distribution_sim(pcnt)/tempreal
        up_young_search_distribution_sim(pcnt)=up_young_search_distribution_sim(pcnt)/tempreal

    END IF


    tempreal=sum(upz_prime_distribution_sim(pcnt, :)+epz_prime_distribution_sim(pcnt,:))
    tempreal2=sum(upz_prime_distribution_sim(pcnt, :))
    tempreal3=sum(epz_prime_distribution_sim(pcnt, :))
    tempreal4=sum(epz_x_prime_distribution_sim(pcnt, 1,:))
    IF(xpts>=2) tempreal5=sum(epz_x_prime_distribution_sim(pcnt, 2,:))
    IF(xpts>=3)  tempreal6=sum(epz_x_prime_distribution_sim(pcnt, 3,:))

    IF (tempreal>0.0_8) THEN
        up_prime_distribution_sim(pcnt)=sum(upz_prime_distribution_sim(pcnt,:))/REAL(tempreal)
        upz_prime_distribution_sim(pcnt,:)=upz_prime_distribution_sim(pcnt,:)/REAL(tempreal)
        epz_prime_distribution_sim(pcnt,:)=epz_prime_distribution_sim(pcnt,:)/REAL(tempreal)

        DO xcnt=1,xpts
            epz_x_prime_distribution_sim(pcnt,xcnt,:)=epz_x_prime_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
            upz_x_prime_distribution_sim(pcnt,xcnt,:)=upz_x_prime_distribution_sim(pcnt,xcnt,:)/REAL(tempreal)
        END DO

        up_prime_rest_distribution_sim(pcnt)=up_prime_rest_distribution_sim(pcnt)/tempreal
        up_prime_reall_distribution_sim(pcnt)=up_prime_reall_distribution_sim(pcnt)/tempreal
        up_prime_search_distribution_sim(pcnt)=up_prime_search_distribution_sim(pcnt)/tempreal

    END IF


    !IF (tempreal>0.0_8) up_prime_distribution_sim(pcnt)=sum(upz_prime_distribution_sim(pcnt,:))/tempreal
    !IF (tempreal2>0.0_8) upz_prime_distribution_sim(pcnt,:)=upz_prime_distribution_sim(pcnt,:)/REAL(tempreal)
    !IF (tempreal3>0.0_8) epz_prime_distribution_sim(pcnt,:)=epz_prime_distribution_sim(pcnt,:)/REAL(tempreal)
    !IF(tempreal4>0.0_8) epz_x_prime_distribution_sim(pcnt,1,:)=epz_x_prime_distribution_sim(pcnt,1,:)/REAL(tempreal)
    !IF(xpts>=2 .and. tempreal5>0.0_8) epz_x_prime_distribution_sim(pcnt,2,:)=epz_x_prime_distribution_sim(pcnt,2,:)/REAL(tempreal)
    !IF(xpts>=3 .and. tempreal6>0.0_8) epz_x_prime_distribution_sim(pcnt,3,:)=epz_x_prime_distribution_sim(pcnt,3,:)/REAL(tempreal)




    tempreal=sum(epz_1yb4_x_distribution_sim(pcnt,:, :))
    IF(tempreal>0.0_8) THEN
        epz_1yb4_x_distribution_sim(pcnt,:,:)=epz_1yb4_x_distribution_sim(pcnt,:,:)/REAL(tempreal)
    END IF

    ! DONE IN STATA?
    !DO zcnt=1, zpts
    !    epz_1yb4_distribution_sim(pcnt,:)=sum(epz_1yb4_x_distribution_sim(pcnt,zcnt,:))
    !END DO

    tempreal2=sum(sep_epz_1yb4_x_distribution_sim(pcnt,:, :))
    IF(tempreal2>0.0_8) THEN
        sep_epz_1yb4_x_distribution_sim(pcnt,:,:)=sep_epz_1yb4_x_distribution_sim(pcnt,:,:)/REAL(tempreal)
    END IF


    !

    END DO normalize_do1

!!==========================================================
!! SUPEROCC DISTRIBUTION
!!==========================================================

normalize_supocc_do1: &
    DO pcnt=1, ppts

    !! normalize by entire population employed in an aggregate productivity state
    tempreal2=0.0
    DO occcnt=1, occpts
    DO xcnt=1, xpts
        tempreal2=tempreal2+sum(uopxz_distribution_sim(occcnt, pcnt, xcnt,:)+eopxz_distribution_sim(occcnt, pcnt, xcnt,:))
    END DO
    END DO 
    
    DO occcnt=1, occpts 
!! ALL WORKERS
    tempreal=sum(uopz_distribution_sim(occcnt, pcnt, :)+eopz_distribution_sim(occcnt, pcnt, :))
    
    IF (tempreal>0.0_8) THEN
        uopz_distribution_sim(occcnt,pcnt,:)=uopz_distribution_sim(occcnt,pcnt,:)/REAL(tempreal)
        eopz_distribution_sim(occcnt,pcnt,:)=eopz_distribution_sim(occcnt,pcnt,:)/REAL(tempreal)
    
        uop_rest_distribution_sim(occcnt,pcnt)=uop_rest_distribution_sim(occcnt, pcnt)/REAL(tempreal)
        uop_reall_distribution_sim(occcnt, pcnt)=uop_reall_distribution_sim(occcnt, pcnt)/REAL(tempreal)
        uop_search_distribution_sim(occcnt, pcnt)=uop_search_distribution_sim(occcnt, pcnt)/REAL(tempreal)

    END IF

    
    DO xcnt=1,xpts
            uopxz_distribution_sim(occcnt, pcnt,xcnt,:)=uopxz_distribution_sim(occcnt, pcnt,xcnt,:)/REAL(tempreal2)
            eopxz_distribution_sim(occcnt, pcnt,xcnt,:)=eopxz_distribution_sim(occcnt, pcnt,xcnt,:)/REAL(tempreal2)
    END DO

    
    
    !! YOUNG
    tempreal=sum(uopz_young_distribution_sim(occcnt, pcnt, :)+eopz_young_distribution_sim(occcnt, pcnt, :))
    

    IF (tempreal>0.0_8) THEN
        uopz_young_distribution_sim(occcnt, pcnt,:)=uopz_young_distribution_sim(occcnt, pcnt,:)/REAL(tempreal)
        eopz_young_distribution_sim(occcnt, pcnt,:)=eopz_young_distribution_sim(occcnt, pcnt,:)/REAL(tempreal)

        
        uop_young_rest_distribution_sim(occcnt, pcnt)=uop_young_rest_distribution_sim(occcnt, pcnt)/tempreal
        uop_young_reall_distribution_sim(occcnt, pcnt)=uop_young_reall_distribution_sim(occcnt, pcnt)/tempreal
        uop_young_search_distribution_sim(occcnt, pcnt)=uop_young_search_distribution_sim(occcnt, pcnt)/tempreal

    END IF
    
    !! PRIME 

    tempreal=sum(uopz_prime_distribution_sim(occcnt, pcnt, :)+eopz_prime_distribution_sim(occcnt, pcnt,:))
    
    IF (tempreal>0.0_8) THEN
        uopz_prime_distribution_sim(occcnt, pcnt,:)=uopz_prime_distribution_sim(occcnt, pcnt,:)/REAL(tempreal)
        eopz_prime_distribution_sim(occcnt, pcnt,:)=eopz_prime_distribution_sim(occcnt, pcnt,:)/REAL(tempreal)

    
        uop_prime_rest_distribution_sim(occcnt, pcnt)=uop_prime_rest_distribution_sim(occcnt, pcnt)/tempreal
        uop_prime_reall_distribution_sim(occcnt, pcnt)=uop_prime_reall_distribution_sim(occcnt, pcnt)/tempreal
        uop_prime_search_distribution_sim(occcnt, pcnt)=uop_prime_search_distribution_sim(occcnt, pcnt)/tempreal

    END IF


    
    !
END DO 
END DO normalize_supocc_do1



    !!----------------------------------------
    !! PERCENTILE


            ! SET THOSE VARIABLES TO ZERO THAT DO NOT NECESSARILY ARE FILLED IN
            m0mratio_x2=0.0_8
            m0mratio_x3=0.0_8
            m0mratio_x2_young=0.0_8
            m0mratio_x3_young=0.0_8
            m0mratio_x2_prime=0.0_8
            m0mratio_x3_prime=0.0_8
            m0mratio_x2_p=0.0_8
            m0mratio_x3_p=0.0_8
            m0mratio_x2_young_p=0.0_8
            m0mratio_x3_young_p=0.0_8
            m0mratio_x2_prime_p=0.0_8
            m0mratio_x3_prime_p=0.0_8

            m1mratio_x2=0.0_8
            m1mratio_x3=0.0_8
            m1mratio_x2_young=0.0_8
            m1mratio_x3_young=0.0_8
            m1mratio_x2_prime=0.0_8
            m1mratio_x3_prime=0.0_8
            m1mratio_x2_p=0.0_8
            m1mratio_x3_p=0.0_8
            m1mratio_x2_young_p=0.0_8
            m1mratio_x3_young_p=0.0_8
            m1mratio_x2_prime_p=0.0_8
            m1mratio_x3_prime_p=0.0_8


            m5mratio_x2=0.0_8
            m5mratio_x3=0.0_8
            m5mratio_x2_young=0.0_8
            m5mratio_x3_young=0.0_8
            m5mratio_x2_prime=0.0_8
            m5mratio_x3_prime=0.0_8
            m5mratio_x2_p=0.0_8
            m5mratio_x3_p=0.0_8
            m5mratio_x2_young_p=0.0_8
            m5mratio_x3_young_p=0.0_8
            m5mratio_x2_prime_p=0.0_8
            m5mratio_x3_prime_p=0.0_8

            m10mratio_x2=0.0_8
            m10mratio_x3=0.0_8
            m10mratio_x2_young=0.0_8
            m10mratio_x3_young=0.0_8
            m10mratio_x2_prime=0.0_8
            m10mratio_x3_prime=0.0_8
            m10mratio_x2_p=0.0_8
            m10mratio_x3_p=0.0_8
            m10mratio_x2_young_p=0.0_8
            m10mratio_x3_young_p=0.0_8
            m10mratio_x2_prime_p=0.0_8
            m10mratio_x3_prime_p=0.0_8


            !m0mratio_all_p(pcnt)=wquantile(0.0_8,pack(wagepz_distribution_sim(:,:), epz_distribution_sim(:,:)>0.0_8) , pack(epz_distribution_sim(:,:), epz_distribution_sim(:,:)>0.0_8))
            !m0mratio_young_p(pcnt)=wquantile(0.0_8,pack(wagepz_young_distribution_sim(:,:), epz_young_distribution_sim(:,:)>0.0_8) , pack(epz_young_distribution_sim(:,:), epz_young_distribution_sim(:,:)>0.0_8))
            !m0mratio_prime_p(pcnt)=wquantile(0.0_8,pack(wagepz_prime_distribution_sim(:,:), epz_prime_distribution_sim(:,:)>0.0_8) , pack(epz_prime_distribution_sim(:,:), epz_prime_distribution_sim(:,:)>0.0_8))

            m0mratio_all=wquantile(0.0_8,pack(wage(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8))
            m0mratio_x1=wquantile(0.0_8,pack(wage(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2=wquantile(0.0_8,pack(wage(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3=wquantile(0.0_8,pack(wage(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8))

            m0mratio_young=wquantile(0.0_8,pack(wage(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8))
            m0mratio_x1_young=wquantile(0.0_8,pack(wage(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2_young=wquantile(0.0_8,pack(wage(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3_young=wquantile(0.0_8,pack(wage(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8))

            m0mratio_prime=wquantile(0.0_8,pack(wage(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8))
            m0mratio_x1_prime=wquantile(0.0_8,pack(wage(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2_prime=wquantile(0.0_8,pack(wage(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3_prime=wquantile(0.0_8,pack(wage(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8))


        DO pcnt=1, ppts
            m0mratio_all_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8))
            m0mratio_x1_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8))

            m0mratio_young_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8))
            m0mratio_x1_young_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2_young_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3_young_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8))

            m0mratio_prime_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8))
            m0mratio_x1_prime_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m0mratio_x2_prime_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m0mratio_x3_prime_p(pcnt)=wquantile(0.0_8,pack(wage(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8))
    END DO

    !! 1st percentile


            m1mratio_all=wquantile(0.01_8,pack(wage(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8))
            m1mratio_x1=wquantile(0.01_8,pack(wage(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2=wquantile(0.01_8,pack(wage(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3=wquantile(0.01_8,pack(wage(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8))

            m1mratio_young=wquantile(0.01_8,pack(wage(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8))
            m1mratio_x1_young=wquantile(0.01_8,pack(wage(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2_young=wquantile(0.01_8,pack(wage(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3_young=wquantile(0.01_8,pack(wage(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8))

            m1mratio_prime=wquantile(0.01_8,pack(wage(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8))
            m1mratio_x1_prime=wquantile(0.01_8,pack(wage(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2_prime=wquantile(0.01_8,pack(wage(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3_prime=wquantile(0.01_8,pack(wage(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8))


        DO pcnt=1, ppts
            m1mratio_all_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8))
            m1mratio_x1_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8))

            m1mratio_young_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8))
            m1mratio_x1_young_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2_young_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3_young_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8))

            m1mratio_prime_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8))
            m1mratio_x1_prime_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m1mratio_x2_prime_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m1mratio_x3_prime_p(pcnt)=wquantile(0.01_8,pack(wage(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8))
    END DO

        !! 5th percentile

            m5mratio_all=wquantile(0.05_8,pack(wage(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8))
            m5mratio_x1=wquantile(0.05_8,pack(wage(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2=wquantile(0.05_8,pack(wage(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3=wquantile(0.05_8,pack(wage(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8))

            m5mratio_young=wquantile(0.05_8,pack(wage(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8))
            m5mratio_x1_young=wquantile(0.05_8,pack(wage(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2_young=wquantile(0.05_8,pack(wage(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3_young=wquantile(0.05_8,pack(wage(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8))

            m5mratio_prime=wquantile(0.05_8,pack(wage(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8))
            m5mratio_x1_prime=wquantile(0.05_8,pack(wage(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2_prime=wquantile(0.05_8,pack(wage(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3_prime=wquantile(0.05_8,pack(wage(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8))


        DO pcnt=1, ppts
            m5mratio_all_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8))
            m5mratio_x1_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8))

            m5mratio_young_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8))
            m5mratio_x1_young_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2_young_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3_young_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8))

            m5mratio_prime_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8))
            m5mratio_x1_prime_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m5mratio_x2_prime_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m5mratio_x3_prime_p(pcnt)=wquantile(0.05_8,pack(wage(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8))
    END DO

        !! 10th percentile

            m10mratio_all=wquantile(0.1_8,pack(wage(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,:,:), epz_xallp_distribution_sim(:,:,:)>0.0_8))
            m10mratio_x1=wquantile(0.1_8,pack(wage(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,1,:), epz_xallp_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2=wquantile(0.1_8,pack(wage(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,2,:), epz_xallp_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3=wquantile(0.1_8,pack(wage(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8) , pack(epz_xallp_distribution_sim(:,3,:), epz_xallp_distribution_sim(:,3,:)>0.0_8))

            m10mratio_young=wquantile(0.1_8,pack(wage(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,:,:), epz_x_young_distribution_sim(:,:,:)>0.0_8))
            m10mratio_x1_young=wquantile(0.1_8,pack(wage(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,1,:), epz_x_young_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2_young=wquantile(0.1_8,pack(wage(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,2,:), epz_x_young_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3_young=wquantile(0.1_8,pack(wage(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(:,3,:), epz_x_young_distribution_sim(:,3,:)>0.0_8))

            m10mratio_prime=wquantile(0.1_8,pack(wage(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,:,:), epz_x_prime_distribution_sim(:,:,:)>0.0_8))
            m10mratio_x1_prime=wquantile(0.1_8,pack(wage(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,1,:), epz_x_prime_distribution_sim(:,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2_prime=wquantile(0.1_8,pack(wage(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,2,:), epz_x_prime_distribution_sim(:,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3_prime=wquantile(0.1_8,pack(wage(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(:,3,:), epz_x_prime_distribution_sim(:,3,:)>0.0_8))


        DO pcnt=1, ppts
            m10mratio_all_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8))
            m10mratio_x1_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,1,:), epz_x_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,2,:), epz_x_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,3,:), epz_x_distribution_sim(pcnt,3,:)>0.0_8))

            m10mratio_young_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,:,:), epz_x_young_distribution_sim(pcnt,:,:)>0.0_8))
            m10mratio_x1_young_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,1,:), epz_x_young_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2_young_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,2,:), epz_x_young_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3_young_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_young_distribution_sim(pcnt,3,:), epz_x_young_distribution_sim(pcnt,3,:)>0.0_8))

            m10mratio_prime_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,:,:), epz_x_prime_distribution_sim(pcnt,:,:)>0.0_8))
            m10mratio_x1_prime_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,1,:), epz_x_prime_distribution_sim(pcnt,1,:)>0.0_8))
            IF(xpts>=2) m10mratio_x2_prime_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,2,:), epz_x_prime_distribution_sim(pcnt,2,:)>0.0_8))
            IF(xpts>=3) m10mratio_x3_prime_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8) , pack(epz_x_prime_distribution_sim(pcnt,3,:), epz_x_prime_distribution_sim(pcnt,3,:)>0.0_8))
    END DO



    !! DIVISION TO GET TO mM ratio
            m0mratio_all=meanwage_all/m0mratio_all
            m0mratio_young=meanwage_young/m0mratio_young
            m0mratio_prime=meanwage_prime/m0mratio_prime

            m0mratio_x1=meanwage_x1/m0mratio_x1
            IF(xpts>=2) m0mratio_x2=meanwage_x2/m0mratio_x2
            IF(xpts>=3) m0mratio_x3=meanwage_x3/m0mratio_x3

            m0mratio_x1_young=meanwage_x1_young/m0mratio_x1_young
            IF(xpts>=2) m0mratio_x2_young=meanwage_x2_young/m0mratio_x2_young
            IF(xpts>=3) m0mratio_x3_young=meanwage_x3_young/m0mratio_x3_young

            m0mratio_x1_prime=meanwage_x1_prime/m0mratio_x1_prime
            IF(xpts>=2) m0mratio_x2_prime=meanwage_x2_prime/m0mratio_x2_prime
            IF(xpts>=3) m0mratio_x3_prime=meanwage_x3_prime/m0mratio_x3_prime

            !! Per pcnt
            DO pcnt=1, ppts

                    m0mratio_all_p(pcnt)=meanwage_all_p(pcnt)/m0mratio_all_p(pcnt)
                    m0mratio_young_p(pcnt)=meanwage_young_p(pcnt)/m0mratio_young_p(pcnt)
                    m0mratio_prime_p(pcnt)=meanwage_prime_p(pcnt)/m0mratio_prime_p(pcnt)

                    m0mratio_x1_p(pcnt)=meanwage_x1_p(pcnt)/m0mratio_x1_p(pcnt)
                    IF(xpts>=2) m0mratio_x2_p(pcnt)=meanwage_x2_p(pcnt)/m0mratio_x2_p(pcnt)
                    IF(xpts>=3) m0mratio_x3_p(pcnt)=meanwage_x3_p(pcnt)/m0mratio_x3_p(pcnt)

                    m0mratio_x1_young_p(pcnt)=meanwage_x1_young_p(pcnt)/m0mratio_x1_young_p(pcnt)
                    IF(xpts>=2) m0mratio_x2_young_p(pcnt)=meanwage_x2_young_p(pcnt)/m0mratio_x2_young_p(pcnt)
                    IF(xpts>=3) m0mratio_x3_young_p(pcnt)=meanwage_x3_young_p(pcnt)/m0mratio_x3_young_p(pcnt)

                    m0mratio_x1_prime_p(pcnt)=meanwage_x1_prime_p(pcnt)/m0mratio_x1_prime_p(pcnt)
                    IF(xpts>=2) m0mratio_x2_prime_p(pcnt)=meanwage_x2_prime_p(pcnt)/m0mratio_x2_prime_p(pcnt)
                    IF(xpts>=3) m0mratio_x3_prime_p(pcnt)=meanwage_x3_prime_p(pcnt)/m0mratio_x3_prime_p(pcnt)

    END DO

            !! 1st percentile Mm ratio

    !! DIVISION TO GET TO mM ratio
            m1mratio_all=meanwage_all/m1mratio_all
            m1mratio_young=meanwage_young/m1mratio_young
            m1mratio_prime=meanwage_prime/m1mratio_prime

            m1mratio_x1=meanwage_x1/m1mratio_x1
            IF(xpts>=2) m1mratio_x2=meanwage_x2/m1mratio_x2
            IF(xpts>=3) m1mratio_x3=meanwage_x3/m1mratio_x3

            m1mratio_x1_young=meanwage_x1_young/m1mratio_x1_young
            IF(xpts>=2) m1mratio_x2_young=meanwage_x2_young/m1mratio_x2_young
            IF(xpts>=3) m1mratio_x3_young=meanwage_x3_young/m1mratio_x3_young

            m1mratio_x1_prime=meanwage_x1_prime/m1mratio_x1_prime
            IF(xpts>=2) m1mratio_x2_prime=meanwage_x2_prime/m1mratio_x2_prime
            IF(xpts>=3) m1mratio_x3_prime=meanwage_x3_prime/m1mratio_x3_prime

            !! Per pcnt
            DO pcnt=1, ppts

                    m1mratio_all_p(pcnt)=meanwage_all_p(pcnt)/m1mratio_all_p(pcnt)
                    m1mratio_young_p(pcnt)=meanwage_young_p(pcnt)/m1mratio_young_p(pcnt)
                    m1mratio_prime_p(pcnt)=meanwage_prime_p(pcnt)/m1mratio_prime_p(pcnt)

                    m1mratio_x1_p(pcnt)=meanwage_x1_p(pcnt)/m1mratio_x1_p(pcnt)
                    IF(xpts>=2) m1mratio_x2_p(pcnt)=meanwage_x2_p(pcnt)/m1mratio_x2_p(pcnt)
                    IF(xpts>=3) m1mratio_x3_p(pcnt)=meanwage_x3_p(pcnt)/m1mratio_x3_p(pcnt)

                    m1mratio_x1_young_p(pcnt)=meanwage_x1_young_p(pcnt)/m1mratio_x1_young_p(pcnt)
                    IF(xpts>=2) m1mratio_x2_young_p(pcnt)=meanwage_x2_young_p(pcnt)/m1mratio_x2_young_p(pcnt)
                    IF(xpts>=3) m1mratio_x3_young_p(pcnt)=meanwage_x3_young_p(pcnt)/m1mratio_x3_young_p(pcnt)

                    m1mratio_x1_prime_p(pcnt)=meanwage_x1_prime_p(pcnt)/m1mratio_x1_prime_p(pcnt)
                    IF(xpts>=2) m1mratio_x2_prime_p(pcnt)=meanwage_x2_prime_p(pcnt)/m1mratio_x2_prime_p(pcnt)
                    IF(xpts>=3) m1mratio_x3_prime_p(pcnt)=meanwage_x3_prime_p(pcnt)/m1mratio_x3_prime_p(pcnt)

    END DO

            !! 5th percentile Mm ratio

    !! DIVISION TO GET TO mM ratio
            m5mratio_all=meanwage_all/m5mratio_all
            m5mratio_young=meanwage_young/m5mratio_young
            m5mratio_prime=meanwage_prime/m5mratio_prime

            m5mratio_x1=meanwage_x1/m5mratio_x1
            IF(xpts>=2) m5mratio_x2=meanwage_x2/m5mratio_x2
            IF(xpts>=3) m5mratio_x3=meanwage_x3/m5mratio_x3

            m5mratio_x1_young=meanwage_x1_young/m5mratio_x1_young
            IF(xpts>=2) m5mratio_x2_young=meanwage_x2_young/m5mratio_x2_young
            IF(xpts>=3) m5mratio_x3_young=meanwage_x3_young/m5mratio_x3_young

            m5mratio_x1_prime=meanwage_x1_prime/m5mratio_x1_prime
            IF(xpts>=2) m5mratio_x2_prime=meanwage_x2_prime/m5mratio_x2_prime
            IF(xpts>=3) m5mratio_x3_prime=meanwage_x3_prime/m5mratio_x3_prime

            !! Per pcnt
            DO pcnt=1, ppts

                    m5mratio_all_p(pcnt)=meanwage_all_p(pcnt)/m5mratio_all_p(pcnt)
                    m5mratio_young_p(pcnt)=meanwage_young_p(pcnt)/m5mratio_young_p(pcnt)
                    m5mratio_prime_p(pcnt)=meanwage_prime_p(pcnt)/m5mratio_prime_p(pcnt)

                    m5mratio_x1_p(pcnt)=meanwage_x1_p(pcnt)/m5mratio_x1_p(pcnt)
                    IF(xpts>=2) m5mratio_x2_p(pcnt)=meanwage_x2_p(pcnt)/m5mratio_x2_p(pcnt)
                    IF(xpts>=3) m5mratio_x3_p(pcnt)=meanwage_x3_p(pcnt)/m5mratio_x3_p(pcnt)

                    m5mratio_x1_young_p(pcnt)=meanwage_x1_young_p(pcnt)/m5mratio_x1_young_p(pcnt)
                    IF(xpts>=2) m5mratio_x2_young_p(pcnt)=meanwage_x2_young_p(pcnt)/m5mratio_x2_young_p(pcnt)
                    IF(xpts>=3) m5mratio_x3_young_p(pcnt)=meanwage_x3_young_p(pcnt)/m5mratio_x3_young_p(pcnt)

                    m5mratio_x1_prime_p(pcnt)=meanwage_x1_prime_p(pcnt)/m5mratio_x1_prime_p(pcnt)
                    IF(xpts>=2) m5mratio_x2_prime_p(pcnt)=meanwage_x2_prime_p(pcnt)/m5mratio_x2_prime_p(pcnt)
                    IF(xpts>=3) m5mratio_x3_prime_p(pcnt)=meanwage_x3_prime_p(pcnt)/m5mratio_x3_prime_p(pcnt)

    END DO


    !! DIVISION TO GET TO mM ratio
            m10mratio_all=meanwage_all/m10mratio_all
            m10mratio_young=meanwage_young/m10mratio_young
            m10mratio_prime=meanwage_prime/m10mratio_prime

            m10mratio_x1=meanwage_x1/m10mratio_x1
            IF(xpts>=2) m10mratio_x2=meanwage_x2/m10mratio_x2
            IF(xpts>=3) m10mratio_x3=meanwage_x3/m10mratio_x3

            m10mratio_x1_young=meanwage_x1_young/m10mratio_x1_young
            IF(xpts>=2) m10mratio_x2_young=meanwage_x2_young/m10mratio_x2_young
            IF(xpts>=3) m10mratio_x3_young=meanwage_x3_young/m10mratio_x3_young

            m10mratio_x1_prime=meanwage_x1_prime/m10mratio_x1_prime
            IF(xpts>=2) m10mratio_x2_prime=meanwage_x2_prime/m10mratio_x2_prime
            IF(xpts>=3) m10mratio_x3_prime=meanwage_x3_prime/m10mratio_x3_prime

            !! Per pcnt
            DO pcnt=1, ppts

                    m10mratio_all_p(pcnt)=meanwage_all_p(pcnt)/m10mratio_all_p(pcnt)
                    m10mratio_young_p(pcnt)=meanwage_young_p(pcnt)/m10mratio_young_p(pcnt)
                    m10mratio_prime_p(pcnt)=meanwage_prime_p(pcnt)/m10mratio_prime_p(pcnt)

                    m10mratio_x1_p(pcnt)=meanwage_x1_p(pcnt)/m10mratio_x1_p(pcnt)
                    IF(xpts>=2) m10mratio_x2_p(pcnt)=meanwage_x2_p(pcnt)/m10mratio_x2_p(pcnt)
                    IF(xpts>=3) m10mratio_x3_p(pcnt)=meanwage_x3_p(pcnt)/m10mratio_x3_p(pcnt)

                    m10mratio_x1_young_p(pcnt)=meanwage_x1_young_p(pcnt)/m10mratio_x1_young_p(pcnt)
                    IF(xpts>=2) m10mratio_x2_young_p(pcnt)=meanwage_x2_young_p(pcnt)/m10mratio_x2_young_p(pcnt)
                    IF(xpts>=3) m10mratio_x3_young_p(pcnt)=meanwage_x3_young_p(pcnt)/m10mratio_x3_young_p(pcnt)

                    m10mratio_x1_prime_p(pcnt)=meanwage_x1_prime_p(pcnt)/m10mratio_x1_prime_p(pcnt)
                    IF(xpts>=2) m10mratio_x2_prime_p(pcnt)=meanwage_x2_prime_p(pcnt)/m10mratio_x2_prime_p(pcnt)
                    IF(xpts>=3) m10mratio_x3_prime_p(pcnt)=meanwage_x3_prime_p(pcnt)/m10mratio_x3_prime_p(pcnt)

    END DO


    !! MUELLER MOMENTS
     DO pcnt=1, ppts
         prod_median(pcnt)=wquantile(0.5_8,pack(prod(pcnt,:,:), epz_1yb4_x_distribution_sim(pcnt,:,:)>0.0_8) , &
                                    pack(epz_1yb4_x_distribution_sim(pcnt,:,:), epz_1yb4_x_distribution_sim(pcnt,:,:)>0.0_8))
         wage_median(pcnt)=wquantile(0.5_8,pack(wage(pcnt,:,:), epz_1yb4_x_distribution_sim(pcnt,:,:)>0.0_8) , &
                                    pack(epz_1yb4_x_distribution_sim(pcnt,:,:), epz_1yb4_x_distribution_sim(pcnt,:,:)>0.0_8))
         !m10mratio_all_p(pcnt)=wquantile(0.1_8,pack(wage(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8) , pack(epz_x_distribution_sim(pcnt,:,:), epz_x_distribution_sim(pcnt,:,:)>0.0_8))


    !tempreal=
    sep_prod_above_med(pcnt)=SUM(pack(sep_epz_1yb4_x_distribution_sim(pcnt,:,:), prod(pcnt,:,:)>prod_median(pcnt)))/SUM(pack(epz_1yb4_x_distribution_sim(pcnt,:,:), prod(pcnt,:,:)>prod_median(pcnt)))
    sep_prod_below_med(pcnt)=SUM(pack(sep_epz_1yb4_x_distribution_sim(pcnt,:,:), prod(pcnt,:,:)<=prod_median(pcnt)))/SUM(pack(epz_1yb4_x_distribution_sim(pcnt,:,:), prod(pcnt,:,:)<=prod_median(pcnt)))
    sep_wage_above_med(pcnt)=SUM(pack(sep_epz_1yb4_x_distribution_sim(pcnt,:,:), wage(pcnt,:,:)>wage_median(pcnt)))/SUM(pack(epz_1yb4_x_distribution_sim(pcnt,:,:), wage(pcnt,:,:)>wage_median(pcnt)))
    sep_wage_below_med(pcnt)=SUM(pack(sep_epz_1yb4_x_distribution_sim(pcnt,:,:), wage(pcnt,:,:)<=wage_median(pcnt)))/SUM(pack(epz_1yb4_x_distribution_sim(pcnt,:,:), wage(pcnt,:,:)<=wage_median(pcnt)))

    END DO



    !!======================
    !!!   RENORMALIZE THE EMPLOYMENT AND UNEMPLOYMENT DISTRIBUTION
    !!!!===========================

    !! FIRST THE (P,Z) DISTRIBUTION

    !
    !DO pcnt=1, ppts
    !
    !
    !        tempreal=SUM(epz_x_distribution_sim(pcnt,1,:))
    !        IF(xpts>=2) tempreal2=SUM(epz_x_distribution_sim(pcnt,2,:))
    !        IF(xpts>=3) tempreal3=SUM(epz_x_distribution_sim(pcnt,3,:))
    !
    !             IF(tempreal>0.0) epz_x_distribution_sim(pcnt,1,:)=epz_x_distribution_sim(pcnt,1,:)/tempreal
    !             IF(xpts>=2 .and. tempreal2>0.0) epz_x_distribution_sim(pcnt,2,:)=epz_x_distribution_sim(pcnt,2,:)/tempreal2
    !             IF(xpts>=3 .and. tempreal3>0.0) epz_x_distribution_sim(pcnt,3,:)=epz_x_distribution_sim(pcnt,3,:)/tempreal3
    !
    !        tempreal=SUM(epz_x_young_distribution_sim(pcnt,1,:))
    !        IF(xpts>=2) tempreal2=SUM(epz_x_young_distribution_sim(pcnt,2,:))
    !        IF(xpts>=3) tempreal3=SUM(epz_x_young_distribution_sim(pcnt,3,:))
    !
    !             IF(tempreal>0.0) epz_x_young_distribution_sim(pcnt,1,:)=epz_x_young_distribution_sim(pcnt,1,:)/tempreal
    !             IF(xpts>=2 .and. tempreal2>0.0) epz_x_young_distribution_sim(pcnt,2,:)=epz_x_young_distribution_sim(pcnt,2,:)/tempreal2
    !             IF(xpts>=3 .and. tempreal3>0.0) epz_x_young_distribution_sim(pcnt,3,:)=epz_x_young_distribution_sim(pcnt,3,:)/tempreal3
    !
    !        tempreal=SUM(epz_x_prime_distribution_sim(pcnt,1,:))
    !        IF(xpts>=2) tempreal2=SUM(epz_x_prime_distribution_sim(pcnt,2,:))
    !        IF(xpts>=3) tempreal3=SUM(epz_x_prime_distribution_sim(pcnt,3,:))
    !
    !             IF(tempreal>0.0) epz_x_prime_distribution_sim(pcnt,1,:)=epz_x_prime_distribution_sim(pcnt,1,:)/tempreal
    !             IF(xpts>=2 .and. tempreal2>0.0) epz_x_prime_distribution_sim(pcnt,2,:)=epz_x_prime_distribution_sim(pcnt,2,:)/tempreal2
    !             IF(xpts>=3 .and. tempreal3>0.0) epz_x_prime_distribution_sim(pcnt,3,:)=epz_x_prime_distribution_sim(pcnt,3,:)/tempreal3
    !END DO

    !! CALCULATE AVERAGE MM RATIOS

    m0mratio_age_contr=epz_young_pmass*m0mratio_young+epz_prime_pmass*m0mratio_prime
    m0mratio_age_x_contr=epz_young_pmass*(epz_x1_young_pmass*m0mratio_x1_young + epz_x2_young_pmass*m0mratio_x2_young + epz_x3_young_pmass*m0mratio_x3_young) &
                            + epz_prime_pmass*(epz_x1_prime_pmass*m0mratio_x1_prime + epz_x2_prime_pmass*m0mratio_x2_prime + epz_x3_prime_pmass*m0mratio_x3_prime)

    m0mratio_age_p_contr=0.0_8
    DO pcnt=1, ppts
        m0mratio_age_p_contr=m0mratio_age_p_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(m0mratio_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(m0mratio_prime_p(pcnt)))
    END DO

    m0mratio_age_p_x_contr=0.0_8
    IF(xpts==3) THEN
    DO pcnt=1, ppts
        m0mratio_age_p_x_contr=m0mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m0mratio_x1_young_p(pcnt) + epz_x2_young_pmass_p(pcnt)*m0mratio_x2_young_p(pcnt) &
                                        + epz_x3_young_pmass_p(pcnt)*m0mratio_x3_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m0mratio_x1_prime_p(pcnt) + epz_x2_prime_pmass_p(pcnt)*m0mratio_x2_prime_p(pcnt) &
                                    + epz_x3_prime_pmass_p(pcnt)*m0mratio_x3_prime_p(pcnt)))
    END DO
    END IF
    IF(xpts==1) THEN
    m0mratio_age_p_x_contr=0.0_8
    DO pcnt=1, ppts
        m0mratio_age_p_x_contr=m0mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m0mratio_x1_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m0mratio_x1_prime_p(pcnt)))
    END DO
    END IF

    ! 1st ptile
    m1mratio_age_contr=epz_young_pmass*m1mratio_young+epz_prime_pmass*m1mratio_prime
    m1mratio_age_x_contr=epz_young_pmass*(epz_x1_young_pmass*m1mratio_x1_young + epz_x2_young_pmass*m1mratio_x2_young + epz_x3_young_pmass*m1mratio_x3_young) &
                            + epz_prime_pmass*(epz_x1_prime_pmass*m1mratio_x1_prime + epz_x2_prime_pmass*m1mratio_x2_prime + epz_x3_prime_pmass*m1mratio_x3_prime)

    m1mratio_age_p_contr=0.0_8
    DO pcnt=1, ppts
        m1mratio_age_p_contr=m1mratio_age_p_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(m1mratio_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(m1mratio_prime_p(pcnt)))
    END DO


    m1mratio_age_p_x_contr=0.0_8
    IF(xpts==3) THEN
    DO pcnt=1, ppts
        m1mratio_age_p_x_contr=m1mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m1mratio_x1_young_p(pcnt) + epz_x2_young_pmass_p(pcnt)*m1mratio_x2_young_p(pcnt) &
                                        + epz_x3_young_pmass_p(pcnt)*m1mratio_x3_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m1mratio_x1_prime_p(pcnt) + epz_x2_prime_pmass_p(pcnt)*m1mratio_x2_prime_p(pcnt) &
                                    + epz_x3_prime_pmass_p(pcnt)*m1mratio_x3_prime_p(pcnt)))
    END DO
    END IF
    IF(xpts==1) THEN
    m1mratio_age_p_x_contr=0.0_8
    DO pcnt=1, ppts
        m1mratio_age_p_x_contr=m1mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m1mratio_x1_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m1mratio_x1_prime_p(pcnt)))
    END DO
    END IF


    ! 5th ptile
    m5mratio_age_contr=epz_young_pmass*m5mratio_young+epz_prime_pmass*m5mratio_prime
    m5mratio_age_x_contr=epz_young_pmass*(epz_x1_young_pmass*m5mratio_x1_young + epz_x2_young_pmass*m5mratio_x2_young + epz_x3_young_pmass*m5mratio_x3_young) &
                            + epz_prime_pmass*(epz_x1_prime_pmass*m5mratio_x1_prime + epz_x2_prime_pmass*m5mratio_x2_prime + epz_x3_prime_pmass*m5mratio_x3_prime)

    m5mratio_age_p_contr=0.0_8
    DO pcnt=1, ppts
        m5mratio_age_p_contr=m5mratio_age_p_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(m5mratio_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(m5mratio_prime_p(pcnt)))
    END DO


    m5mratio_age_p_x_contr=0.0_8
    IF(xpts==3) THEN
    DO pcnt=1, ppts
        m5mratio_age_p_x_contr=m5mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m5mratio_x1_young_p(pcnt) + epz_x2_young_pmass_p(pcnt)*m5mratio_x2_young_p(pcnt) &
                                        + epz_x3_young_pmass_p(pcnt)*m5mratio_x3_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m5mratio_x1_prime_p(pcnt) + epz_x2_prime_pmass_p(pcnt)*m5mratio_x2_prime_p(pcnt) &
                                    + epz_x3_prime_pmass_p(pcnt)*m5mratio_x3_prime_p(pcnt)))
    END DO
    END IF
    IF(xpts==1) THEN
    m5mratio_age_p_x_contr=0.0_8
    DO pcnt=1, ppts
        m5mratio_age_p_x_contr=m5mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m5mratio_x1_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m5mratio_x1_prime_p(pcnt)))
    END DO
    END IF


    m10mratio_age_contr=epz_young_pmass*m10mratio_young+epz_prime_pmass*m10mratio_prime
    m10mratio_age_x_contr=epz_young_pmass*(epz_x1_young_pmass*m10mratio_x1_young + epz_x2_young_pmass*m10mratio_x2_young + epz_x3_young_pmass*m10mratio_x3_young) &
                            + epz_prime_pmass*(epz_x1_prime_pmass*m10mratio_x1_prime + epz_x2_prime_pmass*m10mratio_x2_prime + epz_x3_prime_pmass*m10mratio_x3_prime)
    m10mratio_age_p_contr=0.0_8
    DO pcnt=1, ppts
        m10mratio_age_p_contr=m10mratio_age_p_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(m10mratio_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(m10mratio_prime_p(pcnt)))
    END DO

    m10mratio_age_p_x_contr=0.0_8
    IF(xpts==3) THEN
    DO pcnt=1, ppts
        m10mratio_age_p_x_contr=m10mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m10mratio_x1_young_p(pcnt) + epz_x2_young_pmass_p(pcnt)*m10mratio_x2_young_p(pcnt) &
                                        + epz_x3_young_pmass_p(pcnt)*m10mratio_x3_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m10mratio_x1_prime_p(pcnt) + epz_x2_prime_pmass_p(pcnt)*m10mratio_x2_prime_p(pcnt) &
                                    + epz_x3_prime_pmass_p(pcnt)*m10mratio_x3_prime_p(pcnt)))
    END DO
    END IF
    IF(xpts==1) THEN
    m10mratio_age_p_x_contr=0.0_8
    DO pcnt=1, ppts
        m10mratio_age_p_x_contr=m10mratio_age_p_x_contr+&
            p_distribution_sim(pcnt)*(epz_young_pmass_p(pcnt)*(epz_x1_young_pmass_p(pcnt)*m10mratio_x1_young_p(pcnt)) &
                                    + epz_prime_pmass_p(pcnt)*(epz_x1_prime_pmass_p(pcnt)*m10mratio_x1_prime_p(pcnt)))
    END DO
    END IF

    !up_distribution_sim(:)=    up_distribution_sim(:)/(REAL(nsim_gen)*REAL(tmax_sim2))
    !up_young_distribution_sim(:)=    up_young_distribution_sim(:)/sum(data_young_qtr(:))
    !up_prime_distribution_sim(:)=    up_prime_distribution_sim(:)/(REAL(nsim_gen)*REAL(tmax_sim2)-sum(data_young_qtr(:)))
!    IF (threadnumber==1) THEN
!    t=4000
!        WRITE(*,*) 'at t, u, v,theta, jf, jfo, sep, wage prod'
!        WRITE(*,FMT='(I5, 8(F8.3,X) )') t, data_u_qtr(t), data_v_qtr(t), data_theta_qtr(t), data_jf_qtr(t),data_jfo_qtr(t), &
!        data_sep_qtr(t), data_wage_qtr(t), data_prod_qtr(t)
!    END IF !(threadnumber==1)

        !------------------------------------
        !   DERIVED MOMENTS
        !------------------------------------

!IF (threadnumber==1) THEN
!CLOSE(49)
!CLOSE(50)
!CLOSE(51)
!CLOSE(53)
!END IF ! (threadnumber==1)


! IF (threadnumber==1 .AND. verboseswitchfile==1) THEN
! OPEN(UNIT=93, file='monthlyseries2.txt', form='formatted', status='replace')
! WRITE(93, FMT='(8(A8,A3), A8)', ADVANCE='no') 'unempl1', ',' , 'unempl2', ',-,', 'vacancy1', ',' , 'vacancy2', ',-,',&
! 'tightns1', ',', 'tightns2', ',-,', 'jbfind1', ',', 'jbfind2', ',-,' , 'no.agnts'
! WRITE(93, FMT='(6(A8,A3))', ADVANCE='no') 'sep rate', ',' , 'sepr2', ',-,' ,'prod', ',', 'prod2', ',-,' , 'wage', ',' , 'wage2', ',-,'
! WRITE(93, FMT='(3(A8,A3))') 'cinfl', ',' , 'ninfl', ',', 'aggprod'
!
! DO t=1, tmax_qtr
!   WRITE(93, FMT='(8(F8.4,A3), I6, A3)', ADVANCE='no') data_u_qtr(t), ',' , data_u_qtr(t), ',|,' ,&
!             data_v_qtr(t), ',' , data_v_qtr(t), ',|,' ,data_theta_qtr(t), ',' , data_theta_qtr(t), ',|,' , &
!             data_jf_qtr(t), ',' , data_jf_qtr(t), ',|,' , number_agents(t), ',|,'
!
!   WRITE(93, FMT='(6(F7.5,A3))',ADVANCE='no') data_sep_qtr(t), ',' , data_sep_qtr(t), ',|,' , data_prod_qtr(t), ',' , data_prod_qtr(t), ',|,' , &
!              0.0_8, ',' , 0.0_8, ',|,'
!   WRITE(93, FMT='(4(F10.3,A3))',ADVANCE='no') data_cocc_inflow_qtr(t), ',' , data_nocc_inflow_qtr(t), ',|,' ! , data_temp_qtr(t), ',|,'  , data_temp_qtr2(t), ',|,'
!   WRITE(93, FMT='(F8.3)') pvector(aggprod_ind(t))
! END DO
! WRITE(93, *) 'tot_dur(0)_cocc=', tot_durationmatrix_cocc(0), 'tot_dur(0)_nocc=', tot_durationmatrix_nocc(0)
! CLOSE(93)
! END IF

!  !$OMP CRITICAL
!DEALLOCATE(data_temp_qtr, data_temp_qtr2)
!  !$OMP END CRITICAL

!=======
!!USE THE LAST tmax_sim observations of tmax_sim2 series
!============

    IF (tmax_sim2>tmax_sim) THEN
        WRITE(*,*) '---- tmax_sim/tmax_sim2 discordance----'
    END IF


    ! further deallocate memory
    !$OMP CRITICAL
    DEALLOCATE(poliDW, & !VE, VU, EV, & !TH, TH_U, DmaxU,Dmax,
                        JF, poliR, WAGE)
    DEALLOCATE(poliDW_Occ, PoliR_Occ, JF_Occ, WAGE_Occ, Searchdir_Occ)

    !$OMP END CRITICAL



!!===============================================================================
!!  PACKING THE TIME SERIES
!!===============================================================================


    ! after packing, we have to make sure that the HP filtering takes the new time span into account
    ! replace HPSCRATCH in HPFILT2 HPFILT_YEARLY for this indicator.
tempint=((tmax_sim2-12-MAX((tmin_sim2/12)*12,5))/12)+5+20

! temporary test
    !mask_qtr= .TRUE.
    !tmax_mask_qtr=tmax_qtr


!ALLOCATE(data_temp_qtr(tempint))

 CALL PACK_DATA_QTR(data_young_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_prime_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_u_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_uall_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_uraw_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_e_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_uadj18m_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_u_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_u_prime_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_uadj18m_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_uadj18m_prime_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_e_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_e_prime_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_ucompldur_occ_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_ucompldur_young_occ_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_ucompldur_prime_occ_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_ucompldur_nocc_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_ucompldur_young_nocc_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_ucompldur_prime_nocc_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_u_qtr_p33, mask_qtr)
 CALL PACK_DATA_QTR(data_u_qtr_p50, mask_qtr)
 CALL PACK_DATA_QTR(data_u_qtr_p67, mask_qtr)


! data_totduration_cocc_qtr(counter1,0:18), data_totduration_nocc_qtr(counter1,0:18), &
!data_totduration_cocc_young_qtr(counter1,0:18), data_totduration_nocc_young_qtr(counter1,0:18),&
!data_totduration_cocc_prime_qtr(counter1,0:18), data_totduration_nocc_prime_qtr(counter1,0:18),&
!data_compduration_cocc_qtr(counter1,0:18), data_compduration_nocc_qtr(counter1,0:18), &
!data_compduration_cocc_young_qtr(counter1,0:18), data_compduration_nocc_young_qtr(counter1,0:18),&
!data_compduration_cocc_prime_qtr(counter1,0:18), data_compduration_nocc_prime_qtr(counter1,0:18),&
!data_totduration_cr_cocc_qtr(counter1,0:18), data_totduration_cr_nocc_qtr(counter1,0:18),&
!data_totduration_cr_cocc_young_qtr(counter1,0:18), data_totduration_cr_nocc_young_qtr(counter1,0:18),&
!data_totduration_cr_cocc_prime_qtr(counter1,0:18), data_totduration_cr_nocc_prime_qtr(counter1,0:18),&

 DO i=0,18

     CALL PACK_DATA_QTR(data_totduration_cocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_nocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_nocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cocc_prime_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_nocc_prime_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_cocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_nocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_cocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_nocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_cocc_prime_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_compduration_nocc_prime_qtr(:,i), mask_qtr)


     CALL PACK_DATA_QTR(data_totduration_cr_cocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cr_nocc_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cr_cocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cr_nocc_young_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cr_cocc_prime_qtr(:,i), mask_qtr)
     CALL PACK_DATA_QTR(data_totduration_cr_nocc_prime_qtr(:,i), mask_qtr)
END DO

 CALL PACK_DATA_QTR(data_v_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_theta_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_jf_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_jf_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_jf_prime_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_prod_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_wage_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_sep_qtr, mask_qtr)
 DO occcnt=1, occpts
    CALL PACK_DATA_QTR(data_supocc_sep_qtr(occcnt,:), mask_qtr)
    CALL PACK_DATA_QTR(data_supocc_udur_qtr(occcnt,:), mask_qtr)
    CALL PACK_DATA_QTR(data_supocc_u_qtr(occcnt,:), mask_qtr)
    CALL PACK_DATA_QTR(data_supocc_e_qtr(occcnt,:), mask_qtr)
 END DO
 CALL PACK_DATA_QTR(data_sep_y_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_sep_p_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_cocc_inflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_cocc_young_inflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_cocc_prime_inflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_inflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_young_inflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_prime_inflow_qtr, mask_qtr)

 CALL PACK_DATA_QTR(data_cocc_outflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_cocc_young_outflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_cocc_prime_outflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_outflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_young_outflow_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_nocc_prime_outflow_qtr, mask_qtr)


CALL PACK_DATA_QTR(data_cocc_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_cocc_young_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_cocc_prime_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_nocc_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_nocc_young_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_nocc_prime_qtr, mask_qtr)

CALL PACK_DATA_QTR( data_pocc_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_pnocc_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_pocc_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_pnocc_young_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_pocc_prime_qtr, mask_qtr)
 CALL PACK_DATA_QTR(data_pnocc_prime_qtr, mask_qtr)

CALL PACK_DATA_QTR(data_ult5wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_u5lt15wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_u15lt27wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ugt27wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult5wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_u5lt15wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_u15lt27wk_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ugt27wk_qtr, mask_qtr)

CALL PACK_DATA_QTR(data_ult3m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult5m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult9m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult13m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ugt13m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult3m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult5m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult9m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult13m_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ugt13m_qtr, mask_qtr)


CALL PACK_DATA_QTR(data_ult3m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult5m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult9m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult13m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ugt13m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult3m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult5m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult9m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult13m_yng_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ugt13m_yng_qtr, mask_qtr)

CALL PACK_DATA_QTR(data_ult3m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult5m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult9m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ult13m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_ugt13m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult3m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult5m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult9m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ult13m_prm_qtr, mask_qtr)
CALL PACK_DATA_QTR(data_l_ugt13m_prm_qtr, mask_qtr)

DO occcnt=1, occpts
DO xcnt=1, occpts
    CALL PACK_DATA_QTR(data_superocc_transmatrix_qtr(occcnt,xcnt,:), mask_qtr)
    CALL PACK_DATA_QTR(data_corr_superocc_transmatrix_qtr(occcnt,xcnt,:), mask_qtr)
END DO
END DO

    
DO occcnt=1, occpts
DO xcnt=1, 2
    CALL PACK_DATA_QTR(corr_occdistr_exo_entry_exit_qtr(occcnt,xcnt, :), mask_qtr)
    CALL PACK_DATA_QTR(occdistr_exo_entry_exit_qtr(occcnt,xcnt, :), mask_qtr)
    CALL PACK_DATA_QTR(corr_occdistr_endo_entry_exit_qtr(occcnt,xcnt, :), mask_qtr)
    CALL PACK_DATA_QTR(occdistr_endo_entry_exit_qtr(occcnt,xcnt, :), mask_qtr)
END DO
END DO 

    
    
!DEALLOCATE(data_temp_qtr)

!! TMAX_QTR2
tmax_qtr2=tmax_mask_qtr


!! RE-USE MASK TO GET AWAY FROM THE EDGES IN HP-FILTERING
mask_qtr= .TRUE.


tempint=tmax_mask_qtr/tmax_mask_swindow_qtr
IF(tempint*tmax_mask_swindow_qtr .ne. tmax_mask_qtr ) WRITE(*,*) 'masked windows do not add up'

tempint=0
DO tcnt=1, tmax_mask_qtr
    IF(tcnt>=tempint*tmax_mask_swindow_qtr-8 .AND. tcnt<=tempint*tmax_mask_swindow_qtr+8) THEN
        mask_qtr(tcnt)=.FALSE.
    ELSE IF (tcnt==tempint*tmax_mask_swindow_qtr+9) THEN
        tempint=tempint+1
    END IF
END DO




IF(verbose_progress) WRITE(*,*) 'past packing'

!===================================================================
!  SOME QUARTERLY AVERAGES (from weekly data), OVERALL
!===================================================================


sepocc_ave=sepocc_ave/REAL(sepocc_ave_counter)
sepnocc_ave=sepnocc_ave/REAL(sepnocc_ave_counter)
sepocc_y_ave=sepocc_y_ave/REAL(sepocc_y_ave_counter)
sepnocc_y_ave=sepnocc_y_ave/REAL(sepnocc_y_ave_counter)
sepocc_p_ave=sepocc_p_ave/REAL(sepocc_p_ave_counter)
sepnocc_p_ave=sepnocc_p_ave/REAL(sepnocc_p_ave_counter)

    unemp_ave=sum(data_u_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    uall_ave=sum(data_uall_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    uadj18m_ave=sum(data_uadj18m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

    uadj18m_young_ave=sum(data_uadj18m_young_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    u_young_ave=sum(data_u_young_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    u_prime_ave=sum(data_u_prime_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

    cocc_ave=sum(data_cocc_outflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    cocc_young_ave=sum(data_cocc_young_outflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    cocc_prime_ave=sum(data_cocc_prime_outflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

    !cocc_inflow_ave=sum(data_cocc_inflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    !cocc_young_inflow_ave=sum(data_cocc_young_inflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    !cocc_prime_inflow_ave=sum(data_cocc_prime_inflow_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

    cocc_inflow_ave=tot_durationmatrix_cocc(1)
    cocc_young_inflow_ave=tot_durationmatrix_cocc_young(1)
    cocc_prime_inflow_ave=tot_durationmatrix_cocc_prime(1)

    !== UNEMPLOYMENT DURATION BY OCCUPATIONAL STAY OR MOVE
    udur_occ_ave_q=sum(data_ucompldur_occ_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    udur_nocc_ave_q=sum(data_ucompldur_nocc_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    udur_occ_young_ave_q=sum(data_ucompldur_young_occ_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    udur_nocc_young_ave_q=sum(data_ucompldur_young_nocc_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    udur_occ_prime_ave_q=sum(data_ucompldur_prime_occ_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    udur_nocc_prime_ave_q=sum(data_ucompldur_prime_nocc_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

    !== UNEMPLOYMENT DURATION BY OCCUPATIONAL STAY OR MOVE -- CENSORED.
    !   = censored: lower bound 1-6 months, upper bound 16


   udur_occ_with_hplu=0.0
   udur_occ_with_lu=0.0
   udur_occ_with_u=0.0
   udur_occ_with_hpu=0.0

   udur_nocc_with_u=0.0
   udur_nocc_with_hpu=0.0
   udur_nocc_with_hplu=0.0
   udur_nocc_with_lu=0.0

   udur_occ_young_with_hplu=0.0
   udur_occ_young_with_lu=0.0
   udur_occ_young_with_u=0.0
   udur_occ_young_with_hpu=0.0

   udur_nocc_young_with_u=0.0
   udur_nocc_young_with_hpu=0.0
   udur_nocc_young_with_hplu=0.0
   udur_nocc_young_with_lu=0.0

   udur_nocc_prime_with_hplu=0.0
   udur_nocc_prime_with_lu=0.0
   udur_nocc_prime_with_u=0.0
   udur_nocc_prime_with_hpu=0.0

   udur_occ_prime_with_u=0.0
   udur_occ_prime_with_hpu=0.0
   udur_occ_prime_with_hplu=0.0
   udur_occ_prime_with_lu=0.0


    udur_mvec_occ_ave=0.0_8
    udur_mvec_occ_young_ave=0.0_8
    udur_mvec_occ_prime_ave=0.0_8
    udur_mvec_nocc_ave=0.0_8
    udur_mvec_nocc_young_ave=0.0_8
    udur_mvec_nocc_prime_ave=0.0_8

    DO tcnt=1, 6

    tempreal=0.0_8
    tempreal2=0.0_8
    tempreal3=0.0_8
    tempreal4=0.0_8
    tempreal5=0.0_8
    tempreal6=0.0_8

        DO zcnt=tcnt, 18
            tempreal=tempreal+(data_compduration_cocc(zcnt))*REAL(zcnt)
            tempreal2=tempreal2+(data_compduration_cocc_young(zcnt))*REAL(zcnt)
            tempreal3=tempreal3+(data_compduration_cocc_prime(zcnt))*REAL(zcnt)
            tempreal4=tempreal4+(data_compduration_nocc(zcnt))*REAL(zcnt)
            tempreal5=tempreal5+(data_compduration_nocc_young(zcnt))*REAL(zcnt)
            tempreal6=tempreal6+(data_compduration_nocc_prime(zcnt))*REAL(zcnt)
        END DO ! zcnt
    udur_mvec_occ_ave(tcnt)=tempreal/sum(data_compduration_cocc(tcnt:18))
    udur_mvec_occ_young_ave(tcnt)=tempreal2/sum(data_compduration_cocc_young(tcnt:18))
    udur_mvec_occ_prime_ave(tcnt)=tempreal3/sum(data_compduration_cocc_prime(tcnt:18))
    udur_mvec_nocc_ave(tcnt)=tempreal4/sum(data_compduration_nocc(tcnt:18))
    udur_mvec_nocc_young_ave(tcnt)=tempreal5/sum(data_compduration_nocc_young(tcnt:18))
    udur_mvec_nocc_prime_ave(tcnt)=tempreal6/sum(data_compduration_nocc_prime(tcnt:18))
    END DO ! tcnt




    !!! CHECK WHICH VERSION TO TAKE
    !noccafterocc_ave=sum(tot_noccafterocc_vector(2:4))/3.0_8
    !noccafternocc_ave=sum(tot_noccafternocc_vector(2:4))/3.0_8
    !noccafternocc_ave=tot_noccafternocc_vector(1)
    !noccafterocc_y_ave=sum(tot_noccafterocc_vector_young(2:4))/3.0_8
    !noccafternocc_y_ave=sum(tot_noccafternocc_vector_young(2:4))/3.0_8
    !noccafterocc_p_ave=sum(tot_noccafterocc_vector_prime(2:4))/3.0_8
    !noccafternocc_p_ave=sum(tot_noccafternocc_vector_prime(2:4))/3.0_8
    !noccafterall_ave=1.0-(sum(tot_durationmatrix_cocc(2:4))/3.0_8)
    !noccafterall_y_ave=1.0-(sum(tot_durationmatrix_cocc_young(2:4))/3.0_8)
    !noccafterall_p_ave=1.0-(sum(tot_durationmatrix_cocc_prime(2:4))/3.0_8)

     !noccafterocc_ave=(tot_noccafterocc_vector(2))
    !noccafternocc_ave=(tot_noccafternocc_vector(2))    !noccafternocc_ave=tot_noccafternocc_vector(2)
    !noccafterocc_y_ave=(tot_noccafterocc_vector_young(2))
    !noccafternocc_y_ave=(tot_noccafternocc_vector_young(2))
    !noccafterocc_p_ave=(tot_noccafterocc_vector_prime(2))
    !noccafternocc_p_ave=(tot_noccafternocc_vector_prime(2))
    !noccafterall_ave=1.0-(tot_durationmatrix_cocc(2))
    !noccafterall_y_ave=1.0-(tot_durationmatrix_cocc_young(2))
    !noccafterall_p_ave=1.0-(tot_durationmatrix_cocc_prime(2))


    noccafterocc_ave=(tot_noccafterocc_vector(1))
    noccafternocc_ave=(tot_noccafternocc_vector(1))
    noccafterocc_y_ave=(tot_noccafterocc_vector_young(1))
    noccafternocc_y_ave=(tot_noccafternocc_vector_young(1))
    noccafterocc_p_ave=(tot_noccafterocc_vector_prime(1))
    noccafternocc_p_ave=(tot_noccafternocc_vector_prime(1))
    noccafterall_ave=1.0-(tot_durationmatrix_cocc(1))
    noccafterall_y_ave=1.0-(tot_durationmatrix_cocc_young(1))
    noccafterall_p_ave=1.0-(tot_durationmatrix_cocc_prime(1))


    v_ave=sum(data_v_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    theta_ave=sum(data_theta_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    ! NOTE: DIFFERENCE IS TIME AGGREGATION.
                ! jf_ave is average quarterly reate
                ! jf_ave2 is average individual job finding rate over the sample, weighs much more heavily recessions (more unemployment)
    jf_ave=sum(data_jf_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jf_ave2=jf_ave2/REAL(jf_ave2_counter)
    !WRITE(*,*) 'jf ave', jf_ave

    jf_young_ave=sum(data_jf_young_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jf_prime_ave=sum(data_jf_prime_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfocc_ave=sum(data_pocc_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfocc_young_ave=sum(data_pocc_young_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfocc_prime_ave=sum(data_pocc_prime_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfnocc_ave=sum(data_pnocc_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfnocc_young_ave=sum(data_pnocc_young_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    jfnocc_prime_ave=sum(data_pnocc_prime_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    sep_ave=sum(data_sep_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    sepyoung_ave=sum(data_sep_y_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    sepprime_ave=sum(data_sep_p_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    prod_ave=sum(data_prod_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
    wage_ave=sum(data_wage_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

   uprop_3m_ave=sum(data_ult3m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_5m_ave=sum(data_ult5m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_9m_ave=sum(data_ult9m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_13m_ave=sum(data_ult13m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_g13m_ave=sum(data_ugt13m_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

   uprop_yng_3m_ave=sum(data_ult3m_yng_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_yng_5m_ave=sum(data_ult5m_yng_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_yng_9m_ave=sum(data_ult9m_yng_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_yng_13m_ave=sum(data_ult13m_yng_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_yng_g13m_ave=sum(data_ugt13m_yng_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

   uprop_prm_3m_ave=sum(data_ult3m_prm_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_prm_5m_ave=sum(data_ult5m_prm_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_prm_9m_ave=sum(data_ult9m_prm_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_prm_13m_ave=sum(data_ult13m_prm_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   uprop_prm_g13m_ave=sum(data_ugt13m_prm_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

   ult5wk_ave=sum(data_ult5wk_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   u5lt15wk_ave=sum(data_u5lt15wk_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   u15lt27wk_ave=sum(data_u15lt27wk_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)
   ugt27wk_ave=sum(data_ugt27wk_qtr(1:tmax_qtr2))/REAL(tmax_qtr2)

tempreal=sum(data_supocc_e_qtr(:, 1:tmax_qtr2))
DO occcnt=1,occpts
    unemp_supocc_ave(occcnt)=sum(data_supocc_u_qtr(occcnt, 1:tmax_qtr2))/REAL(tmax_qtr2)
    e_supocc_ave(occcnt)=sum(data_supocc_e_qtr(occcnt, 1:tmax_qtr2))/tempreal
END DO

! LOG THE DURATIONS; THERE COULD BE ZEROES THAT MESS UP THE LOG CALCULATION!

data_l_ult5wk_qtr(1:tmax_qtr2)=LOG(data_ult5wk_qtr(1:tmax_qtr2))
data_l_u5lt15wk_qtr(1:tmax_qtr2)=LOG(data_u5lt15wk_qtr(1:tmax_qtr2))
data_l_u15lt27wk_qtr(1:tmax_qtr2)=LOG(data_u15lt27wk_qtr(1:tmax_qtr2))
data_l_ugt27wk_qtr(1:tmax_qtr2)=LOG(data_ugt27wk_qtr(1:tmax_qtr2))

data_l_ult3m_qtr(1:tmax_qtr2)=LOG(data_ult3m_qtr(1:tmax_qtr2))
data_l_ult5m_qtr(1:tmax_qtr2)=LOG(data_ult5m_qtr(1:tmax_qtr2))
data_l_ult9m_qtr(1:tmax_qtr2)=LOG(data_ult9m_qtr(1:tmax_qtr2))
data_l_ult13m_qtr(1:tmax_qtr2)=LOG(data_ult13m_qtr(1:tmax_qtr2))
data_l_ugt13m_qtr(1:tmax_qtr2)=LOG(data_ugt13m_qtr(1:tmax_qtr2))

data_l_ult3m_yng_qtr(1:tmax_qtr2)=LOG(data_ult3m_yng_qtr(1:tmax_qtr2))
data_l_ult5m_yng_qtr(1:tmax_qtr2)=LOG(data_ult5m_yng_qtr(1:tmax_qtr2))
data_l_ult9m_yng_qtr(1:tmax_qtr2)=LOG(data_ult9m_yng_qtr(1:tmax_qtr2))
data_l_ult13m_yng_qtr(1:tmax_qtr2)=LOG(data_ult13m_yng_qtr(1:tmax_qtr2))
data_l_ugt13m_yng_qtr(1:tmax_qtr2)=LOG(data_ugt13m_yng_qtr(1:tmax_qtr2))

data_l_ult3m_prm_qtr(1:tmax_qtr2)=LOG(data_ult3m_prm_qtr(1:tmax_qtr2))
data_l_ult5m_prm_qtr(1:tmax_qtr2)=LOG(data_ult5m_prm_qtr(1:tmax_qtr2))
data_l_ult9m_prm_qtr(1:tmax_qtr2)=LOG(data_ult9m_prm_qtr(1:tmax_qtr2))
data_l_ult13m_prm_qtr(1:tmax_qtr2)=LOG(data_ult13m_prm_qtr(1:tmax_qtr2))
data_l_ugt13m_prm_qtr(1:tmax_qtr2)=LOG(data_ugt13m_prm_qtr(1:tmax_qtr2))

data_supocc_lsep_qtr(:,1:tmax_qtr2)=LOG(data_supocc_sep_qtr(:,1:tmax_qtr2))
data_supocc_ludur_qtr(:,1:tmax_qtr2)=LOG(data_supocc_udur_qtr(:,1:tmax_qtr2))
data_supocc_lu_qtr(:,1:tmax_qtr2)=LOG(data_supocc_u_qtr(:,1:tmax_qtr2))

!calculate variances
var_uprop_3m_ave=VARCALCUL(data_ult3m_qtr, tmax_qtr2)
var_uprop_5m_ave=VARCALCUL(data_ult5m_qtr, tmax_qtr2)
var_uprop_9m_ave=VARCALCUL(data_ult9m_qtr, tmax_qtr2)
var_uprop_13m_ave=VARCALCUL(data_ult13m_qtr, tmax_qtr2)
var_uprop_g13m_ave=VARCALCUL(data_ugt13m_qtr, tmax_qtr2)
var_l_uprop_3m_ave=VARCALCUL(data_l_ult3m_qtr, tmax_qtr2)
var_l_uprop_5m_ave=VARCALCUL(data_l_ult5m_qtr, tmax_qtr2)
var_l_uprop_9m_ave=VARCALCUL(data_l_ult9m_qtr, tmax_qtr2)
var_l_uprop_13m_ave=VARCALCUL(data_l_ult13m_qtr, tmax_qtr2)
var_l_uprop_g13m_ave=VARCALCUL(data_l_ugt13m_qtr, tmax_qtr2)

var_uprop_yng_3m_ave=VARCALCUL(data_ult3m_yng_qtr, tmax_qtr2)
var_uprop_yng_5m_ave=VARCALCUL(data_ult5m_yng_qtr, tmax_qtr2)
var_uprop_yng_9m_ave=VARCALCUL(data_ult9m_yng_qtr, tmax_qtr2)
var_uprop_yng_13m_ave=VARCALCUL(data_ult13m_yng_qtr, tmax_qtr2)
var_uprop_yng_g13m_ave=VARCALCUL(data_ugt13m_yng_qtr, tmax_qtr2)

var_l_uprop_yng_3m_ave=VARCALCUL(data_l_ult3m_yng_qtr, tmax_qtr2)
var_l_uprop_yng_5m_ave=VARCALCUL(data_l_ult5m_yng_qtr, tmax_qtr2)
var_l_uprop_yng_9m_ave=VARCALCUL(data_l_ult9m_yng_qtr, tmax_qtr2)
var_l_uprop_yng_13m_ave=VARCALCUL(data_l_ult13m_yng_qtr, tmax_qtr2)
var_l_uprop_yng_g13m_ave=VARCALCUL(data_l_ugt13m_yng_qtr, tmax_qtr2)

var_uprop_prm_3m_ave=VARCALCUL(data_ult3m_prm_qtr, tmax_qtr2)
var_uprop_prm_5m_ave=VARCALCUL(data_ult5m_prm_qtr, tmax_qtr2)
var_uprop_prm_9m_ave=VARCALCUL(data_ult9m_prm_qtr, tmax_qtr2)
var_uprop_prm_13m_ave=VARCALCUL(data_ult13m_prm_qtr, tmax_qtr2)
var_uprop_prm_g13m_ave=VARCALCUL(data_ugt13m_prm_qtr, tmax_qtr2)

var_l_uprop_prm_3m_ave=VARCALCUL(data_l_ult3m_prm_qtr, tmax_qtr2)
var_l_uprop_prm_5m_ave=VARCALCUL(data_l_ult5m_prm_qtr, tmax_qtr2)
var_l_uprop_prm_9m_ave=VARCALCUL(data_l_ult9m_prm_qtr, tmax_qtr2)
var_l_uprop_prm_13m_ave=VARCALCUL(data_l_ult13m_prm_qtr, tmax_qtr2)
var_l_uprop_prm_g13m_ave=VARCALCUL(data_l_ugt13m_prm_qtr, tmax_qtr2)




var_ult5wk_ave=VARCALCUL(data_ult5wk_qtr, tmax_qtr2)
var_u5lt15wk_ave=VARCALCUL(data_u5lt15wk_qtr, tmax_qtr2)
var_u15lt27wk_ave=VARCALCUL(data_u15lt27wk_qtr, tmax_qtr2)
var_ugt27wk_ave=VARCALCUL(data_ugt27wk_qtr, tmax_qtr2)
var_l_ult5wk_ave=VARCALCUL(data_l_ult5wk_qtr, tmax_qtr2)
var_l_u5lt15wk_ave=VARCALCUL(data_l_u5lt15wk_qtr, tmax_qtr2)
var_l_u15lt27wk_ave=VARCALCUL(data_l_u15lt27wk_qtr, tmax_qtr2)
var_l_ugt27wk_ave=VARCALCUL(data_l_ugt27wk_qtr, tmax_qtr2)

IF(verbose_progress) THEN
    WRITE(*,*) 'ENTERING NON-HPF REGRESSIONS'
END IF

!$OMP CRITICAL
ALLOCATE(Xjf(1:tmax_qtr2,2), Yjf(1:tmax_qtr2,1))

Xjf(:,1)=1
Xjf(:,2)=0.0_8

!
! 1. EMPIRICAL ELASTICITY OF THE MATCHING FUNCTION: LINDT
Xjf(:,1)=1
Xjf(:,2)=LOG(data_theta_qtr(1: tmax_qtr2-2))
Yjf(1:tmax_qtr2-2,1)=LOG(data_jf_qtr(1:tmax_qtr2-2))
IF(verbose_progress) WRITE(*,*) 'check regression 1'
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf, errmsg)
elmatching_lindt_ave=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'elmatching_lindt_ave'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 1'
! 2. ELASTICITY U w/ v
Xjf(:,1)=1
Xjf(:,2)=LOG(data_v_qtr(1:tmax_qtr2-2))
Yjf(1:tmax_qtr2-2,1)=LOG(data_u_qtr(1: tmax_qtr2-2))
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf, errmsg)
el_u_with_v_lindt=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_u_with_v_lind'
    END IF
    IF(verbose_progress) WRITE(*,*) 'checked regression 2'
! 3. ELASTICITY U w/ P
Xjf(:,1)=1
Xjf(:,2)=LOG(data_prod_qtr(1:tmax_qtr2-2))
Yjf(1:tmax_qtr2-2,1)=LOG(data_u_qtr(1: tmax_qtr2-2))
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf, errmsg)
el_u_with_p_lindt=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_u_with_p_lindt'
    END IF
    IF(verbose_progress) WRITE(*,*) 'checked regression 3'

! 3a Unemployment duration per occ w/ P

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_udur_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_supocc_prod_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_supocc_prod_semielasticity_ldt(', occcnt, ')'
    END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 4'

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_lu_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u_supocc_prod_elasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u_supocc_prod_elasticity_ldt(', occcnt, ')'
    END IF
    END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 5'

    DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_u_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u_supocc_prod_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u_supocc_prod_semielasticity_ldt(', occcnt, ')'
    END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 6'

! 3b Separation per occ w/ P

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_sep_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_supocc_prod_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_supocc_prod_semielasticity_ldt(', occcnt, ')'
    END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 7'

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_lsep_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_supocc_prod_elasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_supocc_prod_elasticity_ldt(', occcnt, ')'
    END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 8'

! 4. UNEMPLOYMENT DURATION
Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_occ_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf, errmsg)
udur_occ_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 9'

Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_young_occ_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_occ_young_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_young_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 10'

Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_prime_occ_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_occ_prime_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_prime_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 11'


Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_nocc_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_nocc_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 12'

Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_young_nocc_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_nocc_young_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_young_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 13'

Xjf(:,1)=1
Xjf(:,2)=data_u_qtr(1: tmax_qtr2-2)
Yjf(1:tmax_qtr2-2,1)=data_ucompldur_prime_nocc_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_nocc_prime_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_prime_with_u'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 14'

! 5. DURATION DISTRIBUTION WITH UNEMPLOYMENT
Xjf(:,2)=LOG(data_u_qtr(1: tmax_qtr2-2))
Yjf(1:tmax_qtr2-2,1)=data_l_ult5wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5w_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 15'

Yjf(1:tmax_qtr2-2,1)=data_l_u5lt15wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u15w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u15w_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 16'


Yjf(1:tmax_qtr2-2,1)=data_l_u15lt27wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u27w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u27w_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 17'


Yjf(1:tmax_qtr2-2,1)=data_l_ugt27wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ugt27w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ugt27w_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 18'



!Yjf(1:tmax_qtr2-2,1)=data_l_ult3m_qtr(1:tmax_qtr2-2)
!CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
!u3m_unemp_elasticity=betajf(2)
!IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
!    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
!    WRITE(10, '(14(F10.4))') thetal
!    WRITE(10,*) 'u3m_unemp_elasticity'
!END IF
!IF(verbose_progress) WRITE(*,*) 'checked regression 19'
!
!
!Yjf(1:tmax_qtr2-2,1)=data_l_ult5m_qtr(1:tmax_qtr2-2)
!CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
!u5m_unemp_elasticity=betajf(2)
!IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
!    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
!    WRITE(10, '(14(F10.4))') thetal
!    WRITE(10,*) 'u5m_unemp_elasticity'
!END IF
!IF(verbose_progress) WRITE(*,*) 'checked regression 20'
!
!
!Yjf(1:tmax_qtr2-2,1)=data_l_ult9m_qtr(1:tmax_qtr2-2)
!CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
!u9m_unemp_elasticity=betajf(2)
!IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
!    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
!    WRITE(10, '(14(F10.4))') thetal
!    WRITE(10,*) 'u9m_unemp_elasticity'
!END IF
!IF(verbose_progress) WRITE(*,*) 'checked regression 21'

!!!====================
!!! DUR DISTR ELASTICITY WITH U FOR PAPER
!!!======================

!data_temp_qtr, data_temp_qtr2, data_temp_qtr3
!data_temp_qtr= lin detrended u 
!data_temp_qtr2= duration time series


OPEN(unit=55,file='durdist_elas.csv',status="replace",form="formatted")
WRITE(55, FMT='(2(A8, A1), A2, A1, 6(A9,A1))', ADVANCE='no') 'qtr' ,',','qtr_win',',' , 'id', ',',   'l_ult3m', ',' , 'l_ult5m', ',', 'l_ult9m', ',' , 'l_ult13m', ',' , 'l_ugt13m', ',' , 'u_q',','
WRITE(55, FMT='(4(A9, A1))') 'Xjf', ',' , 'Yjf', ',' , 'data_qtr', ',' , 'data_qtr3', ',' 

tempint=1
DO t=1,tmax_qtr2

    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1))') t ,',',tempint ,',' , 0, ',',   data_l_ult3m_qtr(t), ',' , data_l_ult5m_qtr(t), ',', data_l_ult9m_qtr(t), ',' , data_l_ult13m_qtr(t), ',' , data_l_ugt13m_qtr(t), ',' , data_u_qtr(t),','
    IF(tempint==tmax_mask_swindow_qtr) tempint=1
    tempint=tempint+1

END DO 





!! -------------- DURATION 1-2 MONTHS

tempreal=-HUGE(1.0)
tempint=0
DO t=1, tmax_qtr2
    IF( (data_u_qtr(t)>0.0001 .AND. data_u_qtr(t) .ne. data_u_qtr(t)-1.0)  &
         .AND. (data_l_ult3m_qtr(t)==data_l_ult3m_qtr(t)) .AND. (data_l_ult3m_qtr(t) .ne. data_l_ult3m_qtr(t)-1.0) &
        .AND. data_l_ult3m_qtr(t)>tempreal ) THEN
    data_temp_qtr(t)=LOG(data_u_qtr(t))
    data_temp_qtr3(t)=data_l_ult3m_qtr(t)
        IF(t==1 .AND. tempint==0) THEN 
            tempint=1
        ELSE if (t>1 .AND. tempint==0) THEN
            data_temp_qtr(1:t-1)=data_temp_qtr(t)
            data_temp_qtr3(1:t-1)=data_temp_qtr3(t)
            tempint=1
        END IF 
    ELSE IF (tempint>0) THEN 
        data_temp_qtr(t)=data_temp_qtr(t-1)
        data_temp_qtr3(t)=data_temp_qtr3(t-1)
    END IF 
    END DO 

!! -- STEP 2 linearly detrended log u series (for X)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Xjf(:,2)=data_temp_qtr2(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending data_u_qtr for elasticity distr w u'

!! -- STEP 3 linearly detrended log DUR DISTRIBUTION part
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr3(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr2(1:tmax_qtr2)


!Yjf(1:tmax_qtr2-2,1)=data_l_ult3m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_elasticity'
    END IF

tempint=1
DO t=1,tmax_qtr2-2
    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1), 4(F9.4, A1))') t ,',',tempint ,',' , 2, ',',   -1.0, ',' , -1.0, ',', -1.0, ',' , -1.0, ',' , -1.0, ',' , -1.0, ',',  &
                                                                        Xjf(t,2), ',' , Yjf(t,1), ',' , data_temp_qtr(t), ',', data_temp_qtr3(t), ','
    tempint=tempint+1
    IF(tempint==tmax_mask_swindow_qtr+1) tempint=1
    

END DO 
    
    
IF(verbose_progress) WRITE(*,*) 'checked regression 19'

!! -----------  DURATION 1-4 MONTHS 

tempreal=-HUGE(1.0)
tempint=0
DO t=1, tmax_qtr2
    !! check for: no -infinity, NaN, 
    IF( (data_u_qtr(t)>0.0001 .AND. data_u_qtr(t) .ne. data_u_qtr(t)-1.0)  &
         .AND. (data_l_ult5m_qtr(t)==data_l_ult5m_qtr(t)) .AND. (data_l_ult5m_qtr(t) .ne. data_l_ult5m_qtr(t)-1.0)  &
        .AND. data_l_ult5m_qtr(t)>tempreal ) THEN
    data_temp_qtr(t)=LOG(data_u_qtr(t))
    data_temp_qtr3(t)=data_l_ult5m_qtr(t)
        IF(t==1 .AND. tempint==0) THEN 
            tempint=1
        ELSE if (t>1 .AND. tempint==0) THEN
            data_temp_qtr(1:t-1)=data_temp_qtr(t)
            data_temp_qtr3(1:t-1)=data_temp_qtr3(t)
            tempint=1
        END IF 
    ELSE IF (tempint>0) THEN 
        data_temp_qtr(t)=data_temp_qtr(t-1)
        data_temp_qtr3(t)=data_temp_qtr3(t-1)
    END IF 
END DO 

!! -- STEP 2 linearly detrended log u series (for X)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Xjf(:,2)=data_temp_qtr2(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending data_u_qtr for elasticity distr w u'

!! -- STEP 3 linearly detrended log DUR DISTRIBUTION part
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr3(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2-2,1)=data_temp_qtr2(1:tmax_qtr2-2)

!Yjf(1:tmax_qtr2-2,1)=data_l_ult5m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 20'

tempint=1
DO t=1,tmax_qtr2
    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1), 4(F9.4, A1))') t ,',',tempint ,',' , 4, ',',   -1.0, ',' , -1.0, ',', -1.0, ',' , -1.0, ',' , -1.0, ',' , -1.0, ',', &
                                                                        Xjf(t,2), ',' , Yjf(t,1), ',' , data_temp_qtr(t), ',', data_temp_qtr3(t), ','
    tempint=tempint+1
    IF(tempint==tmax_mask_swindow_qtr+1) tempint=1
    
END DO 


!! ------------ DURATION 5-8 MONTHS
tempreal=-HUGE(1.0)
tempint=0
DO t=1, tmax_qtr2
    IF( (data_u_qtr(t)>0.0001 .AND. data_u_qtr(t) .ne. data_u_qtr(t)-1.0)  &
         .AND. (data_l_ult9m_qtr(t)==data_l_ult9m_qtr(t)) .AND. (data_l_ult9m_qtr(t) .ne. data_l_ult9m_qtr(t)-1.0)  &
         .AND. data_l_ult9m_qtr(t)>tempreal ) THEN
    data_temp_qtr(t)=LOG(data_u_qtr(t))
    data_temp_qtr3(t)=data_l_ult9m_qtr(t)
        IF(t==1 .AND. tempint==0) THEN 
            tempint=1
        ELSE if (t>1 .AND. tempint==0) THEN
            data_temp_qtr(1:t-1)=data_temp_qtr(t)
            data_temp_qtr3(1:t-1)=data_temp_qtr3(t)
            tempint=1
        END IF 
    ELSE IF (tempint>0) THEN 
        data_temp_qtr(t)=data_temp_qtr(t-1)
        data_temp_qtr3(t)=data_temp_qtr3(t-1)
    END IF 
END DO 

!! -- STEP 2 linearly detrended log u series (for X)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Xjf(:,2)=data_temp_qtr2(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending data_u_qtr for elasticity distr w u'

!! -- STEP 3 linearly detrended log DUR DISTRIBUTION part
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr3(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2-2,1)=data_temp_qtr2(1:tmax_qtr2-2)



!Yjf(1:tmax_qtr2-2,1)=data_l_ult9m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 21'

tempint=1
DO t=1,tmax_qtr2
    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1), 4(F9.4, A1))') t ,',',tempint ,',' , 8, ',',   -1.0, ',' , -1.0, ',', -1.0, ',' , -1.0, ',' , -1.0, ',' , -1.0, ',', &
                                                                        Xjf(t,2), ',' , Yjf(t,1), ',' , data_temp_qtr(t), ',', data_temp_qtr3(t), ','
    tempint=tempint+1
    IF(tempint==tmax_mask_swindow_qtr+1) tempint=1
    
    END DO 


!! ------------- DURATION 9-12 MONTHS 

!! -- STEP 1 checking for rubbish outcomes (log(0), NaN etc.) in the regression
!!          in this case, repeat last valid observation
!!          if the first observation of the time series is rubbish, then move on, and when the first good one is hit
tempreal=-HUGE(1.0)
tempint=0
DO t=1, tmax_qtr2
    IF( (data_u_qtr(t)>0.0001 .AND. data_u_qtr(t) .ne. data_u_qtr(t)-1.0)  &
         .AND. (data_l_ult13m_qtr(t)==data_l_ult13m_qtr(t)) .AND. (data_l_ult13m_qtr(t) .ne. data_l_ult13m_qtr(t)-1.0) &
        .AND. data_l_ult13m_qtr(t)>tempreal  ) THEN
    data_temp_qtr(t)=LOG(data_u_qtr(t))
    data_temp_qtr3(t)=data_l_ult13m_qtr(t)
        IF(t==1 .AND. tempint==0) THEN 
            tempint=1
        ELSE if (t>1 .AND. tempint==0) THEN
            WRITE(*,*) 'pre-lin detrending NaN'
            data_temp_qtr(1:t-1)=data_temp_qtr(t)
            data_temp_qtr3(1:t-1)=data_temp_qtr3(t)
            tempint=1
        END IF 
    ELSE IF (tempint>0) THEN 
        data_temp_qtr(t)=data_temp_qtr(t-1)
        data_temp_qtr3(t)=data_temp_qtr3(t-1)
    END IF 
END DO 

!! -- STEP 2 linearly detrended log u series (for X)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Xjf(:,2)=data_temp_qtr2(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending data_u_qtr for elasticity distr w u'

!! -- STEP 3 linearly detrended log DUR DISTRIBUTION part
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr3(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2-2,1)=data_temp_qtr2(1:tmax_qtr2-2)




CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_elasticity'
    END IF

IF(verbose_progress) WRITE(*,*) 'checked regression 22'

tempint=1
DO t=1,tmax_qtr2
    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1), 4(F9.4, A1))') t ,',',tempint ,',' , 12, ',',   -1.0, ',' , -1.0, ',', -1.0, ',' , -1.0, ',' , -1.0, ',' , -1.0, ',', &
                                                                        Xjf(t,2), ',' , Yjf(t,1), ',' , data_temp_qtr(t), ',', data_temp_qtr3(t), ','
    tempint=tempint+1
    IF(tempint==tmax_mask_swindow_qtr+1) tempint=1
    
    END DO 


!! ------------- DURATION 13-18 MONTHS 

!! -- STEP 1 checking for rubbish outcomes (log(0), NaN etc.) in the regression
!!          in this case, repeat last valid observation
!!          if the first observation of the time series is rubbish, then move on, and when the first good one is hit
tempreal=-HUGE(1.0)
tempint=0
DO t=1, tmax_qtr2
    IF( (data_u_qtr(t)>0.0001 .AND. data_u_qtr(t) .ne. data_u_qtr(t)-1.0)  &
         .AND. (data_l_ugt13m_qtr(t) == data_l_ugt13m_qtr(t)) .AND. (data_l_ugt13m_qtr(t) .ne. data_l_ugt13m_qtr(t)-1.0) &
        .AND. data_l_ugt13m_qtr(t)>tempreal ) THEN
    data_temp_qtr(t)=LOG(data_u_qtr(t))
    data_temp_qtr3(t)=data_l_ugt13m_qtr(t)
        IF(t==1 .AND. tempint==0) THEN 
            tempint=1
        ELSE if (t>1 .AND. tempint==0) THEN
            data_temp_qtr(1:t-1)=data_temp_qtr(t)
            data_temp_qtr3(1:t-1)=data_temp_qtr3(t)
            tempint=1
        END IF 
    ELSE IF (tempint>0) THEN 
        data_temp_qtr(t)=data_temp_qtr(t-1)
        data_temp_qtr3(t)=data_temp_qtr3(t-1)
    END IF 
END DO 

!! -- STEP 2 linearly detrended log u series (for X)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Xjf(:,2)=data_temp_qtr2(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending data_u_qtr for elasticity distr w u'

!! -- STEP 3 linearly detrended log DUR DISTRIBUTION part
CALL LINDETREND_WINDOWS(tmax_qtr2,data_temp_qtr3(1:tmax_qtr2), data_temp_qtr2(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2-2,1)=data_temp_qtr2(1:tmax_qtr2-2)



!Yjf(1:tmax_qtr2-2,1)=data_l_ugt13m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_elasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 23'

tempint=1
DO t=1,tmax_qtr2
    WRITE(55, FMT='(2(I8, A1), I2, A1, 6(F9.4,A1), 4(F9.4, A1))') t ,',',tempint ,',' , 18, ',',   -1.0, ',' , -1.0, ',', -1.0, ',' , -1.0, ',' , -1.0, ',' , -1.0, ',', &
                                                                        Xjf(t,2), ',' , Yjf(t,1), ',' , data_temp_qtr(t), ',', data_temp_qtr3(t), ','
    tempint=tempint+1
    IF(tempint==tmax_mask_swindow_qtr+1) tempint=1
    
END DO 
CLOSE(55)

!! _    _   _   _   _ _    _   _   _   _ _    _   _   _   _ _    _   _   _   _ _    _   _   _   _ _    _   _   _   _ _    _   _   _   _ 

!! YOUNG


    Yjf(1:tmax_qtr2-2,1)=data_l_ult3m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_yng_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 24'


Yjf(1:tmax_qtr2-2,1)=data_l_ult5m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_yng_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 25'


Yjf(1:tmax_qtr2-2,1)=data_l_ult9m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_yng_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 26'


Yjf(1:tmax_qtr2-2,1)=data_l_ult13m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_yng_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 27'


Yjf(1:tmax_qtr2-2,1)=data_l_ugt13m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_yng_elasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 28'

!! PRIME
    Yjf(1:tmax_qtr2-2,1)=data_l_ult3m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_prm_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 29'


Yjf(1:tmax_qtr2-2,1)=data_l_ult5m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_prm_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 30'


Yjf(1:tmax_qtr2-2,1)=data_l_ult9m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_prm_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 31'


Yjf(1:tmax_qtr2-2,1)=data_l_ult13m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_prm_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 32'


Yjf(1:tmax_qtr2-2,1)=data_l_ugt13m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_prm_elasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 33'




Yjf(1:tmax_qtr2-2,1)=data_ult5wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5w_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 34'


Yjf(1:tmax_qtr2-2,1)=data_u5lt15wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u15w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u15w_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 35'


Yjf(1:tmax_qtr2-2,1)=data_u15lt27wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u27w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u27w_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 36'


Yjf(1:tmax_qtr2-2,1)=data_ugt27wk_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ugt27w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ugt27w_unemp_semielasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 37'


!! ALL WORKERS

Yjf(1:tmax_qtr2-2,1)=data_ult3m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 38'


Yjf(1:tmax_qtr2-2,1)=data_ult5m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 39'


Yjf(1:tmax_qtr2-2,1)=data_ult9m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 40'


Yjf(1:tmax_qtr2-2,1)=data_ult13m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 41'


Yjf(1:tmax_qtr2-2,1)=data_ugt13m_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_semielasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 42'

!! YOUNG WORKERS


Yjf(1:tmax_qtr2-2,1)=data_ult3m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_yng_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 43'


Yjf(1:tmax_qtr2-2,1)=data_ult5m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_yng_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 44'


Yjf(1:tmax_qtr2-2,1)=data_ult9m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_yng_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 45'


Yjf(1:tmax_qtr2-2,1)=data_ult13m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_yng_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 46'


Yjf(1:tmax_qtr2-2,1)=data_ugt13m_yng_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_yng_semielasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 47'


!! PRIME-AGED WORKERS


Yjf(1:tmax_qtr2-2,1)=data_ult3m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u3m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u3m_unemp_prm_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 48'


Yjf(1:tmax_qtr2-2,1)=data_ult5m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u5m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u5m_unemp_prm_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 49'


Yjf(1:tmax_qtr2-2,1)=data_ult9m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u9m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u9m_unemp_prm_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 50'


Yjf(1:tmax_qtr2-2,1)=data_ult13m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u13m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u13m_unemp_prm_semielasticity'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 51'

Yjf(1:tmax_qtr2-2,1)=data_ugt13m_prm_qtr(1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
ug13m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'ug13m_unemp_prm_semielasticity'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 52'
IF(verbose_progress) WRITE(*,*) 'on to supocc regressions'
!!===============================================================
    !!   LINEARLY DETRENDED UNEMPLOYMENT
    !!===============================================================

    !data_temp_qtr3 is linearly detrended LOG unemployment

    data_temp_qtr3=0.0_8
    CALL LINDETREND_WINDOWS(tmax_qtr2,LOG(data_u_qtr(1:tmax_qtr2)), data_temp_qtr3(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)

    !
    !! set constant + time trend on the indepndent variables
    !Xjf(:,:)=0
    !Xjf(1:tmax_mask_swindow_qtr,1)=1
    !DO tcnt=1, tmax_mask_swindow_qtr
    !        Xjf(tcnt,2)=REAL(tcnt)            ! linear time trend
    !END DO
    !
    !! set bounds of superwindow
    !tempcounter1=1
    !tempcounter2=tmax_mask_swindow_qtr
    !
    !! determine tempint=no. superwindows
    !counter1=tmax_qtr2
    !counter2=tmax_mask_swindow_qtr
    !tempint=  tmax_qtr2/tmax_mask_swindow_qtr
    !IF( (tmax_qtr2/tmax_mask_swindow_qtr)*tmax_mask_swindow_qtr .ne. tmax_qtr2) THEN
    !     WRITE(*,*) 'sum of all tmax_mask_swindow_qtr windows does not add up to tmax_qtr2'
    !END IF
    !
    !DO t=1, tempint ! tempint=no. superwindows here
    !    !! REGRESSIONS PER SUPERWINDOW
    !    Yjf(1:tmax_mask_swindow_qtr,1)=data_u_qtr(tempcounter1: tempcounter2)
    !    CALL multivar_regression(Yjf(1:tmax_mask_swindow_qtr,:), Xjf(1:tmax_mask_swindow_qtr,:), tmax_mask_swindow_qtr, 2, betajf,errmsg)
    !
    !    !! RESIDUALS OF UNEMPLOYMENT AFTER LINEAR DETRENDING
    !    DO tcnt=tempcounter1, tempcounter2
    !        data_temp_qtr3(tcnt)=data_u_qtr(tcnt)-betajf(2)*REAL(tcnt-tempcounter+1)
    !    END DO
    !
    !    tempcounter1=tempcounter1+tmax_mask_swindow_qtr
    !    tempcounter2=tempcounter2+tmax_mask_swindow_qtr
    !END DO


!!===========================================
!!  SEPARATIONS
!!===========================================

   !! REAL(8), DIMENSION(occpts) :: sep_supocc_unemp_elasticity_ldt, sep_supocc_unemp_semielasticity_ldt, sep_supocc_prod_elasticity_ldt, sep_supocc_prod_semielasticity_ldt

Xjf(:,1)=1.0
Xjf(:,2)=0.0
Xjf(1:tmax_qtr2,2)=data_temp_qtr3(1:tmax_qtr2)
data_temp_qtr=0.0

!! BASElINE
!Yjf(1:tmax_qtr2-2,1)=data_supocc_sep_qtr(occcnt, 1:tmax_qtr2-2)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_sep_qtr(1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)
IF(verbose_progress) WRITE(*,*) 'checked lin detrending 53'

CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_unemp_semielasticity_ldt=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_semielasticity_ldt'
END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 53'


CALL LINDETREND_WINDOWS(tmax_qtr2,LOG(data_sep_qtr(1:tmax_qtr2)), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_unemp_elasticity_ldt=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_elasticity_ldt'
    END IF
IF(verbose_progress) WRITE(*,*) 'checked regression 54'
!!================
!! PER SUPEROCC
!!================

DO occcnt=1, occpts
!Yjf(1:tmax_qtr2-2,1)=data_supocc_sep_qtr(occcnt, 1:tmax_qtr2-2)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_supocc_sep_qtr(occcnt, 1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_supocc_unemp_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_supocc_unemp_semielasticity_ldt(', occcnt, ')'
END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 55'
DO occcnt=1, occpts
!Yjf(1:tmax_qtr2-2,1)=data_supocc_lsep_qtr(occcnt, 1:tmax_qtr2-2)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_supocc_lsep_qtr(occcnt, 1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
sep_supocc_unemp_elasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_supocc_unemp_elasticity_ldt(', occcnt, ')'
    END IF
    END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 56'
DO occcnt=1, occpts
!Yjf(1:tmax_qtr2-2,1)=data_supocc_udur_qtr(occcnt, 1:tmax_qtr2-2)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_supocc_udur_qtr(occcnt, 1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_supocc_unemp_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_supocc_unemp_semielasticity_ldt(', occcnt, ')'
END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 57'
DO occcnt=1, occpts
!Yjf(1:tmax_qtr2-2,1)=data_supocc_udur_qtr(occcnt, 1:tmax_qtr2-2)
CALL LINDETREND_WINDOWS(tmax_qtr2,data_supocc_ludur_qtr(occcnt, 1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
Yjf(1:tmax_qtr2,1)=data_temp_qtr(1:tmax_qtr2)

CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
udur_supocc_unemp_elasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_supocc_unemp_elasticity_ldt(', occcnt, ')'
    END IF
    END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 58'
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_u_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u_supocc_unemp_semielasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u_supocc_unemp_semielasticity_ldt(', occcnt, ')'
    END IF
    END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 59'
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-2,1)=data_supocc_lu_qtr(occcnt, 1:tmax_qtr2-2)
CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
u_supocc_unemp_elasticity_ldt(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'lu_supocc_unemp_elasticity_ldt(', occcnt, ')'
    END IF
END DO
IF(verbose_progress) WRITE(*,*) 'checked regression 60'
IF(verbose_progress) WRITE(*,*) 'finished with (before hp filtering) regressions)'

!!==========================================
!! BEVERIDGE CurVE LINEARLY DETRENDED!!!!!
!!==========================================

tempreal=0.0_8      ! covariance
tempreal2=0.0_8     ! mean u
tempreal3=0.0_8     ! mean v
tempreal4=0.0_8     ! variance u
tempreal5=0.0_8     ! variance v


tempint=0

DO t=1, tmax_qtr2-2
     tempreal=tempreal+(LOG(data_u_qtr(t))*LOG(data_v_qtr(t)))
     tempreal2=tempreal2+LOG(data_u_qtr(t))
     tempreal3=tempreal3+LOG(data_v_qtr(t))
     tempreal4=tempreal4+(LOG(data_u_qtr(t))*LOG(data_u_qtr(t)))
     tempreal5=tempreal5+(LOG(data_v_qtr(t))*LOG(data_v_qtr(t)))
     tempint=tempint+1
END DO

corr_uv_lindt=(tempreal/REAL(tempint))-(tempreal2/REAL(tempint))*(tempreal3/REAL(tempint))
corr_uv_lindt=corr_uv_lindt/(sqrt((tempreal4/REAL(tempint)))*sqrt((tempreal5/REAL(tempint))))



!DEALLOCATE(Xjf, Yjf)
!$OMP END CRITICAL

!===============================================================
!  REPORTING
!===============================================================



! WRITE THE SAME TO SCREEN


IF(verbose_cutoffs==1) THEN
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'pid', ',', 'pvec', ','
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'zRn1', ',' , 'zR1', ','
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'zQn1', ',' ,'zQ1', ','
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'zRn2', ',' , 'zR2', ','
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'zQn2', ',' ,'zQ2', ','
 WRITE(10, FMT='(A6, A1, A6, A1)', ADVANCE='NO') 'zRn3', ',' , 'zR3', ','
 WRITE(10, FMT='(A6, A1, A6)') 'zQn3', ',' ,'zQ3'

 DO pcnt=1, ppts

        ! write productivity ind, productivity
   WRITE(10, FMT='(I6, A1)', ADVANCE='NO') pcnt, ','
   WRITE(10, FMT='(F6.4, A1)', ADVANCE='NO') pvector(pcnt), ','


     ! write reallocation cutoff ind, reallocation productivity. NOTE THAT WE TAKE xcnt=1 here, but really we should be talking about
     ! average x-productivities
    DO xcnt=1, xpts

    IF(poliR(pcnt,xcnt, 1)==1) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') 0, ' ' , 0.0_8, ' '
    ELSE
        DO zcnt=1, zpts-1
            IF(poliR(pcnt, xcnt, zcnt)==0 .AND. poliR(pcnt, xcnt, zcnt+1)==1) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') zcnt, ' ' , zvector(zcnt), ' '
            END IF
        END DO
        IF (poliR(pcnt, xcnt, zpts)==0) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') zpts, ' ' , zvector(zpts), ' '
        END IF
    END IF
 ! write quit cutoff ind, quit cutoff productivity. AGAIN WE REPORT ONLY FOR XCNT==1, but really, we should be reporting it for all xcnts
 ! if there is heterogeneity here

    IF(poliDW(pcnt,xcnt,1)==1) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') 0, ' ' , 0.0_8, ' '
    ELSE
        DO zcnt=1, zpts-1
            IF(poliDW(pcnt, xcnt, zcnt)==0 .AND. poliDW(pcnt, xcnt, zcnt+1)==1) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') zcnt, ' ' , zvector(zcnt), ' '
            END IF
        END DO
        IF (poliDW(pcnt, xcnt, zpts)==0) THEN
                   WRITE(10, FMT='(I6, A1, F6.4, A1)', ADVANCE='NO') zpts, ' ' , zvector(zpts), ' '
        END IF
    END IF
  END DO        ! xcnt loop
  WRITE(10,*) ' '
 END DO         ! pcnt loop
END IF

    !$OMP CRITICAL
IF(verbose_results_l1==1) THEN
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave prod      ~~~~ ', prod_ave
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave wage      ~~~~ ', wage_ave
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave theta     ~~~~ ', theta_ave
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave cost/hire ~~~~ ', tot_costofhires


    WRITE(10,FMT='(A27, A9, A5, A9, A5, A9)')       '~~~~STATISTIC     ~~~~ ', 'MODEL', '.....', 'DATA'
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave u         ~~~~ ', unemp_ave, '.....', u_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave u_young   ~~~~ ', u_young_ave, '.....', u_y_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave u_prime   ~~~~ ', u_prime_ave, '.....', u_p_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~u prop window ~~~~ ', uproportion_window, '.....', uproportion_window_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~uocc prop window~~~ ', uoccproportion_window, '.....', uoccproportion_window_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~unocc prop wndw~~~~ ', unoccproportion_window, '.....', unoccproportion_window_data




    WRITE(10,FMT='(A27)') ' '
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave c_occ (2m) ~~~ ', tot_durationmatrix_cocc(2), '.....', tot_durationmatrix_cocc_data(2)
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave c_occ y(2m)~~~ ', tot_durationmatrix_cocc_young(2), '.....', tot_durationmatrix_cocc_young_data(2)
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave c_occ p(2m)~~~ ', tot_durationmatrix_cocc_prime(2), '.....', tot_durationmatrix_cocc_prime_data(2)
    WRITE(10,FMT='(A27)') ' '
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave sep        ~~~ ', sep_ave, '.....', sep_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave sep young ~~~~ ', sepyoung_ave, '.....', sepyoung_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave sep prime ~~~~ ', sepprime_ave, '.....', sepprime_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~av.sep aftercm 1y~ ', sepocc_ave, '.....', sepocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~av.mthsep aftcm y 1y~ ', sepocc_y_ave, '.....', sepocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~av.mthsep aftcm p 1y~ ', sepocc_p_ave, '.....', sepocc_p_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~av.mthsep aftercs 1y~ ', sepnocc_ave, '.....', sepnocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~av.mthsep aftcs y 1y~ ', sepnocc_y_ave, '.....', sepnocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~av.mthsep aftcs p 1y~ ', sepnocc_p_ave, '.....', sepnocc_p_ave_data



    WRITE(10,FMT='(A27)') ' '
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave comp occ   ~~~ ', cocc_ave, '.....', -1.0_8
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave comp occ y ~~~ ', cocc_young_ave, '.....', -1.0_8
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave comp occ p ~~~ ', cocc_prime_ave, '.....', -1.0_8

    WRITE(10,*) ' '
    WRITE(10,*) ' JOB FINDING '
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jf (ts qtr ave)', jf_ave, '.....', jf_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '****ave jf (indiv.)    ', jf_ave2, '.....', jf_ave2_data
    WRITE(10,*) ' JOB FINDING '
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jf young   ~~~ ', jf_young_ave, '.....', jf_young_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jf prime   ~~~ ', jf_prime_ave, '.....', jf_prime_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jfocc      ~~~ ', jfocc_ave, '.....', jfocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jfocc young~~~ ', jfocc_young_ave, '.....', jfocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~ave jfocc prime~~~ ', jfocc_prime_ave, '.....', jfocc_p_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~av jfnocc      ~~~ ', jfnocc_ave, '.....', jfnocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~av jfnocc young~~~ ', jfnocc_young_ave, '.....', jfnocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~av jfnocc prime~~~ ', jfnocc_prime_ave, '.....', jfnocc_p_ave_data

    WRITE(10,*) ' '
    WRITE(10,*) ' REPEAT MOBILITY -- COMPOSITION  '
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam ~~~ ', noccafterocc_ave, '~~~data~~~', noccafterocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas ~~~ ', noccafternocc_ave, '~~~data~~~', noccafternocc_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam y~~~ ', noccafterocc_y_ave, '~~~data~~~', noccafterocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas y~~~ ', noccafternocc_y_ave, '~~~data~~~', noccafternocc_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam p~~~ ', noccafterocc_p_ave, '~~~data~~~', noccafterocc_p_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas p~~~ ', noccafternocc_p_ave, '~~~data~~~', noccafternocc_p_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~c sa_all  ~~~ ', noccafterall_ave, '~~~data~~~', noccafterall_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~c sa_all y~~~ ', noccafterall_y_ave, '~~~data~~~', noccafterall_y_ave_data
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~c sa_all p~~~ ', noccafterall_p_ave, '~~~data~~~', noccafterall_p_ave_data

    WRITE(10, *) '~~~~~ with different minimum durations in the second uspell ~~~~~'
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 1~~~ ', tot_noccafterocc_vector(1), '~~~data~~~', tot_noccafterocc_vector_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 1~~~ ', tot_noccafternocc_vector(1), '~~~data~~~',tot_noccafternocc_vector_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 2~~~ ', tot_noccafterocc_vector(2), '~~~data~~~', tot_noccafterocc_vector_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 2~~~ ', tot_noccafternocc_vector(2), '~~~data~~~',tot_noccafternocc_vector_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 3~~~ ', tot_noccafterocc_vector(3), '~~~data~~~', tot_noccafterocc_vector_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 3~~~ ', tot_noccafternocc_vector(3), '~~~data~~~', tot_noccafternocc_vector_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 4~~~ ', tot_noccafterocc_vector(4), '~~~data~~~', tot_noccafterocc_vector_data(4)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 4~~~ ', tot_noccafternocc_vector(4), '~~~data~~~', tot_noccafternocc_vector_data(4)
    WRITE(10, *) '~~~~~ YOUNG: with different minimum durations  ~~~~~'
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 1~~~ ', tot_noccafterocc_vector_young(1), '~~~data~~~', tot_noccafterocc_vector_young_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 1~~~ ', tot_noccafternocc_vector_young(1), '~~~data~~~',tot_noccafternocc_vector_young_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 2~~~ ', tot_noccafterocc_vector_young(2), '~~~data~~~', tot_noccafterocc_vector_young_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 2~~~ ', tot_noccafternocc_vector_young(2), '~~~data~~~',tot_noccafternocc_vector_young_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 3~~~ ', tot_noccafterocc_vector_young(3), '~~~data~~~', tot_noccafterocc_vector_young_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 3~~~ ', tot_noccafternocc_vector_young(3), '~~~data~~~', tot_noccafternocc_vector_young_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 4~~~ ', tot_noccafterocc_vector_young(4), '~~~data~~~', tot_noccafterocc_vector_young_data(4)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 4~~~ ', tot_noccafternocc_vector_young(4), '~~~data~~~', tot_noccafternocc_vector_young_data(4)
    WRITE(10, *) '~~~~~ PRIME: with different minimum durations  ~~~~~'
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 1~~~ ', tot_noccafterocc_vector_prime(1), '~~~data~~~', tot_noccafterocc_vector_prime_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 1~~~ ', tot_noccafternocc_vector_prime(1), '~~~data~~~',tot_noccafternocc_vector_prime_data(1)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 2~~~ ', tot_noccafterocc_vector_prime(2), '~~~data~~~', tot_noccafterocc_vector_prime_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 2~~~ ', tot_noccafternocc_vector_prime(2), '~~~data~~~',tot_noccafternocc_vector_prime_data(2)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 3~~~ ', tot_noccafterocc_vector_prime(3), '~~~data~~~', tot_noccafterocc_vector_prime_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 3~~~ ', tot_noccafternocc_vector_prime(3), '~~~data~~~', tot_noccafternocc_vector_prime_data(3)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sam 4~~~ ', tot_noccafterocc_vector_prime(4), '~~~data~~~', tot_noccafterocc_vector_prime_data(4)
    WRITE(10,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp sas 4~~~ ', tot_noccafternocc_vector_prime(4), '~~~data~~~', tot_noccafternocc_vector_prime_data(4)






    WRITE(10,*) ' '
    WRITE(10,*) '~~~~~RETURNS TENURE~~~~~ '
    WRITE(10,FMT='(A20, F8.5, A2, F8.5)' ) 'returns 5y occ ten~~~~', returnstenure5y, '--', rtnoccten5yr_data
    WRITE(10,FMT='(A20, F8.5, A2, F8.5)' ) 'returns 5y occ ten~~~~', returnstenure10y, '--', rtnoccten10yr_data

    !   WRITE(*,*) ' '
!       WRITE(*,*) '~~~~~OCC TENURE DISTRIBUTION~~~~~ '
!       WRITE(*,*) 'occ_ten_dist(1)', occ_ten_dist(1)
!       WRITE(*,*) 'occ_ten_dist(2)', occ_ten_dist(2)
!       WRITE(*,*) 'occ_ten_dist(3)', occ_ten_dist(3)
!       WRITE(*,*) 'occ_ten_dist(4)', occ_ten_dist(4)
!       WRITE(*,*) 'occ_ten_dist(5)', occ_ten_dist(5)
!       WRITE(*,*) 'occ_ten_dist(6)', occ_ten_dist(6)
!       WRITE(*,*) 'occ_ten_dist(7)', occ_ten_dist(7)
!       WRITE(*,*) 'occ_ten_dist(8)', occ_ten_dist(8)
!
!
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 18/6months ~~~~', 1.0 - occ_ten_dist(2)/occ_ten_dist(1), '--', 0.25_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 30/18months~~~~', 1.0 - occ_ten_dist(3)/occ_ten_dist(2), '--', 0.20_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 42/30months~~~~', 1.0 - occ_ten_dist(4)/occ_ten_dist(3), '--', 0.163_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 54/42months~~~~', 1.0 - occ_ten_dist(5)/occ_ten_dist(4), '--', 0.146_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 66/54months~~~~', 1.0 - occ_ten_dist(6)/occ_ten_dist(5), '--', 0.117_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 78/66months~~~~', 1.0 - occ_ten_dist(7)/occ_ten_dist(6), '--', 0.103_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 90/78months~~~~', 1.0 - occ_ten_dist(8)/occ_ten_dist(7), '--', 0.093_8
!       WRITE(*,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 21/20 years~~~~', 1.0 - occ_ten_dist(10)/occ_ten_dist(9), '--', 0.05_8
!
!       WRITE(*,*) 'TARGETS IN TERMS OF TENURE HAZARDS'
!       WRITE(*,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 30/18 divided by surv 18/6~~~~', (occ_ten_dist(3)/occ_ten_dist(2))/ (occ_ten_dist(2)/occ_ten_dist(1)), '--', 0.80/0.75_8
!       WRITE(*,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 42/30 divided by surv 30/18~~~~',(occ_ten_dist(4)/occ_ten_dist(3))/(occ_ten_dist(3)/occ_ten_dist(2)), '--', 0.837 /0.80_8
!       WRITE(*,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 54/42 divided by surv 42/30~~~~', (occ_ten_dist(5)/occ_ten_dist(4)) /(occ_ten_dist(4)/occ_ten_dist(3)), '--', 0.856/0.837_8
!       WRITE(*,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 66/54 divided by surv 54/42~~~~', (occ_ten_dist(6)/occ_ten_dist(5))/(occ_ten_dist(5)/occ_ten_dist(4)), '--', 0.883/0.856_8
!
!
       WRITE(10,*) ' '
       WRITE(10,*) '~~~~ AVERAGE UNEMPLOYMENT DURATION DISTRIBUTION FROM BLS resp. SIPP '
       WRITE(10,FMT='(2(A20, F6.4, A2, F6.4))' ) 'prop  unemp < 5wks', ult5wk_ave, '--', ult5wk_ave_data, 'sipp < 3m', uprop_3m_ave, '--', uprop_3m_ave_data
       WRITE(10,FMT='(2(A20, F6.4, A2, F6.4))' ) 'prop u gt5 lt15 wk', u5lt15wk_ave, '--', u5lt15wk_ave_data,'sipp <5m', uprop_5m_ave, '--', uprop_5m_ave_data
       WRITE(10,FMT='(2(A20, F6.4, A2, F6.4))' ) 'prop u gt15 lt27 w', u15lt27wk_ave, '--', u15lt27wk_ave_data, 'sipp <9m', uprop_9m_ave, '--', uprop_9m_ave_data
       WRITE(10,FMT='(2(A20, F6.4, A2, F6.4))' ) 'prop u gt27 weeks ', ugt27wk_ave, '--', ugt27wk_ave_data,'sipp <13m ', uprop_13m_ave, '--', uprop_13m_ave_data
END IF


IF(verbose_results_l2==1) THEN
       WRITE(10,*) ' '
       WRITE(10,*) '~~~~ AVERAGE DURATION DISTRIBUTION ***VARIANCE**** (UNFILTERED) BLS '
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop  unemp < 5wks', sqrt(var_ult5wk_ave), '--', var_ult5wk_ave_data, 'log', sqrt(var_l_ult5wk_ave), '--', var_l_ult5wk_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u gt5 lt15 wk', sqrt(var_u5lt15wk_ave), '--', var_u5lt15wk_ave_data,'log', sqrt(var_l_u5lt15wk_ave), '--', var_l_u5lt15wk_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u gt15 lt27 w', sqrt(var_u15lt27wk_ave), '--', var_u15lt27wk_ave_data, 'log', sqrt(var_l_u15lt27wk_ave), '--', var_l_u15lt27wk_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u gt27 weeks ', sqrt(var_ugt27wk_ave), '--', var_ugt27wk_ave_data,'log', sqrt(var_l_ugt27wk_ave), '--', var_l_ugt27wk_ave_data
       WRITE(10,*) '~~~~ AVERAGE DURATION DISTRIBUTION ***VARIANCE**** (UNFILTERED) SIPP '
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop  unemp < 3m', sqrt(var_uprop_3m_ave), '--', var_uprop_3m_ave_data, 'log', sqrt(var_l_uprop_3m_ave), '--', var_l_uprop_3m_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u <5m', sqrt(var_uprop_5m_ave), '--', var_uprop_5m_ave_data,'log', sqrt(var_l_uprop_5m_ave), '--', var_l_uprop_5m_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u 5-9m', sqrt(var_uprop_9m_ave), '--', var_uprop_9m_ave_data, 'log', sqrt(var_l_uprop_9m_ave), '--', var_l_uprop_9m_ave_data
       WRITE(10,FMT='(2(A20, F7.4, A2, F7.4))' ) 'prop u 9-13m', sqrt(var_uprop_13m_ave), '--', var_uprop_13m_ave_data,'log', sqrt(var_l_uprop_13m_ave), '--', var_l_uprop_13m_ave_data





WRITE(10,*) '  '
WRITE(10,*) '=============> UNFILTERED ELASTICITY WITH UNEMPLOYMENT (M*D)<======'
WRITE(10,*) '======> prop u<5wk  :', u5w_unemp_elasticity, '*', u5w_unemp_elasticity_data
WRITE(10,*) '======> prop u5-1wk :', u15w_unemp_elasticity, '*', u15w_unemp_elasticity_data
WRITE(10,*) '======> prop u15-27w:', u27w_unemp_elasticity, '*', u27w_unemp_elasticity_data
WRITE(10,*) '======> prop u>27wk :', ugt27w_unemp_elasticity, '*', ugt27w_unemp_elasticity_data
WRITE(10,*) ' '
WRITE(10,*) '======> prop u<3m  :', u3m_unemp_elasticity, '*', u3m_unemp_elasticity_data
WRITE(10,*) '======> prop u<5m  :', u5m_unemp_elasticity, '*', u5m_unemp_elasticity_data
WRITE(10,*) '======> prop u5-9m :', u9m_unemp_elasticity, '*', u9m_unemp_elasticity_data
WRITE(10,*) '======> prop u9-13m:', u13m_unemp_elasticity, '*', u13m_unemp_elasticity_data
WRITE(10,*) '======> prop >13m  :', ug13m_unemp_elasticity, '*', ug13m_unemp_elasticity_data

WRITE(10,*) '  '
WRITE(10,*) '=============> UNFILTERED SEMI-elasticity WITH UNEMPLOYMENT (M*D) <======'
WRITE(10,*) '======> prop u<5wk  :', u5w_unemp_semielasticity, '*', u5w_unemp_semielasticity_data
WRITE(10,*) '======> prop u5-1wk :', u15w_unemp_semielasticity, '*', u15w_unemp_semielasticity_data
WRITE(10,*) '======> prop u15-27w:', u27w_unemp_semielasticity, '*', u27w_unemp_semielasticity_data
WRITE(10,*) '======> prop u>27wk :', ugt27w_unemp_semielasticity, '*', ugt27w_unemp_semielasticity_data
WRITE(10,*) ' '
WRITE(10,*) '======> prop u<3m  :', u3m_unemp_semielasticity, '*', u3m_unemp_semielasticity_data
WRITE(10,*) '======> prop u<5m  :', u5m_unemp_semielasticity, '*', u5m_unemp_semielasticity_data
WRITE(10,*) '======> prop u5-9m :', u9m_unemp_semielasticity, '*', u9m_unemp_semielasticity_data
WRITE(10,*) '======> prop u9-13m:', u13m_unemp_semielasticity, '*', u13m_unemp_semielasticity_data
WRITE(10,*) '======> prop >13m  :', ug13m_unemp_semielasticity, '*', ug13m_unemp_semielasticity_data

!
!       WRITE(*,*) '~~~~ AVERAGE UNEMPLOYMENT DURATION DISTRIBUTION FROM BLS: from simulation totals '
!       WRITE(*,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop  unemp < 5wks', tot_ult5wk, '--', 0.38_8, 'matrix < 5wks', ult5wk_2, '--', 0.38_8
!       WRITE(*,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt5 lt15 wk', tot_u5lt15wk, '--', 0.3_8,'matr u gt5 lt15 wk', u5lt15wk_2, '--', 0.3_8
!       WRITE(*,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt15 lt27 w', tot_u15lt27wk, '--', 0.14_8, 'matr u gt15 lt27 w', u15lt27wk_2, '--', 0.14_8
!       WRITE(*,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt27 weeks ', tot_ugt27wk, '--', 0.18_8,'matr u gt27 weeks ', ugt27wk_2, '--', 0.18_8
!
WRITE(10,*) ' '
WRITE(10,*) ' '
WRITE(10,*) ' '
WRITE(10,*) ' '

    END IF

IF(verbose_results_l1==1) THEN



    WRITE(10,*) '~~~~INCOMPLETE DURATION DISTRIBUTION~~~~~~~~~~~~~~'
    WRITE(10,*) '~~~~~~~~ DURATION OF UNEMPLOYMENT~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'durdistr', 'durdisty', 'durdistp', 'data', 'data y', 'data p'
    DO tcnt=0, 18
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_durationmatrix(tcnt), ' y:', tot_durationmatrix_young(tcnt),' p:', tot_durationmatrix_prime(tcnt), &

            '|a:', tot_durationmatrix_data(tcnt),' y:', tot_durationmatrix_young_data(tcnt),' p:', tot_durationmatrix_prime_data(tcnt)

    END DO
END IF
IF(verbose_results_l0==1) THEN

    WRITE(10,*) '~~~~~~~~ PROPORTION OF OCC CHANGERS IN U. STOCK~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_durationmatrix_cocc(tcnt), ' y:', tot_durationmatrix_cocc_young(tcnt),' p:', tot_durationmatrix_cocc_prime(tcnt), &
                                    '|a:', tot_durationmatrix_cocc_data(tcnt),' y:', tot_durationmatrix_cocc_young_data(tcnt),' p:', tot_durationmatrix_cocc_prime_data(tcnt)
    END DO

    WRITE(10,*) '********CORRECTED*** PROPORTION OF OCC CHANGERS IN U. STOCK~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_durationmatrix_cr_cocc(tcnt), ' y:', tot_durationmatrix_cr_cocc_young(tcnt),' p:', tot_durationmatrix_cr_cocc_prime(tcnt), &
                                    '|a:', tot_durationmatrix_cr_cocc_data(tcnt),' y:', tot_durationmatrix_cr_cocc_young_data(tcnt),' p:', tot_durationmatrix_cr_cocc_prime_data(tcnt)
    END DO


    WRITE(10,*) '~~~~~~~~ INCOMPL. DURATION OF OCC CHANGERS ~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_udurationmatrix_m(tcnt), ' y:', tot_udurationmatrix_m_young(tcnt),' p:', tot_udurationmatrix_m_prime(tcnt), &
                                    '|a:', tot_udurationmatrix_m_data(tcnt),' y:', tot_udurationmatrix_m_young_data(tcnt),' p:', tot_udurationmatrix_m_prime_data(tcnt)
    END DO

    WRITE(10,*) '~~~~~~~~ INCOMPL. DURATION OF OCC STAYERS ~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_udurationmatrix_s(tcnt), ' y:', tot_udurationmatrix_s_young(tcnt),' p:', tot_udurationmatrix_s_prime(tcnt), &
                                    '|a:', tot_udurationmatrix_s_data(tcnt),' y:', tot_udurationmatrix_s_young_data(tcnt),' p:', tot_udurationmatrix_s_prime_data(tcnt)
    END DO
END IF
!! HAZARDS
IF(verbose_results_l1==1) THEN
    WRITE(10,*) '~~~~INCOMPLETE DURATION HAZARDS~~~~~~~~~~~~~~'
    WRITE(10,*) '~~~~~~~~ DURATION OF UNEMPLOYMENT~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'durdistr', 'durdisty', 'durdistp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_haz_durationmatrix(tcnt), ' y:', tot_haz_durationmatrix_young(tcnt),' p:', tot_haz_durationmatrix_prime(tcnt), &
                                    '|a:', tot_haz_durationmatrix_data(tcnt),' y:', tot_haz_durationmatrix_young_data(tcnt),' p:', tot_haz_durationmatrix_prime_data(tcnt)

    END DO


    WRITE(10,*) '~~~~~~~~ HAZARD INCOMPL. DURATION OF OCC CHANGERS ~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_haz_udurationmatrix_m(tcnt), ' y:', tot_haz_udurationmatrix_m_young(tcnt),' p:', tot_haz_udurationmatrix_m_prime(tcnt), &
                                    '|a:', tot_haz_udurationmatrix_m_data(tcnt),' y:', tot_haz_udurationmatrix_m_young_data(tcnt),' p:', tot_haz_udurationmatrix_m_prime_data(tcnt)
    END DO

    WRITE(10,*) '~~~~~~~~ HAZARD INCOMPL. DURATION OF OCC STAYERS ~~~'
    WRITE(10,FMT='(A7,X,6(3X,A7))') 'mth dur', 'occmov', 'occmovy', 'occmovp', 'data', 'data y', 'data p'
    DO tcnt=0, 24
        WRITE(10,FMT='(I7,X,6(A3, F7.3))') tcnt, ' a:',tot_haz_udurationmatrix_s(tcnt), ' y:', tot_haz_udurationmatrix_s_young(tcnt),' p:', tot_haz_udurationmatrix_s_prime(tcnt), &
                                    '|a:', tot_haz_udurationmatrix_s_data(tcnt),' y:', tot_haz_udurationmatrix_s_young_data(tcnt),' p:', tot_haz_udurationmatrix_s_prime_data(tcnt)
    END DO




    WRITE(10,*) ' '
    WRITE(10,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (lower transition rates)'
    WRITE(10,*) '                    rates are normalized by first-month survivors in unemployment'
    WRITE(10,*) '                       not inflowers into unemployment'
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2(1), '--', duration2_data(1)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2(2), '--', duration2_data(2)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2(3), '--', duration2_data(3)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2(4), '--', duration2_data(4)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2(5), '--', duration2_data(5)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2(6), '--', duration2_data(6)
    WRITE(10,FMT='(1(A30, F10.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2(7), '--', duration2_data(7)

    WRITE(10,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (20-30yo) M/D'
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2_young(1), '--', duration2_young_data(1)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2_young(2), '--', duration2_young_data(2)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2_young(3), '--', duration2_young_data(3)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2_young(4), '--', duration2_young_data(4)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2_young(5), '--', duration2_young_data(5)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2_young(6), '--', duration2_young_data(6)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2_young(7), '--', duration2_young_data(7)

    WRITE(10,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (35-55yo) M/D'
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2_prime(1), '--', duration2_prime_data(1)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2_prime(2), '--', duration2_prime_data(2)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2_prime(3), '--', duration2_prime_data(3)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2_prime(4), '--', duration2_prime_data(4)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2_prime(5), '--', duration2_prime_data(5)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2_prime(6), '--', duration2_prime_data(6)
    WRITE(10,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2_prime(7), '--', duration2_prime_data(7)



WRITE(10,*) ' '
WRITE(10,*) ' ---- **SEP** SEMI ELASTICITIES WITH UNEMPLOYMENT (LIN DETRENDED) ---- '
tempreal=0.0
tempreal2=0.0
DO occcnt=1, occpts
    tempreal=tempreal+0.5*(corr_occdistr_begin_end(occcnt, 1)+corr_occdistr_begin_end(occcnt, 2))*sep_supocc_unemp_semielasticity_ldt(occcnt)
    tempreal2=tempreal2+0.5*(corr_occdistr_begin_end_data(occcnt, 1)+corr_occdistr_begin_end_data(occcnt, 2))*sep_supocc_unemp_semielasticity_ldt_data(occcnt)
END DO
    WRITE(10,FMT='(A3,A2,3(A9,A2), A2, 3(A9,A2))') 'occ', ', ', 'semi_el', ', ', 'nrm.uncnd', ', ', 'nrm.avdst', ', ', 'd;', 'semi_el', ', ', 'nrm.uncnd', ', ', 'nrm.avdst',', '
DO occcnt=1, occpts
    WRITE(10,FMT='(I3,A2,3(F9.4,A2), A2, 3(F9.4,A2))') occcnt, ', ', sep_supocc_unemp_semielasticity_ldt(occcnt),', ', sep_supocc_unemp_semielasticity_ldt(occcnt)/sep_unemp_semielasticity_ldt, ', ',&
                                                            sep_supocc_unemp_semielasticity_ldt(occcnt)/tempreal, ', ', '  ', &
                                                            sep_supocc_unemp_semielasticity_ldt_data(occcnt),', ', sep_supocc_unemp_semielasticity_ldt_data(occcnt)/sep_unemp_semielasticity_ldt_data, ', ',&
                                                            sep_supocc_unemp_semielasticity_ldt_data(occcnt)/tempreal2, ', '

END DO

WRITE(10,*) ' '
WRITE(10,*) ' ---- **SEP** ELASTICITIES WITH UNEMPLOYMENT (LIN DETRENDED) ---- '
tempreal=0.0
tempreal2=0.0
DO occcnt=1, occpts
    tempreal=tempreal+0.5*(corr_occdistr_begin_end(occcnt, 1)+corr_occdistr_begin_end(occcnt, 2))*sep_supocc_unemp_elasticity_ldt(occcnt)
    tempreal2=tempreal2+0.5*(corr_occdistr_begin_end_data(occcnt, 1)+corr_occdistr_begin_end_data(occcnt, 2))*sep_supocc_unemp_elasticity_ldt_data(occcnt)
END DO
    WRITE(10,FMT='(A3,A2,3(A9,A2), A2, 3(A9,A2))') 'occ', ', ', 'elas', ', ', 'nrm.uncnd', ', ', 'nrm.avdst', ', ', 'd;', 'elas', ', ', 'nrm.uncnd', ', ', 'nrm.avdst',', '
DO occcnt=1, occpts
    WRITE(10,FMT='(I3,A2,3(F9.4,A2), A2, 3(F9.4,A2))') occcnt, ', ', sep_supocc_unemp_elasticity_ldt(occcnt),', ', sep_supocc_unemp_elasticity_ldt(occcnt)/sep_unemp_elasticity_ldt, ', ',&
                                                            sep_supocc_unemp_elasticity_ldt(occcnt)/tempreal, ', ', '  ', &
                                                            sep_supocc_unemp_elasticity_ldt_data(occcnt),', ', sep_supocc_unemp_elasticity_ldt_data(occcnt)/sep_unemp_elasticity_ldt_data, ', ',&
                                                            sep_supocc_unemp_elasticity_ldt_data(occcnt)/tempreal2, ', '

END DO


WRITE(10,*) ' '
WRITE(10,*) ' ---- **UDUR** SEMI ELASTICITIES WITH UNEMPLOYMENT (LIN DETRENDED) ----- '
!DO occcnt=1, occpts
!    WRITE(10,*) occcnt, ' , ', udur_supocc_unemp_semielasticity_ldt(occcnt)
!END DO


tempreal=0.0
tempreal2=0.0
DO occcnt=1, occpts
    tempreal=tempreal+0.5*(occdistr_begin_end(occcnt, 1)+occdistr_begin_end(occcnt, 2))*udur_supocc_unemp_semielasticity_ldt(occcnt)
    tempreal2=tempreal2+0.5*(occdistr_begin_end_data(occcnt, 1)+occdistr_begin_end_data(occcnt, 2))*udur_supocc_unemp_semielasticity_ldt_data(occcnt)
END DO
    WRITE(10,FMT='(A3,A2,3(A9,A2), A2, 3(A9,A2))') 'occ', ', ', 'semi_el', ', ', 'nrm.avdst', ', ', 'nrm.avdst', ', ', 'd;', 'semi_el', ', ', 'nrm.avdst', ', ', 'nrm.avdst',', '
DO occcnt=1, occpts
    WRITE(10,FMT='(I3,A2,3(F9.4,A2), A2, 3(F9.4,A2))') occcnt, ', ', udur_supocc_unemp_semielasticity_ldt(occcnt),', ', udur_supocc_unemp_semielasticity_ldt(occcnt)/tempreal, ', ',&
                                                            udur_supocc_unemp_semielasticity_ldt(occcnt)/tempreal, ', ', '  ', &
                                                            udur_supocc_unemp_semielasticity_ldt_data(occcnt),', ', udur_supocc_unemp_semielasticity_ldt_data(occcnt)/tempreal2, ', ',&
                                                            udur_supocc_unemp_semielasticity_ldt_data(occcnt)/tempreal2, ', '

END DO


WRITE(10,*) ' '
WRITE(10,*) ' ---- **UDUR** ELASTICITIES WITH UNEMPLOYMENT (LINEARLY DETRENDED) ---- '
!DO occcnt=1, occpts
!    WRITE(10,*) occcnt, ' , ', udur_supocc_unemp_elasticity_ldt(occcnt)
!END DO
tempreal=0.0
tempreal2=0.0
DO occcnt=1, occpts
    tempreal=tempreal+0.5*(occdistr_begin_end(occcnt, 1)+occdistr_begin_end(occcnt, 2))*udur_supocc_unemp_elasticity_ldt(occcnt)
    tempreal2=tempreal2+0.5*(occdistr_begin_end_data(occcnt, 1)+occdistr_begin_end_data(occcnt, 2))*udur_supocc_unemp_elasticity_ldt_data(occcnt)
END DO
    WRITE(10,FMT='(A3,A2,3(A9,A2), A2, 3(A9,A2))') 'occ', ', ', 'semi_el', ', ', 'nrm.avdst', ', ', 'nrm.avdst', ', ', 'd;', 'semi_el', ', ', 'nrm.avdst', ', ', 'nrm.avdst',', '
DO occcnt=1, occpts
    WRITE(10,FMT='(I3,A2,3(F9.4,A2), A2, 3(F9.4,A2))') occcnt, ', ', udur_supocc_unemp_elasticity_ldt(occcnt),', ', udur_supocc_unemp_elasticity_ldt(occcnt)/tempreal, ', ',&
                                                            udur_supocc_unemp_elasticity_ldt(occcnt)/tempreal, ', ', '  ', &
                                                            udur_supocc_unemp_elasticity_ldt_data(occcnt),', ', udur_supocc_unemp_elasticity_ldt_data(occcnt)/tempreal2, ', ',&
                                                            udur_supocc_unemp_elasticity_ldt_data(occcnt)/tempreal2, ', '

END DO


END IF



IF(verbose_results_l3==1) THEN

    WRITE(10,*) '~~~~ EMPLOYMENT DURATION AFTER UE_OCC: SURVIVAL RATES'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ(1), '--', empduration_occ_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ(2), '--', empduration_occ_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ(3), '--', empduration_occ_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ(4), '--', empduration_occ_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ(5), '--', empduration_occ_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ(6), '--', empduration_occ_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ(7), '--', empduration_occ_data(7)

    WRITE(10,*) '~~~~ EMPLOYMENT DURATION AFTER UE_NOCC: SURVIVAL RATES'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc(1), '--', empduration_nocc_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc(2), '--', empduration_nocc_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc(3), '--', empduration_nocc_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc(4), '--', empduration_nocc_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc(5), '--', empduration_nocc_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc(6), '--', empduration_nocc_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc(7), '--', empduration_nocc_data(7)


    WRITE(10,*) '~~~~ E-DUR AFTER UE_OCC_Y: SURVIVAL RATES YOUNG'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ_y(1), '--', empduration_occ_y_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ_y(2), '--', empduration_occ_y_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ_y(3), '--', empduration_occ_y_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ_y(4), '--', empduration_occ_y_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ_y(5), '--', empduration_occ_y_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ_y(6), '--', empduration_occ_y_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ_y(7), '--', empduration_occ_y_data(7)

    WRITE(10,*) '~~~~ E-DUR AFTER UE_NOCC_Y: SURVIVAL RATES YOUNG'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc_y(1), '--', empduration_nocc_y_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc_y(2), '--', empduration_nocc_y_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc_y(3), '--', empduration_nocc_y_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc_y(4), '--', empduration_nocc_y_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc_y(5), '--', empduration_nocc_y_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc_y(6), '--', empduration_nocc_y_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc_y(7), '--', empduration_nocc_y_data(7)


    WRITE(10,*) '~~~~ E-DUR AFTER UE_OCC_P: SURVIVAL RATES PRIME'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ_p(1), '--', empduration_occ_p_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ_p(2), '--', empduration_occ_p_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ_p(3), '--', empduration_occ_p_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ_p(4), '--', empduration_occ_p_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ_p(5), '--', empduration_occ_p_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ_p(6), '--', empduration_occ_p_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ_p(7), '--', empduration_occ_p_data(7)

    WRITE(10,*) '~~~~ E-DUR AFTER UE_NOCC_P: SURVIVAL RATES PRIME'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc_p(1), '--', empduration_nocc_p_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc_p(2), '--', empduration_nocc_p_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc_p(3), '--', empduration_nocc_p_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc_p(4), '--', empduration_nocc_p_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc_p(5), '--', empduration_nocc_p_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc_p(6), '--', empduration_nocc_p_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc_p(7), '--', empduration_nocc_p_data(7)



    WRITE(10,*) '~~~~ E-DUR AFTER UE_OCC_SHUSPELL: SURVIVAL RATES PREV U SPELL=short'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ_shuspell(1), '--', empduration_occ_shuspell_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ_shuspell(2), '--', empduration_occ_shuspell_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ_shuspell(3), '--', empduration_occ_shuspell_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ_shuspell(4), '--', empduration_occ_shuspell_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ_shuspell(5), '--', empduration_occ_shuspell_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ_shuspell(6), '--', empduration_occ_shuspell_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ_shuspell(7), '--', empduration_occ_shuspell_data(7)

    WRITE(10,*) '~~~~ E-DUR AFTER UE_NOCC_SHUSPELL: SURVIVAL RATES PREV U SPELL=short'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc_shuspell(1), '--', empduration_nocc_shuspell_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc_shuspell(2), '--', empduration_nocc_shuspell_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc_shuspell(3), '--', empduration_nocc_shuspell_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc_shuspell(4), '--', empduration_nocc_shuspell_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc_shuspell(5), '--', empduration_nocc_shuspell_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc_shuspell(6), '--', empduration_nocc_shuspell_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc_shuspell(7), '--', empduration_nocc_shuspell_data(7)


 WRITE(10,*) '~~~~ E-DUR AFTER UE_OCC_LUSPELL: SURVIVAL RATES PREV U SPELL=long'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ_luspell(1), '--', empduration_occ_luspell_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ_luspell(2), '--', empduration_occ_luspell_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ_luspell(3), '--', empduration_occ_luspell_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ_luspell(4), '--', empduration_occ_luspell_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ_luspell(5), '--', empduration_occ_luspell_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ_luspell(6), '--', empduration_occ_luspell_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ_luspell(7), '--', empduration_occ_luspell_data(7)

    WRITE(10,*) '~~~~ E-DUR AFTER UE_NOCC_LUSPELL: SURVIVAL RATES PREV U SPELL=long'
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc_luspell(1), '--', empduration_nocc_luspell_data(1)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc_luspell(2), '--', empduration_nocc_luspell_data(2)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc_luspell(3), '--', empduration_nocc_luspell_data(3)
    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc_luspell(4), '--', empduration_nocc_luspell_data(4)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc_luspell(5), '--', empduration_nocc_luspell_data(5)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc_luspell(6), '--', empduration_nocc_luspell_data(6)
!    WRITE(10,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc_luspell(7), '--', empduration_nocc_luspell_data(7)






    WRITE(10,*) '~~~~~~~~~ RELATIVE SURVIVAL OCC/NOCC PROBABILITY AT 2YRS ~~~~~~~~~:', (empduration_occ(6)/empduration_nocc(6))-1.0_8
END IF


IF(verbose_results_l1==1) THEN

    WRITE(10,*) '~~~~~~~~~ SUBSEQUENT UNEMPLOYMENT HAZARD ~~~~~~~~~:'
    WRITE(10,*) ' === MODEL: Ps(tay)a(fter)s(tay), Psam(ove), Pmam, Pmas ==='
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', pnoccafternocc, '-', pnoccafterocc, '-', poccafterocc, '-', poccafternocc
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'y:', pnoccafternocc_y, '-', pnoccafterocc_y, '-', poccafterocc_y, '-', poccafternocc_y
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'p:', pnoccafternocc_p, '-', pnoccafterocc_p, '-', poccafterocc_p, '-', poccafternocc_p

    WRITE(10,*) ' === DATA: Ps(tay)a(fter)s(tay), Psam(ove), Pmam, Pmas ==='
!    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', reemployhaz_sas_data, '-', reemployhaz_sam_data, '-', reemployhaz_mam_data, '-', reemployhaz_mas_data
!    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'y:', reemployhaz_sas_y_data, '-', reemployhaz_sam_y_data, '-', reemployhaz_mam_y_data, '-', reemployhaz_mas_y_data
!    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'p:', reemployhaz_sas_p_data, '-', reemployhaz_sam_p_data, '-', reemployhaz_mam_p_data, '-', reemployhaz_mas_p_data
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', pnoccafternocc_data, '-', pnoccafterocc_data, '-', poccafterocc_data, '-', poccafternocc_data
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'y:', pnoccafternocc_y_data, '-', pnoccafterocc_y_data, '-', poccafterocc_y_data, '-', poccafternocc_y_data
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'p:', pnoccafternocc_p_data, '-', pnoccafterocc_p_data, '-', poccafterocc_p_data, '-', poccafternocc_p_data
    END IF


IF(verbose_results_l3==1) THEN

    WRITE(10,*) '~~~~~~~~~ SUBSEQUENT UNEMPLOYMENT HAZARD w. LENGTH (sh/lg) PREVIOUS UNEMPLOYMENT SPELL ~~~~~~~~~:'


    WRITE(10,*) ' === MODEL: Ps(tay)a(fter)s(tay), Psam(ove), Pmam, Pmas ==='
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ash:', pnoccafternocc_uspell(1), '-', pnoccafterocc_uspell(1), '-', poccafterocc_uspell(1), '-', poccafternocc_uspell(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'alg:', pnoccafternocc_uspell(2), '-', pnoccafterocc_uspell(2), '-', poccafterocc_uspell(2), '-', poccafternocc_uspell(2)

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ysh:', pnoccafternocc_y_uspell(1), '-', pnoccafterocc_y_uspell(1), '-', poccafterocc_y_uspell(1), '-', poccafternocc_y_uspell(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ylg:', pnoccafternocc_y_uspell(2), '-', pnoccafterocc_y_uspell(2), '-', poccafterocc_y_uspell(2), '-', poccafternocc_y_uspell(2)

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'psh:', pnoccafternocc_p_uspell(1), '-', pnoccafterocc_p_uspell(1), '-', poccafterocc_p_uspell(1), '-', poccafternocc_p_uspell(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'plg:', pnoccafternocc_p_uspell(2), '-', pnoccafterocc_p_uspell(2), '-', poccafterocc_p_uspell(2), '-', poccafternocc_p_uspell(2)

    WRITE(10,*) ' === DATA: Ps(tay)a(fter)s(tay), Psam(ove), Pmam, Pmas ==='

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ash:', pnoccafternocc_uspell_data(1), '-', pnoccafterocc_uspell_data(1), '-', poccafterocc_uspell_data(1), '-', poccafternocc_uspell_data(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'alg:', pnoccafternocc_uspell_data(2), '-', pnoccafterocc_uspell_data(2), '-', poccafterocc_uspell_data(2), '-', poccafternocc_uspell_data(2)

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ysh:', pnoccafternocc_y_uspell_data(1), '-', pnoccafterocc_y_uspell_data(1), '-', poccafterocc_y_uspell_data(1), '-', poccafternocc_y_uspell_data(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'ylg:', pnoccafternocc_y_uspell_data(2), '-', pnoccafterocc_y_uspell_data(2), '-', poccafterocc_y_uspell_data(2), '-', poccafternocc_y_uspell_data(2)

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'psh:', pnoccafternocc_p_uspell_data(1), '-', pnoccafterocc_p_uspell_data(1), '-', poccafterocc_p_uspell_data(1), '-', poccafternocc_p_uspell_data(1)
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'plg:', pnoccafternocc_p_uspell_data(2), '-', pnoccafterocc_p_uspell_data(2), '-', poccafterocc_p_uspell_data(2), '-', poccafternocc_p_uspell_data(2)


    WRITE(10,*) '    '
    WRITE(10,*) '  ELASTICITY OF PREVIOUS U-SPELL WITH CURRENT SPELL: occ stayers/movers  '

    WRITE(10,*) ' === MODEL: ELASTICITY-CORRELATION, DATA:EL-CORR ==='
    WRITE(10,*) ' all   '

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', repeat_udur_el , '-', repeat_udur_corr , '-', repeat_udur_el_data , '-', repeat_udur_corr_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'am :', repeat_udur_el_m , '-', repeat_udur_corr_m , '-', repeat_udur_el_m_data , '-', repeat_udur_corr_m_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'as :', repeat_udur_el_s , '-', repeat_udur_corr_s , '-', repeat_udur_el_s_data , '-', repeat_udur_corr_s_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sam:', repeat_udur_el_sam , '-', repeat_udur_corr_sam , '-', repeat_udur_el_sam_data , '-', repeat_udur_corr_sam_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sas:', repeat_udur_el_sas , '-', repeat_udur_corr_sas , '-', repeat_udur_el_sas_data , '-', repeat_udur_corr_sas_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mam:', repeat_udur_el_mam , '-', repeat_udur_corr_mam , '-', repeat_udur_el_mam_data , '-', repeat_udur_corr_mam_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mas:', repeat_udur_el_mas , '-', repeat_udur_corr_mas , '-', repeat_udur_el_mas_data , '-', repeat_udur_corr_mas_data , '-'


    WRITE(10,*) ' yy   '

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', repeat_udur_el_y , '-', repeat_udur_corr_y , '-', repeat_udur_el_y_data , '-', repeat_udur_corr_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'am :', repeat_udur_el_m_y , '-', repeat_udur_corr_m_y , '-', repeat_udur_el_m_y_data , '-', repeat_udur_corr_m_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'as :', repeat_udur_el_s_y , '-', repeat_udur_corr_s_y , '-', repeat_udur_el_s_y_data , '-', repeat_udur_corr_s_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sam:', repeat_udur_el_sam_y , '-', repeat_udur_corr_sam_y , '-', repeat_udur_el_sam_y_data , '-', repeat_udur_corr_sam_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sas:', repeat_udur_el_sas_y , '-', repeat_udur_corr_sas_y , '-', repeat_udur_el_sas_y_data , '-', repeat_udur_corr_sas_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mam:', repeat_udur_el_mam_y , '-', repeat_udur_corr_mam_y , '-', repeat_udur_el_mam_y_data , '-', repeat_udur_corr_mam_y_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mas:', repeat_udur_el_mas_y , '-', repeat_udur_corr_mas_y , '-', repeat_udur_el_mas_y_data , '-', repeat_udur_corr_mas_y_data , '-'


    WRITE(10,*) ' pp   '

    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'all:', repeat_udur_el_p , '-', repeat_udur_corr_p , '-', repeat_udur_el_p_data , '-', repeat_udur_corr_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'am :', repeat_udur_el_m_p , '-', repeat_udur_corr_m_p , '-', repeat_udur_el_m_p_data , '-', repeat_udur_corr_m_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'as :', repeat_udur_el_s_p , '-', repeat_udur_corr_s_p , '-', repeat_udur_el_s_p_data , '-', repeat_udur_corr_s_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sam:', repeat_udur_el_sam_p , '-', repeat_udur_corr_sam_p , '-', repeat_udur_el_sam_p_data , '-', repeat_udur_corr_sam_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'sas:', repeat_udur_el_sas_p , '-', repeat_udur_corr_sas_p , '-', repeat_udur_el_sas_p_data , '-', repeat_udur_corr_sas_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mam:', repeat_udur_el_mam_p , '-', repeat_udur_corr_mam_p , '-', repeat_udur_el_mam_p_data , '-', repeat_udur_corr_mam_p_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A1))') 'mas:', repeat_udur_el_mas_p , '-', repeat_udur_corr_mas_p , '-', repeat_udur_el_mas_p_data , '-', repeat_udur_corr_mas_p_data , '-'


    WRITE(10,*) ' composition of repeat unemployment, with duration of previous spells'
    WRITE(10,FMT='(A4, 4(F6.3, A4))') 'ssst', noccafternocc_uspell(1), 'sslt', noccafternocc_uspell(2) , 'data', noccafternocc_stu_data , '-', noccafternocc_ltu_data , '-'
    WRITE(10,FMT='(A4, 4(F6.3, A4))') 'smst', noccafterocc_uspell(1), 'smlt', noccafterocc_uspell(2) , 'data', noccafterocc_stu_data , '-', noccafterocc_ltu_data , '-'
    END IF

    vbdist_if: IF(verbose_distribution==1) THEN
    WRITE(10,*) ' '
    WRITE(10,*) ' '
    WRITE(10,*) 'unemployment and employment distributions w/ agg prod'



    ! productivity distribution
    WRITE(10, FMT='(A8)' , ADVANCE='no') 'ag.pdstr'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)', ADVANCE='no' ) 'pdistr'

    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') p_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '



    ! unemployment distribution
    WRITE(10, FMT='(A8)' ) ' u_p: '
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    WRITE(10, FMT='(A8)' ) ' u_p2: '
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_distribution_sim2(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'urest(p)'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_rest_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'ureal(p)'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_reall_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'usrch(p)'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_search_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uy w/ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_young_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '




    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uyrest_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_young_rest_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uyreal_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_young_reall_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uysrch_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_young_search_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uprime_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_prime_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '



    WRITE(10, FMT='(A8)' , ADVANCE='no') 'uprest_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_prime_rest_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'upreal_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_prime_reall_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A8)' , ADVANCE='no') 'upsrch_p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_prime_search_distribution_sim(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '


    WRITE(10, FMT='(A2)' ) ' '
    WRITE(10, FMT='(A2)' ) ' '
    WRITE(10, FMT='(A2)' ) ' '
    WRITE(10, *) '  distribution of unemployed with aggregate productivity and z-prod'

    ! ! unemployment distribution
!     WRITE(10, FMT='(A8)' , ADVANCE='no') 'urate(p)'
!     DO pcnt=1,ppts
!         WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
!     END DO
!     WRITE(10, FMT='(A2)' ) ' '
!     DO pcnt=1,ppts
!         WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') up_distribution_sim(pcnt)
!     END DO
!     WRITE(10, FMT='(A2)' ) ' '
!
!     WRITE(10, FMT='(A8)' , ADVANCE='no') 'uymss(p)'
!
!     DO pcnt=1,ppts
!         WRITE(10, FMT='(F7.4, X)' , ADVANCE='NO') up_young_distribution_sim(pcnt)/p_distribution_sim(pcnt)
!     END DO
!     WRITE(10, FMT='(A2)' ) ' '
!
!     WRITE(10, FMT='(A8)' , ADVANCE='no') 'upmss(p)'
!     DO pcnt=1,ppts
!         WRITE(10, FMT='(F7.4, X)' , ADVANCE='NO') up_prime_distribution_sim(pcnt)/p_distribution_sim(pcnt)
!     END DO
!     WRITE(10, FMT='(A2)' ) ' '


WRITE(10, *) '  distribution of unemployed over islands, with different aggregate product.'

    ! unemployment distribution
    WRITE(10, *) ' distribution of **ALL UNEMPLOYED**, over islands, with p'
    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    DO zcnt=1, zpts
    WRITE(10, FMT='(A4,F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') upz_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO

    WRITE(10, *) ' distribution of **YOUNG UNEMPLOYMENT**, over islands, with p'

    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    DO zcnt=1, zpts
    WRITE(10, FMT='(A4,F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') upz_young_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO


    WRITE(10, *) ' distribution of **PRIME UNEMPLOYMENT**, over islands, with p'

    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    DO zcnt=1, zpts
        WRITE(10, FMT='(A4,F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') upz_prime_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO

    WRITE(10,*) ' '

WRITE(10, *) '  distribution of employed over islands, with different aggregate productivity'

    ! employment mass distribution
    WRITE(10, *) ' distribution of **ALL EMPLOYED**, over islands, with p'
    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    DO zcnt=1, zpts
    WRITE(10, FMT='(A4, F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') epz_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO

    WRITE(10, *) ' distribution of **YOUNG EMPLOYED**, over islands, with p'
    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    DO zcnt=1, zpts
    WRITE(10, FMT='(A4,F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') epz_young_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO


    WRITE(10, *) ' distribution of **PRIME EMPLOYED**, over islands, with p'

    WRITE(10, FMT='(A13,X)' , ADVANCE='no') '  z \ p'
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') pvector(pcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '

    DO zcnt=1, zpts
        WRITE(10, FMT='(A4,F9.6,X)' , ADVANCE='no') '  z=', zvector(zcnt)
    DO pcnt=1,ppts
        WRITE(10, FMT='(F9.6, X)' , ADVANCE='NO') epz_prime_distribution_sim(pcnt,zcnt)
    END DO
    WRITE(10, FMT='(A2)' ) ' '
    END DO
    END IF vbdist_if
    !$OMP END CRITICAL




!!$OMP MASTER
!
!IF(verboseswitchfile==1 .AND. screenoutcapture_switch==1) THEN
!OPEN(UNIT=11, file="data.txt", status="old", form="formatted", position="append")
!
!
!
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave prod         ~~~~ ', prod_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave u         ~~~~ ', unemp_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave u_young   ~~~~ ', u_young_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave u_prime   ~~~~ ', u_prime_ave
!    WRITE(11,FMT='(A27)') ' '
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave c_occ infl ~~~ ', cocc_inflow_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave c_oc infl y~~~ ', cocc_young_inflow_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave c_oc infl p~~~ ', cocc_prime_inflow_ave
!    WRITE(11,FMT='(A27)') ' '
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave comp occ   ~~~ ', cocc_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave comp occ y ~~~ ', cocc_young_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave comp occ p ~~~ ', cocc_prime_ave
!    WRITE(11,FMT='(A27)') ' '
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave jfocc      ~~~ ', jfocc_ave
!    !WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave jfocc young~~~ ', jfocc_young_ave
!    !WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~ave jfocc prime~~~ ', jfocc_prime_ave
!    WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~av jfnocc      ~~~ ', jfnocc_ave
!    !WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~av jfnocc young~~~ ', jfnocc_young_ave
!    !WRITE(11,FMT='(A27, F9.4, A2, F9.4)') '~~~~av jfnocc prime~~~ ', jfnocc_prime_ave
!
!    WRITE(11,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp n_after c~~~ ', noccafterocc_ave, '~~~rel.~~~', noccafterocc_ave/cocc_inflow_ave
!    WRITE(11,FMT='(A27, F9.4, A10, F9.4)') '~~~~comp n after n~~~ ', noccafternocc_ave, '~~~rel.~~~', noccafternocc_ave/cocc_inflow_ave
!
!
!
!
!    WRITE(11,*) ' '
!    WRITE(11,*) '~~~~~RETURNS TENURE~~~~~ '
!    WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'returns 5y occ ten~~~~', returnstenure5y, '--', 0.12_8
!    WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'returns 5y occ ten~~~~', returnstenure10y, '--', 0.18_8
!
!    !   WRITE(11,*) ' '
!!       WRITE(11,*) '~~~~~OCC TENURE DISTRIBUTION~~~~~ '
!!       WRITE(11,*) 'occ_ten_dist(1)', occ_ten_dist(1)
!!       WRITE(11,*) 'occ_ten_dist(2)', occ_ten_dist(2)
!!       WRITE(11,*) 'occ_ten_dist(3)', occ_ten_dist(3)
!!       WRITE(11,*) 'occ_ten_dist(4)', occ_ten_dist(4)
!!       WRITE(11,*) 'occ_ten_dist(5)', occ_ten_dist(5)
!!       WRITE(11,*) 'occ_ten_dist(6)', occ_ten_dist(6)
!!       WRITE(11,*) 'occ_ten_dist(7)', occ_ten_dist(7)
!!       WRITE(11,*) 'occ_ten_dist(8)', occ_ten_dist(8)
!!
!!
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 18/6months ~~~~', 1.0 - occ_ten_dist(2)/occ_ten_dist(1), '--', 0.25_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 30/18months~~~~', 1.0 - occ_ten_dist(3)/occ_ten_dist(2), '--', 0.20_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 42/30months~~~~', 1.0 - occ_ten_dist(4)/occ_ten_dist(3), '--', 0.163_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 54/42months~~~~', 1.0 - occ_ten_dist(5)/occ_ten_dist(4), '--', 0.146_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 66/54months~~~~', 1.0 - occ_ten_dist(6)/occ_ten_dist(5), '--', 0.117_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 78/66months~~~~', 1.0 - occ_ten_dist(7)/occ_ten_dist(6), '--', 0.103_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 90/78months~~~~', 1.0 - occ_ten_dist(8)/occ_ten_dist(7), '--', 0.093_8
!!       WRITE(11,FMT='(A20, F8.5, A2, F8.5)' ) 'hazard 21/20 years~~~~', 1.0 - occ_ten_dist(10)/occ_ten_dist(9), '--', 0.05_8
!!
!!       WRITE(11,*) 'TARGETS IN TERMS OF TENURE HAZARDS'
!!       WRITE(11,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 30/18 divided by surv 18/6~~~~', (occ_ten_dist(3)/occ_ten_dist(2))/ (occ_ten_dist(2)/occ_ten_dist(1)), '--', 0.80/0.75_8
!!       WRITE(11,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 42/30 divided by surv 30/18~~~~',(occ_ten_dist(4)/occ_ten_dist(3))/(occ_ten_dist(3)/occ_ten_dist(2)), '--', 0.837 /0.80_8
!!       WRITE(11,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 54/42 divided by surv 42/30~~~~', (occ_ten_dist(5)/occ_ten_dist(4)) /(occ_ten_dist(4)/occ_ten_dist(3)), '--', 0.856/0.837_8
!!       WRITE(11,FMT='(A60, F8.5, A2, F8.5)' ) '~~~~survival rate 66/54 divided by surv 54/42~~~~', (occ_ten_dist(6)/occ_ten_dist(5))/(occ_ten_dist(5)/occ_ten_dist(4)), '--', 0.883/0.856_8
!!
!!
!       WRITE(11,*) ' '
!       WRITE(11,*) '~~~~ AVERAGE UNEMPLOYMENT DURATION DISTRIBUTION FROM BLS vs. SIPP'
!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop  unemp < 5wks', ult5wk_ave, '--', ult5wk_ave_data, ' < 3months', uprop_3m_ave, '--', uprop_3m_ave_data
!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt5 lt15 wk', u5lt15wk_ave, '--', u5lt15wk_ave_data,'< 5months', uprop_5m_ave, '--', uprop_5m_ave_data
!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt15 lt27 w', u15lt27wk_ave, '--', u15lt27wk_ave_data, '5-9 months', uprop_9m_ave, '--', uprop_9m_ave_data
!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt27 weeks ', ugt27wk_ave, '--', ugt27wk_ave_data,'9-13months ', uprop_13m_ave, '--', uprop_13m_ave_data
!!
!!       WRITE(11,*) '~~~~ AVERAGE UNEMPLOYMENT DURATION DISTRIBUTION FROM BLS: from simulation totals '
!!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop  unemp < 5wks', tot_ult5wk, '--', 0.38_8, 'matrix < 5wks', ult5wk_2, '--', 0.38_8
!!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt5 lt15 wk', tot_u5lt15wk, '--', 0.3_8,'matr u gt5 lt15 wk', u5lt15wk_2, '--', 0.3_8
!!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt15 lt27 w', tot_u15lt27wk, '--', 0.14_8, 'matr u gt15 lt27 w', u15lt27wk_2, '--', 0.14_8
!!       WRITE(11,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop u gt27 weeks ', tot_ugt27wk, '--', 0.18_8,'matr u gt27 weeks ', ugt27wk_2, '--', 0.18_8
!!
!
!    WRITE(11,*) ' '
!    WRITE(11,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (lower transition rates)'
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2(1), '--', duration2_data(1)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2(2), '--', duration2_data(2)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2(3), '--', duration2_data(3)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2(4), '--', duration2_data(4)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2(5), '--', duration2_data(5)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2(6), '--', duration2_data(6)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2(7), '--', duration2_data(7)
!
!    WRITE(11,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (20-30yo) M/D'
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2_young(1), '--', duration2_young_data(1)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2_young(2), '--', duration2_young_data(2)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2_young(3), '--', duration2_young_data(3)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2_young(4), '--', duration2_young_data(4)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2_young(5), '--', duration2_young_data(5)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2_young(6), '--', duration2_young_data(6)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2_young(7), '--', duration2_young_data(7)
!
!    WRITE(11,*) '~~~~ UNEMPLOYMENT DURATION: SURVIVAL RATES FROM SIPP (35-55yo): M/D'
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 2m', duration2_prime(1), '--', duration2_prime_data(1)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 4m', duration2_prime(2), '--', duration2_prime_data(2)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 8m', duration2_prime(3), '--', duration2_prime_data(3)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 12m', duration2_prime(4), '--', duration2_prime_data(4)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 16m', duration2_prime(5), '--', duration2_prime_data(5)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 20m', duration2_prime(6), '--', duration2_prime_data(6)
!    WRITE(11,FMT='(1(A30, F7.4, A2, F7.4))' ) 'U surv up to (incl) 24m', duration2_prime(7), '--', duration2_prime_data(7)
!
!
!    WRITE(11,*) '~~~~ EMPLOYMENT DURATION AFTER UE_OCC: SURVIVAL RATES'
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_occ(1), '--', empduration_occ_data(1)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_occ(2), '--', empduration_occ_data(2)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_occ(3), '--', empduration_occ_data(3)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_occ(4), '--', empduration_occ_data(4)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_occ(5), '--', empduration_occ_data(5)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_occ(6), '--', empduration_occ_data(6)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_occ(7), '--', empduration_occ_data(7)
!
!    WRITE(11,*) '~~~~ EMPLOYMENT DURATION AFTER UE_NOCC: SURVIVAL RATES'
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 4m', empduration_nocc(1), '--', empduration_nocc_data(1)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 8m', empduration_nocc(2), '--', empduration_nocc_data(2)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 12m', empduration_nocc(3), '--', empduration_nocc_data(3)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 16m', empduration_nocc(4), '--', empduration_nocc_data(4)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 20m', empduration_nocc(5), '--', empduration_nocc_data(5)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 24m', empduration_nocc(6), '--', empduration_nocc_data(6)
!    WRITE(11,FMT='(1(A30, F5.2, A2, F5.2))' ) 'surv up to (incl) 28m', empduration_nocc(7), '--', empduration_nocc_data(7)
!
!    WRITE(11,*) '~~~~~~~~~ RELATIVE SURVIVAL OCC/NOCC PROBABILITY AT 2YRS ~~~~~~~~~:', (empduration_occ(6)/empduration_nocc(6))-1.0_8
!
!CLOSE(11)
!END IF
!!$OMP END MASTER


!WRITE(10,*) 'THREAD NUMBER REPORTING *****************', threadnumber



!WRITE(*,*) '************ RELOCATION /SEPARATION CUTOFFS******************'
!DO pcnt=1, ppts
!WRITE(*, FMT='(F5.2, A5)', ADVANCE='no') pvector(pcnt), ',---,'
!DO xcnt=1, xpts
!    IF(reservation_zr(pcnt, xcnt)>zpts) THEN
!        tempreal=888.88_8
!    ELSE
!        tempreal=zvector(reservation_zr(pcnt, xcnt))
!    END IF
!    WRITE(*, FMT='(F5.2, A1, I3, A5)', ADVANCE='no') tempreal,'-',reservation_zr(pcnt, xcnt), ',-|-,'
!END DO
!    DO xcnt=1, xpts
!    IF(reservation_zq(pcnt, xcnt)>zpts) THEN
!        tempreal2=888.88_8
!    ELSE
!        tempreal2=zvector(reservation_zq(pcnt, xcnt))
!    END IF
!    WRITE(*, FMT='(F5.2, A1, I3, A5)', ADVANCE='no') tempreal,'-',reservation_zq(pcnt, xcnt), ',-|-,'
!    END DO
!
!
!WRITE(*, FMT='(A5)') ' '
!
!END DO

!===============================================================
!          MONTHLY TIME SERIES, written to file
!===============================================================

!IF (threadnumber==1) THEN
!OPEN(UNIT=93, file="monthly_time_series2.txt", status="replace", form="formatted")
!IF (matrix_statistics==1) WRITE(93, FMT='(13(A6))', ADVANCE='NO') "time,", "agg p,", "u,", "v,", "theta,", "sep,", "jf,", "wage,", "prod,", "reall,", "and simul:,"
!WRITE(93, FMT='(12(A6))') "time,", "agg p,", "u,", "v,", "theta,", "sep,", "jf,", "wage,", "prod,", "reall,"
!DO t=1,tmax_sim2
!IF (matrix_statistics==1) WRITE(93, FMT='(I6, A1, 9(F7.5, A1))') t, ",", pvector(aggprod_ind(t)), ",", data_u_qtr(t), "," , data_v_qtr(t), "," ,data_theta_qtr(t), ",", &
!        data_sep_qtr(t), ","  , data_jf_qtr(t), ","  , data_wage_qtr(t), ","  , data_prod_qtr(t), ","  , data_reall_qtr(t)
!WRITE(93, FMT='(I6, A1, 3(F10.7, X, A1, X))', ADVANCE='NO') t, ",", pvector(aggprod_ind(t)), ",", data_u_qtr(t), "," , data_v_qtr(t), ","
!WRITE(93, FMT='(6(F10.7, X, A1, X))') data_theta_qtr(t), ",", data_sep_qtr(t), ","  , data_jf_qtr(t), ","  , data_wage_qtr(t), "," &
!                             , data_prod_qtr(t), ","  , data_reall_qtr(t)
!END DO
!CLOSE(93)
!END IF !(threadnumber==1)
!


!============================================
!          AGGREGATE TIME SERIES  -- LOG, QUARTERLY & HP-FILTERED
!============================================
IF(verbose_progress) WRITE(*,*) 'at foot of additional series allocation'
!$OMP CRITICAL
tcnt=(tmax_qtr2/4)
ALLOCATE(data_ulev_qtr(tmax_qtr2), data_lsep_qtr(tmax_qtr2), data_lsep_y_qtr(tmax_qtr2), data_lsep_p_qtr(tmax_qtr2), data_ljf_qtr(tmax_qtr2), &
data_ljf_young_qtr(tmax_qtr2), data_ljf_prime_qtr(tmax_qtr2), data_lpocc_qtr(tmax_qtr2), data_lpnocc_qtr(tmax_qtr2), &
data_ljf5_qtr(tmax_qtr2), data_ljf5_young_qtr(tmax_qtr2), data_ljf5_prime_qtr(tmax_qtr2), data_lpocc5_qtr(tmax_qtr2), &
data_lpnocc5_qtr(tmax_qtr2), data_lv5_qtr(tmax_qtr2), data_lu5_qtr(tmax_qtr2), data_luall5_qtr(tmax_qtr2), data_ltheta5_qtr(tmax_qtr2), &
data_lsep5_qtr(tmax_qtr2), data_lprod5_qtr(tmax_qtr2), data_lwage5_qtr(tmax_qtr2), &
data_lcocc_outflow5_qtr(tmax_qtr2), data_lcocc_young_outflow5_qtr(tmax_qtr2), data_lcocc_prime_outflow5_qtr(tmax_qtr2), &
data_u_yr(tcnt+1), data_sep_y_yr(tcnt+1), data_sep_p_yr(tcnt+1), data_jf_y_yr(tcnt+1), data_jf_p_yr(tcnt+1), data_u_y_yr(tcnt+1), data_u_p_yr(tcnt+1), &
data_sm5_ult3m_qtr(tmax_qtr2), data_sm5_ult5m_qtr(tmax_qtr2), &
data_sm5_ult9m_qtr(tmax_qtr2), data_sm5_ult13m_qtr(tmax_qtr2), data_sm5_ugt13m_qtr(tmax_qtr2) &
)
!$OMP END CRITICAL

    IF(verbose_progress) WRITE(*,*) 'passed allocation of additional series, all go to tmax_qtr2, except the yearly series to tmax_qtr2/4 +1'

! LOG YEARLY SERIES: U, SEP_Y, SEP_P
        ! aggregate into yearly stats
    DO i=1, tmax_qtr2/4
           tcnt=(i-1)*4+1
           data_u_yr(i)=0.25_8*(data_uall_qtr(tcnt)+ data_uall_qtr(tcnt+1)+data_uall_qtr(tcnt+2)+ data_uall_qtr(tcnt+3))
           data_sep_y_yr(i)=0.25_8*(data_sep_y_qtr(tcnt)+ data_sep_y_qtr(tcnt+1)+data_sep_y_qtr(tcnt+2)+ data_sep_y_qtr(tcnt+3))
           data_sep_p_yr(i)=0.25_8*(data_sep_p_qtr(tcnt)+ data_sep_p_qtr(tcnt+1)+data_sep_p_qtr(tcnt+2)+ data_sep_p_qtr(tcnt+3))
           data_jf_y_yr(i)=0.25_8*(data_jf_young_qtr(tcnt)+ data_jf_young_qtr(tcnt+1)+data_jf_young_qtr(tcnt+2)+ data_jf_young_qtr(tcnt+3))
           data_jf_p_yr(i)=0.25_8*(data_jf_prime_qtr(tcnt)+ data_jf_prime_qtr(tcnt+1)+data_jf_prime_qtr(tcnt+2)+ data_jf_prime_qtr(tcnt+3))
           data_u_y_yr(i)=0.25_8*(data_u_young_qtr(tcnt)+ data_u_young_qtr(tcnt+1)+data_u_young_qtr(tcnt+2)+ data_u_young_qtr(tcnt+3))
           data_u_p_yr(i)=0.25_8*(data_u_prime_qtr(tcnt)+ data_u_prime_qtr(tcnt+1)+data_u_prime_qtr(tcnt+2)+ data_u_prime_qtr(tcnt+3))
    END DO
    !! check
        uall_yrave=sum(data_u_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        sep_y_yrave=sum(data_sep_y_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        sep_p_yrave=sum(data_sep_p_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        jf_y_yrave=sum(data_jf_y_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        jf_p_yrave=sum(data_jf_p_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        u_y_yrave=sum(data_u_y_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)
        u_p_yrave=sum(data_u_p_yr(1:(tmax_qtr2/4)))/REAL(tmax_qtr2/4)




        ! log 'em
            data_u_yr(1:(tmax_qtr2/4))=LOG(data_u_yr(1:(tmax_qtr2/4)))
            data_sep_y_yr(1:(tmax_qtr2/4))=LOG(data_sep_y_yr(1:(tmax_qtr2/4)))
            data_sep_p_yr(1:(tmax_qtr2/4))=LOG(data_sep_p_yr(1:(tmax_qtr2/4)))
            data_jf_y_yr(1:(tmax_qtr2/4))=LOG(data_jf_y_yr(1:(tmax_qtr2/4)))
            data_jf_p_yr(1:(tmax_qtr2/4))=LOG(data_jf_p_yr(1:(tmax_qtr2/4)))
            data_u_y_yr(1:(tmax_qtr2/4))=LOG(data_u_y_yr(1:(tmax_qtr2/4)))
            data_u_p_yr(1:(tmax_qtr2/4))=LOG(data_u_p_yr(1:(tmax_qtr2/4)))


! LOG THE SERIES (or not)
        data_uraw_qtr(1:tmax_qtr2)=data_u_qtr(1:tmax_qtr2)
        data_ulev_qtr(1:tmax_qtr2)=data_u_qtr(1:tmax_qtr2)
        !data_reall_qtr(:)=LOG(data_reall_qtr(:))



        !data_ult5wk_qtr(1:tmax_qtr2)=LOG(data_ult5wk_qtr(1:tmax_qtr2))
        !data_u5lt15wk_qtr(1:tmax_qtr2)=LOG(data_u5lt15wk_qtr(1:tmax_qtr2))
        !data_u15lt27wk_qtr(1:tmax_qtr2)=LOG(data_u15lt27wk_qtr(1:tmax_qtr2))
        !data_ugt27wk_qtr(1:tmax_qtr2)=LOG(data_ugt27wk_qtr(1:tmax_qtr2))

! initialize with original series
    data_ljf5_qtr(1:tmax_qtr2)=LOG(data_jf_qtr(1:tmax_qtr2))
    data_ljf5_young_qtr(1:tmax_qtr2)=LOG(data_jf_young_qtr(1:tmax_qtr2))
    data_ljf5_prime_qtr(1:tmax_qtr2)=LOG(data_jf_prime_qtr(1:tmax_qtr2))
    data_lpocc5_qtr(1:tmax_qtr2)=LOG(data_pocc_qtr(1:tmax_qtr2))
    data_lpnocc5_qtr(1:tmax_qtr2)=LOG(data_pnocc_qtr(1:tmax_qtr2))
    data_lv5_qtr(1:tmax_qtr2)=LOG(data_v_qtr(1:tmax_qtr2))
    data_lu5_qtr(1:tmax_qtr2)=LOG(data_u_qtr(1:tmax_qtr2))
    data_luall5_qtr(1:tmax_qtr2)=LOG(data_uall_qtr(1:tmax_qtr2))
    data_ltheta5_qtr(1:tmax_qtr2)=LOG(data_theta_qtr(1:tmax_qtr2))
    data_lprod5_qtr(1:tmax_qtr2)=LOG(data_prod_qtr(1:tmax_qtr2))
    data_lwage5_qtr(1:tmax_qtr2)=LOG(data_wage_qtr(1:tmax_qtr2))
    data_lsep5_qtr(1:tmax_qtr2)=LOG(data_sep_qtr(1:tmax_qtr2))
    !data_cocc_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_outflow_qtr(1:tmax_qtr2))
    !data_cocc_young_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_young_outflow_qtr(1:tmax_qtr2))
    !data_cocc_prime_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_prime_outflow_qtr(1:tmax_qtr2))

! smooth and take logs
DO tcnt=3, tmax_qtr2-2
    data_ljf5_qtr(tcnt)=LOG(sum(data_jf_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_ljf5_young_qtr(tcnt)=LOG(sum(data_jf_young_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_ljf5_prime_qtr(tcnt)=LOG(sum(data_jf_prime_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lpocc5_qtr(tcnt)=LOG(sum(data_pocc_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lpnocc5_qtr(tcnt)=LOG(sum(data_pnocc_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lv5_qtr(tcnt)=LOG(sum(data_v_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lu5_qtr(tcnt)=LOG(sum(data_u_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_luall5_qtr(tcnt)=LOG(sum(data_uall_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_ltheta5_qtr(tcnt)=LOG(sum(data_theta_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lprod5_qtr(tcnt)=LOG(sum(data_prod_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lwage5_qtr(tcnt)=LOG(sum(data_wage_qtr((tcnt-2):(tcnt+2)))/5.0_8)
    data_lsep5_qtr(tcnt)=LOG(sum(data_sep_qtr((tcnt-2):(tcnt+2)))/5.0_8)

    !! SMOOTH THE AGE PATTERNS 
    

END DO

data_sm5_ult3m_qtr=data_ult3m_qtr
data_sm5_ult5m_qtr=data_ult5m_qtr
data_sm5_ult9m_qtr=data_ult9m_qtr
data_sm5_ult13m_qtr=data_ult13m_qtr
data_sm5_ugt13m_qtr=data_ugt13m_qtr

DO t=3,tmax_qtr2-2
    data_sm5_ult3m_qtr(t)=(data_ult3m_qtr(t-2)+data_ult3m_qtr(t-1)+data_ult3m_qtr(t)+data_ult3m_qtr(t+1)+data_ult3m_qtr(t+2))/5.0
    data_sm5_ult5m_qtr(t)=(data_ult5m_qtr(t-2)+data_ult5m_qtr(t-1)+data_ult5m_qtr(t)+data_ult5m_qtr(t+1)+data_ult5m_qtr(t+2))/5.0
    data_sm5_ult9m_qtr(t)=(data_ult9m_qtr(t-2)+data_ult9m_qtr(t-1)+data_ult9m_qtr(t)+data_ult9m_qtr(t+1)+data_ult9m_qtr(t+2))/5.0
    data_sm5_ult13m_qtr(t)=(data_ult13m_qtr(t-2)+data_ult13m_qtr(t-1)+data_ult13m_qtr(t)+data_ult13m_qtr(t+1)+data_ult13m_qtr(t+2))/5.0
    data_sm5_ugt13m_qtr(t)=(data_ugt13m_qtr(t-2)+data_ugt13m_qtr(t-1)+data_ugt13m_qtr(t)+data_ugt13m_qtr(t+1)+data_ugt13m_qtr(t+2))/5.0
    END DO

!!! SMOOTH THE FOLLOWING AGE INDEXED TIME SERIES OR NOT
    
    !! if not smoothing, log them here, otherwise they are logged during smoothing 
        !data_u_young_qtr(1:tmax_qtr2)=LOG(data_u_young_qtr(1:tmax_qtr2))
        !data_u_prime_qtr(1:tmax_qtr2)=LOG(data_u_prime_qtr(1:tmax_qtr2))
        !data_lsep_y_qtr(1:tmax_qtr2)=LOG(data_sep_y_qtr(1:tmax_qtr2))
        !data_lsep_p_qtr(1:tmax_qtr2)=LOG(data_sep_p_qtr(1:tmax_qtr2))
        !data_cocc_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_outflow_qtr(1:tmax_qtr2))
        !data_cocc_young_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_young_outflow_qtr(1:tmax_qtr2))
        !data_cocc_prime_outflow_qtr(1:tmax_qtr2)=LOG(data_cocc_prime_outflow_qtr(1:tmax_qtr2))
        !data_ljf_young_qtr(1:tmax_qtr2)=LOG(data_jf_young_qtr(1:tmax_qtr2))
        !data_ljf_prime_qtr(1:tmax_qtr2)=LOG(data_jf_prime_qtr(1:tmax_qtr2))

        
    !data_u_young_qtr
data_temp_qtr3=data_u_young_qtr
data_u_young_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_u_young_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO

    !data_u_prime_qtr
data_temp_qtr3=data_u_prime_qtr
data_u_prime_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_u_prime_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO

    !data_sep_y_qtr
data_temp_qtr3=data_sep_y_qtr
data_sep_y_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_sep_y_qtr(tcnt)=sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8
END DO
    !data_lsep_y_qtr
data_temp_qtr3=data_sep_y_qtr
data_lsep_y_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lsep_y_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO
    !data_sep_p_qtr
data_temp_qtr3=data_sep_p_qtr
data_sep_p_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_sep_p_qtr(tcnt)=sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8
END DO
    !data_lsep_p_qtr
data_temp_qtr3=data_sep_p_qtr
data_lsep_p_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lsep_p_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO
    !data_cocc_young_outflow_qtr
data_temp_qtr3=data_cocc_young_outflow_qtr
data_cocc_young_outflow_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_cocc_young_outflow_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO
    !data_cocc_prime_outflow_qtr
data_temp_qtr3=data_cocc_prime_outflow_qtr
data_cocc_prime_outflow_qtr=0.0_8
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_cocc_prime_outflow_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO
    
!data_temp_qtr3=data_cocc_outflow_qtr
!data_lcocc_outflow5_qtr=0.0_8
!DO tcnt=3, tmax_qtr2-2
!    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
!END DO
!
!data_temp_qtr3=data_cocc_young_outflow_qtr
!data_lcocc_young_outflow5_qtr=0.0_8
!DO tcnt=3, tmax_qtr2-2
!    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_young_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
!END DO
!
!
!data_temp_qtr3=data_cocc_prime_outflow_qtr
!data_lcocc_prime_outflow5_qtr=0.0_8
!DO tcnt=3, tmax_qtr2-2
!    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_prime_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
!END DO


data_temp_qtr3(1:tmax_qtr2)=data_cocc_outflow_qtr(1:tmax_qtr2)
data_lcocc_outflow5_qtr(1:tmax_qtr2)=log(data_cocc_outflow_qtr(1:tmax_qtr2))
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
    END DO

data_temp_qtr3(1:tmax_qtr2)=data_cocc_young_outflow_qtr(1:tmax_qtr2)
data_lcocc_young_outflow5_qtr(1:tmax_qtr2)=log(data_cocc_young_outflow_qtr(1:tmax_qtr2))
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_young_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO

data_temp_qtr3(1:tmax_qtr2)=data_cocc_prime_outflow_qtr(1:tmax_qtr2)
data_lcocc_prime_outflow5_qtr(1:tmax_qtr2)=log(data_cocc_prime_outflow_qtr(1:tmax_qtr2))
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_lcocc_prime_outflow5_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO


        data_u_qtr(1:tmax_qtr2)=LOG(data_u_qtr(1:tmax_qtr2))
        data_v_qtr(1:tmax_qtr2)=LOG(data_v_qtr(1:tmax_qtr2))
        data_theta_qtr(1:tmax_qtr2)=LOG(data_theta_qtr(1:tmax_qtr2))
        data_lsep_qtr(1:tmax_qtr2)=LOG(data_sep_qtr(1:tmax_qtr2))
        DO occcnt=1, occpts
            data_supocc_lsep_qtr(occcnt,1:tmax_qtr2)=LOG(data_supocc_sep_qtr(occcnt,1:tmax_qtr2))
        END DO
        DO occcnt=1, occpts
            data_supocc_ludur_qtr(occcnt,1:tmax_qtr2)=LOG(data_supocc_udur_qtr(occcnt,1:tmax_qtr2))
        END DO
        data_ljf_qtr(1:tmax_qtr2)=LOG(data_jf_qtr(1:tmax_qtr2))

        data_lpocc_qtr(1:tmax_qtr2)=LOG(data_pocc_qtr(1:tmax_qtr2))
        data_lpnocc_qtr(1:tmax_qtr2)=LOG(data_pnocc_qtr(1:tmax_qtr2))


        data_wage_qtr(1:tmax_qtr2)=LOG(data_wage_qtr(1:tmax_qtr2))
        data_prod_qtr(1:tmax_qtr2)=LOG(data_prod_qtr(1:tmax_qtr2))


        
        data_cocc_inflow_qtr(1:tmax_qtr2)=LOG(data_cocc_inflow_qtr(1:tmax_qtr2))
        data_cocc_young_inflow_qtr(1:tmax_qtr2)=LOG(data_cocc_young_inflow_qtr(1:tmax_qtr2))
        data_cocc_prime_inflow_qtr(1:tmax_qtr2)=LOG(data_cocc_prime_inflow_qtr(1:tmax_qtr2))

        
        !
        !  OPEN(UNIT=21, file="original_quarterly_timeseries_sep.txt", status="replace", form="formatted")
        !WRITE(21,*) 'data_lsep5_qtr(tcnt), data_lsep_qtr(tcnt), data_sep_qtr(tcnt)'
        !DO tcnt=1, tmax_qtr2
        !    WRITE(21,*) data_lsep5_qtr(tcnt), data_lsep_qtr(tcnt), data_sep_qtr(tcnt)
        !END DO
        !CLOSE(21)
        !OPEN(UNIT=20, file="original_quarterly_timeseries_prod.txt", status="replace", form="formatted")
        !WRITE(20,*) 'data_lprod5_qtr(tcnt), data_lsep_qtr(tcnt), data_sep_qtr(tcnt)'
        !DO tcnt=1, tmax_qtr2
        !    WRITE(20,*) data_lprod5_qtr(tcnt), data_lprod_qtr(tcnt), data_prod_qtr(tcnt)
        !END DO
        !CLOSE(20)
        !OPEN(UNIT=24, file="original_quarterly_timeseries_reall.txt", status="replace", form="formatted")
        !WRITE(24,*) 'data_lcocc_outflow5_qtr, data_cocc_outflow_qtr'
        !DO tcnt=1, tmax_qtr2
        !    WRITE(24,*) data_lcocc_outflow5_qtr, data_cocc_outflow_qtr
        !END DO
        !CLOSE(24)

data_temp_qtr3(1:tmax_qtr2)=data_pocc_qtr(1:tmax_qtr2)
data_pocc_qtr(1:tmax_qtr2)=log(data_temp_qtr3(1:tmax_qtr2))
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_pocc_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
END DO

data_temp_qtr3(1:tmax_qtr2)=data_pnocc_qtr(1:tmax_qtr2)
data_pnocc_qtr(1:tmax_qtr2)=log(data_temp_qtr3(1:tmax_qtr2))
DO tcnt=3, tmax_qtr2-2
    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_pnocc_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
    END DO

!data_temp_qtr3=data_jf_qtr
!DO tcnt=3, tmax_qtr2-2
!    IF(sum(data_temp_qtr3(tcnt-2:tcnt+2))>0.0) data_jf_qtr(tcnt)=LOG(sum(data_temp_qtr3(tcnt-2:tcnt+2))/5.0_8)
!END DO



!!$OMP CRITICAL
!DEALLOCATE(data_temp_qtr3)
!!$OMP END CRITICAL

 !!$OMP MASTER
 !IF (verboseswitchfile==1) THEN
 !    OPEN(UNIT=21, file="quarterly_timeseries.txt", status="replace", form="formatted")
 !    WRITE(21,*) 'HP FILTERED ------------------------->'
 !    WRITE(21, FMT='(4(A15))', ADVANCE='NO') "time,", "hp_l_u,", "hp_l_v,", "hp_l_theta,"
 !    WRITE(21, FMT='(5(A15))', ADVANCE='NO') "hp_l_sep,", "hp_l_jf,", "hp_l_wage,", "hp_l_prod,", "hp_l_reall,"
 !    WRITE(21, FMT='(3(A15))', ADVANCE='NO') "log_u,", "log_v,", "log_theta,"
 !    WRITE(21, FMT='(5(A15))', ADVANCE='NO') "log_sep,", "log_jf,", "log_wage,", "log_prod,", "log_reall,"
 !    WRITE(21, FMT='(2(A15))') "log_jfocc,", "hp_l_jfocc,"
 !    DO t=1,tmax_qtr2-1
 !        WRITE(21, FMT='(I5,9X, A1, 3(F14.6, A1))', ADVANCE='NO') t, "," , data_u_qtr(t), ",", data_v_qtr(t), ",", data_theta_qtr(t), ","
 !        WRITE(21, FMT='(5(F14.6, A1))', ADVANCE='NO') data_lsep_qtr(t), ",", data_ljf_qtr(t), ",", 0.0_8, ",", data_prod_qtr(t), ",", data_cocc_inflow_qtr(t), ","
 !        WRITE(21, FMT='(1(A2))') ',-'
 !    END DO
 !    CLOSE(21)
 !END IF
 !!$OMP END MASTER

! HP FILTER IT

! prescott's HP Filter code
!C ----------------------------------------------------------------------
!C  SR: hpfilt
!C  Kalman smoothing routine for HP filter written by E Prescott.
!C   y=data series, d=deviations from trend, t=trend, n=no. obs,
!C   s=smoothing parameter (eg, 1600 for std HP).
!C   Array v is scratch area and must have dimension at least 3n.
!C   If IOPT=1 and n and s are the same as for the previous call,
!C   the numbers in v are not recomputed.  This reduces execution
!C   time by about 30 percent.  Note that if this option is exercised,
!C   v cannot be used for other purposes between calls.
!C   This version does NOT release the trend in order to save memory.
!C ----------------------------------------------------------------------

!$OMP CRITICAL


     counter1=tmax_qtr2
     counter2=tmax_mask_swindow_qtr


     !ALLOCATE(data_temp_qtr(counter1), data_temp_qtr2(counter1))

     IF(verbose_progress) WRITE(*,*) 'HP FILTERING PART'


     !     SUBROUTINE HPFILT(Y,D,V,N,S,IOPT)
    CALL HPFILT2(data_ulev_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ulev_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_u_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_u_qtr(1:counter1)=data_temp_qtr(1:counter1)
    !
    !WRITE(*,*) 'data_u_qtr'
    !DO i=1, counter1
    !    WRITE(*,*) data_u_qtr(i)
    !END DO

    CALL HPFILT2(data_v_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_v_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_theta_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_theta_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_sep_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sep_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_lsep_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lsep_qtr(1:counter1)=data_temp_qtr(1:counter1)

    DO occcnt=1, occpts
        CALL HPFILT2(data_supocc_sep_qtr(occcnt, 1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
        data_supocc_sep_qtr(occcnt, 1:counter1)=data_temp_qtr(1:counter1)

        CALL HPFILT2(data_supocc_lsep_qtr(occcnt, 1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
        data_supocc_lsep_qtr(occcnt, 1:counter1)=data_temp_qtr(1:counter1)

        !CALL HPFILT2(data_supocc_udur_qtr(occcnt, 1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
        !data_supocc_udur_qtr(occcnt, 1:counter1)=data_temp_qtr(1:counter1)

        !CALL HPFILT2(data_supocc_udur_qtr(occcnt, 1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
        !data_supocc_udur_qtr(occcnt, 1:counter1)=data_temp_qtr(1:counter1)
    END DO


    CALL HPFILT2(data_jf_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_jf_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_ljf_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ljf_qtr(1:counter1)=data_temp_qtr(1:counter1)

!    CALL HPFILT2(data_wage_qtr,data_temp_qtr,tmax_qtr2-1,hpfilterfactor,0)
!    data_u_qtr=data_temp_qtr

    CALL HPFILT2(data_prod_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_prod_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_wage_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_wage_qtr(1:counter1)=data_temp_qtr(1:counter1)


!    CALL HPFILT2(data_reall_qtr,data_temp_qtr,tmax_qtr2-1,hpfilterfactor,0)
!    data_u_qtr=data_temp_qtr


     !     SUBROUTINE HPFILT(Y,D,V,N,S,IOPT)
        ! young unemployment
    CALL HPFILT2(data_u_young_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_u_young_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime unemployment
    CALL HPFILT2(data_u_prime_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_u_prime_qtr(1:counter1)=data_temp_qtr(1:counter1)
            ! young job finding
    CALL HPFILT2(data_jf_young_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_jf_young_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime job finding
    CALL HPFILT2(data_jf_prime_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_jf_prime_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! young log job finding
    CALL HPFILT2(data_jf_young_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_jf_young_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime log job finding
    CALL HPFILT2(data_ljf_prime_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ljf_prime_qtr(1:counter1)=data_temp_qtr(1:counter1)

        ! young separation
    CALL HPFILT2(data_sep_y_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sep_y_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime separation
    CALL HPFILT2(data_sep_p_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sep_p_qtr(1:counter1)=data_temp_qtr(1:counter1)
            ! young separation
    CALL HPFILT2(data_lsep_y_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lsep_y_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime separation
    CALL HPFILT2(data_lsep_p_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lsep_p_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_cocc_inflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_inflow_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! young reallocation composition
    CALL HPFILT2(data_cocc_young_inflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_young_inflow_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime reallocation composition
    CALL HPFILT2(data_cocc_prime_inflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_prime_inflow_qtr(1:counter1)=data_temp_qtr(1:counter1)


    CALL HPFILT2(data_cocc_outflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_outflow_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! young reallocation composition
    CALL HPFILT2(data_cocc_young_outflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_young_outflow_qtr(1:counter1)=data_temp_qtr(1:counter1)
        ! prime reallocation composition
    CALL HPFILT2(data_cocc_prime_outflow_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_cocc_prime_outflow_qtr(1:counter1)=data_temp_qtr(1:counter1)


    !jfocc
    CALL HPFILT2(data_pocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_pocc_qtr(1:counter1)=data_temp_qtr(1:counter1)
    !jfnocc
    CALL HPFILT2(data_pnocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_pnocc_qtr(1:counter1)=data_temp_qtr(1:counter1)
    !log jfocc
    CALL HPFILT2(data_lpocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lpocc_qtr(1:counter1)=data_temp_qtr(1:counter1)
    !log jfnocc
    CALL HPFILT2(data_lpnocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lpnocc_qtr(1:counter1)=data_temp_qtr(1:counter1)

    ! PROPORTIONS UNEMPLOYMENT POOL: BLS
    ! U LESS THAN 5 WKS
    CALL HPFILT2(data_ult5wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult5wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5 and 15
    CALL HPFILT2(data_u5lt15wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_u5lt15wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 15 and 27
    CALL HPFILT2(data_u15lt27wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_u15lt27wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5 and 15
    CALL HPFILT2(data_ugt27wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ugt27wk_qtr(1:counter1)=data_temp_qtr(1:counter1)


    ! PROPORTIONS UNEMPLOYMENT POOL: BLS LOGGED
    ! U LESS THAN 5 WKS
    CALL HPFILT2(data_l_ult5wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult5wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5 and 15
    CALL HPFILT2(data_l_u5lt15wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_u5lt15wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 15 and 27
    CALL HPFILT2(data_l_u15lt27wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_u15lt27wk_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5 and 15
    CALL HPFILT2(data_l_ugt27wk_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ugt27wk_qtr(1:counter1)=data_temp_qtr(1:counter1)

    ! PROPORTIONS UNEMPLOYMENT POOL: SIPP
    !!-- ALL
    ! U LESS THAN 3 months
    CALL HPFILT2(data_ult3m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult3m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 1-4
    CALL HPFILT2(data_ult5m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult5m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-9
    CALL HPFILT2(data_ult9m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult9m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12
    CALL HPFILT2(data_ult13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult13m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 13-18
    CALL HPFILT2(data_ugt13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ugt13m_qtr(1:counter1)=data_temp_qtr(1:counter1)

    ! SMOOTHED VERSION
    CALL HPFILT2(data_sm5_ult3m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sm5_ult3m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 1-4
    CALL HPFILT2(data_sm5_ult5m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sm5_ult5m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-9
    CALL HPFILT2(data_sm5_ult9m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sm5_ult9m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12
    CALL HPFILT2(data_sm5_ult13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sm5_ult13m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 13-18
    CALL HPFILT2(data_sm5_ugt13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_sm5_ugt13m_qtr(1:counter1)=data_temp_qtr(1:counter1)

    !! LOGGED PROPORTIONS UNEMPLOYMENT POOL: SIPP LOG
    ! U LESS 3 MONTHS
    CALL HPFILT2(data_l_ult3m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult3m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN <5m
    CALL HPFILT2(data_l_ult5m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult5m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-8
    CALL HPFILT2(data_l_ult9m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult9m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12m
    CALL HPFILT2(data_l_ult13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult13m_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U 13-18m
    CALL HPFILT2(data_l_ugt13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ugt13m_qtr(1:counter1)=data_temp_qtr(1:counter1)

    !!-- YNG
    ! U LESS THAN 3 months
    CALL HPFILT2(data_ult3m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult3m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 1-4
    CALL HPFILT2(data_ult5m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult5m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-9
    CALL HPFILT2(data_ult9m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult9m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12
    CALL HPFILT2(data_ult13m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult13m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 13-18
    CALL HPFILT2(data_ugt13m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ugt13m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)


    ! LOGGED PROPORTIONS UNEMPLOYMENT POOL: SIPP LOG
    ! U LESS 3 MONTHS
    CALL HPFILT2(data_l_ult3m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult3m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN <5m
    CALL HPFILT2(data_l_ult5m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult5m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-8
    CALL HPFILT2(data_l_ult9m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult9m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12m
    CALL HPFILT2(data_l_ult13m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult13m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U 13-18m
    CALL HPFILT2(data_l_ugt13m_yng_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ugt13m_yng_qtr(1:counter1)=data_temp_qtr(1:counter1)

    !!-- PRIME
    ! U LESS THAN 3 months
    CALL HPFILT2(data_ult3m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult3m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 1-4
    CALL HPFILT2(data_ult5m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult5m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-9
    CALL HPFILT2(data_ult9m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult9m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12
    CALL HPFILT2(data_ult13m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ult13m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 13-18
    CALL HPFILT2(data_ugt13m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ugt13m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)


    ! LOGGED PROPORTIONS UNEMPLOYMENT POOL: SIPP LOG
    ! U LESS 3 MONTHS
    CALL HPFILT2(data_l_ult3m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult3m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN <5m
    CALL HPFILT2(data_l_ult5m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult5m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 5-8
    CALL HPFILT2(data_l_ult9m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult9m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U BETWEEN 9-12m
    CALL HPFILT2(data_l_ult13m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ult13m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)
    ! U 13-18m
    CALL HPFILT2(data_l_ugt13m_prm_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_l_ugt13m_prm_qtr(1:counter1)=data_temp_qtr(1:counter1)




    ! smoothed job finding/u/v/theta/prod/wage/sep/cocc_outflow series


                ! CAREFUL WITH THE INDICES: COUNTER1 seems to go to e.g. 1160, but the size of the vector in is 4 less
    CALL HPFILT2(data_ljf5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ljf5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_ljf5_young_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ljf5_young_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_ljf5_prime_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ljf5_prime_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lpocc5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lpocc5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lpnocc5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lpnocc5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lv5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lv5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lu5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lu5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_luall5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_luall5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_ltheta5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ltheta5_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_lsep5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lsep5_qtr(1:counter1)=data_temp_qtr(1:counter1)
        !OPEN(UNIT=23, file="hp_quarterly_timeseries.txt", status="replace", form="formatted")
        !WRITE(23,*) 'data_lsep5_qtr(tcnt), data_lsep_qtr(tcnt), data_sep_qtr(tcnt)'
        !DO tcnt=1, counter1
        !    WRITE(23,*) data_lsep5_qtr(tcnt), data_lsep_qtr(tcnt), data_sep_qtr(tcnt)
        !END DO
        !CLOSE(23)

    CALL HPFILT2(data_lwage5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lwage5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lprod5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lprod5_qtr(1:counter1)=data_temp_qtr(1:counter1)

    CALL HPFILT2(data_lcocc_outflow5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lcocc_outflow5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lcocc_young_outflow5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lcocc_young_outflow5_qtr(1:counter1)=data_temp_qtr(1:counter1)
    CALL HPFILT2(data_lcocc_prime_outflow5_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_lcocc_prime_outflow5_qtr(1:counter1)=data_temp_qtr(1:counter1)


    ! duration
    CALL HPFILT2(data_ucompldur_occ_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_occ_qtr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_ucompldur_young_occ_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_young_occ_qtr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_ucompldur_prime_occ_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_prime_occ_qtr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_ucompldur_nocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_nocc_qtr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_ucompldur_young_nocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_young_nocc_qtr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_ucompldur_prime_nocc_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    data_ucompldur_prime_nocc_qtr(1:counter1)=data_temp_qtr(1:counter1)


    !! YEARLY SERIES, ANDY MUELLER MOMENTS, HP FILTER with FACTOR 100
    counter1=tmax_qtr2/4
    counter2=tmax_mask_swindow_qtr/4

   CALL HPFILT2(data_u_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_u_yr(1:counter1)=data_temp_qtr(1:counter1)



   CALL HPFILT2(data_sep_y_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_sep_y_yr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_sep_p_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_sep_p_yr(1:counter1)=data_temp_qtr(1:counter1)

    !WRITE(*,*) 'i, data_u_yr(i), data_sep_y_yr(i), data_sep_p_yr(i)'
    !DO i=1, counter1
    !    WRITE(*,FMT='(I4,A1, E10.4, A1, E10.4, A1, E10.4)') i, ',', data_u_yr(i), ',', data_sep_y_yr(i), ',', data_sep_p_yr(i)
    !END DO
    !

    CALL HPFILT2(data_jf_y_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_jf_y_yr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_jf_p_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_jf_p_yr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_u_y_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_u_y_yr(1:counter1)=data_temp_qtr(1:counter1)
   CALL HPFILT2(data_u_p_yr(1:counter1),data_temp_qtr, counter2, counter1,100.0_8,0)
    data_u_p_yr(1:counter1)=data_temp_qtr(1:counter1)



    !DEALLOCATE(data_temp_qtr,data_temp_qtr2)

    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr

IF(verbose_progress) WRITE(*,*) 'FINISHED HP FILTERING PART'
!$OMP END CRITICAL


!============================================================
! top ISOLATE TOP/BOTTOM 33%, BOTTOM 50%, exclude ends of HP filtered time series
!============================================================

counter1=tmax_qtr2

  !! can make sure we are well within the superwindow each time. now simply the entire series (Except for and last boundary)
hpu_p33=quantile((33*counter1)/100, data_u_qtr(13:counter1-12))
hpu_p50=quantile((50*counter1)/100, data_u_qtr(13:counter1-12))
hpu_p67=quantile((67*counter1)/100, data_u_qtr(13:counter1-12))

!IF(verboseswitch==1) WRITE(*,*) 'HP U percentile cutoffs: p33, p50, p67', hpu_p33, hpu_p50, hpu_p67
IF(verbose_results_l0==1 .OR. verbose_netmob_solve) WRITE(*,*) 'HP U percentile cutoffs: p33, p50, p67', hpu_p33, hpu_p50, hpu_p67
data_u_qtr_p33=0.0_8
data_u_qtr_p50=0.0_8
data_u_qtr_p67=0.0_8

DO pcnt=13,counter1
    IF(data_u_qtr(pcnt)<=hpu_p33) data_u_qtr_p33(pcnt)=1.0_8
    IF(data_u_qtr(pcnt)<=hpu_p50) data_u_qtr_p50(pcnt)=1.0_8
    IF(data_u_qtr(pcnt)>hpu_p67) data_u_qtr_p67(pcnt)=1.0_8
END DO


            ! Calculate innerproduct
                    !result = MATMUL (matrix_a,matrix_b); If matrix_a has shape (m) and matrix_b has shape (m, k), the result is a rank-one array with shape (k)
!WRITE(*,*) data_totduration_cocc_qtr(counter1/2,:)
!WRITE(*,*) 'tot_durationmatrix_cocc', tot_durationmatrix_cocc



!-----------
! ALL, UNCORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cocc_p50(zcnt)=tot_durationmatrix_cocc_p50(zcnt)+data_totduration_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_p50(zcnt)=tot_durationmatrix_nocc_p50(zcnt)+data_totduration_nocc_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<=hpu_p33 ) THEN
            tot_durationmatrix_cocc_p33(zcnt)=tot_durationmatrix_cocc_p33(zcnt)+data_totduration_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_p33(zcnt)=tot_durationmatrix_nocc_p33(zcnt)+data_totduration_nocc_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cocc_p67(zcnt)=tot_durationmatrix_cocc_p67(zcnt)+data_totduration_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_p67(zcnt)=tot_durationmatrix_nocc_p67(zcnt)+data_totduration_nocc_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=REAL(tot_durationmatrix_cocc_p67(zcnt)+tot_durationmatrix_nocc_p67(zcnt))
IF(tempreal>0.0_8) tot_durationmatrix_cocc_p67(zcnt)=tot_durationmatrix_cocc_p67(zcnt)/tempreal
tempreal=REAL(tot_durationmatrix_cocc_p50(zcnt)+tot_durationmatrix_nocc_p50(zcnt))
IF(tempreal>0.0_8) tot_durationmatrix_cocc_p50(zcnt)=tot_durationmatrix_cocc_p50(zcnt)/tempreal
tempreal=REAL(tot_durationmatrix_cocc_p33(zcnt)+tot_durationmatrix_nocc_p33(zcnt))
IF(tempreal>0.0_8) tot_durationmatrix_cocc_p33(zcnt)=tot_durationmatrix_cocc_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_nocc_p67(1))
    tempreal2=REAL(tot_durationmatrix_nocc_p50(1))
    tempreal3=REAL(tot_durationmatrix_nocc_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_nocc_p67(zcnt)=tot_durationmatrix_nocc_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_nocc_p50(zcnt)=tot_durationmatrix_nocc_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_nocc_p33(zcnt)=tot_durationmatrix_nocc_p33(zcnt)/tempreal3
END IF

    END DO  ! zcnt loop over incomplete unemployment duration

! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_nocc_p67(1)=1.0_8
!tot_durationmatrix_nocc_p50(1)=1.0_8
!tot_durationmatrix_nocc_p33(1)=1.0_8



!-----------
! ALL, CORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cr_cocc_p50(zcnt)=tot_durationmatrix_cr_cocc_p50(zcnt)+data_totduration_cr_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_p50(zcnt)=tot_durationmatrix_cr_nocc_p50(zcnt)+data_totduration_cr_nocc_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<hpu_p33 ) THEN
            tot_durationmatrix_cr_cocc_p33(zcnt)=tot_durationmatrix_cr_cocc_p33(zcnt)+data_totduration_cr_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_p33(zcnt)=tot_durationmatrix_cr_nocc_p33(zcnt)+data_totduration_cr_nocc_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cr_cocc_p67(zcnt)=tot_durationmatrix_cr_cocc_p67(zcnt)+data_totduration_cr_cocc_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_p67(zcnt)=tot_durationmatrix_cr_nocc_p67(zcnt)+data_totduration_cr_nocc_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=tot_durationmatrix_cr_cocc_p67(zcnt)+tot_durationmatrix_cr_nocc_p67(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_p67(zcnt)=tot_durationmatrix_cr_cocc_p67(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_p50(zcnt)+tot_durationmatrix_cr_nocc_p50(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_p50(zcnt)=tot_durationmatrix_cr_cocc_p50(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_p33(zcnt)+tot_durationmatrix_cr_nocc_p33(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_p33(zcnt)=tot_durationmatrix_cr_cocc_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_cr_nocc_p67(1))
    tempreal2=REAL(tot_durationmatrix_cr_nocc_p50(1))
    tempreal3=REAL(tot_durationmatrix_cr_nocc_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_cr_nocc_p67(zcnt)=tot_durationmatrix_cr_nocc_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_cr_nocc_p50(zcnt)=tot_durationmatrix_cr_nocc_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_cr_nocc_p33(zcnt)=tot_durationmatrix_cr_nocc_p33(zcnt)/tempreal3
END IF
    END DO
! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_cr_nocc_p67(1)=1.0_8
!tot_durationmatrix_cr_nocc_p50(1)=1.0_8
!tot_durationmatrix_cr_nocc_p33(1)=1.0_8





!-----------
! YOUNG, UNCORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cocc_young_p50(zcnt)=tot_durationmatrix_cocc_young_p50(zcnt)+data_totduration_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_young_p50(zcnt)=tot_durationmatrix_nocc_young_p50(zcnt)+data_totduration_nocc_young_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<hpu_p33 ) THEN
            tot_durationmatrix_cocc_young_p33(zcnt)=tot_durationmatrix_cocc_young_p33(zcnt)+data_totduration_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_young_p33(zcnt)=tot_durationmatrix_nocc_young_p33(zcnt)+data_totduration_nocc_young_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cocc_young_p67(zcnt)=tot_durationmatrix_cocc_young_p67(zcnt)+data_totduration_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_young_p67(zcnt)=tot_durationmatrix_nocc_young_p67(zcnt)+data_totduration_nocc_young_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=tot_durationmatrix_cocc_young_p67(zcnt)+tot_durationmatrix_nocc_young_p67(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_young_p67(zcnt)=tot_durationmatrix_cocc_young_p67(zcnt)/tempreal
tempreal=tot_durationmatrix_cocc_young_p50(zcnt)+tot_durationmatrix_nocc_young_p50(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_young_p50(zcnt)=tot_durationmatrix_cocc_young_p50(zcnt)/tempreal
tempreal=tot_durationmatrix_cocc_young_p33(zcnt)+tot_durationmatrix_nocc_young_p33(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_young_p33(zcnt)=tot_durationmatrix_cocc_young_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_nocc_young_p67(1))
    tempreal2=REAL(tot_durationmatrix_nocc_young_p50(1))
    tempreal3=REAL(tot_durationmatrix_nocc_young_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_nocc_young_p67(zcnt)=tot_durationmatrix_nocc_young_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_nocc_young_p50(zcnt)=tot_durationmatrix_nocc_young_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_nocc_young_p33(zcnt)=tot_durationmatrix_nocc_young_p33(zcnt)/tempreal3
END IF
    END DO
! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_nocc_young_p67(1)=1.0_8
!tot_durationmatrix_nocc_young_p50(1)=1.0_8
!tot_durationmatrix_nocc_young_p33(1)=1.0_8

!-----------
! YOUNG, CORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cr_cocc_young_p50(zcnt)=tot_durationmatrix_cr_cocc_young_p50(zcnt)+data_totduration_cr_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_young_p50(zcnt)=tot_durationmatrix_cr_nocc_young_p50(zcnt)+data_totduration_cr_nocc_young_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<hpu_p33 ) THEN
            tot_durationmatrix_cr_cocc_young_p33(zcnt)=tot_durationmatrix_cr_cocc_young_p33(zcnt)+data_totduration_cr_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_young_p33(zcnt)=tot_durationmatrix_cr_nocc_young_p33(zcnt)+data_totduration_cr_nocc_young_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cr_cocc_young_p67(zcnt)=tot_durationmatrix_cr_cocc_young_p67(zcnt)+data_totduration_cr_cocc_young_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_young_p67(zcnt)=tot_durationmatrix_cr_nocc_young_p67(zcnt)+data_totduration_cr_nocc_young_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=tot_durationmatrix_cr_cocc_young_p67(zcnt)+tot_durationmatrix_cr_nocc_young_p67(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_young_p67(zcnt)=tot_durationmatrix_cr_cocc_young_p67(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_young_p50(zcnt)+tot_durationmatrix_cr_nocc_young_p50(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_young_p50(zcnt)=tot_durationmatrix_cr_cocc_young_p50(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_young_p33(zcnt)+tot_durationmatrix_cr_nocc_young_p33(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_young_p33(zcnt)=tot_durationmatrix_cr_cocc_young_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_cr_nocc_young_p67(1))
    tempreal2=REAL(tot_durationmatrix_cr_nocc_young_p50(1))
    tempreal3=REAL(tot_durationmatrix_cr_nocc_young_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_cr_nocc_young_p67(zcnt)=tot_durationmatrix_cr_nocc_young_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_cr_nocc_young_p50(zcnt)=tot_durationmatrix_cr_nocc_young_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_cr_nocc_young_p33(zcnt)=tot_durationmatrix_cr_nocc_young_p33(zcnt)/tempreal3
END IF
    END DO
! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_cr_nocc_young_p67(1)=1.0_8
!tot_durationmatrix_cr_nocc_young_p50(1)=1.0_8
!tot_durationmatrix_cr_nocc_young_p33(1)=1.0_8




!-----------
! PRIME, UNCORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cocc_prime_p50(zcnt)=tot_durationmatrix_cocc_prime_p50(zcnt)+data_totduration_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_prime_p50(zcnt)=tot_durationmatrix_nocc_prime_p50(zcnt)+data_totduration_nocc_prime_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<hpu_p33 ) THEN
            tot_durationmatrix_cocc_prime_p33(zcnt)=tot_durationmatrix_cocc_prime_p33(zcnt)+data_totduration_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_prime_p33(zcnt)=tot_durationmatrix_nocc_prime_p33(zcnt)+data_totduration_nocc_prime_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cocc_prime_p67(zcnt)=tot_durationmatrix_cocc_prime_p67(zcnt)+data_totduration_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_nocc_prime_p67(zcnt)=tot_durationmatrix_nocc_prime_p67(zcnt)+data_totduration_nocc_prime_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=tot_durationmatrix_cocc_prime_p67(zcnt)+tot_durationmatrix_nocc_prime_p67(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_prime_p67(zcnt)=tot_durationmatrix_cocc_prime_p67(zcnt)/tempreal
tempreal=tot_durationmatrix_cocc_prime_p50(zcnt)+tot_durationmatrix_nocc_prime_p50(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_prime_p50(zcnt)=tot_durationmatrix_cocc_prime_p50(zcnt)/tempreal
tempreal=tot_durationmatrix_cocc_prime_p33(zcnt)+tot_durationmatrix_nocc_prime_p33(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cocc_prime_p33(zcnt)=tot_durationmatrix_cocc_prime_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_nocc_prime_p67(1))
    tempreal2=REAL(tot_durationmatrix_nocc_prime_p50(1))
    tempreal3=REAL(tot_durationmatrix_nocc_prime_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_nocc_prime_p67(zcnt)=tot_durationmatrix_nocc_prime_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_nocc_prime_p50(zcnt)=tot_durationmatrix_nocc_prime_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_nocc_prime_p33(zcnt)=tot_durationmatrix_nocc_prime_p33(zcnt)/tempreal3
END IF
    END DO
! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_nocc_prime_p67(1)=1.0_8
!tot_durationmatrix_nocc_prime_p50(1)=1.0_8
!tot_durationmatrix_nocc_prime_p33(1)=1.0_8

!-----------
! PRIME, CORRECTED
!-----------
DO zcnt=1, 18
z2cnt=0
p2cnt=0
x2cnt=0
DO pcnt=1, counter1

     IF(data_u_qtr(pcnt)<=hpu_p50 ) THEN
            tot_durationmatrix_cr_cocc_prime_p50(zcnt)=tot_durationmatrix_cr_cocc_prime_p50(zcnt)+data_totduration_cr_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_prime_p50(zcnt)=tot_durationmatrix_cr_nocc_prime_p50(zcnt)+data_totduration_cr_nocc_prime_qtr(pcnt,zcnt)
            x2cnt=x2cnt+1
     END IF

     IF(data_u_qtr(pcnt)<hpu_p33 ) THEN
            tot_durationmatrix_cr_cocc_prime_p33(zcnt)=tot_durationmatrix_cr_cocc_prime_p33(zcnt)+data_totduration_cr_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_prime_p33(zcnt)=tot_durationmatrix_cr_nocc_prime_p33(zcnt)+data_totduration_cr_nocc_prime_qtr(pcnt,zcnt)
            p2cnt=p2cnt+1
     END IF


    IF (data_u_qtr(pcnt)>=hpu_p67) THEN
        tot_durationmatrix_cr_cocc_prime_p67(zcnt)=tot_durationmatrix_cr_cocc_prime_p67(zcnt)+data_totduration_cr_cocc_prime_qtr(pcnt,zcnt)
            tot_durationmatrix_cr_nocc_prime_p67(zcnt)=tot_durationmatrix_cr_nocc_prime_p67(zcnt)+data_totduration_cr_nocc_prime_qtr(pcnt,zcnt)
            z2cnt=z2cnt+1
    END IF

END DO
tempreal=tot_durationmatrix_cr_cocc_prime_p67(zcnt)+tot_durationmatrix_cr_nocc_prime_p67(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_prime_p67(zcnt)=tot_durationmatrix_cr_cocc_prime_p67(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_prime_p50(zcnt)+tot_durationmatrix_cr_nocc_prime_p50(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_prime_p50(zcnt)=tot_durationmatrix_cr_cocc_prime_p50(zcnt)/tempreal
tempreal=tot_durationmatrix_cr_cocc_prime_p33(zcnt)+tot_durationmatrix_cr_nocc_prime_p33(zcnt)
IF(tempreal>0.0_8) tot_durationmatrix_cr_cocc_prime_p33(zcnt)=tot_durationmatrix_cr_cocc_prime_p33(zcnt)/tempreal

IF(zcnt>1) THEN
    tempreal=REAL(tot_durationmatrix_cr_nocc_prime_p67(1))
    tempreal2=REAL(tot_durationmatrix_cr_nocc_prime_p50(1))
    tempreal3=REAL(tot_durationmatrix_cr_nocc_prime_p33(1))
    IF(tempreal>0.0_8) tot_durationmatrix_cr_nocc_prime_p67(zcnt)=tot_durationmatrix_cr_nocc_prime_p67(zcnt)/tempreal
    IF(tempreal2>0.0_8) tot_durationmatrix_cr_nocc_prime_p50(zcnt)=tot_durationmatrix_cr_nocc_prime_p50(zcnt)/tempreal2
    IF(tempreal3>0.0_8) tot_durationmatrix_cr_nocc_prime_p33(zcnt)=tot_durationmatrix_cr_nocc_prime_p33(zcnt)/tempreal3
END IF
    END DO
! FIRST ELEMENT: either normalize to zero, or keep as the total number of observations?
!tot_durationmatrix_cr_nocc_prime_p67(1)=1.0_8
!tot_durationmatrix_cr_nocc_prime_p50(1)=1.0_8
!tot_durationmatrix_cr_nocc_prime_p33(1)=1.0_8


            !tot_durationmatrix_nocc_p33/50/67 should collect the number of spells observed

!WRITE(*,*) '------------------------------'
!WRITE(*,*) 'tot_durationmatrix_cocc_p33'
!WRITE(*,*) tot_durationmatrix_cocc_p33

!WRITE(*,*)  'tot_durationmatrix_cocc_p67'
!WRITE(*,*)  tot_durationmatrix_cocc_p67
!WRITE(*,*) '------------------------------'

profileshift_shortdur=0.0_8
tempreal=0.0_8
tempreal2=0.0_8
do tcnt=1,6
    tempreal=tempreal+tot_durationmatrix_cocc_p33(tcnt)
    tempreal2=tempreal2+tot_durationmatrix_cocc_p67(tcnt)
end do

IF (tempreal2>0.0_8) profileshift_shortdur=tempreal/tempreal2

profileshift_shortdur=0.0_8
tempreal=0.0_8
tempreal2=0.0_8
do tcnt=7,12
    tempreal=tempreal+tot_durationmatrix_cocc_p33(tcnt)
    IF(tcnt>9) tempreal2=tempreal2+tot_durationmatrix_cocc_p67(tcnt)
end do
    tempreal=tempreal/3.0_8
    tempreal2=tempreal2/6.0_8
IF (tempreal2>0.0_8) profileshift_longdur=tempreal/tempreal2


!================================================================
!   ENTRY VS MOBILITY
!=================================================================


occdistr_exo_entry_exit_goodp50=0.0
corr_occdistr_exo_entry_exit_goodp50=0.0 
occdistr_endo_entry_exit_goodp50=0.0
corr_occdistr_endo_entry_exit_goodp50=0.0

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<hpu_p50 ) THEN
        DO occcnt=1, occpts
        DO xcnt=1, 2
                occdistr_exo_entry_exit_goodp50(occcnt, xcnt)=occdistr_exo_entry_exit_goodp50(occcnt, xcnt)+occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_exo_entry_exit_goodp50(occcnt, xcnt)=corr_occdistr_exo_entry_exit_goodp50(occcnt, xcnt)+corr_occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                occdistr_endo_entry_exit_goodp50(occcnt, xcnt)=occdistr_endo_entry_exit_goodp50(occcnt, xcnt)+occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_endo_entry_exit_goodp50(occcnt, xcnt)=corr_occdistr_endo_entry_exit_goodp50(occcnt, xcnt)+corr_occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
        END DO 
        END DO 
    END IF
END DO


occdistr_exo_entry_exit_badp50=0.0
corr_occdistr_exo_entry_exit_badp50=0.0 
occdistr_endo_entry_exit_badp50=0.0
corr_occdistr_endo_entry_exit_badp50=0.0

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)>=hpu_p50 ) THEN
        DO occcnt=1, occpts
        DO xcnt=1, 2
                occdistr_exo_entry_exit_badp50(occcnt, xcnt)=occdistr_exo_entry_exit_badp50(occcnt, xcnt)+occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_exo_entry_exit_badp50(occcnt, xcnt)=corr_occdistr_exo_entry_exit_badp50(occcnt, xcnt)+corr_occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                occdistr_endo_entry_exit_badp50(occcnt, xcnt)=occdistr_endo_entry_exit_badp50(occcnt, xcnt)+occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_endo_entry_exit_badp50(occcnt, xcnt)=corr_occdistr_endo_entry_exit_badp50(occcnt, xcnt)+corr_occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
        END DO 
        END DO 
    END IF
    END DO

!! CHECK 

occdistr_exo_entry_exit2=0.0
corr_occdistr_exo_entry_exit2=0.0 
occdistr_endo_entry_exit2=0.0
corr_occdistr_endo_entry_exit2=0.0

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<hpu_p50 .OR. data_u_qtr(tcnt)>=hpu_p50 ) THEN
        DO occcnt=1, occpts
        DO xcnt=1, 2
                occdistr_exo_entry_exit2(occcnt, xcnt)=occdistr_exo_entry_exit2(occcnt, xcnt)+occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_exo_entry_exit2(occcnt, xcnt)=corr_occdistr_exo_entry_exit2(occcnt, xcnt)+corr_occdistr_exo_entry_exit_qtr(occcnt, xcnt, tcnt)
                occdistr_endo_entry_exit2(occcnt, xcnt)=occdistr_endo_entry_exit2(occcnt, xcnt)+occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
                corr_occdistr_endo_entry_exit2(occcnt, xcnt)=corr_occdistr_endo_entry_exit2(occcnt, xcnt)+corr_occdistr_endo_entry_exit_qtr(occcnt, xcnt, tcnt)
        END DO 
        END DO 
    END IF
END DO
    
!=============================================================
!  NET MOBILITY OVER THE CYCLE
!=============================================================


!! P50 BELOW MEDIAN LOG HP FILTERED UNEMPLOYMENT
data_superocc_temptransmatrix=0.0_8
DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<hpu_p50 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
END DO

data_superocc_transmatrix_p50=data_superocc_temptransmatrix


! reset
data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<hpu_p50 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_corr_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
    END DO

data_corr_superocc_transmatrix_p50=data_superocc_temptransmatrix

! reset
data_superocc_temptransmatrix=0.0_8

CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p50, netmob_calc_vector_p50)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p50, grossmob_calc_vector_p50)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50, corr_netmob_calc_vector_p50)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50, corr_grossmob_calc_vector_p50)


    overall_netmob_p50=sum(abs(netmob_calc_vector_p50))/2.0
    overall_grossmob_p50=sum(abs(grossmob_calc_vector_p50))
    overall_xsmob_p50=overall_grossmob_p50-overall_netmob_p50

    overall_corr_netmob_p50=sum(abs(corr_netmob_calc_vector_p50))/2.0
    overall_corr_grossmob_p50=sum(abs(corr_grossmob_calc_vector_p50))
    overall_corr_xsmob_p50=overall_corr_grossmob_p50-overall_corr_netmob_p50

    !! DATA COUNTER PART


    CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p50_data, netmob_calc_vector_p50_data)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p50_data, grossmob_calc_vector_p50_data)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50_data, corr_netmob_calc_vector_p50_data)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50_data, corr_grossmob_calc_vector_p50_data)


    overall_netmob_p50_data=sum(abs(netmob_calc_vector_p50_data))/2.0
    overall_grossmob_p50_data=sum(abs(grossmob_calc_vector_p50_data))
    overall_xsmob_p50_data=overall_grossmob_p50_data-overall_netmob_p50_data

    overall_corr_netmob_p50_data=sum(abs(corr_netmob_calc_vector_p50_data))/2.0
    overall_corr_grossmob_p50_data=sum(abs(corr_grossmob_calc_vector_p50_data))
    overall_corr_xsmob_p50_data=overall_corr_grossmob_p50_data-overall_corr_netmob_p50_data



!! 33 percent **LOWEST** LHPF unemployment rates

data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<=hpu_p33 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
END DO

data_superocc_transmatrix_p33=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<=hpu_p33 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_corr_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
END DO

data_corr_superocc_transmatrix_p33=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

    CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p33, netmob_calc_vector_p33)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p33, grossmob_calc_vector_p33)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p33, corr_netmob_calc_vector_p33)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p33, corr_grossmob_calc_vector_p33)


    overall_netmob_p33=sum(abs(netmob_calc_vector_p33))/2.0
    overall_grossmob_p33=sum(abs(grossmob_calc_vector_p33))
    overall_xsmob_p33=overall_grossmob_p33-overall_netmob_p33

    overall_corr_netmob_p33=sum(abs(corr_netmob_calc_vector_p33))/2.0
    overall_corr_grossmob_p33=sum(abs(corr_grossmob_calc_vector_p33))
    overall_corr_xsmob_p33=overall_corr_grossmob_p33-overall_corr_netmob_p33


!! DATA COUNTER PART


    CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p33_data, netmob_calc_vector_p33_data)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p33_data, grossmob_calc_vector_p33_data)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p33_data, corr_netmob_calc_vector_p33_data)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p33_data, corr_grossmob_calc_vector_p33_data)


    overall_netmob_p33_data=sum(abs(netmob_calc_vector_p33_data))/2.0
    overall_grossmob_p33_data=sum(abs(grossmob_calc_vector_p33_data))
    overall_xsmob_p33_data=overall_grossmob_p33_data-overall_netmob_p33_data

    overall_corr_netmob_p33_data=sum(abs(corr_netmob_calc_vector_p33_data))/2.0
    overall_corr_grossmob_p33_data=sum(abs(corr_grossmob_calc_vector_p33_data))
    overall_corr_xsmob_p33_data=overall_corr_grossmob_p33_data-overall_corr_netmob_p33_data




!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!! 33 percent **HIGHEST** LHPF unemployment rates

data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)>=hpu_p67 ) THEN

        !data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_superocc_transmatrix_qtr(:,:,tcnt)
        Do occcnt=1,occpts
        DO xcnt=1, occpts
            data_superocc_temptransmatrix(occcnt,xcnt)=data_superocc_temptransmatrix(occcnt,xcnt)+data_superocc_transmatrix_qtr(occcnt,xcnt,tcnt)
        END DO
        END DO

    END IF
END DO

data_superocc_transmatrix_p67=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)>=hpu_p67 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_corr_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
    END DO

data_corr_superocc_transmatrix_p67=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p67, netmob_calc_vector_p67)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p67, grossmob_calc_vector_p67)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p67, corr_netmob_calc_vector_p67)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p67, corr_grossmob_calc_vector_p67)


    overall_netmob_p67=sum(abs(netmob_calc_vector_p67))/2.0
    overall_grossmob_p67=sum(abs(grossmob_calc_vector_p67))
    overall_xsmob_p67=overall_grossmob_p67-overall_netmob_p67

    overall_corr_netmob_p67=sum(abs(corr_netmob_calc_vector_p67))/2.0
    overall_corr_grossmob_p67=sum(abs(corr_grossmob_calc_vector_p67))
    overall_corr_xsmob_p67=overall_corr_grossmob_p67-overall_corr_netmob_p67


    !! DATA COUNTER PART


    CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p67_data, netmob_calc_vector_p67_data)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p67_data, grossmob_calc_vector_p67_data)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p67_data, corr_netmob_calc_vector_p67_data)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p67_data, corr_grossmob_calc_vector_p67_data)


    overall_netmob_p67_data=sum(abs(netmob_calc_vector_p67_data))/2.0
    overall_grossmob_p67_data=sum(abs(grossmob_calc_vector_p67_data))
    overall_xsmob_p67_data=overall_grossmob_p67_data-overall_netmob_p67_data

    overall_corr_netmob_p67_data=sum(abs(corr_netmob_calc_vector_p67_data))/2.0
    overall_corr_grossmob_p67_data=sum(abs(corr_grossmob_calc_vector_p67_data))
    overall_corr_xsmob_p67_data=overall_corr_grossmob_p67_data-overall_corr_netmob_p67_data

Do occcnt=1,occpts
DO xcnt=1, occpts
    data_superocc_temptransmatrix(occcnt,xcnt)=sum(data_corr_superocc_transmatrix_qtr(occcnt,xcnt,:))
END DO
    END DO
    
!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!! remainder: between median and top third highest HPF unemployment rates
    

data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)<hpu_p67 .AND. data_u_qtr(tcnt)>=hpu_p50) THEN

        !data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_superocc_transmatrix_qtr(:,:,tcnt)
        Do occcnt=1,occpts
        DO xcnt=1, occpts
            data_superocc_temptransmatrix(occcnt,xcnt)=data_superocc_temptransmatrix(occcnt,xcnt)+data_superocc_transmatrix_qtr(occcnt,xcnt,tcnt)
        END DO
        END DO

    END IF
END DO

data_superocc_transmatrix_p50p67=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF(data_u_qtr(tcnt)>=hpu_p50 .AND. data_u_qtr(tcnt)<hpu_p67 ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_corr_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
END DO

data_corr_superocc_transmatrix_p50p67=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_p50p67, netmob_calc_vector_p50p67)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_p50p67, grossmob_calc_vector_p50p67)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50p67, corr_netmob_calc_vector_p50p67)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_p50p67, corr_grossmob_calc_vector_p50p67)


    overall_netmob_p50p67=sum(abs(netmob_calc_vector_p50p67))/2.0
    overall_grossmob_p50p67=sum(abs(grossmob_calc_vector_p50p67))
    overall_xsmob_p50p67=overall_grossmob_p50p67-overall_netmob_p50p67

    overall_corr_netmob_p50p67=sum(abs(corr_netmob_calc_vector_p50p67))/2.0
    overall_corr_grossmob_p50p67=sum(abs(corr_grossmob_calc_vector_p50p67))
    overall_corr_xsmob_p50p67=overall_corr_grossmob_p50p67-overall_corr_netmob_p50p67

!!~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
!! all: between median and top third highest HPF unemployment rates

data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF((data_u_qtr(tcnt) .ne. data_u_qtr(tcnt)+1.0) .AND. (.NOT.(data_u_qtr(tcnt) .ne. data_u_qtr(tcnt))) ) THEN

        !data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_superocc_transmatrix_qtr(:,:,tcnt)
        Do occcnt=1,occpts
        DO xcnt=1, occpts
            data_superocc_temptransmatrix(occcnt,xcnt)=data_superocc_temptransmatrix(occcnt,xcnt)+data_superocc_transmatrix_qtr(occcnt,xcnt,tcnt)
        END DO
        END DO

    END IF
END DO

data_superocc_transmatrix_allptile=data_superocc_temptransmatrix
data_superocc_temptransmatrix=0.0_8

DO tcnt=1, counter1         ! check counter1
    IF((data_u_qtr(tcnt) .ne. data_u_qtr(tcnt)+1.0) .AND. (.NOT.(data_u_qtr(tcnt) .ne. data_u_qtr(tcnt))) ) THEN
        data_superocc_temptransmatrix(:,:)=data_superocc_temptransmatrix(:,:)+data_corr_superocc_transmatrix_qtr(:,:,tcnt)
    END IF
    END DO

data_corr_superocc_transmatrix_allptile=data_superocc_temptransmatrix
!data_superocc_temptransmatrix=0.0_8

CALL NETMOBILITY_CALC(occpts,data_superocc_transmatrix_allptile, netmob_calc_vector_allptile)
    CALL GROSSMOBILITY_CALC(occpts,data_superocc_transmatrix_allptile, grossmob_calc_vector_allptile)
    CALL NETMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_allptile, corr_netmob_calc_vector_allptile)
    CALL GROSSMOBILITY_CALC(occpts,data_corr_superocc_transmatrix_allptile, corr_grossmob_calc_vector_allptile)


    overall_netmob_allptile=sum(abs(netmob_calc_vector_allptile))/2.0
    overall_grossmob_allptile=sum(abs(grossmob_calc_vector_allptile))
    overall_xsmob_allptile=overall_grossmob_allptile-overall_netmob_allptile

    overall_corr_netmob_allptile=sum(abs(corr_netmob_calc_vector_allptile))/2.0
    overall_corr_grossmob_allptile=sum(abs(corr_grossmob_calc_vector_allptile))
    overall_corr_xsmob_allptile=overall_corr_grossmob_allptile-overall_corr_netmob_allptile


!==========================================================
!    WRITE QUARTERLY AGGREGATE TIME SERIES TO FILE
!=========================================================


 !!$OMP MASTER
 !INQUIRE(FILE="quarterly_timeseries.txt", EXIST=file_exists)
 !IF (verbosetimeseriesfile==1 .AND. file_exists) THEN
 !    OPEN(UNIT=21, file="quarterly_timeseries.txt", status="old", form="formatted", position='append')
 !    WRITE(21,*) 'HP FILTERED ------------------------->'
 !    WRITE(21,*) 'threadno: ', threadnumber
 !    WRITE(21, FMT='(4(A15))', ADVANCE='NO') "time,", "hp_l_u,", "hp_l_v,", "hp_l_theta,"
 !    WRITE(21, FMT='(5(A15))', ADVANCE='NO') "hp_l_sep,", "hp_l_jf,", "hp_l_wage,", "hp_l_prod,", "hp_l_reall,"
 !    WRITE(21, FMT='(3(A15))', ADVANCE='NO') "log_u,", "log_v,", "log_theta,"
 !    WRITE(21, FMT='(5(A15))', ADVANCE='NO') "log_sep,", "log_jf,", "log_wage,", "log_prod,", "log_reall,"
 !    WRITE(21, FMT='(2(A15))') "log_jfocc,", "hp_l_jfocc,"
 !
 !    DO t=1,tmax_qtr2-2
 !        WRITE(21, FMT='(I5,9X, A1, 3(F14.6, A1))', ADVANCE='NO') t, "," , data_u_qtr(t), ",", data_v_qtr(t), ",", data_theta_qtr(t), ","
 !        WRITE(21, FMT='(5(F10.6, A1))', ADVANCE='NO') data_lsep_qtr(t), ",", data_ljf_qtr(t), ",", 0.0_8, ",", data_prod_qtr(t), ",", data_cocc_inflow_qtr(t), ","
 !        WRITE(21, *) ', -'
 !    END DO
 !    CLOSE(21)
 !END IF
 !!$OMP END MASTER




!=====================================================================================================
!============================================
!          AGGREGATE TIME SERIES  -- ELASTICITIES, AUTOCORRELATIONS, CORRELATIONS
!============================================
!=========================================================================================================

! INITIALIZE

var_u=0.0_8
var_v=0.0_8
var_theta=0.0_8
var_sep=0.0_8
var_jf=0.0_8
var_jfo=0.0_8
var_wage=0.0_8
var_prod=0.0_8
var_reall=0.0_8
var_u5=0.0_8
var_v5=0.0_8
var_theta5=0.0_8

var_sep5=0.0_8
var_jf5=0.0_8
var_jfo5=0.0_8
var_wage5=0.0_8
var_prod5=0.0_8
var_reall5=0.0_8
var_reall5_2=0.0_8

corr_uv=0.0_8
corr_uv_lindt=0.0_8
corr_utheta=0.0_8
corr_usep=0.0_8
corr_ujf=0.0_8
corr_uwage=0.0_8
corr_uprod=0.0_8
corr_ureall=0.0_8
corr_vtheta=0.0_8

corr_vsep=0.0_8
corr_vjf=0.0_8
corr_vwage=0.0_8
corr_vprd=0.0_8
corr_vreall=0.0_8

corr_thetasep=0.0_8
corr_thetajf=0.0_8
corr_thetawage=0.0_8
corr_thetaprod=0.0_8
corr_thetareall=0.0_8

corr_sepjf=0.0_8
corr_sepwage=0.0_8
corr_sepprod=0.0_8
corr_sepreall=0.0_8

corr_jfwage=0.0_8
corr_jfprod=0.0_8
corr_wageprod=0.0_8
corr_wagereall=0.0_8
corr_prodreall=0.0_8

corr_jfreall=0.0_8
corr_vprod=0.0_8
corr_ujfo=0.0_8
corr_vjfo=0.0_8
corr_thetajfo=0.0_8
corr_sepjfo=0.0_8
corr_jfjfo=0.0_8

corr_wagejfo=0.0_8
corr_prodjfo=0.0_8
corr_realljfo=0.0_8

corr_uv5=0.0_8
corr_uv5_2=0.0_8
corr_utheta5=0.0_8
corr_usep5=0.0_8
corr_ujf5=0.0_8
corr_uwage5=0.0_8
corr_uprod5=0.0_8
corr_ureall5=0.0_8
corr_vtheta5=0.0_8

corr_vsep5=0.0_8
corr_vjf5=0.0_8
corr_vwage5=0.0_8
corr_vprd5=0.0_8
corr_vreall5=0.0_8

corr_thetasep5=0.0_8
corr_thetajf5=0.0_8
corr_thetawage5=0.0_8
corr_thetaprod5=0.0_8
corr_thetareall5=0.0_8
corr_sepjf5=0.0_8
corr_sepwage5=0.0_8
corr_sepprod5=0.0_8
corr_sepreall5=0.0_8
corr_jfwage5=0.0_8
corr_jfprod5=0.0_8
corr_wageprod5=0.0_8
corr_wagereall5=0.0_8
corr_prodreall5=0.0_8

corr_jfreall5=0.0_8
corr_vprod5=0.0_8
corr_ujfo5=0.0_8
corr_vjfo5=0.0_8
corr_thetajfo5=0.0_8
corr_sepjfo5=0.0_8
corr_jfjfo5=0.0_8

corr_wagejfo5=0.0_8
corr_prodjfo5=0.0_8
corr_realljfo5=0.0_8

ac_u=0.0_8
ac_v=0.0_8
ac_theta=0.0_8
ac_sep=0.0_8
ac_jf=0.0_8
ac_wage=0.0_8
ac_prod=0.0_8
ac_reall=0.0_8
ac_jfo=0.0_8
ac_u5=0.0_8

ac_v5=0.0_8
ac_theta5=0.0_8
ac_sep5=0.0_8
ac_jf5=0.0_8
ac_wage5=0.0_8
ac_prod5=0.0_8
ac_reall5=0.0_8
ac_jfo5=0.0_8


jfocc5_prod_elasticity=0.0_8
jfnocc5_prod_elasticity=0.0_8
jf5_young_prod_elasticity=0.0_8
jf5_prime_prod_elasticity=0.0_8
jf5_prod_elasticity=0.0_8
jfocc5_prod_semielasticity=0.0_8
jfnocc5_prod_semielasticity=0.0_8
jf5_young_prod_semielasticity=0.0_8
jf5_prime_prod_semielasticity=0.0_8
jf5_prod_semielasticity=0.0_8
jfocc5_unemp_semielasticity=0.0_8
jfnocc5_unemp_semielasticity=0.0_8
jf5_young_unemp_semielasticity=0.0_8
jf5_prime_unemp_semielasticity=0.0_8
jf5_unemp_semielasticity=0.0_8
jfocc5_unemp_elasticity=0.0_8
jfnocc5_unemp_elasticity=0.0_8
jf5_young_unemp_elasticity=0.0_8
jf5_prime_unemp_elasticity=0.0_8
jf5_unemp_elasticity=0.0_8

jfocc_unemp_elasticity=0.0_8
jfnocc_unemp_elasticity=0.0_8
jf_young_unemp_elasticity=0.0_8
jf_prime_unemp_elasticity=0.0_8
jf_unemp_elasticity=0.0_8
sep_unemp_elasticity=0.0_8

sep_young_prod_semielasticity=0.0_8
sep_prod_semielasticity=0.0_8
sep_prime_prod_semielasticity=0.0_8
jfocc_prod_semielasticity=0.0_8
jfnocc_prod_semielasticity=0.0_8

jf_prod_semielasticity=0.0_8
jf_young_prod_semielasticity=0.0_8
jf_prime_prod_semielasticity=0.0_8

sep_young_unemp_semielasticity=0.0_8
sep_unemp_semielasticity=0.0_8
sep_prime_unemp_semielasticity=0.0_8
jfocc_unemp_semielasticity=0.0_8
jfnocc_unemp_semielasticity=0.0_8

jf_unemp_semielasticity=0.0_8
jf_young_unemp_semielasticity=0.0_8
jf_prime_unemp_semielasticity=0.0_8

hp_uprop3m_prod_elasticity=0.0_8
hp_uprop5m_prod_elasticity=0.0_8
hp_uprop9m_prod_elasticity=0.0_8
hp_uprop13m_prod_elasticity=0.0_8
hp_upropg13m_prod_elasticity=0.0_8
hp_uprop3m_prod_semielasticity=0.0_8
hp_uprop5m_prod_semielasticity=0.0_8
hp_uprop9m_prod_semielasticity=0.0_8
hp_uprop13m_prod_semielasticity=0.0_8
hp_upropg13m_prod_semielasticity=0.0_8
hp_uprop3m_unemp_elasticity=0.0_8
hp_uprop5m_unemp_elasticity=0.0_8
hp_uprop9m_unemp_elasticity=0.0_8
hp_uprop13m_unemp_elasticity=0.0_8
hp_upropg13m_unemp_elasticity=0.0_8
hp_sm_uprop3m_unemp_elasticity=0.0_8
hp_sm_uprop5m_unemp_elasticity=0.0_8
hp_sm_uprop9m_unemp_elasticity=0.0_8
hp_sm_uprop13m_unemp_elasticity=0.0_8
hp_sm_upropg13m_unemp_elasticity=0.0_8

hp_uprop3m_unemp_semielasticity=0.0_8
hp_uprop5m_unemp_semielasticity=0.0_8
hp_uprop9m_unemp_semielasticity=0.0_8
hp_uprop13m_unemp_semielasticity=0.0_8
hp_upropg13m_unemp_semielasticity=0.0_8
hp_uprop3m_prod_yng_elasticity=0.0_8
hp_uprop5m_prod_yng_elasticity=0.0_8
hp_uprop9m_prod_yng_elasticity=0.0_8
hp_uprop13m_prod_yng_elasticity=0.0_8
hp_upropg13m_prod_yng_elasticity=0.0_8

hp_uprop3m_prod_yng_semielasticity=0.0_8
hp_uprop5m_prod_yng_semielasticity=0.0_8
hp_uprop9m_prod_yng_semielasticity=0.0_8
hp_uprop13m_prod_yng_semielasticity=0.0_8
hp_upropg13m_prod_yng_semielasticity=0.0_8
hp_uprop3m_unemp_yng_elasticity=0.0_8
hp_uprop5m_unemp_yng_elasticity=0.0_8
hp_uprop9m_unemp_yng_elasticity=0.0_8
hp_uprop13m_unemp_yng_elasticity=0.0_8
hp_upropg13m_unemp_yng_elasticity=0.0_8
hp_uprop3m_unemp_yng_semielasticity=0.0_8
hp_uprop5m_unemp_yng_semielasticity=0.0_8
hp_uprop9m_unemp_yng_semielasticity=0.0_8
hp_uprop13m_unemp_yng_semielasticity=0.0_8
hp_upropg13m_unemp_yng_semielasticity=0.0_8
hp_uprop3m_prod_prm_elasticity=0.0_8
hp_uprop5m_prod_prm_elasticity=0.0_8
hp_uprop9m_prod_prm_elasticity=0.0_8
hp_uprop13m_prod_prm_elasticity=0.0_8
hp_upropg13m_prod_prm_elasticity=0.0_8
hp_uprop3m_prod_prm_semielasticity=0.0_8
hp_uprop5m_prod_prm_semielasticity=0.0_8
hp_uprop9m_prod_prm_semielasticity=0.0_8
hp_uprop13m_prod_prm_semielasticity=0.0_8
hp_upropg13m_prod_prm_semielasticity=0.0_8
hp_uprop3m_unemp_prm_elasticity=0.0_8
hp_uprop5m_unemp_prm_elasticity=0.0_8
hp_uprop9m_unemp_prm_elasticity=0.0_8
hp_uprop13m_unemp_prm_elasticity=0.0_8
hp_upropg13m_unemp_prm_elasticity=0.0_8
hp_uprop3m_unemp_prm_semielasticity=0.0_8
hp_uprop5m_unemp_prm_semielasticity=0.0_8
hp_uprop9m_unemp_prm_semielasticity=0.0_8
hp_uprop13m_unemp_prm_semielasticity=0.0_8
hp_upropg13m_unemp_prm_semielasticity=0.8

sm_hp_uprop3m_u_semi_el=0.0_8
sm_hp_uprop5m_u_semi_el=0.0_8
sm_hp_uprop9m_u_semi_el=0.0_8
sm_hp_uprop13m_u_semi_el=0.0_8
sm_hp_upropg13m_u_semi_el=0.0_8


! means quarterly: hp filtered: should equal 0 more or less
u_ave_q=sum(data_u_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
uall_ave_q=sum(data_uall_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
v_ave_q=sum(data_v_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
theta_ave_q=sum(data_theta_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
sep_ave_q=sum(data_lsep_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
jf_ave_q=sum(data_ljf_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
prod_ave_q=sum(data_prod_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
reall_ave_q=sum(data_cocc_outflow_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)


u_ave_q5=sum(data_lu5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
uall_ave_q5=sum(data_luall5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
v_ave_q5=sum(data_lv5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
theta_ave_q5=sum(data_ltheta5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
sep_ave_q5=sum(data_lsep5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
jf_ave_q5=sum(data_ljf5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
prod_ave_q5=sum(data_lprod5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)
reall_ave_q5=sum(data_lcocc_outflow5_qtr(13:tmax_qtr2-12))/REAL(tmax_qtr2-24.0)

!WRITE(*,*) 'HP DETRENDED AVERAGES, should be zero'
!WRITE(*,*) 'u_ave_q=', u_ave_q, 'v_ave_q=', v_ave_q, 'theta_ave_q=', theta_ave_q, 'sep_ave_q=', sep_ave_q
!WRITE(*,*) 'jf_ave_q=', jf_ave_q, 'wage_ave_q=', wage_ave_q, 'prod_ave_q=', prod_ave_q, 'reall_ave_q=', reall_ave_q

!=============================
! VARIANCES UNSMOOTHED
!================================


var_u=VARCALCUL(data_u_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_uall=VARCALCUL(data_uall_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_v=VARCALCUL(data_v_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_theta=VARCALCUL(data_theta_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_jf=VARCALCUL(data_ljf_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_sep=VARCALCUL(data_lsep_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_prod=VARCALCUL(data_prod_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_reall=VARCALCUL(data_cocc_outflow_qtr(13:tmax_qtr2-12), tmax_qtr2-24)

!!u
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+(data_u_qtr(t))**2.0_8
!     tempint=tempint+1
!END DO
!!WRITE(*,*) 'tempreal: sum of sq u=', tempreal
!!WRITE(*,*) 'tempint=', tempint
!var_u=tempreal/REAL(tempint)
!!WRITE(*,*) 'unconditional variance', var_u, 'and average u', u_ave_q
!var_u=(tempreal/REAL(tempint))-(u_ave_q)**2.0_8
!!WRITE(*,*) 'afterwards var_u=,', var_u
!
!!PAUSE
!
!
!
!!v
!
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_v=(tempreal/REAL(tempint))-(v_ave_q)**2.0_8
!!theta
!
!
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_theta_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_theta=(tempreal/REAL(tempint))-(theta_ave_q)**2.0_8
!
!! jf
!
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_ljf_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_jf=(tempreal/REAL(tempint))-(jf_ave_q)**2.0_8
!
!
!
!! sep
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_lsep_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_sep=(tempreal/REAL(tempint))-(sep_ave_q)**2.0_8
!
!
!!! wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_wage_qtr(t)**2.0_8
!!     tempint=tempint+1
!!END DO
!!var_wage=(tempreal/REAL(tempint))-(wage_ave_q)**2.0_8
!
!
!! prod
!
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_prod_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_prod=(tempreal/REAL(tempint))-(prod_ave_q)**2.0_8
!
!
!! reall
!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-2
!     tempreal=tempreal+data_cocc_outflow_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_reall=(tempreal/REAL(tempint))-(reall_ave_q)**2.0_8




!=============================
! VARIANCES **SMOOTHED**
!================================


var_u5=VARCALCUL(data_lu5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_uall5=VARCALCUL(data_luall5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_v5=VARCALCUL(data_lv5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_theta5=VARCALCUL(data_ltheta5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_jf5=VARCALCUL(data_ljf5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_sep5=VARCALCUL(data_lsep5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_prod5=VARCALCUL(data_lprod5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)
var_reall5=VARCALCUL(data_lcocc_outflow5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)

!
!!u
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+(data_lu5_qtr(t))**2.0_8
!     tempint=tempint+1
!END DO
!!WRITE(*,*) 'tempreal: sum of sq u=', tempreal
!!WRITE(*,*) 'tempint=', tempint
!var_u5=tempreal/REAL(tempint)
!!WRITE(*,*) 'unconditional variance', var_u5, 'and average u', u_ave_q5
!var_u5=(tempreal/REAL(tempint))-(u_ave_q5)**2.0_8
!!WRITE(*,*) 'afterwards var_u=,', var_u
!
!!PAUSE
!
!
!
!!v
!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_v5=(tempreal/REAL(tempint))-(v_ave_q5)**2.0_8
!!theta
!
!! theta
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ltheta5_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_theta5=(tempreal/REAL(tempint))-(theta_ave_q5)**2.0_8
!
!! jf
!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ljf5_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_jf5=(tempreal/REAL(tempint))-(jf_ave_q5)**2.0_8
!
!
!
!! sep
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lsep5_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_sep5=(tempreal/REAL(tempint))-(sep_ave_q5)**2.0_8
!
!
!!! wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_wage_qtr(t)**2.0_8
!!     tempint=tempint+1
!!END DO
!!var_wage5=(tempreal/REAL(tempint))-(wage_ave_q5)**2.0_8
!
!
!! prod
!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lprod5_qtr(t)**2.0_8
!     tempint=tempint+1
!END DO
!var_prod5=(tempreal/REAL(tempint))-(prod_ave_q5)**2.0_8
!
!
!! reall
!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-2
!     tempreal=tempreal+(data_lcocc_outflow5_qtr(t))**2.0_8
!     tempint=tempint+1
!END DO
!var_reall5=(tempreal/REAL(tempint))-(reall_ave_q5)**2.0_8
!
tempreal=0.0_8
tempint=0
DO t=13, tmax_qtr2-24
     tempreal=tempreal+(data_lcocc_outflow5_qtr(t))**2.0_8
     tempint=tempint+1
END DO
var_reall5_2=(tempreal/REAL(tempint))-(reall_ave_q5)**2.0_8


!===============================
! CORRELATION TABLE UNSMOOTHED
!===============================

! Correlations with u
!cov_uv, cov_utheta, cov_usep, cov_ujf, cov_uwage, cov_uprod, cov_ureall,

corr_uv=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_v_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_utheta=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_theta_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_usep=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_lsep_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ujf=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_ljf_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_uwage=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uprod=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ureall=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! Correlations with u
!cov_uv, cov_utheta, cov_usep, cov_ujf, cov_uwage, cov_uprod, cov_ureall,

corr_uallu=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_u_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallv=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_v_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ualltheta=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_theta_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallsep=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_lsep_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ualljf=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_ljf_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_uallwage=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallprod=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallreall=CORRCALCUL(data_uall_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! correlations with v

corr_vtheta=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_theta_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vsep=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_lsep_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vjf=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_ljf_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_vwage=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vprod=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vreall=CORRCALCUL(data_v_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! tightness


corr_thetasep=CORRCALCUL(data_theta_qtr(13:(tmax_qtr2-12)), data_lsep_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetajf=CORRCALCUL(data_theta_qtr(13:(tmax_qtr2-12)), data_ljf_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_thetawage=CORRCALCUL(data_theta_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetaprod=CORRCALCUL(data_theta_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetareall=CORRCALCUL(data_theta_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! separations


corr_sepjf=CORRCALCUL(data_lsep_qtr(13:(tmax_qtr2-12)), data_ljf_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_sepwage=CORRCALCUL(data_lsep_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_sepprod=CORRCALCUL(data_lsep_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_sepreall=CORRCALCUL(data_lsep_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! job finding

!corr_jfwage=CORRCALCUL(data_ljf_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_jfprod=CORRCALCUL(data_ljf_qtr(13:(tmax_qtr2-12)), data_prod_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_jfreall=CORRCALCUL(data_ljf_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! productivity

!corr_prodwage=CORRCALCUL(data_u_qtr(13:(tmax_qtr2-12)), data_wage_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_prodreall=CORRCALCUL(data_prod_qtr(13:(tmax_qtr2-12)), data_cocc_outflow_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

!
!
!
!
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+(data_u_qtr(t)*data_v_qtr(t))
!     tempint=tempint+1
!END DO
!corr_uv=(tempreal/REAL(tempint))-(u_ave_q)*(v_ave_q)
!corr_uv=corr_uv/(sqrt(var_v)*sqrt(var_u))
!
!! u with theta
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_u_qtr(t)*data_theta_qtr(t)
!     tempint=tempint+1
!END DO
!corr_utheta=(tempreal/REAL(tempint))-(u_ave_q)*(theta_ave_q)
!corr_utheta=corr_utheta/(sqrt(var_u)*sqrt(var_theta))
!
!! u with jf
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_u_qtr(t)*data_ljf_qtr(t)
!     tempint=tempint+1
!END DO
!corr_ujf=(tempreal/REAL(tempint))-(u_ave_q)*(jf_ave_q)
!corr_ujf=corr_ujf/(sqrt(var_u)*sqrt(var_jf))
!
!
!! u with sep
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_u_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_usep=(tempreal/REAL(tempint))-(u_ave_q)*(sep_ave_q)
!corr_usep=corr_usep/(sqrt(var_u)*sqrt(var_sep))
!
!! u with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_u_qtr(t)*data_prod_qtr(t)
!     tempint=tempint+1
!END DO
!corr_uprod=(tempreal/REAL(tempint))-(u_ave_q)*(prod_ave_q)
!corr_uprod=corr_uprod/(sqrt(var_u)*sqrt(var_prod))
!
!! u with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_u_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_uwage=(tempreal/REAL(tempint))-(u_ave_q)*(wage_ave_q)
!!corr_uwage=corr_uwage/(sqrt(var_u)*sqrt(var_wage))
!
!! u with reall
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_u_qtr(t)*data_cocc_outflow_qtr(t)
!     tempint=tempint+1
!END DO
!corr_ureall=(tempreal/REAL(tempint))-(u_ave_q)*(reall_ave_q)
!corr_ureall=corr_ureall/(sqrt(var_u)*sqrt(var_reall))
!
!
!! CORRELATIONS WITH V
!!cov_vtheta, cov_vsep, cov_vjf, cov_vwage, cov_vprd, cov_vreall,
!
!! v with theta
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)*data_theta_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vtheta=(tempreal/REAL(tempint))-(v_ave_q)*(theta_ave_q)
!corr_vtheta=corr_vtheta/(sqrt(var_v)*sqrt(var_theta))
!
!! v with sep
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vsep=(tempreal/REAL(tempint))-(v_ave_q)*(sep_ave_q)
!corr_vsep=corr_vsep/(sqrt(var_v)*sqrt(var_sep))
!
!! v with jf
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)*data_ljf_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vjf=(tempreal/REAL(tempint))-(v_ave_q)*(jf_ave_q)
!corr_vjf=corr_vjf/(sqrt(var_v)*sqrt(var_jf))
!
!
!
!
!
!! v with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_v_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_vwage=(tempreal/REAL(tempint))-(v_ave_q)*(wage_ave_q)
!!corr_vwage=corr_vwage/(sqrt(var_v)*sqrt(var_wage))
!
!! v with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)*data_prod_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vprod=(tempreal/REAL(tempint))-(v_ave_q)*(prod_ave_q)
!corr_vprod=corr_vprod/(sqrt(var_v)*sqrt(var_prod))
!
!! v with reall
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_v_qtr(t)*data_cocc_outflow_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vreall=(tempreal/REAL(tempint))-(v_ave_q)*(reall_ave_q)
!corr_vreall=corr_vreall/(sqrt(var_v)*sqrt(var_reall))
!
!
!
!
!
!! CORRELATIONS WITH THETA
!!cov_thetasep, cov_thetajf, cov_thetawage, cov_thetaprod, cov_thetareall, &
!
!! sep with theta
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_theta_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetasep=(tempreal/REAL(tempint))-(theta_ave_q)*(sep_ave_q)
!corr_thetasep=corr_thetasep/(sqrt(var_theta)*sqrt(var_sep))
!
!
!
!! theta with jf
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_theta_qtr(t)*data_ljf_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetajf=(tempreal/REAL(tempint))-(theta_ave_q)*(jf_ave_q)
!corr_thetajf=corr_thetajf/(sqrt(var_theta)*sqrt(var_jf))
!
!
!
!! theta with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_theta_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_thetawage=(tempreal/REAL(tempint))-(theta_ave_q)*(wage_ave_q)
!!corr_thetawage=corr_thetawage/(sqrt(var_theta)*sqrt(var_wage))
!
!
!! theta with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_theta_qtr(t)*data_prod_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetaprod=(tempreal/REAL(tempint))-(theta_ave_q)*(prod_ave_q)
!corr_thetaprod=corr_thetaprod/(sqrt(var_theta)*sqrt(var_prod))
!
!
!! theta  with reall
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_theta_qtr(t)*data_cocc_outflow_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetareall=(tempreal/REAL(tempint))-(theta_ave_q)*(reall_ave_q)
!corr_thetareall=corr_thetareall/(sqrt(var_theta)*sqrt(var_reall))
!
!! CORRELATIONS WITH SEP
!! cov_sepjf, cov_sepwage, cov_sepprod, cov_sepreall, &
!
!
!! sep with jf
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_ljf_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepjf=(tempreal/REAL(tempint))-(jf_ave_q)*(sep_ave_q)
!corr_sepjf=corr_sepjf/(sqrt(var_jf)*sqrt(var_sep))
!
!
!
!
!! sep with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_wage_qtr(t)*data_sep_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_sepwage=(tempreal/REAL(tempint))-(wage_ave_q)*(sep_ave_q)
!!corr_sepwage=corr_sepwage/(sqrt(var_wage)*sqrt(var_sep))
!
!
!! sep with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_prod_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepprod=(tempreal/REAL(tempint))-(prod_ave_q)*(sep_ave_q)
!corr_sepprod=corr_sepprod/(sqrt(var_prod)*sqrt(var_sep))
!
!
!! sep with reall
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_cocc_outflow_qtr(t)*data_lsep_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepreall=(tempreal/REAL(tempint))-(reall_ave_q)*(sep_ave_q)
!corr_sepreall=corr_sepreall/(sqrt(var_reall)*sqrt(var_sep))
!
!! CORRELATIONS WITH JF
!! cov_jfwage, cov_jfprod, covjfreall
!
!
!! jf with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_wage_qtr(t)*data_ljf_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_jfwage=(tempreal/REAL(tempint))-(wage_ave_q)*(jf_ave_q)
!!corr_jfwage=corr_jfwage/(sqrt(var_wage)*sqrt(var_jf))
!
!! jf with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_prod_qtr(t)*data_ljf_qtr(t)
!     tempint=tempint+1
!END DO
!corr_jfprod=(tempreal/REAL(tempint))-(prod_ave_q)*(jf_ave_q)
!corr_jfprod=corr_jfprod/(sqrt(var_prod)*sqrt(var_jf))
!
!! jf with reall
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_cocc_outflow_qtr(t)*data_ljf_qtr(t)
!     tempint=tempint+1
!END DO
!corr_jfreall=(tempreal/REAL(tempint))-(reall_ave_q)*(jf_ave_q)
!corr_jfreall=corr_jfreall/(sqrt(var_reall)*sqrt(var_jf))
!
!
!
!
!
!
!! CORRELATIONS WITH WAGE
!!cov_wageprod, cov_wagereall,
!
!! prod with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_wage_qtr(t)*data_prod_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_wageprod=(tempreal/REAL(tempint))-(wage_ave_q)*(prod_ave_q)
!!corr_wageprod=corr_wageprod/(sqrt(var_wage)*sqrt(var_prod))
!
!!! reall with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=1, tmax_qtr2-2
!!     tempreal=tempreal+data_wage_qtr(t)*data_cocc_outflow_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_wagereall=(tempreal/REAL(tempint))-(wage_ave_q)*(reall_ave_q)
!!corr_wagereall=corr_wagereall/(sqrt(var_wage)*sqrt(var_reall))
!
!
!! CORRELATIONS WITH PROD
!!covprod_reall
!
!! reall with prod
!tempreal=0.0_8
!tempint=0
!DO t=1, tmax_qtr2-2
!     tempreal=tempreal+data_prod_qtr(t)*data_cocc_outflow_qtr(t)
!     tempint=tempint+1
!END DO
!corr_prodreall=(tempreal/REAL(tempint))-(prod_ave_q)*(reall_ave_q)
!corr_prodreall=corr_prodreall/(sqrt(var_prod)*sqrt(var_reall))

! ~~~~~~~~~~~~~~~~~~~~~~~~~~~AUTOCORRELATIONS

!ac_u, ac_v, ac_theta, ac_sep, ac_jf, ac_wage, ac_prod, ac_reall
! ac_u
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_u_qtr(t)*data_u_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_u=(tempreal/REAL(tempint))-(u_ave_q)*(u_ave_q)
ac_u=ac_u/var_u

! ac_uall
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_uall_qtr(t)*data_uall_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_uall=(tempreal/REAL(tempint))-(uall_ave_q)*(uall_ave_q)
ac_uall=ac_uall/var_uall


! ac_v
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_v_qtr(t)*data_v_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_v=(tempreal/REAL(tempint))-(v_ave_q)*(v_ave_q)
ac_v=ac_v/var_v


! ac_theta
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_theta_qtr(t)*data_theta_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_theta=(tempreal/REAL(tempint))-(theta_ave_q)*(theta_ave_q)
ac_theta=ac_theta/var_theta


! ac_jf
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_ljf_qtr(t)*data_ljf_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_jf=(tempreal/REAL(tempint))-(jf_ave_q)*(jf_ave_q)
ac_jf=ac_jf/var_jf




! ac_sep
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lsep_qtr(t)*data_lsep_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_sep=(tempreal/REAL(tempint))-(sep_ave_q)*(sep_ave_q)
ac_sep=ac_sep/var_sep


! ac_prod
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_prod_qtr(t)*data_prod_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_prod=(tempreal/REAL(tempint))-(prod_ave_q)*(prod_ave_q)
ac_prod=ac_prod/var_prod


!! ac_wage
!tempreal=0.0_8
!tempint=0
!DO t=2, tmax_qtr2
!     tempreal=tempreal+data_wage_qtr(t)*data_wage_qtr(t-1)
!     tempint=tempint+1
!END DO
!ac_wage=(tempreal/REAL(tempint))-(wage_ave_q)*(wage_ave_q)
!ac_wage=ac_wage/var_wage


! ac_reall
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_cocc_outflow_qtr(t)*data_cocc_outflow_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_reall=(tempreal/REAL(tempint))-(reall_ave_q)*(reall_ave_q)
ac_reall=ac_reall/var_reall



!===============================
! CORRELATION TABLE **SMOOTHED**
!===============================

! Correlations with u
!cov_uv, cov_utheta, cov_usep, cov_ujf, cov_uwage, cov_uprod, cov_ureall,

corr_uv5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_lv5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_utheta5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_ltheta5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_usep5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_lsep5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ujf5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_ljf5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_uwage5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uprod5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ureall5=CORRCALCUL(data_lu5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! Correlations with u
!cov_uv, cov_utheta, cov_usep, cov_ujf, cov_uwage, cov_uprod, cov_ureall,

corr_uallu5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_lu5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallv5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_lv5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ualltheta5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_ltheta5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallsep5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_lsep5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_ualljf5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_ljf5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_uallwage5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallprod5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_uallreall5=CORRCALCUL(data_luall5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! correlations with v

corr_vtheta5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_ltheta5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vsep5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_lsep5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vjf5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_ljf5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_vwage5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vprod5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_vreall5=CORRCALCUL(data_lv5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! tightness


corr_thetasep5=CORRCALCUL(data_ltheta5_qtr(13:(tmax_qtr2-12)), data_lsep5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetajf5=CORRCALCUL(data_ltheta5_qtr(13:(tmax_qtr2-12)), data_ljf5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_thetawage5=CORRCALCUL(data_ltheta5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetaprod5=CORRCALCUL(data_ltheta5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_thetareall5=CORRCALCUL(data_ltheta5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

! separations


corr_sepjf5=CORRCALCUL(data_lsep5_qtr(13:(tmax_qtr2-12)), data_ljf5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
!corr_sepwage5=CORRCALCUL(data_lsep5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_sepprod5=CORRCALCUL(data_lsep5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_sepreall5=CORRCALCUL(data_lsep5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! job finding

!corr_jfwage5=CORRCALCUL(data_ljf5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_jfprod5=CORRCALCUL(data_ljf5_qtr(13:(tmax_qtr2-12)), data_lprod5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_jfreall5=CORRCALCUL(data_ljf5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)


! productivity

!corr_prodwage5=CORRCALCUL(data_u5_qtr(13:(tmax_qtr2-12)), data_wage5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)
corr_prodreall5=CORRCALCUL(data_lprod5_qtr(13:(tmax_qtr2-12)), data_lcocc_outflow5_qtr(13:(tmax_qtr2-12)), tmax_qtr2-24)

!
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+(data_lu5_qtr(t)*data_lv5_qtr(t))
!     tempint=tempint+1
!END DO
!corr_uv5=(tempreal/REAL(tempint))-(u_ave_q5)*(v_ave_q5)
!corr_uv5=corr_uv5/(sqrt(var_v5)*sqrt(var_u5))
!
!! u with theta
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lu5_qtr(t)*data_ltheta5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_utheta5=(tempreal/REAL(tempint))-(u_ave_q5)*(theta_ave_q5)
!corr_utheta5=corr_utheta5/(sqrt(var_u5)*sqrt(var_theta5))
!
!! u with jf
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lu5_qtr(t)*data_ljf5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_ujf5=(tempreal/REAL(tempint))-(u_ave_q5)*(jf_ave_q5)
!corr_ujf5=corr_ujf5/(sqrt(var_u5)*sqrt(var_jf5))
!
!
!! u with sep
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lu5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_usep5=(tempreal/REAL(tempint))-(u_ave_q5)*(sep_ave_q5)
!corr_usep5=corr_usep5/(sqrt(var_u5)*sqrt(var_sep5))
!
!! u with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lu5_qtr(t)*data_lprod5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_uprod5=(tempreal/REAL(tempint))-(u_ave_q5)*(prod_ave_q5)
!corr_uprod5=corr_uprod5/(sqrt(var_u5)*sqrt(var_prod5))
!
!! u with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_u_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_uwage=(tempreal/REAL(tempint))-(u_ave_q)*(wage_ave_q)
!!corr_uwage=corr_uwage/(sqrt(var_u)*sqrt(var_wage))
!
!! u with reall
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lu5_qtr(t)*data_lcocc_outflow5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_ureall5=(tempreal/REAL(tempint))-(u_ave_q5)*(reall_ave_q5)
!corr_ureall5=corr_ureall5/(sqrt(var_u5)*sqrt(var_reall5))
!
!
!!-------
!! CORRELATIONS WITH V
!!cov_vtheta, cov_vsep, cov_vjf, cov_vwage, cov_vprd, cov_vreall,
!
!! v with theta
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)*data_ltheta5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vtheta5=(tempreal/REAL(tempint))-(v_ave_q5)*(theta_ave_q5)
!corr_vtheta5=corr_vtheta5/(sqrt(var_v5)*sqrt(var_theta5))
!
!! v with sep
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vsep5=(tempreal/REAL(tempint))-(v_ave_q5)*(sep_ave_q5)
!corr_vsep5=corr_vsep5/(sqrt(var_v5)*sqrt(var_sep5))
!
!! v with jf
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)*data_ljf5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vjf5=(tempreal/REAL(tempint))-(v_ave_q5)*(jf_ave_q5)
!corr_vjf5=corr_vjf5/(sqrt(var_v5)*sqrt(var_jf5))
!
!
!
!
!
!! v with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_v_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_vwage=(tempreal/REAL(tempint))-(v_ave_q)*(wage_ave_q)
!!corr_vwage=corr_vwage/(sqrt(var_v)*sqrt(var_wage))
!
!! v with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)*data_lprod5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vprod5=(tempreal/REAL(tempint))-(v_ave_q5)*(prod_ave_q5)
!corr_vprod5=corr_vprod5/(sqrt(var_v5)*sqrt(var_prod5))
!
!! v with reall
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lv5_qtr(t)*data_lcocc_outflow5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_vreall5=(tempreal/REAL(tempint))-(v_ave_q5)*(reall_ave_q5)
!corr_vreall5=corr_vreall5/(sqrt(var_v5)*sqrt(var_reall5))
!
!
!
!
!
!! CORRELATIONS WITH THETA
!!cov_thetasep, cov_thetajf, cov_thetawage, cov_thetaprod, cov_thetareall, &
!
!! sep with theta
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ltheta5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetasep5=(tempreal/REAL(tempint))-(theta_ave_q5)*(sep_ave_q5)
!corr_thetasep5=corr_thetasep5/(sqrt(var_theta5)*sqrt(var_sep5))
!
!
!
!! theta with jf
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ltheta5_qtr(t)*data_ljf5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetajf5=(tempreal/REAL(tempint))-(theta_ave_q5)*(jf_ave_q5)
!corr_thetajf5=corr_thetajf5/(sqrt(var_theta5)*sqrt(var_jf5))
!
!
!
!! theta with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_theta_qtr(t)*data_wage_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_thetawage=(tempreal/REAL(tempint))-(theta_ave_q)*(wage_ave_q)
!!corr_thetawage=corr_thetawage/(sqrt(var_theta)*sqrt(var_wage))
!
!
!! theta with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ltheta5_qtr(t)*data_lprod5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetaprod5=(tempreal/REAL(tempint))-(theta_ave_q5)*(prod_ave_q5)
!corr_thetaprod5=corr_thetaprod5/(sqrt(var_theta5)*sqrt(var_prod5))
!
!
!! theta  with reall
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ltheta5_qtr(t)*data_lcocc_outflow5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_thetareall5=(tempreal/REAL(tempint))-(theta_ave_q5)*(reall_ave_q5)
!corr_thetareall5=corr_thetareall5/(sqrt(var_theta5)*sqrt(var_reall5))
!
!! CORRELATIONS WITH SEP
!! cov_sepjf, cov_sepwage, cov_sepprod, cov_sepreall, &
!
!
!! sep with jf
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_ljf5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepjf5=(tempreal/REAL(tempint))-(jf_ave_q5)*(sep_ave_q5)
!corr_sepjf5=corr_sepjf5/(sqrt(var_jf5)*sqrt(var_sep5))
!
!
!
!
!! sep with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_wage_qtr(t)*data_sep_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_sepwage=(tempreal/REAL(tempint))-(wage_ave_q)*(sep_ave_q)
!!corr_sepwage=corr_sepwage/(sqrt(var_wage)*sqrt(var_sep))
!
!
!! sep with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lprod5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepprod5=(tempreal/REAL(tempint))-(prod_ave_q5)*(sep_ave_q5)
!corr_sepprod5=corr_sepprod5/(sqrt(var_prod5)*sqrt(var_sep5))
!
!
!! sep with reall
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lcocc_outflow5_qtr(t)*data_lsep5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_sepreall5=(tempreal/REAL(tempint))-(reall_ave_q5)*(sep_ave_q5)
!corr_sepreall5=corr_sepreall5/(sqrt(var_reall5)*sqrt(var_sep5))
!
!! CORRELATIONS WITH JF
!! cov_jfwage, cov_jfprod, covjfreall
!
!
!! jf with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_wage_qtr(t)*data_ljf_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_jfwage=(tempreal/REAL(tempint))-(wage_ave_q)*(jf_ave_q)
!!corr_jfwage=corr_jfwage/(sqrt(var_wage)*sqrt(var_jf))
!
!! jf with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lprod5_qtr(t)*data_ljf5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_jfprod5=(tempreal/REAL(tempint))-(prod_ave_q5)*(jf_ave_q5)
!corr_jfprod5=corr_jfprod5/(sqrt(var_prod5)*sqrt(var_jf5))
!
!! jf with reall
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lcocc_outflow5_qtr(t)*data_ljf5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_jfreall5=(tempreal/REAL(tempint))-(reall_ave_q5)*(jf_ave_q5)
!corr_jfreall5=corr_jfreall5/(sqrt(var_reall5)*sqrt(var_jf5))
!
!
!
!
!
!
!! CORRELATIONS WITH WAGE
!!cov_wageprod, cov_wagereall,
!
!! prod with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_wage_qtr(t)*data_prod_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_wageprod=(tempreal/REAL(tempint))-(wage_ave_q)*(prod_ave_q)
!!corr_wageprod=corr_wageprod/(sqrt(var_wage)*sqrt(var_prod))
!
!!! reall with wage
!!tempreal=0.0_8
!!tempint=0
!!DO t=3, tmax_qtr2-3
!!     tempreal=tempreal+data_wage_qtr(t)*data_cocc_outflow_qtr(t)
!!     tempint=tempint+1
!!END DO
!!corr_wagereall=(tempreal/REAL(tempint))-(wage_ave_q)*(reall_ave_q)
!!corr_wagereall=corr_wagereall/(sqrt(var_wage)*sqrt(var_reall))
!
!
!! CORRELATIONS WITH PROD
!!covprod_reall
!
!! reall with prod
!tempreal=0.0_8
!tempint=0
!DO t=3, tmax_qtr2-3
!     tempreal=tempreal+data_lprod5_qtr(t)*data_lcocc_outflow5_qtr(t)
!     tempint=tempint+1
!END DO
!corr_prodreall5=(tempreal/REAL(tempint))-(prod_ave_q5)*(reall_ave_q5)
!corr_prodreall5=corr_prodreall5/(sqrt(var_prod5)*sqrt(var_reall5))
!


!================================================
! ~~~~~~~~~~~~~~~~~~~~~~~~~~~AUTOCORRELATIONS: UNSMOOTHED
!=================================================

!ac_u, ac_v, ac_theta, ac_sep, ac_jf, ac_wage, ac_prod, ac_reall
! ac_u


tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2-1
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_u_qtr(t)*data_u_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_u=(tempreal/REAL(tempint))-(u_ave_q)*(u_ave_q)
ac_u=ac_u/var_u

! ac_u


tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2-1
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_uall_qtr(t)*data_uall_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_uall=(tempreal/REAL(tempint))-(uall_ave_q)*(uall_ave_q)
ac_uall=ac_uall/var_uall


! ac_v
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_v_qtr(t)*data_v_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_v=(tempreal/REAL(tempint))-(v_ave_q)*(v_ave_q)
ac_v=ac_v/var_v


! ac_theta
tempreal=0.0_8
tempint=0
DO t=13, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_theta_qtr(t)*data_theta_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_theta=(tempreal/REAL(tempint))-(theta_ave_q)*(theta_ave_q)
ac_theta=ac_theta/var_theta


! ac_jf
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_ljf_qtr(t)*data_ljf_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_jf=(tempreal/REAL(tempint))-(jf_ave_q)*(jf_ave_q)
ac_jf=ac_jf/var_jf




! ac_sep
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2-12
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lsep_qtr(t)*data_lsep_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_sep=(tempreal/REAL(tempint))-(sep_ave_q)*(sep_ave_q)
ac_sep=ac_sep/var_sep


! ac_prod
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_prod_qtr(t)*data_prod_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_prod=(tempreal/REAL(tempint))-(prod_ave_q)*(prod_ave_q)
ac_prod=ac_prod/var_prod


!! ac_wage
!tempreal=0.0_8
!tempint=0
!DO t=2, tmax_qtr2
!     tempreal=tempreal+data_wage_qtr(t)*data_wage_qtr(t-1)
!     tempint=tempint+1
!END DO
!ac_wage=(tempreal/REAL(tempint))-(wage_ave_q)*(wage_ave_q)
!ac_wage=ac_wage/var_wage


! ac_reall
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_cocc_outflow_qtr(t)*data_cocc_outflow_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_reall=(tempreal/REAL(tempint))-(reall_ave_q)*(reall_ave_q)
ac_reall=ac_reall/var_reall



!================================================
! ~~~~AUTOCORRELATIONS: **SMOOTHED**
!=================================================

!ac_u, ac_v, ac_theta, ac_sep, ac_jf, ac_wage, ac_prod, ac_reall
! ac_u
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lu5_qtr(t)*data_lu5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_u5=(tempreal/REAL(tempint))-(u_ave_q5)*(u_ave_q5)
ac_u5=ac_u5/var_u5

!ac_u, ac_v, ac_theta, ac_sep, ac_jf, ac_wage, ac_prod, ac_reall
! ac_u
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_luall5_qtr(t)*data_luall5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_uall5=(tempreal/REAL(tempint))-(uall_ave_q5)*(uall_ave_q5)
ac_uall5=ac_uall5/var_uall5

! ac_v
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lv5_qtr(t)*data_lv5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_v5=(tempreal/REAL(tempint))-(v_ave_q5)*(v_ave_q5)
ac_v5=ac_v5/var_v5


! ac_theta
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_ltheta5_qtr(t)*data_ltheta5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_theta5=(tempreal/REAL(tempint))-(theta_ave_q5)*(theta_ave_q5)
ac_theta5=ac_theta5/var_theta5


! ac_jf
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_ljf5_qtr(t)*data_ljf5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_jf5=(tempreal/REAL(tempint))-(jf_ave_q5)*(jf_ave_q5)
ac_jf5=ac_jf5/var_jf5




! ac_sep
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lsep5_qtr(t)*data_lsep5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_sep5=(tempreal/REAL(tempint))-(sep_ave_q5)*(sep_ave_q5)
ac_sep5=ac_sep5/var_sep5


! ac_prod
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
     tempreal=tempreal+data_lprod5_qtr(t)*data_lprod5_qtr(t-1)
     tempint=tempint+1
END DO
ac_prod5=(tempreal/REAL(tempint))-(prod_ave_q5)*(prod_ave_q5)
ac_prod5=ac_prod5/var_prod5


!! ac_wage
!tempreal=0.0_8
!tempint=0
!DO t=2, tmax_qtr2
!     tempreal=tempreal+data_wage_qtr(t)*data_wage_qtr(t-1)
!     tempint=tempint+1
!END DO
!ac_wage=(tempreal/REAL(tempint))-(wage_ave_q)*(wage_ave_q)
!ac_wage=ac_wage/var_wage


! ac_reall
tempreal=0.0_8
tempint=0
DO t=2, tmax_qtr2
    IF(mask_qtr(t)== .TRUE.) THEN
     tempreal=tempreal+data_lcocc_outflow5_qtr(t)*data_lcocc_outflow5_qtr(t-1)
     tempint=tempint+1
    END IF
END DO
ac_reall5=(tempreal/REAL(tempint))-(reall_ave_q5)*(reall_ave_q5)
ac_reall5=ac_reall5/var_reall5


! NEW WAY OF CALCULATING
!CALL UNBIASED_CORRELATION( tmax_qtr2-5, data_lcocc_outflow5_qtr(3:tmax_qtr2-2), data_lcocc_outflow5_qtr(3:tmax_qtr2-2), 999.99_8, 1, ac_reall5, tempreal, tempint)
!CALL UNBIASED_CORRELATION( tmax_qtr2-5, data_lu5_qtr(3:tmax_qtr2-2), data_lv5_qtr(3:tmax_qtr2-2), 999.99_8, 0, corr_uv5_2, tempreal, tempint)







!====================================================
!========== LIFECYCLE CORRELATIONS AND VARIANCES
!=====================================================


!(data_lu5_qtr(13:tmax_qtr2-12), tmax_qtr2-24)

var_uyoung=VARCALCUL(data_u_young_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_uprime=VARCALCUL(data_u_prime_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_jfyoung=VARCALCUL(data_ljf5_young_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_jfprime=VARCALCUL(data_ljf5_prime_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_jfocc=VARCALCUL(data_lpocc5_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_jfnocc=VARCALCUL(data_lpnocc5_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)

var_sepyoung=VARCALCUL(data_sep_y_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_lsepyoung=VARCALCUL(data_lsep_y_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_sepprime=VARCALCUL(data_sep_p_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_lsepprime=VARCALCUL(data_lsep_p_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_cm=VARCALCUL(data_cocc_outflow_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_cmyoung=VARCALCUL(data_cocc_young_outflow_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
var_cmprime=VARCALCUL(data_cocc_prime_outflow_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)

relstdev_occmob_y=sqrt(var_cm)/sqrt(var_prod)

corr_uyoungprod=CORRCALCUL(data_u_young_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_uprimeprod=CORRCALCUL(data_u_prime_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_jfyoungprod=CORRCALCUL(data_ljf_young_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_jfprimeprod=CORRCALCUL(data_ljf_prime_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_sepyoungprod=CORRCALCUL(data_lsep_y_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_sepprimeprod=CORRCALCUL(data_lsep_p_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_cmyoungprod=CORRCALCUL(data_cocc_young_outflow_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_cmprimeprod=CORRCALCUL(data_cocc_prime_outflow_qtr(13:tmax_qtr2-12) , data_prod_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)

corr_jfyoungunempl=CORRCALCUL(data_ljf_young_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_jfprimeunempl=CORRCALCUL(data_ljf_prime_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_sepyoungunempl=CORRCALCUL(data_lsep_y_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_sepprimeunempl=CORRCALCUL(data_lsep_p_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_cmyoungunempl=CORRCALCUL(data_cocc_young_outflow_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)
corr_cmprimeunempl=CORRCALCUL(data_cocc_prime_outflow_qtr(13:tmax_qtr2-12) , data_u_qtr(13:tmax_qtr2-12) , tmax_qtr2-24)



! calculate the elasticity of the matching function is the same (or similar) to the data
! regress job finding rate on a constant and on the tightness



!$OMP CRITICAL
!CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
!WRITE(10,*) 'time=', time_string(2), 'before regressions, on thread:', threadnumber


!ALLOCATE(Xjf(tmax_qtr2-2,2), Yjf(1:tmax_qtr2-2,1))


!Xjf(:,1)=1
!Xjf(:,2)=data_theta_qtr(1: tmax_qtr2-2)
!Yjf(1:tmax_qtr2-2,1)=data_ljf_qtr(1:tmax_qtr2-2)
!
!CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
!
!IF (verbose_results_l1==1) THEN
!WRITE(10,*) ' '
!WRITE(10,*) '======> elasticity of jf wrt theta:', betajf(2)
!WRITE(10,*) ' '
!END

! CALCULATE ELASTICITIES OF INTEREST!!!
IF (verbose_progress) WRITE(*,*) '! CALCULATE ELASTICITIES OF INTEREST!!!'


! 1. EMPIRICAL ELASTICITY OF THE MATCHING FUNCTION
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_theta_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ljf_qtr(13:tmax_qtr2-12)

CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
IF (verbose_results_l1==1) WRITE(10,*) 'elasticity of the matching function:', betajf(2)
!WRITE(*,*) 'elasticity of the matching function:', betajf(2)
elmatching_ave=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'elmatching_ave'
END IF


! 2. UNEMP with productivity
Xjf(1:tmax_qtr2-24,2)=data_prod_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_u_qtr(13:tmax_qtr2-12)

CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
unemp_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'unemp_prod_elasticity'
END IF


! 3. UNEMPLOYMENT OF YOUNG WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_u_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
u_young_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u_young_prod_elasticity'
END IF


! 4. UNEMPLOYMENT OF PRIME-AGED WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_u_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
u_prime_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'u_prime_prod_elasticity'
END IF


! 5a. SEPARATION OF YOUNG WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lsep_y_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_young_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_young_prod_elasticity'
END IF


! 5b. SEPARATION OF PRIME-AGED WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lsep_p_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prime_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prime_prod_elasticity'
END IF


! 5a. SEPARATION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lsep_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prod_elasticity'
END IF

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_lsep_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_supocc_prod_elasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'supocc_sep_prod_elasticity'
END IF
END DO


DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_ludur_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_supocc_prod_elasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'supocc_udur_prod_elasticity'
END IF
END DO

! 6a1. COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_inflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_inflow_prod_elasticity'
END IF


! 6a2. YOUNG COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_young_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_young_inflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_young_inflow_prod_elasticity'
END IF


! 6a3. PRIME COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_prime_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_prime_inflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_prime_inflow_prod_elasticity'
END IF



! 6a4. COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_outflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_outflow_prod_elasticity'
END IF


! 6a5. YOUNG COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_young_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_young_outflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_young_outflow_prod_elasticity'
END IF


! 6a6. PRIME COMPOSITION WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_cocc_prime_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_prime_outflow_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_prime_outflow_prod_elasticity'
END IF



! 6b. JFOCC WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lpocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc_prod_elasticity'
END IF


! 6c. JFNOCC WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lpnocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc_prod_elasticity'
END IF



! 7a. JF OF YOUNG WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_young_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_young_prod_elasticity'
END IF



! 7b. JF OF PRIME-AGED WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_prime_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_prime_prod_elasticity'
END IF


! 7c. JF WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_prod_elasticity'
END IF


!! FIVE QUARTER SMOOTHED VARS

! 6b2. JFOCC WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lpocc5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc5_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc5_prod_elasticity'
END IF


! 6c2. JFNOCC WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_lpnocc5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc5_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc5_prod_elasticity'
END IF



! 7a2. JF OF YOUNG WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf5_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_young_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_young_prod_elasticity'
END IF


! 7b2. JF OF PRIME-AGED WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf5_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_prime_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_prime_prod_elasticity'
END IF


! 7c2. JF WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ljf5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_prod_elasticity'
END IF




! X. WAGE WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_wage_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
wage_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'wage_prod_elasticity'
END IF



! XX. PROPORTIONS U WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_l_ult5wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5w_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5w_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_u5lt15wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop15w_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop15w_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_u15lt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop27w_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop27w_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ugt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropgt27w_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropgt27w_prod_elasticity'
END IF



! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_l_ult3m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult5m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult9m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_prod_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_prod_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_prod_elasticity'
END IF







! XX. SEMI-semielasticity PROPORTIONS U WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ult5wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5w_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5w_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_u5lt15wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop15w_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop15w_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_u15lt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop27w_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop27w_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ugt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropgt27w_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropgt27w_prod_semielasticity'
END IF



! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_prod_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_prod_semielasticity'
END IF

Yjf(1:tmax_qtr2-24,1)=data_ugt13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropg13m_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropg13m_prod_semielasticity'
END IF


! XX. PROPORTIONS U WITH prod_yngUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_prod_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_prod_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_prod_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_prod_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_prod_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_prod_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_prod_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_prod_yng_semielasticity'
    END IF


! XX. PROPORTIONS U WITH prod_prmUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_prod_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_prod_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_prod_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_prod_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_prod_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_prod_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_prod_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_prod_prm_semielasticity'
END IF




!!-----------------------
!! ELASTICITIES WITH UNEMPLOYMENT

Xjf(1:tmax_qtr2-24,2)=data_u_qtr(13: tmax_qtr2-12)

! 8a. SEP YOUNG WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_lsep_y_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_young_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_young_unemp_elasticity'
END IF


! 8b. SEP PRIME WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_lsep_p_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prime_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prime_unemp_elasticity'
END IF



! 8b. SEP WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_lsep_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_elasticity'
END IF

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_lsep_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_supocc_unemp_elasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'superocc_sep_unemp_semielasticity'
END IF
END DO

! 9a1. COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_inflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_inflow_unemp_elasticity'
END IF


! 9a2. YOUNG COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_young_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_young_inflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_young_inflow_unemp_elasticity'
END IF


! 9a3. PRIME COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_prime_inflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_prime_inflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_prime_inflow_unemp_elasticity'
END IF


! 9a4. OUTFLOW COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_outflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_outflow_unemp_elasticity'
END IF



! 9a5. YOUNG OUTFLOW COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_young_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_young_outflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_young_outflow_unemp_elasticity'
END IF



! 9a6. PRIME OUTFLOW COMPOSITION WITH UNEMPLOYMENT

Yjf(1:tmax_qtr2-24,1)=data_cocc_prime_outflow_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
cocc_prime_outflow_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'cocc_prime_outflow_unemp_elasticity'
END IF



! 9b. JFOCC WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_lpocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc_unemp_elasticity'
END IF


! 9c. JFNOCC WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_lpnocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc_unemp_elasticity'
END IF




! 10a. JF OF YOUNG WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_ljf_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_young_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_young_unemp_elasticity'
END IF


! 10b. JF OF PRIME-AGED WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_ljf_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_prime_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_prime_unemp_elasticity'
END IF


! 10c. JF OF ALL  WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_ljf_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_unemp_elasticity'
END IF

! 11. UDUR WITH UNEMPLOYMENT
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_ludur_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_supocc_unemp_elasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'supocc_udur_unemp_elasticity'
END IF
END DO



! 12a. ELASTICITY U w/ v
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_v_qtr(13:tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_u_qtr(13: tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
el_u_with_v=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_u_with_v'
END IF


! 12b. ELASTICITY V w/ U
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_u_qtr(13:tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_v_qtr(13: tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
el_v_with_u=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_v_with_u'
END IF


! 12c. ELASTICITY U w/ v  -- SMOOTHED
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_lv5_qtr(13:tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_lu5_qtr(13: tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
el_u5_with_v5=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_u5_with_v5'
END IF


! 12d. ELASTICITY V w/ U  -- SMOOTHED
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_lu5_qtr(13:tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_lv5_qtr(13: tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
el_v5_with_u5=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_v5_with_u5'
END IF



! 13. ELASTICITY U w/ P
Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_prod_qtr(13:tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_u_qtr(13: tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
el_u_with_p=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'el_u_with_p'
END IF



!=============================================
!   SEMI ELASTICITIES
!==============================================

!==========================================
! with output
Xjf(1:tmax_qtr2-24,2)=data_prod_qtr(13: tmax_qtr2-12)

! 1a. JF OF YOUNG WITH PROD
Yjf(1:tmax_qtr2-24,1)=data_jf_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_young_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_young_prod_semielasticity'
END IF


! 1b. JF OF PRIME-AGED WITH PROD
Yjf(1:tmax_qtr2-24,1)=data_jf_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_prime_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_prime_prod_semielasticity'
END IF



! 1c. JF OF PRIME-AGED WITH PROD
Yjf(1:tmax_qtr2-24,1)=data_jf_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_prod_semielasticity=betajf(2)
jf_prod_semielasticity=-999.99
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_prod_semielasticity'
END IF


! 2b. JFOCC WITH PROD
Yjf(1:tmax_qtr2-24,1)=data_pocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc5_prod_semielasticity=betajf(2)
jfocc_prod_semielasticity=-999.99
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc5_prod_semielasticity'
END IF


! 2c. JFNOCC WITH PROD
Yjf(1:tmax_qtr2-24,1)=data_pnocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc5_prod_semielasticity=betajf(2)
jfnocc_prod_semielasticity=-999.99
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc5_prod_semielasticity'
END IF


! 3a. SEP YOUNG WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_sep_y_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_young_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_young_prod_semielasticity'
END IF


! 3b. SEP PRIME WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_sep_p_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prime_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prime_prod_semielasticity'
END IF



! 3c. SEP WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_sep_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prod_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prod_semielasticity'
END IF

DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_sep_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_supocc_prod_semielasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_semielasticity'
END IF
    END DO

! u duration with productivity PER OCCUPATION
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_udur_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_supocc_prod_semielasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'supocc_udur_prod_semielasticity'
END IF
END DO

!===================================
! with UNEMPLOYMENT

Xjf(1:tmax_qtr2-24,2)=data_u_qtr(13: tmax_qtr2-12)

! 1a. JF OF YOUNG WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_jf_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_young_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_young_unemp_semielasticity'
END IF


! 1b. JF OF PRIME-AGED WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_jf_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_prime_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_prime_unemp_semielasticity'
END IF


! 1c. JF OF PRIME-AGED WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_jf_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf_unemp_semielasticity'
END IF


! 1.d u duration with unemployment PER OCCUPATION
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_udur_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_supocc_unemp_semielasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'supocc_udur_prod_elasticity'
END IF
END DO


! 2b. JFOCC WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_pocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc_unemp_semielasticity'
END IF


! 2c. JFNOCC WITH UNEMPLOYMENT
Yjf(1:tmax_qtr2-24,1)=data_pnocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc_unemp_semielasticity'
END IF



! 3a. SEP YOUNG WITH UNEMPL
Yjf(1:tmax_qtr2-24,1)=data_sep_y_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_young_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_young_unemp_semielasticity'
END IF


! 3b. SEP PRIME WITH UNEMPL
Yjf(1:tmax_qtr2-24,1)=data_sep_p_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_prime_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_prime_unemp_semielasticity'
END IF



! 3c. SEP WITH UNEMPL
Yjf(1:tmax_qtr2-24,1)=data_sep_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_semielasticity'
    END IF


! 3d. SEP per superocc WITH UNEMPL
DO occcnt=1, occpts
Yjf(1:tmax_qtr2-24,1)=data_supocc_sep_qtr(occcnt, 13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sep_supocc_unemp_semielasticity(occcnt)=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sep_unemp_semielasticity'
END IF
END DO


!! UNEMPLOYMENT DURATION ELASTICITY AND SEMIELASTICITY


! XX. PROPORTIONS U WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_l_ult5wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5w_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_u5lt15wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop15w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop15w_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_u15lt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop27w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop27w_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ugt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropgt27w_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropgt27w_unemp_elasticity'
END IF



! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_l_ult3m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult5m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult9m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_elasticity'
    END IF

!! YOUNG

Yjf(1:tmax_qtr2-24,1)=data_l_ult3m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_yng_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult5m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_yng_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult9m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_yng_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult13m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_yng_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_yng_elasticity'
    END IF

!! PRIME

    Yjf(1:tmax_qtr2-24,1)=data_l_ult3m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_prm_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult5m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_prm_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult9m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_prm_elasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_l_ult13m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_prm_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_prm_elasticity'
END IF



!!!!! ----> SEMI ELASTICITY WITH UNEMPLOYMENT


! XX. PROPORTIONS U WITH PRODUCTIVITY
Yjf(1:tmax_qtr2-24,1)=data_ult5wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5w_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_u5lt15wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop15w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop15w_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_u15lt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop27w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop27w_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ugt27wk_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropgt27w_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropgt27w_unemp_semielasticity'
END IF



! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_semielasticity'
    END IF

Yjf(1:tmax_qtr2-24,1)=data_ugt13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_upropg13m_unemp_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_upropg13m_unemp_semielasticity'
    END IF

!! SMOOTHED

    Yjf(1:tmax_qtr2-24,1)=data_sm5_ult3m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sm_hp_uprop3m_u_semi_el=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sm_hp_uprop3m_u_semi_el'
END IF


Yjf(1:tmax_qtr2-24,1)=data_sm5_ult5m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sm_hp_uprop5m_u_semi_el=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sm_hp_uprop5m_u_semi_el'
END IF


Yjf(1:tmax_qtr2-24,1)=data_sm5_ult9m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sm_hp_uprop9m_u_semi_el=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sm_hp_uprop9m_u_semi_el'
END IF


Yjf(1:tmax_qtr2-24,1)=data_sm5_ult13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sm_hp_uprop13m_u_semi_el=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sm_hp_uprop13m_u_semi_el'
    END IF

Yjf(1:tmax_qtr2-24,1)=data_sm5_ugt13m_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
sm_hp_upropg13m_u_semi_el=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'sm_hp_upropg13m_u_semi_el'
    END IF




!! YOUNG

    ! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_yng_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_yng_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_yng_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_yng_semielasticity'
    END IF

    !! PRIME
    ! XX. PROPORTIONS U WITH PRODUCTIVITY FROM ****** SIPP *******
Yjf(1:tmax_qtr2-24,1)=data_ult3m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop3m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop3m_unemp_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult5m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop5m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop5m_unemp_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult9m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop9m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop9m_unemp_prm_semielasticity'
END IF


Yjf(1:tmax_qtr2-24,1)=data_ult13m_prm_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
hp_uprop13m_unemp_prm_semielasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'hp_uprop13m_unemp_prm_semielasticity'
END IF


!! FIVE QUARTER SMOOTHED VARS

! 6b2. JFOCC WITH UNEMP
Yjf(1:tmax_qtr2-24,1)=data_lpocc5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfocc5_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfocc5_unemp_elasticity'
END IF


! 6c2. JFNOCC WITH UNEMP
Yjf(1:tmax_qtr2-24,1)=data_lpnocc5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jfnocc5_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jfnocc5_unemp_elasticity'
END IF



! 7a2. JF OF YOUNG WITH UNEMP
Yjf(1:tmax_qtr2-24,1)=data_ljf5_young_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_young_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_young_unemp_elasticity'
END IF


! 7b2. JF OF PRIME-AGED WITH UNEMP
Yjf(1:tmax_qtr2-24,1)=data_ljf5_prime_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_prime_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_prime_unemp_elasticity'
END IF


! 7c2. JF WITH UNEMP
Yjf(1:tmax_qtr2-24,1)=data_ljf5_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
jf5_unemp_elasticity=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'jf5_unemp_elasticity'
END IF



!! XXX DURATION BEHAVIOR: ABS CHANGES

Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_occ_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_occ_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_with_hpu'
END IF


Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_young_occ_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_occ_young_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_young_with_hpu'
END IF


Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_prime_occ_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_occ_prime_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_occ_prime_with_hpu'
END IF



Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_nocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_nocc_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_with_hpu'
END IF


Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_young_nocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_nocc_young_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_young_with_hpu'
END IF


Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_prime_nocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_nocc_prime_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_prime_with_hpu'
END IF

Xjf(:,1)=1
Xjf(1:tmax_qtr2-24,2)=data_ulev_qtr(13: tmax_qtr2-12)
Yjf(1:tmax_qtr2-24,1)=data_ucompldur_prime_nocc_qtr(13:tmax_qtr2-12)
CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
udur_nocc_prime_with_hpu=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'udur_nocc_prime_with_hpu'
END IF



!!! MUELLER MOMENTS

Xjf(:,1)=1
tcnt=0
DO t=1,(tmax_qtr2/4)
    IF(mask_qtr(4*t-2)== .TRUE. .AND. mask_qtr(4*t-6)== .TRUE. .AND. mask_qtr(4*t-10)== .TRUE. &
        .AND. mask_qtr(4*t+2)== .TRUE. .AND. mask_qtr(4*t+6)== .TRUE. .AND. mask_qtr(4*t+10)== .TRUE.) THEN
        tcnt=tcnt+1
        Xjf(tcnt,2)=data_u_yr(t)
        Yjf(tcnt,1)=data_sep_y_yr(t)-data_sep_p_yr(t)
    END IF
END DO
CALL multivar_regression(Yjf(1:tcnt,:), Xjf(1:tcnt,:), tcnt, 2, betajf,errmsg)
cycl_sep_age_shift_muellermom=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'MUELLER MOMENT REGRESSION SEP'
END IF

 !       data_jf_y_yr
    !       data_jf_p_yr
    !       data_u_y_yr
    !       data_u_p_yr

! job finding
DO t=1,tmax_qtr2/4-8
    Xjf(t,2)=data_u_yr(t+4)
    Yjf(t,1)=data_jf_y_yr(t+4)-data_jf_p_yr(t+4)
END DO
CALL multivar_regression(Yjf(1:(tmax_qtr2/4-8),:), Xjf(1:(tmax_qtr2/4-8),:), (tmax_qtr2/4-8), 2, betajf,errmsg)
cycl_jf_age_shift_muellermom=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'MUELLER MOMENT REGRESSION JF'
    END IF


! unemployment
DO t=1,tmax_qtr2/4-8
    Xjf(t,2)=data_u_yr(t+4)
    Yjf(t,1)=data_u_y_yr(t+4)-data_u_p_yr(t+4)
END DO
CALL multivar_regression(Yjf(1:(tmax_qtr2/4-8),:), Xjf(1:(tmax_qtr2/4-8),:), (tmax_qtr2/4-8), 2, betajf,errmsg)
cycl_u_age_shift_muellermom=betajf(2)
IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
    WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
    WRITE(10, '(14(F10.4))') thetal
    WRITE(10,*) 'MUELLER MOMENT REGRESSION U'
    END IF


!!==========================================
!!  DURATION REGRESSIONS Occ/Nocc with the cycle
!!==========================================

IF(verbose_progress) WRITE(*,*) '    !!  DURATION REGRESSIONS Occ/Nocc with the cycle  '


!hpfilterfactor already defined
counter1=tmax_qtr2
!!$OMP CRITICAL
!ALLOCATE(data_temp_qtr(counter1), data_temp_qtr2(counter1))
!!$OMP END CRITICAL

udur_mvec_occ_with_u=0.0_8
udur_mvec_occ_young_with_u=0.0_8
udur_mvec_occ_prime_with_u=0.0_8
udur_mvec_nocc_with_u=0.0_8
udur_mvec_nocc_young_with_u=0.0_8
udur_mvec_nocc_prime_with_u=0.0_8

udur_mvec_occ_with_hpu=0.0_8
udur_mvec_occ_young_with_hpu=0.0_8
udur_mvec_occ_prime_with_hpu=0.0_8
udur_mvec_nocc_with_hpu=0.0_8
udur_mvec_nocc_young_with_hpu=0.0_8
udur_mvec_nocc_prime_with_hpu=0.0_8

!udur_mvec_occ_with_lu=0.0_8
!udur_mvec_occ_young_with_lu=0.0_8
!udur_mvec_occ_prime_with_lu=0.0_8
!udur_mvec_nocc_with_lu=0.0_8
!udur_mvec_nocc_young_with_lu=0.0_8
!udur_mvec_nocc_prime_with_lu=0.0_8
!
!
!udur_mvec_occ_with_hplu=0.0_8
!udur_mvec_occ_young_with_hplu=0.0_8
!udur_mvec_occ_prime_with_hplu=0.0_8
!udur_mvec_nocc_with_hplu=0.0_8
!udur_mvec_nocc_young_with_hplu=0.0_8
!udur_mvec_nocc_prime_with_hplu=0.0_8

! ---- occ changers - ALL ----


DO xcnt=1,6
    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_cocc_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_cocc_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt

    ! quarterly ts average
    ! udur_mvec_occ_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(13:tmax_qtr2-12,:), Xjf(13:tmax_qtr2-12,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_with_u(xcnt)'
    END IF



    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr
    !WRITE(*,*) 'tmax_qtr2=', tmax_qtr2
    !WRITE(*,*) 'tmax_mask_swindow_qtr=', tmax_mask_swindow_qtr

    ! U 13-18m
    !CALL HPFILT2(data_l_ugt13m_qtr(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    !data_l_ugt13m_qtr  (1:counter1)=data_temp_qtr(1:counter1)

    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)
    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)

    Yjf(1:counter1,1)=data_temp_qtr(1:tmax_qtr2-2)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_with_hpu(xcnt)'
    END IF
    !WRITE(*,*) 'udur_mvec_occ_with_hpu(xcnt)=',udur_mvec_occ_with_hpu(xcnt)



END DO !xcnt

! ---- occ changers - YOUNG ----
DO xcnt=1,6
    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_cocc_young_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_cocc_young_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt

    ! quarterly ts average
    !udur_mvec_occ_young_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(13:tmax_qtr2-12,:), Xjf(13:tmax_qtr2-12,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_young_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_young_with_u(xcnt)'
    END IF
    !WRITE(*,*) 'udur_mvec_occ_young_with_u(xcnt)=',udur_mvec_occ_young_with_u(xcnt)


    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr
    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)

    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    !WRITE(*,*) 'done hp filter udur_mvec_occ_young_with_hpu(xcnt)'
    Yjf(1:counter1,1)=data_temp_qtr(1:counter1)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_young_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_young_with_hpu(xcnt)'
    END IF
    !WRITE(*,*) 'done full calculation udur_mvec_occ_young_with_hpu(', xcnt, ')'

END DO !xcnt


! ---- occ changers - PRIME ----
DO xcnt=1,6
    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_cocc_prime_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_cocc_prime_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt


    ! quarterly ts average
    !udur_mvec_occ_prime_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)

    CALL multivar_regression(Yjf(13:tmax_qtr2-12,:), Xjf(13:tmax_qtr2-12,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_prime_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_prime_with_u(xcnt)'
    END IF


    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr

    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)
    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)

    Yjf(1:counter1,1)=data_temp_qtr(1:counter1)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_occ_prime_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_occ_prime_with_hpu(xcnt)'
    END IF


END DO !xcnt
IF(verbose_progress) WRITE(*,*) 'NOW DURATION OF OCCUPATIONS STAYERS AND CYCLE'

! ---- nocc stayers - ALL ----
DO xcnt=1,6

    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_nocc_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_nocc_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt


    ! quarterly ts average
    !udur_mvec_nocc_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)

    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_with_u(xcnt)'
    END IF


    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr
    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)
    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    Yjf(1:counter1,1)=data_temp_qtr(1:counter1)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_with_hpu(xcnt)'
    END IF


END DO !xcnt

! ---- nocc stayers - YOUNG ----
DO xcnt=1,6
    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_nocc_young_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_nocc_young_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt



    ! quarterly ts average
    ! udur_mvec_nocc_young_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_young_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_young_with_u(xcnt)'
    END IF


    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr
    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)
    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)

    Yjf(1:counter1,1)=data_temp_qtr(1:counter1)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_young_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_young_with_hpu(xcnt)'
    END IF


END DO !xcnt


! ---- nocc stayers - PRIME ----
DO xcnt=1,6
    DO tcnt=1, tmax_qtr2

        tempreal=0.0_8
        DO zcnt=xcnt, 18
        tempreal=tempreal+data_compduration_nocc_prime_qtr(tcnt,zcnt)*REAL(zcnt)
        END DO !zcnt

        IF(tempreal>0.0_8) THEN
            tempreal=tempreal/sum(data_compduration_nocc_prime_qtr(tcnt,xcnt:18))
        ELSE IF (tempreal==0.0_8) THEN
            tempreal=0.0_8
        END IF

        Yjf(tcnt,1)=tempreal

    END DO !tcnt


    ! quarterly ts average
    ! udur_mvec_nocc_prime_ave(xcnt)=sum(Yjf(1:tmax_qtr2-2,1))/REAL(tmax_qtr2-2)

    ! run overall regression
    Xjf(:,1)=1
    Xjf(:,2)=data_uraw_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_prime_with_u(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_prime_with_u'
    END IF


    ! run HP filtered regression on hpu levels
    counter1=tmax_qtr2
    counter2=tmax_mask_swindow_qtr
    data_temp_qtr2(1:counter1)=Yjf(1:counter1,1)
    CALL HPFILT2(data_temp_qtr2(1:counter1),data_temp_qtr, counter2, counter1,hpfilterfactor,0)
    Yjf(1:counter1,1)=data_temp_qtr(1:counter1)
    Xjf(:,1)=1
    Xjf(:,2)=data_ulev_qtr(1: tmax_qtr2-2)
    CALL multivar_regression(Yjf(1:tmax_qtr2-24,:), Xjf(1:tmax_qtr2-24,:), tmax_qtr2-24, 2, betajf,errmsg)
    udur_mvec_nocc_prime_with_hpu(xcnt)=betajf(2)
    IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
        WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
        WRITE(10, '(14(F10.4))') thetal
        WRITE(10,*) 'udur_mvec_nocc_prime_with_hpu'
    END IF


    END DO !xcnt


    !DO tcnt=1, tmax_qtr2
    !
    !    tempreal=0.0_8
    !    DO zcnt=xcnt, 18
    !    tempreal=tempreal+data_compduration_cocc_qtr(tcnt,zcnt)*REAL(zcnt)
    !    END DO !zcnt
    !
    !    IF(tempreal>0.0_8) THEN
    !        tempreal=tempreal/sum(data_compduration_cocc_qtr(tcnt,xcnt:18))
    !    ELSE IF (tempreal==0.0_8) THEN
    !        tempreal=0.0_8
    !    END IF
    !
    !    Yjf(tcnt,1)=tempreal
    !
    !END DO !tcnt
    !
    !

moverstayer_regr_lindetrending_if: &
IF(moverstayer_regr_lindetrending==1 ) THEN
        !--- ONLY ALL WORKERS' RESPONSE IS LINEARLY DETRENDED, FOR OCC AND NOCC, BUT FOR 4 DIFFERENT MEASURES OF UNEMPLOYMENT (2x UNEMP, 2x HP FILTERED)
        !--- ALSO GET RID OF THE CONSTANT, JUST TO DEAL WITH THE RESIDUALS

        IF(verbose_progress) WRITE(*,*) 'entering  moverstayer_regr_lindetrending'

        !tmax_swindow_qtr=tmax_swindow_wks_raw/12
        !data_ucompldur_nocc_qtr, data_ucompldur_occ_qtr
        !tempcounter=((tmax_qtr-2)/tmax_swindow_qtr)
        !tempcounter2=tempcounter*tmax_swindow_qtr       ! maximum time for all full superwindows

                        ! linearly detrend data_ucompldur_nocc_qtr

                        Xjf(:,1)=1

                        ! data_ucompldur_nocc_qtr is already HP FILTERED, so have to reconstruct it

                        DO tcnt=1, tmax_qtr2

                            tempreal=0.0_8
                            DO zcnt=1, 18
                            tempreal=tempreal+data_compduration_nocc_qtr(tcnt,zcnt)*REAL(zcnt)
                            END DO !zcnt

                            IF(tempreal>0.0_8) THEN
                                tempreal=tempreal/sum(data_compduration_nocc_qtr(tcnt,1:18))
                            ELSE IF (tempreal==0.0_8) THEN
                                tempreal=0.0_8
                            END IF

                            Yjf(tcnt,1)=tempreal

                        END DO


                        !DO counter1=1, tempcounter2, tmax_swindow_qtr       ! cycle through superwindows
                        !    tempcounter1=counter1+tmax_swindow_qtr-1          ! tempcounter1 is maximum time within superwindow
                        !    DO tcnt=1, tmax_swindow_qtr
                        !        Xjf(counter1+tcnt-1,2)=REAL(tcnt)
                        !    END DO
                        !    ! linear detrending within superwindow: estimate
                        !    CALL multivar_regression(Yjf(counter1:tempcounter1,:), Xjf(counter1:tempcounter1,:), tmax_swindow_qtr, 2, betajf,errmsg)
                        !        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                        !            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                        !            WRITE(10,*) 'linear detrending data_ucompldur_nocc_qtr'
                        !        END IF
                        !
                        !        ! linear detrending within superwindow: residuals of estimation
                        !        DO tcnt=1, tmax_swindow_qtr
                        !        data_ucompldur_nocc_qtr(counter1+tcnt-1)=Yjf(counter1+tcnt-1,1)-betajf(1)-betajf(2)*Xjf(counter1+tcnt-1,2)
                        !        END DO
                        !END DO
                        data_temp_qtr2(1:tmax_qtr2)=Yjf(1:tmax_qtr2,1)
                        CALL LINDETREND_WINDOWS(tmax_qtr2, data_temp_qtr2(1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
                        data_ucompldur_nocc_qtr(1:tmax_qtr2)=data_temp_qtr(1:tmax_qtr2)



                        ! data_ucompldur_occ_qtr is already HP FILTERED, so have to reconstruct it

                        DO tcnt=1, tmax_qtr2

                            tempreal=0.0_8
                            DO zcnt=1, 18
                            tempreal=tempreal+data_compduration_cocc_qtr(tcnt,zcnt)*REAL(zcnt)
                            END DO !zcnt

                            IF(tempreal>0.0_8) THEN
                                tempreal=tempreal/sum(data_compduration_cocc_qtr(tcnt,1:18))
                            ELSE IF (tempreal==0.0_8) THEN
                                tempreal=0.0_8
                            END IF

                            Yjf(tcnt,1)=tempreal

                        END DO

                        data_temp_qtr2(1:tmax_qtr2)=Yjf(1:tmax_qtr2,1)
                        CALL LINDETREND_WINDOWS(tmax_qtr2, data_temp_qtr2(1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
                        data_ucompldur_occ_qtr(1:tmax_qtr2)=data_temp_qtr(1:tmax_qtr2)



                        !!=== LINEARLY DETRENDED U LEVEL SE
                        !! RUN REGRESSIONS
                        !! 1) NOCC DUR ON LIN DETRENDED U (LEVEL)
                        !! 2) OCC DUR ON LIN DETRENDED U (LEVEL)

                        !! 1) NOCC DUR ON LIN DETRENDED U (LEVEL)
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_nocc_qtr(1:tmax_qtr2)
                        Xjf(:,1)=1
                        CALL LINDETREND_WINDOWS(tmax_qtr2, data_uraw_qtr(1:tmax_qtr2), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
                        Xjf(1:tmax_qtr2,2)=data_temp_qtr(1:tmax_qtr2)
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_nocc_with_u=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_nocc_with_u LIN DETRENDED'
                        END IF


                        ! linearly detrend data_u  logged: data_temp_qtr2
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_occ_qtr(1:tmax_qtr2)
                        !Xjf(:,1)=1
                        !Xjf(:,2) ALREADY SET TO DATA_URAW_QTR LINEARLY DETRENDED ABOVE
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_occ_with_u=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_occ_with_u LIN DETRENDED'
                        END IF

            !!=== LINEARLY DETRENDED U LOG SERIES

                        !! RUN REGRESSIONS
                        !! 3) NOCC DUR ON LIN DETRENDED U (LOG)
                        !! 4) OCC DUR ON LIN DETRENDED U (LOG)

                        !! 3) NOCC DUR ON LIN DETRENDED U (LOG)
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_nocc_qtr(1:tmax_qtr2)
                        Xjf(:,1)=1
                        CALL LINDETREND_WINDOWS(tmax_qtr2, log(data_uraw_qtr(1:tmax_qtr2)), data_temp_qtr(1:tmax_qtr2), tmax_qtr2, tmax_mask_swindow_qtr)
                        Xjf(1:tmax_qtr2,2)=data_temp_qtr(1:tmax_qtr2)
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_nocc_with_lu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_nocc_with_lu LIN DETRENDED'
                        END IF

                        !! 4) OCC DUR ON LIN DETRENDED U (LOG)
                        ! linearly detrend data_u  logged: data_temp_qtr2
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_occ_qtr(1:tmax_qtr2)
                        !Xjf(:,1)=1
                        !Xjf(:,2) ALREADY SET TO DATA_URAW_QTR LOG LINEARLY DETRENDED ABOVE
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_occ_with_lu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_occ_with_lu LIN DETRENDED'
                        END IF



                        !!=== HP FILTERED U LEVEL SERIES WITHIN SUPERWINDOW






                        !! REGRESSIONS
                        !! 5) NOCC DURATION WITH HP U
                        !! 6) OCC UDURATION WITH HP U

                        !! 5) NOCC DUR ON HP FILTERED U (LEVEL)
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_nocc_qtr(1:tmax_qtr2)
                        Xjf(:,1)=1
                        Xjf(1:tmax_qtr2,2)=data_ulev_qtr(1:tmax_qtr2)
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_nocc_with_hpu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_nocc_with_hpu HPF + LIN DETRENDED'
                        END IF

                        !! 6) OCC DUR ON HP FILTERED U (LEVEL)
                        ! linearly detrend data_u  logged: data_temp_qtr2
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_occ_qtr(1:tmax_qtr2)
                        !Xjf(:,1)=1
                        !Xjf(:,2) ALREADY SET TO DATA_URAW_QTR HP FILTERED ABOVE
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_occ_with_hpu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_occ_with_hpu HPF+ LIN DETRENDED'
                        END IF


                        !! LOG UNEMPLOYMENT RATE -  HP FILTERING
                        !! 7) NOCC DURATION WITH HP LOG U
                        !! 8) OCC UDURATION WITH HP LOG U

                        !! 7) NOCC DUR ON HP FILTERED U (LOG )
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_nocc_qtr(1:tmax_qtr2)
                        Xjf(:,1)=1
                        Xjf(1:tmax_qtr2,2)=data_u_qtr(1:tmax_qtr2)
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_nocc_with_hplu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_nocc_with_hplu HPF + LIN DETRENDED'
                        END IF

                        !! 8) OCC DUR ON HP FILTERED U (LOG )
                        ! linearly detrend data_u  logged: data_temp_qtr2
                        Yjf(1:tmax_qtr2,1)=data_ucompldur_occ_qtr(1:tmax_qtr2)
                        Xjf(:,1)=1
                        !Xjf(:,2) ALREADY SET TO DATA_URAW_QTR LOG HP FILTERED ABOVE
                        CALL multivar_regression(Yjf(1:tmax_qtr2,:), Xjf(1:tmax_qtr2,:), tmax_qtr2, 2, betajf,errmsg)
                        udur_occ_with_hplu=betajf(2)
                        IF(errmsg>0 .AND. print_regress_errmsg_ind==1) THEN
                            WRITE(10,*) 'error in regression, code:', errmsg, 'data/time', time_string(1), time_string(2)
                            WRITE(10, '(14(F10.4))') thetal
                            WRITE(10,*) 'udur_occ_with_hplu HPF+ LIN DETRENDED'
                        END IF



END IF moverstayer_regr_lindetrending_if


IF(verbose_progress) WRITE(*,*) 'passed duration responses part'

!$OMP CRITICAL
!DEALLOCATE(data_temp_qtr, data_temp_qtr2)
DEALLOCATE(Xjf, Yjf)
!$OMP END CRITICAL

IF(verbose_progress) WRITE(*,*) 'passed deallocation part, prevarcalcul'





hp_var_uprop_3m_ave=VARCALCUL(data_ult3m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_5m_ave=VARCALCUL(data_ult5m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_9m_ave=VARCALCUL(data_ult9m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_13m_ave=VARCALCUL(data_ult13m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_3m_ave=VARCALCUL(data_l_ult3m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_5m_ave=VARCALCUL(data_l_ult5m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_9m_ave=VARCALCUL(data_l_ult9m_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_13m_ave=VARCALCUL(data_l_ult13m_qtr(1:tmax_qtr2), tmax_qtr2)

hp_var_uprop_yng_3m_ave=VARCALCUL(data_ult3m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_yng_5m_ave=VARCALCUL(data_ult5m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_yng_9m_ave=VARCALCUL(data_ult9m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_yng_13m_ave=VARCALCUL(data_ult13m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_yng_3m_ave=VARCALCUL(data_l_ult3m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_yng_5m_ave=VARCALCUL(data_l_ult5m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_yng_9m_ave=VARCALCUL(data_l_ult9m_yng_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_yng_13m_ave=VARCALCUL(data_l_ult13m_yng_qtr(1:tmax_qtr2), tmax_qtr2)


hp_var_uprop_prm_3m_ave=VARCALCUL(data_ult3m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_prm_5m_ave=VARCALCUL(data_ult5m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_prm_9m_ave=VARCALCUL(data_ult9m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_uprop_prm_13m_ave=VARCALCUL(data_ult13m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_prm_3m_ave=VARCALCUL(data_l_ult3m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_prm_5m_ave=VARCALCUL(data_l_ult5m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_prm_9m_ave=VARCALCUL(data_l_ult9m_prm_qtr(1:tmax_qtr2), tmax_qtr2)
hp_var_l_uprop_prm_13m_ave=VARCALCUL(data_l_ult13m_prm_qtr(1:tmax_qtr2), tmax_qtr2)



!!========================================
!! NET MOB OVER THE CYCLE STATS
!!========================================

    !! SUPEROCC 1 CHANGERS DIRECTION
                   tempreal=sum(data_corr_superocc_transmatrix_allptile(1,:))
                   data_corr_superocc_transmatrix_forreal(1,1)=data_corr_superocc_transmatrix_allptile(1,1)/tempreal
                   data_corr_superocc_transmatrix_forreal(1,2)=data_corr_superocc_transmatrix_allptile(1,2)/tempreal
                   data_corr_superocc_transmatrix_forreal(1,3)=data_corr_superocc_transmatrix_allptile(1,3)/tempreal
                   data_corr_superocc_transmatrix_forreal(1,4)=data_corr_superocc_transmatrix_allptile(1,4)/tempreal

    !! SUPEROCC 2 CHANGERS DIRECTION
                   tempreal=sum(data_corr_superocc_transmatrix_allptile(2,:))
                   data_corr_superocc_transmatrix_forreal(2,1)=data_corr_superocc_transmatrix_allptile(2,1)/tempreal
                   data_corr_superocc_transmatrix_forreal(2,2)=data_corr_superocc_transmatrix_allptile(2,2)/tempreal
                   data_corr_superocc_transmatrix_forreal(2,3)=data_corr_superocc_transmatrix_allptile(2,3)/tempreal
                   data_corr_superocc_transmatrix_forreal(2,4)=data_corr_superocc_transmatrix_allptile(2,4)/tempreal

    !! SUPEROCC 3 CHANGERS DIRECTION
                   tempreal=sum(data_corr_superocc_transmatrix_allptile(3,:))
                   data_corr_superocc_transmatrix_forreal(3,1)=data_corr_superocc_transmatrix_allptile(3,1)/tempreal
                   data_corr_superocc_transmatrix_forreal(3,2)=data_corr_superocc_transmatrix_allptile(3,2)/tempreal
                   data_corr_superocc_transmatrix_forreal(3,3)=data_corr_superocc_transmatrix_allptile(3,3)/tempreal
                   data_corr_superocc_transmatrix_forreal(3,4)=data_corr_superocc_transmatrix_allptile(3,4)/tempreal

    !! SUPEROCC 4 CHANGERS DIRECTION
                   tempreal=sum(data_corr_superocc_transmatrix_allptile(4,:))
                   data_corr_superocc_transmatrix_forreal(4,1)=data_corr_superocc_transmatrix_allptile(4,1)/tempreal
                   data_corr_superocc_transmatrix_forreal(4,2)=data_corr_superocc_transmatrix_allptile(4,2)/tempreal
                   data_corr_superocc_transmatrix_forreal(4,3)=data_corr_superocc_transmatrix_allptile(4,3)/tempreal
                   data_corr_superocc_transmatrix_forreal(4,4)=data_corr_superocc_transmatrix_allptile(4,4)/tempreal




tempreal=sum(data_corr_superocc_transmatrix_allptile(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow(occcnt)=(sum(data_corr_superocc_transmatrix_allptile(occcnt,:))-data_corr_superocc_transmatrix_allptile(occcnt,occcnt))/tempreal
    corr_supocc_inflow(occcnt)=(sum(data_corr_superocc_transmatrix_allptile(:,occcnt))-data_corr_superocc_transmatrix_allptile(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix(:,:))
DO occcnt=1, occpts
    supocc_outflow(occcnt)=(sum(data_superocc_transmatrix(occcnt,:))-data_superocc_transmatrix(occcnt,occcnt))/tempreal
    supocc_inflow(occcnt)=(sum(data_superocc_transmatrix(:,occcnt))-data_superocc_transmatrix(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_corr_superocc_transmatrix_p33(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p33(occcnt)=(sum(data_corr_superocc_transmatrix_p33(occcnt,:))-data_corr_superocc_transmatrix_p33(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p33(occcnt)=(sum(data_corr_superocc_transmatrix_p33(:,occcnt))-data_corr_superocc_transmatrix_p33(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p33(:,:))
DO occcnt=1, occpts
    supocc_outflow_p33(occcnt)=(sum(data_superocc_transmatrix_p33(occcnt,:))-data_superocc_transmatrix_p33(occcnt,occcnt))/tempreal
    supocc_inflow_p33(occcnt)=(sum(data_superocc_transmatrix_p33(:,occcnt))-data_superocc_transmatrix_p33(occcnt,occcnt))/tempreal
    END DO


tempreal=sum(data_corr_superocc_transmatrix_p50(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p50(occcnt)=(sum(data_corr_superocc_transmatrix_p50(occcnt,:))-data_corr_superocc_transmatrix_p50(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p50(occcnt)=(sum(data_corr_superocc_transmatrix_p50(:,occcnt))-data_corr_superocc_transmatrix_p50(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p50(:,:))
DO occcnt=1, occpts
    supocc_outflow_p50(occcnt)=(sum(data_superocc_transmatrix_p50(occcnt,:))-data_superocc_transmatrix_p50(occcnt,occcnt))/tempreal
    supocc_inflow_p50(occcnt)=(sum(data_superocc_transmatrix_p50(:,occcnt))-data_superocc_transmatrix_p50(occcnt,occcnt))/tempreal
    END DO


tempreal=sum(data_corr_superocc_transmatrix_p67(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p67(occcnt)=(sum(data_corr_superocc_transmatrix_p67(occcnt,:))-data_corr_superocc_transmatrix_p67(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p67(occcnt)=(sum(data_corr_superocc_transmatrix_p67(:,occcnt))-data_corr_superocc_transmatrix_p67(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p67(:,:))
DO occcnt=1, occpts
    supocc_outflow_p67(occcnt)=(sum(data_superocc_transmatrix_p67(occcnt,:))-data_superocc_transmatrix_p67(occcnt,occcnt))/tempreal
    supocc_inflow_p67(occcnt)=(sum(data_superocc_transmatrix_p67(:,occcnt))-data_superocc_transmatrix_p67(occcnt,occcnt))/tempreal
    END DO

!! FOR DATA TOO


tempreal=sum(data_corr_superocc_transmatrix_data(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_data(occcnt)=(sum(data_corr_superocc_transmatrix_data(occcnt,:))-data_corr_superocc_transmatrix_data(occcnt,occcnt))/tempreal
    corr_supocc_inflow_data(occcnt)=(sum(data_corr_superocc_transmatrix_data(:,occcnt))-data_corr_superocc_transmatrix_data(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_data(:,:))
DO occcnt=1, occpts
    supocc_outflow_data(occcnt)=(sum(data_superocc_transmatrix_data(occcnt,:))-data_superocc_transmatrix_data(occcnt,occcnt))/tempreal
    supocc_inflow_data(occcnt)=(sum(data_superocc_transmatrix_data(:,occcnt))-data_superocc_transmatrix_data(occcnt,occcnt))/tempreal
END DO


tempreal=sum(data_corr_superocc_transmatrix_p33_data(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p33_data(occcnt)=(sum(data_corr_superocc_transmatrix_p33_data(occcnt,:))-data_corr_superocc_transmatrix_p33_data(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p33_data(occcnt)=(sum(data_corr_superocc_transmatrix_p33_data(:,occcnt))-data_corr_superocc_transmatrix_p33_data(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p33(:,:))
DO occcnt=1, occpts
    supocc_outflow_p33_data(occcnt)=(sum(data_superocc_transmatrix_p33_data(occcnt,:))-data_superocc_transmatrix_p33_data(occcnt,occcnt))/tempreal
    supocc_inflow_p33_data(occcnt)=(sum(data_superocc_transmatrix_p33_data(:,occcnt))-data_superocc_transmatrix_p33_data(occcnt,occcnt))/tempreal
END DO


tempreal=sum(data_corr_superocc_transmatrix_p50_data(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p50_data(occcnt)=(sum(data_corr_superocc_transmatrix_p50_data(occcnt,:))-data_corr_superocc_transmatrix_p50_data(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p50_data(occcnt)=(sum(data_corr_superocc_transmatrix_p50_data(:,occcnt))-data_corr_superocc_transmatrix_p50_data(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p50_data(:,:))
DO occcnt=1, occpts
    supocc_outflow_p50_data(occcnt)=(sum(data_superocc_transmatrix_p50_data(occcnt,:))-data_superocc_transmatrix_p50_data(occcnt,occcnt))/tempreal
    supocc_inflow_p50_data(occcnt)=(sum(data_superocc_transmatrix_p50_data(:,occcnt))-data_superocc_transmatrix_p50_data(occcnt,occcnt))/tempreal
    END DO


tempreal=sum(data_corr_superocc_transmatrix_p67_data(:,:))
DO occcnt=1, occpts
    corr_supocc_outflow_p67_data(occcnt)=(sum(data_corr_superocc_transmatrix_p67_data(occcnt,:))-data_corr_superocc_transmatrix_p67_data(occcnt,occcnt))/tempreal
    corr_supocc_inflow_p67_data(occcnt)=(sum(data_corr_superocc_transmatrix_p67_data(:,occcnt))-data_corr_superocc_transmatrix_p67_data(occcnt,occcnt))/tempreal
END DO

tempreal=sum(data_superocc_transmatrix_p67_data(:,:))
DO occcnt=1, occpts
    supocc_outflow_p67_data(occcnt)=(sum(data_superocc_transmatrix_p67_data(occcnt,:))-data_superocc_transmatrix_p67_data(occcnt,occcnt))/tempreal
    supocc_inflow_p67_data(occcnt)=(sum(data_superocc_transmatrix_p67_data(:,occcnt))-data_superocc_transmatrix_p67_data(occcnt,occcnt))/tempreal
END DO




IF(verbose_progress) WRITE(*,*) 'passed deallocation part, post-varcalcul'




write_unit10_if: &
    IF(verbose_results_l1==1) THEN
    WRITE(10,*) ' '
    WRITE(10,*) '======> elasticity of jf wrt theta:', elmatching_ave
    WRITE(10,*) ' '
    WRITE(10,*) '=============> ELASTICITY WITH PRODUCTIVITY (M/D) <======'
    WRITE(10,*) '======> unemployment:', unemp_prod_elasticity, '*', unemp_prod_elasticity_data
    WRITE(10,*) '======> unempl young:', u_young_prod_elasticity
    WRITE(10,*) '======> unempl prime:', u_prime_prod_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> jf          :', jf_prod_elasticity
    WRITE(10,*) '======> jfocc       :', jfocc_prod_elasticity
    WRITE(10,*) '======> jfnocc      :', jfnocc_prod_elasticity
    WRITE(10,*) '======> jf young    :', jf_young_prod_elasticity
    WRITE(10,*) '======> jf prime    :', jf_prime_prod_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> jf 5q       :', jf5_prod_elasticity, '*', jf5_prod_elasticity_data
    WRITE(10,*) '======> jfocc 5q    :', jfocc5_prod_elasticity, '*', jfocc5_prod_elasticity_data
    WRITE(10,*) '======> jfnocc 5q   :', jfnocc5_prod_elasticity, '*', jfnocc5_prod_elasticity_data
    WRITE(10,*) '======> jf young 5q :', jf5_young_prod_elasticity, '*', jf5_young_prod_elasticity_data
    WRITE(10,*) '======> jf prime 5q :', jf5_prime_prod_elasticity, '*', jf5_prime_prod_elasticity_data
    WRITE(10,*) '  '
    WRITE(10,*) '======> sep         :', sep_prod_elasticity, '*', sep_prod_elasticity_data
    WRITE(10,*) '======> sep young   :', sep_young_prod_elasticity, '*', sep_young_prod_elasticity_data
    WRITE(10,*) '======> sep sep     :', sep_prime_prod_elasticity, '*', sep_prime_prod_elasticity_data
    WRITE(10,*) '======> comp        :', cocc_inflow_prod_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> cm outfl    :', cocc_outflow_prod_elasticity, '*', cocc_outflow_prod_elasticity_data
    WRITE(10,*) '======> cm outfl y  :', cocc_young_outflow_prod_elasticity, '*', cocc_young_outflow_prod_elasticity_data
    WRITE(10,*) '======> cm outfl p  :', cocc_prime_outflow_prod_elasticity, '*', cocc_prime_outflow_prod_elasticity_data


    WRITE(10,*) '======> wage        :', wage_prod_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> prop u<5wk  :', hp_uprop5w_prod_elasticity, '*', hp_uprop5w_prod_elasticity_data
    WRITE(10,*) '======> prop u5-15wk:', hp_uprop15w_prod_elasticity, '*', hp_uprop15w_prod_elasticity_data
    WRITE(10,*) '======> prop u15-27w:', hp_uprop27w_prod_elasticity, '*', hp_uprop27w_prod_elasticity_data
    WRITE(10,*) '======> prop u>27wk :', hp_upropgt27w_prod_elasticity, '*', hp_upropgt27w_prod_elasticity_data
    WRITE(10,*) '  '
    WRITE(10,*) '======> prop u<3m  :', hp_uprop3m_prod_elasticity, '*', hp_uprop3m_prod_elasticity_data
    WRITE(10,*) '======> prop u<5m  :', hp_uprop5m_prod_elasticity, '*', hp_uprop5m_prod_elasticity_data
    WRITE(10,*) '======> prop u5-9  :', hp_uprop9m_prod_elasticity, '*', hp_uprop9m_prod_elasticity_data
    WRITE(10,*) '======> prop u9-13 :', hp_uprop13m_prod_elasticity, '*', hp_uprop13m_prod_elasticity_data

    WRITE(10,*) '  '
    WRITE(10,*) '=============> ELASTICITY WITH UNEMPLOYMENT <======'
    WRITE(10,*) '======> jf          :', jf_unemp_elasticity
    WRITE(10,*) '======> jfocc       :', jfocc_unemp_elasticity
    WRITE(10,*) '======> jfnocc      :', jfnocc_unemp_elasticity
    WRITE(10,*) '======> jf young    :', jf_young_unemp_elasticity
    WRITE(10,*) '======> jf prime    :', jf_prime_unemp_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> jf 5q       :', jf5_unemp_elasticity, '*', jf5_unemp_elasticity_data
    WRITE(10,*) '======> jfocc 5q    :', jfocc5_unemp_elasticity, '*', jfocc5_unemp_elasticity_data
    WRITE(10,*) '======> jfnocc 5q   :', jfnocc5_unemp_elasticity, '*', jfnocc5_unemp_elasticity_data
    WRITE(10,*) '======> jf young 5q :', jf5_young_unemp_elasticity, '*', jf5_young_unemp_elasticity_data
    WRITE(10,*) '======> jf prime 5q :', jf5_prime_unemp_elasticity, '*', jf5_prime_unemp_elasticity_data
    WRITE(10,*) '  '
    WRITE(10,*) '======> sep         :', sep_unemp_elasticity, '*', sep_unemp_elasticity_data
    WRITE(10,*) '======> sep young   :', sep_young_unemp_elasticity, '*', sep_young_unemp_elasticity_data
    WRITE(10,*) '======> sep prime   :', sep_prime_unemp_elasticity, '*', sep_prime_unemp_elasticity_data
    WRITE(10,*) '  '

    WRITE(10,*) '======> comp infl   :', cocc_inflow_unemp_elasticity
    WRITE(10,*) '  '
    WRITE(10,*) '======> cm outfl    :', cocc_outflow_unemp_elasticity, '*', cocc_outflow_unemp_elasticity_data
    WRITE(10,*) '======> cm outfl y  :', cocc_young_outflow_unemp_elasticity, '*', cocc_young_outflow_unemp_elasticity_data
    WRITE(10,*) '======> cm outfl p  :', cocc_prime_outflow_unemp_elasticity, '*', cocc_prime_outflow_unemp_elasticity_data
    WRITE(10,*) '  '
    WRITE(10,*) '======> prop u<5wk  :', hp_uprop5w_unemp_elasticity, '*', hp_uprop5w_unemp_elasticity_data
    WRITE(10,*) '======> prop u5-15wk:', hp_uprop15w_unemp_elasticity, '*', hp_uprop15w_unemp_elasticity_data
    WRITE(10,*) '======> prop u15-27w:', hp_uprop27w_unemp_elasticity, '*', hp_uprop27w_unemp_elasticity_data
    WRITE(10,*) '======> prop u>27wk :', hp_upropgt27w_unemp_elasticity, '*', hp_upropgt27w_unemp_elasticity_data
    WRITE(10,*) ' '
    WRITE(10,*) '======> prop u<3m  :', hp_uprop3m_unemp_elasticity, '*', hp_uprop3m_unemp_elasticity_data
    WRITE(10,*) '======> prop u<5m  :', hp_uprop5m_unemp_elasticity, '*', hp_uprop5m_unemp_elasticity_data
    WRITE(10,*) '======> prop u5-9  :', hp_uprop9m_unemp_elasticity, '*', hp_uprop9m_unemp_elasticity_data
    WRITE(10,*) '======> prop u9-13 :', hp_uprop13m_unemp_elasticity, '*', hp_uprop13m_unemp_elasticity_data


    WRITE(10,*) ' '

    WRITE(10,*) '=============> SEMI-ELASTICITY WITH PRODUCTIVITY <======'
    WRITE(10,*) ' semielasticities in the data calculated from 5quarter smoothed series'
    WRITE(10,*) '======> jf          :', jf_prod_semielasticity, '*', jf_prod_semielasticity_data
    WRITE(10,*) '======> jfocc       :', jfocc_prod_semielasticity, '*', jfocc_prod_semielasticity_data
    WRITE(10,*) '======> jfnocc      :', jfnocc_prod_semielasticity, '*', jfnocc_prod_semielasticity_data
    WRITE(10,*) '======> jf young    :', jf_young_prod_semielasticity
    WRITE(10,*) '======> jf prime    :', jf_prime_prod_semielasticity
    WRITE(10,*) '======> jf 5q       :', jf5_prod_semielasticity, '*', jf5_prod_semielasticity_data
    WRITE(10,*) '======> jfocc 5q    :', jfocc5_prod_semielasticity, '*', jfocc5_prod_semielasticity_data
    WRITE(10,*) '======> jfnocc 5q   :', jfnocc5_prod_semielasticity, '*', jfnocc5_prod_semielasticity_data
    WRITE(10,*) '======> jf young 5q :', jf5_young_prod_semielasticity, '*', jf5_young_prod_semielasticity_data
    WRITE(10,*) '======> jf prime 5q :', jf5_prime_prod_semielasticity, '*', jf5_prime_prod_semielasticity_data


    WRITE(10,*) '======> sep         :', sep_prod_semielasticity, '*', sep_prod_semielasticity_data
    WRITE(10,*) '======> sep young   :', sep_young_prod_semielasticity, '*', sep_young_prod_semielasticity_data
    WRITE(10,*) '======> sep prime   :', sep_prime_prod_semielasticity, '*', sep_prime_prod_semielasticity_data
    WRITE(10,*) '  '
    WRITE(10,*) '======> prop u<5wk  :', hp_uprop5w_prod_semielasticity, '*', hp_uprop5w_prod_semielasticity_data
    WRITE(10,*) '======> prop u5-15wk:', hp_uprop15w_prod_semielasticity, '*', hp_uprop15w_prod_semielasticity_data
    WRITE(10,*) '======> prop u15-27w:', hp_uprop27w_prod_semielasticity, '*', hp_uprop27w_prod_semielasticity_data
    WRITE(10,*) '======> prop u>27wk :', hp_upropgt27w_prod_semielasticity, '*', hp_upropgt27w_prod_semielasticity_data
    WRITE(10,*) ' '
    WRITE(10,*) '======> prop u<3m  :', hp_uprop3m_prod_semielasticity, '*', hp_uprop3m_prod_semielasticity_data
    WRITE(10,*) '======> prop u<5m  :', hp_uprop5m_prod_semielasticity, '*', hp_uprop5m_prod_semielasticity_data
    WRITE(10,*) '======> prop u5-9  :', hp_uprop9m_prod_semielasticity, '*', hp_uprop9m_prod_semielasticity_data
    WRITE(10,*) '======> prop u9-13 :', hp_uprop13m_prod_semielasticity, '*', hp_uprop13m_prod_semielasticity_data

    WRITE(10,*) '  '
    WRITE(10,*) '  '
END IF write_unit10_if


IF(verbose_results_l0==1) THEN

    WRITE(10,*) '=============> SEMI-ELASTICITY WITH UNEMPLOYMENT <======'
    WRITE(10,*) '======> jf          :', jf_unemp_semielasticity, '*', jf_unemp_semielasticity_data
    WRITE(10,*) '======> jfocc       :', jfocc_unemp_semielasticity, '*', jfocc_unemp_semielasticity_data
    WRITE(10,*) '======> jfnocc      :', jfnocc_unemp_semielasticity, '*', jfnocc_unemp_semielasticity_data
    WRITE(10,*) '======> jf young    :', jf_young_unemp_semielasticity
    WRITE(10,*) '======> jf prime    :', jf_prime_unemp_semielasticity
    WRITE(10,*) '======> jf 5q       :', jf5_unemp_elasticity, '*', jf5_unemp_elasticity_data
    WRITE(10,*) '======> jfocc 5q    :', jfocc5_unemp_elasticity, '*', jfocc5_unemp_elasticity_data
    WRITE(10,*) '======> jfnocc 5q   :', jfnocc5_unemp_elasticity, '*', jfnocc5_unemp_elasticity_data
    WRITE(10,*) '======> jf young 5q :', jf5_young_unemp_elasticity, '*', jf5_young_unemp_elasticity_data
    WRITE(10,*) '======> jf prime 5q :', jf5_prime_unemp_elasticity, '*', jf5_prime_unemp_elasticity_data

    WRITE(10,*) '======> sep         :', sep_unemp_semielasticity, '*', sep_unemp_semielasticity_data
    WRITE(10,*) '======> sep young   :', sep_young_unemp_semielasticity, '*', sep_young_unemp_semielasticity_data
    WRITE(10,*) '======> sep prime   :', sep_prime_unemp_semielasticity, '*', sep_prime_unemp_semielasticity_data

    WRITE(10,*) '======> prop u<5wk  :', hp_uprop5w_unemp_semielasticity, '*', hp_uprop5w_unemp_semielasticity_data
    WRITE(10,*) '======> prop u5-15wk:', hp_uprop15w_unemp_semielasticity, '*', hp_uprop15w_unemp_semielasticity_data
    WRITE(10,*) '======> prop u15-27w:', hp_uprop27w_unemp_semielasticity, '*', hp_uprop27w_unemp_semielasticity_data
    WRITE(10,*) '======> prop u>27wk :', hp_upropgt27w_unemp_semielasticity, '*', hp_upropgt27w_unemp_semielasticity_data
    WRITE(10,*) ' '
    WRITE(10,*) '======> prop u<3m  :', hp_uprop3m_unemp_semielasticity, '*', hp_uprop3m_unemp_semielasticity_data
    WRITE(10,*) '======> prop u<5m  :', hp_uprop5m_unemp_semielasticity, '*', hp_uprop5m_unemp_semielasticity_data
    WRITE(10,*) '======> prop u5-9  :', hp_uprop9m_unemp_semielasticity, '*', hp_uprop9m_unemp_semielasticity_data
    WRITE(10,*) '======> prop u9-13 :', hp_uprop13m_unemp_semielasticity, '*', hp_uprop13m_unemp_semielasticity_data

    WRITE(10,*) ' '
    WRITE(10,*) ' '
END IF

IF(verbose_results_l3==1) THEN

WRITE(10,*) ' LIFE-CYCLE VARIANCES AND COVARIANCES ====================================='
WRITE(10,*) ' '



WRITE(10,*) 'stdev u_young', sqrt(var_uyoung), '*'
WRITE(10,*) 'stdev uprime' , sqrt(var_uprime), '*'
WRITE(10,*) 'stdev jfyoung', sqrt(var_jfyoung), '*', var_jfyoung_data
WRITE(10,*) 'stdev jfprime', sqrt(var_jfprime), '*', var_jfprime_data
WRITE(10,*) 'stdev jfocc', sqrt(var_jfocc), '*', var_jfocc_data
WRITE(10,*) 'stdev jfnocc', sqrt(var_jfnocc), '*', var_jfnocc_data
WRITE(10,*) 'stdev log sepyoung', sqrt(var_lsepyoung), '*', var_lsepyoung_data
WRITE(10,*) 'stdev log sepprime', sqrt(var_lsepprime), '*', var_lsepprime_data
WRITE(10,*) 'stdev sepyoung', sqrt(var_sepyoung), '*', var_sepyoung_data
WRITE(10,*) 'stdev sepprime', sqrt(var_sepprime), '*', var_sepprime_data
WRITE(10,*) 'stdev cm     ', sqrt(var_cm) ,'*', var_cm_data
WRITE(10,*) 'stdev cmyoung', sqrt(var_cmyoung), '*', var_cmyoung_data
WRITE(10,*) 'stdev cmprime', sqrt(var_cmprime), '*', var_cmprime_data

WRITE(10,*) ' '
WRITE(10,*) 'CORRELATION WITH PROD/UNEMP'
WRITE(10,*) 'uyoung w/ prod ', corr_uyoungprod
WRITE(10,*) 'uprime w/ prod ', corr_uprimeprod
WRITE(10,*) 'jfyoung w/ prod ', corr_jfyoungprod
WRITE(10,*) 'jfprime w/ prod ', corr_jfprimeprod
WRITE(10,*) 'sepyoung w/ prod ', corr_sepyoungprod
WRITE(10,*) 'sepprime w/ prod ', corr_sepprimeprod
WRITE(10,*) 'cmyoung w/ prod ', corr_cmyoungprod
WRITE(10,*) 'cmprime w/ prod', corr_cmprimeprod
WRITE(10,*) 'jfy w/ unemp ', corr_jfyoungunempl
WRITE(10,*) 'jfp w/ unemp ', corr_jfprimeunempl
WRITE(10,*) 'sepy w/ unemp ', corr_sepyoungunempl
WRITE(10,*) 'sepp w/ unemp ', corr_sepprimeunempl
WRITE(10,*) 'cmy w/ unemp ', corr_cmyoungunempl
WRITE(10,*) 'cmp w/ unemp ', corr_cmprimeunempl


WRITE(10,*) ' '
END IF


IF (verbose_profileshift==1) THEN
    WRITE(10,*) ' '
    WRITE(10,*) ' ALL'
    !WRITE(10,FMT='(A10, F6.4)', ADVANCE='NO')
    WRITE(10,FMT='(A6, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11)') 'month', ',' , 'prfl_33', ',' , 'dist_33', ',', 'prfl_50', ',' , 'dist_50', ',', 'prfl_67', ',' , 'dist_67'
    DO pcnt=1,12
    WRITE(10,FMT='(I6, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4)') pcnt, ',', tot_durationmatrix_cocc_p33(pcnt), ',' , tot_durationmatrix_nocc_p33(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_p50(pcnt), ',' , tot_durationmatrix_nocc_p50(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_p67(pcnt), ',' , tot_durationmatrix_nocc_p67(pcnt)
    END DO
    WRITE(10,*) ' '
    WRITE(10,*) ' YOUNG'
    !WRITE(10,FMT='(A10, F6.4)', ADVANCE='NO')
    WRITE(10,FMT='(A6, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11)') 'month', ',' , 'prfl_33', ',' , 'dist_33', ',', 'prfl_50', ',' , 'dist_50', ',', 'prfl_67', ',' , 'dist_67'
    DO pcnt=1,12
    WRITE(10,FMT='(I6, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4)') pcnt, ',', tot_durationmatrix_cocc_young_p33(pcnt), ',' , tot_durationmatrix_nocc_young_p33(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_young_p50(pcnt), ',' , tot_durationmatrix_nocc_young_p50(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_young_p67(pcnt), ',' , tot_durationmatrix_nocc_young_p67(pcnt)
    END DO
    WRITE(10,*) ' '
    WRITE(10,*) ' PRIME'
    !WRITE(10,FMT='(A10, F6.4)', ADVANCE='NO')
    WRITE(10,FMT='(A6, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11, A1, A11)') 'month', ',' , 'prfl_33', ',' , 'dist_33', ',', 'prfl_50', ',' , 'dist_50', ',', 'prfl_67', ',' , 'dist_67'
    DO pcnt=1,12
    WRITE(10,FMT='(I6, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4, A1, F11.4)') pcnt, ',', tot_durationmatrix_cocc_prime_p33(pcnt), ',' , tot_durationmatrix_nocc_prime_p33(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_prime_p50(pcnt), ',' , tot_durationmatrix_nocc_prime_p50(pcnt) &
                                                                                        , ',', tot_durationmatrix_cocc_prime_p67(pcnt), ',' , tot_durationmatrix_nocc_prime_p67(pcnt)
    END DO



    !
    !WRITE(10,*) ' DURATION PROFILE BOTTOM 33 U-RATES'
    !WRITE(10,*) ' 1 mth p33', tot_durationmatrix_cocc_p33(1)
    !WRITE(10,*) ' 2 mth p33', tot_durationmatrix_cocc_p33(2)
    !WRITE(10,*) ' 3 mth p33', tot_durationmatrix_cocc_p33(3)
    !WRITE(10,*) ' 4 mth p33', tot_durationmatrix_cocc_p33(4)
    !WRITE(10,*) ' 5 mth p33', tot_durationmatrix_cocc_p33(5)
    !WRITE(10,*) ' 6 mth p33', tot_durationmatrix_cocc_p33(6)
    !WRITE(10,*) ' 7 mth p33', tot_durationmatrix_cocc_p33(7)
    !WRITE(10,*) ' 8 mth p33', tot_durationmatrix_cocc_p33(8)
    !WRITE(10,*) ' 9 mth p33', tot_durationmatrix_cocc_p33(9)
    !WRITE(10,*) ' 10 mth p33', tot_durationmatrix_cocc_p33(10)
    !WRITE(10,*) ' 11 mth p33', tot_durationmatrix_cocc_p33(11)
    !WRITE(10,*) ' 12 mth p33', tot_durationmatrix_cocc_p33(12)
    !WRITE(10,*) ' '
    !
    !WRITE(10,*) ' NUMBER OF SPELLS BOTTOM 33 U-RATES'
    !WRITE(10,*) ' 1 mth p33', tot_durationmatrix_nocc_p33(1)
    !WRITE(10,*) ' 2 mth p33', tot_durationmatrix_nocc_p33(2)
    !WRITE(10,*) ' 3 mth p33', tot_durationmatrix_nocc_p33(3)
    !WRITE(10,*) ' 4 mth p33', tot_durationmatrix_nocc_p33(4)
    !WRITE(10,*) ' 5 mth p33', tot_durationmatrix_nocc_p33(5)
    !WRITE(10,*) ' 6 mth p33', tot_durationmatrix_nocc_p33(6)
    !WRITE(10,*) ' 7 mth p33', tot_durationmatrix_nocc_p33(7)
    !WRITE(10,*) ' 8 mth p33', tot_durationmatrix_nocc_p33(8)
    !WRITE(10,*) ' 9 mth p33', tot_durationmatrix_nocc_p33(9)
    !WRITE(10,*) ' 10 mth p33', tot_durationmatrix_nocc_p33(10)
    !WRITE(10,*) ' 11 mth p33', tot_durationmatrix_nocc_p33(11)
    !WRITE(10,*) ' 12 mth p33', tot_durationmatrix_nocc_p33(12)
    !
    !
    !WRITE(10,*) ' '
    !
    !WRITE(10,*) ' DURATION PROFILE BOTTOM 50 U-RATES'
    !WRITE(10,*) ' 1 mth p50', tot_durationmatrix_cocc_p50(1)
    !WRITE(10,*) ' 2 mth p50', tot_durationmatrix_cocc_p50(2)
    !WRITE(10,*) ' 3 mth p50', tot_durationmatrix_cocc_p50(3)
    !WRITE(10,*) ' 4 mth p50', tot_durationmatrix_cocc_p50(4)
    !WRITE(10,*) ' 5 mth p50', tot_durationmatrix_cocc_p50(5)
    !WRITE(10,*) ' 6 mth p50', tot_durationmatrix_cocc_p50(6)
    !WRITE(10,*) ' 7 mth p50', tot_durationmatrix_cocc_p50(7)
    !WRITE(10,*) ' 8 mth p50', tot_durationmatrix_cocc_p50(8)
    !WRITE(10,*) ' 9 mth p50', tot_durationmatrix_cocc_p50(9)
    !WRITE(10,*) ' 10 mth p50', tot_durationmatrix_cocc_p50(10)
    !WRITE(10,*) ' 11 mth p50', tot_durationmatrix_cocc_p50(11)
    !WRITE(10,*) ' 12 mth p50', tot_durationmatrix_cocc_p50(12)
    !
    !
    !WRITE(10,*) ' NUMBER OF SPELLS BOTTOM 50 U-RATES'
    !WRITE(10,*) ' 1 mth p50', tot_durationmatrix_nocc_p50(1)
    !WRITE(10,*) ' 2 mth p50', tot_durationmatrix_nocc_p50(2)
    !WRITE(10,*) ' 3 mth p50', tot_durationmatrix_nocc_p50(3)
    !WRITE(10,*) ' 4 mth p50', tot_durationmatrix_nocc_p50(4)
    !WRITE(10,*) ' 5 mth p50', tot_durationmatrix_nocc_p50(5)
    !WRITE(10,*) ' 6 mth p50', tot_durationmatrix_nocc_p50(6)
    !WRITE(10,*) ' 7 mth p50', tot_durationmatrix_nocc_p50(7)
    !WRITE(10,*) ' 8 mth p50', tot_durationmatrix_nocc_p50(8)
    !WRITE(10,*) ' 9 mth p50', tot_durationmatrix_nocc_p50(9)
    !WRITE(10,*) ' 10 mth p50', tot_durationmatrix_nocc_p50(10)
    !WRITE(10,*) ' 11 mth p50', tot_durationmatrix_nocc_p50(11)
    !WRITE(10,*) ' 12 mth p50', tot_durationmatrix_nocc_p50(12)
    !
    !
    !WRITE(10,*) ' '
    !
    !WRITE(10,*) ' DURATION PROFILE TOP 33 U-RATES'
    !WRITE(10,*) ' 1 mth p67', tot_durationmatrix_cocc_p67(1)
    !WRITE(10,*) ' 2 mth p67', tot_durationmatrix_cocc_p67(2)
    !WRITE(10,*) ' 3 mth p67', tot_durationmatrix_cocc_p67(3)
    !WRITE(10,*) ' 4 mth p67', tot_durationmatrix_cocc_p67(4)
    !WRITE(10,*) ' 5 mth p67', tot_durationmatrix_cocc_p67(5)
    !WRITE(10,*) ' 6 mth p67', tot_durationmatrix_cocc_p67(6)
    !WRITE(10,*) ' 7 mth p67', tot_durationmatrix_cocc_p67(7)
    !WRITE(10,*) ' 8 mth p67', tot_durationmatrix_cocc_p67(8)
    !WRITE(10,*) ' 9 mth p67', tot_durationmatrix_cocc_p67(9)
    !WRITE(10,*) ' 10 mth p67', tot_durationmatrix_cocc_p67(10)
    !WRITE(10,*) ' 11 mth p67', tot_durationmatrix_cocc_p67(11)
    !WRITE(10,*) ' 12 mth p67', tot_durationmatrix_cocc_p67(12)
    !
    !
    !WRITE(10,*) ' NUMBER OF SPELLS TOP 33 U-RATES'
    !WRITE(10,*) ' 1 mth p67', tot_durationmatrix_nocc_p67(1)
    !WRITE(10,*) ' 2 mth p67', tot_durationmatrix_nocc_p67(2)
    !WRITE(10,*) ' 3 mth p67', tot_durationmatrix_nocc_p67(3)
    !WRITE(10,*) ' 4 mth p67', tot_durationmatrix_nocc_p67(4)
    !WRITE(10,*) ' 5 mth p67', tot_durationmatrix_nocc_p67(5)
    !WRITE(10,*) ' 6 mth p67', tot_durationmatrix_nocc_p67(6)
    !WRITE(10,*) ' 7 mth p67', tot_durationmatrix_nocc_p67(7)
    !WRITE(10,*) ' 8 mth p67', tot_durationmatrix_nocc_p67(8)
    !WRITE(10,*) ' 9 mth p67', tot_durationmatrix_nocc_p67(9)
    !WRITE(10,*) ' 10 mth p67', tot_durationmatrix_nocc_p67(10)
    !WRITE(10,*) ' 11 mth p67', tot_durationmatrix_nocc_p67(11)
    !WRITE(10,*) ' 12 mth p67', tot_durationmatrix_nocc_p67(12)
END IF


! corr_uyoungprod
! corr_uprimeprod
! corr_jfyoungprod
! corr_jfprimeprod
! corr_sepyoungprod
! corr_sepprimeprod
! corr_cmyoungprod
! corr_cmprimeprod
!
! corr_jfyoungunempl
! corr_jfprimeunempl
! corr_sepyoungunempl
! corr_sepprimeunempl
! corr_cmyoungunempl
! corr_cmprimeunempl

!$OMP END CRITICAL

!CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
!WRITE(10,*) 'time=', time_string(2), 'after regressions, on thread:', threadnumber


! READ SOMETHNG ABOUT THE PROCYCLICALITY OF lower-income in? Violante, Heathcote?


corr_uwage=huge(1.0_8)
corr_vwage=huge(1.0_8)
corr_thetawage=huge(1.0_8)
corr_sepwage=huge(1.0_8)
corr_jfwage=huge(1.0_8)
corr_wageprod=huge(1.0_8)
corr_wagereall=huge(1.0_8)
ac_wage=huge(1.0_8)
var_wage=huge(1.0_8)


!===========================================
! REPORT
!===========================================

!u, v, theta, sep, jf, prod, wage, realloc: first standard deviations, autocrr, cov matrix
IF(verbose_results_l0==1) THEN
WRITE(10,*) '==================================================='
WRITE(10, FMT='(A8,8(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "uall", "reall"
WRITE(10, FMT='(A8,8(F9.4))') "stdev", sqrt(var_u) , sqrt(var_v)  , sqrt(var_theta)  , sqrt(var_sep) , sqrt(var_jf) , &
sqrt(var_prod) , sqrt(var_uall) , sqrt(var_reall)
WRITE(10, FMT='(A8,8(F9.4))') "autocorr", ac_u , ac_v  , ac_theta  , ac_sep , ac_jf , &
ac_prod , ac_uall , ac_reall
WRITE(10,*) '---------------------------------------------------'
WRITE(10, FMT='(A8,8(F9.4))') "u", var_u , corr_uv  , corr_utheta  , corr_usep  , corr_ujf  ,  &
corr_uprod  , corr_uallu  , corr_ureall
WRITE(10, FMT='(A8,9X, 7(F9.4))') "v", var_v  , corr_vtheta  , corr_vsep  , corr_vjf  ,  &
corr_vprod  , corr_uallv  , corr_vreall
WRITE(10, FMT='(A8,18X, 6(F9.4))') "theta", var_theta, corr_thetasep  , corr_thetajf  ,  &
corr_thetaprod  , corr_ualltheta  , corr_thetareall
WRITE(10, FMT='(A8,27X, 5(F9.4))') "sep",  var_sep , corr_sepjf  ,  &
corr_sepprod  , corr_uallsep  , corr_sepreall
WRITE(10, FMT='(A8,36X, 4(F9.4))') "jf",  var_jf,  &
corr_jfprod , corr_ualljf  , corr_jfreall
WRITE(10, FMT='(A8,45X, 3(F9.4))') "prod", var_prod, corr_uallprod  , corr_prodreall
WRITE(10, FMT='(A8,54X, 2(F9.4))') "uall", var_uall , corr_uallreall
WRITE(10, FMT='(A8,63X, (F9.4))') "reall", var_reall
WRITE(10,*) '--------------------------------------------------'
    END IF

IF(verbose_results_l0==1) THEN
WRITE(*,*) '==================================================='
WRITE(*, FMT='(A8,8(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "uall", "reall"
WRITE(*, FMT='(A8,8(F9.4))') "stdev", sqrt(var_u) , sqrt(var_v)  , sqrt(var_theta)  , sqrt(var_sep) , sqrt(var_jf) , &
sqrt(var_prod) , sqrt(var_uall) , sqrt(var_reall)
WRITE(*, FMT='(A8,8(F9.4))') "autocorr", ac_u , ac_v  , ac_theta  , ac_sep , ac_jf , &
ac_prod , ac_uall , ac_reall
WRITE(*,*) '---------------------------------------------------'
WRITE(*, FMT='(A8,8(F9.4))') "u", var_u , corr_uv  , corr_utheta  , corr_usep  , corr_ujf  ,  &
corr_uprod  , corr_uallu  , corr_ureall
WRITE(*, FMT='(A8,9X, 7(F9.4))') "v", var_v  , corr_vtheta  , corr_vsep  , corr_vjf  ,  &
corr_vprod  , corr_uallv  , corr_vreall
WRITE(*, FMT='(A8,18X, 6(F9.4))') "theta", var_theta, corr_thetasep  , corr_thetajf  ,  &
corr_thetaprod  , corr_ualltheta  , corr_thetareall
WRITE(*, FMT='(A8,27X, 5(F9.4))') "sep",  var_sep , corr_sepjf  ,  &
corr_sepprod  , corr_uallsep  , corr_sepreall
WRITE(*, FMT='(A8,36X, 4(F9.4))') "jf",  var_jf,  &
corr_jfprod , corr_ualljf  , corr_jfreall
WRITE(*, FMT='(A8,45X, 3(F9.4))') "prod", var_prod, corr_uallprod  , corr_prodreall
WRITE(*, FMT='(A8,54X, 2(F9.4))') "uall", var_uall , corr_uallreall
WRITE(*, FMT='(A8,63X, (F9.4))') "reall", var_reall
WRITE(*,*) '--------------------------------------------------'
    END IF
!===========================================
! REPORT
!===========================================

!u, v, theta, sep, jf, prod, wage, realloc: first standard deviations, autocrr, cov matrix
    IF(verbose_results_l1==1) THEN
WRITE(10,*) ' '
WRITE(10,*) '==================================================='
WRITE(10,*)      'in the actual data (H&M): '
WRITE(10,*) '==================================================='

WRITE(10, FMT='(A8,8(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "wage", "reall"
WRITE(10, FMT='(A8,8(F9.4))') "stdev", 0.125_8 , 0.139_8  , 0.259_8  , -2.0_8 , -2.0_8 , &
0.013_8 , -2.0_8 , -2.0_8
WRITE(10, FMT='(A8,8(F9.4))') "autocorr", 0.87_8, 0.904_8  , 0.894_8 , -2.0_8 , -2.0_8 , &
0.765_8 , -2.0_8 , -2.0_8
WRITE(10,*) '---------------------------------------------------'
WRITE(10, FMT='(A8,8(F9.4))') "u", 1.0_8 , -0.919_8  , -0.977_8  , -2.0_8  , -2.0_8  ,  &
-0.302_8  , -2.0_8  , -0.208
WRITE(10, FMT='(A8,9X, 7(F9.4))') "v", 1.0_8  , 0.982_8  , -2.0_8  , -2.0_8  ,  &
0.46_8  , -2.0_8  , -2.0_8
WRITE(10, FMT='(A8,18X, 6(F9.4))') "theta", 1.0_8, -2.0_8  , -2.0_8  ,  &
0.393_8  , -2.0_8  , -2.0_8
WRITE(10,*) '--------------------------------------------------'

END IF

!!$OMP MASTER
!IF(verboseswitchfile==1 .AND. screenoutcapture_switch==1) THEN
!OPEN(UNIT=11, file="data.txt", status="old", form="formatted", position="append")
!
!   WRITE(11,*), '=====theta=========='
!   WRITE(11,FMT='(A10, F6.3)' )      'delta= ',  thetal(1)
!   WRITE(11,FMT='(A11, F6.3)' )      '; reallc= ', thetal(2)
!   WRITE(11,FMT='(A5, F6.3)' )      '; k= ',thetal(3)
!   WRITE(11,FMT='(A5, F6.3)' )     '; b= ', thetal(4)
!   WRITE(11,FMT='(A8, F6.3)'  )       '; rho_p= ', thetal(5)
!   WRITE(11,FMT='(A11, F6.3)')      '; sigma_p= ', thetal(6)
!
!   WRITE(11,FMT='(A8, F6.3)'  )       'rho_z= ', thetal(7)
!   WRITE(11,FMT='(A10, F5.3)' )      '; sigma_z=', thetal(8)
!   WRITE(11,FMT='(A8, F5.3)' )      '; eta=', thetal(9)
!   WRITE(11,FMT='(A11, F6.3)' )      '; zcorr= ', thetal(10)
!   WRITE(11,FMT='(A11, F6.3)' )      '; hc5yr ', thetal(11)
!   WRITE(11,FMT='(A11, F6.3)' )      '; hc10yr ', thetal(12)
!   WRITE(11,FMT='(A11, F6.3)')      '; rstr srch ', thetal(13)
!   WRITE(11,*), '=====theta=========='
!
!
!
!!u, v, theta, sep, jf, prod, wage, realloc: first standard deviations, autocrr, cov matrix
!WRITE(11,*) '==================================================='
!WRITE(11, FMT='(A8,8(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "wage", "reall"
!WRITE(11, FMT='(A8,8(F9.4))') "stdev", sqrt(var_u) , sqrt(var_v)  , sqrt(var_theta)  , sqrt(var_sep) , sqrt(var_jf) , &
!sqrt(var_prod) , sqrt(var_wage) , sqrt(var_reall)
!WRITE(11, FMT='(A8,8(F9.4))') "autocorr", ac_u , ac_v  , ac_theta  , ac_sep , ac_jf , &
!ac_prod , ac_wage , ac_reall
!WRITE(11,*) '---------------------------------------------------'
!WRITE(11, FMT='(A8,8(F9.4))') "u", var_u , corr_uv  , corr_utheta  , corr_usep  , corr_ujf  ,  &
!corr_uprod  , corr_uwage  , corr_ureall
!WRITE(11, FMT='(A8,9X, 7(F9.4))') "v", var_v  , corr_vtheta  , corr_vsep  , corr_vjf  ,  &
!corr_vprod  , corr_vwage  , corr_vreall
!WRITE(11, FMT='(A8,18X, 6(F9.4))') "theta", var_theta, corr_thetasep  , corr_thetajf  ,  &
!corr_thetaprod  , corr_thetawage  , corr_thetareall
!WRITE(11, FMT='(A8,27X, 5(F9.4))') "sep",  var_sep , corr_sepjf  ,  &
!corr_sepprod  , corr_sepwage  , corr_sepreall
!WRITE(11, FMT='(A8,36X, 4(F9.4))') "jf",  var_jf,  &
!corr_jfprod , corr_jfwage  , corr_jfreall
!WRITE(11, FMT='(A8,45X, 3(F9.4))') "prod", var_prod, corr_wageprod  , corr_prodreall
!WRITE(11, FMT='(A8,54X, 2(F9.4))') "wage", var_wage , corr_wagereall
!WRITE(11, FMT='(A8,63X, (F9.4))') "wage", var_reall
!WRITE(11,*) '--------------------------------------------------'
!
!CLOSE(UNIT=11)
!END IF
!!$OMP END MASTER

!============================================
!          ISLAND-HETEROGENEITY: TIME SERIES, AND CROSS-SECTIONAL VARIATION
!============================================

! moments to match: see shimer and alvarez wages. They use the following procedure:
!  to detrend wages: divide by the average wage at the time.
!  then run a wage regression, on wages past, AND average wage in the industry




    !******************************************************************
    !
    !VI. Moment distance (for SMM)
    !
    !******************************************************************
!
    ! TARGETING average transition rates, average old/young wage ratio,
    ! and moments of the average (unconditional) tenure distribution
      !$OMP CRITICAL

                    udur_occ_moment1=tot_udurationmatrix_m(8)/tot_udurationmatrix_m(4)
                    udur_occ_moment2=tot_udurationmatrix_m(12)/tot_udurationmatrix_m(8)


                     cmy_cmp_mom=tot_durationmatrix_cocc_young(1)/tot_durationmatrix_cocc_prime(1)
                    cmy_cmp_corr_mom=tot_durationmatrix_cr_cocc_young(1)/tot_durationmatrix_cr_cocc_prime(1)
                    cmy_cmp_mom2m=tot_durationmatrix_cocc_young(2)/tot_durationmatrix_cocc_prime(2)
                    cmy_cmp_corr_mom2m=tot_durationmatrix_cr_cocc_young(2)/tot_durationmatrix_cr_cocc_prime(2)
                    cmy_cmp_mom3m=tot_durationmatrix_cocc_young(3)/tot_durationmatrix_cocc_prime(3)
                    cmy_cmp_corr_mom3m=tot_durationmatrix_cr_cocc_young(3)/tot_durationmatrix_cr_cocc_prime(3)
                    cmy_cmp_mom4m=tot_durationmatrix_cocc_young(4)/tot_durationmatrix_cocc_prime(4)
                    cmy_cmp_corr_mom4m=tot_durationmatrix_cr_cocc_young(4)/tot_durationmatrix_cr_cocc_prime(4)
                    cmy_cmp_mom_ave=SUM(tot_durationmatrix_cocc_young(1:12))/SUM(tot_durationmatrix_cocc_prime(1:12))
                    cmy_cmp_corr_mom_ave=SUM(tot_durationmatrix_cr_cocc_young(1:12))/SUM(tot_durationmatrix_cr_cocc_prime(1:12))


                    occmob_3m_p33=tot_durationmatrix_cr_cocc_p33(3)
                    occmob_3m_p67=tot_durationmatrix_cr_cocc_p67(3)
                    occmob_6m_p33=tot_durationmatrix_cr_cocc_p33(6)
                    occmob_6m12_p67=(tot_durationmatrix_cr_cocc_p67(6)+tot_durationmatrix_cr_cocc_p67(7)+tot_durationmatrix_cr_cocc_p67(8)+ &
                                            tot_durationmatrix_cr_cocc_p67(9)+tot_durationmatrix_cr_cocc_p67(10)+tot_durationmatrix_cr_cocc_p67(11)+&
                                            tot_durationmatrix_cr_cocc_p67(12))/7.0_8



    ! DISTRIBUTION OF UNEMPLOYMENT RATES IN THE TIME SERIES
    unemp_ee_p5=wquantile(0.05_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p10=wquantile(0.10_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p25=wquantile(0.25_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p50=wquantile(0.50_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p75=wquantile(0.75_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p90=wquantile(0.90_8,up_distribution_sim(:),p_distribution_sim(:))
    unemp_ee_p95=wquantile(0.95_8,up_distribution_sim(:),p_distribution_sim(:))



    !================================
    !  VERSIONS
    !===============================
    IF(verbose_progress) WRITE(*,*) 'data moment assignment'


    
    
                    !=====================
                    !  EMPIRICAL MOMENTS
                    !====================

        
                    mom_data=0.0_8          ! set all moments to zero, as default

                    mom_data(1)=1.0_8                  ! average productivity
                    mom_data(2)=ac_p_data
                    mom_data(3)=sd_p_data
                    mom_data(4)=elmatch_data
                    


                    mom_data(5)=tot_durationmatrix_cocc_data(1)
                    mom_data(7)=tot_durationmatrix_cocc_data(2)
                    mom_data(9)=tot_durationmatrix_cocc_data(4)
                    mom_data(11)=tot_durationmatrix_cocc_data(8)
                    mom_data(13)=tot_durationmatrix_cocc_data(10)
                    mom_data(15)=tot_durationmatrix_cocc_data(12)


                    mom_data(6)=tot_durationmatrix_data(2)
                    mom_data(8)=tot_durationmatrix_data(4)
                    mom_data(10)=tot_durationmatrix_data(8)
                    mom_data(12)=tot_durationmatrix_data(12)
                    mom_data(14)=tot_durationmatrix_data(16)                                ! 16 months survival
                    mom_data(16)=tot_durationmatrix_data(20)                       ! 20 months survival



                    mom_data(17)=u_data      !unemp_ave                 ! unemployment rate, average
                    mom_data(18)=rel_udur_move_stay_data                             ! rel length occupational movers/stayers
                    mom_data(19)=0.0
                    mom_data(19)=0.0

                    mom_data(20)=rtnoccten5yr_data
                    mom_data(21)=cmy_cmp_data_ave                    !cmy_cmp_data2m
                    mom_data(22)=rtnoccten10yr_data
                    mom_data(23)=sepyoung_ave_data/sepprime_ave_data

                   mom_data(24)=uproportion_window_data
                   mom_data(25)=tot_corr_noccafternocc_data            !noccafternocc_ave_data
                   mom_data(26)=sep_ave_12m_posthire_data/sep_ave_12m_data
                   mom_data(27)=0.0
                   mom_data(28)=0.0


                    ! survival stats young
                    mom_data(29)=tot_durationmatrix_young_data(4)
                    mom_data(30)=tot_durationmatrix_young_data(8)
                    mom_data(31)=tot_durationmatrix_young_data(12)
                    mom_data(32)=tot_durationmatrix_young_data(16)
                    mom_data(33)=tot_durationmatrix_young_data(20)
                ! survival stats prime
                    mom_data(34)=tot_durationmatrix_prime_data(4)
                    mom_data(35)=tot_durationmatrix_prime_data(8)
                    mom_data(36)=tot_durationmatrix_prime_data(12)
                    mom_data(37)=tot_durationmatrix_prime_data(16)
                    mom_data(38)=tot_durationmatrix_prime_data(20)
                ! occmob duration profile young
                    mom_data(39)=tot_durationmatrix_cr_cocc_young_data(2)
                    mom_data(40)=tot_durationmatrix_cr_cocc_young_data(4)
                    mom_data(41)=tot_durationmatrix_cr_cocc_young_data(8)
                    mom_data(42)=tot_durationmatrix_cr_cocc_young_data(10)
                    mom_data(43)=tot_durationmatrix_cr_cocc_young_data(12)
                ! occmob duration profile prime
                    mom_data(44)=tot_durationmatrix_cr_cocc_prime_data(2)
                    mom_data(45)=tot_durationmatrix_cr_cocc_prime_data(4)
                    mom_data(46)=tot_durationmatrix_cr_cocc_prime_data(8)
                    mom_data(47)=tot_durationmatrix_cr_cocc_prime_data(10)
                    mom_data(48)=tot_durationmatrix_cr_cocc_prime_data(12)
                ! first two months
                   mom_data(49)=tot_durationmatrix_young_data(2)
                   mom_data(50)=tot_durationmatrix_prime_data(2)





                ! THIS HITS LEVELS AND SLOPES
                    mom_data(53)=tot_durationmatrix_cr_cocc_p33_data(1)
                    mom_data(54)=tot_durationmatrix_cr_cocc_p33_data(2)
                    mom_data(55)=tot_durationmatrix_cr_cocc_p33_data(3)
                    mom_data(56)=tot_durationmatrix_cr_cocc_p33_data(4)
                    mom_data(57)=tot_durationmatrix_cr_cocc_p33_data(5)
                    mom_data(58)=tot_durationmatrix_cr_cocc_p33_data(6)
                    mom_data(59)=tot_durationmatrix_cr_cocc_p33_data(7)
                    mom_data(60)=tot_durationmatrix_cr_cocc_p33_data(8)


                    mom_data(61)=tot_durationmatrix_cr_cocc_p67_data(1)
                    mom_data(62)=tot_durationmatrix_cr_cocc_p67_data(2)
                    mom_data(63)=tot_durationmatrix_cr_cocc_p67_data(3)
                    mom_data(64)=tot_durationmatrix_cr_cocc_p67_data(4)
                    mom_data(65)=tot_durationmatrix_cr_cocc_p67_data(5)
                    mom_data(66)=tot_durationmatrix_cr_cocc_p67_data(6)
                    mom_data(67)=tot_durationmatrix_cr_cocc_p67_data(7)
                    mom_data(68)=tot_durationmatrix_cr_cocc_p67_data(8)
                    mom_data(69)=tot_durationmatrix_cr_cocc_p67_data(9)
                    mom_data(70)=tot_durationmatrix_cr_cocc_p67_data(10)
                    mom_data(71)=tot_durationmatrix_cr_cocc_p67_data(11)
                    mom_data(72)=tot_durationmatrix_cr_cocc_p67_data(12)

netmob_data_moment_assignment:&
IF(netmob_estimation_moments==1 .AND. nmom_local>=106) THEN

             !! SUPEROCC CHANGE DIRECTION
                tempreal=sum(data_corr_superocc_transmatrix_data(:,:))
                               mom_data(73)=1.0+data_corr_superocc_transmatrix_data(1,1)/tempreal
                               mom_data(78)=1.0+data_corr_superocc_transmatrix_data(2,2)/tempreal
                               mom_data(83)=1.0+data_corr_superocc_transmatrix_data(3,3)/tempreal
                               mom_data(88)=1.0+data_corr_superocc_transmatrix_data(4,4)/tempreal
                        !! average superocc mobility
                               mom_data(97)=(data_corr_superocc_transmatrix_data(1,1)+data_corr_superocc_transmatrix_data(2,2)+&
                                                data_corr_superocc_transmatrix_data(3,3)+data_corr_superocc_transmatrix_data(4,4))/tempreal


                !! SUPEROCC 1 CHANGERS DIRECTION
                tempreal=data_corr_superocc_transmatrix_data(1,2)+data_corr_superocc_transmatrix_data(1,3)+data_corr_superocc_transmatrix_data(1,4)
                               mom_data(74)=1.0+data_corr_superocc_transmatrix_data(1,2)/tempreal
                               mom_data(75)=1.0+data_corr_superocc_transmatrix_data(1,3)/tempreal
                               mom_data(76)=1.0+data_corr_superocc_transmatrix_data(1,4)/tempreal

                !! SUPEROCC 2 CHANGERS DIRECTION
                tempreal=data_corr_superocc_transmatrix_data(2,1)+data_corr_superocc_transmatrix_data(2,3)+data_corr_superocc_transmatrix_data(2,4)
                               mom_data(77)=1.0+data_corr_superocc_transmatrix_data(2,1)/tempreal
                               mom_data(79)=1.0+data_corr_superocc_transmatrix_data(2,3)/tempreal
                               mom_data(80)=1.0+data_corr_superocc_transmatrix_data(2,4)/tempreal

                !! SUPEROCC 3 CHANGERS DIRECTION
                tempreal=data_corr_superocc_transmatrix_data(3,1)+data_corr_superocc_transmatrix_data(3,2)+data_corr_superocc_transmatrix_data(3,4)
                               mom_data(81)=1.0+data_corr_superocc_transmatrix_data(3,1)/tempreal
                               mom_data(82)=1.0+data_corr_superocc_transmatrix_data(3,2)/tempreal
                               mom_data(84)=1.0+data_corr_superocc_transmatrix_data(3,4)/tempreal

                !! SUPEROCC 3 CHANGERS DIRECTION
                tempreal=data_corr_superocc_transmatrix_data(4,1)+data_corr_superocc_transmatrix_data(4,2)+data_corr_superocc_transmatrix_data(4,3)
                               mom_data(85)=1.0+data_corr_superocc_transmatrix_data(4,1)/tempreal
                               mom_data(86)=1.0+data_corr_superocc_transmatrix_data(4,2)/tempreal
                               mom_data(87)=1.0+data_corr_superocc_transmatrix_data(4,3)/tempreal

                !!=================================
                !! TRANSITION MATRIX TARGETING
                !!=================================
    
                IF(moments_netmobtransmatrix_ind==1) THEN 
                               tempreal=sum(data_corr_superocc_transmatrix_data(1,:))
                               tempreal2=sum(data_corr_superocc_transmatrix_data(2,:))
                               tempreal3=sum(data_corr_superocc_transmatrix_data(3,:))
                               tempreal4=sum(data_corr_superocc_transmatrix_data(4,:))
                               mom_data(73)=1.0+data_corr_superocc_transmatrix_data(1,1)/tempreal
                               mom_data(78)=1.0+data_corr_superocc_transmatrix_data(2,2)/tempreal2
                               mom_data(83)=1.0+data_corr_superocc_transmatrix_data(3,3)/tempreal3
                               mom_data(88)=1.0+data_corr_superocc_transmatrix_data(4,4)/tempreal4
                        !! average superocc mobility
                               mom_data(97)=(data_corr_superocc_transmatrix_data(1,1)+data_corr_superocc_transmatrix_data(2,2)+&
                                        data_corr_superocc_transmatrix_data(3,3)+data_corr_superocc_transmatrix_data(4,4))/&
                                        (sum(data_corr_superocc_transmatrix_data(:,:)))


                !! SUPEROCC 1 CHANGERS DIRECTION
                               mom_data(74)=1.0+data_corr_superocc_transmatrix_data(1,2)/tempreal
                               mom_data(75)=1.0+data_corr_superocc_transmatrix_data(1,3)/tempreal
                               mom_data(76)=1.0+data_corr_superocc_transmatrix_data(1,4)/tempreal

                !! SUPEROCC 2 CHANGERS DIRECTION
                               mom_data(77)=1.0+data_corr_superocc_transmatrix_data(2,1)/tempreal2
                               mom_data(79)=1.0+data_corr_superocc_transmatrix_data(2,3)/tempreal2
                               mom_data(80)=1.0+data_corr_superocc_transmatrix_data(2,4)/tempreal2

                !! SUPEROCC 3 CHANGERS DIRECTION
                               mom_data(81)=1.0+data_corr_superocc_transmatrix_data(3,1)/tempreal3
                               mom_data(82)=1.0+data_corr_superocc_transmatrix_data(3,2)/tempreal3
                               mom_data(84)=1.0+data_corr_superocc_transmatrix_data(3,4)/tempreal3

                !! SUPEROCC 4 CHANGERS DIRECTION
                               mom_data(85)=1.0+data_corr_superocc_transmatrix_data(4,1)/tempreal4
                               mom_data(86)=1.0+data_corr_superocc_transmatrix_data(4,2)/tempreal4
                               mom_data(87)=1.0+data_corr_superocc_transmatrix_data(4,3)/tempreal4
                END IF 
                   
                   
                    !! end distribution (cORRECTED)
                               mom_data(89)=corr_occdistr_begin_end_data(1,2)
                               mom_data(90)=corr_occdistr_begin_end_data(2,2)
                               mom_data(91)=corr_occdistr_begin_end_data(3,2)
                               mom_data(92)=corr_occdistr_begin_end_data(4,2)

                    !!--------------------------------
                    !! (MAINLY) CYCLICAL SHIFTS IN GROSS/NET MOB
                    !!---------------------------------

                    !! difference in NORMALIZED gross outflow per occupation BOTTOM THIRD U RATES - TO THIRD???
                               !! IF HARD TO HIT (AND OVERALL FLOW IS ADJUSTING TOO MUCH/TOO LITTLE BECAUSE OF MONTH 1 EFFECTS,
                               !!           NORMALIZE RELATIVE TO OVERALL (AVERAGE ACROSS ALL SUPEROCCS)
                               !! **ALTERNATIVE IS TO TRY TO MATCH FLOW MATRICES FOR P33 AND P67 IN THEIR ENTIRETY**
                               !mom_data(93)=1.0+corr_supocc_outflow_p33_data(1)-corr_supocc_outflow_p67_data(1)
                               !mom_data(94)=1.0+corr_supocc_outflow_p33_data(2)-corr_supocc_outflow_p67_data(2)
                               !mom_data(95)=1.0+corr_supocc_outflow_p33_data(3)-corr_supocc_outflow_p67_data(3)
                               !mom_data(96)=1.0+corr_supocc_outflow_p33_data(4)-corr_supocc_outflow_p67_data(4)

                    mom_data(93)=1.0+corr_netmob_calc_vector_data(1)
                    mom_data(94)=1.0+corr_netmob_calc_vector_data(2)
                    mom_data(95)=1.0+corr_netmob_calc_vector_data(3)
                    mom_data(96)=1.0+corr_netmob_calc_vector_data(4)



                  !! difference in gross outflow per occupation TOP THIRD BOTTOM THIRD???
                                !mom_data(97)=1.0_8            !! FILL IN. NEED OCCUPATIONAL SIZES WHICH CAN BE GAUGED FROM OCCUPATIONAL SERIES? OR WE DON'T NEED TO DO THIS?
                    !           mom_data(98)=1.0_8
                    !!! difference in NORMALIZED gross INflow per occupation BOTTOM THIRD U RATES - TO THIRD???
                    !           !! IF HARD TO HIT (AND OVERALL FLOW IS ADJUSTING TOO MUCH/TOO LITTLE BECAUSE OF MONTH 1 EFFECTS,
                    !           !!           NORMALIZE RELATIVE TO OVERALL (AVERAGE ACROSS ALL SUPEROCCS)
                    !
                    !           mom_data(99)=1.0+corr_supocc_inflow_p33_data(1)-corr_supocc_inflow_p67_data(1)
                    !           mom_data(100)=1.0+corr_supocc_inflow_p33_data(2)-corr_supocc_inflow_p67_data(2)
                    !           mom_data(101)=1.0+corr_supocc_inflow_p33_data(3)-corr_supocc_inflow_p67_data(3)
                    !           mom_data(102)=1.0+corr_supocc_inflow_p33_data(4)-corr_supocc_inflow_p67_data(4)

                  !!-------------------------------------
                    !!  INFLOW SHIFT RELATIVE TO NET FLOW SHIFT
                    !!--------------------------------------

                               tempreal=sum(corr_supocc_inflow_p50_data(:))
                               tempreal2=sum(corr_supocc_inflow_p67_data(:))

                                !! independent variable: cyclical change in inflow
                               temp_occ_y(1,1)=(corr_supocc_inflow_p50_data(1)/tempreal)-(corr_supocc_inflow_p67_data(1)/tempreal2)
                               temp_occ_y(2,1)=(corr_supocc_inflow_p50_data(2)/tempreal)-(corr_supocc_inflow_p67_data(2)/tempreal2)
                               temp_occ_y(3,1)=(corr_supocc_inflow_p50_data(3)/tempreal)-(corr_supocc_inflow_p67_data(3)/tempreal2)
                               temp_occ_y(4,1)=(corr_supocc_inflow_p50_data(4)/tempreal)-(corr_supocc_inflow_p67_data(4)/tempreal2)

                               !! dependent variable: cyclical change in outflow
                               temp_occ_x(:,1)=1.0
                               temp_occ_x(1,2)=corr_netmob_calc_vector_p50_data(1)-corr_netmob_calc_vector_p67_data(1)
                               temp_occ_x(2,2)=corr_netmob_calc_vector_p50_data(2)-corr_netmob_calc_vector_p67_data(2)
                               temp_occ_x(3,2)=corr_netmob_calc_vector_p50_data(3)-corr_netmob_calc_vector_p67_data(3)
                               temp_occ_x(4,2)=corr_netmob_calc_vector_p50_data(4)-corr_netmob_calc_vector_p67_data(4)


                               CALL multivar_regression(temp_occ_y, temp_occ_x, 4, 2, betajf,errmsg)
                                tempreal=betajf(2)

                                IF((tempreal .ne. tempreal) .OR. tempreal==tempreal-1.0) THEN
                                    mom_data(98)=-999.99
                                ELSE
                                    mom_data(98)=tempreal
                                END IF
                                !mom_data(98) SEE BELOW: RESPONSIVENESS OF CYCLICAL INFLOW TO CYCLICAL NET FLOW

                    !!---------------------------------------------
                    !! INFLOW SHIFT
                    !!---------------------------------------------

                               tempreal=sum(corr_supocc_inflow_p50_data(:))
                               tempreal2=sum(corr_supocc_inflow_p67_data(:))

                               mom_data(99)=1.0+(corr_supocc_inflow_p50_data(1)/tempreal)-(corr_supocc_inflow_p67_data(1)/tempreal2)
                               mom_data(100)=1.0+(corr_supocc_inflow_p50_data(2)/tempreal)-(corr_supocc_inflow_p67_data(2)/tempreal2)
                               mom_data(101)=1.0+(corr_supocc_inflow_p50_data(3)/tempreal)-(corr_supocc_inflow_p67_data(3)/tempreal2)
                               mom_data(102)=1.0+(corr_supocc_inflow_p50_data(4)/tempreal)-(corr_supocc_inflow_p67_data(4)/tempreal2)



                  !! NET FLOW IN RECESSIONS
                               mom_data(103)=1.0+corr_netmob_calc_vector_p67_data(1)
                               mom_data(104)=1.0+corr_netmob_calc_vector_p67_data(2)
                               mom_data(105)=1.0+corr_netmob_calc_vector_p67_data(3)
                               mom_data(106)=1.0+corr_netmob_calc_vector_p67_data(4)
                    !! NET FLOW IN GOOD TIMES
                               mom_data(107)=1.0+corr_netmob_calc_vector_p50_data(1)
                               mom_data(108)=1.0+corr_netmob_calc_vector_p50_data(2)
                               mom_data(109)=1.0+corr_netmob_calc_vector_p50_data(3)
                               mom_data(110)=1.0+corr_netmob_calc_vector_p50_data(4)
                    !!! MOG MOBILITY PER SUPER OCC -- to pin down mobility within superocc, and show that this is relatively uniform?
                    !           mom_data(111)=corr_mogmob_superocc_data(1)
                    !           mom_data(112)=corr_mogmob_superocc_data(2)
                    !           mom_data(113)=corr_mogmob_superocc_data(3)
                    !           mom_data(114)=corr_mogmob_superocc_data(4)

                               !mom_data(111)=1.0+corr_netmob_calc_vector_p50_data(1)-corr_netmob_calc_vector_p67_data(1)
                               !mom_data(112)=1.0+corr_netmob_calc_vector_p50_data(2)-corr_netmob_calc_vector_p67_data(2)
                               !mom_data(113)=1.0+corr_netmob_calc_vector_p50_data(3)-corr_netmob_calc_vector_p67_data(3)
                               !mom_data(114)=1.0+corr_netmob_calc_vector_p50_data(4)-corr_netmob_calc_vector_p67_data(4)


                                tempreal=0.0
                                tempreal2=0.0
                                DO occcnt=1, occpts
                                    tempreal=tempreal+0.5*(occdistr_begin_end(occcnt, 1)+occdistr_begin_end(occcnt, 2))*udur_supocc_unemp_elasticity_ldt(occcnt)
                                    tempreal2=tempreal2+0.5*(occdistr_begin_end_data(occcnt, 1)+occdistr_begin_end_data(occcnt, 2))*udur_supocc_unemp_elasticity_ldt_data(occcnt)
                                END DO
                                            mom_data(111)=udur_supocc_unemp_elasticity_ldt_data(1)/tempreal2
                                            mom_data(112)=udur_supocc_unemp_elasticity_ldt_data(2)/tempreal2
                                            mom_data(113)=udur_supocc_unemp_elasticity_ldt_data(3)/tempreal2
                                            mom_data(114)=udur_supocc_unemp_elasticity_ldt_data(4)/tempreal2

                                   !! relative relation shift inflow shift

                                       tempreal=sum(corr_supocc_inflow_p50_data(:))
                                       tempreal2=sum(corr_supocc_inflow_p67_data(:))

                                       mom_data(115)=(abs((corr_supocc_inflow_p50_data(3)/tempreal)-(corr_supocc_inflow_p67_data(3)/tempreal2))+abs((corr_supocc_inflow_p50_data(4)/tempreal)-(corr_supocc_inflow_p67_data(4)/tempreal2)))/ &
                                        (abs(corr_netmob_calc_vector_p50_data(3)-corr_netmob_calc_vector_p67_data(3))+abs(corr_netmob_calc_vector_p50_data(4)-corr_netmob_calc_vector_p67_data(4)))

                                mom_data(117)=1.0+corr_netmob_calc_vector_p50_data(1)-corr_netmob_calc_vector_p67_data(1)
                                mom_data(118)=1.0+corr_netmob_calc_vector_p50_data(2)-corr_netmob_calc_vector_p67_data(2)
                                mom_data(119)=1.0+corr_netmob_calc_vector_p50_data(3)-corr_netmob_calc_vector_p67_data(3)
                                mom_data(120)=1.0+corr_netmob_calc_vector_p50_data(4)-corr_netmob_calc_vector_p67_data(4)

    END IF netmob_data_moment_assignment


                    !!=============================================
                    !!  SIMULATION DATA
                    !!============================================

    
    
    
    
    
                    IF(verbose_progress) WRITE(*,*) 'simulated moments assignment'





            
                    mom=0.0_8

                    mom(1)=prod_ave                  ! average productivity
                    mom(2)=ac_prod
                    mom(3)=sqrt(var_prod)

                    mom(4)=elmatching_ave

                    mom(5)=tot_durationmatrix_cocc(1)
                    mom(7)=tot_durationmatrix_cocc(2)
                    mom(9)=tot_durationmatrix_cocc(4)
                    mom(11)=tot_durationmatrix_cocc(8)
                    mom(13)=tot_durationmatrix_cocc(10)
                    mom(15)=tot_durationmatrix_cocc(12)



                    mom(6)=tot_durationmatrix(2)
                    mom(8)=tot_durationmatrix(4)
                    mom(10)=tot_durationmatrix(8)
                    mom(12)=tot_durationmatrix(12)
                    mom(14)=tot_durationmatrix(16)                                ! 16 months survival
                    mom(16)=tot_durationmatrix(20)                       ! 20 months survival


                    mom(17)=unemp_earlier_e_ave      !unemp_ave                 ! unemployment rate, average
                    mom(18)=udur_mvec_occ_ave(1)/udur_mvec_nocc_ave(1) 
                    mom(19)=0.0

                    mom(20)=returnstenure5y
                    mom(21)=cmy_cmp_mom_ave
                    mom(22)=returnstenure10y
                    mom(23)=sepyoung_ave/sepprime_ave

                   mom(24)=uproportion_window
                   mom(25)=tot_corr_noccafternocc !noccafternocc_ave 
                   mom(26)=sep_ave_12m_posthire/sep_ave_12m

                   mom(27)=0.0
                   mom(28)=0.0

                                ! survival stats young
                                    mom(29)=tot_durationmatrix_young(4)
                                    mom(30)=tot_durationmatrix_young(8)
                                    mom(31)=tot_durationmatrix_young(12)
                                    mom(32)=tot_durationmatrix_young(16)
                                    mom(33)=tot_durationmatrix_young(20)
                                ! survival stats prime
                                    mom(34)=tot_durationmatrix_prime(4)
                                    mom(35)=tot_durationmatrix_prime(8)
                                    mom(36)=tot_durationmatrix_prime(12)
                                    mom(37)=tot_durationmatrix_prime(16)
                                    mom(38)=tot_durationmatrix_prime(20)
                                ! occmob duration profile young
                                    mom(39)=tot_durationmatrix_cr_cocc_young(2)
                                    mom(40)=tot_durationmatrix_cr_cocc_young(4)
                                    mom(41)=tot_durationmatrix_cr_cocc_young(8)
                                    mom(42)=tot_durationmatrix_cr_cocc_young(10)
                                    mom(43)=tot_durationmatrix_cr_cocc_young(12)
                                ! occmob duration profile prime
                                    mom(44)=tot_durationmatrix_cr_cocc_prime(2)
                                    mom(45)=tot_durationmatrix_cr_cocc_prime(4)
                                    mom(46)=tot_durationmatrix_cr_cocc_prime(8)
                                    mom(47)=tot_durationmatrix_cr_cocc_prime(10)
                                    mom(48)=tot_durationmatrix_cr_cocc_prime(12)
                                    ! shortduration
                                    mom(49)=tot_durationmatrix_young(2)
                                    mom(50)=tot_durationmatrix_prime(2)

                                mom(27)=0.0
                                mom(28)=0.0







                    mom(53)=tot_durationmatrix_cr_cocc_p33(1)
                    mom(54)=tot_durationmatrix_cr_cocc_p33(2)
                    mom(55)=tot_durationmatrix_cr_cocc_p33(3)
                    mom(56)=tot_durationmatrix_cr_cocc_p33(4)
                    mom(57)=tot_durationmatrix_cr_cocc_p33(5)
                    mom(58)=tot_durationmatrix_cr_cocc_p33(6)
                    mom(59)=tot_durationmatrix_cr_cocc_p33(7)
                    mom(60)=tot_durationmatrix_cr_cocc_p33(8)


                    mom(61)=tot_durationmatrix_cr_cocc_p67(1)
                    mom(62)=tot_durationmatrix_cr_cocc_p67(2)
                    mom(63)=tot_durationmatrix_cr_cocc_p67(3)
                    mom(64)=tot_durationmatrix_cr_cocc_p67(4)
                    mom(65)=tot_durationmatrix_cr_cocc_p67(5)
                    mom(66)=tot_durationmatrix_cr_cocc_p67(6)
                    mom(67)=tot_durationmatrix_cr_cocc_p67(7)
                    mom(68)=tot_durationmatrix_cr_cocc_p67(8)
                    mom(69)=tot_durationmatrix_cr_cocc_p67(9)
                    mom(70)=tot_durationmatrix_cr_cocc_p67(10)
                    mom(71)=tot_durationmatrix_cr_cocc_p67(11)
                    mom(72)=tot_durationmatrix_cr_cocc_p67(12)

    netmob_moment_assignment:&        
        IF(netmob_estimation_moments==1 .AND. nmom_local>=120) THEN

        
    !!----------------------------------
    !! SUPEROCC CHANGE DIRECTION
    !!----------------------------------

    !! SUPEROCC CHANGE DIRECTION
    tempreal=sum(data_corr_superocc_transmatrix_allptile(:,:))
                   mom(73)=1.0+data_corr_superocc_transmatrix_allptile(1,1)/tempreal
                   mom(78)=1.0+data_corr_superocc_transmatrix_allptile(2,2)/tempreal
                   mom(83)=1.0+data_corr_superocc_transmatrix_allptile(3,3)/tempreal
                   mom(88)=1.0+data_corr_superocc_transmatrix_allptile(4,4)/tempreal
            !! average superocc mobility
                   mom(97)=(data_corr_superocc_transmatrix_allptile(1,1)+data_corr_superocc_transmatrix_allptile(2,2)+&
                                    data_corr_superocc_transmatrix_allptile(3,3)+data_corr_superocc_transmatrix_allptile(4,4))/tempreal


    !! SUPEROCC 1 CHANGERS DIRECTION
    tempreal=data_corr_superocc_transmatrix_allptile(1,2)+data_corr_superocc_transmatrix_allptile(1,3)+data_corr_superocc_transmatrix_allptile(1,4)
                   mom(74)=1.0+data_corr_superocc_transmatrix_allptile(1,2)/tempreal
                   mom(75)=1.0+data_corr_superocc_transmatrix_allptile(1,3)/tempreal
                   mom(76)=1.0+data_corr_superocc_transmatrix_allptile(1,4)/tempreal

    !! SUPEROCC 2 CHANGERS DIRECTION
    tempreal=data_corr_superocc_transmatrix_allptile(2,1)+data_corr_superocc_transmatrix_allptile(2,3)+data_corr_superocc_transmatrix_allptile(2,4)
                   mom(77)=1.0+data_corr_superocc_transmatrix_allptile(2,1)/tempreal
                   mom(79)=1.0+data_corr_superocc_transmatrix_allptile(2,3)/tempreal
                   mom(80)=1.0+data_corr_superocc_transmatrix_allptile(2,4)/tempreal

    !! SUPEROCC 3 CHANGERS DIRECTION
    tempreal=data_corr_superocc_transmatrix_allptile(3,1)+data_corr_superocc_transmatrix_allptile(3,2)+data_corr_superocc_transmatrix_allptile(3,4)
                   mom(81)=1.0+data_corr_superocc_transmatrix_allptile(3,1)/tempreal
                   mom(82)=1.0+data_corr_superocc_transmatrix_allptile(3,2)/tempreal
                   mom(84)=1.0+data_corr_superocc_transmatrix_allptile(3,4)/tempreal

    !! SUPEROCC 3 CHANGERS DIRECTION
    tempreal=data_corr_superocc_transmatrix_allptile(4,1)+data_corr_superocc_transmatrix_allptile(4,2)+data_corr_superocc_transmatrix_allptile(4,3)
                   mom(85)=1.0+data_corr_superocc_transmatrix_allptile(4,1)/tempreal
                   mom(86)=1.0+data_corr_superocc_transmatrix_allptile(4,2)/tempreal
                   mom(87)=1.0+data_corr_superocc_transmatrix_allptile(4,3)/tempreal
                   
                   
            IF(moments_netmobtransmatrix_ind==1) THEN 
                           tempreal=sum(data_corr_superocc_transmatrix_allptile(1,:))
                           tempreal2=sum(data_corr_superocc_transmatrix_allptile(2,:))
                           tempreal3=sum(data_corr_superocc_transmatrix_allptile(3,:))
                           tempreal4=sum(data_corr_superocc_transmatrix_allptile(4,:))
                           mom(73)=1.0+data_corr_superocc_transmatrix_allptile(1,1)/tempreal
                           mom(78)=1.0+data_corr_superocc_transmatrix_allptile(2,2)/tempreal2
                           mom(83)=1.0+data_corr_superocc_transmatrix_allptile(3,3)/tempreal3
                           mom(88)=1.0+data_corr_superocc_transmatrix_allptile(4,4)/tempreal4
                    !! average superocc mobility
                           mom(97)=(data_corr_superocc_transmatrix_allptile(1,1)+data_corr_superocc_transmatrix_allptile(2,2)+&
                                            data_corr_superocc_transmatrix_allptile(3,3)+data_corr_superocc_transmatrix_allptile(4,4))/&
                                            (sum(data_corr_superocc_transmatrix_allptile(:,:)))


            !! SUPEROCC 1 CHANGERS DIRECTION
                           mom(74)=1.0+data_corr_superocc_transmatrix_allptile(1,2)/tempreal
                           mom(75)=1.0+data_corr_superocc_transmatrix_allptile(1,3)/tempreal
                           mom(76)=1.0+data_corr_superocc_transmatrix_allptile(1,4)/tempreal

            !! SUPEROCC 2 CHANGERS DIRECTION
                           mom(77)=1.0+data_corr_superocc_transmatrix_allptile(2,1)/tempreal2
                           mom(79)=1.0+data_corr_superocc_transmatrix_allptile(2,3)/tempreal2
                           mom(80)=1.0+data_corr_superocc_transmatrix_allptile(2,4)/tempreal2

            !! SUPEROCC 3 CHANGERS DIRECTION
                           mom(81)=1.0+data_corr_superocc_transmatrix_allptile(3,1)/tempreal3
                           mom(82)=1.0+data_corr_superocc_transmatrix_allptile(3,2)/tempreal3
                           mom(84)=1.0+data_corr_superocc_transmatrix_allptile(3,4)/tempreal3

            !! SUPEROCC 4 CHANGERS DIRECTION
                           mom(85)=1.0+data_corr_superocc_transmatrix_allptile(4,1)/tempreal4
                           mom(86)=1.0+data_corr_superocc_transmatrix_allptile(4,2)/tempreal4
                           mom(87)=1.0+data_corr_superocc_transmatrix_allptile(4,3)/tempreal4
            END IF 
    
    !!----------------------------------
    !! end distribution (cORRECTED)
    !!----------------------------------
                   mom(89)=corr_occdistr_end_v3(1)
                   mom(90)=corr_occdistr_end_v3(2)
                   mom(91)=corr_occdistr_end_v3(3)
                   mom(92)=corr_occdistr_end_v3(4)

    !!-------------------------------------------------
    !!  NET MOBILITY
    !!-------------------------------------------------

                   
                   
                    mom(93)=1.0+corr_netmob_calc_vector_allptile(1)
                    mom(94)=1.0+corr_netmob_calc_vector_allptile(2)
                    mom(95)=1.0+corr_netmob_calc_vector_allptile(3)
                    mom(96)=1.0+corr_netmob_calc_vector_allptile(4)



        !mom(97) ALREADY USED FOR AVERAGE SUPEROCC MOBILITY

        !!-------------------------------------
        !!  INFLOW SHIFT RELATIVE TO NET FLOW SHIFT
        !!--------------------------------------

                    mom(98)=1.0
                    !mom(98) SEE BELOW: RESPONSIVENESS OF CYCLICAL INFLOW TO CYCLICAL NET FLOW

                   tempreal=sum(corr_supocc_inflow_p50(:))
                   tempreal2=sum(corr_supocc_inflow_p67(:))

                    !! independent variable: cyclical change in inflow
                   temp_occ_y(1,1)=(corr_supocc_inflow_p50(1)/tempreal)-(corr_supocc_inflow_p67(1)/tempreal2)
                   temp_occ_y(2,1)=(corr_supocc_inflow_p50(2)/tempreal)-(corr_supocc_inflow_p67(2)/tempreal2)
                   temp_occ_y(3,1)=(corr_supocc_inflow_p50(3)/tempreal)-(corr_supocc_inflow_p67(3)/tempreal2)
                   temp_occ_y(4,1)=(corr_supocc_inflow_p50(4)/tempreal)-(corr_supocc_inflow_p67(4)/tempreal2)

                   !! dependent variable: cyclical change in outflow
                   temp_occ_x(:,1)=1.0
                   temp_occ_x(1,2)=corr_netmob_calc_vector_p50(1)-corr_netmob_calc_vector_p67(1)
                   temp_occ_x(2,2)=corr_netmob_calc_vector_p50(2)-corr_netmob_calc_vector_p67(2)
                   temp_occ_x(3,2)=corr_netmob_calc_vector_p50(3)-corr_netmob_calc_vector_p67(3)
                   temp_occ_x(4,2)=corr_netmob_calc_vector_p50(4)-corr_netmob_calc_vector_p67(4)


                   CALL multivar_regression(temp_occ_y, temp_occ_x, 4, 2, betajf,errmsg)
                    tempreal=betajf(2)

                    IF((tempreal .ne. tempreal) .OR. tempreal==tempreal-1.0) THEN
                        mom(98)=-999.99
                    ELSE
                        mom(98)=tempreal
                    END IF


        !!---------------------------------------------
        !! INFLOW SHIFT
        !!---------------------------------------------

                   tempreal=sum(corr_supocc_inflow_p50(:))
                   tempreal2=sum(corr_supocc_inflow_p67(:))

                   mom(99)=1.0+(corr_supocc_inflow_p50(1)/tempreal)-(corr_supocc_inflow_p67(1)/tempreal2)
                   mom(100)=1.0+(corr_supocc_inflow_p50(2)/tempreal)-(corr_supocc_inflow_p67(2)/tempreal2)
                   mom(101)=1.0+(corr_supocc_inflow_p50(3)/tempreal)-(corr_supocc_inflow_p67(3)/tempreal2)
                   mom(102)=1.0+(corr_supocc_inflow_p50(4)/tempreal)-(corr_supocc_inflow_p67(4)/tempreal2)

        !!-------------------------------------------
        !!  NET FLOW SHIFT
        !!-------------------------------------------


        !! NET FLOW IN RECESSIONS
                   mom(103)=1.0+corr_netmob_calc_vector_p67(1)
                   mom(104)=1.0+corr_netmob_calc_vector_p67(2)
                   mom(105)=1.0+corr_netmob_calc_vector_p67(3)
                   mom(106)=1.0+corr_netmob_calc_vector_p67(4)
        !! NET FLOW IN GOOD TIMES
                   mom(107)=1.0+corr_netmob_calc_vector_p50(1)
                   mom(108)=1.0+corr_netmob_calc_vector_p50(2)
                   mom(109)=1.0+corr_netmob_calc_vector_p50(3)
                   mom(110)=1.0+corr_netmob_calc_vector_p50(4)
       
        tempreal=0.0
        tempreal2=0.0
        DO occcnt=1, occpts
            tempreal=tempreal+0.5*(occdistr_begin_end(occcnt, 1)+occdistr_begin_end(occcnt, 2))*udur_supocc_unemp_elasticity_ldt(occcnt)
            tempreal2=tempreal2+0.5*(occdistr_begin_end_data(occcnt, 1)+occdistr_begin_end_data(occcnt, 2))*udur_supocc_unemp_elasticity_ldt_data(occcnt)
        END DO
                    mom(111)=udur_supocc_unemp_elasticity_ldt(1)/tempreal
                    mom(112)=udur_supocc_unemp_elasticity_ldt(2)/tempreal
                    mom(113)=udur_supocc_unemp_elasticity_ldt(3)/tempreal
                    mom(114)=udur_supocc_unemp_elasticity_ldt(4)/tempreal

        
        !! anchors
                   ! average occupation productivity weighted by ave (begin-end) share each occupation
                   !mom(115)=((occdistr_begin_end_data(1,1)+occdistr_begin_end_data(1,2))/2.0)*
                   ! average occupation elasticity  weighted by ave (begin-end) share each occupation
                   !mom(116)=

        !! relative relation shift inflow shift

                   tempreal=sum(corr_supocc_inflow_p50(:))
                   tempreal2=sum(corr_supocc_inflow_p67(:))
                   mom(115)=(abs((corr_supocc_inflow_p50(3)/tempreal)-(corr_supocc_inflow_p67(3)/tempreal2))+abs((corr_supocc_inflow_p50(4)/tempreal)-(corr_supocc_inflow_p67(4)/tempreal2)))/ &
                            (abs(corr_netmob_calc_vector_p50(3)-corr_netmob_calc_vector_p67(3))+abs(corr_netmob_calc_vector_p50(4)-corr_netmob_calc_vector_p67(4)))

    !! cyclical differences net mobility
                    mom(117)=1.0+corr_netmob_calc_vector_p50(1)-corr_netmob_calc_vector_p67(1)
                    mom(118)=1.0+corr_netmob_calc_vector_p50(2)-corr_netmob_calc_vector_p67(2)
                    mom(119)=1.0+corr_netmob_calc_vector_p50(3)-corr_netmob_calc_vector_p67(3)
                    mom(120)=1.0+corr_netmob_calc_vector_p50(4)-corr_netmob_calc_vector_p67(4)
                    

    END IF netmob_moment_assignment


        

   !================================
   ! distance calculation
   !=================================
IF(verbose_progress) WRITE(*,*) 'distance calculation'
    ! FROM SIMPLE TO MORE ELABORATE
    



    omega=1.0_8


    
    !!===========================================
    !!  FOR REPORTING WEIGHTS
    !!==============================================

    DO i=1, nmom_local
        momweightl(i)=omega(i,i)
    END DO


   !====================================================
   ! CALCULATE MOMENT DISTANCE, with diagonal weighting matrix
   !====================================================

        ! AVERAGE PRODUCTIVITY: [0, infty)
        tempint=1
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF

        ! MOMENTS 2-19: ALL BETWEEN 0 and 1
            DO tempint=2,17
                                 IF(mom(tempint)>=0.0 .AND. mom(tempint)<=1.0 .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
                                ELSE
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
                                END IF
            END DO

        ! RETURNS TO TENURE [0, infty), SEPARATION AGE DIFFERENCE, REPEAT SEP RATIO, DISPERSION: [0, infty)
    tempint=18
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8 .AND. &
               mom(tempint)*mom_data(tempint)>0.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE IF (moments_lifecycleversion_umedian_noreall_ind==1 .OR. moments_lifecycleversion_bev_umedian_noreall_ind==1) THEN
                                        omega(tempint,tempint)=0.0_8
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF

    tempint=19
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
    END IF
    !RATIO occmob mobility y/p, between [0, infty)

    ! returns to occ. tenure can in
    tempint=20
            IF(mom(tempint)>-HUGE(1.0) .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(MAX(mom(tempint),0.0_8)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF

    tempint=22
            IF(mom(tempint)>-HUGE(1.0) .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(MAX(mom(tempint),0.0_8)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF


    tempint=21
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF
    tempint=23
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
            END IF

    ! MOMENTS 24-25: ALL BETWEEN 0 and 1
            DO tempint=24,25
                                 IF(mom(tempint)>=0.0 .AND. mom(tempint)<=1.0 .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
                                ELSE
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
                                END IF
            END DO

        tempint=26
            IF(mom(tempint)>=0.0 .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
    END IF


    ! MOMENTS 27-28 - OPEN : ALL BETWEEN 0 and +infty
            DO tempint=27,28
                                 IF(mom(tempint)>=0.0 .AND. mom(tempint)<=HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
                                ELSE
                                    omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
                                END IF
    END DO







    DO tempint=29,50
                                            IF(mom(tempint)>=0.0 .AND. mom(tempint)<=1.0 .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                                omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
                                            ELSE
                                                omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
                                            END IF
    END DO



    
    DO tempint=53,72
                                            IF(mom(tempint)>=0.0 .AND. mom(tempint)<=1.0 .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                                omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
                                            ELSE
                                                omega(tempint,tempint)=omega(tempint,tempint)*(10.0)**2
                                            END IF
    END DO
    
    !!=========================================
    !! INCLUDE NET MOB MOMENTS IN DISTANCE
    !!============================================

    IF(netmob_estimation_moments==1) THEN
     DO tempint=73,120
            IF(mom(tempint)>=-HUGE(1.0) .AND. mom(tempint)<HUGE(1.0_8) .AND. mom(tempint)==mom(tempint) .AND. mom(tempint) .ne. mom(tempint)+1.0_8) THEN
                                        omega(tempint,tempint)=omega(tempint,tempint)*(10.0*(mom(tempint)-mom_data(tempint))/(mom(tempint)+mom_data(tempint)))**2
            ELSE
                                        omega(tempint,tempint)=omega(tempint,tempint)*(100.0)**2
            END IF
     END DO
    END IF


    !!====================================
    !!  ADD DISTANCES
    !!======================================

   tempreal=0.0_8
   DO i=1, nmom_local !nmom_local
       IF((omega(i,i) .ne. omega(i,i)+1.0_8) .AND. omega(i,i)>0.0_8) THEN
            tempreal=tempreal+omega(i,i)
       ELSE IF (omega(i,i) == omega(i,i)+1.0_8) THEN
            tempreal=tempreal+100000.0_8
       END IF
    END DO

    !! second stage, net mobility only
    IF(netmob_estimation_moments_only==1) THEN
        tempreal=0.0_8
       DO i=73, nmom_local !nmom_local
           IF((omega(i,i) .ne. omega(i,i)+1.0_8) .AND. omega(i,i)>0.0_8) THEN
                tempreal=tempreal+omega(i,i)
           ELSE IF (omega(i,i) == omega(i,i)+1.0_8) THEN
                tempreal=tempreal+100000.0_8
           END IF
        END DO
    END IF


    mom1_dist=tempreal

IF(verbose_progress) WRITE(*,*) 'file 13 reporting'





    !================================================
    !================================================
    !
    !  R E P O R T I N G
    !
    !=================================================
    !==================================================


    
    
! REPORT PARAMETERS FOR PAPER    
OPEN(UNIT=56, file='parameters.txt', form='formatted', status='replace')


   WRITE(56, FMT='((A30, F15.9))') 'reallocation cost c:', reallc
   WRITE(56, FMT='((A30, F15.9))') 'vacancy cost k:', k
   WRITE(56, FMT='((A30, F15.9))') 'unemp flow benefit:', b
   WRITE(56, FMT='((A30, F15.9))') 'eta:', eta
   WRITE(56, FMT='((A30, F15.9))') 'delta_lowhc:', deltalowhc
   WRITE(56, FMT='((A30, F15.9))') 'delta_highhc:', deltahighhc
   WRITE(56, FMT='((A30, F15.9))') 'z_correction:', zcorrection
   WRITE(56, FMT='((A30, F15.9))') 'rho_p:', rho_p
   WRITE(56, FMT='((A30, F15.9))') 'sigma_p:', sigma_p
   WRITE(56, FMT='((A30, F15.9))') 'rho_z:', rho_z
   WRITE(56, FMT='((A30, F15.9))') 'sigma_z:', sigma_z
   WRITE(56, FMT='((A30, F15.9))') 'x2 hc level:', xvector(2)
   WRITE(56, FMT='((A30, F15.9))') 'x3 hc level:', xvector(3)
   WRITE(56, FMT='((A30, F15.9))') 'skill depreciation:', skilldep
   !! net mobility moments
   WRITE(56, FMT='((A30, F15.9))') 'superocc1_level:', occprodvector(1)
    WRITE(56, FMT='((A30, F15.9))') '(implied) superocc2_level:', occprodvector(2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_level:', occprodvector(3)
    WRITE(56, FMT='((A30, F15.9))') 'superocc4_level:', occprodvector(4)
    WRITE(56, FMT='((A30, F15.9))') 'superocc1_elas_aggA:', occaggprod_elas(1)
    WRITE(56, FMT='((A30, F15.9))') '(implied) superocc2_level:', occaggprod_elas(2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_level:', occaggprod_elas(3)
    WRITE(56, FMT='((A30, F15.9))') 'superocc4_level:', occaggprod_elas(4)
    WRITE(56, FMT='((A30, F15.9))') 'superocc1_exoinflow:', entry_occdistr(1)
    WRITE(56, FMT='((A30, F15.9))') 'superocc2_exoinflow:', entry_occdistr(2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_exoinflow:', entry_occdistr(3)
    WRITE(56, FMT='((A30, F15.9))') '(impl.)superocc4_exoinflow:', entry_occdistr(4)
    WRITE(56, FMT='((A30, F15.9))') 'x-superocc search elas:', occsearch_elas
                ! 10net mob moments above, 12 moments of the transition matrix below 
    WRITE(56, FMT='((A30, F15.9))') 'superocc1_1_transmatrix:', searchdir_pars(1,1)
    WRITE(56, FMT='((A30, F15.9))') 'superocc1_2_transmatrix:', searchdir_pars(1,2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc1_3_transmatrix:', searchdir_pars(1,3)
    WRITE(56, FMT='((A30, F15.9))') '(impl)superocc1_4_transmatrix:', searchdir_pars(1,4)
    WRITE(56, FMT='((A30, F15.9))') 'superocc2_1_transmatrix:', searchdir_pars(2,1)
    WRITE(56, FMT='((A30, F15.9))') 'superocc2_2_transmatrix:', searchdir_pars(2,2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc2_3_transmatrix:', searchdir_pars(2,3)
    WRITE(56, FMT='((A30, F15.9))') '(impl)superocc2_4_transmatrix:', searchdir_pars(2,4)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_1_transmatrix:', searchdir_pars(3,1)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_2_transmatrix:', searchdir_pars(3,2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc3_3_transmatrix:', searchdir_pars(3,3)
    WRITE(56, FMT='((A30, F15.9))') '(impl)superocc3_4_transmatrix:', searchdir_pars(3,4)
    WRITE(56, FMT='((A30, F15.9))') 'superocc4_1_transmatrix:', searchdir_pars(4,1)
    WRITE(56, FMT='((A30, F15.9))') 'superocc4_2_transmatrix:', searchdir_pars(4,2)
    WRITE(56, FMT='((A30, F15.9))') 'superocc4_3_transmatrix:', searchdir_pars(4,3)
    WRITE(56, FMT='((A30, F15.9))') '(impl)superocc4_4_transmatrix:', searchdir_pars(4,4)
    
     
CLOSE(56)
    

OPEN(UNIT=13, file='moments.txt', form='formatted', status='replace')
        write(13,FMT='(1(A25, A8, A4, A8, A4 ))'), 'MOMENT:',   'MODEL', ' , ', 'DATA'
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'average productivity:',   mom(1), ' , ', mom_data(1)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'rhop_p:',   mom(2), ' , ', mom_data(2) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'sigma_p:', mom(3), ' , ', mom_data(3) 
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'ave unemp (earlier empl):', mom(17), ' , ', mom_data(17)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'repeat mob stay|prev.stay:', mom(25), ' , ', mom_data(25)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'rel occ mob young/prime', mom(21), ' , ', mom_data(21)
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'sep rate young/prime:', mom(23), ' , ', mom_data(23)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'rel. sep rate hire/empl', mom(26), ' , ',mom_data(26)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'prob u within 3yrs for empl.', mom(24), ' , ', mom_data(24)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'emp. elas matching fcn:', mom(4), ' , ', mom_data(4) 
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'emp return tenure, 5yr:', mom(20), ' , ', mom_data(20)
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'emp return tenure, 10yr:', mom(22), ' , ', mom_data(22)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'rel u.dur movers/stayers:', mom(18), ' , ', mom_data(18)
        
        write(13,*) '' 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 1:', mom(5), ' , ', mom_data(5) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 2:', mom(7), ' , ', mom_data(7) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 4:', mom(9), ' , ', mom_data(9) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 8:', mom(11), ' , ', mom_data(11) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 10:', mom(13), ' , ', mom_data(13) 
        write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob, duration >= 12:', mom(15), ' , ', mom_data(15) 
        
        write(13,*) '' 
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 2m:', mom(6), ' , ', mom_data(6)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 4m:', mom(8), ' , ', mom_data(8)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 8m:', mom(10), ' , ', mom_data(10)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 12:', mom(12), ' , ', mom_data(12)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 16:', mom(14), ' , ', mom_data(14)
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival profile 20:', mom(16), ' , ', mom_data(16)

        


    
        !WRITE(13, *) 'lifecycle survival profile'
        write(13,*) '' 
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  2m:', mom(49), ' , ',mom_data(49)
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  4 :', mom(29), ' , ', mom_data(29)
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  8 :', mom(30), ' , ', mom_data(30)
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  12:', mom(31), ' , ', mom_data(31)
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  16:', mom(32), ' , ', mom_data(32)
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival young  20:', mom(33), ' , ', mom_data(33)
        
        write(13,*) '' 
        write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  2m:', mom(50), ' , ',mom_data(50)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  4m:', mom(34), ' , ',mom_data(34)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  8m:', mom(35), ' , ',mom_data(35)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  12:', mom(36), ' , ',mom_data(36)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  16:', mom(37), ' , ',mom_data(37)
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'u.survival prime  20:', mom(38), ' , ',mom_data(38)
    
        write(13,*) '' 
       WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob young w. dur 2 :', mom(39), ' , ', mom_data(39)
       WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob young w. dur 4 :', mom(40), ' , ', mom_data(40)
       WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob young w. dur 8 :', mom(41), ' , ', mom_data(41)
       WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob young w. dur 10:', mom(42), ' , ', mom_data(42)
       WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob young w. dur 12:', mom(43), ' , ', mom_data(43)
       
       write(13,*) '' 
       WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob prime w. dur 2 :', mom(44), ' , ',mom_data(44)
       WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob prime w. dur 4 :', mom(45), ' , ',mom_data(45)
       WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob prime w. dur 8 :', mom(46), ' , ',mom_data(46)
       WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob prime w. dur 10:', mom(47), ' , ',mom_data(47)
       WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob prime w. dur 12:', mom(48), ' , ',mom_data(48)
       
    
    !write(13,*) ' good times'
    write(13,*) '' 
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 1 good times:', mom(53), ' , ', mom_data(53)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 2 good times:', mom(54), ' , ',mom_data(54)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 3 good times:', mom(55), ' , ', mom_data(55)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 4 good times:', mom(56), ' , ',mom_data(56)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 5 good times:', mom(57), ' , ', mom_data(57)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 6 good times:', mom(58), ' , ',mom_data(58)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 7 good times:', mom(59), ' , ', mom_data(59)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 8 good times:', mom(60), ' , ',mom_data(60)
    
    write(13,*) ''
    !write(13,*) ' bad times '
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 1 bad times:', mom(61), ' , ', mom_data(61)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 2 bad times:', mom(62), ' , ',mom_data(62)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 3 bad times:', mom(63), ' , ', mom_data(63)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 4 bad times:', mom(64), ' , ',mom_data(64)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 5 bad times:', mom(65), ' , ', mom_data(65)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 6 bad times:', mom(66), ' , ',mom_data(66)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 7 bad times:', mom(67), ' , ', mom_data(67)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 8 bad times:', mom(68), ' , ',mom_data(68)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 9 bad times:', mom(69), ' , ', mom_data(69)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 10 bad times:', mom(70), ' , ',mom_data(70)
    write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 11 bad times:', mom(71), ' , ', mom_data(71)
    write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occmob dur 12 bad times:', mom(72), ' , ',mom_data(72)

    write(13,*) ''
    write(13,*) ''
    write(13,*) ' NET MOBILITY MOMENTS'
    write(13,*) ''
    
    WRITE(13,*) 'SUPEROCC TRANSITION MATRIX (TARGETED)'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix1_1:', mom(73)-1.0, ' , ', mom_data(73)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix1_2:', mom(74)-1.0, ' , ',mom_data(74)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix1_3:', mom(75)-1.0, ' , ', mom_data(75)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix1_4:', mom(76)-1.0, ' , ',mom_data(76)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix2_1:', mom(77)-1.0, ' , ', mom_data(77)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix2_2:', mom(78)-1.0, ' , ',mom_data(78)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix2_3:', mom(79)-1.0, ' , ', mom_data(79)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix2_4:', mom(80)-1.0, ' , ',mom_data(80)-1.0
            write(13,*) ' '
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix3_1:', mom(81)-1.0, ' , ', mom_data(81)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix3_2:', mom(82)-1.0, ' , ',mom_data(82)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix3_3:', mom(83)-1.0, ' , ', mom_data(83)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix3_4:', mom(84)-1.0, ' , ',mom_data(84)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix4_1:', mom(85)-1.0, ' , ', mom_data(85)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix4_2:', mom(86)-1.0, ' , ',mom_data(86)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix4_3:', mom(87)-1.0, ' , ', mom_data(87)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'transmatrix4_4:', mom(88)-1.0, ' , ',mom_data(88)-1.0
 
    !! end-of-window distribution (4 moment - info for 3 - for 3 parameters)
    WRITE(13,*) 'ENDPOINT DISTRIBUTION'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occ distr end, superocc1:', mom(89), ' , ', mom_data(89)
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occ distr end, superocc2:', mom(90), ' , ',mom_data(90)
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occ distr end, superocc3:', mom(91), ' , ', mom_data(91)
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'occ distr end, superocc4:', mom(92), ' , ',mom_data(92)
    
            WRITE(13,*) 'NET MOBILITY RATE, TIME AVERAGE'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'ave netmob superocc1:', mom(93)-1.0, ' , ', mom_data(93)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'ave netmob superocc2:', mom(94)-1.0, ' , ',mom_data(94)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'ave netmob superocc3:', mom(95)-1.0, ' , ', mom_data(95)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'ave netmob superocc4:', mom(96)-1.0, ' , ',mom_data(96)-1.0

            WRITE(13,*) ' SUPER OCC MOBILITY AND KEY RELATION BETWEEN INFLOWS AND NET FLOWS, REGRESSION'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'grand ave superocc staying:', mom(97), ' , ', mom_data(97)
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'appxfig 3b relation:', mom(98), ' , ',mom_data(98)

            
    WRITE(13,*) ' NET INFLOW DISTRIBUTION CHANGE OVER THE CYCLE'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change inflow prop, s.occ1:', mom(99)-1.0, ' , ', mom_data(99)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change inflow prop, s.occ2:', mom(100)-1.0, ' , ',mom_data(100)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change inflow prop, s.occ3:', mom(101)-1.0, ' , ', mom_data(101)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change inflow prop, s.occ4:', mom(102)-1.0, ' , ',mom_data(102)-1.0
    !! NET FLOW IN RECESSIONS
            WRITE(13,*) ' NET FLOWS IN RECESSINOS AND EXPANSIONS, PER SUPEROCC'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow recession, s.occ1:', mom(103)-1.0, ' , ', mom_data(103)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow recession, s.occ2:', mom(104)-1.0, ' , ',mom_data(104)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow recession, s.occ3:', mom(105)-1.0, ' , ', mom_data(105)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow recession, s.occ4:', mom(106)-1.0, ' , ',mom_data(106)-1.0

        !! NET FLOW IN GOOD TIMES
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow expansion, s.occ1:', mom(107)-1.0, ' , ', mom_data(107)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow expansion, s.occ2:', mom(108)-1.0, ' , ',mom_data(108)-1.0
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow expansion, s.occ3:', mom(109)-1.0, ' , ', mom_data(109)-1.0
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'net flow expansion, s.occ4:', mom(110)-1.0, ' , ',mom_data(110)-1.0

        
            WRITE(13,*) 'ELAS U DURATION IN SUPEROCC, to UNEMPLOYMENT RATE, NORMALIZED'
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'duration elasticity s.occ1:', mom(111), ' , ', mom_data(111)
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'duration elasticity s.occ2:', mom(112), ' , ',mom_data(112)
            write(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'duration elasticity s.occ3:', mom(113), ' , ', mom_data(113)
            write(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'duration elasticity s.occ4:', mom(114), ' , ',mom_data(114)


        
        WRITE(13,*) 'CYCLICAL RESPONSE NETFLOWS (implied by previous moments)'
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change netflow, s.occ1:', mom(117)-1.0, ' , ', mom_data(117)-1.0
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change netflow, s.occ2:', mom(118)-1.0, ' , ',mom_data(118)-1.0
        WRITE(13,FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change netflow, s.occ3:', mom(119)-1.0, ' , ', mom_data(119)-1.0
        WRITE(13, FMT='(1(A25, F8.4, A4, F8.4, A4 ))'), 'cycl change netflow, s.occ4:', mom(120)-1.0, ' , ',mom_data(120)-1.0
       
CLOSE(13)


OPEN(UNIT=13, file='ts_xcorrelations.txt', form='formatted', status='replace')



       WRITE(13, *) ' '
       WRITE(13, *) ' '
       WRITE(13, *) '======= '
       WRITE(13, *) ' CROSSCORRELATION TABLE **SMOOTHED** HPF-LOGGED '
       WRITE(13, *) '======== '

WRITE(13,*) ' '
WRITE(13,*) '==================================================='
WRITE(13, FMT='(A8,9(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "uall", "reall", "reall_chk"
WRITE(13, FMT='(A8,9(F9.2))') "stdev", sqrt(var_u5) , sqrt(var_v5)  , sqrt(var_theta5)  , sqrt(var_sep5) , sqrt(var_jf5) , &
sqrt(var_prod5) , sqrt(var_uall5) , sqrt(var_reall5), sqrt(var_reall5_2)
WRITE(13, FMT='(A8,8(F9.2))') "autocorr", ac_u5 , ac_v5  , ac_theta5  , ac_sep5 , ac_jf5 , &
ac_prod5 , ac_uall5 , ac_reall5
WRITE(13,*) '---------------------------------------------------'
WRITE(13, FMT='(A8,8(F9.2))') "u", var_u5 , corr_uv5  , corr_utheta5  , corr_usep5  , corr_ujf5  ,  &
corr_uprod5  , corr_uallu5  , corr_ureall5
WRITE(13, FMT='(A8,9X, 7(F9.2))') "v", var_v5  , corr_vtheta5  , corr_vsep5  , corr_vjf5  ,  &
corr_vprod5  , corr_uallv5  , corr_vreall5
WRITE(13, FMT='(A8,18X, 6(F9.2))') "theta", var_theta5, corr_thetasep5  , corr_thetajf5  ,  &
corr_thetaprod5  , corr_ualltheta5  , corr_thetareall5
WRITE(13, FMT='(A8,27X, 5(F9.2))') "sep",  var_sep5 , corr_sepjf5  ,  &
corr_sepprod5  , corr_uallsep5  , corr_sepreall5
WRITE(13, FMT='(A8,36X, 4(F9.2))') "jf",  var_jf5,  &
corr_jfprod5 , corr_ualljf5  , corr_jfreall5
WRITE(13, FMT='(A8,45X, 3(F9.2))') "prod5", var_prod5, corr_uallprod5  , corr_prodreall5
WRITE(13, FMT='(A8,54X, 2(F9.2))') "uall", var_uall5 , corr_uallreall5
WRITE(13, FMT='(A8,63X, (F9.2))') "reall", var_reall5
WRITE(13,*) '--------------------------------------------------'



CLOSE(13)


OPEN(UNIT=13, file='ts_xcorrelations_unsmoothed.txt', form='formatted', status='replace')


       WRITE(13, *) ' '
       WRITE(13, *) ' '
       WRITE(13, *) '====================== '
       WRITE(13, *) ' UNSMOOTHED HPF-LOGGED '
       WRITE(13, *) '====================== '

WRITE(13,*) ' '
WRITE(13,*) '==================================================='
WRITE(13, FMT='(A8,8(A9))')"statistc", "u", "v", "tghtness", "sep",  "jb find", "prod", "uall", "reall"
WRITE(13, FMT='(A8,8(F9.2))') "stdev", sqrt(var_u) , sqrt(var_v)  , sqrt(var_theta)  , sqrt(var_sep) , sqrt(var_jf) , &
sqrt(var_prod) , sqrt(var_uall) , sqrt(var_reall)
WRITE(13, FMT='(A8,8(F9.2))') "autocorr", ac_u , ac_v  , ac_theta  , ac_sep , ac_jf , &
ac_prod , ac_uall , ac_reall
WRITE(13,*) '---------------------------------------------------'
WRITE(13, FMT='(A8,8(F9.2))') "u", var_u , corr_uv  , corr_utheta  , corr_usep  , corr_ujf  ,  &
corr_uprod  , corr_uallu  , corr_ureall
WRITE(13, FMT='(A8,9X, 7(F9.2))') "v", var_v  , corr_vtheta  , corr_vsep  , corr_vjf  ,  &
corr_vprod  , corr_uallv  , corr_vreall
WRITE(13, FMT='(A8,18X, 6(F9.2))') "theta", var_theta, corr_thetasep  , corr_thetajf  ,  &
corr_thetaprod  , corr_ualltheta  , corr_thetareall
WRITE(13, FMT='(A8,27X, 5(F9.2))') "sep",  var_sep , corr_sepjf  ,  &
corr_sepprod  , corr_uallsep , corr_sepreall
WRITE(13, FMT='(A8,36X, 4(F9.2))') "jf",  var_jf,  corr_jfprod , corr_ualljf  , corr_jfreall
WRITE(13, FMT='(A8,45X, 3(F9.2))') "prod", var_prod, corr_uallprod  , corr_prodreall
WRITE(13, FMT='(A8,54X, 2(F9.2))') "uall", var_uall , corr_uallreall
WRITE(13, FMT='(A8,63X, (F9.2))') "reall", var_reall
WRITE(13,*) '--------------------------------------------------'

CLOSE(13)

OPEN(UNIT=13, file='incompl_durdistr_stats.txt', form='formatted', status='replace')
WRITE(13,*) ' '
WRITE(13,*) ' '
WRITE(13,*) '~~~~ INCOMPL U DURATION DISTRIBUTION FROM SIPP, ALL (MODEL -- DATA)'
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) ' < 3months', uprop_3m_ave, '--', uprop_3m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) '< 5months', uprop_5m_ave, '--', uprop_5m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) '5-9 months', uprop_9m_ave, '--', uprop_9m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) '9-13months ', uprop_13m_ave, '--', uprop_13m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) '13-18months ', uprop_g13m_ave, '--', uprop_g13m_ave_data
WRITE(13,*) '~~~~ INCOMPL U DISTRIBUTION: **YNG VS PRM** (MODEL -- DATA)' 
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop 1-2m;    yng:', uprop_yng_3m_ave, '--', uprop_yng_3m_ave_data,   ' prm: ', uprop_prm_3m_ave, '--', uprop_prm_3m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop 1-4m;    yng:', uprop_yng_5m_ave, '--', uprop_yng_5m_ave_data,   ' prm: ', uprop_prm_5m_ave, '--', uprop_prm_5m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop 5-8m;    yng:', uprop_yng_9m_ave, '--', uprop_yng_9m_ave_data,   ' prm: ', uprop_prm_9m_ave, '--', uprop_prm_9m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop 9-12m;   yng:', uprop_yng_13m_ave, '--', uprop_yng_13m_ave_data, ' prm: ', uprop_prm_13m_ave, '--', uprop_prm_13m_ave_data
WRITE(13,FMT='(2(A20, F5.2, A2, F5.2))' ) 'prop >=13m;   yng:', uprop_yng_g13m_ave, '--',uprop_yng_g13m_ave_data,' prm: ', uprop_prm_g13m_ave, '--', uprop_prm_g13m_ave_data

WRITE(13,*) ' '
WRITE(13,*) ' '
WRITE(13,*) ' - HP-FILT. SEMI-ELASTICITY OF DURATION DIST TO UNEMPLOYMENT RATE-'
!WRITE(13,*) 'prop u<3m  :', hp_uprop3m_unemp_semielasticity, '--', hp_uprop3m_unemp_semielasticity_instdata
!WRITE(13,*) 'prop u<5m  :', hp_uprop5m_unemp_semielasticity, '--', hp_uprop5m_unemp_semielasticity_instdata
!WRITE(13,*) 'prop u5-9  :', hp_uprop9m_unemp_semielasticity, '--', hp_uprop9m_unemp_semielasticity_instdata
!WRITE(13,*) 'prop u9-13 :', hp_uprop13m_unemp_semielasticity, '--', hp_uprop13m_unemp_semielasticity_instdata
!WRITE(13,*) 'prop u13-8 :', hp_upropg13m_unemp_semielasticity, '--', hp_upropg13m_unemp_semielasticity_instdata
WRITE(13,*) 'prop u<3m  :', sm_hp_uprop3m_u_semi_el, '--', hp_uprop3m_unemp_semielasticity_instdata
WRITE(13,*) 'prop u<5m  :', sm_hp_uprop5m_u_semi_el, '--', hp_uprop5m_unemp_semielasticity_instdata
WRITE(13,*) 'prop u5-9  :', sm_hp_uprop9m_u_semi_el,  '--', hp_uprop9m_unemp_semielasticity_instdata
WRITE(13,*) 'prop u9-13 :', sm_hp_uprop13m_u_semi_el, '--', hp_uprop13m_unemp_semielasticity_instdata
WRITE(13,*) 'prop u13-8 :', sm_hp_upropg13m_u_semi_el,  '--', hp_upropg13m_unemp_semielasticity_instdata

WRITE(13,*) '  -note: NaN could occur if empty quarterly obs at high duration in simulation, '
WRITE(13,*) '              increase nsim_gen in mod_global_ctv.f90                               '
WRITE(13,*) ' '
WRITE(13,*) ' '
WRITE(13,*) ' - (LIN. DETRENDED, NO HPF) ELASTICITY DURATION DIST TO UNEMPLOYMENT RATE-'
write(13,*) 'prop u<3m  :', u3m_unemp_elasticity, '--', u3m_unemp_elasticity_data
write(13,*) 'prop u<5m  :', u5m_unemp_elasticity, '--', u5m_unemp_elasticity_data
write(13,*) 'prop u5-9m :', u9m_unemp_elasticity, '--', u9m_unemp_elasticity_data
write(13,*) 'prop u9-13m:', u13m_unemp_elasticity, '--', u13m_unemp_elasticity_data
write(13,*) 'prop >13m  :', ug13m_unemp_elasticity, '--', ug13m_unemp_elasticity_data
WRITE(13,*) '  -note: NaN could occur if empty quarterly obs at high duration in simulation, '
WRITE(13,*) '              increase nsim_gen in mod_global_ctv.f90                               '
WRITE(13,*) ' '
write(13, *) ' SEMI ELAST AVE U DURATION OF MOVERS/STAYERS WITH U.RATE (LIN DETRENDED)'
write(13, FMT='(A24,A10, A2, A10 , A2, A10, A2, A10)')      'MEASURE', '1-18mth sp', '--', 'data 1-18', ',,', 'all spells', ',', 'data all'
write(13, FMT='(A24,F10.3, A2, F10.3 , A2,E10.2, A2, E10.2)') 'OCC MOVERS :', udur_occ_with_lu, '--', udur_occ_with_lu_data
write(13, FMT='(A24,F10.3, A2, F10.3 , A2,E10.2, A2, E10.2)') 'OCC STAYERS:', udur_nocc_with_lu, '--', udur_nocc_with_lu_data
WRITE(13,*) ' '
WRITE(13,*) ' '
write(13, *) ' SEMI ELAST AVE U DURATION OF MOVERS/STAYERS WITH U.RATE (HP FILTERED)'
write(13, FMT='(A24,F10.3, A2, F10.3 , A2,E10.2, A2, E10.2)') 'OCC MOVERS :', udur_occ_with_hplu, '--', udur_occ_with_hplu_data
write(13, FMT='(A24,F10.3, A2, F10.3 , A2,E10.2, A2, E10.2)') 'OCC STAYERS:', udur_nocc_with_hplu, '--', udur_nocc_with_hplu_data
WRITE(13,*) ' '
WRITE(13,*) ' '
write(13, *) ' UALL_INCLUDING_ENTRY=', uall_ave
        
    
CLOSE(13)

OPEN(UNIT=13, file='further_stats.txt', form='formatted', status='replace')

WRITE(13,*) ' '
    
    
    WRITE(13, *) 'FOOTNOTE 22 SEPARATION cond. on move/stayer previous u spell (MODEL--DATA)'
    WRITE(13,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') 'ave mthly sep after move:', sepocc_ave, ' -- ', sepocc_ave_data
    WRITE(13,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') 'ave mthly sep after stay:', sepnocc_ave, ' -- ', sepnocc_ave_data
    
    WRITE(13, *) '' 
    WRITE(13, *) 'STRONGER RELATIVE RESPONSE TO SEPARATIONS OF PRIME TO YOUNG, MODEL'
    WRITE(13, *) '   (elasticity hp-filtered sep with hp-filtered productivity) '
    WRITE(13,*) 'sep young:', sep_young_prod_elasticity 
    WRITE(13,*) 'sep prime:', sep_prime_prod_elasticity 

    WRITE(13, *) '' 
    WRITE(13, *) 'SLIGHTLY STRONGER REL. RESPONSE U RATE OF PRIME TO YOUNG, MODEL'
    WRITE(13, *) '   (elasticity hp-filtered u with hp-filtered productivity) '
    WRITE(13,*) 'unempl young:', u_young_prod_elasticity
    WRITE(13,*) 'unempl prime:', u_prime_prod_elasticity

    WRITE(13, *) ''
    WRITE(13, *) 'mM ratio in the model'
    
    WRITE(13, FMT='(A40, X, F11.4)') 'min-Mean, all wages:                    ', m0mratio_all
    WRITE(13, FMT='(A40, X, F11.4)') 'min-Mean, controlling for age:          ', m0mratio_age_contr
    WRITE(13, FMT='(A40, X, F11.4)') 'min-Mean, controlling for age and cycle:', m0mratio_age_p_contr
    
    WRITE(13, FMT='(A40, X, F11.4)') '1st ptile-Mean, all wages:                    ', m1mratio_all
    WRITE(13, FMT='(A40, X, F11.4)') '1st ptile-Mean, controlling for age:          ', m1mratio_age_contr
    WRITE(13, FMT='(A40, X, F11.4)') '1st ptile-Mean, controlling for age and cycle:', m1mratio_age_p_contr
    
    WRITE(13, *) 'Preferred measure: min-Mean, controls age, cycle' 
    
    
    WRITE(13, *) ''
    WRITE(13, *) 'model generates that u is more concentrated for prime-aged'
    WRITE(13,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~u prop window ~~~~ ', uproportion_window, ' -- ', uproportion_window_data
    WRITE(13,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~uprop window yng ~ ', uproportion_window_y, ' --', uproportion_window_y_data
    WRITE(13,FMT='(A27, F9.4, A5, F9.4, A5, F9.4)') '~~~~uprop window prm ~ ', uproportion_window_p, ' -- ', uproportion_window_p_data



CLOSE(13)



!!  EXCESS NET MOBILITY duration profile 
OPEN(UNIT=13, file='xsnetprofile.csv', form='formatted', status='replace')

WRITE(13,FMT='(A3, A3, 6(A9,A3) )') 'dur', ' , ' , 'netmobdur', ' , ', 'cnetmobdr', ' , ', 'grsmobdur', ' , ', 'cgrsmobdr', ' , ' , &
                                                   'xsmobdur ' , ' , ', 'cxsmobdur', ' , '
DO t=1, 18
    WRITE(13,FMT='(I3, A3, 6(F9.5, A3))') t, ' , ', overall_netmobdur(t), ' , ' , overall_corr_netmobdur(t), ' , ' , &
                                overall_grossmobdur(t), ' , ' , overall_corr_grossmobdur(t),  ' , ' , &
                                overall_xsmobdur(t), ' , ' , overall_corr_xsmobdur(t), ' , '
END DO 

CLOSE(13)



!shifts_netflow_inflow.csv

! superocc_id, superocc_label, -infl_cshft_m, nmob_cshft_m, netmob_rec_m, netmob_exp_m, transmat_to_1, ... transmat_to_4, begin_distr, enddistr, duration elasticity, decomposition
! this also includes 'table 6'
OPEN(UNIT=13, file='shifts_netflow_inflow.csv', form='formatted', status='replace')

WRITE(13,FMT='(4(A17, A3))', ADVANCE='no') 'occupation', ' , ' , 'occlabel', ' , ' , 'infl_cshift_m', ' , ', 'nmob_cshift_m', ' , '
WRITE(13,FMT='(3(A17, A3))', ADVANCE='no')  'netmob_rec_m', ' , ', 'netmob_exp_m', ' , ' , 'netmob_ave_m' , ' , '
WRITE(13,FMT='(4(A17, A3))', ADVANCE='no') 'transmat_to_1_m', ' , ', 'transmat_to_2_m', ' , ', 'transmat_to_3_m', ' , ', 'transmat_to_4_m', ' , ' 
WRITE(13,FMT='(1(A17, A3))', ADVANCE='no') 'udur_elas_raw_m', ' , '
WRITE(13,FMT='(4(A17, A3))', ADVANCE='no')  'udur_elas_m', ' , ', 'begin_distr', ' , ', 'end_distr_m', ' , ','end_distr_d', ' , '
WRITE(13,FMT='(4(A17, A3))')  'decomp_exofl_m', ' , ', 'decomp_endofl_m', ' , ', 'decomp_endo_gd_m', ' , ','decomp_endo_bad_m', ' , '

DO t=1, 4
        WRITE(13,FMT='((I17, A3))', ADVANCE='no') t, ' , ' 
        IF (t == 1) WRITE(13,FMT='((A17, A3))', ADVANCE='no'), 'NRC', ' , ' 
        IF (t == 2) WRITE(13,FMT='((A17, A3))', ADVANCE='no'), 'RC', ' , ' 
        IF (t == 3) WRITE(13,FMT='((A17, A3))', ADVANCE='no'), 'NRM', ' , ' 
        IF (t == 4) WRITE(13,FMT='((A17, A3))', ADVANCE='no'), 'RM', ' , ' 
            
        !! since the netflow, inflow stats are calculated from the flow matrix and not stored separately other than in the moment
        !! conditions we use the moments here to report these stats; be careful when changing the moments!
        
        WRITE(13,FMT='(2(F17.4, A3))', ADVANCE='no'), mom(98+t)-1.0, ' , ', mom(116+t)-1.0, ' , '
        WRITE(13,FMT='(3(F17.4, A3))', ADVANCE='no')  mom(102+t)-1.0, ' , ', mom(106+t)-1.0, ' , ' , mom(92+t)-1.0 , ' , '

        
            

        
        IF (t==1) WRITE(13,FMT='(4(F17.4, A3))', ADVANCE='no') mom(73)-1.0, ' , ', mom(74)-1.0, ' , ', mom(75)-1.0, ' , ', mom(76)-1.0, ' , ' 
        IF (t==2) WRITE(13,FMT='(4(F17.4, A3))', ADVANCE='no') mom(77)-1.0, ' , ', mom(78)-1.0, ' , ', mom(79)-1.0, ' , ', mom(80)-1.0, ' , ' 
        IF (t==3) WRITE(13,FMT='(4(F17.4, A3))', ADVANCE='no') mom(81)-1.0, ' , ', mom(82)-1.0, ' , ', mom(83)-1.0, ' , ', mom(84)-1.0, ' , ' 
        IF (t==4) WRITE(13,FMT='(4(F17.4, A3))', ADVANCE='no') mom(85)-1.0, ' , ', mom(86)-1.0, ' , ', mom(87)-1.0, ' , ', mom(88)-1.0, ' , ' 

        
        tempreal=0.0
        DO occcnt=1, occpts
            tempreal=tempreal+0.5*(occdistr_begin_end(occcnt, 1)+occdistr_begin_end(occcnt, 2))*udur_supocc_unemp_elasticity_ldt(occcnt)
        END DO
        
        WRITE(13,FMT='(1(F17.4, A3))', ADVANCE='no')  udur_supocc_unemp_elasticity_ldt(t), ' , '
        WRITE(13,FMT='(4(F17.4, A3))', ADVANCE='no')  udur_supocc_unemp_elasticity_ldt(t)/tempreal, ' , ', corr_occdistr_begin_end_data(t,1), ' , ', corr_occdistr_end_v3(t), ' , ',corr_occdistr_begin_end_data(t,2), ' , '

            ! windows of measurement of endogenous flows in model not full window of occupation size change, hence proportionality adjustment

            ! total change in size in the model
            tempreal5=corr_occdistr_end_v3(t)-corr_occdistr_begin_end_data(t,1)
            ! exo entry, exit in all times (.,1) is newborns in occ; (.,2) is deaths in occupation
            tempreal=-(corr_occdistr_exo_entry_exit(t,2)-corr_occdistr_exo_entry_exit(t,1))/(REAL(nsim_gen)*no_superwindows)
            ! tempreal6=remainder explained by endogenous mobility
            tempreal6=tempreal5-tempreal
            ! endo good times, restricted window
            tempreal2=-(corr_occdistr_endo_entry_exit_goodp50(t,2)-corr_occdistr_endo_entry_exit_goodp50(t,1))/(REAL(nsim_gen)*no_superwindows)
            ! endo bad times, restricted window
            tempreal3= -(corr_occdistr_endo_entry_exit_badp50(t,2)-corr_occdistr_endo_entry_exit_badp50(t,1))/(REAL(nsim_gen)*no_superwindows)
            ! endo all time, restricted window
            tempreal4=tempreal2+tempreal3
                
            ! adjustment for restricted window
            tempreal6=tempreal6/tempreal4
            
            ! make it percentage terms
            tempreal=tempreal
            tempreal2=tempreal2*tempreal6
            tempreal3=tempreal3*tempreal6
            tempreal4=tempreal4*tempreal6

        
        WRITE(13,FMT='(4(F17.4, A3))')  tempreal, ' , ', tempreal4, ' , ', tempreal2, ' , ',tempreal3, ' , '
END DO 
CLOSE(13)

! table 6 calculations 




filename='weights'//trim(file_id)//trim(x1)//'.csv'
OPEN(UNIT=12, file=filename, form='formatted', status='replace')

DO pcnt=1, nmom_local
            write(12, fmt='(A6,I3,A1,I3,A2)', advance='no') 'omega(',pcnt, ',', pcnt, ')='
            write(12, fmt='(F12.6)') momweightl(pcnt)
END DO

CLOSE(12)



!filename='mobsurvprofiles'//trim(file_id)//trim(x1)//'.csv'
!OPEN(UNIT=12, file=filename, form='formatted', status='replace')
!
!WRITE(12, FMT='(A5, A1)' , ADVANCE='NO') 'month', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur',','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_yng',','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_prm',','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_prm_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm_data', ','
!
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm_data', ','
!
!
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_prm_data', ','
!
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_prm_data', ','
!
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_yng', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_prm', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_yng_data', ','
!WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_prm_data', ','
!
!WRITE(12, FMT='(A1)' ) ','
!
!DO pcnt=1,18
!
!
!    WRITE(12, FMT='(A5, A1)' , ADVANCE='NO') 'month', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur',','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_yng',','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_prm',','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_prm_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm_data', ','
!
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_st_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_18_mv_prm_data', ','
!
!
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_st_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_lt_mv_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p33_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p50_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'surv_p67_prm_data', ','
!
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p33_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p50_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'mobdur_p67_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p33_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p50_prm_data', ','
!
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_yng', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_prm', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_yng_data', ','
!    WRITE(12, FMT='(A20, A1)' , ADVANCE='NO') 'cmobdur_p67_prm_data', ','
!
!    WRITE(12, FMT='(A1)' ) ','
!
!
!END DO
!
!
!DO pcnt=19, 24
!
!
!END DO
!
!CLOSE(12)
!
!

!!======================
!! PROFILES FILE
!!======================

filename='profile'//trim(file_id)//trim(x1)//'.csv'
OPEN(UNIT=12, file=filename, form='formatted', status='replace')

WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'month', ','
!! CORRECTED MOBILITY
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdury_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdury_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdurp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'cmdurp_d', ','
!! RAW MOBILITY
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdury_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdury_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdurp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mdurp_d', ','
!! CYCLICAL MOB
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badcmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badcmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdcmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdcmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdmdur_d', ','
    !! spells in distribution in good and bad times
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badnspel_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badnspel_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdnspel_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdnspel_d', ','
    !! conf interval
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badcm_lb_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'badcm_ub_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdcm_lb_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'gdcm_ub_d', ','
!! SURVIVAL
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'surv_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'surv_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'survy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'survy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'survp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'survp_d', ','
!! stayers survival
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurv_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurv_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurvy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurvy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurvp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'stsurvp_d', ','
!! movers survival
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurv_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurv_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurvy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurvy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurvp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvsurvp_d', ','
!! HAZARDS
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'haz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'haz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'hazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'hazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'hazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'hazp_d', ','
!! stayers haz
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthaz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthaz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'sthazp_d', ','
!! movers haz
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhaz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhaz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') 'mvhazp_d', ','
!! separations after new hire
WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') 'sepallyr_m', ',','sepallyr_d', ','
WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') 'seprhire_m', ',','seprhire_d', ','
WRITE(12,FMT='(A10,A1)') '-----', ','


DO tcnt=1, 18
WRITE(12,FMT='(I10,A1)', ADVANCE='NO') tcnt, ','
!! CORRECTED MOBILITY
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_prime_data(tcnt), ','
!! RAW MOBILITY
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_prime_data(tcnt), ','
!! CYCLICAL MOB
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_p67(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_p67_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p67(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p67_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_p33(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cr_cocc_p33_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p33(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p33_data(tcnt), ','
    !! spells in distribution in good and bad times
IF (tcnt==1) THEN
    WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0, ','
ELSE
    WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_nocc_p67(tcnt), ','
END IF

WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_durationmatrix_nocc_p67_data(tcnt), ','

IF (tcnt==1) THEN
    WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0, ','
ELSE
    WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_nocc_p33(tcnt), ','
END IF

WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') (1.0-tot_durationmatrix_nocc_p33_data(tcnt)), ','

!! conf interval
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p67_lb_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p67_ub_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p33_lb_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_cocc_p33_ub_data(tcnt), ','

!! SURVIVAL
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_prime_data(tcnt), ','
!! stayers survival
tempint=1!! adjustment
!tot_durationmatrix2_nocc_young_data
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_young_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_prime_data(tcnt-tempint), ','
!! movers survival
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_young_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_prime_data(tcnt-tempint), ','
!! HAZARDS
 !WRITE(13,FMT='(I7,X,6(A3, F7.3))') tcnt-1, ' a:',1.0-tot_haz_durationmatrix(tcnt), ' y:', 1.0-tot_haz_durationmatrix_young(tcnt),' p:', 1.0-tot_haz_durationmatrix_prime(tcnt), &
 !                                   '|a:', tot_haz_durationmatrix_data(tcnt),' y:', tot_haz_durationmatrix_young_data(tcnt),' p:', tot_haz_durationmatrix_prime_data(tcnt)

WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_durationmatrix(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_durationmatrix_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_durationmatrix_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_durationmatrix_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_durationmatrix_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_durationmatrix_prime_data(tcnt), ','
!! stayers haz
!WRITE(13,FMT='(I7,X,6(A3, F7.3))') tcnt-1, ' a:',1.0-tot_haz_udurationmatrix_m(tcnt), ' y:', 1.0-tot_haz_udurationmatrix_m_young(tcnt),' p:', 1.0-tot_haz_udurationmatrix_m_prime(tcnt), &
!                                    '|a:', tot_haz_udurationmatrix_m_data(tcnt),' y:', tot_haz_udurationmatrix_m_young_data(tcnt),' p:', tot_haz_udurationmatrix_m_prime_data(tcnt)
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_s(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_s_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_s_young(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_s_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_s_prime(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_s_prime_data(tcnt), ','
!! movers haz
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_m(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_m_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_m_young(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_m_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 1.0-tot_haz_udurationmatrix_m_prime(tcnt+1), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_haz_udurationmatrix_m_prime_data(tcnt), ','
!! separations after new hire
!WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 'sepallyr', ','
!WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') 'seprhireyr', ','
   IF(tcnt==1) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_1m, ',', sep_ave_1m_data, ','
   IF(tcnt==2) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_2m, ',', sep_ave_2m_data, ','
   IF(tcnt==3) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_3m, ',', sep_ave_3m_data, ','
   IF(tcnt==4) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_4m, ',', sep_ave_4m_data, ','
   IF(tcnt==5) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_5m, ',', sep_ave_5m_data, ','
   IF(tcnt==6) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_6m, ',', sep_ave_6m_data, ','
   IF(tcnt==7) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_7m, ',', sep_ave_7m_data, ','
   IF(tcnt==8) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_8m, ',', sep_ave_8m_data, ','
   IF(tcnt==9) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_9m, ',', sep_ave_9m_data, ','
   IF(tcnt==10) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_10m, ',', sep_ave_10m_data, ','
   IF(tcnt==11) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_11m, ',', sep_ave_11m_data, ','
   IF(tcnt==12) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_12m, ',', sep_ave_12m_data, ','
   IF(tcnt>12) WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') ' ', ',', ' ' , ','
 !   WRITE(13,* ) ' separations in first year after hire'
   IF(tcnt==1) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_1m_posthire, ',', sep_ave_1m_posthire_data, ','
   IF(tcnt==2) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_2m_posthire, ',', sep_ave_2m_posthire_data, ','
   IF(tcnt==3) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_3m_posthire, ',', sep_ave_3m_posthire_data, ','
   IF(tcnt==4) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_4m_posthire, ',', sep_ave_4m_posthire_data, ','
   IF(tcnt==5) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_5m_posthire, ',', sep_ave_5m_posthire_data, ','
   IF(tcnt==6) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_6m_posthire, ',', sep_ave_6m_posthire_data, ','
   IF(tcnt==7) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_7m_posthire, ',', sep_ave_7m_posthire_data, ','
   IF(tcnt==8) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_8m_posthire, ',', sep_ave_8m_posthire_data, ','
   IF(tcnt==9) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_9m_posthire, ',', sep_ave_9m_posthire_data, ','
   IF(tcnt==10) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_10m_posthire, ',', sep_ave_10m_posthire_data, ','
   IF(tcnt==11) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_11m_posthire, ',', sep_ave_11m_posthire_data, ','
   IF(tcnt==12) WRITE(12,FMT='(2(F10.4,A1))', ADVANCE='NO') sep_ave_12m_posthire, ',', sep_ave_12m_posthire_data, ','
   IF(tcnt>12) WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') ' ', ',', ' ' , ','
WRITE(12,FMT='(A10,A1)') '-----', ','

END DO

!! MONTHS 19 and 20: survival rates
DO tcnt=19,20
    WRITE(12,FMT='(I10,A1)', ADVANCE='NO') tcnt, ','
!! CORRECTED MOBILITY
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdury_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdury_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdurp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'cmdurp_d', ','
!! RAW MOBILITY
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdury_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdury_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdurp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mdurp_d', ','
!! CYCLICAL MOB
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badcmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badcmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdcmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdcmdur_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdmdur_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdmdur_d', ','
    !! spells in distribution in good and bad times
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badnspel_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badnspel_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdnspel_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdnspel_d', ','
    !! conf interval
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badcm_lb_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'badcm_ub_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdcm_lb_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'gdcm_ub_d', ','
!! SURVIVAL
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_young_data(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix_prime_data(tcnt), ','
!! stayers survival
tempint=1!! adjustment
!tot_durationmatrix2_nocc_young_data
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_young_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_nocc_prime_data(tcnt-tempint), ','
!! movers survival
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_young(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_young_data(tcnt-tempint), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_prime(tcnt), ','
WRITE(12,FMT='(F10.4,A1)', ADVANCE='NO') tot_durationmatrix2_cocc_prime_data(tcnt-tempint), ','
!! HAZARDS
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'haz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'haz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'hazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'hazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'hazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'hazp_d', ','
!! stayers haz
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthaz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthaz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'sthazp_d', ','
!! movers haz
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhaz_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhaz_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhazy_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhazy_d', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhazp_m', ','
WRITE(12,FMT='(A10,A1)', ADVANCE='NO') ' ', ',' ! 'mvhazp_d', ','
!! separations after new hire
WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') ' ', ',' ! 'sepallyr_m', ',','sepallyr_d', ','
WRITE(12,FMT='(2(A10,A1))', ADVANCE='NO') ' ', ',' ! 'seprhire_m', ',','seprhire_d', ','
WRITE(12,FMT='(A10,A1)') '-----', ','


END DO
CLOSE(12)




filename='dist_best'//trim(file_id)//trim(x1)//'.csv'
OPEN(UNIT=35, file=filename, form='formatted', status='replace')

WRITE(35, FMT='(A4, A1)' , ADVANCE='NO') 'pidx', ','
WRITE(35, FMT='(A4, A1)' , ADVANCE='NO') 'xidx', ','
WRITE(35, FMT='(A4, A1)' , ADVANCE='NO') 'zidx', ','
WRITE(35, FMT='(A4, A1)' , ADVANCE='NO') 'oidx', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'p_level', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'x_level', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_level', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'occ_level', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'prod', ','
!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'wage', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'pdist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'zdist', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_prime', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_x', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_young_x', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_prime_x', ','

!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_x', ','
!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_young_x', ','
!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'epz_dist_prime_x', ','


WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist_prime', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist_x', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist_young_x', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'upz_dist_prime_x', ','

! UNEMPLOYMENT DECOMPOSITION
    !REAL(8), DIMENSION(ppts) :: up_young_distribution_sim
    !REAL(8), DIMENSION(ppts) :: up_prime_distribution_sim
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'uallp_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_dist_prime', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_search_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_search_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_search_dist_prime', ','


WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_rest_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_rest_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_rest_dist_prime', ','


WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_reall_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_reall_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'up_reall_dist_prime', ','


!! distribution of (employed and unemployed over islands with different aggregate states
    !REAL(8), DIMENSION(ppts, zpts) :: upz_distribution_sim, epz_distribution_sim
    !REAL(8), DIMENSION(ppts, zpts) :: upz_young_distribution_sim, epz_young_distribution_sim
    !REAL(8), DIMENSION(ppts, zpts) :: upz_prime_distribution_sim, epz_prime_distribution_sim
    !! total rest, reallocation, search unemployment
    !! distribution of (employed and )unemployed with aggregate states



WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'e_dist_e1yb4_x', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'sep_dist_e1yb4_x', ','
!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_r_binary', ','
!WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_s_binary', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_r_func', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_s_func', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_r_val', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'z_s_val', ','


WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'eopz_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'eopz_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'eopz_dist_prime', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'eopxz_dist', ','

WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'uopz_dist', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'uopz_dist_young', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'uopz_dist_prime', ','
WRITE(35, FMT='(A20, A1)' , ADVANCE='NO') 'uopxz_dist', ','

WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_search_dist', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_search_dist_young', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_search_dist_prime', ','

WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_rest_dist', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_rest_dist_young', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_rest_dist_prime', ','

WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_reall_dist', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_reall_dist_young', ','
WRITE(35, FMT='(A21, A1)' , ADVANCE='NO') 'uop_reall_dist_prime', ','



WRITE(35, FMT='(A1)' ) ','



    !                                        epz_xallp_distribution_sim, epz_xallp_young_distribution_sim, epz_xallp_prime_distribution_sim, &
    !                                        epz_1yb4_x_distribution_sim, sep_epz_1yb4_x_distribution_sim
    !

DO pcnt=1,ppts
DO xcnt=1, xpts
DO zcnt=1, zpts
DO occcnt=0, occpts

WRITE(35, FMT='(I4, A1)' , ADVANCE='NO') pcnt, ','
WRITE(35, FMT='(I4, A1)' , ADVANCE='NO') xcnt, ','
WRITE(35, FMT='(I4, A1)' , ADVANCE='NO') zcnt, ','
WRITE(35, FMT='(I4, A1)' , ADVANCE='NO') occcnt, ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') pvector(pcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') xvector(xcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') zvector(zcnt), ','
IF(occcnt==0) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') -1.0_8, ','
ELSE IF (occcnt>0 .AND. occcnt<=occpts) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') occprodvector(occcnt), ','
END IF

IF(occcnt==0) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') pfunction(pcnt, xcnt, zcnt), ','
ELSE IF (occcnt>0 .AND. occcnt<=occpts) THEN
    ! can be filled later
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') (occprodvector(occcnt)*pvector(pcnt))**occaggprod_elas(occcnt)  , ','
END IF


!WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') wage(pcnt,xcnt,zcnt), ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') p_distribution_sim(pcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') znewpdf(zcnt), ','

! EMPLOYMENT PER AGE
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_distribution_sim(pcnt, zcnt), ','
!epz_x_young_distribution_sim, epz_x_prime_distribution_sim
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_young_distribution_sim(pcnt, zcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_prime_distribution_sim(pcnt, zcnt), ','


! EMPLOYMENT PER HC LEVEL
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_x_distribution_sim(pcnt, xcnt, zcnt), ','
!epz_x_young_distribution_sim, epz_x_prime_distribution_sim
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_x_young_distribution_sim(pcnt, xcnt, zcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_x_prime_distribution_sim(pcnt, xcnt, zcnt), ','



! UNEMPLOYMENT PER AGE
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_distribution_sim(pcnt, zcnt), ','
!epz_x_young_distribution_sim, epz_x_prime_distribution_sim
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_young_distribution_sim(pcnt, zcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_prime_distribution_sim(pcnt, zcnt), ','

! UNEMPLOYMENT PER HC LEVEL
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_x_distribution_sim(pcnt, xcnt, zcnt), ','
!epz_x_young_distribution_sim, epz_x_prime_distribution_sim
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_x_young_distribution_sim(pcnt, xcnt, zcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_x_prime_distribution_sim(pcnt, xcnt, zcnt), ','


! UNEMPLOYMENT RATES, THEN SPLIT OVER SEARCH REST REALLOCATION
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uallp_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_distribution_sim(pcnt), ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_search_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_search_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_search_distribution_sim(pcnt), ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_rest_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_rest_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_rest_distribution_sim(pcnt), ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_reall_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_reall_distribution_sim(pcnt),  ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_reall_distribution_sim(pcnt), ','

WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_1yb4_x_distribution_sim(pcnt, xcnt, zcnt), ','
WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') sep_epz_1yb4_x_distribution_sim(pcnt, xcnt, zcnt), ','
!

!! cutoff z-values (as a function of p,x)
IF (occcnt==0) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') reservation_zr(pcnt, xcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') reservation_zq(pcnt, xcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') zvector(MAX(1, MIN(reservation_zr(pcnt, xcnt),zpts))), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') zvector(MAX(1, MIN(reservation_zq(pcnt, xcnt),zpts))), ','
ELSE IF (occcnt>0 .AND. occcnt<=occpts) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') reservation_zr_occ(occcnt,pcnt, xcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') reservation_zq_occ(occcnt,pcnt, xcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') zvector(MAX(1, MIN(reservation_zr_occ(occcnt,pcnt, xcnt),zpts))), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') zvector(MAX(1, MIN(reservation_zq_occ(occcnt,pcnt, xcnt),zpts))), ','
END IF

!! supp occ spec 
IF (occcnt==0) THEN
      WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_distribution_sim(pcnt, zcnt), ','
    !epz_x_young_distribution_sim, epz_x_prime_distribution_sim
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_young_distribution_sim(pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') epz_prime_distribution_sim(pcnt, zcnt), ','
    ! UNEMPLOYMENT PER AGE
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_distribution_sim(pcnt, zcnt), ','
    !epz_x_young_distribution_sim, epz_x_prime_distribution_sim
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_young_distribution_sim(pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') upz_prime_distribution_sim(pcnt, zcnt), ','

    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_search_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_search_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_search_distribution_sim(pcnt), ','

    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_rest_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_rest_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_rest_distribution_sim(pcnt), ','

    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_reall_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_young_reall_distribution_sim(pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') up_prime_reall_distribution_sim(pcnt), ','


ELSE IF (occcnt>0 .AND. occcnt<=occpts) THEN
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') eopz_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') eopz_young_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') eopz_prime_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') eopxz_distribution_sim(occcnt, pcnt, xcnt,zcnt), ','
    ! UNEMPLOYMENT PER AGE
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uopz_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uopz_young_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uopz_prime_distribution_sim(occcnt, pcnt, zcnt), ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uopxz_distribution_sim(occcnt, pcnt, xcnt,zcnt), ','
    
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_search_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_young_search_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_prime_search_distribution_sim(occcnt, pcnt), ','

    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_rest_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_young_rest_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_prime_rest_distribution_sim(occcnt, pcnt), ','

    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_reall_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_young_reall_distribution_sim(occcnt, pcnt),  ','
    WRITE(35, FMT='(F12.6, A1)' , ADVANCE='NO') uop_prime_reall_distribution_sim(occcnt, pcnt), ','


END IF






WRITE(35, FMT='(A1)' ) ','




END DO  ! occcnt
END DO  !zcnt
END DO  !xcnt
END DO  ! pcnt

CLOSE(35)



filename='rest_u_'//trim(file_id)//trim(x1)//'.csv'
OPEN(UNIT=20, file=filename, form='formatted', status='replace')

WRITE(20, FMT='(4(A12, A1))', ADVANCE='no') 'occcnt', ',' , 'pcnt', ',' , 'p_level', ',', 'xcnt', ','
WRITE(20, FMT='(2(A12, A1))', ADVANCE='no') 'rest_zcnt', ',' , 'rest_z_level', ',' 
WRITE(20, FMT='(A12, A1)', ADVANCE='no')  'udistr', ','   
WRITE(20, FMT='(A12, A1)', ADVANCE='no')  'escape1m', ','   
WRITE(20, FMT='(A12, A1)', ADVANCE='no')  'escape1p5m', ','   
WRITE(20, FMT='(A12, A1)', ADVANCE='no')  'escape2m', ','   
WRITE(20, FMT='(A1)')  ','   

DO pcnt=1, ppts 
DO occcnt=1, occpts 
DO xcnt=1, xpts 

ztemptransmatrix=0.0
zrest4transmatrix=0.0
zrest6transmatrix=0.0
zrest8transmatrix=0.0

restu_write_if: &
IF(reservation_zr_occ(occcnt,pcnt, xcnt)<=reservation_zq_occ(occcnt,pcnt, xcnt)-1 .AND. (reservation_zq_occ(occcnt,pcnt, xcnt)<=zpts+1) &
        .AND.reservation_zr_occ(occcnt,pcnt, xcnt)>=1) THEN
    DO zcnt=reservation_zr_occ(occcnt,pcnt, xcnt), reservation_zq_occ(occcnt,pcnt, xcnt)-1
    DO z2cnt=reservation_zr_occ(occcnt,pcnt, xcnt), reservation_zq_occ(occcnt,pcnt, xcnt)-1
            ztemptransmatrix(zcnt, z2cnt)=ztransmatrix(zcnt,z2cnt)
    END DO
    END DO 

ztemptransmatrix=MATMUL(ztemptransmatrix, ztemptransmatrix)
zrest4transmatrix=MATMUL(ztemptransmatrix, ztemptransmatrix)
zrest6transmatrix=MATMUL(zrest4transmatrix, ztemptransmatrix)
zrest8transmatrix=MATMUL(zrest4transmatrix, zrest4transmatrix)

DO zcnt=reservation_zr_occ(occcnt,pcnt, xcnt), reservation_zq_occ(occcnt,pcnt, xcnt)-1
    WRITE(20, FMT='(2(I12, A1),(F12.6, A1),(I12, A1))', ADVANCE='no') occcnt, ',' , pcnt, ',' , pvector(pcnt), ',', xcnt, ','
    WRITE(20, FMT='((I8, A4, A1, F12.6, A1))', ADVANCE='no') zcnt, '    ', ',' , zvector(zcnt), ',' 

    ! unemployment distribution
    WRITE(20, FMT='(F12.6, A1)', ADVANCE='no')  uopxz_distribution_sim(occcnt,pcnt, xcnt, zcnt), ','   
    
    ! calculate 4 month escape freq
    tempreal=0.0
    DO z2cnt=1, zpts
        tempreal=tempreal+ zrest4transmatrix(zcnt,z2cnt)
    END DO 
    WRITE(20, FMT='(F12.6, A1)', ADVANCE='no')  1.0-tempreal, ','   
    
    ! calculate 6 month escape freq
    tempreal=0.0
    DO z2cnt=1, zpts
        tempreal=tempreal+ zrest6transmatrix(zcnt,z2cnt)
    END DO 
    WRITE(20, FMT='(F12.6, A1)', ADVANCE='no')  1.0-tempreal, ','   
    
    ! calculate 8 month escape freq
    tempreal=0.0
    DO z2cnt=1, zpts
        tempreal=tempreal+ zrest8transmatrix(zcnt,z2cnt)
    END DO 
    WRITE(20, FMT='(F12.6, A1)', ADVANCE='no')  1.0-tempreal, ','   
    WRITE(20, FMT='(A1)')  ','   
END DO

!ELSE !restu_write_if: no rest unemployment for this agg prod/occ/xcnt
!    WRITE(20, FMT='(2(I12, A1),(F12.6, A1),(I12, A1))', ADVANCE='no') occcnt, ',' , pcnt, ',' , pvector(pcnt), ',', xcnt, ','
!    WRITE(20, FMT='(A1)')  ','   
 
END IF restu_write_if
END DO  !xcnt
END DO  ! pcnt
END DO  ! occcnt


CLOSE(20)





    !=============================================================
    !==============================================================
    !  CLOSING AN ITERATION
    !==============================================================
    !==============================================================

    ! update counter, and best distance
    estim_counter=estim_counter+1
    IF(mom1_dist<estim_best) estim_best=mom1_dist


    !!$OMP MASTER
 IF (verbosetimeseriesfile2==1) THEN
     OPEN(UNIT=21, file="u_qrtseries.txt", status="replace", form="formatted")
     WRITE(21, FMT='(A8, 4(A15))', ADVANCE='NO') "time,", "hp_l_u,", "uraw,", "aggprod_ind,"
     WRITE(21, FMT='(3(A12))', ADVANCE='NO') "hpu_p33_ind,", "hpu_p50_ind,", "hpu_p67_ind,"
     WRITE(21, FMT='(2(A15))') " ", " "
     DO t=1,tmax_qtr2-1
         WRITE(21, FMT='(I7,A1, 2(F14.6, A1), I14, A1)', ADVANCE='NO') t, "," , data_u_qtr(t), ",", data_uraw_qtr(t), ",", aggprod_ind(MIN(tmin_sim2+12*(t-1)+6, tmax_sim2-60)), ","
         IF(data_u_qtr(t)<=hpu_p33 .AND. data_u_qtr(t)<=hpu_p50 ) THEN
            WRITE(21, FMT='(3(I14, A1))', ADVANCE='NO') 1, ",", 1, ",", 0, ","
         ELSEIF(data_u_qtr(t)>hpu_p33 .AND. data_u_qtr(t)<=hpu_p33 ) THEN
            WRITE(21, FMT='(3(I14, A1))', ADVANCE='NO') 0, ",", 1, ",", 0, ","
         ELSEIF(data_u_qtr(t)>hpu_p67 ) THEN
            WRITE(21, FMT='(3(I14, A1))', ADVANCE='NO') 0, ",", 0, ",", 1, ","
         END IF
         WRITE(21, FMT='(1(A2))') ','
     END DO
     CLOSE(21)
 END IF
 !!$OMP END MASTER


    !!~~~~~~~~~~~~~~~~~~
    !! this is where the local allocatables come to pass
    !!~~~~~~~~~~~~~~~
      !$OMP CRITICAL
     DEALLOCATE(aggprod_ind)
      !$OMP END CRITICAL
        !!$OMP CRITICAL
        !DEALLOCATE(data_temp_qtr3)
        !!$OMP END CRITICAL



      !$OMP CRITICAL
    DEALLOCATE(mask_qtr, unempdur_estatus, data_u_qtr, data_uall_qtr, data_e_qtr, data_uadj18m_qtr, data_u_young_qtr,data_u_prime_qtr, data_uadj18m_young_qtr,data_uadj18m_prime_qtr, &
    data_e_young_qtr,data_e_prime_qtr, data_uraw_qtr, &
    data_u_qtr_p33, data_u_qtr_p50, data_u_qtr_p67, &
    data_ucompldur_occ_qtr, data_ucompldur_young_occ_qtr, data_ucompldur_prime_occ_qtr, &
    data_ucompldur_nocc_qtr, data_ucompldur_young_nocc_qtr, data_ucompldur_prime_nocc_qtr, &
    data_totduration_cocc_qtr, data_totduration_nocc_qtr, &
    data_totduration_cocc_young_qtr, data_totduration_nocc_young_qtr, &
    data_totduration_cocc_prime_qtr, data_totduration_nocc_prime_qtr, &
    data_compduration_cocc_qtr, data_compduration_nocc_qtr, &
    data_compduration_cocc_young_qtr, data_compduration_nocc_young_qtr, &
    data_compduration_cocc_prime_qtr, data_compduration_nocc_prime_qtr, &
    data_totduration_cr_cocc_qtr, data_totduration_cr_nocc_qtr, &
    data_totduration_cr_cocc_young_qtr, data_totduration_cr_nocc_young_qtr, &
    data_totduration_cr_cocc_prime_qtr, data_totduration_cr_nocc_prime_qtr, &
    data_v_qtr,data_theta_qtr, &
    data_jf_qtr, data_jf_young_qtr, data_jf_prime_qtr, &
    data_prod_qtr, data_wage_qtr, data_sep_qtr, data_sep_y_qtr, data_sep_p_qtr, &
    data_cocc_inflow_qtr, data_cocc_young_inflow_qtr, data_cocc_prime_inflow_qtr, data_nocc_inflow_qtr, &
    data_nocc_young_inflow_qtr, data_nocc_prime_inflow_qtr, &
    data_cocc_outflow_qtr, data_cocc_young_outflow_qtr, data_cocc_prime_outflow_qtr, data_nocc_outflow_qtr, &
    data_nocc_young_outflow_qtr, data_nocc_prime_outflow_qtr, &
    data_cocc_qtr, data_cocc_young_qtr, data_cocc_prime_qtr, data_nocc_qtr, data_nocc_young_qtr, data_nocc_prime_qtr, &
    data_pocc_qtr, data_pnocc_qtr, data_pocc_young_qtr, data_pnocc_young_qtr, data_pocc_prime_qtr, data_pnocc_prime_qtr, data_young_qtr, data_prime_qtr, &
    data_ulev_qtr, &
    data_lsep_qtr, data_lsep_y_qtr, data_lsep_p_qtr, data_ljf_qtr, &
    data_ljf_young_qtr, data_ljf_prime_qtr, data_lpocc_qtr, data_lpnocc_qtr, &
    data_ult5wk_qtr, data_u5lt15wk_qtr, data_u15lt27wk_qtr, data_ugt27wk_qtr, &
    data_l_ult5wk_qtr, data_l_u5lt15wk_qtr, data_l_u15lt27wk_qtr, data_l_ugt27wk_qtr, &
    data_ljf5_qtr, data_ljf5_young_qtr, data_ljf5_prime_qtr, data_lpocc5_qtr, data_lpnocc5_qtr, &
    
    data_lv5_qtr, data_lu5_qtr, data_luall5_qtr, data_ltheta5_qtr, &
    data_lsep5_qtr, data_lprod5_qtr, data_lwage5_qtr, &
    data_lcocc_outflow5_qtr, data_lcocc_young_outflow5_qtr, data_lcocc_prime_outflow5_qtr, &
    data_u_yr, data_sep_y_yr, data_sep_p_yr, data_jf_y_yr, data_jf_p_yr, data_u_y_yr, data_u_p_yr, &
    data_sm5_ult3m_qtr, data_sm5_ult5m_qtr, &
    data_sm5_ult9m_qtr, data_sm5_ult13m_qtr, data_sm5_ugt13m_qtr, &
    data_ult3m_qtr , data_ult5m_qtr , &
    data_ult9m_qtr , data_ult13m_qtr , data_ugt13m_qtr , &
    data_l_ult3m_qtr , data_l_ult5m_qtr , &
    data_l_ult9m_qtr , data_l_ult13m_qtr , data_l_ugt13m_qtr , &
    data_ult3m_yng_qtr , data_ult5m_yng_qtr , &
    data_ult9m_yng_qtr , data_ult13m_yng_qtr , data_ugt13m_yng_qtr , &
    data_l_ult3m_yng_qtr , data_l_ult5m_yng_qtr , &
    data_l_ult9m_yng_qtr , data_l_ult13m_yng_qtr , data_l_ugt13m_yng_qtr , &
    data_ult3m_prm_qtr , data_ult5m_prm_qtr , &
    data_ult9m_prm_qtr , data_ult13m_prm_qtr , data_ugt13m_prm_qtr , &
    data_l_ult3m_prm_qtr , data_l_ult5m_prm_qtr , &
    data_l_ult9m_prm_qtr , data_l_ult13m_prm_qtr , data_l_ugt13m_prm_qtr, &
    data_superocc_transmatrix_qtr, data_corr_superocc_transmatrix_qtr, &
    data_supocc_udur_counter_qtr, data_supocc_u_qtr, data_supocc_lu_qtr, &
    data_supocc_e_qtr, data_supocc_sep_qtr,data_supocc_lsep_qtr, &
    data_supocc_udur_qtr, data_supocc_ludur_qtr, &
    data_temp_qtr, data_temp_qtr2, data_temp_qtr3, & !data_scratch_qtr, 
    occdistr_exo_entry_exit_qtr, corr_occdistr_exo_entry_exit_qtr, &
    occdistr_endo_entry_exit_qtr, corr_occdistr_endo_entry_exit_qtr &
        )
      !$OMP END CRITICAL

    !!~~~~~~~ note that we can deal with

    202 FORMAT (2(I14, A1), F14.4, A1, I14, A1, F14.4, A1, 5(I14, A1))



        ! report duration of program
    CALL DATE_AND_TIME(time_string(1), time_string(2), time_string(3))
    call cpu_time ( t2 )
    WRITE(10,*) 'date=', time_string(1), ',end:', time_string(2), ',start:', time_string_begin(2), ',CPUtime:', t2-t1, ',dist:', mom1_dist, 'thread', threadnumber
    !WRITE(*,*) 'date=', time_string(1), ',end:', time_string(2), ',start:', time_string_begin(2), ',CPUtime:', t2-t1, ',dist:', mom1_dist, 'thread', threadnumber
    !WRITE(*,*) 'date=', time_string(1), 'end: ', time_string(2), 'start:', time_string_begin(2), 'CPU time:', t2-t1, 'dist'

    ! stop if it is a one-off trial run
    
        !WRITE(10,*) 'one run completed: PAUSED'
    
    ! close reporting file
    CLOSE(10)

    !=========================
    ! BEEEEEEEEEEP
    !=====================


    ! beep to signal run end
    !Print *, char(7)


            !===========================================
            ! WRITE TO MOM VECTOR (V_ERR)
            !===========================================

    DO i=1, nmom_local !nmom_local
        IF((omega(i,i) .ne. omega(i,i)+1.0_8) .AND. omega(i,i) .ge. 0.0_8) THEN
             mom(i)=sqrt(omega(i,i))
        ELSE IF (omega(i,i) == omega(i,i)+1.0_8) THEN
             mom(i)=omega(i,i)
        ELSE IF (omega(i,i)<0.0_8) THEN
             mom(i)=HUGE(1.0_8)
        END IF
     END DO


 !==================================================================================================================================================


    !****************************************************************************************
    ! ADDITIONAL PARTS/FUNCTIONS
    !****************************************************************************************


    CONTAINS

     REAL(8) FUNCTION pfunction(pindex, xindex, zindex)
            INTEGER(4), INTENT(IN) :: pindex, xindex, zindex

                pfunction=zvector(zindex)*pvector(pindex)*xvector(xindex)

     END FUNCTION pfunction


     REAL(8) FUNCTION pfunction_pz(pindex, zindex)
            INTEGER(4), INTENT(IN) :: pindex, zindex

                pfunction_pz=zvector(zindex)*pvector(pindex)

     END FUNCTION pfunction_pz

! variance calculation
REAL(8) FUNCTION VARCALCUL(vector, tmax_qtr_local)

    REAL(8), DIMENSION(:), INTENT(IN) :: vector
    INTEGER, INTENT(IN) :: tmax_qtr_local
    INTEGER :: vectorsize, tempint,t
    REAL(8) :: tempvar, tempaverage

    vectorsize=SIZE(vector, dim=1)
    IF (vectorsize<tmax_qtr_local-2) WRITE(*,*) 'ERROR --- VECTOR SIZE IN VARIANCE CALCULATION RUBBISH: check variance function and its inputs'

    tempvar=0.0_8
    tempaverage=0.0_8
    tempint=0
    DO t=1, MAX(tmax_qtr_local-2,1)
     tempvar=tempvar+vector(t)**2.0_8
     tempaverage=tempaverage+vector(t)
     tempint=tempint+1
    END DO
    tempaverage=tempaverage/REAL(tempint)
    varcalcul=(tempvar/REAL(tempint))-(tempaverage)**2.0_8
END FUNCTION varcalcul


! corr calculation
REAL(8) FUNCTION CORRCALCUL(vector1, vector2, tmax_qtr_local)

    REAL(8), DIMENSION(:), INTENT(IN) :: vector1, vector2
    INTEGER, INTENT(IN) :: tmax_qtr_local
    INTEGER :: vectorsize, tempint,t
    REAL(8) :: tempcorr, tempaverage1, tempaverage2, tempvar1, tempvar2

    vectorsize=MIN(SIZE(vector1, dim=1), SIZE(vector2, dim=1))
    IF (vectorsize<tmax_qtr_local-2) WRITE(*,*) 'ERROR --- VECTOR SIZE IN CORRELATION CALCULATION RUBBISH: check correlation function and its inputs'

    tempcorr=0.0_8
    tempaverage1=0.0_8
    tempaverage2=0.0_8
    tempvar1=0.0_8
    tempvar2=0.0_8
    tempint=0
    DO t=1, MAX(tmax_qtr_local-2,1)
     tempcorr=tempcorr+(vector1(t)*vector2(t))
     tempvar1=tempvar1+vector1(t)**2.0_8
     tempvar2=tempvar2+vector2(t)**2.0_8
     tempaverage1=tempaverage1+vector1(t)
     tempaverage2=tempaverage2+vector2(t)
     tempint=tempint+1
    END DO
    tempaverage1=tempaverage1/REAL(tempint)
    tempaverage2=tempaverage2/REAL(tempint)
    tempvar1=(tempvar1/REAL(tempint))-(tempaverage1)**2.0_8
    tempvar2=(tempvar2/REAL(tempint))-(tempaverage2)**2.0_8
    tempcorr=(tempcorr/REAL(tempint))-(tempaverage1)*(tempaverage2)
    corrcalcul=tempcorr/(SQRT(tempvar1)*SQRT(tempvar2))
END FUNCTION CORRCALCUL


! prescott's HP Filter code
!C ----------------------------------------------------------------------
!C  SR: hpfilt
!C  Kalman smoothing routine for HP filter written by E Prescott.
!C   y=data series, d=deviations from trend, t=trend, n=no. obs,
!C   s=smoothing parameter (eg, 1600 for std HP).
!C   Array v is scratch area and must have dimension at least 3n.
!C   If IOPT=1 and n and s are the same as for the previous call,
!C   the numbers in v are not recomputed.  This reduces execution
!C   time by about 30 percent.  Note that if this option is exercised,
!C   v cannot be used for other purposes between calls.
!C   This version does NOT release the trend in order to save memory.
!C ----------------------------------------------------------------------




 SUBROUTINE HPFILT(Y,D,V,N,S,IOPT)

      INTEGER(4) :: IOPT,NN,I,I1,IB,N
      REAL(8), DIMENSION(:), INTENT(IN) :: Y
      REAL(8), DIMENSION(N) :: T(N)
      REAL(8), DIMENSION(:,:), INTENT(INOUT) :: V
      REAL(8), INTENT(OUT) :: D(N)

      REAL(8), INTENT(IN) :: S
      REAL(8) :: SS

      REAL(8) :: M1, M2, V11, V12, V22, X, Z, B11, B12, B22, DET, E1, E2


      DATA SS, NN/0.D0,0/



!      REAL(8) :: Y(144),T(144),V(144,3),D(144),SS
!      REAL(8) :: M1, M2, V11, V12, V22, X, Z, B11, B12, B22, DET, E1, E2, S
!      INTEGER(4) IOPT,NN,I,I1,IB,N
!      DATA SS, NN/0.D0,0/

!C
!C     compute sequences of covariance matrix for f[x(t),x(t-1) | y(<t)]
!C
      IF(IOPT .NE. 1 .OR. NN .NE. N  .OR. S .NE. SS)  THEN
        SS=S
        NN=N
        V11=1.0_8
        V22=1.0_8
        V12=0.0_8
       DO 5 I=3,N
        X=V11
        Z=V12
        V11=1.D0/S + 4.D0*(X-Z) + V22
        V12=2.D0*X - Z
        V22=X
        DET=V11*V22-V12*V12
        V(I,1)=V22/DET
        V(I,3)=V11/DET
        V(I,2)=-V12/DET
        X=V11+1.D0
        Z=V11
        V11=V11-V11*V11/X
        V22=V22-V12*V12/X
        V12=V12-Z*V12/X
  5    CONTINUE
                                       ENDIF
!C
!C     this is the forward pass
!C
      M1=Y(2)
      M2=Y(1)
      DO 10 I=3,N
        X=M1
        M1=2.0*M1-M2
        M2=X
        T(I-1)= V(I,1)*M1+V(I,2)*M2
        D(I-1)= V(I,2)*M1+V(I,3)*M2
        DET=V(I,1)*V(I,3)-V(I,2)*V(I,2)
        V11=V(I,3)/DET
        V12=-V(I,2)/DET
        Z=(Y(I)-M1)/(V11+1.D0)
        M1=M1+V11*Z
        M2=M2+V12*Z
 10     CONTINUE
      T(N)=M1
      T(N-1)=M2
!C
!C       this is the backward pass
!C
         M1=Y(N-1)
         M2=Y(N)
        DO 15 I=N-2,1,-1
           I1=I+1
           IB=N-I+1
         X=M1
         M1=2.D0*M1 - M2
         M2=X
!C
!C           combine info for y(.lt.i) with info for y(.ge.i)
!C
         IF(I.GT.2)                 THEN
           E1=V(IB,3)*M2 + V(IB,2)*M1 + T(I)
           E2=V(IB,2)*M2 + V(IB,1)*M1 + D(I)
           B11=V(IB,3)+V(I1,1)
           B12=V(IB,2)+V(I1,2)
           B22=V(IB,1)+V(I1,3)
           DET=B11*B22-B12*B12
           T(I)=(-B12*E1+B11*E2)/DET
                                    ENDIF
!C
!C           end of combining
!C
        DET=V(IB,1)*V(IB,3)-V(IB,2)*V(IB,2)
        V11=V(IB,3)/DET
        V12=-V(IB,2)/DET
        Z=(Y(I)-M1)/(V11+1.D0)
         M1=M1+V11*Z
         M2=M2+V12*Z
 15     CONTINUE
       T(1)=M1
       T(2)=M2
        DO 20 I=1,N
 20      D(I)=Y(I)-T(I)
        RETURN


 END SUBROUTINE HPFILT

 !! THIS SUBROUTINE HPFILTERS WITHIN SUPERWINDOWS

 SUBROUTINE HPFILT2(Y,D,window_qtr,N,S,IOPT2)

      INTEGER(4), INTENT(IN) :: IOPT2, N, window_qtr    ! re-use code for entire series, re-use code for each iteration, dimension of time series in
      REAL(8), DIMENSION(:), INTENT(IN) :: Y            ! input series
      !REAL(8), DIMENSION(:,:), INTENT(INOUT) :: V       ! scratch
      REAL(8), INTENT(OUT) :: D(N)                      ! output (filtered) series
      INTEGER(4) :: IOPT
      REAL(8), DIMENSION(window_qtr) :: DD          ! output (filtered) series
      REAL(8), DIMENSION(4*window_qtr,3) :: VV
      REAL(8), INTENT(IN) :: S                          ! filter factor
      INTEGER :: local_no_superwindows, leftover_window, windowcount
      INTEGER :: local_tswindow_start, local_tswindow_end

!! WINDOWS
local_no_superwindows=max(N/window_qtr,0)
IF (local_no_superwindows<=0) WRITE(*,*) 'no full superwindow to filter in'

!! observations out of standard window
leftover_window=N-(local_no_superwindows*window_qtr)
IF (leftover_window>0 .AND. leftover_window<=0) THEN
        WRITE(*,*) '(too) small but (too) positive leftover_window=', leftover_window
ELSE IF (leftover_window>0) THEN
        WRITE(*,FMT='(A34,I4,A4,I4,A15,I4,A7,I4)') 'WARNING: leftover_window>5, equals', leftover_window, '; N=', N, '; no.swindows=', local_no_superwindows, '; twin=', window_qtr
END IF

!! proceed to filtering within window
IF(local_no_superwindows>0) THEN
    local_tswindow_start=1
    local_tswindow_end=window_qtr


    IOPT=IOPT2

    DO windowcount=1, local_no_superwindows

        ! TO SPEED UP, SET IOPT TO 1 beyond windowcount=1
        IF (windowcount>1) IOPT=1

        ! FILTERING
        CALL HPFILT(Y(local_tswindow_start:local_tswindow_end),DD,VV,window_qtr,S,IOPT)

        ! build filtered series
        D(local_tswindow_start:local_tswindow_end)=DD(1:window_qtr)

        ! update window
        local_tswindow_start=local_tswindow_start+window_qtr
        local_tswindow_end=local_tswindow_end+window_qtr

    END DO
END IF
!
!IF(leftover_window>5) THEN
!        local_tswindow_end=N
!        local_tswindow_start=MAX(N-leftover_window+1,1)
!        CALL HPFILT(Y(local_tswindow_start:local_tswindow_end),D(local_tswindow_start:local_tswindow_end),V(1:4*(leftover_window),1:3),leftover_window,S,0)
!END IF


END SUBROUTINE HPFILT2
!
! !! THIS SUBROUTINE HPFILTERS WITHIN SUPERWINDOWS
!SUBROUTINE HPFILT2_YEARLY(Y,D,V,window_yr, N,S,IOPT2)
!
!
!      INTEGER(4), INTENT(IN) :: IOPT2, N, window_yr    ! re-use code for entire series, re-use code for each iteration, dimension of time series in
!      INTEGER(4) :: IOPT
!      REAL(8), DIMENSION(:), INTENT(IN) :: Y            ! input series
!      REAL(8), DIMENSION(:,:), INTENT(INOUT) :: V       ! scratch
!      REAL(8), DIMENSION(:), INTENT(OUT) :: D           ! output (filtered) series
!      !INTEGER, INTENT(INOUT) :: TMAX_YR                 ! adjusted yearly count
!      REAL(8), DIMENSION(window_yr) :: DD      ! output (filtered) series
!      REAL(8), DIMENSION(window_yr*4,3) :: VV
!      REAL(8), INTENT(IN) :: S                          ! filter factor
!      INTEGER :: local_no_superwindows, leftover_window, windowcount, yr_windowlength
!      INTEGER :: local_tswindow_start, local_tswindow_end
!      INTEGER :: tmax_swindow_yr
!
!! IF no_superwindows*
!local_no_superwindows=max(N/window_yr,0)
!leftover_window=N-(local_no_superwindows*window_yr)
!
!IF (local_no_superwindows<=0) THEN
!    WRITE(*,*) 'ERROR: YEARLY HP FILTERING, NO FULL SUPERWINDOW'
!END IF
!
!IF (leftover_window>0 .AND. leftover_window<=5) THEN
!        WRITE(*,*) '(too) small but (too) positive yearly leftover_window=', leftover_window
!ELSE IF (leftover_window>5) THEN
!        WRITE(*,*) 'WARNING yearly leftover_window=', leftover_window
!END IF
!
!
!IF(local_no_superwindows>0) THEN
!
!    local_tswindow_start=1
!    local_tswindow_end=tmax_swindow_yr
!
!
!
!    IOPT=IOPT2
!
!    DO windowcount=1, local_no_superwindows
!
!        ! TO SPEED UP, SET IOPT TO 1 beyond windowcount=1
!        IF (windowcount>1) IOPT=0
!
!        !WRITE(*,*) 'entering HPFILT'
!        CALL HPFILT(Y(local_tswindow_start:local_tswindow_end),DD,VV,tmax_swindow_yr,S,IOPT)
!
!        D(local_tswindow_start:local_tswindow_end)=DD(1:tmax_swindow_yr)
!
!        local_tswindow_start=local_tswindow_start+tmax_swindow_yr
!        local_tswindow_end=local_tswindow_end+tmax_swindow_yr
!
!    END DO
!END IF
!!
!!IF(leftover_window>5) THEN
!!        local_tswindow_end=N
!!        local_tswindow_start=MAX(N-leftover_window+1,1)
!!        CALL HPFILT(Y(local_tswindow_start:local_tswindow_end),D(local_tswindow_start:local_tswindow_end),V(1:4*(leftover_window),1:3),leftover_window,S,0)
!!END IF
!
!END SUBROUTINE HPFILT2_YEARLY
!

recursive function quantile( k, a) result( value)
    integer,             intent (in)    :: k          ! position in array
    real(8), dimension (:), intent (in) :: a          ! array in
    real(8)                             :: value      ! output value of quantile
    integer                             :: j
    real(8)                             :: ak
    ak = a( k)
    j = count( a < ak)                                  ! how many a(:) < ak
    if( j >= k) then
        value = quantile( k, pack( a, a < ak))
    else
	    j = count( a > ak) + k - size( a)
	    if( j > 0) then
		    value = quantile( j, pack( a, a > ak))
	    else
		    value = ak
        end if
    end if

end function quantile


recursive function wquantile(targetpctile, a, ww) result( value)
    real(8),             intent (in)    :: targetpctile          ! percentile (fractional notation)
    !real(8), intent(in)                 :: vecsize
    real(8), dimension (:), intent (in) :: a, ww          ! array in
    real(8), dimension(size(ww))        :: wwl
    REAL(8)                             :: targetpctilel
    real(8)                             :: value      ! output value of quantile
    integer                             :: counter1,j,indx,k, vecsize
    real(8)                             :: temppctile
    real(8)                             :: ak

    ! establish the index of the vector where adding up all mass up to and including the element, mass equals or for the first time EXCEEDS the percentile cutoff
    ! i.e. target percentile 0, first element exceeds it. (we count from the 0th percentile to the 99th percentile, perhaps misnaming things a bit!)
    targetpctilel=targetpctile
    ! Normalize weights to 1.0: this means that we have to adjust the targetpercentile we feed in recursively, because the remaining distribution is 'censored'
    IF(sum(ww(:))>0.0_8) THEN

    wwl=ww/sum(ww(:))

    ! find the index at which total probaiblity passes the targetpctile cutoff
    k=1
    temppctile=0.0_8
    establish_count_do: DO counter1=1,size(a)
        temppctile=temppctile+wwl(counter1)
        IF(temppctile>=targetpctilel .OR. k==size(a)) EXIT establish_count_do
        k=k+1
    END DO establish_count_do

    ! the value attached to said index
    ak = a( k)
    j=count( a< ak)                              ! how many a(:) < ak: size of vector considered subsequently

    ! total mass of those with values strictly less
    temppctile=0.0_8
    DO counter1=1,size(a)
        IF(a(counter1)<ak) temppctile=temppctile+wwl(counter1)
    END DO

    !! if more mass is contained than the target percentile, below ak, we repeat the exercise, but only consider those values strictly below ak
    if( temppctile >=targetpctilel .AND. j>0 .AND. temppctile>0.0_8) then
        !adjust target percentile
        IF(temppctile>0.0_8) targetpctilel=targetpctilel/temppctile
        value = wquantile(targetpctilel, pack( a, a < ak), pack(wwl, a<ak))
    elseif (temppctile >=targetpctilel .AND. j==0) then
        value=ak
    elseif (temppctile==0.0_8 .and. targetpctilel ==0.0_8) then
        value=ak
    else
    !! if less mass contained strictly below ak, then two possibilities: either we need to add strictly positive mass that is strictly above ak, or
    !! adding the mass at ak will make the mass counter jump over the percentile target, in which case we have found the value at the targetpctilel percentile
	    !j = count( a > ak) + k - size( a)          ! j>0 implies size(a)-k< count(a>ak)
	    !if( j > 0) then
		!    value = quantile( j, pack( a, a > ak))
	    !else
		!    value = ak
        !end if

        !targetpctilel= mass(a>ak) + targetpctilel-1.0_8               ! mass strictly below ak is strictly lower than target. New target is to look for 1.0-
                                                                    ! temppctile+wwl(k)=mass(a>ak)
                                                                    ! targetpctilel=targetpctilel-mass<=ak
                                                                    ! which equals targetpctilel=targetpctilel-temppctile-wwl(k)
        targetpctilel=targetpctilel-temppctile-wwl(k)
        if (targetpctilel>0.0_8) then
            targetpctilel=targetpctilel/(1.0_8-temppctile-wwl(k))               ! adjust targetpercentile
            value= wquantile(targetpctilel, pack(a, a>ak), pack(wwl,a>ak))
        else
            value=ak
        end if

    end if
else if (SUM(REAL(ww(:)))==0 .AND. size(a)>0) then
    value=-1000000000
else
    value=-HUGE(1.0_8)
end if

end function wquantile

SUBROUTINE UNBIASED_CORRELATION( N, A, B, msg, lag, r, t, m)

  ! Computes the correlation of two series A and B of length
  ! N as a function of lag. The correlation is unbiased
  ! because the sums in the covariance and standard devia-
  ! tions are divided by m, not m-1, where m is the number
  ! of overlapping grid points.

  ! The correlation r is defined as
  !
  !           cov(A,B)
  !     r = -------------
  !          s(A) * s(B)
  !
  ! where cov() is covariance and s() is standard deviation.

  ! The series A and B must be prepared such that they
  ! are sent to this routine with zero lag. If necessary, this
  ! is accomplished by padding the beginning or ends (or both)
  ! of each time series with missing values (msg) so that their
  ! elements correspond one to one. The resultant time series
  ! will be of equal length N. Also, missing values (msg)
  ! distributed thoughout each time series is perfectly
  ! acceptable. Time series B will be shifted by the amount
  ! lag relative to time series A:

  ! RETURNS: r, the unbiased correlation, t, the significance
  ! of the unbiased correlation ( t is set to msg if B = A
  ! at lag 0, i.e. an autocorrelation at lag 0, or if the
  ! correlation is 1.0 in general), and m, the number of
  ! overlapping grid points.

  ! A:      t1  t2  t3  t4        ...       tN
  ! B:              t1  t2  t3  t4        ...       tN

  !         \_ _/
  !           V
  !           lag = 2 (Defined to be > 0.)

  IMPLICIT NONE

  INTEGER, INTENT(IN)                :: N
  REAL(8), DIMENSION(N), INTENT(IN)  :: A
  REAL(8), DIMENSION(N), INTENT(IN)  :: B
  REAL(8), INTENT(IN)                :: msg
  INTEGER, INTENT(IN)                :: lag
  REAL(8), INTENT(OUT)               :: r
  REAL(8), INTENT(OUT)               :: t
  INTEGER, INTENT(OUT)               :: m


  REAL, DIMENSION(:), ALLOCATABLE :: x
  REAL, DIMENSION(:), ALLOCATABLE :: y
  REAL, DIMENSION(:), ALLOCATABLE :: xdev
  REAL, DIMENSION(:), ALLOCATABLE :: ydev
  REAL, DIMENSION(:), ALLOCATABLE :: xdevydev
  REAL, DIMENSION(:), ALLOCATABLE :: xdevxdev
  REAL, DIMENSION(:), ALLOCATABLE :: ydevydev

  REAL                            :: xmn
  REAL                            :: ymn
  REAL                            :: COVxy
  REAL                            :: Sx
  REAL                            :: Sy


  ALLOCATE( x(1:3*N) )
  ALLOCATE( y(1:3*N) )

  x(:) = msg
  y(:) = msg

  x(N+1:2*N) = A(:)
  y(N+1:2*N) = B(:)

  y = EOSHIFT( y, SHIFT = -lag, BOUNDARY = msg )

  WHERE ( x == msg ) y = msg
  WHERE ( y == msg ) x = msg

  m = COUNT( x /= msg )

  IF ( m < 3 ) THEN

   WRITE (*,'(A40, I1)') "The number of overlapping points is m = ", m
   WRITE (*,'(A35)')     "The value of m should be 3 or more."
   WRITE (*,'(A17)')     "Decrease the lag."
   WRITE (*,'(A52)')     "Execution halted in SUBROUTINE UNBIASED_CORRELATION."
   STOP

  END IF

  xmn = SUM( x, DIM = 1, MASK = x /= msg ) / REAL(m)
  ymn = SUM( y, DIM = 1, MASK = y /= msg ) / REAL(m)

  ALLOCATE( xdev(1:3*N) )
  ALLOCATE( ydev(1:3*N) )

  xdev(:) = x(:) - xmn
  WHERE ( x == msg ) xdev(:) = msg

  ydev(:) = y(:) - ymn
  WHERE ( y == msg ) ydev(:) = msg

  ALLOCATE( xdevydev(1:3*N) )

  xdevydev(:) = xdev(:) * ydev(:)
  WHERE ( x == msg ) xdevydev(:) = msg

  COVxy = SUM( xdevydev, DIM = 1, MASK = xdevydev /= msg ) / REAL(m)

  ALLOCATE( xdevxdev(1:3*N) )

  xdevxdev(:) = xdev(:) * xdev(:)
  WHERE ( x == msg ) xdevxdev(:) = msg

  Sx = SQRT( SUM( xdevxdev, DIM = 1, MASK = xdevxdev /= msg ) / REAL(m) )

  ALLOCATE( ydevydev(1:3*N) )

  ydevydev(:) = ydev(:) * ydev(:)
  WHERE ( y == msg ) ydevydev(:) = msg

  Sy = SQRT( SUM( ydevydev, DIM = 1, MASK = ydevydev /= msg ) / REAL(m) )

  r = COVxy / ( Sx * Sy )

  IF ( r /= 1.0 ) THEN

    t = r * SQRT( (m - 2) / ( 1 - r*r ) )

  ELSE

    t = msg

  END IF

  DEALLOCATE( x, y, xdev, ydev, xdevydev, xdevxdev, ydevydev )

  END SUBROUTINE UNBIASED_CORRELATION

subroutine bkfilter(n, y, up, dn, k, ybp)

! Aubhik 20.02.2005
!
! Baxter and King (1999) Band-Pass filter
!
! y is a data vector of length n
! ybp is the band pass filtered series, with 0.0 for the first and last k observations
! n is the length of the data vector y
! up is the lower frequency
!	for example, the business cycle band will have up = 6 for quarterly data
!	and up = 1.5 for annual data
! dn is the higher frequency
!	for example, the business cycle band will have dn = 32 for quarterly data
!	and dn = 8 for annual data
! k is the number of leads and lags used by the symmetric moving-average
!	representation of the band pass filter.  Baxter and King (1999) find
!	that k = 12 is a practical choice.
!
! Algorithm provided by Bob King.  This subroutine is the Fortran 90 version of
! bpf.m and filtk.m written by Baxter and King (1999).  The band pass filter is
! a moving average involving 2k+1 terms.  The weights are symmetric and calculated
! in akvec.

implicit none

integer, parameter:: rk = selected_real_kind(15,307), ik = selected_int_kind(9)

integer(ik):: n, up, dn, k
real(rk):: y(n), ybp(n)

integer(ik):: j
real(rk):: pi, omlbar, omubar, kr, kj, theta
real(rk):: akvec(k+1), avec(2*k+1)

intent(in):: n, up, dn, k, y
intent(out):: ybp

pi = 2.0_rk*acos(0.0_rk)

omlbar = 2.0_rk*pi/dble(dn)
omubar = 2.0_rk*pi/dble(up)

akvec = 0.0_rk
avec = 0.0_rk

kr = dble(k)

akvec(1) = (omubar - omlbar)/pi

do j = 1, k
    kj = dble(j)
    akvec(j+1) = (dsin(kj*omubar) - dsin(kj*omlbar))/(kj*pi)
end do

theta = akvec(1) + 2.0_rk*sum(akvec(2:k+1))
theta = -1.0_rk*(theta/(2.0_rk*kr + 1.0_rk))

akvec = akvec + theta

avec(k+1) = akvec(1)

do j = 1, k
    avec(k+1 - j) = akvec(j+1)
    avec(k+1 + j) = akvec(j+1)
end do

ybp = 0.0_rk

do j = k + 1, n - k
    ybp(j) = dot_product(avec, y(j - k: j + k))
end do

end subroutine bkfilter

    END SUBROUTINE CTV_function_simple




SUBROUTINE PACK_DATA_QTR(vector_inout, mask_in)

    REAL(8), DIMENSION(:), INTENT(INOUT) :: vector_inout
    LOGICAL, DIMENSION(:), INTENT(IN)    :: mask_in
    REAL(8), DIMENSION(size(vector_inout)) :: temp_vector, temp_vector2
    INTEGER                              :: arr_size

    temp_vector2=0.0_8
    temp_vector=pack(vector_inout, mask_in, temp_vector2)
    vector_inout=temp_vector

END SUBROUTINE PACK_DATA_QTR

SUBROUTINE NETMOBILITY_CALC(dim,matrix_in, netmob_vector)

    INTEGER, INTENT(IN)                         :: dim
    REAL(8), DIMENSION(dim,dim), INTENT(IN)     :: matrix_in
    REAL(8), DIMENSION(dim), INTENT(OUT)        :: netmob_vector
    INTEGER                                     :: countr
    REAL(8), DIMENSION(dim)                     :: source_distr, dest_distr
    REAL(8)                                     :: tmpreal, sumflows
    REAL(8), DIMENSION(dim,dim)                 :: matrix


    sumflows=sum(matrix_in(:,:))

    matrix=matrix_in/sumflows

    DO countr=1, dim
        source_distr(countr)=sum(matrix(countr,:))
        dest_distr(countr)=sum(matrix(:,countr))
    END DO
    DO countr=1, dim
        netmob_vector(countr)=source_distr(countr)-dest_distr(countr)
    END DO



END SUBROUTINE NETMOBILITY_CALC

SUBROUTINE GROSSMOBILITY_CALC(dim,matrix_in, out_vector)

    INTEGER, INTENT(IN)                         :: dim
    REAL(8), DIMENSION(dim,dim), INTENT(IN)     :: matrix_in
    REAL(8), DIMENSION(dim), INTENT(OUT)        :: out_vector
    INTEGER                                     :: countr
    REAL(8), DIMENSION(dim)                     :: source_outflow_distr, dest_inflow_distr
    REAL(8)                                     :: tmpreal, sumflows
    REAL(8), DIMENSION(dim,dim)                 :: matrix

    sumflows=sum(matrix_in(:,:))

    matrix=matrix_in/sumflows

    DO countr=1, dim
        source_outflow_distr(countr)=sum(matrix(countr,:))-matrix(countr,countr)
        dest_inflow_distr(countr)=sum(matrix(:,countr))-matrix(countr,countr)
    END DO

    out_vector=source_outflow_distr

    ! NOTE: UNCLEAR HOW TO DEFINE GROSS MOBILITY AT THE LEVEL OF OCCUPATION
    ! NOW: just have defined it as the outflow from an occupation
    ! BETTER: define it as MAX(outflow(occ), inflow(occ))
    ! EXCESS MOBILITY then is: GROSSMOB(occ)-ABS(NETFLOW(occ))


    END SUBROUTINE GROSSMOBILITY_CALC


!ALLOCATE(data_temp_qtr(tempint))

    SUBROUTINE LINDETREND_WINDOWS(diml,vector_in, vector_out, superwindow_size, window_size)
        ! SUBROUTINE LINDETREND_WINDOWS(tmax_qtr2,data_u_qtr, data_temp_qtr3, tmax_qtr2, tmax_mask_swindow_qtr)

    INTEGER, INTENT(IN) ::  diml, superwindow_size, window_size
    REAL(8), DIMENSION(diml), INTENT(IN) :: vector_in
    REAL(8), DIMENSION(diml), INTENT(OUT):: vector_out
    REAL(8), DIMENSION(1:window_size, 1) :: Yjfl
    REAL(8), DIMENSION(1:window_size, 2) :: Xjfl
    INTEGER :: tempcounter1l, tempcounter2l, no_windowsl, tcntl, tl
    INTEGER(4) :: errmsgl
    REAL(8), DIMENSION(2) :: betajfl

    !tmax_mask_swindow_qtr=window_size
    !tmax_qtr2=superwindow_size

    !data_temp_qtr3=0.0_8
    vector_out=0.0_8

    ! set constant + time trend on the indepndent variables
    Xjfl(:,:)=0
    Xjfl(1:window_size,1)=1.0
    DO tcntl=1, window_size
            Xjfl(tcntl,2)=REAL(tcntl)            ! linear time trend
    END DO

    ! set bounds of superwindow
    tempcounter1l=1
    tempcounter2l=window_size

    ! determine tempint=no. superwindows
    !counter1l=superwindow_size
    !counter2l=window_size
    no_windowsl=  superwindow_size/window_size
    IF( (superwindow_size/window_size)*window_size .ne. superwindow_size) THEN
         WRITE(*,*) 'LINDETREND_WINDOWS: sum of window_size*windows .ne. superwindow_size'
    END IF
    IF( superwindow_size > diml) THEN
         WRITE(*,*) 'LINDETREND_WINDOWS: superwindow>dim vector_in'
    END IF

    DO tl=1, no_windowsl ! no_windowsl=no. superwindows here
        !! REGRESSIONS PER SUPERWINDOW
        Yjfl(1:window_size,1)=vector_in(tempcounter1l: tempcounter2l)
        CALL multivar_regression(Yjfl(1:window_size,:), Xjfl(1:window_size,:), window_size, 2, betajfl,errmsgl)
            !CALL multivar_regression(Yjf(1:tmax_qtr2-2,:), Xjf(1:tmax_qtr2-2,:), tmax_qtr2-2, 2, betajf,errmsg)
            IF(errmsgl .ne. 0) WRITE(*,*) 'LINDETREND_WINDOWS: regression error', errmsgl

        !! RESIDUALS OF UNEMPLOYMENT AFTER LINEAR DETRENDING
        DO tcntl=tempcounter1l, tempcounter2l
            vector_out(tcntl)=vector_in(tcntl)-betajfl(2)*REAL(tcntl-tempcounter1l+1)-betajfl(1)
        END DO

        tempcounter1l=tempcounter1l+window_size
        tempcounter2l=tempcounter2l+window_size
    END DO

    END SUBROUTINE LINDETREND_WINDOWS

END MODULE mod_solve_ctv
